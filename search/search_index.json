{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"\u7ad9\u70b9\u200b\u7b80\u8ff0\u200b(Introduction)","text":"<p>\u200b\u76ee\u6807\u200b</p> <p>\u200b\u5d4c\u5165\u5f0f\u200bLinux\u200b\u5168\u65b0\u200b\u7cfb\u5217\u200b\u6559\u7a0b\u200b\u4e4b\u200b\u9a71\u52a8\u200b\u5927\u5168\u200b\uff1a\u200b\u57fa\u4e8e\u200b\u767e\u95ee\u200b\u7f51\u200bIMX6ULL-PRO\u200b\u5f00\u53d1\u677f\u200b\uff0cSTM32MP157-PRO\u200b\u5f00\u53d1\u677f\u200b\u5f55\u5236\u200b\uff0c\u200b\u6df1\u5165\u200b\u8bb2\u89e3\u200bLinux\u200b\u5185\u6838\u200b\u9a71\u52a8\u200b\u6846\u67b6\u200b\u7ec4\u6210\u200b\uff0c\u200b\u6d89\u53ca\u200b\u901a\u4fe1\u534f\u8bae\u200b\u539f\u7406\u200b\uff0c\u200b\u624b\u628a\u624b\u200b\u4ece\u200b\u96f6\u200b\u7f16\u5199\u200b\u4ee3\u7801\u200b\uff0c\u200b\u624b\u7ed8\u200b+\u200b\u4ee3\u7801\u200b\u73b0\u573a\u200b\u7f16\u5199\u200b\u5228\u6790\u200b\u65b9\u5f0f\u200b \u200b\u5e26\u200b\u60a8\u200b\u6df1\u5165\u200b\u7406\u89e3\u200b\u5404\u4e2a\u200b\u90e8\u5206\u200b\u3002</p>"},{"location":"#_1","title":"\u5982\u4f55\u200b\u9605\u8bfb\u200b\u6b64\u7ad9\u200b\uff1f","text":"<p>\u200b\u611f\u5174\u8da3\u200b\u53ef\u4ee5\u200b\u52a0\u5165\u200bQQ\u200b\u7fa4\u200b 562614605\u200b\u4e86\u89e3\u200b\uff0c\u200b\u5efa\u8bae\u200b\u4f7f\u7528\u200bPC\u200b\u7aef\u200b\u6d4f\u89c8\u5668\u200b\u8bbf\u95ee\u200b\uff0c\u200b\u5206\u8fa8\u7387\u200b1080p\u200b\u4e3a\u200b\u6700\u4f73\u200b\u9605\u8bfb\u200b\u3002 IMX6ULL-PRO\u200b\u5f00\u53d1\u677f\u200b\u5546\u54c1\u200b\u4ecb\u7ecd\u200b\uff1ahttps://item.taobao.com/item.htm?&amp;id=610613585935 STM32MP157-PRO\u200b\u5f00\u53d1\u677f\u200b\u5546\u54c1\u200b\u4ecb\u7ecd\u200b\uff1ahttps://item.taobao.com/item.htm?&amp;id=623233533961 </p> <p>\u200b\u4e3a\u4ec0\u4e48\u200b\u56fe\u7247\u200b\u663e\u793a\u200b\u4e0d\u5168\u200b\uff1f\u200b\u56e0\u4e3a\u200b\u670d\u52a1\u5668\u8d44\u6e90\u200b\u6709\u9650\u200b\uff0c\u200b\u6587\u6863\u200b\u56fe\u7247\u200b\u8d44\u6599\u200b\u5e9e\u5927\u200b\uff0c\u200b\u5728\u200b\u8d2d\u4e70\u200b\u3010\u200b\u767e\u95ee\u200b\u7f51\u97e6\u200b\u4e1c\u5c71\u200b\u9a71\u52a8\u200b\u5927\u5168\u200b\u8bfe\u7a0b\u200b\u3011\u200b\u4e4b\u540e\u200b\u4f1a\u200b\u6709\u200b\u5b8c\u6574\u200b\u7684\u200b\u6587\u6863\u8d44\u6599\u200b\u4e0b\u8f7d\u200b\u5730\u5740\u200b\uff0c\u200b\u8bfe\u7a0b\u200b\u83b7\u53d6\u200b\u5730\u5740\u200b\uff1ahttps://item.taobao.com/item.htm?id=636066114871</p>"},{"location":"#_2","title":"\u5d4c\u5165\u5f0f\u200b\u5f00\u53d1\u200b\u6d41\u7a0b\u200b\u7b80\u8ff0","text":"<p>\u200b\u5728\u200b\u8fdb\u5165\u200b\u5d4c\u5165\u5f0f\u200bLinux\u200b\u5f00\u53d1\u200b\u4e4b\u524d\u200b\uff0c\u200b\u6211\u4eec\u200b\u9700\u8981\u200b\u5148\u200b\u4e86\u89e3\u200b\u4e00\u4e0b\u200b\u5d4c\u5165\u5f0f\u200b\u7cfb\u7edf\u200b\u7684\u200b\u5f00\u53d1\u200b\u6846\u67b6\u200b\u4ee5\u53ca\u200b\u6d41\u7a0b\u200b\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b\uff0c\u200b\u5de6\u4fa7\u200b\u4e3a\u200b\u6211\u4eec\u200b\u5e38\u7528\u200b\u7684\u200bPC\u200b\u7535\u8111\u4e3b\u673a\u200b\uff0c\u200b\u53f3\u4fa7\u200b\u4e3a\u200b\u5d4c\u5165\u5f0f\u200b\u7cfb\u7edf\u200b\uff0c\u200b\u56e0\u4e3a\u200b\u5d4c\u5165\u5f0f\u200b\u82af\u7247\u200b\u7684\u200b\u6027\u80fd\u200b\u5185\u5b58\u200b\u5b58\u50a8\u200b\u6761\u4ef6\u200b\u7b49\u200b\u539f\u56e0\u200b \u200b\u65e0\u6cd5\u200b\u76f4\u63a5\u200b\u5728\u200b\u5d4c\u5165\u5f0f\u200b\u82af\u7247\u200b\u4e0a\u200b\u8fdb\u884c\u200b\u7a0b\u5e8f\u5f00\u53d1\u200b\uff0c\u200b\u6b64\u65f6\u200b\u6211\u4eec\u200b\u5c31\u200b\u9700\u8981\u200b\u501f\u52a9\u200b\u6027\u80fd\u200b\u5f3a\u5927\u200b\u7684\u200bPC\u200b\u4e3b\u673a\u200b\uff0c\u200b\u4e00\u822c\u200b\u4e3a\u200bX86\u200b\u7535\u8111\u200b\uff0c\u200b\u901a\u8fc7\u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200b\u7684\u200b\u65b9\u5f0f\u200b\u751f\u4ea7\u200b \u200b\u5d4c\u5165\u5f0f\u200b\u82af\u7247\u200b\u53ef\u4ee5\u200b\u8fd0\u884c\u200b\u7684\u200b\u7a0b\u5e8f\u200b\uff0c\u200b\u5728\u200b\u8fd9\u91cc\u200b\uff0c\u200b\u6211\u4eec\u200b\u4e00\u822c\u200b\u53eb\u200bPC\u200b\u4e3b\u673a\u200b\u4e3a\u200bHost\u200b\u7aef\u200b\uff0c\u200b\u5bf9\u4e8e\u200b\u6211\u4eec\u200b\u7684\u200b\u5d4c\u5165\u5f0f\u200b\u5f00\u53d1\u677f\u200b\uff0c\u200b\u6211\u4eec\u200b\u4e00\u822c\u200b\u6210\u4e3a\u200bTarget\u200b\u7aef\u200b\u3002\u200b\u6211\u4eec\u200b\u9700\u8981\u200b\u5728\u200bHost\u200b\u7aef\u200b\u4f7f\u7528\u200b\u9488\u5bf9\u200b\u4e8e\u200bTarget\u200b\u7aef\u200b\u82af\u7247\u200b\u67b6\u6784\u200b\u751f\u6210\u200b\u7684\u200b\u5de5\u5177\u200b\u94fe\u200b\u8fdb\u884c\u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200b\uff0c\u200b\u6700\u540e\u200b\u5c06\u200b\u8f93\u51fa\u200b\u7684\u200b\u53ef\u6267\u884c\u6587\u4ef6\u200b\u5b58\u653e\u200b\u81f3\u200bTarget(\u200b\u76ee\u6807\u200b\u5f00\u53d1\u677f\u200b)\u200b\u5185\u200b\u8fd0\u884c\u200b\u3002 </p> <p>\u200b\u901a\u8fc7\u200b\u4e0a\u200b\u56fe\u200b\u53ef\u4ee5\u200b\u770b\u51fa\u200b\uff0c\u200b\u5b9e\u9645\u200b\u7684\u200b\u5d4c\u5165\u5f0f\u200b\u5f00\u53d1\u200b\u662f\u200b\u901a\u8fc7\u200b\u4e24\u200b\u90e8\u5206\u200b\u7ec4\u6210\u200b\u7684\u200b\uff0c\u200b\u90a3\u4e48\u200b\u5bf9\u4e8e\u200b\u5d4c\u5165\u5f0f\u200bLinux\u200b\u8bbe\u5907\u200b\u5f00\u53d1\u200b\u4e5f\u200b\u662f\u200b\u5982\u6b64\u200b\u3002\u200b\u901a\u8fc7\u200bHost\u200b\u7aef\u7684\u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200b\u5de5\u5177\u200b\u94fe\u200b\u7f16\u8bd1\u200b Target(\u200b\u76ee\u6807\u200b\u5f00\u53d1\u677f\u200b)\u200b\u7684\u200b\u7a0b\u5e8f\u200b\uff0c\u200b\u7136\u540e\u200b\u653e\u5728\u200bTarget\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u8fd0\u884c\u200b\u3002  </p> <p>\u200b\u65e2\u7136\u200bTarget(\u200b\u76ee\u6807\u200b\u5f00\u53d1\u677f\u200b)\u200b\u4e0a\u200b\u8fd0\u884c\u200b\u7684\u200b\u7a0b\u5e8f\u200b\u662f\u200b\u901a\u8fc7\u200bHost(PC\u200b\u4e3b\u673a\u200b)\u200b\u7aef\u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200b\u5de5\u5177\u200b\u94fe\u200b\u751f\u6210\u200b\uff0c\u200b\u90a3\u4e48\u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200b\u5de5\u5177\u200b\u94fe\u200b\u53c8\u200b\u662f\u4ece\u200b\u54ea\u91cc\u200b\u800c\u200b\u6765\u200b\uff1f\u200b\u8fd9\u91cc\u200b\u5c31\u200b\u6d89\u53ca\u200b\u5230\u200b\u4e86\u200b\u4e00\u4e2a\u200bBuildSystem(\u200b\u6784\u5efa\u200b\u7cfb\u7edf\u200b)\u200b\u7684\u200b\u6982\u5ff5\u200b\uff0c\u200b\u6240\u6709\u200b\u7684\u200b\u7a0b\u5e8f\u200b\u90fd\u200b\u4e0d\u200b\u53ef\u80fd\u200b\u662f\u200b\u76f4\u63a5\u200b\u51ed\u7a7a\u51fa\u73b0\u200b\uff0c\u200b\u800c\u662f\u200b\u901a\u8fc7\u200b\u7f16\u7a0b\u200b\u5f00\u53d1\u200b\uff0c\u200b\u6700\u540e\u200b\u518d\u200b\u7f16\u8bd1\u200b\u5f97\u51fa\u200b\u3002\u200b\u4e0b\u9762\u200b\u8fd9\u200b\u5f20\u56fe\u200b\u6f14\u793a\u200b\u4e86\u200b\uff0c\u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200b\u5de5\u5177\u200b\u94fe\u200b\u7684\u200b\u751f\u6210\u200b\u4ee5\u53ca\u200b\u5982\u4f55\u200b\u4f7f\u7528\u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200b\u5de5\u5177\u200b\u94fe\u200b\u7f16\u8bd1\u200b\u751f\u6210\u200b\u4e00\u4e2a\u200b\u53ef\u4ee5\u200b\u5728\u200bTarget(\u200b\u76ee\u6807\u200b\u5f00\u53d1\u677f\u200b)\u200b\u4e0a\u200b\u8fd0\u884c\u200b\u7684\u200bc++\u200b\u7a0b\u5e8f\u200b\u3002\u200b\u8fd9\u91cc\u200b\u4e3b\u8981\u200b\u544a\u8bc9\u200b\u5927\u5bb6\u200b\uff0c\u200b\u6240\u6709\u200b\u7684\u200b\u7a0b\u5e8f\u200b\u90fd\u200b\u662f\u4ece\u200b\u6e90\u7801\u200b\u7f16\u8bd1\u200b\u5f97\u51fa\u200b\uff0c\u200b\u4e0d\u7ba1\u200b\u662f\u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200b\u5de5\u5177\u200b\u94fe\u200b\u8fd8\u662f\u200b Target\u200b\u4e0a\u200b\u8fd0\u884c\u200b\u7684\u200b\u7a0b\u5e8f\u200b\u3002 </p> <ul> <li>\u200b\u5982\u679c\u200b\u770b\u200b\u4e86\u200b\u4e0a\u8ff0\u200b\u7684\u200b\u4ecb\u7ecd\u200b\u8fd8\u662f\u200b\u4e0d\u592a\u200b\u7406\u89e3\u200b \u200b\u5d4c\u5165\u5f0f\u200b\u7684\u200b\u5f00\u53d1\u200b\u6d41\u7a0b\u200b\u6846\u67b6\u200b\u53ef\u4ee5\u200b\u770b\u200b\u6211\u4eec\u200b\u4e4b\u524d\u200b\u4e13\u95e8\u200b\u5f55\u5236\u200b\u7684\u200b\u4e00\u5957\u200b\u57fa\u4e8e\u200bbuildroot\u200b\u5f00\u53d1\u200b\u7684\u200b\u5d4c\u5165\u5f0f\u200b\u57fa\u7840\u77e5\u8bc6\u200b\u79d1\u666e\u200b\u7c7b\u200b\u89c6\u9891\u6559\u7a0b\u200b\u3002</li> </ul>"},{"location":"#_3","title":"\u4ee3\u7801\u200b\u5e93\u200b\u4f7f\u7528\u200b\u6b65\u9aa4","text":"<p>Note</p> <p>\u200b\u8be6\u7ec6\u200b\u7684\u200b\u5404\u4e2a\u200b\u90e8\u5206\u200b\u5f00\u53d1\u200b\u6b65\u9aa4\u200b\u8bf7\u200b\u67e5\u770b\u200b \u200b\u5de6\u4fa7\u200b\u5bfc\u822a\u200b  LinuxC\u200b\u57fa\u7840\u200b Linux\u200b\u7ec4\u4ef6\u200b\u5f00\u53d1\u200b Linux\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u5f00\u53d1\u200b Linux\u200b\u7cfb\u7edf\u200b\u5f00\u53d1\u200b \u200b\u9875\u9762\u200b\uff0c\u200b\u5728\u200b\u9875\u9762\u200b\u5185\u4f1a\u200b\u6709\u200b\u8be6\u7ec6\u200b\u7684\u200b\u5404\u200b\u90e8\u5206\u200b\u5f00\u53d1\u200b\u6d41\u7a0b\u200b\u4ecb\u7ecd\u200b\u3002</p> <pre><code>graph LR\nA[0.\u200b\u51c6\u5907\u200b\u786c\u4ef6\u200b]--&gt;B[1.\u200b\u83b7\u53d6\u200bUbuntu\u200b\u865a\u62df\u673a\u200b\u7cfb\u7edf\u200b]--&gt;2.\u200b\u914d\u7f6e\u200bHost\u200b\u5f00\u53d1\u200b\u73af\u5883\u200b--&gt;3.\u200b\u83b7\u53d6\u200bTarget\u200b\u5de5\u7a0b\u200b\u793a\u4f8b\u200b--&gt;4.Host\u200b\u7aef\u200b\u7f16\u8bd1\u200b\u5f00\u53d1\u200b--&gt;5.\u200b\u4e0a\u4f20\u200b\u81f3\u200bTarget\u200b\u5f00\u53d1\u677f\u200b\u8fd0\u884c\u200b</code></pre>"},{"location":"#_4","title":"\u5982\u4f55\u200b\u53c2\u4e0e\u200b\u7f16\u8f91\u200b\uff1f","text":"<ul> <li>\u200b\u6211\u4eec\u200b\u6240\u6709\u200b\u7684\u200b\u6587\u6863\u200b\u4f7f\u7528\u200bmakrdown\u200b\u8fdb\u884c\u200b\u7f16\u5199\u200b\uff0c\u200b\u5b58\u653e\u200b\u5728\u200bgithub\u200b\u4ed3\u5e93\u200bhttps://github.com/100askTeam/LinuxDeviceDriver-Tranning \u200b\u5185\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u76f4\u63a5\u200b\u70b9\u51fb\u200b\u6bcf\u4e2a\u200b\u9875\u9762\u200b\u53f3\u4e0a\u89d2\u200b\u7684\u200b \ud83d\udd8a \u200b\u7bad\u5934\u200b\u76f4\u63a5\u200b\u7f16\u8f91\u200b\u4fee\u6539\u200b\u3002</li> <li>\u200b\u5bf9\u4e8e\u200b\u4ee3\u7801\u200b\u793a\u4f8b\u200b\u7b49\u200b\u5de5\u7a0b\u200b\uff0c\u200b\u5168\u90e8\u200b\u90fd\u200b\u6839\u636e\u200b\u4e0d\u540c\u200b\u7684\u200b\u4f7f\u7528\u200b\u573a\u666f\u200b\u5b58\u653e\u200b\u5728\u200b\u4e0d\u540c\u200b\u7684\u200bgit\u200b\u4ed3\u5e93\u200b\u5185\u200b\u3002</li> </ul> <p>\u200b\u613f\u666f\u200b\uff1a\u200b\u6211\u4eec\u200b\u6b63\u5728\u200b\u4e0d\u65ad\u200b\u5730\u200b\u652f\u6301\u200b\u66f4\u200b\u591a\u200b\u7684\u200b\u786c\u4ef6\u200b\u6a21\u5757\u200b\uff0c\u200b\u4ee3\u7801\u200b\u793a\u4f8b\u200b\uff0c\u200b\u52a0\u5165\u200b\u5230\u200b\u8fd9\u4e2a\u200b\u7ad9\u70b9\u200b\u5185\u200b\uff0c\u200b\u5982\u679c\u200b\u60a8\u200b\u611f\u5174\u8da3\u200b\uff0c\u200b\u6b22\u8fce\u200b\u52a0\u5165\u200b\u3002</p> <ul> <li>\u200b\u8ba8\u8bba\u200b\u4ea4\u6d41\u200b\uff1ahttps://forums.100ask.net/c/elinuxdev/23</li> </ul>"},{"location":"#_5","title":"\u60a8\u200b\u5c06\u200b\u83b7\u5f97\u200b\u4ec0\u4e48\u200b\uff1f","text":"<p>\u200b\u5feb\u901f\u200b\u5b9e\u73b0\u200b\u60a8\u200b\u9700\u8981\u200b\u5b9e\u73b0\u200b\u7684\u200b\u529f\u80fd\u200b\uff0c\u200b\u6211\u4eec\u200b\u63d0\u4f9b\u200b\u4e13\u95e8\u200b\u7684\u200b\u5f00\u53d1\u677f\u200b\u786c\u4ef6\u200b\uff0c\u200b\u914d\u5957\u200b\u7684\u200b\u6a21\u5757\u200b\u786c\u4ef6\u200b\uff0c\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b \u200b\u7cfb\u7edf\u200b\u6e90\u7801\u200bSDK\u200b\u5de5\u7a0b\u200b\u6e90\u7801\u200b\uff0c\u200b\u5e38\u7528\u200b\u7ec4\u4ef6\u200b\u5f00\u53d1\u200b\u793a\u4f8b\u200b\uff0c\u200b\u4ee5\u53ca\u200bLinuxC\u200b\u57fa\u7840\u200b\uff0c\u200b\u8ba9\u200b\u5927\u5bb6\u200b\u53ef\u4ee5\u200b\u5728\u200b\u6700\u200b\u77ed\u200b\u7684\u200b\u65f6\u95f4\u200b\u5185\u200b\u5b9e\u73b0\u200b\u81ea\u5df1\u200b\u9700\u8981\u200b\u7684\u200b\u529f\u80fd\u200b\u3002</p>"},{"location":"#_6","title":"\u5173\u4e8e\u200b\u5f00\u6e90\u200b\u534f\u8bae","text":"<p>\u200b\u6b64\u200b\u9875\u9762\u200b\u4f7f\u7528\u200b\u4e86\u200b\u5f00\u6e90\u200b\u7684\u200bMkdoc\u200b\u6587\u6863\u200b\u6846\u67b6\u200b\uff0c\u200b\u6587\u6863\u200b\u7ad9\u70b9\u200b\u6258\u7ba1\u200b\u5728\u200bGitHub\u200b\u4e0a\u200b\uff0c\u200b\u6bcf\u4e2a\u200b\u9875\u9762\u200b\u90fd\u200b\u4f1a\u200b\u6709\u200b\u7f16\u8f91\u200b\u6309\u94ae\u200b\uff0c\u200b\u5927\u5bb6\u200b\u53ef\u4ee5\u200b\u4e00\u8d77\u200b\u53c2\u4e0e\u200b\u7f16\u8f91\u200b\u6216\u8005\u200b\u63d0\u95ee\u200b\u6539\u8fdb\u200b\u6b64\u200b\u6587\u6863\u200b,\u200b\u5982\u679c\u200b\u60a8\u200b\u8f6c\u53d1\u200b\u6b64\u200b\u6587\u7ae0\u200b\uff0c\u200b\u8bf7\u200b\u6ce8\u660e\u200b\u51fa\u5904\u200b\uff0c\u200b\u8c22\u8c22\u200b\uff01 * \u200b\u56fe\u7247\u200b\u5f15\u7528\u200b: https://preshing.com/20141119/how-to-build-a-gcc-cross-compiler/</p>"},{"location":"About/","title":"\u5173\u4e8e\u200b\u6211\u4eec","text":"<p>\u200b\u6211\u4eec\u200b\u662f\u200b\u4e00\u5bb6\u200b\u4e13\u6ce8\u200b\u4e8e\u200b\u5d4c\u5165\u5f0f\u200bLinux\u200b\u6559\u80b2\u200b\u57f9\u8bad\u200b\u5341\u4f59\u5e74\u200b\u516c\u53f8\u200b\uff0c\u200b\u4e3b\u200b\u8bb2\u5e08\u200b\u97e6\u200b\u4e1c\u5c71\u200b\u8001\u5e08\u200b\u64c5\u957f\u200bARM\u200b\u7cfb\u5217\u200b\u65b9\u9762\u200b\u7684\u200b\u786c\u4ef6\u200b\u539f\u7406\u56fe\u200b\u8bbe\u8ba1\u200b\uff0c\u200b\u7cbe\u901a\u200bARM MIPS Blackfin\u200b\u7b49\u200b\u67b6\u6784\u200b\u5904\u7406\u5668\u200b\u7684\u200bLinux\u200b\u5e95\u5c42\u200b\u7cfb\u7edf\u200b\u5f00\u53d1\u200b\u3002</p> <ul> <li>\u200b\u97e6\u200b\u4e1c\u5c71\u200b-\u200b\u5d4c\u5165\u5f0f\u200b\u4e13\u5bb6\u200b | \u200b\u534e\u4e3a\u200b\u8ba4\u8bc1\u200b\u9996\u6279\u200b\u9e3f\u8499\u200b\u7cfb\u7edf\u200b\u8bfe\u7a0b\u200b\u5f00\u8005\u200b</li> <li>\u200b\u5173\u6ce8\u200b\u516c\u4f17\u200b\u53f7\u200b\uff1a\u200b\u767e\u95ee\u200b\u79d1\u6280\u200b\uff08\u200b\u6700\u65b0\u200b\u8d44\u8baf\u200b\uff09</li> <li>\u200b\u97e6\u200b\u4e1c\u5c71\u200b\u5b98\u65b9\u200b\u6dd8\u5b9d\u200b\u5e97\u94fa\u200b\uff1a100ask.taobao.com</li> <li>\u200b\u97e6\u200b\u4e1c\u5c71\u200b\u5b98\u65b9\u200b\u5728\u7ebf\u200b\u5b66\u4e60\u200b\u5e73\u53f0\u200b\uff1a100ask.org</li> <li>QQ\u200b\u6280\u672f\u200b\u4ea4\u6d41\u200b\u7fa4\u200b\uff1a562614605</li> <li>\u200b\u5b98\u65b9\u200b\u90ae\u7bb1\u200b\uff1a support@100ask.net</li> </ul>"},{"location":"03_LCD/01_1/","title":"01_\u200b\u5355\u7247\u673a\u200b_Linux\u200b\u4e0b\u200b\u4e0d\u540c\u200b\u63a5\u53e3\u200b\u7684\u200bLCD\u200b\u786c\u4ef6\u200b\u64cd\u4f5c\u200b\u539f\u7406","text":""},{"location":"03_LCD/01_1/#lcd","title":"\u4e0d\u540c\u200b\u63a5\u53e3\u200b\u7684\u200bLCD\u200b\u786c\u4ef6\u200b\u64cd\u4f5c\u200b\u539f\u7406","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>MIPI-DSI\u3001MIPI-CSI\u3001LVDS\u200b\u7b49\u200b\u63a5\u53e3\u200b\u89e3\u6790\u200b\uff1ahttps://blog.csdn.net/u014470361/article/details/88891255</li> <li>ILI9488\u200b\u9a71\u52a8\u200b\u82af\u7247\u200b\u6570\u636e\u200b\u624b\u518c\u200b.pdf</li> </ul>"},{"location":"03_LCD/01_1/#1-lcd","title":"1. \u200b\u5e94\u7528\u200b\u5de5\u7a0b\u5e08\u200b\u773c\u91cc\u200b\u770b\u5230\u200b\u7684\u200bLCD","text":"<p>LCD\u200b\u7531\u200b\u4e00\u4e2a\u200b\u4e00\u4e2a\u200b\u50cf\u7d20\u200b\u7ec4\u6210\u200b\uff1a\u200b\u6bcf\u884c\u200b\u6709\u200bxres\u200b\u4e2a\u200b\u50cf\u7d20\u200b\uff0c\u200b\u6709\u200byres\u200b\u884c\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u5206\u8fa8\u7387\u200b\u662f\u200b\uff1axres * yres\u3002</p> <p></p> <p>\u200b\u53ea\u8981\u200b\u6211\u4eec\u200b\u80fd\u200b\u63a7\u5236\u200b\u4efb\u610f\u200b\u4e00\u4e2a\u200b\u50cf\u7d20\u200b\u7684\u200b\u989c\u8272\u200b\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u5728\u200bLCD\u200b\u4e0a\u200b\u7ed8\u5236\u200b\u6587\u5b57\u200b\u3001\u200b\u56fe\u7247\u200b\u3002</p>"},{"location":"03_LCD/01_1/#11","title":"1.1 \u200b\u50cf\u7d20\u200b\u7684\u200b\u989c\u8272\u200b\u600e\u4e48\u200b\u8868\u793a","text":"<p>\u200b\u7528\u200b\u7ea2\u7eff\u84dd\u200b\u4e09\u200b\u989c\u8272\u200b\u6765\u200b\u8868\u793a\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u7528\u200b24\u200b\u4f4d\u200b\u6570\u636e\u200b\u6765\u200b\u8868\u793a\u200b\u7ea2\u7eff\u84dd\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u7528\u200b16\u200b\u4f4d\u200b\u7b49\u7b49\u200b\u683c\u5f0f\u200b\uff0c\u200b\u6bd4\u5982\u200b\uff1a</p> <ul> <li>bpp\uff1abits per pixel\uff0c\u200b\u6bcf\u4e2a\u200b\u50cf\u7d20\u200b\u7528\u200b\u591a\u5c11\u200b\u4f4d\u6765\u200b\u8868\u793a\u200b</li> <li>24bpp\uff1a\u200b\u5b9e\u9645\u4e0a\u200b\u4f1a\u200b\u7528\u5230\u200b32\u200b\u4f4d\u200b\uff0c\u200b\u5176\u4e2d\u200b8\u200b\u4f4d\u672a\u200b\u4f7f\u7528\u200b\uff0c\u200b\u5176\u4f59\u200b24\u200b\u4f4d\u4e2d\u200b\u5206\u522b\u200b\u7528\u200b8\u200b\u4f4d\u200b\u8868\u793a\u200b\u7ea2\u200b(R)\u3001\u200b\u7eff\u200b(G)\u3001\u200b\u84dd\u200b(B)</li> <li>16bpp\uff1a\u200b\u6709\u200brbg565\uff0crgb555</li> <li>rgb565\uff1a\u200b\u7528\u200b5\u200b\u4f4d\u200b\u8868\u793a\u200b\u7ea2\u200b\u30016\u200b\u4f4d\u200b\u8868\u793a\u200b\u7eff\u200b\u30015\u200b\u4f4d\u200b\u8868\u793a\u200b\u84dd\u200b</li> <li>rgb555\uff1a16\u200b\u4f4d\u200b\u6570\u636e\u200b\u4e2d\u200b\u7528\u200b5\u200b\u4f4d\u200b\u8868\u793a\u200b\u7ea2\u200b\u30015\u200b\u4f4d\u200b\u8868\u793a\u200b\u7eff\u200b\u30015\u200b\u4f4d\u200b\u8868\u793a\u200b\u84dd\u200b\uff0c\u200b\u6d6a\u8d39\u200b\u4e00\u4f4d\u200b</li> </ul> <p></p>"},{"location":"03_LCD/01_1/#12-lcd","title":"1.2 \u200b\u600e\u4e48\u200b\u628a\u200b\u989c\u8272\u200b\u53d1\u7ed9\u200bLCD","text":"<p>\u200b\u5047\u8bbe\u200b\u6bcf\u4e2a\u200b\u50cf\u7d20\u200b\u7684\u200b\u989c\u8272\u200b\u7528\u200b16\u200b\u4f4d\u6765\u200b\u8868\u793a\u200b\uff0c\u200b\u90a3\u4e48\u200b\u4e00\u4e2a\u200bLCD\u200b\u7684\u200b\u6240\u6709\u200b\u50cf\u7d20\u70b9\u200b\u5047\u8bbe\u200b\u6709\u200bxres * y res\u200b\u4e2a\u200b\uff0c \u200b\u9700\u8981\u200b\u7684\u200b\u5185\u5b58\u200b\u4e3a\u200b\uff1axres * yres * 16 / 8\uff0c\u200b\u4e5f\u200b\u5c31\u662f\u200b\u8981\u200b\u8bbe\u7f6e\u200b\u6240\u6709\u200b\u50cf\u7d20\u200b\u7684\u200b\u989c\u8272\u200b\uff0c\u200b\u9700\u8981\u200b\u8fd9\u4e48\u200b\u5927\u5c0f\u200b\u7684\u200b\u5185\u5b58\u200b\u3002 \u200b\u8fd9\u5757\u200b\u5185\u5b58\u200b\u5c31\u200b\u88ab\u200b\u79f0\u4e3a\u200bframebuffer\uff1a</p> <ul> <li>Framebuffer\u200b\u4e2d\u200b\u6bcf\u5757\u200b\u6570\u636e\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200b\u50cf\u7d20\u200b</li> <li>\u200b\u6bcf\u5757\u200b\u6570\u636e\u200b\u7684\u200b\u5927\u5c0f\u200b\u53ef\u80fd\u200b\u662f\u200b16\u200b\u4f4d\u200b\u300132\u200b\u4f4d\u200b\uff0c\u200b\u8fd9\u200b\u8ddf\u200bLCD\u200b\u4e0a\u200b\u50cf\u7d20\u200b\u7684\u200b\u989c\u8272\u200b\u683c\u5f0f\u200b\u6709\u5173\u200b</li> <li>\u200b\u8bbe\u7f6e\u200b\u597d\u200bLCD\u200b\u786c\u4ef6\u200b\u540e\u200b\uff0c\u200b\u53ea\u200b\u9700\u8981\u200b\u628a\u200b\u989c\u8272\u200b\u6570\u636e\u200b\u5199\u5165\u200bFramebuffer\u200b\u5373\u53ef\u200b</li> </ul> <p></p>"},{"location":"03_LCD/01_1/#2-lcd","title":"2. \u200b\u9a71\u52a8\u200b\u5de5\u7a0b\u5e08\u200b\u773c\u91cc\u200b\u770b\u5230\u200b\u7684\u200bLCD","text":"<p>\u200b\u9a71\u52a8\u200b\u5de5\u7a0b\u5e08\u200b\u5bf9\u200bLCD\u200b\u7684\u200b\u7406\u89e3\u200b\u8981\u200b\u6df1\u5165\u200b\u786c\u4ef6\u200b\uff0c\u200b\u6bd4\u5982\u200b\u8981\u200b\u56de\u7b54\u200b\u8fd9\u200b\u51e0\u4e2a\u200b\u95ee\u9898\u200b\uff1a</p> <ul> <li>Framebuffer\u200b\u5728\u200b\u54ea\u91cc\u200b\uff1f</li> <li>\u200b\u8c01\u200b\u628a\u200bFramebuffer\u200b\u4e2d\u200b\u7684\u200b\u6570\u636e\u200b\u53d1\u7ed9\u200bLCD\uff1f</li> </ul>"},{"location":"03_LCD/01_1/#21-lcd","title":"2.1 \u200b\u7edf\u4e00\u200b\u7684\u200bLCD\u200b\u786c\u4ef6\u200b\u6a21\u578b","text":""},{"location":"03_LCD/01_1/#22-mcu8080lcd","title":"2.2 MCU\u200b\u5e38\u7528\u200b\u7684\u200b8080\u200b\u63a5\u53e3\u200bLCD\u200b\u6a21\u7ec4","text":""},{"location":"03_LCD/01_1/#23-mputft-rgb","title":"2.3 MPU\u200b\u5e38\u7528\u200b\u7684\u200bTFT RGB\u200b\u63a5\u53e3","text":""},{"location":"03_LCD/01_1/#24-mipi","title":"2.4 \u200b\u6709\u200b\u4e00\u4e2a\u200bMIPI\u200b\u6807\u51c6","text":"<p>**MIPI**\u200b\u8868\u793a\u200b<code>Mobile Industry Processor Interface</code>\uff0c\u200b\u5373\u200b\u79fb\u52a8\u200b\u4ea7\u4e1a\u200b\u5904\u7406\u5668\u200b\u63a5\u53e3\u200b\u3002\u200b\u662f\u200bMIPI\u200b\u8054\u76df\u200b\u53d1\u8d77\u200b\u7684\u200b\u4e3a\u200b\u79fb\u52a8\u200b\u5e94\u7528\u200b\u5904\u7406\u5668\u200b\u5236\u5b9a\u200b\u7684\u200b\u5f00\u653e\u200b\u6807\u51c6\u200b\u548c\u200b\u4e00\u4e2a\u200b\u89c4\u8303\u200b\u3002\u200b\u4e3b\u8981\u200b\u662f\u200b\u624b\u673a\u200b\u5185\u90e8\u200b\u7684\u200b\u63a5\u53e3\u200b\uff08\u200b\u6444\u50cf\u5934\u200b\u3001\u200b\u663e\u793a\u5c4f\u200b\u63a5\u53e3\u200b\u3001\u200b\u5c04\u9891\u200b/\u200b\u57fa\u5e26\u200b\u63a5\u53e3\u200b\uff09\u200b\u7b49\u200b\u6807\u51c6\u5316\u200b\uff0c\u200b\u4ece\u800c\u200b\u51cf\u5c11\u200b\u624b\u673a\u200b\u5185\u90e8\u200b\u63a5\u53e3\u200b\u7684\u200b\u590d\u6742\u7a0b\u5ea6\u200b\u53ca\u200b\u589e\u52a0\u200b\u8bbe\u8ba1\u200b\u7684\u200b\u7075\u6d3b\u6027\u200b\u3002</p> <p>\u200b\u5bf9\u4e8e\u200bLCD\uff0cMIPI\u200b\u63a5\u53e3\u200b\u53ef\u4ee5\u200b\u5206\u4e3a\u200b3\u200b\u7c7b\u200b\uff1a</p> <ul> <li> <p>MIPI-DBI (Display Bus Interface)  </p> </li> <li> <p>\u200b\u65e2\u7136\u200b\u662f\u200bBus(\u200b\u603b\u7ebf\u200b)\uff0c\u200b\u5c31\u662f\u200b\u65e2\u200b\u80fd\u200b\u53d1\u9001\u6570\u636e\u200b\uff0c\u200b\u4e5f\u200b\u80fd\u200b\u53d1\u9001\u200b\u547d\u4ee4\u200b\uff0c\u200b\u5e38\u7528\u200b\u7684\u200b8080\u200b\u63a5\u53e3\u200b\u5c31\u200b\u5c5e\u4e8e\u200bDBI\u200b\u63a5\u53e3\u200b\u3002</p> </li> <li> <p>Type B (i-80 system), 8-/9-/16-/18-/24-bit bus  </p> </li> <li>Type C (Serial data transfer interface, \u00be-line SPI)  </li> <li> <p>MIPI-DPI (Display Pixel Interface)  </p> </li> <li> <p>Pixel(\u200b\u50cf\u7d20\u200b)\uff0c\u200b\u5f3a\u8c03\u200b\u7684\u200b\u662f\u200b\u64cd\u4f5c\u200b\u5355\u4e2a\u200b\u50cf\u7d20\u200b\uff0c\u200b\u5728\u200bMPU\u200b\u4e0a\u200b\u7684\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u5c31\u662f\u200b\u8fd9\u79cd\u200b\u63a5\u53e3\u200b</p> </li> <li> <p>Supports 24 bit/pixel (R: 8-bit, G: 8-bit, B: 8-bit)</p> </li> <li>Supports 18 bit/pixel (R: 6-bit, G: 6-bit, B: 6-bit)</li> <li> <p>Supports 16 bit/pixel (R: 5-bit, G: 6-bit, B: 5-bit)  </p> </li> <li> <p>MIPI-DSI (Display Serial Interface)  </p> </li> <li>Serial\uff0c\u200b\u76f8\u6bd4\u200b\u4e8e\u200bDBI\u3001DPI\u200b\u9700\u8981\u200b\u4f7f\u7528\u200b\u5f88\u591a\u200b\u63a5\u53e3\u200b\u7ebf\u200b\uff0cDSI\u200b\u9700\u8981\u200b\u7684\u200b\u63a5\u53e3\u200b\u7ebf\u200b\u5927\u4e3a\u200b\u51cf\u5c11\u200b</li> <li>Supports one data lane/maximum speed 500Mbps</li> <li>Supports DSI version 1.01</li> <li>Supports D-PHY version 1.00 </li> </ul>"},{"location":"03_LCD/02_1/","title":"02_Framebuffer\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":""},{"location":"03_LCD/02_1/#framebuffer","title":"Framebuffer\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":""},{"location":"03_LCD/02_1/#1","title":"1. \u200b\u600e\u4e48\u200b\u7f16\u5199\u200b\u5b57\u7b26\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<ul> <li>\u200b\u9a71\u52a8\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u53f7\u200b</li> <li>\u200b\u6784\u9020\u200bfile_operations\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u586b\u5145\u200bopen/read/write\u200b\u7b49\u200b\u6210\u5458\u200b\u51fd\u6570\u200b</li> <li>\u200b\u6ce8\u518c\u200b\u9a71\u52a8\u200b\uff1aregister_chrdev(major, name, &amp;fops)</li> <li>\u200b\u5165\u53e3\u200b\u51fd\u6570\u200b</li> <li>\u200b\u51fa\u53e3\u200b\u51fd\u6570\u200b</li> </ul>"},{"location":"03_LCD/02_1/#2-framebuffer","title":"2. Framebuffer\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":"<p>\u200b\u5206\u4e3a\u200b\u4e0a\u4e0b\u200b\u4e24\u5c42\u200b\uff1a</p> <ul> <li>fbmem.c\uff1a\u200b\u627f\u4e0a\u542f\u4e0b\u200b</li> <li>\u200b\u5b9e\u73b0\u200b\u3001\u200b\u6ce8\u518c\u200bfile_operations\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> <li>\u200b\u628a\u200bAPP\u200b\u7684\u200b\u8c03\u7528\u200b\u5411\u4e0b\u200b\u8f6c\u53d1\u200b\u5230\u200b\u5177\u4f53\u200b\u7684\u200b\u786c\u4ef6\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</li> <li>xxx_fb.c\uff1a\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</li> <li>\u200b\u5b9e\u73b0\u200b\u3001\u200b\u6ce8\u518c\u200bfb_info\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> <li>\u200b\u5b9e\u73b0\u200b\u786c\u4ef6\u200b\u64cd\u4f5c\u200b</li> </ul> <p>\u200b\u8c03\u7528\u200b\u5173\u7cfb\u200b\uff1a</p> <pre><code>\u200b\u4f8b\u5b50\u200b1\uff1a\napp:  open(\"/dev/fb0\", ...)   \u200b\u4e3b\u200b\u8bbe\u5907\u200b\u53f7\u200b: 29, \u200b\u6b21\u200b\u8bbe\u5907\u200b\u53f7\u200b: 0\n--------------------------------------------------------------\nkernel:\n         fb_open\n            int fbidx = iminor(inode);\n            struct fb_info *info = = registered_fb[0];\n\n\n\u200b\u4f8b\u5b50\u200b2\uff1a\napp:  read()\n---------------------------------------------------------------\nkernel:\n        fb_read\n            int fbidx = iminor(inode);\n            struct fb_info *info = registered_fb[fbidx];\n            if (info-&gt;fbops-&gt;fb_read)\n                return info-&gt;fbops-&gt;fb_read(info, buf, count, ppos);\n\n            src = (u32 __iomem *) (info-&gt;screen_base + p);\n            dst = buffer;\n            *dst++ = fb_readl(src++);\n            copy_to_user(buf, buffer, c)            \n</code></pre>"},{"location":"03_LCD/02_1/#3-framebuffer","title":"3. \u200b\u600e\u4e48\u200b\u7f16\u5199\u200bFramebuffer\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>\u200b\u6838\u5fc3\u200b\uff1a</p> <p></p> <ul> <li> <p>\u200b\u5206\u914d\u200bfb_info</p> </li> <li> <p>framebuffer_alloc</p> </li> <li> <p>\u200b\u8bbe\u7f6e\u200bfb_info</p> </li> <li> <p>var</p> </li> <li>fbops</li> <li> <p>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u64cd\u4f5c\u200b</p> </li> <li> <p>\u200b\u6ce8\u518c\u200bfb_info</p> </li> <li> <p>register_framebuffer</p> </li> </ul>"},{"location":"03_LCD/03/","title":"03_\u200b\u7f16\u7a0b\u200b_\u200b\u5199\u51fa\u200b\u6846\u67b6","text":""},{"location":"03_LCD/03/#_","title":"\u7f16\u7a0b\u200b_\u200b\u5199\u51fa\u200b\u6846\u67b6","text":"<p>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>drivers\\video\\fbdev\\s3c2410fb.c\n</code></pre> <p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u5bf9\u5e94\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u4e2d\u200b\uff0c\u200b\u4f4d\u7f6e\u200b\u5982\u4e0b\u200b(\u200b\u8fd9\u200b2\u200b\u4e2a\u200b\u6587\u4ef6\u200b\u662f\u200b\u5b8c\u5168\u200b\u4e00\u6837\u200b\u7684\u200b)\uff1a</p> <pre><code>doc_and_source_for_drivers\\STM32MP157\\source\\A7\\03_LCD\\01_fb_info\\lcd_drv.c\n\u200b\u6216\u200b\uff1a\ndoc_and_source_for_drivers\\IMX6ULL\\source\\03_LCD\\01_fb_info\\lcd_drv.c\n</code></pre> <p>\u200b\u6ce8\u610f\u200b\uff1a</p> <ul> <li>\u200b\u5de5\u4f5c\u200b\u4e2d\u200b\u5e76\u4e0d\u9700\u8981\u200b\u6211\u4eec\u200b\u4ece\u5934\u200b\u5199\u51fa\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u5f88\u591a\u200b\u65f6\u5019\u200b\u662f\u200b\u53bb\u200b\u4fee\u6539\u200b\u73b0\u6210\u200b\u7684\u200b\u4ee3\u7801\u200b</li> <li>\u200b\u4f46\u662f\u200b\u9700\u8981\u200b\u4f60\u200b\u7406\u89e3\u200b\u6574\u4e2a\u200b\u9a71\u52a8\u200b</li> <li>\u200b\u9700\u8981\u200b\u77e5\u9053\u200b\u6539\u200b\u54ea\u91cc\u200b\u3001\u200b\u600e\u4e48\u200b\u6539\u200b</li> <li>\u200b\u9700\u8981\u200b\u5b66\u4e60\u200b</li> <li>\u200b\u5b66\u4e60\u200b\u65f6\u200b</li> <li>\u200b\u5982\u679c\u200b\u53ea\u662f\u200b\u5bf9\u200b\u7740\u200b\u73b0\u6210\u200b\u7684\u200b\u4ee3\u7801\u200b\u8bb2\u89e3\u200b\uff0c\u200b\u8bb2\u5b8c\u200b\u542c\u200b\u5b8c\u200b\u4e5f\u200b\u5c31\u200b\u5fd8\u8bb0\u200b\u5b8c\u200b\u4e86\u200b</li> <li>\u200b\u6240\u4ee5\u200b\uff0c\u200b\u5f3a\u70c8\u5efa\u8bae\u200b\u81ea\u5df1\u200b\u52a8\u624b\u200b\u5199\u200b</li> <li>\u200b\u6211\u200b\u505a\u200bLinux\u200b\u5df2\u7ecf\u200b16\u200b\u5e74\u200b\u4e86\u200b\uff0c\u200b\u73b0\u5728\u200b\u5f55\u5236\u200b\u89c6\u9891\u200b\u8fd8\u662f\u200b\u6ca1\u200b\u5077\u61d2\u200b\u4ece\u200b0\u200b\u5199\u200b\u4ee3\u7801\u200b\uff0c\u200b\u4f60\u200b\u521d\u5b66\u200b\u7684\u8bdd\u200b\u5c31\u200b\u60f3\u200b\u5077\u61d2\u200b\u53ea\u200b\u770b\u200b\u4e0d\u7ec3\u200b\u5417\u200b\uff1f</li> </ul>"},{"location":"03_LCD/03/#1-fb_info","title":"1. \u200b\u5206\u914d\u200bfb_info","text":""},{"location":"03_LCD/03/#2-fb_info","title":"2. \u200b\u8bbe\u7f6e\u200bfb_info","text":"<p>\u200b\u8981\u200b\u8bbe\u7f6e\u200b\u54ea\u4e9b\u200b\u5185\u5bb9\u200b\uff1f\u200b\u6839\u636e\u200bAPP\u200b\u7684\u200b\u9700\u6c42\u200b\u6765\u200b\u3002</p>"},{"location":"03_LCD/03/#3-fb_info","title":"3. \u200b\u6ce8\u518c\u200bfb_info","text":""},{"location":"03_LCD/04/","title":"04_\u200b\u6700\u200b\u7b80\u5355\u200b\u7684\u200bLCD\u200b\u9a71\u52a8\u200b_\u200b\u57fa\u4e8e\u200bQEMU","text":""},{"location":"03_LCD/04/#lcd_qemu","title":"\u6700\u200b\u7b80\u5355\u200b\u7684\u200bLCD\u200b\u9a71\u52a8\u200b_\u200b\u57fa\u4e8e\u200bQEMU","text":"<p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u5bf9\u5e94\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u4e2d\u200b\uff0c\u200b\u4f4d\u7f6e\u200b\u5982\u4e0b\u200b(\u200b\u8fd9\u200b2\u200b\u4e2a\u200b\u6587\u4ef6\u200b\u662f\u200b\u5b8c\u5168\u200b\u4e00\u6837\u200b\u7684\u200b)\uff1a</p> <pre><code>doc_and_source_for_drivers\\STM32MP157\\source\\A7\\03_LCD\\02_lcd_drv_qemu\\lcd_drv.c\n\u200b\u6216\u200b\uff1a\ndoc_and_source_for_drivers\\IMX6ULL\\source\\03_LCD\\02_lcd_drv_qemu\\lcd_drv.c\n</code></pre> <p>\u200b\u76ee\u524d\u200b\u767e\u95ee\u200b\u7f51\u200b\u4e3b\u63a8\u200b\u7684\u200b\u5f00\u53d1\u677f\u200b\u662f\u200bIMX6ULL\u3001STM32MP157\u3002 \u200b\u4f46\u662f\u200b\u4e5f\u200b\u63a8\u51fa\u200b\u4e86\u200b\u4e00\u5757\u200b\u865a\u62df\u200b\u7684\u200b\u5f00\u53d1\u677f\u200b\uff1aIMX6ULL_QEMU\uff0c\u200b\u539f\u56e0\u200b\u6709\u200b2\uff1a</p> <ul> <li>\u200b\u964d\u4f4e\u200b\u5b66\u4e60\u200b\u6210\u672c\u200b</li> <li>\u200b\u521d\u5b66\u200b\u9636\u6bb5\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u4e0d\u4e70\u200b\u5f00\u53d1\u677f\u200b\uff0c\u200b\u4f7f\u7528\u200bQEMU\u200b\u5373\u53ef\u200b\u5165\u95e8\u200b\u3002</li> <li>\u200b\u6df1\u5165\u200b\u5b66\u4e60\u200b\u5185\u6838\u200b\u53ca\u200b\u9a71\u52a8\u200b</li> <li>\u200b\u4f7f\u7528\u200bQEMU\u200b\u53ef\u4ee5\u200b\u975e\u5e38\u200b\u65b9\u4fbf\u200b\u5730\u200b\u8c03\u8bd5\u200b\u5185\u6838\u200b\u3001\u200b\u67e5\u770b\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6267\u884c\u200b\u8fc7\u7a0b\u200b</li> <li>\u200b\u6709\u52a9\u4e8e\u200b\u6df1\u5165\u7814\u7a76\u200b\u5185\u6838\u200b\u53ca\u200b\u9a71\u52a8\u200b</li> </ul> <p>\u200b\u540e\u9762\u200b\u7684\u200b\u89c6\u9891\u200b\u91cc\u200b\uff0c\u200b\u4f1a\u200b\u4f7f\u7528\u200bQEMU\u200b\u6765\u200b\u8bb2\u89e3\u200b\u67d0\u4e9b\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u3002 \u200b\u6ce8\u610f\u200b\uff1a</p> <ul> <li>\u200b\u4f7f\u7528\u200bQEMU\u200b\u4e0d\u662f\u200b\u5fc5\u987b\u200b\u7684\u200b</li> <li>QEMU\u200b\u53ea\u662f\u200b\u63d0\u4f9b\u200b\u53e6\u200b\u4e00\u4e2a\u200b\u89d2\u5ea6\u200b\u7684\u200b\u5b66\u4e60\u200b\u65b9\u6cd5\u200b\uff0c\u200b\u6bd4\u5982\u200b\uff1a</li> <li>LCD\u200b\u9a71\u52a8\u200b\uff1a\u200b\u4f7f\u7528\u200bQEMU\u200b\u53ef\u4ee5\u200b\u65f6\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u7b80\u5316\u200b\u786c\u4ef6\u200b\u7684\u200b\u64cd\u4f5c\u200b</li> <li>\u200b\u4e2d\u65ad\u200b\u5b50\u7cfb\u7edf\u200b\uff1a\u200b\u53ef\u4ee5\u200b\u8ddf\u8e2a\u200b\u8c03\u7528\u200b\u8fc7\u7a0b\u200b</li> <li>\u200b\u4f60\u200b\u53ef\u4ee5\u200b\u53ea\u200b\u770b\u200bQEMU\u200b\u76f8\u5173\u200b\u7684\u200b\u89c6\u9891\u200b\uff0c\u200b\u4e0d\u200b\u4f7f\u7528\u200bQEMU\u200b\u6765\u200b\u64cd\u4f5c\u200b</li> <li>\u200b\u5728\u200b\u771f\u5b9e\u200b\u7684\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u8bb2\u89e3\u200b\u7684\u200b\u5185\u5bb9\u200b\uff0c\u200b\u4f1a\u200b\u8986\u76d6\u200bQEMU\u200b\u89c6\u9891\u200b\u7684\u200b\u77e5\u8bc6\u200b</li> </ul>"},{"location":"03_LCD/04/#1-qemu","title":"1. \u200b\u4e3a\u4ec0\u4e48\u200b\u8981\u200b\u7528\u200bQEMU","text":"<p>Linux\u200b\u9a71\u52a8\u200b = \u200b\u9a71\u52a8\u200b\u6846\u67b6\u200b + \u200b\u786c\u4ef6\u200b\u64cd\u4f5c\u200b\u3002 \u200b\u5982\u679c\u200b\u786c\u4ef6\u200b\u64cd\u4f5c\u200b\u8db3\u591f\u200b\u7b80\u5355\u200b\uff0c\u200b\u6211\u4eec\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u628a\u200b\u7cbe\u529b\u200b\u653e\u5728\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u7684\u200b\u6846\u67b6\u200b\u4e0a\u200b\uff0c\u200b\u8fd9\u624d\u200b\u662f\u200bLinux\u200b\u7684\u200b\u6838\u5fc3\u200b\u3002 \u200b\u770b\u770b\u200b\u771f\u5b9e\u200b\u7684\u200bLCD\u200b\u8fde\u7ebf\u200b\uff1a </p> <p>\u200b\u5bf9\u4e8e\u200b\u786c\u4ef6\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u4f60\u200b\u81f3\u5c11\u200b\u8981\u200b\u505a\u200b\u8fd9\u4e9b\u200b\u4e8b\u60c5\u200b\uff1a</p> <ul> <li>\u200b\u8bbe\u7f6e\u200b\u5f15\u811a\u200b\u7528\u4e8e\u200bLCD</li> <li>\u200b\u9605\u8bfb\u200bLCD\u200b\u624b\u518c\u200b\uff0c\u200b\u9605\u8bfb\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u624b\u518c\u200b\uff0c\u200b\u6839\u636e\u200bLCD\u200b\u53c2\u6570\u8bbe\u7f6e\u200bLCD\u200b\u63a7\u5236\u5668\u200b</li> <li>\u200b\u8bbe\u7f6e\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u65f6\u200b\uff0c\u200b\u4f60\u200b\u8fd8\u200b\u9700\u8981\u200b\u4e86\u89e3\u200b\u6240\u7528\u200b\u7684\u200b\u4e3b\u63a7\u200b\u82af\u7247\u200b\u7684\u200b\u65f6\u949f\u200b\u7cfb\u7edf\u200b</li> <li>\u200b\u5206\u914d\u200bFramebuffer\uff0c\u200b\u628a\u200bFramebuffer\u200b\u5730\u5740\u200b\u544a\u8bc9\u200bLCD\u200b\u63a7\u5236\u5668\u200b</li> </ul> <p>\u200b\u603b\u4e4b\u200b\uff0c\u200b\u975e\u5e38\u590d\u6742\u200b\u3002\u200b\u5982\u679c\u200b\u4f60\u200b\u6362\u200b\u4e86\u200b\u82af\u7247\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u5de5\u4f5c\u200b\u53c8\u200b\u5f97\u200b\u91cd\u6765\u200b\u4e00\u6b21\u200b\u3002 \u200b\u5982\u679c\u200b\u4f60\u200b\u672c\u8eab\u200b\u5df2\u7ecf\u200b\u5bf9\u200b\u9605\u8bfb\u200b\u82af\u7247\u200b\u624b\u518c\u200b\u5f88\u200b\u719f\u6089\u200b\uff0c\u200b\u5bf9\u200b\u786c\u4ef6\u200b\u64cd\u4f5c\u200b\u5f88\u200b\u719f\u6089\u200b\uff0c\u200b\u90a3\u4e48\u200b\u5b66\u4e60\u200b\u65f6\u200b\u6ca1\u200b\u5fc5\u8981\u200b\u628a\u200b\u65f6\u95f4\u200b\u6d6a\u8d39\u200b\u5728\u200b\u8fd9\u65b9\u9762\u200b\u3002 \u200b\u4f7f\u7528\u200bQEMU\uff0c\u200b\u865a\u62df\u200b\u51fa\u200b\u4e00\u6b3e\u200b\u7b80\u5355\u200b\u7684\u200bLCD\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u7b80\u5316\u200b\u786c\u4ef6\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u8ba9\u200b\u6211\u4eec\u200b\u628a\u200b\u7cbe\u529b\u200b\u653e\u5728\u200b\u9a71\u52a8\u200b\u6846\u67b6\u200b\u4e0a\u200b\u3002</p>"},{"location":"03_LCD/04/#2-lcd","title":"2. LCD\u200b\u76f8\u5173\u200b\u7684\u200b\u82af\u7247\u200b\u624b\u518c","text":""},{"location":"03_LCD/04/#21-lcd","title":"2.1 \u200b\u865a\u62df\u200b\u7684\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u624b\u518c","text":"<p>\u200b\u767e\u95ee\u200b\u7f51\u200b\u4fee\u6539\u200b\u4e86\u200bQEMU\u200b\u7684\u200b\u6e90\u7801\u200b\uff0c\u200b\u5b9e\u73b0\u200b\u4e86\u200b\u4e00\u4e2a\u200b\u865a\u62df\u200b\u7684\u200bLCD\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u64cd\u4f5c\u200b\u5f88\u200b\u7b80\u5355\u200b\u3002 \u200b\u53ea\u6709\u200b4\u200b\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u624b\u518c\u200b\u5982\u4e0b\u200b\uff1a</p> \u200b\u5730\u5740\u200b \u200b\u5bc4\u5b58\u5668\u200b \u200b\u8bf4\u660e\u200b 0x021C8000 fb_base_phys \u200b\u7528\u4e8e\u200b\u8bbe\u7f6e\u200bFramebuffer\u200b\u7684\u200b\u7269\u7406\u5730\u5740\u200b 0x021C8004 fb_xres \u200b\u7528\u4e8e\u200b\u8bbe\u7f6e\u200bFramebuffer\u200b\u7684\u200bX\u200b\u65b9\u5411\u200b\u5206\u8fa8\u7387\u200b 0x021C8008 fb_yres \u200b\u7528\u4e8e\u200b\u8bbe\u7f6e\u200bFramebuffer\u200b\u7684\u200bY\u200b\u65b9\u5411\u200b\u5206\u8fa8\u7387\u200b 0x021C800C fb_bpp \u200b\u7528\u4e8e\u200b\u8bbe\u7f6e\u200bFramebuffer\u200b\u4e2d\u200b\u50cf\u7d20\u200b\u7684\u200b\u4f4d\u200b\u5bbd"},{"location":"03_LCD/04/#22lcd","title":"2.2\u200b\u865a\u62df\u200b\u7684\u200bLCD\u200b\u82af\u7247\u200b\u53c2\u6570","text":"<p>\u200b\u76ee\u524d\u200b\u8fd9\u200b\u6b3e\u200b\u865a\u62df\u200b\u7684\u200bLCD\u200b\u5206\u8fa8\u7387\u200b\u4e3a\u200b500x300,16bpp\u3002\u200b\u6682\u65f6\u200b\u672a\u200b\u652f\u6301\u200b\u5176\u4ed6\u200b\u53c2\u6570\u200b\u3002</p>"},{"location":"03_LCD/04/#3-lcd","title":"3. \u200b\u4fee\u6539\u200bLCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6dfb\u52a0\u200b\u786c\u4ef6\u200b\u64cd\u4f5c","text":""},{"location":"03_LCD/04/#4-qemu","title":"4. \u200b\u4e0b\u8f7d\u200b\u3001\u200b\u5b89\u88c5\u200b\u3001\u200b\u8fd0\u884c\u200bQEMU","text":"<p>\u200b\u53c2\u8003\u200b\uff1a<code>http://wiki.100ask.org/Qemu</code></p>"},{"location":"03_LCD/04/#5","title":"5. \u200b\u4e0b\u8f7d\u200b\u3001\u200b\u7f16\u8bd1\u200b\u5185\u6838","text":"<p>\u200b\u53c2\u8003\u200b\uff1a<code>http://wiki.100ask.org/Qemu</code></p>"},{"location":"03_LCD/04/#6-lcd","title":"6. \u200b\u66ff\u6362\u200bLCD\u200b\u9a71\u52a8\u7a0b\u5e8f","text":""},{"location":"03_LCD/05/","title":"05_\u200b\u4e0a\u673a\u200b\u5b9e\u9a8c\u200b_\u200b\u57fa\u4e8e\u200bQEMU","text":""},{"location":"03_LCD/05/#_qemu","title":"\u4e0a\u673a\u200b\u5b9e\u9a8c\u200b_\u200b\u57fa\u4e8e\u200bQEMU","text":"<p>\u200b\u524d\u63d0\u200b\uff1a\u200b\u5b89\u88c5\u200b\u4e86\u200bVMware\uff0c\u200b\u8fd0\u884c\u200b\u767e\u95ee\u200b\u7f51\u200b\u63d0\u4f9b\u200b\u7684\u200bUbuntu 18.04 \u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u5bf9\u5e94\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u4e2d\u200b\uff0c\u200b\u4f4d\u7f6e\u200b\u5982\u4e0b\u200b(\u200b\u8fd9\u200b2\u200b\u4e2a\u200b\u6587\u4ef6\u200b\u662f\u200b\u5b8c\u5168\u200b\u4e00\u6837\u200b\u7684\u200b)\uff1a</p> <pre><code>doc_and_source_for_drivers\\STM32MP157\\source\\A7\\03_LCD\\03_lcd_drv_qemu_ok\\lcd_drv.c\n\u200b\u6216\u200b\uff1a\ndoc_and_source_for_drivers\\IMX6ULL\\source\\03_LCD\\03_lcd_drv_qemu_ok\\lcd_drv.c\n</code></pre>"},{"location":"03_LCD/05/#1-qemu","title":"1. \u200b\u4e0b\u8f7d\u200b\u3001\u200b\u5b89\u88c5\u200b\u3001\u200b\u8fd0\u884c\u200bQEMU","text":"<p>\u200b\u53c2\u8003\u200b\uff1a<code>http://wiki.100ask.org/Qemu</code></p>"},{"location":"03_LCD/05/#11-qemu","title":"1.1 \u200b\u4e0b\u8f7d\u200b\u767e\u95ee\u200b\u7f51\u200b\u5236\u4f5c\u200b\u7684\u200bQEMU","text":"<ul> <li>\u200b\u4e0b\u8f7d\u200b</li> </ul> <p>\u200b\u5728\u200bUbuntu 18.04\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\uff0c\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u4e00\u4e2a\u200b\u76ee\u5f55\u200b<code>ubuntu-18.04_imx6ul_qemu_system</code>\uff1a</p> <pre><code>git  clone  https://e.coding.net/weidongshan/ubuntu-18.04_imx6ul_qemu_system.git\n</code></pre> <ul> <li>\u200b\u5b89\u88c5\u200bSDL</li> </ul> <p>\u200b\u4e0b\u8f7d\u200b\u6210\u529f\u200b\u540e\u200b\uff0c\u200b\u8fdb\u5165\u200b<code>ubuntu-18.04_imx6ul_qemu_system</code>\u200b\u76ee\u5f55\u200b\uff0c\u200b\u6267\u884c\u200b<code>install_sdl.sh</code>\uff0c\u200b\u5982\u4e0b\u200b\u6240\u793a\u200b\uff1a</p> <pre><code>cd ~/ubuntu-18.04_imx6ul_qemu_system/\nbook@100ask:~/ubuntu-18.04_imx6ul_qemu_system$ ls\nimx6ull-system-image  install_sdl.sh  qemu  qemu-imx6ull-gui.sh  qemu-imx6ull-nogui.sh  README.md  ubuntu-18.04_sdl-package\nbook@100ask:~/ubuntu-18.04_imx6ul_qemu_system$ ./install_sdl.sh\n</code></pre>"},{"location":"03_LCD/05/#12-qemu","title":"1.2 \u200b\u8fd0\u884c\u200bQEMU","text":"<p>\u200b\u5fc5\u987b\u200b\u5728\u200bUbunut\u200b\u7684\u200b\u684c\u9762\u73af\u5883\u200b\u4e0b\u200b\u542f\u52a8\u200b\u7ec8\u7aef\u200b\uff0c\u200b\u6267\u884c\u200b<code>./qemu-imx6ull-gui.sh</code>\uff0c\u200b\u5982\u4e0b\u200b\u6240\u793a\u200b\uff1a</p> <pre><code>cd ~/ubuntu-18.04_imx6ul_qemu_system/\nbook@100ask:~/ubuntu-18.04_imx6ul_qemu_system$ ls\nimx6ull-system-image  install_sdl.sh  qemu  qemu-imx6ull-gui.sh  qemu-imx6ull-nogui.sh  README.md  ubuntu-18.04_sdl-package\nbook@100ask:~/ubuntu-18.04_imx6ul_qemu_system$ ./qemu-imx6ull-gui.sh\n</code></pre>"},{"location":"03_LCD/05/#13-qemu","title":"1.3 \u200b\u9000\u51fa\u200bQEMU","text":"<p>\u200b\u5982\u679c\u200b\u5728\u200bQEMU\u200b\u7684\u200bGUI\u200b\u754c\u9762\u200b\u4e2d\u200b\u53d1\u73b0\u200b\u9f20\u6807\u200b\u65e0\u6cd5\u200b\u79fb\u51fa\u6765\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u6309\u4e0b\u200b\"Ctrl + Alt + G\"\u200b\u9000\u51fa\u200bGUI\u200b\u754c\u9762\u200b\u3002</p> <p>\u200b\u8981\u200b\u9000\u51fa\u200bQEMU\uff0c\u200b\u5728\u200b\u7ec8\u7aef\u200b\u4e2d\u200b\u540c\u65f6\u200b\u6309\u4f4f\u200bCtrl\u200b\u952e\u200b\u3001A\u200b\u952e\u200b\uff0c\u200b\u7136\u540e\u200b\u540c\u65f6\u200b\u677e\u5f00\u200b\uff0c\u200b\u6700\u540e\u200b\u6309\u4e0b\u200bX\u200b\u952e\u200b\u3002</p>"},{"location":"03_LCD/05/#2","title":"2. \u200b\u4e0b\u8f7d\u200b\u3001\u200b\u7f16\u8bd1\u200b\u5185\u6838","text":"<p>\u200b\u53c2\u8003\u200b\uff1a<code>http://wiki.100ask.org/Qemu</code></p>"},{"location":"03_LCD/05/#21","title":"2.1 \u200b\u4e0b\u8f7d\u200b\u6e90\u7801","text":"<p>\u200b\u5728\u200bUbuntu\u200b\u4e2d\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b\uff1a</p> <pre><code>book@100ask:~$ git clone https://e.coding.net/codebug8/repo.git\nbook@100ask:~$ mkdir -p 100ask_imx6ull-qemu &amp;&amp; cd 100ask_imx6ull-qemu\nbook@100ask:~/100ask_imx6ull-qemu$ ../repo/repo init -u https://e.coding.net/weidongshan/manifests.git -b linux-sdk -m  imx6ull/100ask-imx6ull_qemu_release_v1.0.xml --no-repo-verify\nbook@100ask:~/100ask_imx6ull-qemu$ ../repo/repo sync -j4\n</code></pre> <p>\u200b\u4e0b\u8f7d\u200b\u6210\u529f\u200b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u5982\u4e0b\u200b\u5185\u5bb9\u200b\uff1a</p> <pre><code>book@100ask:~$ cd 100ask_imx6ull-qemu/\nbook@100ask:~/100ask_imx6ull-qemu$ ls\nbuildroot2019.02  linux-4.9.88  qemu  ToolChain\n</code></pre>"},{"location":"03_LCD/05/#22","title":"2.2 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<p>\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b\uff1a</p> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-qemu/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre> <p>\u200b\u6211\u4eec\u200b\u5e76\u200b\u4e0d\u662f\u200b\u7ecf\u5e38\u200b\u4f7f\u7528\u200bQEMU\uff0c\u200b\u6240\u4ee5\u200b\u5c31\u200b\u624b\u5de5\u200b\u6267\u884c\u200b\u8fd9\u4e9b\u200b\u547d\u4ee4\u200b\u5427\u200b\u3002 \u200b\u5728\u200b\u4e00\u4e2a\u200b\u7ec8\u7aef\u200b\u91cc\u200b\u8981\u200b\u7f16\u8bd1\u200b\u5185\u6838\u200b\u7684\u8bdd\u200b\uff0c\u200b\u90fd\u200b\u9700\u8981\u200b\u624b\u5de5\u200b\u6267\u884c\u200b\u4e0a\u8ff0\u200b\u547d\u4ee4\u200b\u3002</p>"},{"location":"03_LCD/05/#23","title":"2.3 \u200b\u914d\u7f6e\u200b\u3001\u200b\u7f16\u8bd1\u200b\u5185\u6838","text":"<p>\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b\uff1a</p> <pre><code>book@100ask:~/100ask_imx6ull-qemu$ cd linux-4.9.88\nbook@100ask:~/100ask_imx6ull-qemu/linux-4.9.88$ make mrproper\nbook@100ask:~/100ask_imx6ull-qemu/linux-4.9.88$ make 100ask_imx6ull_qemu_defconfig\nbook@100ask:~/100ask_imx6ull-qemu/linux-4.9.88$ make zImage\n</code></pre>"},{"location":"03_LCD/05/#24-qemuzimage","title":"2.4 \u200b\u5728\u200bQEMU\u200b\u4e2d\u200b\u4f7f\u7528\u200b\u65b0\u200b\u7684\u200bzImage","text":"<p>\u200b\u628a\u200b\u7f16\u8bd1\u200b\u51fa\u6765\u200b\u7684\u200bzImage\u200b\u590d\u5236\u5230\u200bQEMU\u200b\u76ee\u5f55\u200b<code>ubuntu-18.04_imx6ul_qemu_system/imx6ull-system-image</code>\u200b\u5373\u53ef\u200b\uff1a</p> <pre><code>book@100ask:~$ cd ~/ubuntu-18.04_imx6ul_qemu_system/\nbook@100ask:~/ubuntu-18.04_imx6ul_qemu_system$ cp ~/100ask_imx6ull-qemu/linux-4.9.88/arch/arm/boot/zImage  imx6ull-system-image/\n</code></pre> <p>\u200b\u7136\u540e\u200b\u91cd\u65b0\u542f\u52a8\u200bQEMU\u3002</p>"},{"location":"03_LCD/05/#3-lcd","title":"3. \u200b\u66ff\u6362\u200bLCD\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>QEMU\u200b\u6240\u7528\u200b\u7684\u200b\u5185\u6838\u200b\u91cc\u200b\u5df2\u7ecf\u200b\u5e26\u6709\u200bLCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e86\u200b\uff0c\u200b\u8981\u200b\u6d4b\u8bd5\u200b\u6211\u4eec\u200b\u7f16\u5199\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u9700\u8981\u200b\u505a\u200b2\u200b\u4ef6\u200b\u4e8b\u200b\uff1a</p> <ul> <li> <p>\u200b\u628a\u200b lcd_drv.c \u200b\u653e\u5230\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b<code>linux-4.9.88/drivers/video/fbdev</code></p> </li> <li> <p>\u200b\u4fee\u6539\u200b<code>linux-4.9.88/drivers/video/fbdev/Makefile</code>\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> </li> </ul> <pre><code>#obj-y += 100ask_qemu_fb.o\nobj-y += lcd_drv.o\n</code></pre> <p>\u200b\u6700\u540e\u200b\uff0c\u200b\u5373\u53ef\u200b\u91cd\u65b0\u200b\u6267\u884c\u200b<code>make zImage</code>\u200b\u7f16\u8bd1\u200b\u5185\u6838\u200b\uff0c\u200b\u5185\u6838\u200b\u91cc\u200b\u5c31\u200b\u542b\u6709\u200b\u65b0\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e86\u200b\u3002</p>"},{"location":"03_LCD/05/#4","title":"4. \u200b\u6d4b\u8bd5","text":"<p>\u200b\u4f7f\u7528\u200b\u65b0\u200b\u5185\u6838\u200b\u542f\u52a8\u200bQEMU\u200b\u540e\u200b\uff0c\u200b\u6267\u884c\u200bfb-test\u200b\u53ca\u200b\u53ef\u200b\u6d4b\u8bd5\u200b\u3002</p> <p></p>"},{"location":"03_LCD/06_1/","title":"06_\u200b\u7ed3\u5408\u200bAPP\u200b\u5206\u6790\u200bLCD\u200b\u9a71\u52a8\u7a0b\u5e8f","text":""},{"location":"03_LCD/06_1/#applcd","title":"\u7ed3\u5408\u200bAPP\u200b\u5206\u6790\u200bLCD\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u5bf9\u5e94\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u4e2d\u200b\uff0c\u200b\u4f4d\u7f6e\u200b\u5982\u4e0b\u200b(\u200b\u8fd9\u200b2\u200b\u4e2a\u200b\u6587\u4ef6\u200b\u662f\u200b\u5b8c\u5168\u200b\u4e00\u6837\u200b\u7684\u200b)\uff1a</p> <pre><code>doc_and_source_for_drivers\\STM32MP157\\source\\A7\\03_LCD\\04_fb_test\n\u200b\u6216\u200b\uff1a\ndoc_and_source_for_drivers\\IMX6ULL\\source\\03_LCD\\04_fb_test\n</code></pre>"},{"location":"03_LCD/06_1/#1-open","title":"1. open","text":"<pre><code>app:  open(\"/dev/fb0\", ...)   \u200b\u4e3b\u200b\u8bbe\u5907\u200b\u53f7\u200b: 29, \u200b\u6b21\u200b\u8bbe\u5907\u200b\u53f7\u200b: 0\n--------------------------------------------------------------\nkernel:\n         fb_open   // fbmem.c\n            struct fb_info *info;\n            info = get_fb_info(fbidx);\n\n            if (info-&gt;fbops-&gt;fb_open) {\n                res = info-&gt;fbops-&gt;fb_open(info,1);   // \u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u9a71\u52a8\u200b\n                if (res)\n                    module_put(info-&gt;fbops-&gt;owner);\n            }           \n</code></pre>"},{"location":"03_LCD/06_1/#2","title":"2. \u200b\u83b7\u5f97\u200b\u53ef\u53d8\u200b\u4fe1\u606f\u200b(\u200b\u542b\u6709\u200b\u5206\u8fa8\u7387\u200b\u7b49\u200b)","text":"<pre><code>app:    ioctl(fd, FBIOGET_VSCREENINFO, &amp;fb_info-&gt;var);\n-------------------------------------------------------------------------\nkernel:\n         fb_ioctl   // fbmem.c\n            struct fb_info *info = file_fb_info(file);\n\n            do_fb_ioctl(info, cmd, arg);\n                var = info-&gt;var;     // \u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u9a71\u52a8\u200b\u8bbe\u7f6e\u200b\u7684\u200b\n                ret = copy_to_user(argp, &amp;var, sizeof(var)) ? -EFAULT : 0;\n</code></pre>"},{"location":"03_LCD/06_1/#3","title":"3. \u200b\u83b7\u5f97\u200b\u56fa\u5b9a\u200b\u4fe1\u606f\u200b(\u200b\u542b\u6709\u200b\u663e\u5b58\u200b\u4fe1\u606f\u200b)","text":"<pre><code>app:    ioctl(fd, FBIOGET_FSCREENINFO, &amp;fb_info-&gt;fix);\n-------------------------------------------------------------------------\nkernel:\n         fb_ioctl   // fbmem.c\n            struct fb_info *info = file_fb_info(file);\n\n            do_fb_ioctl(info, cmd, arg);\n                fix = info-&gt;fix;     // \u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u9a71\u52a8\u200b\u8bbe\u7f6e\u200b\u7684\u200b\n                ret = copy_to_user(argp, &amp;fix, sizeof(fix)) ? -EFAULT : 0;\n</code></pre>"},{"location":"03_LCD/06_1/#4-mmap","title":"4. mmap","text":"<pre><code>app\uff1avoid *ptr = mmap(0,\n            fb_info-&gt;var.yres_virtual * fb_info-&gt;fix.line_length,\n            PROT_WRITE | PROT_READ,\n            MAP_SHARED, fd, 0);\n-------------------------------------------------------------------------\nkernel:\n         fb_mmap   // fbmem.c\n            struct fb_info *info = file_fb_info(file);\n\n            start = info-&gt;fix.smem_start;\n            len = info-&gt;fix.smem_len;\n            return vm_iomap_memory(vma, start, len);\n</code></pre>"},{"location":"03_LCD/06_1/#5","title":"5. \u200b\u7ed8\u5236\u200b\u56fe\u7247","text":""},{"location":"03_LCD/07_1/","title":"07_\u200b\u786c\u4ef6\u200b_8080\u200b\u63a5\u53e3\u200bLCD\u200b\u65f6\u5e8f\u200b\u5206\u6790","text":""},{"location":"03_LCD/07_1/#_8080lcd","title":"\u786c\u4ef6\u200b_8080\u200b\u63a5\u53e3\u200bLCD\u200b\u65f6\u5e8f\u200b\u5206\u6790","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff0cGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff1a</p> <ul> <li> <p>8080\u200b\u63a5\u53e3\u200bLCD</p> </li> <li> <p>\u200b\u63a5\u53e3\u200b\u539f\u7406\u56fe\u200b\uff1a<code>\u200b\u5176\u4ed6\u200b\u8d44\u6599\u200b\\STM32F103\\\u200b\u539f\u7406\u56fe\u200b\\100ASK_STM32F103_V10_0707FINAL.pdf</code></p> </li> <li> <p>LCD\u200b\u6570\u636e\u200b\u624b\u518c\u200b\uff1a</p> </li> <li> <p><code>\u200b\u5176\u4ed6\u200b\u8d44\u6599\u200b\\STM32F103\\datasheet\\LCD\u200b\u663e\u793a\u5c4f\u200b\u8d44\u6599\u200b\\3.5\u200b\u5bf8\u200b\\LCD_3.5\u200b\u5bf8\u200b_320x480_ILI9488_\u200b\u6db2\u6676\u663e\u793a\u200b\u6a21\u5757\u200b\u89c4\u683c\u4e66\u200b.pdf</code></p> </li> <li><code>\u200b\u5176\u4ed6\u200b\u8d44\u6599\u200b\\STM32F103\\datasheet\\LCD\u200b\u663e\u793a\u5c4f\u200b\u8d44\u6599\u200b\\3.5\u200b\u5bf8\u200b\\ILI9488\u200b\u9a71\u52a8\u200b\u82af\u7247\u200b\u6570\u636e\u200b\u624b\u518c\u200b.pdf</code></li> </ul>"},{"location":"03_LCD/07_1/#1","title":"1. \u200b\u63a5\u53e3\u200b\u539f\u7406\u56fe","text":""},{"location":"03_LCD/07_1/#11-8080","title":"1.1 8080\u200b\u63a5\u53e3\u200b\u539f\u7406\u56fe","text":""},{"location":"03_LCD/07_1/#12-tft-rgb","title":"1.2 TFT-RGB\u200b\u63a5\u53e3\u200b\u539f\u7406\u56fe","text":""},{"location":"03_LCD/07_1/#2-8080","title":"2. 8080\u200b\u63a5\u53e3\u200b\u65f6\u5e8f\u200b\u56fe","text":""},{"location":"03_LCD/08_1/","title":"08_\u200b\u786c\u4ef6\u200b_TFT-RGB\u200b\u63a5\u53e3\u200bLCD\u200b\u65f6\u5e8f\u200b\u5206\u6790","text":""},{"location":"03_LCD/08_1/#_tft-rgblcd","title":"\u786c\u4ef6\u200b_TFT-RGB\u200b\u63a5\u53e3\u200bLCD\u200b\u65f6\u5e8f\u200b\u5206\u6790","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff0cGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff1a</p> <ul> <li> <ul> <li>TFT-RGB LCD</li> </ul> </li> <li> <p>\u200b\u63a5\u53e3\u200b\u539f\u7406\u56fe\u200b\uff1a</p> <ul> <li>`IMX6ULL\\\u200b\u5f00\u53d1\u677f\u200b\u914d\u5957\u200b\u8d44\u6599\u200b\\\u200b\u539f\u7406\u56fe\u200b\\Base_board\\100ask_imx6ull_v1.1.pdf``</li> <li><code>`STM32MP157\\\u200b\u5f00\u53d1\u677f\u200b\u914d\u5957\u200b\u8d44\u6599\u200b\\\u200b\u539f\u7406\u56fe\u200b\\01_Base_board(\u200b\u5e95\u677f\u200b)\\100ASK_STM32MP157_PRO_V11_\u200b\u5e95\u677f\u200b\u539f\u7406\u56fe\u200b.pdf</code></li> </ul> </li> <li> <p>LCD\u200b\u6570\u636e\u200b\u624b\u518c\u200b(\u200b\u8fd9\u200b2\u200b\u4e2a\u200b\u6587\u4ef6\u200b\u662f\u200b\u4e00\u6837\u200b\u7684\u200b)\uff1a</p> <ul> <li>`IMX6ULL\\\u200b\u5f00\u53d1\u677f\u200b\u914d\u5957\u200b\u8d44\u6599\u200b\\datasheet\\Base_board\\100ask_imx6ull\u200b\u5e95\u677f\u200b_\u200b\u89c4\u683c\u4e66\u200b\\7.0-13SPEC(7\u200b\u5bf8\u200b1024600TN-RGB).pdf``</li> <li><code>STM32MP157\\\u200b\u5f00\u53d1\u677f\u200b\u914d\u5957\u200b\u8d44\u6599\u200b\\datasheeet\\03_7\u200b\u5bf8\u200bLCD\u200b\u6a21\u5757\u200b\\LCD\u200b\u6570\u636e\u200b\u624b\u518c\u200b7.0-13SPEC(7\u200b\u5bf8\u200b1024600TN-RGB).pdf</code></li> </ul> </li> </ul>"},{"location":"03_LCD/08_1/#1","title":"1. \u200b\u63a5\u53e3\u200b\u539f\u7406\u56fe","text":""},{"location":"03_LCD/08_1/#11-tft-rgb","title":"1.1 TFT-RGB\u200b\u63a5\u53e3\u200b\u539f\u7406\u56fe","text":""},{"location":"03_LCD/08_1/#2-tft-rgb","title":"2. TFT-RGB\u200b\u63a5\u53e3\u200b\u65f6\u5e8f\u200b\u56fe","text":""},{"location":"03_LCD/08_1/#21-lcd","title":"2.1 LCD\u200b\u65f6\u5e8f\u200b\u56fe","text":""},{"location":"03_LCD/08_1/#22-lcd","title":"2.2 LCD\u200b\u63a7\u5236\u5668\u200b\u65f6\u5e8f\u200b\u56fe","text":""},{"location":"03_LCD/09_1/","title":"09_\u200b\u786c\u4ef6\u200b_IMX6ULL\u200b\u7684\u200bLCD\u200b\u63a7\u5236\u5668","text":""},{"location":"03_LCD/09_1/#_imx6ulllcd","title":"\u786c\u4ef6\u200b_IMX6ULL\u200b\u7684\u200bLCD\u200b\u63a7\u5236\u5668","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff0cGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff1a</p> <ul> <li><code>IMX6ULL\\\u200b\u5f00\u53d1\u677f\u200b\u914d\u5957\u200b\u8d44\u6599\u200b\\datasheet\\Core_board\\CPU\\IMX6ULLRM.pdf</code></li> <li> <p><code>\u300aChapter 34 Enhanced LCD Interface (eLCDIF)\u300b</code></p> </li> <li> <p>IMX6ULL\u200b\u7684\u200bLCD\u200b\u88f8\u673a\u200b\u7a0b\u5e8f\u200b</p> </li> <li> <p><code>IMX6ULL\\source\\03_LCD\\05_\u200b\u53c2\u8003\u200b\u7684\u200b\u88f8\u673a\u200b\u6e90\u7801\u200b\\03_font_test</code></p> </li> </ul>"},{"location":"03_LCD/09_1/#1-lcd","title":"1. LCD\u200b\u63a7\u5236\u5668\u200b\u6a21\u5757\u200b\u4ecb\u7ecd","text":""},{"location":"03_LCD/09_1/#11","title":"1.1 \u200b\u786c\u4ef6\u200b\u6846\u56fe","text":"<p>IMX6ULL\u200b\u7684\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u540d\u79f0\u200b\u4e3a\u200beLCDIF(Enhanced LCD Interface\uff0c\u200b\u589e\u5f3a\u578b\u200bLCD\u200b\u63a5\u53e3\u200b)\uff0c\u200b\u4e3b\u8981\u200b\u7279\u6027\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u652f\u6301\u200bMPU\u200b\u6a21\u5f0f\u200b\uff1a\u200b\u6709\u4e9b\u200b\u663e\u793a\u5c4f\u200b\u81ea\u5e26\u200b\u663e\u5b58\u200b\uff0c\u200b\u53ea\u200b\u9700\u8981\u200b\u628a\u200b\u547d\u4ee4\u200b\u3001\u200b\u6570\u636e\u200b\u53d1\u9001\u7ed9\u200b\u663e\u793a\u5c4f\u200b\u5373\u53ef\u200b\uff1b\u200b\u5c31\u662f\u200b\u524d\u9762\u200b\u8bb2\u200b\u7684\u200b8080\u200b\u63a5\u53e3\u200b</li> <li>VSYNC\u200b\u6a21\u5f0f\u200b\uff1a\u200b\u8ddf\u200bMPU\u200b\u6a21\u5f0f\u200b\u7c7b\u4f3c\u200b\uff0c\u200b\u591a\u200b\u4e86\u200bVSYNC\u200b\u4fe1\u53f7\u200b\u3002\u200b\u9488\u5bf9\u200b\u9ad8\u901f\u200b\u6570\u636e\u4f20\u8f93\u200b\uff08\u200b\u884c\u573a\u200b\u4fe1\u53f7\u200b\uff09</li> <li>\u200b\u652f\u6301\u200bDOTCLK\u200b\u6a21\u5f0f\u200b\uff1aRGB\u200b\u63a5\u53e3\u200b\uff0c\u200b\u5c31\u662f\u200b\u524d\u9762\u200b\u8bb2\u200b\u7684\u200bTFT-RGB\u200b\u63a5\u53e3\u200b</li> <li>\u200b\u652f\u6301\u200bITU-R BT.656\u200b\u63a5\u53e3\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u628a\u200b4:2:2 YcbCr\u200b\u683c\u5f0f\u200b\u7684\u200b\u6570\u636e\u200b\u8f6c\u6362\u200b\u4e3a\u200b\u6a21\u62df\u200b\u7535\u89c6\u4fe1\u53f7\u200b</li> <li>8/16/18/24/32 bit \u200b\u7684\u200bbpp\u200b\u6570\u636e\u200b\u90fd\u200b\u652f\u6301\u200b\uff0c\u200b\u53d6\u51b3\u4e8e\u200bIO\u200b\u7684\u200b\u590d\u7528\u200b\u8bbe\u7f6e\u200b\u53ca\u200b\u5bc4\u5b58\u5668\u200b\u914d\u7f6e\u200b</li> <li>MPU\u200b\u6a21\u5f0f\u200b\uff0cVSYNC\u200b\u6a21\u5f0f\u200b\uff0cDOTCLK\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u914d\u7f6e\u200b\u65f6\u5e8f\u200b\u53c2\u6570\u200b\u3002</li> </ul> <p></p> <p>\u200b\u4e0a\u56fe\u200b\u662f\u200bIMX6ULL\u200b\u7684\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u6846\u56fe\u200b\u3002 \u200b\u6211\u4eec\u200b\u5728\u200b\u5185\u5b58\u200b\u4e2d\u200b\u5212\u51fa\u200b\u4e00\u5757\u200b\u5185\u5b58\u200b\uff0c\u200b\u79f0\u4e4b\u4e3a\u200b\u663e\u5b58\u200b\uff0c\u200b\u8f6f\u4ef6\u200b\u628a\u200b\u6570\u636e\u200b\u5199\u5165\u200b\u663e\u5b58\u200b\u3002 \u200b\u8bbe\u7f6e\u200b\u597d\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u4e4b\u540e\u200b\uff0c\u200b\u5b83\u4f1a\u200b\u901a\u8fc7\u200bAXI\u200b\u603b\u7ebf\u200b\u534f\u8bae\u200b\u4ece\u200b\u663e\u5b58\u200b\u628a\u200bRGB\u200b\u6570\u636e\u200b\u8bfb\u5165\u200bFIFO\uff0c\u200b\u518d\u200b\u5230\u8fbe\u200bLCD\u200b\u63a5\u53e3\u200b(LCD Interface)\u3002 LCD\u200b\u63a7\u5236\u5668\u200b\u6709\u200b\u4e24\u4e2a\u200b\u65f6\u949f\u200b\u57df\u200b\uff1a\u200b\u5916\u8bbe\u200b\u603b\u7ebf\u200b\u65f6\u949f\u200b\u57df\u200b\uff0cLCD\u200b\u50cf\u7d20\u200b\u65f6\u949f\u200b\u57df\u200b\u3002\u200b\u524d\u8005\u200b\u662f\u200b\u7528\u6765\u200b\u8ba9\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u6b63\u5e38\u200b\u5de5\u4f5c\u200b\uff0c\u200b\u540e\u8005\u200b\u662f\u200b\u7528\u6765\u200b\u63a7\u5236\u200b\u7535\u5b50\u67aa\u200b\u79fb\u52a8\u200b\u3002 \u200b\u4e0a\u56fe\u200b\u7684\u200bRead_Data\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u5728\u200bMPU\u200b\u6a21\u5f0f\u200b\u4e0b\u624d\u200b\u7528\u5230\u200b\uff1b\u200b\u6211\u4eec\u200b\u91c7\u7528\u200b\u7684\u200b\u662f\u200bDCLK\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u56e0\u6b64\u200b\u4e0d\u4e88\u8003\u8651\u200b\u3002</p> <p>\u200b\u66f4\u200b\u8be6\u7ec6\u200b\u7684\u200b\u5185\u5bb9\u200b\u53ef\u4ee5\u200b\u67e5\u770b\u200bIMX6ull\u200b\u82af\u7247\u200b\u624b\u518c\u200b\u300aChapter 34 Enhanced LCD Interface (eLCDIF)\u300b\u3002</p>"},{"location":"03_LCD/09_1/#12","title":"1.2 \u200b\u6570\u636e\u4f20\u8f93\u200b\u4e0e\u200b\u5904\u7406","text":"<ul> <li>\u200b\u6846\u56fe\u200b\uff1a</li> </ul> <ul> <li>\u200b\u4e3e\u4f8b\u8bf4\u660e\u200b\uff1a\u200b\u89c1\u200b\u89c6\u9891\u200b</li> </ul>"},{"location":"03_LCD/09_1/#13","title":"1.3 \u200b\u65f6\u5e8f\u200b\u63a7\u5236","text":"<p>\u200b\u770b\u200b\u5bc4\u5b58\u5668\u200b\u8bf4\u660e\u200b\u3002</p>"},{"location":"03_LCD/09_1/#2-lcd","title":"2. LCD\u200b\u63a7\u5236\u5668\u200b\u5bc4\u5b58\u5668\u200b\u7b80\u4ecb","text":"<p>\u200b\u67e5\u770b\u200b\u4efb\u4f55\u200b\u82af\u7247\u200b\u7684\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u5bc4\u5b58\u5668\u200b\u65f6\u200b\uff0c\u200b\u8bb0\u4f4f\u200b\u51e0\u4e2a\u200b\u8981\u70b9\u200b\uff1a</p> <p>\u2460 \u200b\u600e\u4e48\u200b\u628a\u200bLCD\u200b\u7684\u200b\u4fe1\u606f\u200b\u544a\u8bc9\u200bLCD\u200b\u63a7\u5236\u5668\u200b\uff1a\u200b\u5373\u200b\u5206\u8fa8\u7387\u200b\u3001\u200b\u884c\u5217\u200b\u65f6\u5e8f\u200b\u3001\u200b\u50cf\u7d20\u200b\u65f6\u949f\u200b\u7b49\u200b\uff1b \u2461 \u200b\u600e\u4e48\u200b\u628a\u200b\u663e\u5b58\u200b\u5730\u5740\u200b\u3001\u200b\u50cf\u7d20\u200b\u683c\u5f0f\u200b\u544a\u8bc9\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u3002</p> <p></p> <p>\u200b\u4e0a\u56fe\u200b\u662f\u200b\u6211\u4eec\u200b\u5c06\u8981\u200b\u4f7f\u7528\u200b\u5230\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u4e0b\u9762\u200b\u9010\u4e2a\u200b\u8bb2\u89e3\u200b\u8fd9\u4e9b\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u5728\u200b\u540e\u7eed\u200b\u7684\u200bLCD\u200b\u63a7\u5236\u200b\u7f16\u7a0b\u200b\u5b9e\u9a8c\u200b\u4f1a\u200b\u7528\u5230\u200b\u3002</p>"},{"location":"03_LCD/09_1/#21-lcdif_ctrl","title":"2.1 LCDIF_CTRL\u200b\u5bc4\u5b58\u5668","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b [31] SFTRST R/W \u200b\u8f6f\u4ef6\u200b\u590d\u4f4d\u200b\uff0c\u200b\u6b63\u5e38\u200b\u5de5\u4f5c\u200b\u65f6\u5e94\u200b\u8bbe\u4e3a\u200b0\uff1b\u200b\u5982\u679c\u200b\u8bbe\u200b\u4e3a\u200b1\uff0c\u200b\u5b83\u4f1a\u200b\u590d\u4f4d\u200b\u6574\u4e2a\u200bLCD\u200b\u63a7\u5236\u5668\u200b [30] CLKGATE R/W \u200b\u65f6\u949f\u200b\u5f00\u5173\u200b\uff0c  0\uff1a\u200b\u6b63\u5e38\u200b\u5de5\u4f5c\u200b\u65f6\u8981\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b0\uff1b  1\uff1a\u200b\u5173\u95ed\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u65f6\u949f\u200b [29] YCBCR422_INPUT R/W \u200b\u4f7f\u7528\u200bRGB\u200b\u63a5\u53e3\u200b\u65f6\u200b\uff0c\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b0\uff1b\u200b\u5176\u4ed6\u200b\u63a5\u53e3\u200b\u6211\u4eec\u200b\u6682\u65f6\u200b\u4e0d\u200b\u5173\u5fc3\u200b [28] READ_WRITEB R/W \u200b\u4f7f\u7528\u200bRGB\u200b\u63a5\u53e3\u200b\u65f6\u200b\uff0c\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b0\uff1b\u200b\u5176\u4ed6\u200b\u63a5\u53e3\u200b\u6211\u4eec\u200b\u6682\u65f6\u200b\u4e0d\u200b\u5173\u5fc3\u200b [27] WAIT_FOR_VSYNC_EDGE R/W \u200b\u5728\u200bVSYNC\u200b\u6a21\u5f0f\u200b\u65f6\u200b\uff0c\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b1\uff1b\u200b\u6211\u4eec\u200b\u4e0d\u200b\u5173\u5fc3\u200b [26] DATA_SHIFT_DIR R/W \u200b\u5728\u200bDVI\u200b\u6a21\u5f0f\u200b\u4e0b\u624d\u200b\u9700\u8981\u200b\u8bbe\u7f6e\u200b\uff0c\u200b\u6211\u4eec\u200b\u4e0d\u200b\u5173\u5fc3\u200b [25:21] SHIFT_NUM_BITS R/W \u200b\u5728\u200bDVI\u200b\u6a21\u5f0f\u200b\u4e0b\u624d\u200b\u9700\u8981\u200b\u8bbe\u7f6e\u200b\uff0c\u200b\u6211\u4eec\u200b\u4e0d\u200b\u5173\u5fc3\u200b [20] DVI_MODE R/W \u200b\u8bbe\u7f6e\u200b\u4e3a\u200b1\u200b\u65f6\u200b\uff0c\u200b\u4f7f\u7528\u200bDVI\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u5c31\u662f\u200bITU-R BT.656\u200b\u6570\u5b57\u200b\u63a5\u53e3\u200b [19] BYPASS_COUNT R/W DOTCLK\u200b\u548c\u200bDVI\u200b\u6a21\u5f0f\u200b\u4e0b\u200b\u9700\u8981\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b1;MPU\u3001VSYNC\u200b\u6a21\u5f0f\u200b\u65f6\u8bbe\u200b\u4e3a\u200b0 [18] VSYNC_MODE R/W \u200b\u4f7f\u7528\u200bVSYNC\u200b\u6a21\u5f0f\u200b\u65f6\u200b\uff0c\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b1 [17] DOTCLK_MODE R/W \u200b\u4f7f\u7528\u200bDOTCLK\u200b\u6a21\u5f0f\u200b\u65f6\u200b\uff0c\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b1\uff1b\u200b\u672c\u200b\u5b9e\u9a8c\u200b\u7528\u200b\u7684\u200b\u5c31\u662f\u200b\u8fd9\u4e2a\u200b\u6a21\u5f0f\u200b [16] DATA_SELECT R/W MPU\u200b\u6a21\u5f0f\u200b\u4e0b\u624d\u200b\u7528\u5230\u200b\uff0c\u200b\u6211\u4eec\u200b\u4e0d\u200b\u5173\u5fc3\u200b [15:14] INPUT_DATA_SWIZZLE R/W \u200b\u663e\u5b58\u200b\u4e2d\u200b\u50cf\u7d20\u200b\u989c\u8272\u200b\u7684\u200b\u6570\u636e\u200b\u8f6c\u7ed9\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u65f6\u200b\uff0c\u200b\u5b57\u8282\u200b\u4f4d\u7f6e\u200b\u662f\u5426\u200b\u4ea4\u6362\u200b\uff1a  0x0\uff1aNO_SWAP\uff0c\u200b\u4e0d\u200b\u4ea4\u6362\u200b\uff1b 0x0\uff1aLITTLE_ENDIAN\uff0c\u200b\u5c0f\u5b57\u200b\u8282\u5e8f\u200b\uff0c\u200b\u8ddf\u200bNO_SWAP\u200b\u4e00\u6837\u200b\uff1b  0x1\uff1aBIG_ENDIAN_SWAP\uff0c\u200b\u5b57\u8282\u200b0\u30013\u200b\u4ea4\u6362\u200b\uff1b\u200b\u5b57\u8282\u200b1\u30012\u200b\u4ea4\u6362\u200b\uff1b  0x1\uff1aSWAP_ALL_BYTES\uff0c\u200b\u5b57\u8282\u200b0\u30013\u200b\u4ea4\u6362\u200b\uff1b\u200b\u5b57\u8282\u200b1\u30012\u200b\u4ea4\u6362\u200b\uff1b  0x2\uff1aHWD_SWAP\uff0c\u200b\u534a\u5b57\u200b\u4ea4\u6362\u200b\uff0c\u200b\u5373\u200b0x12345678\u200b\u8f6c\u4e3a\u200b0x56781234  0x3\uff1aHWD_BYTE_SWAP\uff0c\u200b\u5728\u200b\u6bcf\u4e2a\u200b\u534a\u5b57\u200b\u5185\u90e8\u200b\u653e\u6362\u200b\u5b57\u8282\u200b\uff0c     \u200b\u5373\u200b0x12345678\u200b\u8f6c\u6362\u200b\u4e3a\u200b0x34127856 [13:12] CSC_DATA_SWIZZLE R/W \u200b\u663e\u5b58\u200b\u4e2d\u200b\u7684\u200b\u6570\u636e\u200b\u88ab\u200b\u4f20\u5165\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u5185\u90e8\u200b\u5e76\u200b\u88ab\u200b\u8f6c\u6362\u200b\u4e3a\u200b24BPP\u200b\u540e\u200b\uff0c\u200b\u5728\u200b\u5b83\u200b\u88ab\u200b\u8f6c\u7ed9\u200bLCD\u200b\u63a5\u53e3\u200b\u4e4b\u524d\u200b\uff0c\u200b\u5b57\u8282\u200b\u4f4d\u7f6e\u200b\u662f\u5426\u200b\u4ea4\u6362\u200b\uff1a  0x0\uff1aNO_SWAP\uff0c\u200b\u4e0d\u200b\u4ea4\u6362\u200b\uff1b  0x0\uff1aLITTLE_ENDIAN\uff0c\u200b\u5c0f\u5b57\u200b\u8282\u5e8f\u200b\uff0c\u200b\u8ddf\u200bNO_SWAP\u200b\u4e00\u6837\u200b\uff1b  0x1\uff1aBIG_ENDIAN_SWAP\uff0c\u200b\u5b57\u8282\u200b0\u30013\u200b\u4ea4\u6362\u200b\uff1b\u200b\u5b57\u8282\u200b1\u30012\u200b\u4ea4\u6362\u200b\uff1b  0x1\uff1aSWAP_ALL_BYTES\uff0c\u200b\u5b57\u8282\u200b0\u30013\u200b\u4ea4\u6362\u200b\uff1b\u200b\u5b57\u8282\u200b1\u30012\u200b\u4ea4\u6362\u200b\uff1b  0x2\uff1aHWD_SWAP\uff0c\u200b\u534a\u5b57\u200b\u4ea4\u6362\u200b\uff0c\u200b\u5373\u200b0x12345678\u200b\u8f6c\u4e3a\u200b0x56781234  0x3\uff1aHWD_BYTE_SWAP\uff0c\u200b\u5728\u200b\u6bcf\u4e2a\u200b\u534a\u5b57\u200b\u5185\u90e8\u200b\u653e\u6362\u200b\u5b57\u8282\u200b\uff0c     \u200b\u5373\u200b0x12345678\u200b\u8f6c\u6362\u200b\u4e3a\u200b0x34127856 [11:10] LCD_DATABUS_WIDTH R/W LCD\u200b\u6570\u636e\u603b\u7ebf\u200b\u5bbd\u5ea6\u200b\uff0c\u200b\u5c31\u662f\u200b\u5bf9\u5916\u200b\u8f93\u51fa\u200b\u7684\u200bLCD\u200b\u6570\u636e\u200b\u7684\u200b\u4f4d\u200b\u5bbd\u200b\uff0c  0x0\uff1a16\u200b\u4f4d\u200b\uff1b  0x1\uff1a8\u200b\u4f4d\u200b\uff1b  0x2\uff1a18\u200b\u4f4d\u200b\uff1b  0x3\uff1a24\u200b\u4f4d\u200b [9:8] WORD_LENGTH R/W \u200b\u8f93\u5165\u200b\u7684\u200b\u6570\u636e\u683c\u5f0f\u200b\uff0c\u200b\u5373\u200b\u663e\u5b58\u200b\u4e2d\u200b\u6bcf\u4e2a\u200b\u50cf\u7d20\u200b\u5360\u200b\u591a\u5c11\u200b\u4f4d\u200b\uff0c  0x0\uff1a16\u200b\u4f4d\u200b\uff1b  0x1\uff1a8\u200b\u4f4d\u200b\uff1b  0x2\uff1a18\u200b\u4f4d\u200b\uff1b  0x3\uff1a24\u200b\u4f4d\u200b [7] RGB_TO_YCBCR422_CSC R/W \u200b\u8bbe\u7f6e\u200b\u4e3a\u200b1\u200b\u65f6\u200b\uff0c\u200b\u4f7f\u80fd\u200b\u989c\u8272\u200b\u7a7a\u95f4\u200b\u8f6c\u6362\u200b\uff1aRGB\u200b\u8f6c\u4e3a\u200bYCbCr [6] ENABLE_PXP_HANDSHAKE R/W \u200b\u5f53\u200bLCDIF_MASTER\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b1\u200b\u65f6\u200b\uff0c\u200b\u518d\u200b\u8bbe\u7f6e\u200b\u8fd9\u4f4d\u200b\uff0c  \u200b\u5219\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u8ddf\u200bPXP\u200b\u4e4b\u95f4\u200b\u7684\u200b\u63e1\u624b\u200b\u673a\u5236\u200b\u88ab\u200b\u5173\u95ed\u200b(\u200b\u6211\u4eec\u200b\u4e0d\u200b\u5173\u5fc3\u200b) [5] MASTER R/W \u200b\u8bbe\u7f6e\u200b\u4e3a\u200b1\u200b\u65f6\u200b\uff0cLCD\u200b\u63a7\u5236\u5668\u200b\u6210\u4e3a\u200bbus master [4] RSRVD0 R/W \u200b\u4fdd\u7559\u200b [3] DATA_FORMAT_16_BIT R/W WORD_LENGTH\u200b\u4e3a\u200b0\u200b\u65f6\u200b\uff0c\u200b\u8868\u793a\u200b\u4e00\u4e2a\u200b\u50cf\u7d20\u200b\u7528\u200b16\u200b\u4f4d\u200b\uff0c\u200b\u6b64\u4f4d\u200b\u4f5c\u7528\u200b\u5982\u4e0b\u200b\uff1a  0\uff1a\u200b\u6570\u636e\u683c\u5f0f\u200b\u4e3a\u200bARGB555\uff1b  1\uff1a\u200b\u6570\u636e\u683c\u5f0f\u200b\u4e3a\u200bRGB565 [2] DATA_FORMAT_18_BIT R/W WORD_LENGTH\u200b\u4e3a\u200b2\u200b\u65f6\u200b\uff0c\u200b\u8868\u793a\u200b\u4e00\u4e2a\u200b\u50cf\u7d20\u200b\u7528\u200b18\u200b\u4f4d\u200b\uff0cRGB\u200b\u6570\u636e\u200b\u8fd8\u662f\u200b\u4fdd\u5b58\u200b\u5728\u200b32\u200b\u4f4d\u200b\u6570\u636e\u200b\u91cc\u200b\uff0c\u200b\u6b64\u4f4d\u200b\u4f5c\u7528\u200b\u5982\u4e0b\u200b\uff1a  0\uff1a\u200b\u4f4e\u200b18\u200b\u4f4d\u200b\u7528\u6765\u200b\u8868\u793a\u200bRGB666\uff0c\u200b\u9ad8\u200b14\u200b\u4f4d\u200b\u65e0\u6548\u200b  1\uff1a\u200b\u9ad8\u200b18\u200b\u4f4d\u200b\u7528\u6765\u200b\u8868\u793a\u200bRGB666\uff0c\u200b\u4f4e\u200b14\u200b\u4f4d\u200b\u65e0\u6548\u200b [1] DATA_FORMAT_24_BIT R/W WORD_LENGTH\u200b\u4e3a\u200b3\u200b\u65f6\u200b\uff0c\u200b\u8868\u793a\u200b\u4e00\u4e2a\u200b\u50cf\u7d20\u200b\u7528\u200b24\u200b\u4f4d\u200b\uff0c\u200b\u6b64\u4f4d\u200b\u4f5c\u7528\u200b\u5982\u4e0b\u200b\uff1a  0\uff1a\u200b\u6240\u6709\u200b\u7684\u200b24\u200b\u4f4d\u200b\u6570\u636e\u200b\u90fd\u200b\u6709\u6548\u200b\uff0c\u200b\u683c\u5f0f\u200b\u4e3a\u200bRGB888  1\uff1a\u200b\u8f6c\u7ed9\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u6570\u636e\u200b\u662f\u200b24\u200b\u4f4d\u200b\u7684\u200b\uff0c\u200b\u4f46\u200b\u53ea\u7528\u200b\u5230\u200b\u5176\u4e2d\u200b\u7684\u200b18\u200b\u4f4d\u200b\uff0c    \u200b\u6bcf\u4e2a\u200b\u5b57\u8282\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u4e00\u4e2a\u200b\u539f\u8272\u200b\uff0c\u200b\u6bcf\u200b\u5b57\u8282\u200b\u4e2d\u200b\u9ad8\u200b2\u200b\u4f4d\u200b\u65e0\u6548\u200b [0] RUN R/W \u200b\u4f7f\u80fd\u200bLCD\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u5f00\u59cb\u200b\u4f20\u8f93\u6570\u636e"},{"location":"03_LCD/09_1/#22-lcdif_ctrl1","title":"2.2 LCDIF_CTRL1\u200b\u5bc4\u5b58\u5668","text":"<p>\u200b\u672c\u200b\u5b9e\u9a8c\u200b\u4e2d\u200b\u4f7f\u7528\u200bTFT LCD\uff0cLCD\u200b\u63a7\u5236\u5668\u200b\u4f7f\u7528\u200bDOTCLK\u200b\u6a21\u5f0f\u200b\u3002\u200b\u672c\u200b\u5bc4\u5b58\u5668\u200b\u4e2d\u200b\u5176\u4ed6\u200b\u7528\u200b\u4e0d\u5230\u200b\u7684\u200b\u4f4d\u200b\uff0c\u200b\u5c31\u200b\u4e0d\u200b\u4ecb\u7ecd\u200b\u4e86\u200b\u3002</p> \u200b\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b [19:16] BYTE_PACKING_FORMAT R/W \u200b\u7528\u6765\u200b\u8868\u793a\u200b\u4e00\u4e2a\u200b32\u200b\u4f4d\u200b\u7684\u200bword\u200b\u4e2d\u200b\uff0c\u200b\u54ea\u4e9b\u200b\u5b57\u8282\u200b\u662f\u200b\u6709\u6548\u200b\u7684\u200b\uff0c\u200b\u5373\u200b\u54ea\u4e9b\u200b\u5b57\u8282\u200b\u662f\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u989c\u8272\u200b\u7684\u200b\u3002  bit16\u300117\u300118\u300119\u200b\u5206\u522b\u200b\u5bf9\u5e94\u200bbyte0\u30011\u30012\u30013\uff1b\u200b\u67d0\u4f4d\u200b\u4e3a\u200b1\uff0c\u200b\u5c31\u200b\u8868\u793a\u200b\u5bf9\u5e94\u200b\u7684\u200b\u5b57\u8282\u200b\u6709\u6548\u200b\u3002  \u200b\u9ed8\u8ba4\u503c\u200b\u662f\u200b0xf\uff0c\u200b\u8868\u793a\u200b32\u200b\u4f4d\u200b\u7684\u200bword\u200b\u4e2d\u200b\uff0c\u200b\u6240\u6709\u200b\u5b57\u8282\u200b\u90fd\u200b\u6709\u6548\u200b\u3002  \u200b\u5bf9\u4e8e\u200b8bpp\uff0c\u200b\u53ef\u4ee5\u200b\u5ffd\u7565\u200b\u672c\u200b\u8bbe\u7f6e\u200b\uff0c\u200b\u6240\u6709\u200b\u7684\u200b\u5b57\u8282\u200b\u90fd\u200b\u662f\u200b\u6709\u6548\u200b\u7684\u200b\uff1b  \u200b\u5bf9\u4e8e\u200b16bpp\uff0cbit[1:0]\u3001bit[3:2]\u200b\u5206\u522b\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200b\u5b57\u8282\u200b\uff0c\u200b\u7ec4\u5408\u200b\u4e2d\u200b\u7684\u200b2\u200b\u4f4d\u200b\u90fd\u200b\u4e3a\u200b1\u200b\u65f6\u200b\uff0c\u200b\u5bf9\u5e94\u200b\u7684\u200b\u5b57\u8282\u200b\u624d\u200b\u6709\u6548\u200b\uff1b  \u200b\u5bf9\u4e8e\u200b24bpp\uff0c0x7\u200b\u8868\u793a\u200b32\u200b\u4f4d\u200b\u6570\u636e\u200b\u4e2d\u200b\u53ea\u7528\u200b\u5230\u200b3\u200b\u4e2a\u200b\u5b57\u8282\u200b\uff0c\u200b\u8fd9\u200b\u79f0\u4e3a\u200b\u201c24 bit unpacked format\u201d\uff0c\u200b\u5373\u200bARGB\uff0c\u200b\u5176\u4e2d\u200b\u7684\u200bA\u200b\u5b57\u8282\u200b\u88ab\u200b\u4e22\u5f03\u200b [0] RESET R/W \u200b\u7528\u6765\u200b\u590d\u4f4d\u200b\u4e86\u200b\u63a5\u200b\u7684\u200bLCD\uff0c  0\uff1aLCD_RESET\u200b\u5f15\u811a\u200b\u8f93\u51fa\u200b\u4f4e\u7535\u5e73\u200b\uff1b  1\uff1aLCD_RESET\u200b\u5f15\u811a\u200b\u8f93\u51fa\u200b\u9ad8\u7535\u5e73"},{"location":"03_LCD/09_1/#23-lcdif_transfer_count","title":"2.3 LCDIF_TRANSFER_COUNT\u200b\u5bc4\u5b58\u5668","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b [31:16] V_COUNT R/W \u200b\u4e00\u5e27\u200b\u4e2d\u200b\uff0c\u200b\u6709\u200b\u591a\u5c11\u200b\u884c\u200b\u6709\u6548\u200b\u6570\u636e\u200b [15:0] H_COUNT R/W \u200b\u4e00\u884c\u200b\u4e2d\u200b\uff0c\u200b\u6709\u200b\u591a\u5c11\u200b\u4e2a\u200b\u50cf\u7d20"},{"location":"03_LCD/09_1/#24-lcdif_vdctrl0","title":"2.4 LCDIF_VDCTRL0\u200b\u5bc4\u5b58\u5668","text":"<p>\u200b   \u200b\u672c\u200b\u5bc4\u5b58\u5668\u200b\u7528\u6765\u200b\u8bbe\u7f6e\u200bVsync\u200b\u4fe1\u53f7\u200b\u76f8\u5173\u200b\u7684\u200b\u65f6\u5e8f\u200b\uff0c\u200b\u53ca\u200b\u6781\u6027\u200b\u3002</p> \u200b\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b [29] VSYNC_OEB R/W \u200b\u7528\u6765\u200b\u63a7\u5236\u200bVSYNC\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u5bf9\u4e8e\u200bDOTCLK\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u8bbe\u200b\u4e3a\u200b0\uff0c  0\uff1aVSYNC\u200b\u662f\u200b\u8f93\u51fa\u200b\u5f15\u811a\u200b\uff0c\u200b\u7528\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u4ea7\u751f\u200b\uff1b  1\uff1aVSYNC\u200b\u662f\u200b\u8f93\u5165\u200b\u5f15\u811a\u200b [28] ENABLE_PRESENT R/W \u200b\u5728\u200bDOTCLK\u200b\u6a21\u5f0f\u200b\u4e0b\u200b\uff0c\u200b\u786c\u4ef6\u200b\u662f\u5426\u200b\u4f1a\u200b\u4ea7\u751f\u200b\u6570\u636e\u200b\u4f7f\u80fd\u200b\u4fe1\u53f7\u200bENALBE\uff1a  0\uff1a\u200b\u4e0d\u200b\u4ea7\u751f\u200b\uff1b  1\uff1a\u200b\u4ea7\u751f\u200b [27] VSYNC_POL R/W \u200b\u7528\u6765\u200b\u51b3\u5b9a\u200bVSYNC\u200b\u8109\u51b2\u200b\u7684\u200b\u6781\u6027\u200b\uff0c  0\uff1a\u200b\u4f4e\u200b\u8109\u51b2\u200b\uff1b  1\uff1a\u200b\u9ad8\u200b\u8109\u51b2\u200b [26] HSYNC_POL R/W \u200b\u7528\u6765\u200b\u51b3\u5b9a\u200bHSYNC\u200b\u8109\u51b2\u200b\u7684\u200b\u6781\u6027\u200b\uff0c  0\uff1a\u200b\u4f4e\u200b\u8109\u51b2\u200b\uff1b  1\uff1a\u200b\u9ad8\u200b\u8109\u51b2\u200b [25] DOTCLK_POL R/W \u200b\u7528\u6765\u200b\u51b3\u5b9a\u200bDOTCLK\u200b\u7684\u200b\u6781\u6027\u200b\uff0c  0\uff1aLCD\u200b\u63a7\u5236\u5668\u200b\u5728\u200bDOTCLK\u200b\u4e0b\u964d\u200b\u6cbf\u200b\u53d1\u9001\u6570\u636e\u200b\uff0cLCD\u200b\u5728\u200b\u4e0a\u5347\u200b\u6cbf\u200b\u6355\u83b7\u200b\u6570\u636e\u200b\uff1b  1\uff1a\u200b\u53cd\u8fc7\u6765\u200b [24] ENABLE_POL R/W \u200b\u7528\u6765\u200b\u51b3\u5b9a\u200bENABLE\u200b\u4fe1\u53f7\u200b\u7684\u200b\u6781\u6027\u200b\uff0c  0\uff1a\u200b\u6570\u636e\u200b\u6709\u6548\u200b\u671f\u95f4\u200b\uff0cENABLE\u200b\u4fe1\u53f7\u200b\u4e3a\u200b\u4f4e\u200b\uff1b  1\uff1a\u200b\u53cd\u8fc7\u6765\u200b [21] VSYNC_PERIOD_UNIT R/W \u200b\u7528\u6765\u200b\u51b3\u5b9a\u200bVSYNC_PERIOD\u200b\u7684\u200b\u5355\u4f4d\u200b\uff0c  0\uff1a\u200b\u5355\u4f4d\u200b\u662f\u200b\u50cf\u7d20\u200b\u65f6\u949f\u200b(pix_clk)\uff0c\u200b\u8fd9\u200b\u5728\u200bVSYNC\u200b\u6a21\u5f0f\u200b\u4e0b\u200b\u4f7f\u7528\u200b\uff1b  1\uff1a\u200b\u5355\u4f4d\u200b\u662f\u200b\u201c\u200b\u6574\u884c\u200b\u201d\uff0c\u200b\u8fd9\u200b\u5728\u200bDOTCLK\u200b\u6a21\u5f0f\u200b\u4e0b\u200b\u4f7f\u7528\u200b [20] VSYNC_PULSE_WIDTH_UNIT R/W \u200b\u7528\u6765\u200b\u51b3\u5b9a\u200bVSYNC_PULSE_WIDTH\u200b\u7684\u200b\u5355\u4f4d\u200b\uff0c  0\uff1a\u200b\u5355\u4f4d\u200b\u662f\u200b\u50cf\u7d20\u200b\u65f6\u949f\u200b(pix_clk)\uff1b  1\uff1a\u200b\u5355\u4f4d\u200b\u662f\u200b\u201c\u200b\u6574\u884c\u200b\u201d [19] HALF_LINE R/W VSYNC\u200b\u5468\u671f\u200b\u662f\u5426\u200b\u5468\u200b\u52a0\u4e0a\u200b\u534a\u884c\u200b\u7684\u200b\u65f6\u95f4\u200b\uff0c  0\uff1aVSYNC\u200b\u5468\u671f\u200b=VSYNC_PERIOD\uff1b  1\uff1aVSYNC\u200b\u5468\u671f\u200b=VSYNC_PERIOD+HORIZONTAL_PERIOD/2 [18] HALF_LINE_MODE R/W 0\uff1a\u200b\u7b2c\u200b1\u200b\u5e27\u200b\u5c06\u200b\u5728\u200b\u4e00\u884c\u200b\u7684\u200b\u4e2d\u95f4\u200b\u7ed3\u675f\u200b\uff0c\u200b\u7b2c\u200b2\u200b\u5e27\u200b\u5728\u200b\u4e00\u884c\u200b\u7684\u200b\u4e2d\u95f4\u200b\u5f00\u59cb\u200b\uff1b  1\uff1a\u200b\u6240\u6709\u200b\u5e27\u200b\u7ed3\u675f\u200b\u524d\u200b\u90fd\u200b\u52a0\u4e0a\u200b\u534a\u884c\u200b\u65f6\u95f4\u200b\uff0c\u200b\u8fd9\u6837\u200b\u6240\u6709\u200b\u5e27\u200b\u90fd\u200b\u4f1a\u200b\u8d77\u200b\u59cb\u4e8e\u200b\u201c\u200b\u884c\u200b\u7684\u200b\u5f00\u5934\u200b\u201d [17:0] VSYNC_PULSE_WIDTH R/W VSYNC\u200b\u8109\u51b2\u200b\u7684\u200b\u5bbd\u5ea6"},{"location":"03_LCD/09_1/#25-lcdif_vdctrl1","title":"2.5 LCDIF_VDCTRL1\u200b\u5bc4\u5b58\u5668","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b [29] VSYNC_PERIOD R/W \u200b\u4e24\u4e2a\u200b\u5782\u76f4\u200b\u540c\u6b65\u200b\u4fe1\u53f7\u200b\u4e4b\u95f4\u200b\u7684\u200b\u95f4\u9694\u200b\uff0c\u200b\u5373\u200b\u5782\u76f4\u200b\u65b9\u5411\u200b\u540c\u6b65\u200b\u4fe1\u53f7\u200b\u7684\u200b\u603b\u200b\u5468\u671f\u200b\uff1b  \u200b\u5355\u4f4d\u200b\u7531\u200bVSYNC_PERIOD_UNIT\u200b\u51b3\u5b9a"},{"location":"03_LCD/09_1/#26-lcdif_vdctrl2","title":"2.6 LCDIF_VDCTRL2\u200b\u5bc4\u5b58\u5668","text":"<p>\u200b   HSYNC_PULSE_WIDTH\uff1a\u200b\u6c34\u5e73\u200b\u540c\u6b65\u200b\u4fe1\u53f7\u200b\u8109\u51b2\u200b\u5bbd\u5ea6\u200b\uff1b</p> <p>\u200b   HSYNC_PERIOD\uff1a\u200b\u4e24\u4e2a\u200b\u6c34\u5e73\u200b\u540c\u6b65\u200b\u4fe1\u53f7\u200b\u4e4b\u95f4\u200b\u7684\u200b\u603b\u6570\u200b\uff0c\u200b\u5373\u200b\u6c34\u5e73\u200b\u65b9\u5411\u200b\u540c\u6b65\u200b\u4fe1\u53f7\u200b\u7684\u200b\u603b\u200b\u5468\u671f\u200b</p> \u200b\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b [31:18] HSYNC_PULSE_WIDTH R/W HSYNC\u200b\u8109\u51b2\u200b\u7684\u200b\u5bbd\u5ea6\u200b(\u200b\u5355\u4f4d\u200b\uff1apix_clk) [17:0] HSYNC_PERIOD R/W \u200b\u6574\u884c\u200b\u7684\u200b\u5bbd\u5ea6\u200b\uff0c\u200b\u5373\u200b\u4e24\u4e2a\u200bHYSNC\u200b\u4fe1\u53f7\u200b\u4e4b\u95f4\u200b\u7684\u200b\u5bbd\u5ea6\u200b(\u200b\u5355\u4f4d\u200b\uff1apix_clk)"},{"location":"03_LCD/09_1/#27-lcdif_vdctrl3","title":"2.7 LCDIF_VDCTRL3\u200b\u5bc4\u5b58\u5668","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b [29] MUX_SYNC_SIGNALS R/W \u200b\u7528\u4e0d\u7740\u200b [28] VSYNC_ONLY R/W 0\uff1aDOTCLK\u200b\u6a21\u5f0f\u200b\u65f6\u200b\u5fc5\u987b\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b0\uff1b  1\uff1aVSYNC\u200b\u6a21\u5f0f\u200b\u65f6\u200b\u5fc5\u987b\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b1 [27:16] HORIZONTAL_WAIT_CNT R/W \u200b\u6c34\u5e73\u200b\u65b9\u5411\u200b\u4e0a\u200b\u7684\u200b\u7b49\u5f85\u200b\u50cf\u7d20\u200b\u4e2a\u6570\u200b\uff0c\u200b\u7b49\u4e8e\u200bthp+thb [15:0] VERTICAL_WAIT_CNT R/W \u200b\u5782\u76f4\u200b\u65b9\u5411\u200b\u4e0a\u200b\u7684\u200b\u7b49\u5f85\u200b\u884c\u200b\u6570\u200b\uff0c\u200b\u7b49\u4e8e\u200btvp+tvb"},{"location":"03_LCD/09_1/#28-lcdif_vdctrl4","title":"2.8 LCDIF_VDCTRL4\u200b\u5bc4\u5b58\u5668","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b [31:29] DOTCLK_DLY_SEL R/W \u200b\u5728\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u5185\u90e8\u200b\u7684\u200bDOTCLK\u200b\u8f93\u51fa\u200b\u5230\u200bLCD_DOTCK\u200b\u5f15\u811a\u200b\u65f6\u200b\uff0c\u200b\u5ef6\u65f6\u200b\u591a\u4e45\u200b\uff1a  0\uff1a2ns\uff1b  1\uff1a4ns\uff1b  2\uff1a6ns\uff1b  3\uff1a8ns\uff1b  \u200b\u5176\u4ed6\u200b\u503c\u200b\u4fdd\u7559\u200b [18] SYNC_SIGNALS_ON R/W DOTCLK\u200b\u6a21\u5f0f\u200b\u4e0b\u200b\u5fc5\u987b\u200b\u8bbe\u200b\u4e3a\u200b1 [17:0] DOTCLK_H_VALID_DATA_CNT R/W \u200b\u6c34\u5e73\u200b\u65b9\u5411\u200b\u4e0a\u200b\u7684\u200b\u6709\u6548\u200b\u50cf\u7d20\u200b\u4e2a\u6570\u200b(pix_clk)\uff0c\u200b\u5373\u200b\u5206\u8fa8\u7387\u200b\u7684\u200by"},{"location":"03_LCD/09_1/#29-lcdif_cur_buf","title":"2.9 LCDIF_CUR_BUF\u200b\u5bc4\u5b58\u5668","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b [31:0] ADDR R/W LCD\u200b\u63a7\u5236\u5668\u200b\u6b63\u5728\u200b\u4f20\u8f93\u200b\u7684\u200b\u5f53\u524d\u200b\u5e27\u200b\u5728\u200b\u663e\u5b58\u200b\u4e2d\u200b\u7684\u200b\u5730\u5740"},{"location":"03_LCD/09_1/#210-lcdif_next_buf","title":"2.10 LCDIF_NEXT_BUF\u200b\u5bc4\u5b58\u5668","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b [31:0] ADDR R/W \u200b\u4e0b\u200b\u4e00\u5e27\u200b\u5728\u200b\u663e\u5b58\u200b\u4e2d\u200b\u7684\u200b\u5730\u5740\u200b <p>LCD\u200b\u63a7\u5236\u5668\u200b\u4f20\u8f93\u200b\u5b8c\u200b\u5f53\u524d\u200b\u5e27\u200b\u540e\u200b\uff0c\u200b\u4f1a\u200b\u628a\u200bLCDIF_NEXT_BUF\u200b\u5bc4\u5b58\u5668\u200b\u7684\u200b\u503c\u200b\u590d\u5236\u5230\u200bLCDIF_CUR_BUF\u200b\u5bc4\u5b58\u5668\u200b\u3002</p>"},{"location":"03_LCD/10_1/","title":"10_\u200b\u5206\u6790\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200bLCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":""},{"location":"03_LCD/10_1/#lcd_imx6ull","title":"\u5206\u6790\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200bLCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff0cGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff1a</p> <ul> <li><code>IMX6ULL\\\u200b\u5f00\u53d1\u677f\u200b\u914d\u5957\u200b\u8d44\u6599\u200b\\datasheet\\Core_board\\CPU\\IMX6ULLRM.pdf</code></li> <li> <p><code>\u300aChapter 34 Enhanced LCD Interface (eLCDIF)\u300b</code></p> </li> <li> <p>IMX6ULL\u200b\u7684\u200bLCD\u200b\u88f8\u673a\u200b\u7a0b\u5e8f\u200b</p> </li> <li> <p><code>IMX6ULL\\source\\03_LCD\\05_\u200b\u53c2\u8003\u200b\u7684\u200b\u88f8\u673a\u200b\u6e90\u7801\u200b\\03_font_test</code></p> </li> <li> <p>\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200bIMX6ULL LCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</p> </li> <li>\u200b\u9a71\u52a8\u200b\u6e90\u7801\u200b\uff1a<code>Linux-4.9.88\\drivers\\video\\fbdev\\mxsfb.c</code></li> <li>\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a<ul> <li><code>arch/arm/boot/dts/imx6ull.dtsi</code></li> <li><code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code></li> </ul> </li> </ul>"},{"location":"03_LCD/10_1/#1","title":"1. \u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":"<p>Linux\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b = \u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6\u200b + \u200b\u786c\u4ef6\u200b\u7f16\u7a0b\u200b\u3002 \u200b\u5728\u200b\u524d\u9762\u200b\u5df2\u7ecf\u200b\u57fa\u4e8e\u200bQEMU\u200b\u7f16\u5199\u200b\u4e86\u200bLCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u5bf9\u200bLCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u7684\u200b\u6846\u67b6\u200b\u5df2\u7ecf\u200b\u5206\u6790\u200b\u6e05\u695a\u200b\u3002 \u200b\u6838\u5fc3\u200b\u5c31\u662f\u200b\uff1a</p> <ul> <li>\u200b\u5206\u914d\u200bfb_info</li> <li>\u200b\u8bbe\u7f6e\u200bfb_info</li> <li>\u200b\u6ce8\u518c\u200bfb_info</li> <li>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u8bbe\u7f6e\u200b</li> </ul>"},{"location":"03_LCD/10_1/#11-platform_driver","title":"1.1 \u200b\u5165\u53e3\u200b\u51fd\u6570\u200b\u6ce8\u518c\u200bplatform_driver","text":""},{"location":"03_LCD/10_1/#12","title":"1.2 \u200b\u8bbe\u5907\u200b\u6811\u6709\u200b\u5bf9\u5e94\u200b\u8282\u70b9","text":""},{"location":"03_LCD/10_1/#13-probe","title":"1.3 probe\u200b\u51fd\u6570\u200b\u5206\u6790","text":""},{"location":"03_LCD/10_1/#2","title":"2. \u200b\u7f16\u5199\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u4ee3\u7801","text":"<p>\u200b\u6211\u4eec\u200b\u53ea\u200b\u9700\u8981\u200b\u9488\u5bf9\u200bIMX6ULL\u200b\u7684\u200b\u7f16\u5199\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u4ee3\u7801\u200b\uff0c\u200b\u6d89\u53ca\u200b3\u200b\u90e8\u5206\u200b\uff1a</p> <ul> <li>GPIO\u200b\u8bbe\u7f6e\u200b</li> <li>LCD\u200b\u5f15\u811a\u200b</li> <li>\u200b\u80cc\u5149\u200b\u5f15\u811a\u200b</li> <li>\u200b\u65f6\u949f\u200b\u8bbe\u7f6e\u200b</li> <li>\u200b\u786e\u5b9a\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u65f6\u949f\u200b</li> <li>\u200b\u6839\u636e\u200bLCD\u200b\u7684\u200bDCLK\u200b\u8ba1\u7b97\u200b\u76f8\u5173\u200b\u65f6\u949f\u200b</li> <li>LCD\u200b\u63a7\u5236\u5668\u200b\u672c\u8eab\u200b\u7684\u200b\u8bbe\u7f6e\u200b</li> <li>\u200b\u6bd4\u5982\u200b\u8bbe\u7f6e\u200bFramebuffer\u200b\u7684\u200b\u5730\u5740\u200b</li> <li>\u200b\u8bbe\u7f6e\u200bFramebuffer\u200b\u4e2d\u200b\u6570\u636e\u683c\u5f0f\u200b\u3001LCD\u200b\u6570\u636e\u683c\u5f0f\u200b</li> <li>\u200b\u8bbe\u7f6e\u200b\u65f6\u5e8f\u200b</li> </ul>"},{"location":"03_LCD/10_1/#21-gpio","title":"2.1 GPIO\u200b\u8bbe\u7f6e","text":"<p>\u200b\u6709\u200b\u4e24\u79cd\u200b\u65b9\u6cd5\u200b\uff1a</p> <ul> <li>\u200b\u76f4\u63a5\u200b\u8bfb\u5199\u200b\u76f8\u5173\u200b\u5bc4\u5b58\u5668\u200b</li> <li>\u200b\u4f7f\u7528\u200b\u8bbe\u5907\u200b\u6811\u200b\uff0c\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\u8bbe\u7f6e\u200bpinctrl</li> <li>\u200b\u672c\u200b\u8bfe\u7a0b\u200b\u4e13\u6ce8\u200b\u4e8e\u200bLCD\uff0c\u200b\u6240\u4ee5\u200b\u4f7f\u7528\u200bpinctrl\u200b\u7b80\u5316\u200b\u7a0b\u5e8f\u200b</li> </ul> <p>\u200b\u8bbe\u5907\u200b\u6811\u200b<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code>\u200b\u4e2d\u200b\uff1a </p>"},{"location":"03_LCD/10_1/#22","title":"2.2 \u200b\u65f6\u949f\u200b\u8bbe\u7f6e","text":"<p>IMX6ULL\u200b\u7684\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u6d89\u53ca\u200b2\u200b\u4e2a\u200b\u65f6\u949f\u200b\uff1a</p> <p></p> <p>\u200b\u4ee3\u7801\u200b\u91cc\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u65f6\u949f\u200b\u5b50\u7cfb\u7edf\u200b\u7684\u200b\u4ee3\u7801\u200b\u3002</p> <ul> <li> <p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u5b9a\u200b\u9891\u7387\u200b\uff1a</p> </li> <li> <p>\u200b\u6587\u4ef6\u200b\uff1aarch/arm/boot/dts/100ask_imx6ull-14x14.dts</p> </li> <li> <p>\u200b\u4ee3\u7801\u200b\uff1aclock-frequency</p> <pre><code>       display-timings {\n            native-mode = &lt;&amp;timing0&gt;;\n\n             timing0: timing0_1024x768 {\n             clock-frequency = &lt;50000000&gt;;\n</code></pre> </li> <li> <p>\u200b\u4ece\u200b\u8bbe\u5907\u200b\u6811\u200b\u83b7\u5f97\u200bdot clock\uff0c\u200b\u5b58\u5165\u200bdisplay_timing</p> </li> <li> <p>\u200b\u6587\u4ef6\u200b\uff1adrivers\\video\\of_display_timing.c</p> </li> <li> <p>\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>ret |= parse_timing_property(np, \"clock-frequency\", &amp;dt-&gt;pixelclock);\n</code></pre> </li> <li> <p>\u200b\u4f7f\u7528\u200bdisplay_timing\u200b\u6765\u200b\u8bbe\u7f6e\u200bvideomode</p> </li> <li> <p>\u200b\u6587\u4ef6\u200b\uff1adrivers\\video\\videomode.c</p> </li> <li> <p>\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>void videomode_from_timing(const struct display_timing *dt,\n              struct videomode *vm)\n{\n    vm-&gt;pixelclock = dt-&gt;pixelclock.typ;\n    vm-&gt;hactive = dt-&gt;hactive.typ;\n    vm-&gt;hfront_porch = dt-&gt;hfront_porch.typ;\n    vm-&gt;hback_porch = dt-&gt;hback_porch.typ;\n    vm-&gt;hsync_len = dt-&gt;hsync_len.typ;\n\n    vm-&gt;vactive = dt-&gt;vactive.typ;\n    vm-&gt;vfront_porch = dt-&gt;vfront_porch.typ;\n    vm-&gt;vback_porch = dt-&gt;vback_porch.typ;\n    vm-&gt;vsync_len = dt-&gt;vsync_len.typ;\n\n    vm-&gt;flags = dt-&gt;flags;\n}\n</code></pre> </li> <li> <p>\u200b\u6839\u636e\u200bvideomode\u200b\u7684\u200b\u503c\u200b\uff0c\u200b\u4f7f\u7528\u200b\u65f6\u949f\u200b\u5b50\u7cfb\u7edf\u200b\u7684\u200b\u51fd\u6570\u200b\u8bbe\u7f6e\u200b\u65f6\u949f\u200b\uff1a</p> </li> <li> <p>\u200b\u6587\u4ef6\u200b\uff1adrivers\\video\\fbdev\\mxc\\ldb.c</p> </li> <li>\u200b\u4ee3\u7801\u200b\uff1a     </li> </ul>"},{"location":"03_LCD/10_1/#23-lcd","title":"2.3 LCD\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u914d\u7f6e","text":"<p>\u200b\u4ee5\u200b\u8bbe\u7f6e\u200b\u5206\u8fa8\u7387\u200b\u4e3a\u4f8b\u200b\u3002 * \u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u5b9a\u200b\u9891\u7387\u200b\uff1a</p> <ul> <li> <p>\u200b\u6587\u4ef6\u200b\uff1aarch/arm/boot/dts/100ask_imx6ull-14x14.dts</p> </li> <li> <p>\u200b\u4ee3\u7801\u200b\uff1aclock-frequency</p> <p><pre><code>       display-timings {\n            native-mode = &lt;&amp;timing0&gt;;\n\n             timing0: timing0_1024x768 {\n                hactive = &lt;1024&gt;;\n                vactive = &lt;600&gt;;\n</code></pre> * \u200b\u4ece\u200b\u8bbe\u5907\u200b\u6811\u200b\u83b7\u5f97\u200b\u5206\u8fa8\u7387\u200b\uff0c\u200b\u5b58\u5165\u200bdisplay_timing</p> </li> <li> <p>\u200b\u6587\u4ef6\u200b\uff1adrivers\\video\\of_display_timing.c</p> </li> <li> <p>\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>    ret |= parse_timing_property(np, \"hactive\", &amp;dt-&gt;hactive);\n    ret |= parse_timing_property(np, \"vactive\", &amp;dt-&gt;vactive);\n</code></pre> </li> <li> <p>\u200b\u4f7f\u7528\u200bdisplay_timing\u200b\u6765\u200b\u8bbe\u7f6e\u200bvideomode</p> </li> <li> <p>\u200b\u6587\u4ef6\u200b\uff1adrivers\\video\\videomode.c</p> </li> <li> <p>\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>void videomode_from_timing(const struct display_timing *dt,\n              struct videomode *vm)\n{\n    vm-&gt;hactive = dt-&gt;hactive.typ;\n\n    vm-&gt;vactive = dt-&gt;vactive.typ;\n</code></pre> </li> <li> <p>\u200b\u6839\u636e\u200bvideomode\u200b\u7684\u200b\u503c\u200b\uff0c\u200b\u8bbe\u7f6e\u200bfb_videomode</p> </li> <li> <p>\u200b\u6587\u4ef6\u200b\uff1adrivers\\video\\fbdev\\core\\fbmon.c</p> </li> <li> <p>\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>int fb_videomode_from_videomode(const struct videomode *vm,\n                struct fb_videomode *fbmode)\n{\n    unsigned int htotal, vtotal;\n\n    fbmode-&gt;xres = vm-&gt;hactive;\n\n    fbmode-&gt;yres = vm-&gt;vactive;\n</code></pre> </li> <li> <p>\u200b\u6839\u636e\u200bfb_videomode\u200b\u7684\u200b\u503c\u200b\uff0c\u200b\u8bbe\u7f6e\u200bfb_info\u200b\u4e2d\u200b\u7684\u200bvar\uff1a</p> </li> <li> <p>\u200b\u6587\u4ef6\u200b\uff1adrivers\\video\\fbdev\\core\\modedb.c</p> </li> <li> <p>\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>void fb_videomode_to_var(struct fb_var_screeninfo *var,\n             const struct fb_videomode *mode)\n{\n    var-&gt;xres = mode-&gt;xres;\n    var-&gt;yres = mode-&gt;yres;\n</code></pre> </li> <li> <p>\u200b\u6839\u636e\u200bvar\u200b\u7684\u200b\u5206\u8fa8\u7387\u200b\uff0c\u200b\u8bbe\u7f6e\u200b\u5bc4\u5b58\u5668\u200b</p> </li> <li> <p>\u200b\u6587\u4ef6\u200b\uff1adrivers\\video\\fbdev\\mxsfb.c</p> </li> <li> <p>\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>    writel(TRANSFER_COUNT_SET_VCOUNT(fb_info-&gt;var.yres) |\n            TRANSFER_COUNT_SET_HCOUNT(fb_info-&gt;var.xres),\n            host-&gt;base + host-&gt;devdata-&gt;transfer_count);\n</code></pre> </li> </ul>"},{"location":"03_LCD/11_1/","title":"11_\u200b\u7f16\u7a0b\u200b_LCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6\u200b_\u200b\u4f7f\u7528\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"03_LCD/11_1/#_lcd_","title":"\u7f16\u7a0b\u200b_LCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6\u200b_\u200b\u4f7f\u7528\u200b\u8bbe\u5907\u200b\u6811","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff0cGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff1a</p> <ul> <li>\u200b\u57fa\u4e8e\u200b\u8fd9\u4e2a\u200b\u7a0b\u5e8f\u4fee\u6539\u200b\uff1a</li> <li><code>IMX6ULL\\source\\03_LCD\\03_lcd_drv_qemu_ok</code></li> <li> <p><code>STM32MP157\\source\\A7\\03_LCD\\03_lcd_drv_qemu_ok</code></p> </li> <li> <p>\u200b\u53c2\u8003\u200b\uff1a\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200b\u793a\u4f8b\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</p> </li> <li> <p>Linux\u200b\u9a71\u52a8\u200b\u6e90\u7801\u200b\uff1a<code>drivers/video/fbdev/simplefb.c</code></p> </li> <li> <p>\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a</p> <ul> <li><code>arch/arm/boot/dts/sun4i-a10.dtsi</code></li> </ul> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u7f16\u5199\u200b\u597d\u200b\u7684\u200b\u4ee3\u7801\u200b</p> </li> <li><code>IMX6ULL\\source\\03_LCD\\06_lcd_drv_framework_use_devicetree</code></li> <li><code>STM32MP157\\source\\A7\\03_LCD\\06_lcd_drv_framework_use_devicetree</code></li> </ul>"},{"location":"03_LCD/11_1/#1","title":"1. \u200b\u8bf4\u660e","text":"<p>Linux\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b = \u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6\u200b + \u200b\u786c\u4ef6\u200b\u7f16\u7a0b\u200b\u3002 \u200b\u5728\u200b\u524d\u9762\u200b\u5df2\u7ecf\u200b\u57fa\u4e8e\u200bQEMU\u200b\u7f16\u5199\u200b\u4e86\u200bLCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u5bf9\u200bLCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u7684\u200b\u6846\u67b6\u200b\u5df2\u7ecf\u200b\u5206\u6790\u200b\u6e05\u695a\u200b\u3002 \u200b\u6838\u5fc3\u200b\u5c31\u662f\u200b\uff1a</p> <ul> <li>\u200b\u5206\u914d\u200bfb_info</li> <li>\u200b\u8bbe\u7f6e\u200bfb_info</li> <li>\u200b\u6ce8\u518c\u200bfb_info</li> <li>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u8bbe\u7f6e\u200b</li> </ul> <p>\u200b\u672c\u200b\u8282\u200b\u8bfe\u7a0b\u200b\u6211\u4eec\u200b\u57fa\u4e8e\u200b\u8bbe\u5907\u200b\u6811\u6765\u200b\u7f16\u5199\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u3002</p>"},{"location":"03_LCD/11_1/#2-platform_driver","title":"2. \u200b\u5165\u53e3\u200b\u51fd\u6570\u200b\u6ce8\u518c\u200bplatform_driver","text":""},{"location":"03_LCD/11_1/#3","title":"3. \u200b\u8bbe\u5907\u200b\u6811\u6709\u200b\u5bf9\u5e94\u200b\u8282\u70b9","text":"<pre><code>                framebuffer-mylcd {\n                        compatible = \"100ask,lcd_drv\";\n                };\n</code></pre>"},{"location":"03_LCD/11_1/#4-probe","title":"4. \u200b\u7f16\u5199\u200bprobe\u200b\u51fd\u6570","text":"<ul> <li>\u200b\u5206\u914d\u200bfb_info</li> <li>\u200b\u8bbe\u7f6e\u200bfb_info</li> <li>\u200b\u6ce8\u518c\u200bfb_info</li> <li>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u8bbe\u7f6e\u200b</li> <li>\u200b\u5f15\u811a\u200b\u8bbe\u7f6e\u200b</li> <li>\u200b\u65f6\u949f\u200b\u8bbe\u7f6e\u200b</li> <li>LCD\u200b\u63a7\u5236\u5668\u200b\u8bbe\u7f6e\u200b</li> </ul>"},{"location":"03_LCD/12_1/","title":"12_\u200b\u7f16\u7a0b\u200b_\u200b\u914d\u7f6e\u200b\u5f15\u811a\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":""},{"location":"03_LCD/12_1/#__imx6ull","title":"\u7f16\u7a0b\u200b_\u200b\u914d\u7f6e\u200b\u5f15\u811a\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff0cGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff1a</p> <ul> <li> <p>\u200b\u82af\u7247\u200b\u8d44\u6599\u200b</p> </li> <li> <p><code>IMX6ULL\\\u200b\u5f00\u53d1\u677f\u200b\u914d\u5957\u200b\u8d44\u6599\u200b\\datasheet\\Core_board\\CPU\\IMX6ULLRM.pdf</code></p> <ul> <li><code>\u300aChapter 34 Enhanced LCD Interface (eLCDIF)\u300b</code></li> </ul> </li> <li> <p>IMX6ULL\u200b\u7684\u200bLCD\u200b\u88f8\u673a\u200b\u7a0b\u5e8f\u200b</p> </li> <li> <p><code>IMX6ULL\\source\\03_LCD\\05_\u200b\u53c2\u8003\u200b\u7684\u200b\u88f8\u673a\u200b\u6e90\u7801\u200b\\03_font_test</code></p> </li> <li> <p>\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200bIMX6ULL LCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</p> </li> <li>\u200b\u9a71\u52a8\u200b\u6e90\u7801\u200b\uff1a<code>Linux-4.9.88\\drivers\\video\\fbdev\\mxsfb.c</code></li> <li>\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a<ul> <li><code>arch/arm/boot/dts/imx6ull.dtsi</code></li> <li><code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code></li> </ul> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u7f16\u5199\u200b\u597d\u200b\u7684\u200b\u4ee3\u7801\u200b</p> </li> <li> <p><code>IMX6ULL\\source\\03_LCD\\07_lcd_drv_pin_config_use_devicetree</code></p> </li> <li> <p>\u200b\u5f15\u811a\u200b\u914d\u7f6e\u200b\u5de5\u5177\u200b/\u200b\u8bbe\u5907\u200b\u6811\u200b\u751f\u6210\u200b\u5de5\u5177\u200b</p> </li> <li> <p>\u200b\u6253\u5f00\u200b\uff1ahttp://download.100ask.net/</p> </li> <li>\u200b\u627e\u5230\u200b\u5f00\u53d1\u677f\u200b\uff1a\"100ASK_IMX6ULL_PRO\u200b\u5f00\u53d1\u677f\u200b\"</li> <li>\u200b\u4e0b\u8f7d\u200b\u5f00\u53d1\u677f\u200b\u914d\u5957\u200b\u8d44\u6599\u200b</li> <li>\u200b\u4e0b\u8f7d\u200b\u5b8c\u540e\u200b\uff0c\u200b\u5de5\u5177\u200b\u5728\u200b\u5982\u4e0b\u200b\u76ee\u5f55\u200b\u91cc\u200b\uff1a</li> </ul> <p></p>"},{"location":"03_LCD/12_1/#1","title":"1. \u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u64cd\u4f5c","text":"<p>LCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u7684\u200b\u6838\u5fc3\u200b\u5c31\u662f\u200b\uff1a</p> <ul> <li>\u200b\u5206\u914d\u200bfb_info</li> <li>\u200b\u8bbe\u7f6e\u200bfb_info</li> <li>\u200b\u6ce8\u518c\u200bfb_info</li> <li>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u8bbe\u7f6e\u200b</li> </ul> <p>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u8bbe\u7f6e\u200b\u53c8\u200b\u53ef\u4ee5\u200b\u5206\u4e3a\u200b3\u200b\u90e8\u5206\u200b\uff1a   * \u200b\u5f15\u811a\u200b\u8bbe\u7f6e\u200b   * \u200b\u65f6\u949f\u200b\u8bbe\u7f6e\u200b   * LCD\u200b\u63a7\u5236\u5668\u200b\u8bbe\u7f6e\u200b</p>"},{"location":"03_LCD/12_1/#2","title":"2. \u200b\u5f15\u811a\u200b\u914d\u7f6e","text":"<p>\u200b\u4e3b\u8981\u200b\u4f7f\u7528\u200bpinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u628a\u200b\u5f15\u811a\u200b\u914d\u7f6e\u200b\u4e3a\u200bLCD\u200b\u529f\u80fd\u200b\uff0c\u200b\u5bf9\u4e8e\u200b\u80cc\u5149\u200b\u5f15\u811a\u200b\u7b49\u200b\u4f7f\u7528\u200bGPIO\u200b\u5b50\u7cfb\u7edf\u200b\u7684\u200b\u51fd\u6570\u200b\u63a7\u5236\u200b\u5b83\u200b\u7684\u200b\u8f93\u51fa\u200b\u7535\u5e73\u200b\u3002</p>"},{"location":"03_LCD/12_1/#21-pinctrllcd","title":"2.1 \u200b\u4f7f\u7528\u200bpinctrl\u200b\u914d\u7f6e\u200bLCD\u200b\u5f15\u811a","text":""},{"location":"03_LCD/12_1/#22-gpio","title":"2.2 \u200b\u4f7f\u7528\u200bGPIO\u200b\u5b50\u7cfb\u7edf\u200b\u63a7\u5236\u200b\u80cc\u5149","text":""},{"location":"03_LCD/13_1/","title":"13_\u200b\u7f16\u7a0b\u200b_\u200b\u914d\u7f6e\u200b\u65f6\u949f\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":""},{"location":"03_LCD/13_1/#__imx6ull","title":"\u7f16\u7a0b\u200b_\u200b\u914d\u7f6e\u200b\u65f6\u949f\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff0cGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff1a</p> <ul> <li> <p>\u200b\u82af\u7247\u200b\u8d44\u6599\u200b</p> </li> <li> <p><code>IMX6ULL\\\u200b\u5f00\u53d1\u677f\u200b\u914d\u5957\u200b\u8d44\u6599\u200b\\datasheet\\Core_board\\CPU\\IMX6ULLRM.pdf</code></p> <ul> <li><code>\u300aChapter 34 Enhanced LCD Interface (eLCDIF)\u300b</code></li> </ul> </li> <li> <p>IMX6ULL\u200b\u7684\u200bLCD\u200b\u88f8\u673a\u200b\u7a0b\u5e8f\u200b</p> </li> <li> <p><code>IMX6ULL\\source\\03_LCD\\05_\u200b\u53c2\u8003\u200b\u7684\u200b\u88f8\u673a\u200b\u6e90\u7801\u200b\\03_font_test</code></p> </li> <li> <p>\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200bIMX6ULL LCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</p> </li> <li>\u200b\u9a71\u52a8\u200b\u6e90\u7801\u200b\uff1a<code>Linux-4.9.88\\drivers\\video\\fbdev\\mxsfb.c</code></li> <li>\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a<ul> <li><code>arch/arm/boot/dts/imx6ull.dtsi</code></li> <li><code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code></li> </ul> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u7f16\u5199\u200b\u597d\u200b\u7684\u200b\u4ee3\u7801\u200b</p> </li> <li> <p><code>IMX6ULL\\source\\03_LCD\\08_lcd_drv_clk_config_use_devicetree</code></p> </li> <li> <p>\u200b\u5f15\u811a\u200b\u914d\u7f6e\u200b\u5de5\u5177\u200b/\u200b\u8bbe\u5907\u200b\u6811\u200b\u751f\u6210\u200b\u5de5\u5177\u200b</p> </li> <li> <p>\u200b\u6253\u5f00\u200b\uff1ahttp://download.100ask.net/</p> </li> <li>\u200b\u627e\u5230\u200b\u5f00\u53d1\u677f\u200b\uff1a\"100ASK_IMX6ULL_PRO\u200b\u5f00\u53d1\u677f\u200b\"</li> <li>\u200b\u4e0b\u8f7d\u200b\u5f00\u53d1\u677f\u200b\u914d\u5957\u200b\u8d44\u6599\u200b</li> <li>\u200b\u4e0b\u8f7d\u200b\u5b8c\u540e\u200b\uff0c\u200b\u5de5\u5177\u200b\u5728\u200b\u5982\u4e0b\u200b\u76ee\u5f55\u200b\u91cc\u200b\uff1a</li> </ul> <p></p>"},{"location":"03_LCD/13_1/#1","title":"1. \u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u64cd\u4f5c","text":"<p>LCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u7684\u200b\u6838\u5fc3\u200b\u5c31\u662f\u200b\uff1a</p> <ul> <li>\u200b\u5206\u914d\u200bfb_info</li> <li>\u200b\u8bbe\u7f6e\u200bfb_info</li> <li>\u200b\u6ce8\u518c\u200bfb_info</li> <li>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u8bbe\u7f6e\u200b</li> </ul> <p>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u8bbe\u7f6e\u200b\u53c8\u200b\u53ef\u4ee5\u200b\u5206\u4e3a\u200b3\u200b\u90e8\u5206\u200b\uff1a   * \u200b\u5f15\u811a\u200b\u8bbe\u7f6e\u200b   * \u200b\u65f6\u949f\u200b\u8bbe\u7f6e\u200b   * LCD\u200b\u63a7\u5236\u5668\u200b\u8bbe\u7f6e\u200b</p>"},{"location":"03_LCD/13_1/#2","title":"2. \u200b\u5206\u6790\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f","text":""},{"location":"03_LCD/13_1/#21","title":"2.1 \u200b\u82af\u7247\u200b\u624b\u518c","text":""},{"location":"03_LCD/13_1/#22","title":"2.2 \u200b\u8bbe\u5907\u200b\u6811","text":"<p>\u200b\u53c2\u8003\u200b\uff1a<code>arch/arm/boot/dts/imx6ull.dtsi</code></p> <pre><code>                       lcdif: lcdif@021c8000 {\n                                compatible = \"fsl,imx6ul-lcdif\", \"fsl,imx28-lcdif\";\n                                reg = &lt;0x021c8000 0x4000&gt;;\n                                interrupts = &lt;GIC_SPI 5 IRQ_TYPE_LEVEL_HIGH&gt;;\n                                clocks = &lt;&amp;clks IMX6UL_CLK_LCDIF_PIX&gt;,\n                                         &lt;&amp;clks IMX6UL_CLK_LCDIF_APB&gt;,\n                                         &lt;&amp;clks IMX6UL_CLK_DUMMY&gt;;\n                                clock-names = \"pix\", \"axi\", \"disp_axi\";\n                                status = \"disabled\";\n                        };\n</code></pre> <p>\u200b\u5b9a\u4e49\u200b\u4e86\u200b3\u200b\u4e2a\u200b\u65f6\u949f\u200b\uff1a</p> <ul> <li>pix\uff1aPixel clock\uff0c\u200b\u7528\u4e8e\u200bLCD\u200b\u63a5\u53e3\u200b\uff0c\u200b\u8bbe\u7f6e\u200b\u4e3a\u200bLCD\u200b\u624b\u518c\u200b\u4e0a\u200b\u7684\u200b\u53c2\u6570\u200b</li> <li>axi\uff1aAXI clock\uff0c\u200b\u7528\u4e8e\u200b\u4f20\u8f93\u6570\u636e\u200b\u3001\u200b\u8bfb\u5199\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u4f7f\u80fd\u200b\u5373\u53ef\u200b</li> <li>disp_axi\uff1a\u200b\u4e00\u4e2a\u200b\u865a\u62df\u200b\u7684\u200b\u65f6\u949f\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u4e0d\u7528\u200b\u8bbe\u7f6e\u200b</li> </ul>"},{"location":"03_LCD/13_1/#23","title":"2.3 \u200b\u4ee3\u7801","text":"<ul> <li>\u200b\u83b7\u5f97\u200b\u65f6\u949f\u200b</li> </ul> <pre><code>  host-&gt;clk_pix = devm_clk_get(&amp;host-&gt;pdev-&gt;dev, \"pix\");\n  if (IS_ERR(host-&gt;clk_pix)) {\n      host-&gt;clk_pix = NULL;\n      ret = PTR_ERR(host-&gt;clk_pix);\n      goto fb_release;\n  }\n\n  host-&gt;clk_axi = devm_clk_get(&amp;host-&gt;pdev-&gt;dev, \"axi\");\n  if (IS_ERR(host-&gt;clk_axi)) {\n      host-&gt;clk_axi = NULL;\n      ret = PTR_ERR(host-&gt;clk_axi);\n      dev_err(&amp;pdev-&gt;dev, \"Failed to get axi clock: %d\\n\", ret);\n      goto fb_release;\n  }\n\n  host-&gt;clk_disp_axi = devm_clk_get(&amp;host-&gt;pdev-&gt;dev, \"disp_axi\");\n  if (IS_ERR(host-&gt;clk_disp_axi)) {\n      host-&gt;clk_disp_axi = NULL;\n      ret = PTR_ERR(host-&gt;clk_disp_axi);\n      dev_err(&amp;pdev-&gt;dev, \"Failed to get disp_axi clock: %d\\n\", ret);\n      goto fb_release;\n  }\n</code></pre> <ul> <li>\u200b\u8bbe\u7f6e\u200b\u9891\u7387\u200b\uff1a\u200b\u53ea\u200b\u9700\u8981\u200b\u8bbe\u7f6e\u200bpixel clock\u200b\u7684\u200b\u9891\u7387\u200b</li> </ul> <pre><code>      ret = clk_set_rate(host-&gt;clk_pix,\n              PICOS2KHZ(fb_info-&gt;var.pixclock) * 1000U);\n</code></pre> <ul> <li>\u200b\u4f7f\u80fd\u200b\u65f6\u949f\u200b</li> </ul> <pre><code>      clk_enable_pix(host);\n          clk_prepare_enable(host-&gt;clk_pix);\n      clk_enable_axi(host);\n          clk_prepare_enable(host-&gt;clk_axi);\n      clk_enable_disp_axi(host);\n          clk_prepare_enable(host-&gt;clk_disp_axi);\n</code></pre>"},{"location":"03_LCD/13_1/#3","title":"3. \u200b\u81ea\u5df1\u200b\u5199\u200b\u4ee3\u7801","text":""},{"location":"03_LCD/14_1/","title":"14_\u200b\u7f16\u7a0b\u200b_\u200b\u914d\u7f6e\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u4e4b\u200b\u83b7\u5f97\u200bLCD\u200b\u53c2\u6570\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":""},{"location":"03_LCD/14_1/#_lcd_imx6ull","title":"\u7f16\u7a0b\u200b_\u200b\u914d\u7f6e\u200bLCD\u200b\u63a7\u5236\u5668\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff0cGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff1a</p> <ul> <li> <p>\u200b\u82af\u7247\u200b\u8d44\u6599\u200b</p> </li> <li> <p><code>IMX6ULL\\\u200b\u5f00\u53d1\u677f\u200b\u914d\u5957\u200b\u8d44\u6599\u200b\\datasheet\\Core_board\\CPU\\IMX6ULLRM.pdf</code></p> <ul> <li><code>\u300aChapter 34 Enhanced LCD Interface (eLCDIF)\u300b</code></li> </ul> </li> <li> <p>IMX6ULL\u200b\u7684\u200bLCD\u200b\u88f8\u673a\u200b\u7a0b\u5e8f\u200b</p> </li> <li> <p><code>IMX6ULL\\source\\03_LCD\\05_\u200b\u53c2\u8003\u200b\u7684\u200b\u88f8\u673a\u200b\u6e90\u7801\u200b\\03_font_test</code></p> </li> <li> <p>\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200bIMX6ULL LCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</p> </li> <li>\u200b\u9a71\u52a8\u200b\u6e90\u7801\u200b\uff1a<code>Linux-4.9.88\\drivers\\video\\fbdev\\mxsfb.c</code></li> <li>\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a<ul> <li><code>arch/arm/boot/dts/imx6ull.dtsi</code></li> <li><code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code></li> </ul> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u7f16\u5199\u200b\u597d\u200b\u7684\u200b\u4ee3\u7801\u200b</p> </li> <li> <p><code>IMX6ULL\\source\\03_LCD\\09_lcd_drv_lcdcontroller_config_use_devicetree</code></p> </li> <li> <p>\u200b\u5f15\u811a\u200b\u914d\u7f6e\u200b\u5de5\u5177\u200b/\u200b\u8bbe\u5907\u200b\u6811\u200b\u751f\u6210\u200b\u5de5\u5177\u200b</p> </li> <li> <p>\u200b\u6253\u5f00\u200b\uff1ahttp://download.100ask.net/</p> </li> <li>\u200b\u627e\u5230\u200b\u5f00\u53d1\u677f\u200b\uff1a\"100ASK_IMX6ULL_PRO\u200b\u5f00\u53d1\u677f\u200b\"</li> <li>\u200b\u4e0b\u8f7d\u200b\u5f00\u53d1\u677f\u200b\u914d\u5957\u200b\u8d44\u6599\u200b</li> <li>\u200b\u4e0b\u8f7d\u200b\u5b8c\u540e\u200b\uff0c\u200b\u5de5\u5177\u200b\u5728\u200b\u5982\u4e0b\u200b\u76ee\u5f55\u200b\u91cc\u200b\uff1a</li> </ul> <p></p>"},{"location":"03_LCD/14_1/#1","title":"1. \u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u64cd\u4f5c","text":"<p>LCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u7684\u200b\u6838\u5fc3\u200b\u5c31\u662f\u200b\uff1a</p> <ul> <li>\u200b\u5206\u914d\u200bfb_info</li> <li>\u200b\u8bbe\u7f6e\u200bfb_info</li> <li>\u200b\u6ce8\u518c\u200bfb_info</li> <li>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u8bbe\u7f6e\u200b</li> </ul> <p>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u8bbe\u7f6e\u200b\u53c8\u200b\u53ef\u4ee5\u200b\u5206\u4e3a\u200b3\u200b\u90e8\u5206\u200b\uff1a   * \u200b\u5f15\u811a\u200b\u8bbe\u7f6e\u200b   * \u200b\u65f6\u949f\u200b\u8bbe\u7f6e\u200b   * LCD\u200b\u63a7\u5236\u5668\u200b\u8bbe\u7f6e\u200b</p>"},{"location":"03_LCD/14_1/#2-lcd","title":"2. \u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u5b9a\u200bLCD\u200b\u53c2\u6570","text":"<pre><code>    framebuffer-mylcd {\n            compatible = \"100ask,lcd_drv\";\n            pinctrl-names = \"default\";\n            pinctrl-0 = &lt;&amp;mylcd_pinctrl&gt;;\n            backlight-gpios = &lt;&amp;gpio1 8 GPIO_ACTIVE_HIGH&gt;;\n\n            clocks = &lt;&amp;clks IMX6UL_CLK_LCDIF_PIX&gt;,\n                     &lt;&amp;clks IMX6UL_CLK_LCDIF_APB&gt;;\n            clock-names = \"pix\", \"axi\";\n\n            display = &lt;&amp;display0&gt;;\n\n            display0: display {\n                bits-per-pixel = &lt;24&gt;;\n                bus-width = &lt;24&gt;;\n\n                display-timings {\n                    native-mode = &lt;&amp;timing0&gt;;\n\n                     timing0: timing0_1024x768 {\n                     clock-frequency = &lt;50000000&gt;;\n                     hactive = &lt;1024&gt;;\n                     vactive = &lt;600&gt;;\n                     hfront-porch = &lt;160&gt;;\n                     hback-porch = &lt;140&gt;;\n                     hsync-len = &lt;20&gt;;\n                     vback-porch = &lt;20&gt;;\n                     vfront-porch = &lt;12&gt;;\n                     vsync-len = &lt;3&gt;;\n\n                     hsync-active = &lt;0&gt;;\n                     vsync-active = &lt;0&gt;;\n                     de-active = &lt;1&gt;;\n                     pixelclk-active = &lt;0&gt;;\n                     };\n\n                };\n            };            \n    };\n</code></pre>"},{"location":"03_LCD/14_1/#3","title":"3. \u200b\u7f16\u7a0b","text":""},{"location":"03_LCD/14_1/#31","title":"3.1 \u200b\u4ece\u200b\u8bbe\u5907\u200b\u6811\u200b\u83b7\u5f97\u200b\u53c2\u6570","text":"<p>\u200b\u65f6\u5e8f\u200b\u53c2\u6570\u200b\u3001\u200b\u5f15\u811a\u200b\u6781\u6027\u200b\u7b49\u200b\u4fe1\u606f\u200b\uff0c\u200b\u90fd\u200b\u88ab\u200b\u4fdd\u5b58\u200b\u5728\u200b\u4e00\u4e2a\u200bdisplay_timing\u200b\u7ed3\u6784\u200b\u4f53\u91cc\u200b\uff1a</p> <p></p> <p>\u200b\u53c2\u8003\u200b\u5185\u6838\u200b\u6587\u4ef6\u200b\uff1a</p> <ul> <li> <p><code>drivers\\video\\of_display_timing.c</code></p> </li> <li> <p><code>drivers\\video\\fbdev\\mxsfb.c</code></p> </li> </ul>"},{"location":"03_LCD/14_1/#32-lcd","title":"3.2 \u200b\u4f7f\u7528\u200b\u53c2\u6570\u200b\u914d\u7f6e\u200bLCD\u200b\u63a7\u5236\u5668","text":""},{"location":"03_LCD/15_1/","title":"15_\u200b\u7f16\u7a0b\u200b_\u200b\u914d\u7f6e\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u4e4b\u200b\u5bc4\u5b58\u5668\u200b\u64cd\u4f5c\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":""},{"location":"03_LCD/15_1/#_lcd_imx6ull","title":"\u7f16\u7a0b\u200b_\u200b\u914d\u7f6e\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u4e4b\u200b\u5bc4\u5b58\u5668\u200b\u64cd\u4f5c\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff0cGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff1a</p> <ul> <li> <p>\u200b\u82af\u7247\u200b\u8d44\u6599\u200b</p> </li> <li> <p><code>IMX6ULL\\\u200b\u5f00\u53d1\u677f\u200b\u914d\u5957\u200b\u8d44\u6599\u200b\\datasheet\\Core_board\\CPU\\IMX6ULLRM.pdf</code></p> <ul> <li><code>\u300aChapter 34 Enhanced LCD Interface (eLCDIF)\u300b</code></li> </ul> </li> <li> <p>IMX6ULL\u200b\u7684\u200bLCD\u200b\u88f8\u673a\u200b\u7a0b\u5e8f\u200b</p> </li> <li> <p><code>IMX6ULL\\source\\03_LCD\\05_\u200b\u53c2\u8003\u200b\u7684\u200b\u88f8\u673a\u200b\u6e90\u7801\u200b\\03_font_test</code></p> </li> <li> <p>\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200bIMX6ULL LCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</p> </li> <li>\u200b\u9a71\u52a8\u200b\u6e90\u7801\u200b\uff1a<code>Linux-4.9.88\\drivers\\video\\fbdev\\mxsfb.c</code></li> <li>\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a<ul> <li><code>arch/arm/boot/dts/imx6ull.dtsi</code></li> <li><code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code></li> </ul> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u7f16\u5199\u200b\u597d\u200b\u7684\u200b\u4ee3\u7801\u200b</p> </li> <li> <p><code>IMX6ULL\\source\\03_LCD\\10_lcd_drv_lcdcontroller_reg_config_use_devicetree</code></p> </li> <li> <p>\u200b\u5f15\u811a\u200b\u914d\u7f6e\u200b\u5de5\u5177\u200b/\u200b\u8bbe\u5907\u200b\u6811\u200b\u751f\u6210\u200b\u5de5\u5177\u200b</p> </li> <li> <p>\u200b\u6253\u5f00\u200b\uff1ahttp://download.100ask.net/</p> </li> <li>\u200b\u627e\u5230\u200b\u5f00\u53d1\u677f\u200b\uff1a\"100ASK_IMX6ULL_PRO\u200b\u5f00\u53d1\u677f\u200b\"</li> <li>\u200b\u4e0b\u8f7d\u200b\u5f00\u53d1\u677f\u200b\u914d\u5957\u200b\u8d44\u6599\u200b</li> <li>\u200b\u4e0b\u8f7d\u200b\u5b8c\u540e\u200b\uff0c\u200b\u5de5\u5177\u200b\u5728\u200b\u5982\u4e0b\u200b\u76ee\u5f55\u200b\u91cc\u200b\uff1a</li> </ul> <p></p>"},{"location":"03_LCD/15_1/#1","title":"1. \u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u64cd\u4f5c","text":"<p>LCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u7684\u200b\u6838\u5fc3\u200b\u5c31\u662f\u200b\uff1a</p> <ul> <li>\u200b\u5206\u914d\u200bfb_info</li> <li>\u200b\u8bbe\u7f6e\u200bfb_info</li> <li>\u200b\u6ce8\u518c\u200bfb_info</li> <li>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u8bbe\u7f6e\u200b</li> </ul> <p>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u8bbe\u7f6e\u200b\u53c8\u200b\u53ef\u4ee5\u200b\u5206\u4e3a\u200b3\u200b\u90e8\u5206\u200b\uff1a   * \u200b\u5f15\u811a\u200b\u8bbe\u7f6e\u200b   * \u200b\u65f6\u949f\u200b\u8bbe\u7f6e\u200b   * LCD\u200b\u63a7\u5236\u5668\u200b\u8bbe\u7f6e\u200b</p>"},{"location":"03_LCD/15_1/#2-lcd","title":"2. \u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u5b9a\u200bLCD\u200b\u53c2\u6570","text":"<pre><code>    framebuffer-mylcd {\n            compatible = \"100ask,lcd_drv\";\n            pinctrl-names = \"default\";\n            pinctrl-0 = &lt;&amp;mylcd_pinctrl&gt;;\n            backlight-gpios = &lt;&amp;gpio1 8 GPIO_ACTIVE_HIGH&gt;;\n\n            clocks = &lt;&amp;clks IMX6UL_CLK_LCDIF_PIX&gt;,\n                     &lt;&amp;clks IMX6UL_CLK_LCDIF_APB&gt;;\n            clock-names = \"pix\", \"axi\";\n\n            display = &lt;&amp;display0&gt;;\n\n            display0: display {\n                bits-per-pixel = &lt;24&gt;;\n                bus-width = &lt;24&gt;;\n\n                display-timings {\n                    native-mode = &lt;&amp;timing0&gt;;\n\n                     timing0: timing0_1024x768 {\n                     clock-frequency = &lt;50000000&gt;;\n                     hactive = &lt;1024&gt;;\n                     vactive = &lt;600&gt;;\n                     hfront-porch = &lt;160&gt;;\n                     hback-porch = &lt;140&gt;;\n                     hsync-len = &lt;20&gt;;\n                     vback-porch = &lt;20&gt;;\n                     vfront-porch = &lt;12&gt;;\n                     vsync-len = &lt;3&gt;;\n\n                     hsync-active = &lt;0&gt;;\n                     vsync-active = &lt;0&gt;;\n                     de-active = &lt;1&gt;;\n                     pixelclk-active = &lt;0&gt;;\n                     };\n\n                };\n            };            \n    };\n</code></pre>"},{"location":"03_LCD/15_1/#3","title":"3. \u200b\u7f16\u7a0b","text":""},{"location":"03_LCD/15_1/#31","title":"3.1 \u200b\u4ece\u200b\u8bbe\u5907\u200b\u6811\u200b\u83b7\u5f97\u200b\u53c2\u6570","text":"<p>\u200b\u65f6\u5e8f\u200b\u53c2\u6570\u200b\u3001\u200b\u5f15\u811a\u200b\u6781\u6027\u200b\u7b49\u200b\u4fe1\u606f\u200b\uff0c\u200b\u90fd\u200b\u88ab\u200b\u4fdd\u5b58\u200b\u5728\u200b\u4e00\u4e2a\u200bdisplay_timing\u200b\u7ed3\u6784\u200b\u4f53\u91cc\u200b\uff1a</p> <p></p> <p>\u200b\u53c2\u8003\u200b\u5185\u6838\u200b\u6587\u4ef6\u200b\uff1a</p> <ul> <li> <p><code>drivers\\video\\of_display_timing.c</code></p> </li> <li> <p><code>drivers\\video\\fbdev\\mxsfb.c</code></p> </li> </ul>"},{"location":"03_LCD/15_1/#32-lcd","title":"3.2 \u200b\u4f7f\u7528\u200b\u53c2\u6570\u200b\u914d\u7f6e\u200bLCD\u200b\u63a7\u5236\u5668","text":"<p>\u200b\u6839\u636e\u200b\u82af\u7247\u200b\u624b\u518c\u200b\uff0c\u200b\u4e00\u4e2a\u200b\u4e00\u4e2a\u200b\u8bbe\u7f6e\u200b\u5bc4\u5b58\u5668\u200b\uff1a</p> <ul> <li>Framebuffer\u200b\u5730\u5740\u200b\u8bbe\u7f6e\u200b</li> <li>Framebuffer\u200b\u4e2d\u200b\u6570\u636e\u683c\u5f0f\u200b\u8bbe\u7f6e\u200b</li> <li>LCD\u200b\u65f6\u5e8f\u200b\u53c2\u6570\u8bbe\u7f6e\u200b</li> <li>LCD\u200b\u5f15\u811a\u200b\u6781\u6027\u200b\u8bbe\u7f6e\u200b</li> </ul>"},{"location":"03_LCD/16/","title":"16_\u200b\u4e0a\u673a\u200b\u5b9e\u9a8c\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":""},{"location":"03_LCD/16/#_imx6ull","title":"\u4e0a\u673a\u200b\u5b9e\u9a8c\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff0cGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff1a</p> <ul> <li> <p>\u200b\u82af\u7247\u200b\u8d44\u6599\u200b</p> </li> <li> <p><code>IMX6ULL\\\u200b\u5f00\u53d1\u677f\u200b\u914d\u5957\u200b\u8d44\u6599\u200b\\datasheet\\Core_board\\CPU\\IMX6ULLRM.pdf</code></p> <ul> <li><code>\u300aChapter 34 Enhanced LCD Interface (eLCDIF)\u300b</code></li> </ul> </li> <li> <p>IMX6ULL\u200b\u7684\u200bLCD\u200b\u88f8\u673a\u200b\u7a0b\u5e8f\u200b</p> </li> <li> <p><code>IMX6ULL\\source\\03_LCD\\05_\u200b\u53c2\u8003\u200b\u7684\u200b\u88f8\u673a\u200b\u6e90\u7801\u200b\\03_font_test</code></p> </li> <li> <p>\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200bIMX6ULL LCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</p> </li> <li>\u200b\u9a71\u52a8\u200b\u6e90\u7801\u200b\uff1a<code>Linux-4.9.88\\drivers\\video\\fbdev\\mxsfb.c</code></li> <li>\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a<ul> <li><code>arch/arm/boot/dts/imx6ull.dtsi</code></li> <li><code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code></li> </ul> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u6d4b\u8bd5\u901a\u8fc7\u200b\u7684\u200b\u4ee3\u7801\u200b</p> </li> <li> <p><code>IMX6ULL\\source\\03_LCD\\11_lcd_drv_imx6ull_ok</code></p> </li> <li> <p>\u200b\u642d\u5efa\u200b\u5f00\u53d1\u200b\u73af\u5883\u200b</p> </li> <li>\u200b\u89c6\u9891\u200b\uff1ahttps://www.100ask.net/<ul> <li>\u300aLinux\u200b\u7cfb\u5217\u200b\u6559\u7a0b\u200b\u4e4b\u200b\u5feb\u901f\u200b\u5165\u95e8\u200b\u300b\u200b\u4e4b\u200b\u300a\u3010\u200b\u7b2c\u200b2\u200b\u7bc7\u200b\u3011\u200b\u73af\u5883\u200b\u642d\u5efa\u200b\u3001Linux\u200b\u57fa\u672c\u64cd\u4f5c\u200b\u3001\u200b\u5de5\u5177\u200b\u4f7f\u7528\u200b\u300b</li> </ul> </li> <li>\u200b\u6587\u6863\u200b\uff1a<code>git clone https://e.coding.net/weidongshan/01_all_series_quickstart.git</code><ul> <li>\u300a\u200b\u5d4c\u5165\u5f0f\u200bLinux\u200b\u5e94\u7528\u200b\u5f00\u53d1\u200b\u5b8c\u5168\u200b\u624b\u518c\u200b_\u200b\u97e6\u200b\u4e1c\u5c71\u200b\u5168\u7cfb\u5217\u200b\u89c6\u9891\u200b\u6587\u6863\u200b\u5168\u96c6\u200bV2.8.pdf\u300b</li> </ul> </li> </ul>"},{"location":"03_LCD/16/#1","title":"1. \u200b\u8981\u200b\u505a\u200b\u7684\u200b\u4e8b\u60c5","text":"<ul> <li> <p>\u200b\u53bb\u9664\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</p> </li> <li> <p>\u200b\u52a0\u5165\u200b\u6211\u4eec\u200b\u7f16\u5199\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u3001\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b</p> </li> <li> <p>\u200b\u91cd\u65b0\u200b\u7f16\u8bd1\u200b\u5185\u6838\u200b\u3001\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> <li> <p>\u200b\u4e0a\u673a\u200b\u6d4b\u8bd5\u200b\uff1a\u200b\u4f7f\u7528\u200b\u7f16\u8bd1\u200b\u51fa\u6765\u200b\u7684\u200b\u5185\u6838\u200b\u3001\u200b\u8bbe\u5907\u200b\u6811\u200b\u542f\u52a8\u200b\u677f\u5b50\u200b</p> </li> </ul>"},{"location":"03_LCD/16/#2","title":"2. \u200b\u53bb\u9664\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>\u200b\u4fee\u6539\u200b\u5185\u6838\u200b\u6587\u4ef6\u200b\uff1a<code>drivers/video/fbdev/Makefile</code>\uff0c\u200b\u628a\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u9a71\u52a8\u7a0b\u5e8f\u200bmxsfb.c\u200b\u5bf9\u5e94\u200b\u7684\u200b\u90a3\u884c\u200b\u6ce8\u91ca\u200b\u6389\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>#obj-$(CONFIG_FB_MXS)             += mxsfb.o\n</code></pre>"},{"location":"03_LCD/16/#3","title":"3. \u200b\u52a0\u5165\u200b\u65b0\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u3001\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li>\u200b\u590d\u5236\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff1a</li> <li>\u200b\u628a\u200b<code>11_lcd_drv_imx6ull_ok\\lcd_drv.c</code>\u200b\u653e\u5230\u200b\u5185\u6838\u200b\u6e90\u7801\u200b\u76ee\u5f55\u200b<code>drivers/video/fbdev</code></li> <li>\u200b\u5907\u4efd\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code></li> <li> <p>\u200b\u628a\u200b<code>11_lcd_drv_imx6ull_ok\\100ask_imx6ull-14x14.dts</code>\u200b\u653e\u5230\u200b\u5185\u6838\u200b\u6e90\u7801\u200b\u76ee\u5f55\u200b<code>arch/arm/boot/dts/</code></p> </li> <li> <p>\u200b\u4fee\u6539\u200b\u5185\u6838\u200b\u6587\u4ef6\u200b\uff1a</p> </li> <li>\u200b\u4fee\u6539\u200b\uff1a<code>drivers/video/fbdev/Makefile</code>\uff0c\u200b\u4f7f\u7528\u200b\u6211\u4eec\u200b\u63d0\u4f9b\u200b\u7684\u200blcd_drv.c\uff0c\u200b\u5982\u4e0b\u200b\uff1a</li> </ul> <pre><code>#obj-$(CONFIG_FB_MXS)             += mxsfb.o\nobj-$(CONFIG_FB_MXS)             += lcd_drv.o\n</code></pre>"},{"location":"03_LCD/16/#4","title":"4. \u200b\u91cd\u65b0\u200b\u7f16\u8bd1\u200b\u5185\u6838\u200b\u3001\u200b\u8bbe\u5907\u200b\u6811","text":"<p>\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u5728\u200bUbuntu\u200b\u4e2d\u200b\u6267\u884c\u200b\u3002</p> <ul> <li>\u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe\u200b</li> </ul> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre> <ul> <li>\u200b\u914d\u7f6e\u200b\u3001\u200b\u7f16\u8bd1\u200b</li> </ul> <pre><code>book@100ask:~/100ask_imx6ull-sdk$ cd Linux-4.9.88\nbook@100ask:~/100ask_imx6ull-sdk/Linux-4.9.88$ make 100ask_imx6ull_defconfig   \nbook@100ask:~/100ask_imx6ull-sdk/Linux-4.9.88$ make zImage \nbook@100ask:~/100ask_imx6ull-sdk/Linux-4.9.88$ make dtbs\n</code></pre> <ul> <li>\u200b\u5f97\u5230\u200b</li> <li>\u200b\u5185\u6838\u200b\uff1a<code>arch/arm/boot/zImage</code></li> <li> <p>\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> </li> </ul> <pre><code>$ cp arch/arm/boot/zImage ~/nfs_rootfs/\n$ cp arch/arm/boot/dts/100ask_imx6ull-14x14.dtb ~/nfs_rootfs/\n</code></pre>"},{"location":"03_LCD/16/#5","title":"5. \u200b\u4e0a\u673a\u200b\u6d4b\u8bd5","text":"<p>\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e2d\u200b\u6267\u884c\u200b\u3002</p> <ul> <li> <p>\u200b\u6302\u8f7d\u200bNFS</p> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.1.100)</p> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.1.137</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u5355\u677f\u200b\u6587\u4ef6\u200b</p> </li> </ul> <pre><code>[root@100ask:~]# cp /mnt/zImage /boot\n[root@100ask:~]# cp /mnt/100ask_imx6ull-14x14.dtb /boot\n[root@100ask:~]# sync\n</code></pre> <ul> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b\u89c2\u5bdf\u200b\u73b0\u8c61\u200b</p> </li> <li> <p>\u200b\u5982\u679c\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200b\u4f01\u9e45\u200bLOGO\uff0c\u200b\u5c31\u200b\u8868\u793a\u200b\u6b63\u5e38\u200b</p> </li> <li> <p>\u200b\u5982\u679c\u200b\u5728\u200b\u7ec8\u7aef\u200b\u4e2d\u200b\u53ef\u4ee5\u200b\u67e5\u770b\u200b\u5230\u200b\u5b58\u5728\u200b<code>/dev/fb0</code>\u200b\u8282\u70b9\u200b\uff0c\u200b\u4e5f\u200b\u8868\u793a\u200b\u6b63\u5e38\u200b</p> </li> <li> <p>\u200b\u89e3\u51b3\u200bBUG</p> </li> <li> <p>\u200b\u73b0\u8c61\u200b\uff1aLCD\u200b\u4e0a\u200b\u6ca1\u6709\u200b\u4f01\u9e45\u200bLOGO\uff0c\u200b\u5728\u200b\u7ec8\u7aef\u200b\u4e2d\u200b\u6267\u884c\u200b<code>ls -l /dev/fb0</code>\u200b\u53d1\u73b0\u200b\u6ca1\u6709\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b</p> </li> <li> <p>\u200b\u89c2\u5bdf\u200b\u5185\u6838\u200b\u542f\u52a8\u200b\u4fe1\u606f\u200b\uff0c\u200b\u770b\u5230\u200b\uff1a</p> <pre><code>[    0.619880] imx6ul-pinctrl 20e0000.iomuxc: pin MX6UL_PAD_GPIO1_IO08 already requested by 2080000.pwm; cannot claim for 21c8000.framebuffer-mylcd\n[    0.619920] imx6ul-pinctrl 20e0000.iomuxc: pin-31 (21c8000.framebuffer-mylcd) status -22\n[    0.619954] imx6ul-pinctrl 20e0000.iomuxc: could not request pin 31 (MX6UL_PAD_GPIO1_IO08) from group mylcd_pingrp  on device 20e0000.iomuxc\n[    0.619985] mylcd 21c8000.framebuffer-mylcd: Error applying setting, reverse things back\n[    0.620070] mylcd: probe of 21c8000.framebuffer-mylcd failed with error -22\n</code></pre> </li> <li> <p>\u200b\u539f\u56e0\u200b\uff1a\u200b\u5f15\u811a\u200b\u51b2\u7a81\u200b</p> <ul> <li>\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200bpwm\u200b\u8282\u70b9\u200b\u3001framebuffer-mylcd\u200b\u8282\u70b9\u200b\uff0c\u200b\u90fd\u200b\u4f7f\u7528\u200b\u5230\u200b\u7684\u200b\u540c\u4e00\u4e2a\u200b\u5f15\u811a\u200b\uff1aPAD_GPIO1_IO08</li> </ul> </li> <li> <p>\u200b\u89e3\u51b3\u200b\u65b9\u6cd5\u200b\uff1a\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code>\uff0c\u200b\u7981\u6b62\u200bpwm\u200b\u8282\u70b9\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a     </p> </li> </ul>"},{"location":"03_LCD/17_1/","title":"17_\u200b\u5355\u200bBuffer\u200b\u7684\u200b\u7f3a\u70b9\u200b\u4e0e\u200b\u6539\u8fdb\u200b\u65b9\u6cd5","text":""},{"location":"03_LCD/17_1/#buffer","title":"\u5355\u200bBuffer\u200b\u7684\u200b\u7f3a\u70b9\u200b\u4e0e\u200b\u6539\u8fdb\u200b\u65b9\u6cd5","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff0cGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff1a</p> <ul> <li> <p>\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200bLCD\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</p> </li> <li> <p>IMX6ULL\u200b\u9a71\u52a8\u200b\u6e90\u7801\u200b\uff1a<code>Linux-4.9.88\\drivers\\video\\fbdev\\mxsfb.c</code></p> </li> <li>STM32MP157\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u662f\u200b\u57fa\u4e8e\u200bGPU\u200b\u7684\u200b\uff0c\u200b\u5728\u200bLinux-5.4\u200b\u91cc\u200b\u6ca1\u6709\u200bmxsfb.c\uff0c\u200b\u53ef\u4ee5\u200b\u53c2\u8003\u200b\u53e6\u200b\u4e00\u4e2a\u200b\uff1a<ul> <li><code>Linux-5.4\\drivers\\video\\fbdev\\goldfishfb.c</code></li> </ul> </li> <li>\u200b\u5728\u200b\u89c6\u9891\u200b\u91cc\u200b\u57fa\u4e8e\u200bIMX6ULL\u200b\u7684\u200bmxsfb.c\u200b\u6765\u200b\u8bb2\u89e3\u200b\uff0c\u200b\u6211\u4eec\u200b\u628a\u200b\u8fd9\u4e2a\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e5f\u200b\u653e\u5230\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b<ul> <li><code>IMX6ULL\\source\\03_LCD\\12_lcd_drv_imx6ull_from_kernel_4.9.88</code></li> <li><code>STM32MP157\\source\\A7\\03_LCD\\12_lcd_drv_imx6ull_from_kernel_4.9.88</code></li> </ul> </li> <li>\u200b\u4f7f\u7528\u200b\u591a\u200bbuffer\u200b\u7684\u200bAPP\u200b\u53c2\u8003\u200b\u7a0b\u5e8f\u200b\uff0c\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u4e2d\u200b<ul> <li><code>IMX6ULL\\source\\03_LCD\\13_multi_framebuffer_example\\testcamera</code></li> <li><code>STM32MP157\\source\\A7\\03_LCD\\13_multi_framebuffer_example\\testcamera</code></li> </ul> </li> </ul>"},{"location":"03_LCD/17_1/#1-buffer","title":"1. \u200b\u5355\u200bBuffer\u200b\u7684\u200b\u7f3a\u70b9","text":"<ul> <li> <p>\u200b\u5982\u679c\u200bAPP\u200b\u901f\u5ea6\u200b\u5f88\u200b\u6162\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200b\u5b83\u200b\u5728\u200bLCD\u200b\u4e0a\u200b\u7f13\u6162\u200b\u7ed8\u5236\u200b\u56fe\u6848\u200b</p> </li> <li> <p>\u200b\u5373\u4f7f\u200bAPP\u200b\u901f\u5ea6\u200b\u5f88\u200b\u9ad8\u200b\uff0cLCD\u200b\u63a7\u5236\u5668\u200b\u4e0d\u65ad\u200b\u4ece\u200bFramebuffer\u200b\u4e2d\u200b\u8bfb\u53d6\u6570\u636e\u200b\u6765\u200b\u663e\u793a\u200b\uff0c\u200b\u800c\u200bAPP\u200b\u4e0d\u65ad\u200b\u628a\u200b\u6570\u636e\u200b\u5199\u5165\u200bFramebuffer</p> </li> <li> <p>\u200b\u5047\u8bbe\u200bAPP\u200b\u60f3\u200b\u628a\u200bLCD\u200b\u663e\u793a\u200b\u4e3a\u6574\u200b\u5c4f\u5e55\u200b\u7684\u200b\u84dd\u8272\u200b\u3001\u200b\u7ea2\u8272\u200b</p> </li> <li> <p>\u200b\u5f88\u5927\u200b\u51e0\u7387\u200b\u51fa\u73b0\u200b\u8fd9\u79cd\u200b\u60c5\u51b5\u200b\uff1a</p> <ul> <li>LCD\u200b\u63a7\u5236\u5668\u200b\u8bfb\u53d6\u200bFramebuffer\u200b\u6570\u636e\u200b\uff0c\u200b\u8bfb\u200b\u5230\u200b\u4e00\u534a\u200b\u65f6\u200b\uff0c\u200b\u5728\u200bLCD\u200b\u4e0a\u200b\u663e\u793a\u200b\u4e86\u200b\u534a\u200b\u5c4f\u5e55\u200b\u7684\u200b\u84dd\u8272\u200b</li> <li>\u200b\u8fd9\u662f\u200bAPP\u200b\u975e\u5e38\u200b\u9ad8\u6548\u200b\u5730\u200b\u628a\u200b\u6574\u4e2a\u200bFramebuffer\u200b\u7684\u200b\u6570\u636e\u200b\u90fd\u200b\u6539\u4e3a\u200b\u4e86\u200b\u7ea2\u8272\u200b</li> <li>LCD\u200b\u63a7\u5236\u5668\u200b\u7ee7\u7eed\u200b\u8bfb\u53d6\u6570\u636e\u200b\uff0c\u200b\u4e8e\u662f\u200bLCD\u200b\u4e0a\u200b\u5c31\u200b\u4f1a\u200b\u663e\u793a\u200b\u534a\u200b\u5c4f\u5e55\u200b\u84dd\u8272\u200b\u3001\u200b\u534a\u200b\u5c4f\u5e55\u200b\u7ea2\u8272\u200b</li> <li>\u200b\u4eba\u773c\u200b\u5c31\u200b\u4f1a\u200b\u611f\u89c9\u200b\u5230\u200b\u5c4f\u5e55\u200b\u95ea\u70c1\u200b\u3001\u200b\u6495\u88c2\u200b</li> </ul> <p></p> </li> </ul>"},{"location":"03_LCD/17_1/#2-buffer","title":"2. \u200b\u4f7f\u7528\u200b\u591a\u200bBuffer\u200b\u6765\u200b\u6539\u8fdb","text":"<p>\u200b\u4e0a\u8ff0\u200b\u4e24\u4e2a\u200b\u7f3a\u70b9\u200b\u7684\u200b\u6839\u6e90\u200b\u662f\u200b\u4e00\u81f4\u200b\u7684\u200b\uff1aFramebuffer\u200b\u4e2d\u200b\u7684\u200b\u6570\u636e\u200b\u8fd8\u200b\u6ca1\u200b\u51c6\u5907\u200b\u597d\u6574\u200b\u5e27\u200b\u6570\u636e\u200b\uff0c\u200b\u5c31\u200b\u88ab\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u4f7f\u7528\u200b\u4e86\u200b\u3002 \u200b\u4f7f\u7528\u200b\u53cc\u200bbuffer\u200b\u751a\u81f3\u200b\u591a\u200bbuffer\u200b\u53ef\u4ee5\u200b\u89e3\u51b3\u200b\u8fd9\u4e2a\u200b\u95ee\u9898\u200b\uff1a</p> <ul> <li>\u200b\u5047\u8bbe\u200b\u6709\u200b2\u200b\u4e2a\u200bFramebuffer\uff1aFB0\u3001FB1</li> <li>LCD\u200b\u63a7\u5236\u5668\u200b\u6b63\u5728\u200b\u8bfb\u53d6\u200bFB0</li> <li>APP\u200b\u5199\u200bFB1</li> <li>\u200b\u5199\u200b\u597d\u200bFB1\u200b\u540e\u200b\uff0c\u200b\u8ba9\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u5207\u6362\u200b\u5230\u200bFB1</li> <li>APP\u200b\u5199\u200bFB0</li> <li>\u200b\u5199\u200b\u597d\u200bFB0\u200b\u540e\u200b\uff0c\u200b\u8ba9\u200bLCD\u200b\u63a7\u5236\u5668\u200b\u5207\u6362\u200b\u5230\u200bFB0  </li> </ul>"},{"location":"03_LCD/17_1/#3-appbuffer","title":"3. \u200b\u5185\u6838\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u3001APP\u200b\u4e92\u76f8\u914d\u5408\u200b\u4f7f\u7528\u200b\u591a\u200bbuffer","text":"<p>\u200b\u6d41\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <ul> <li>\u200b\u9a71\u52a8\u200b\uff1a\u200b\u5206\u914d\u200b\u591a\u4e2a\u200bbuffer</li> </ul> <pre><code>fb_info-&gt;fix.smem_len = SZ_32M;\nfbi-&gt;screen_base = dma_alloc_writecombine(fbi-&gt;device,\n              fbi-&gt;fix.smem_len,\n              (dma_addr_t *)&amp;fbi-&gt;fix.smem_start,\n              GFP_DMA | GFP_KERNEL);\n</code></pre> <ul> <li>\u200b\u9a71\u52a8\u200b\uff1a\u200b\u4fdd\u5b58\u200bbuffer\u200b\u4fe1\u606f\u200b</li> </ul> <pre><code>fb_info-&gt;fix.smem_len  // \u200b\u542b\u6709\u200b\u603b\u200bbuffer\u200b\u5927\u5c0f\u200b \nfb_info-&gt;var           // \u200b\u542b\u6709\u200b\u5355\u4e2a\u200bbuffer\u200b\u4fe1\u606f\u200b\n</code></pre> <ul> <li>APP\uff1a\u200b\u8bfb\u53d6\u200bbuffer\u200b\u4fe1\u606f\u200b</li> </ul> <pre><code>ioctl(fd_fb, FBIOGET_FSCREENINFO, &amp;fix);\nioctl(fd_fb, FBIOGET_VSCREENINFO, &amp;var);\n\n// \u200b\u8ba1\u7b97\u200b\u662f\u5426\u200b\u652f\u6301\u200b\u591a\u200bbuffer\uff0c\u200b\u6709\u200b\u591a\u5c11\u200b\u4e2a\u200bbuffer\nscreen_size = var.xres * var.yres * var.bits_per_pixel / 8;\nnBuffers = fix.smem_len / screen_size;\n</code></pre> <ul> <li>APP\uff1a\u200b\u4f7f\u80fd\u200b\u591a\u200bbuffer</li> </ul> <pre><code>var.yres_virtual = nBuffers * var.yres;\nioctl(fd_fb, FBIOPUT_VSCREENINFO, &amp;var);\n</code></pre> <ul> <li>APP\uff1a\u200b\u5199\u200bbuffer</li> </ul> <pre><code>fb_base = (unsigned char *)mmap(NULL , fix.smem_len, PROT_READ | PROT_WRITE, MAP_SHARED, fd_fb, 0);\n\n/* get buffer */\npNextBuffer =  fb_base + nNextBuffer * screen_size;\n\n/* set buffer */\nlcd_draw_screen(pNextBuffer, colors[i]);\n</code></pre> <ul> <li>APP\uff1a\u200b\u5f00\u59cb\u200b\u5207\u6362\u200bbuffer</li> </ul> <pre><code>/* switch buffer */\nvar.yoffset = nNextBuffer * var.yres;\nioctl(fd_fb, FBIOPAN_DISPLAY, &amp;var);\n</code></pre> <ul> <li>\u200b\u9a71\u52a8\u200b\uff1a\u200b\u5207\u6362\u200bbuffer</li> </ul> <pre><code>// fbmem.c\nfb_ioctl\n    do_fb_ioctl\n      fb_pan_display(info, &amp;var);\n          err = info-&gt;fbops-&gt;fb_pan_display(var, info) // \u200b\u8c03\u7528\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u51fd\u6570\u200b            \n</code></pre> <p>\u200b\u793a\u4f8b\u200b\uff1a   </p> <ul> <li>APP\uff1a\u200b\u7b49\u5f85\u200b\u5207\u6362\u200b\u5b8c\u6210\u200b(\u200b\u5728\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e2d\u200b\u5df2\u7ecf\u200b\u7b49\u5f85\u200b\u5207\u6362\u200b\u5b8c\u6210\u200b\u4e86\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8fd9\u4e2a\u200b\u8c03\u7528\u200b\u5e76\u200b\u65e0\u200b\u5fc5\u8981\u200b)</li> </ul> <pre><code>ret = 0;\nioctl(fd_fb, FBIO_WAITFORVSYNC, &amp;ret);\n</code></pre>"},{"location":"03_LCD/18/","title":"18_\u200b\u7f16\u5199\u200b\u4f7f\u7528\u200b\u591a\u200bbuffer\u200b\u7684\u200b\u5e94\u7528\u7a0b\u5e8f","text":""},{"location":"03_LCD/18/#buffer","title":"\u7f16\u5199\u200b\u4f7f\u7528\u200b\u591a\u200bbuffer\u200b\u7684\u200b\u5e94\u7528\u7a0b\u5e8f","text":"<ul> <li>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u7f16\u5199\u200b\u597d\u200b\u7684\u200b\u7a0b\u5e8f\u200b\uff0c\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b</li> <li><code>IMX6ULL\\source\\03_LCD\\14_use_multi_framebuffer</code></li> <li> <p><code>STM32MP157\\source\\A7\\03_LCD\\14_use_multi_framebuffer</code></p> </li> <li> <p>\u200b\u53c2\u8003\u200b\u7a0b\u5e8f\u200b\uff1a\u200b\u5e94\u7528\u200b\u57fa\u7840\u200b\u8bfe\u7a0b\u200b\u91cc\u200b\u4f7f\u7528\u200bFramebuffer\u200b\u7684\u200b\u7cbe\u7b80\u200b\u7a0b\u5e8f\u200b</p> </li> <li><code>IMX6ULL\\source\\03_LCD\\14_use_multi_framebuffer\\reference\\07_framebuffer</code></li> <li> <p><code>STM32MP157\\source\\A7\\03_LCD\\14_use_multi_framebuffer\\reference\\07_framebuffer</code></p> </li> <li> <p>\u200b\u53c2\u8003\u200b\u7a0b\u5e8f\u200b\uff1a\u200b\u4f7f\u7528\u200b\u591a\u200bbuffer\u200b\u7684\u200bAPP\uff0c\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b</p> <ul> <li><code>IMX6ULL\\source\\03_LCD\\13_multi_framebuffer_example\\testcamera</code></li> <li><code>STM32MP157\\source\\A7\\03_LCD\\13_multi_framebuffer_example\\testcamera</code></li> </ul> </li> </ul>"},{"location":"03_LCD/18/#1-bufferbufferapp","title":"1. \u200b\u7f16\u5199\u200b\u4e00\u4e2a\u200b\u652f\u6301\u200b\u5355\u200bbuffer\u3001\u200b\u591a\u200bbuffer\u200b\u7684\u200bAPP","text":"<p>\u200b\u5faa\u73af\u200b\u663e\u793a\u200b\u6574\u200b\u5c4f\u5e55\u200b\u7684\u200b\u7ea2\u200b\u3001\u200b\u7eff\u200b\u3001\u200b\u84dd\u200b\u3001\u200b\u9ed1\u200b\u3001\u200b\u767d\u200b\u3002</p>"},{"location":"03_LCD/18/#2","title":"2. \u200b\u7f16\u8bd1\u7a0b\u5e8f","text":""},{"location":"03_LCD/18/#21","title":"2.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<ul> <li>\u200b\u5bf9\u4e8e\u200bIMX6ULL</li> </ul> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre> <ul> <li>\u200b\u5bf9\u4e8e\u200bSTM32MP157</li> </ul> <pre><code>source /home/book/100ask_stm32mp157_pro-sdk/ToolChain/openstlinux_eglfs-linux-gnueabi/environment-setup-cortexa7t2hf-neon-vfpv4-ostl-linux-gnueabi\nexport ARCH=arm\nexport CROSS_COMPILE=arm-ostl-linux-gnueabi-\n</code></pre>"},{"location":"03_LCD/18/#22","title":"2.2 \u200b\u7f16\u8bd1","text":"<p>\u200b\u8bbe\u7f6e\u200b\u597d\u200b\u5de5\u5177\u200b\u94fe\u540e\u200b\uff0c\u200b\u628a\u200b<code>14_use_multi_framebuffer</code>\u200b\u4e0a\u200b\u4f20\u5230\u200bUbuntu\uff0c\u200b\u5728\u200b\u8be5\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b<code>make</code>\u200b\u5373\u53ef\u200b</p>"},{"location":"03_LCD/18/#3","title":"3. \u200b\u4e0a\u673a\u200b\u6d4b\u8bd5","text":""},{"location":"03_LCD/18/#31-lcd","title":"3.1 \u200b\u6062\u590d\u200b\u5185\u6838\u200b\u4f7f\u7528\u200b\u81ea\u5e26\u200b\u7684\u200bLCD\u200b\u9a71\u52a8","text":"<ul> <li>\u200b\u6062\u590d\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff1a\u200b\u4fee\u6539\u200b<code>drivers/video/fbdev/Makefile</code>\uff0c\u200b\u6062\u590d\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200bmxsfb.c\uff0c\u200b\u5982\u4e0b\u200b\uff1a</li> </ul> <pre><code>obj-$(CONFIG_FB_MXS)             += mxsfb.o\n#obj-$(CONFIG_FB_MXS)             += lcd_drv.o\n</code></pre> <ul> <li> <p>\u200b\u6062\u590d\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> <li> <p>\u200b\u628a\u200bGIT\u200b\u4ed3\u5e93\u200b\u4e2d\u200b\u7684\u200b\u6587\u4ef6\u200b\u590d\u5236\u5230\u200b\u5185\u6838\u200barch/arm/boo/dts\u200b\u76ee\u5f55\u200b</p> <ul> <li><code>doc_and_source_for_drivers\\IMX6ULL\\source\\03_LCD\\11_lcd_drv_imx6ull_ok\\origin</code></li> </ul> </li> <li> <p>\u200b\u91cd\u65b0\u200b\u7f16\u8bd1\u200b\u5185\u6838\u200b\u3001\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> </ul> <pre><code>make zImage\nmake dtbs\n</code></pre> <ul> <li> <p>\u200b\u66ff\u6362\u200b\u5185\u6838\u200b\u3001\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> <li> <p>\u200b\u628a\u200b\u7f16\u8bd1\u200b\u51fa\u6765\u200b\u7684\u200b<code>arch/arm/boot/zImage</code>\u3001<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> </li> <li>\u200b\u653e\u5230\u200b\u5f00\u53d1\u677f\u200b\u7684\u200b/boot\u200b\u76ee\u5f55\u200b</li> </ul>"},{"location":"03_LCD/18/#32-gui","title":"3.2 \u200b\u7981\u6b62\u200b\u5f00\u53d1\u677f\u200b\u81ea\u5e26\u200b\u7684\u200bGUI\u200b\u7a0b\u5e8f","text":"<p>\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\uff1a</p> <pre><code>[root@100ask:~]# mv /etc/init.d/S99myirhmi2 /etc/\n[root@100ask:~]# reboot\n</code></pre>"},{"location":"03_LCD/18/#33","title":"3.3 \u200b\u628a\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b\u653e\u5230\u200b\u677f\u5b50\u200b\u4e0a\u200b\u3001\u200b\u6267\u884c","text":"<p>\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e2d\u200b\u6267\u884c\u200b\u3002</p> <ul> <li> <p>\u200b\u6302\u8f7d\u200bNFS</p> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.1.100)</p> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.1.137</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u200b\u3001\u200b\u6267\u884c\u7a0b\u5e8f\u200b</p> </li> </ul> <pre><code>[root@100ask:~]# cp /mnt/multi_framebuffer_test   /bin\n[root@100ask:~]# multi_framebuffer_test single \u200b\u6216\u200b multi_framebuffer_test double\n</code></pre>"},{"location":"03_LCD/18/#4-lcd","title":"4. LCD\u200b\u81ea\u52a8\u200b\u9ed1\u5c4f","text":"<p>\u200b\u4e3a\u4e86\u200b\u7701\u200b\u7535\u200b\uff0cLCD\u200b\u5728\u200b10\u200b\u5206\u949f\u200b\u5de6\u53f3\u200b\u4f1a\u200b\u81ea\u52a8\u200b\u9ed1\u5c4f\u200b\u3002 \u200b\u5982\u679c\u200b\u4f60\u200b\u6b63\u5728\u200b\u8fd0\u884c\u200bmulti_framebuffer_test\u200b\u7a0b\u5e8f\u200b\uff0c\u200b\u53ef\u80fd\u200b\u4f1a\u200b\u6709\u200b\u5982\u4e0b\u200b\u63d0\u793a\u200b(\u200b\u4ee5\u200bIMX6ULL\u200b\u4e3a\u4f8b\u200b)\uff1a</p> <pre><code>[  961.147548] mxsfb 21c8000.lcdif: can't wait for VSYNC when fb is blank\n</code></pre> <p>\u200b\u8fd9\u200b\u8868\u793a\u200b\uff1a\u200b\u5f53\u200b\u5c4f\u5e55\u200b\u4e3a\u200bblank(\u200b\u9ed1\u5c4f\u200b)\u200b\u65f6\u200b\uff0c\u200b\u65e0\u6cd5\u200b\u7b49\u5f85\u200bVSYNC\u3002</p> <p>\u200b\u6211\u4eec\u200b\u53ef\u4ee5\u200b\u7981\u6b62\u200bLCD\u200b\u81ea\u52a8\u200b\u9ed1\u5c4f\u200b\uff0c\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u5373\u53ef\u200b\uff1a</p> <pre><code>#close lcd sleep\necho -e \"\\033[9;0]\" &gt; /dev/tty1\necho -e \"\\033[?25l\"  &gt; /dev/tty1\n</code></pre>"},{"location":"04_I2C/01/","title":"01_I2C\u200b\u89c6\u9891\u200b\u4ecb\u7ecd","text":""},{"location":"04_I2C/01/#i2c","title":"I2C\u200b\u89c6\u9891\u200b\u4ecb\u7ecd","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>I2CTools\uff1ahttps://mirrors.edge.kernel.org/pub/software/utils/i2c-tools/</li> </ul>"},{"location":"04_I2C/01/#1-i2c","title":"1. I2C\u200b\u786c\u4ef6\u200b\u6846\u67b6","text":"<ul> <li>\u200b\u5728\u200b\u4e00\u4e2a\u200b\u82af\u7247\u200b(SoC)\u200b\u5185\u90e8\u200b\uff0c\u200b\u6709\u200b\u4e00\u4e2a\u200b\u6216\u200b\u591a\u4e2a\u200bI2C\u200b\u63a7\u5236\u5668\u200b</li> <li>\u200b\u5728\u200b\u4e00\u4e2a\u200bI2C\u200b\u63a7\u5236\u5668\u200b\u4e0a\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u8fde\u63a5\u200b\u4e00\u4e2a\u200b\u6216\u200b\u591a\u4e2a\u200bI2C\u200b\u8bbe\u5907\u200b</li> <li>I2C\u200b\u603b\u7ebf\u200b\u53ea\u200b\u9700\u8981\u200b2\u200b\u6761\u7ebf\u200b\uff1a\u200b\u65f6\u949f\u200b\u7ebf\u200bSCL\u3001\u200b\u6570\u636e\u7ebf\u200bSDA</li> <li>\u200b\u5728\u200bI2C\u200b\u603b\u7ebf\u200b\u7684\u200bSCL\u3001SDA\u200b\u7ebf\u4e0a\u200b\uff0c\u200b\u90fd\u200b\u6709\u200b\u4e0a\u200b\u62c9\u200b\u7535\u963b\u200b</li> </ul>"},{"location":"04_I2C/01/#2-i2c","title":"2. I2C\u200b\u8f6f\u4ef6\u200b\u6846\u67b6","text":"<p>\u200b\u4ee5\u200bI2C\u200b\u63a5\u53e3\u200b\u7684\u200b\u5b58\u50a8\u8bbe\u5907\u200bAT24C02\u200b\u4e3a\u4f8b\u200b\uff1a</p> <ul> <li>APP\uff1a</li> <li>\u200b\u63d0\u51fa\u200b\u8981\u6c42\u200b\uff1a\u200b\u628a\u200b\u5b57\u7b26\u4e32\u200b\"www.100ask.net\"\u200b\u5199\u5165\u200bAT24C02\u200b\u5730\u5740\u200b16\u200b\u5f00\u59cb\u200b\u7684\u200b\u5730\u65b9\u200b</li> <li>\u200b\u5b83\u200b\u662f\u200b\u5927\u7237\u200b\uff0c\u200b\u4e0d\u200b\u5173\u5fc3\u200b\u5e95\u5c42\u200b\u5b9e\u73b0\u200b\u7684\u200b\u7ec6\u8282\u200b</li> <li>\u200b\u5b83\u200b\u53ea\u200b\u9700\u8981\u200b\u8c03\u7528\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u63d0\u4f9b\u200b\u7684\u200b\u63a5\u53e3\u200b</li> <li>AT24C02\u200b\u9a71\u52a8\u200b\uff1a</li> <li>\u200b\u5b83\u200b\u77e5\u9053\u200bAT24C02\u200b\u8981\u6c42\u200b\u7684\u200b\u5730\u5740\u200b\u3001\u200b\u6570\u636e\u683c\u5f0f\u200b</li> <li>\u200b\u5b83\u200b\u77e5\u9053\u200b\u53d1\u51fa\u200b\u4ec0\u4e48\u200b\u4fe1\u53f7\u200b\u624d\u80fd\u200b\u8ba9\u200bAT24C02\u200b\u6267\u884c\u200b\u64e6\u9664\u200b\u3001\u200b\u70e7\u5199\u200b\u5de5\u4f5c\u200b</li> <li>\u200b\u5b83\u200b\u77e5\u9053\u200b\u600e\u4e48\u200b\u5224\u65ad\u200b\u6570\u636e\u200b\u662f\u5426\u200b\u70e7\u5199\u200b\u6210\u529f\u200b</li> <li>\u200b\u5b83\u200b\u6784\u9020\u200b\u597d\u200b\u4e00\u7cfb\u5217\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u53d1\u7ed9\u200bI2C\u200b\u63a7\u5236\u5668\u200b</li> <li>I2C\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b</li> <li>\u200b\u5b83\u200b\u6839\u636e\u200bI2C\u200b\u534f\u8bae\u200b\u53d1\u51fa\u200b\u5404\u7c7b\u200b\u4fe1\u53f7\u200b\uff1aI2C\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\u3001I2C\u200b\u5b58\u50a8\u200b\u5730\u5740\u200b\u3001\u200b\u6570\u636e\u200b</li> <li>\u200b\u5b83\u200b\u6839\u636e\u200bI2C\u200b\u534f\u8bae\u200b\u5224\u65ad\u200b</li> </ul>"},{"location":"04_I2C/01/#3","title":"3. \u200b\u6211\u4eec\u200b\u8bb2\u200b\u4ec0\u4e48","text":""},{"location":"04_I2C/01/#31-linux","title":"3.1 \u200b\u5bf9\u4e8e\u200bLinux","text":"<p>\u200b\u4ece\u4e0a\u5230\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u5148\u8bb2\u200bI2C\u200b\u534f\u8bae\u200b</li> <li>APP\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200b\u4e24\u7c7b\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u8bbf\u95ee\u200b\u8bbe\u5907\u200b</li> <li>I2C\u200b\u8bbe\u5907\u200b\u81ea\u5df1\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</li> <li>\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200bi2c-dev.c\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u5b83\u200b\u662f\u200bi2c\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b\u66b4\u9732\u200b\u7ed9\u200b\u7528\u6237\u200b\u7a7a\u95f4\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b(i2c-dev.c)</li> <li>I2C Device Driver</li> <li>I2C\u200b\u8bbe\u5907\u200b\u81ea\u5df1\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</li> <li>\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200bi2c-dev.c\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u5b83\u200b\u662f\u200bi2c\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b\u66b4\u9732\u200b\u7ed9\u200b\u7528\u6237\u200b\u7a7a\u95f4\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b(i2c-dev.c)</li> <li>I2C Controller Driver</li> <li>\u200b\u82af\u7247\u200bI2C\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b(\u200b\u79f0\u4e3a\u200badapter)</li> <li>\u200b\u4f7f\u7528\u200bGPIO\u200b\u6a21\u62df\u200b\u7684\u200bI2C\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b(i2c-gpio.c)</li> </ul>"},{"location":"04_I2C/01/#32","title":"3.2 \u200b\u5bf9\u4e8e\u200b\u5355\u7247\u673a\u200b/\u200b\u88f8\u673a","text":"<p>\u200b\u4ece\u4e0a\u5230\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u5148\u8bb2\u200bI2C\u200b\u534f\u8bae\u200b</li> <li>APP</li> <li>I2C Device Driver</li> <li>I2C Controller Driver(\u200b\u4e5f\u200b\u88ab\u200b\u79f0\u4e3a\u200badapter)</li> </ul>"},{"location":"04_I2C/02_1/","title":"02_I2C\u200b\u534f\u8bae","text":""},{"location":"04_I2C/02_1/#i2c","title":"I2C\u200b\u534f\u8bae","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>i2c_spec.pdf</li> </ul>"},{"location":"04_I2C/02_1/#1","title":"1. \u200b\u786c\u4ef6\u200b\u8fde\u63a5","text":"<p>I2C\u200b\u5728\u200b\u786c\u4ef6\u200b\u4e0a\u200b\u7684\u200b\u63a5\u6cd5\u200b\u5982\u4e0b\u200b\u6240\u793a\u200b\uff0c\u200b\u4e3b\u63a7\u200b\u82af\u7247\u200b\u5f15\u51fa\u200b\u4e24\u6761\u7ebf\u200bSCL,SDA\u200b\u7ebf\u200b\uff0c\u200b\u5728\u200b\u4e00\u6761\u200bI2C\u200b\u603b\u7ebf\u200b\u4e0a\u200b\u53ef\u4ee5\u200b\u63a5\u200b\u5f88\u591a\u200bI2C\u200b\u8bbe\u5907\u200b\uff0c\u200b\u6211\u4eec\u200b\u8fd8\u4f1a\u653e\u200b\u4e00\u4e2a\u200b\u4e0a\u62c9\u200b\u7535\u963b\u200b\uff08\u200b\u653e\u200b\u4e00\u4e2a\u200b\u4e0a\u62c9\u200b\u7535\u963b\u200b\u7684\u200b\u539f\u56e0\u200b\u4ee5\u540e\u200b\u6211\u4eec\u200b\u518d\u8bf4\u200b\uff09\u3002</p> <p></p>"},{"location":"04_I2C/02_1/#2","title":"2. \u200b\u4f20\u8f93\u6570\u636e\u200b\u7c7b\u6bd4","text":"<p>\u200b\u600e\u4e48\u200b\u901a\u8fc7\u200bI2C\u200b\u4f20\u8f93\u6570\u636e\u200b\uff0c\u200b\u6211\u4eec\u200b\u9700\u8981\u200b\u628a\u200b\u6570\u636e\u200b\u4ece\u4e3b\u200b\u8bbe\u5907\u200b\u53d1\u9001\u5230\u200b\u4ece\u200b\u8bbe\u5907\u200b\u4e0a\u53bb\u200b\uff0c\u200b\u4e5f\u200b\u9700\u8981\u200b\u628a\u200b\u6570\u636e\u200b\u4ece\u200b\u4ece\u200b\u8bbe\u5907\u200b\u4f20\u9001\u200b\u5230\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u4e0a\u53bb\u200b\uff0c\u200b\u6570\u636e\u200b\u6d89\u53ca\u200b\u5230\u200b\u53cc\u5411\u200b\u4f20\u8f93\u200b\u3002</p> <p>\u200b\u4e3e\u4e2a\u200b\u4f8b\u5b50\u200b\uff1a</p> <p></p> <p>\u200b\u4f53\u80b2\u8001\u5e08\u200b\uff1a\u200b\u53ef\u4ee5\u200b\u628a\u200b\u7403\u200b\u53d1\u7ed9\u200b\u5b66\u751f\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u628a\u200b\u7403\u200b\u4ece\u200b\u5b66\u751f\u200b\u4e2d\u200b\u63a5\u8fc7\u200b\u6765\u200b\u3002</p> <ul> <li>\u200b\u53d1\u7403\u200b\uff1a</li> <li>\u200b\u8001\u5e08\u200b\uff1a\u200b\u5f00\u59cb\u200b\u4e86\u200b(start)</li> <li>\u200b\u8001\u5e08\u200b\uff1aA\uff01\u200b\u6211\u8981\u200b\u53d1\u7403\u200b\u7ed9\u200b\u4f60\u200b\uff01(\u200b\u5730\u5740\u200b/\u200b\u65b9\u5411\u200b)</li> <li>\u200b\u5b66\u751f\u200bA\uff1a\u200b\u5230\u200b\uff01(\u200b\u56de\u5e94\u200b)</li> <li>\u200b\u8001\u5e08\u200b\u628a\u200b\u7403\u200b\u53d1\u51fa\u200b\u53bb\u200b\uff08\u200b\u4f20\u8f93\u200b\uff09</li> <li>A\u200b\u6536\u5230\u200b\u7403\u200b\u4e4b\u540e\u200b\uff0c\u200b\u5e94\u8be5\u200b\u544a\u8bc9\u200b\u8001\u5e08\u200b\u4e00\u58f0\u200b\uff08\u200b\u56de\u5e94\u200b\uff09</li> <li> <p>\u200b\u8001\u5e08\u200b\uff1a\u200b\u7ed3\u675f\u200b\uff08\u200b\u505c\u6b62\u200b\uff09</p> </li> <li> <p>\u200b\u63a5\u7403\u200b\uff1a</p> </li> <li>\u200b\u8001\u5e08\u200b\uff1a\u200b\u5f00\u59cb\u200b\u4e86\u200b(start)</li> <li>\u200b\u8001\u5e08\u200b\uff1aB\uff01\u200b\u628a\u200b\u7403\u200b\u53d1\u7ed9\u200b\u6211\u200b\uff01(\u200b\u5730\u5740\u200b/\u200b\u65b9\u5411\u200b)</li> <li>\u200b\u5b66\u751f\u200bB\uff1a\u200b\u5230\u200b\uff01</li> <li>B\u200b\u628a\u200b\u7403\u200b\u53d1\u7ed9\u200b\u8001\u5e08\u200b\uff08\u200b\u4f20\u8f93\u200b\uff09</li> <li>\u200b\u8001\u5e08\u200b\u6536\u5230\u200b\u7403\u200b\u4e4b\u540e\u200b\uff0c\u200b\u7ed9\u200bB\u200b\u8bf4\u200b\u4e00\u58f0\u200b\uff0c\u200b\u8868\u793a\u200b\u6536\u5230\u200b\u7403\u200b\u4e86\u200b\uff08\u200b\u56de\u5e94\u200b\uff09</li> <li>\u200b\u8001\u5e08\u200b\uff1a\u200b\u7ed3\u675f\u200b\uff08\u200b\u505c\u6b62\u200b\uff09</li> </ul> <p>\u200b\u6211\u4eec\u200b\u5c31\u200b\u4f7f\u7528\u200b\u8fd9\u4e2a\u200b\u7b80\u5355\u200b\u7684\u200b\u4f8b\u5b50\u200b\uff0c\u200b\u6765\u200b\u89e3\u91ca\u4e00\u4e0b\u200bIIC\u200b\u7684\u200b\u4f20\u8f93\u200b\u534f\u8bae\u200b\uff1a</p> <ul> <li>\u200b\u8001\u5e08\u200b\u8bf4\u200b\u5f00\u59cb\u200b\u4e86\u200b\uff0c\u200b\u8868\u793a\u200b\u5f00\u59cb\u200b\u4fe1\u53f7\u200b(start)</li> <li>\u200b\u8001\u5e08\u200b\u63d0\u9192\u200b\u67d0\u4e2a\u200b\u5b66\u751f\u200b\u8981\u200b\u53d1\u7403\u200b\uff0c\u200b\u8868\u793a\u200b\u53d1\u9001\u200b\u5730\u5740\u200b\u548c\u200b\u65b9\u5411\u200b(address/read/write)</li> <li>\u200b\u8001\u5e08\u200b\u53d1\u7403\u200b/\u200b\u63a5\u7403\u200b\uff0c\u200b\u8868\u793a\u200b\u6570\u636e\u200b\u7684\u200b\u4f20\u8f93\u200b</li> <li>\u200b\u6536\u5230\u200b\u7403\u8981\u200b\u56de\u5e94\u200b\uff1a\u200b\u56de\u5e94\u200b\u4fe1\u53f7\u200b(ACK)</li> <li>\u200b\u8001\u5e08\u200b\u8bf4\u200b\u7ed3\u675f\u200b\uff0c\u200b\u8868\u793a\u200bIIC\u200b\u4f20\u8f93\u200b\u7ed3\u675f\u200b(P)</li> </ul>"},{"location":"04_I2C/02_1/#3-iic","title":"3. IIC\u200b\u4f20\u8f93\u6570\u636e\u200b\u7684\u200b\u683c\u5f0f","text":""},{"location":"04_I2C/02_1/#31","title":"3.1 \u200b\u5199\u200b\u64cd\u4f5c","text":"<p>\u200b\u6d41\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u4e3b\u200b\u82af\u7247\u200b\u8981\u200b\u53d1\u51fa\u200b\u4e00\u4e2a\u200bstart\u200b\u4fe1\u53f7\u200b</li> <li>\u200b\u7136\u540e\u200b\u53d1\u51fa\u200b\u4e00\u4e2a\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b(\u200b\u7528\u6765\u200b\u786e\u5b9a\u200b\u662f\u200b\u5f80\u200b\u54ea\u200b\u4e00\u4e2a\u200b\u82af\u7247\u200b\u5199\u200b\u6570\u636e\u200b)\uff0c\u200b\u65b9\u5411\u200b(\u200b\u8bfb\u200b/\u200b\u5199\u200b\uff0c0\u200b\u8868\u793a\u200b\u5199\u200b\uff0c1\u200b\u8868\u793a\u200b\u8bfb\u200b)</li> <li>\u200b\u4ece\u200b\u8bbe\u5907\u200b\u56de\u5e94\u200b(\u200b\u7528\u6765\u200b\u786e\u5b9a\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u662f\u5426\u200b\u5b58\u5728\u200b)\uff0c\u200b\u7136\u540e\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u4f20\u8f93\u6570\u636e\u200b</li> <li>\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u53d1\u9001\u200b\u4e00\u4e2a\u200b\u5b57\u8282\u200b\u6570\u636e\u200b\u7ed9\u200b\u4ece\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5e76\u200b\u7b49\u5f85\u200b\u56de\u5e94\u200b</li> <li>\u200b\u6bcf\u200b\u4f20\u8f93\u200b\u4e00\u200b\u5b57\u8282\u200b\u6570\u636e\u200b\uff0c\u200b\u63a5\u6536\u200b\u65b9\u8981\u200b\u6709\u200b\u4e00\u4e2a\u200b\u56de\u5e94\u200b\u4fe1\u53f7\u200b\uff08\u200b\u786e\u5b9a\u200b\u6570\u636e\u200b\u662f\u5426\u200b\u63a5\u53d7\u200b\u5b8c\u6210\u200b)\uff0c\u200b\u7136\u540e\u200b\u518d\u200b\u4f20\u8f93\u200b\u4e0b\u200b\u4e00\u4e2a\u200b\u6570\u636e\u200b\u3002</li> <li>\u200b\u6570\u636e\u200b\u53d1\u9001\u200b\u5b8c\u200b\u4e4b\u540e\u200b\uff0c\u200b\u4e3b\u200b\u82af\u7247\u200b\u5c31\u200b\u4f1a\u200b\u53d1\u9001\u200b\u4e00\u4e2a\u200b\u505c\u6b62\u200b\u4fe1\u53f7\u200b\u3002</li> </ul> <p>\u200b\u4e0b\u56fe\u200b\uff1a\u200b\u767d\u8272\u200b\u80cc\u666f\u200b\u8868\u793a\u200b\"\u200b\u4e3b\u200b\u2192\u200b\u4ece\u200b\"\uff0c\u200b\u7070\u8272\u200b\u80cc\u666f\u200b\u8868\u793a\u200b\"\u200b\u4ece\u200b\u2192\u200b\u4e3b\u200b\"</p> <p></p>"},{"location":"04_I2C/02_1/#32","title":"3.2 \u200b\u8bfb\u200b\u64cd\u4f5c","text":"<p>\u200b\u6d41\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u4e3b\u200b\u82af\u7247\u200b\u8981\u200b\u53d1\u51fa\u200b\u4e00\u4e2a\u200bstart\u200b\u4fe1\u53f7\u200b</li> <li>\u200b\u7136\u540e\u200b\u53d1\u51fa\u200b\u4e00\u4e2a\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b(\u200b\u7528\u6765\u200b\u786e\u5b9a\u200b\u662f\u200b\u5f80\u200b\u54ea\u200b\u4e00\u4e2a\u200b\u82af\u7247\u200b\u5199\u200b\u6570\u636e\u200b)\uff0c\u200b\u65b9\u5411\u200b(\u200b\u8bfb\u200b/\u200b\u5199\u200b\uff0c0\u200b\u8868\u793a\u200b\u5199\u200b\uff0c1\u200b\u8868\u793a\u200b\u8bfb\u200b)</li> <li> <p>\u200b\u4ece\u200b\u8bbe\u5907\u200b\u56de\u5e94\u200b(\u200b\u7528\u6765\u200b\u786e\u5b9a\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u662f\u5426\u200b\u5b58\u5728\u200b)\uff0c\u200b\u7136\u540e\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u4f20\u8f93\u6570\u636e\u200b</p> </li> <li> <p>\u200b\u4ece\u200b\u8bbe\u5907\u200b\u53d1\u9001\u200b\u4e00\u4e2a\u200b\u5b57\u8282\u200b\u6570\u636e\u200b\u7ed9\u200b\u4e3b\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5e76\u200b\u7b49\u5f85\u200b\u56de\u5e94\u200b</p> </li> <li>\u200b\u6bcf\u200b\u4f20\u8f93\u200b\u4e00\u200b\u5b57\u8282\u200b\u6570\u636e\u200b\uff0c\u200b\u63a5\u6536\u200b\u65b9\u8981\u200b\u6709\u200b\u4e00\u4e2a\u200b\u56de\u5e94\u200b\u4fe1\u53f7\u200b\uff08\u200b\u786e\u5b9a\u200b\u6570\u636e\u200b\u662f\u5426\u200b\u63a5\u53d7\u200b\u5b8c\u6210\u200b)\uff0c\u200b\u7136\u540e\u200b\u518d\u200b\u4f20\u8f93\u200b\u4e0b\u200b\u4e00\u4e2a\u200b\u6570\u636e\u200b\u3002</li> <li>\u200b\u6570\u636e\u200b\u53d1\u9001\u200b\u5b8c\u200b\u4e4b\u540e\u200b\uff0c\u200b\u4e3b\u200b\u82af\u7247\u200b\u5c31\u200b\u4f1a\u200b\u53d1\u9001\u200b\u4e00\u4e2a\u200b\u505c\u6b62\u200b\u4fe1\u53f7\u200b\u3002</li> </ul> <p>\u200b\u4e0b\u56fe\u200b\uff1a\u200b\u767d\u8272\u200b\u80cc\u666f\u200b\u8868\u793a\u200b\"\u200b\u4e3b\u200b\u2192\u200b\u4ece\u200b\"\uff0c\u200b\u7070\u8272\u200b\u80cc\u666f\u200b\u8868\u793a\u200b\"\u200b\u4ece\u200b\u2192\u200b\u4e3b\u200b\"</p> <p></p>"},{"location":"04_I2C/02_1/#33-i2c","title":"3.3 I2C\u200b\u4fe1\u53f7","text":"<p>I2C\u200b\u534f\u8bae\u200b\u4e2d\u200b\u6570\u636e\u4f20\u8f93\u200b\u7684\u200b\u5355\u4f4d\u200b\u662f\u200b\u5b57\u8282\u200b\uff0c\u200b\u4e5f\u200b\u5c31\u662f\u200b8\u200b\u4f4d\u200b\u3002\u200b\u4f46\u662f\u200b\u8981\u200b\u7528\u5230\u200b9\u200b\u4e2a\u200b\u65f6\u949f\u200b\uff1a\u200b\u524d\u9762\u200b8\u200b\u4e2a\u200b\u65f6\u949f\u200b\u7528\u6765\u200b\u4f20\u8f93\u200b8\u200b\u6570\u636e\u200b\uff0c\u200b\u7b2c\u200b9\u200b\u4e2a\u200b\u65f6\u949f\u200b\u7528\u6765\u200b\u4f20\u8f93\u200b\u56de\u5e94\u200b\u4fe1\u53f7\u200b\u3002\u200b\u4f20\u8f93\u200b\u65f6\u200b\uff0c\u200b\u5148\u200b\u4f20\u8f93\u200b\u6700\u9ad8\u200b\u4f4d\u200b(MSB)\u3002</p> <ul> <li>\u200b\u5f00\u59cb\u200b\u4fe1\u53f7\u200b\uff08S\uff09\uff1aSCL\u200b\u4e3a\u200b\u9ad8\u7535\u5e73\u200b\u65f6\u200b\uff0cSDA\u200b\u5c71\u200b\u9ad8\u7535\u5e73\u200b\u5411\u200b\u4f4e\u7535\u5e73\u200b\u8df3\u53d8\u200b\uff0c\u200b\u5f00\u59cb\u200b\u4f20\u9001\u6570\u636e\u200b\u3002</li> <li>\u200b\u7ed3\u675f\u200b\u4fe1\u53f7\u200b\uff08P\uff09\uff1aSCL\u200b\u4e3a\u200b\u9ad8\u7535\u5e73\u200b\u65f6\u200b\uff0cSDA\u200b\u7531\u200b\u4f4e\u7535\u5e73\u200b\u5411\u200b\u9ad8\u7535\u5e73\u200b\u8df3\u53d8\u200b\uff0c\u200b\u7ed3\u675f\u200b\u4f20\u9001\u6570\u636e\u200b\u3002</li> <li>\u200b\u54cd\u5e94\u200b\u4fe1\u53f7\u200b(ACK)\uff1a\u200b\u63a5\u6536\u5668\u200b\u5728\u200b\u63a5\u6536\u200b\u5230\u200b8\u200b\u4f4d\u200b\u6570\u636e\u200b\u540e\u200b\uff0c\u200b\u5728\u200b\u7b2c\u200b9\u200b\u4e2a\u200b\u65f6\u949f\u200b\u5468\u671f\u200b\uff0c\u200b\u62c9\u4f4e\u200bSDA</li> <li>SDA\u200b\u4e0a\u200b\u4f20\u8f93\u200b\u7684\u200b\u6570\u636e\u200b\u5fc5\u987b\u200b\u5728\u200bSCL\u200b\u4e3a\u200b\u9ad8\u7535\u5e73\u200b\u671f\u95f4\u200b\u4fdd\u6301\u7a33\u5b9a\u200b\uff0cSDA\u200b\u4e0a\u200b\u7684\u200b\u6570\u636e\u200b\u53ea\u80fd\u200b\u5728\u200bSCL\u200b\u4e3a\u200b\u4f4e\u7535\u5e73\u200b\u671f\u95f4\u200b\u53d8\u5316\u200b</li> </ul> <p>I2C\u200b\u534f\u8bae\u200b\u4fe1\u53f7\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"04_I2C/02_1/#34","title":"3.4 \u200b\u534f\u8bae\u200b\u7ec6\u8282","text":"<ul> <li> <p>\u200b\u5982\u4f55\u200b\u5728\u200bSDA\u200b\u4e0a\u200b\u5b9e\u73b0\u200b\u53cc\u5411\u200b\u4f20\u8f93\u200b\uff1f   \u200b\u4e3b\u200b\u82af\u7247\u200b\u901a\u8fc7\u200b\u4e00\u6839\u200bSDA\u200b\u7ebf\u200b\u65e2\u200b\u53ef\u4ee5\u200b\u628a\u200b\u6570\u636e\u200b\u53d1\u7ed9\u200b\u4ece\u200b\u8bbe\u5907\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u4ece\u200bSDA\u200b\u4e0a\u200b\u8bfb\u53d6\u6570\u636e\u200b\uff0c\u200b\u8fde\u63a5\u200bSDA\u200b\u7ebf\u200b\u7684\u200b\u5f15\u811a\u200b\u91cc\u9762\u200b\u5fc5\u7136\u200b\u6709\u200b\u4e24\u4e2a\u200b\u5f15\u811a\u200b\uff08\u200b\u53d1\u9001\u200b\u5f15\u811a\u200b/\u200b\u63a5\u53d7\u200b\u5f15\u811a\u200b\uff09\u3002</p> </li> <li> <p>\u200b\u4e3b\u200b\u3001\u200b\u4ece\u200b\u8bbe\u5907\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200bSDA\u200b\u53d1\u9001\u6570\u636e\u200b\uff0c\u200b\u80af\u5b9a\u200b\u4e0d\u80fd\u200b\u540c\u65f6\u200b\u53d1\u9001\u6570\u636e\u200b\uff0c\u200b\u600e\u4e48\u200b\u9519\u5f00\u200b\u65f6\u95f4\u200b\uff1f   \u200b\u5728\u200b9\u200b\u4e2a\u200b\u65f6\u949f\u200b\u91cc\u200b\uff0c   \u200b\u524d\u200b8\u200b\u4e2a\u200b\u65f6\u949f\u200b\u7531\u4e3b\u200b\u8bbe\u5907\u200b\u53d1\u9001\u6570\u636e\u200b\u7684\u8bdd\u200b\uff0c\u200b\u7b2c\u200b9\u200b\u4e2a\u200b\u65f6\u949f\u200b\u5c31\u200b\u7531\u200b\u4ece\u200b\u8bbe\u5907\u200b\u53d1\u9001\u6570\u636e\u200b\uff1b   \u200b\u524d\u200b8\u200b\u4e2a\u200b\u65f6\u949f\u200b\u7531\u200b\u4ece\u200b\u8bbe\u5907\u200b\u53d1\u9001\u6570\u636e\u200b\u7684\u8bdd\u200b\uff0c\u200b\u7b2c\u200b9\u200b\u4e2a\u200b\u65f6\u949f\u200b\u5c31\u200b\u7531\u4e3b\u200b\u8bbe\u5907\u200b\u53d1\u9001\u6570\u636e\u200b\u3002</p> </li> <li>\u200b\u53cc\u65b9\u200b\u8bbe\u5907\u200b\u4e2d\u200b\uff0c\u200b\u67d0\u4e2a\u200b\u8bbe\u5907\u200b\u53d1\u9001\u6570\u636e\u200b\u65f6\u200b\uff0c\u200b\u53e6\u4e00\u65b9\u200b\u600e\u6837\u624d\u80fd\u200b\u4e0d\u200b\u5f71\u54cd\u200bSDA\u200b\u4e0a\u200b\u7684\u200b\u6570\u636e\u200b\uff1f   \u200b\u8bbe\u5907\u200b\u7684\u200bSDA\u200b\u4e2d\u6709\u200b\u4e00\u4e2a\u200b\u4e09\u6781\u7ba1\u200b\uff0c\u200b\u4f7f\u7528\u200b\u5f00\u6781\u200b/\u200b\u5f00\u200b\u6f0f\u7535\u200b\u8def\u200b(\u200b\u4e09\u6781\u7ba1\u200b\u662f\u200b\u5f00\u6781\u200b\uff0cCMOS\u200b\u7ba1\u662f\u200b\u5f00\u6f0f\u200b\uff0c\u200b\u4f5c\u7528\u200b\u4e00\u6837\u200b)\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\uff1a   </li> </ul> <p>\u200b\u771f\u503c\u8868\u200b\u5982\u4e0b\u200b\uff1a </p> <p>\u200b\u4ece\u200b\u771f\u503c\u8868\u200b\u548c\u200b\u7535\u8def\u56fe\u200b\u6211\u4eec\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200b\uff1a</p> <ul> <li>\u200b\u5f53\u67d0\u200b\u4e00\u4e2a\u200b\u82af\u7247\u200b\u4e0d\u60f3\u200b\u5f71\u54cd\u200bSDA\u200b\u7ebf\u65f6\u200b\uff0c\u200b\u90a3\u200b\u5c31\u200b\u4e0d\u200b\u9a71\u52a8\u200b\u8fd9\u4e2a\u200b\u4e09\u6781\u7ba1\u200b</li> <li>\u200b\u60f3\u200b\u8ba9\u200bSDA\u200b\u8f93\u51fa\u200b\u9ad8\u7535\u5e73\u200b\uff0c\u200b\u53cc\u65b9\u200b\u90fd\u200b\u4e0d\u200b\u9a71\u52a8\u200b\u4e09\u6781\u7ba1\u200b(SDA\u200b\u901a\u8fc7\u200b\u4e0a\u62c9\u200b\u7535\u963b\u200b\u53d8\u4e3a\u200b\u9ad8\u7535\u5e73\u200b)</li> <li>\u200b\u60f3\u200b\u8ba9\u200bSDA\u200b\u8f93\u51fa\u200b\u4f4e\u7535\u5e73\u200b\uff0c\u200b\u5c31\u200b\u9a71\u52a8\u200b\u4e09\u6781\u7ba1\u200b</li> </ul> <p>\u200b\u4ece\u200b\u4e0b\u9762\u200b\u7684\u200b\u4f8b\u5b50\u200b\u53ef\u4ee5\u200b\u770b\u770b\u200b\u6570\u636e\u200b\u662f\u200b\u600e\u4e48\u200b\u4f20\u200b\u7684\u200b\uff08\u200b\u5b9e\u73b0\u200b\u53cc\u5411\u200b\u4f20\u8f93\u200b\uff09\u3002 \u200b\u4e3e\u4f8b\u200b\uff1a\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u53d1\u9001\u200b\uff088bit\uff09\u200b\u7ed9\u200b\u4ece\u200b\u8bbe\u5907\u200b</p> <ul> <li>\u200b\u524d\u200b8\u200b\u4e2a\u200bclk</li> <li>\u200b\u4ece\u200b\u8bbe\u5907\u200b\u4e0d\u8981\u200b\u5f71\u54cd\u200bSDA\uff0c\u200b\u4ece\u200b\u8bbe\u5907\u200b\u4e0d\u200b\u9a71\u52a8\u200b\u4e09\u6781\u7ba1\u200b</li> <li> <p>\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u51b3\u5b9a\u200b\u6570\u636e\u200b\uff0c\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u8981\u200b\u53d1\u9001\u200b1\u200b\u65f6\u200b\u4e0d\u200b\u9a71\u52a8\u200b\u4e09\u6781\u7ba1\u200b\uff0c\u200b\u8981\u200b\u53d1\u9001\u200b0\u200b\u65f6\u200b\u9a71\u52a8\u200b\u4e09\u6781\u7ba1\u200b</p> </li> <li> <p>\u200b\u7b2c\u200b9\u200b\u4e2a\u200bclk\uff0c\u200b\u7531\u200b\u4ece\u200b\u8bbe\u5907\u200b\u51b3\u5b9a\u200b\u6570\u636e\u200b</p> </li> <li>\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u4e0d\u200b\u9a71\u52a8\u200b\u4e09\u6781\u7ba1\u200b</li> <li>\u200b\u4ece\u200b\u8bbe\u5907\u200b\u51b3\u5b9a\u200b\u6570\u636e\u200b\uff0c\u200b\u8981\u200b\u53d1\u51fa\u200b\u56de\u5e94\u200b\u4fe1\u53f7\u200b\u7684\u8bdd\u200b\uff0c\u200b\u5c31\u200b\u9a71\u52a8\u200b\u4e09\u6781\u7ba1\u200b\u8ba9\u200bSDA\u200b\u53d8\u4e3a\u200b0</li> <li>\u200b\u4ece\u200b\u8fd9\u91cc\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200bACK\u200b\u4fe1\u53f7\u200b\u662f\u200b\u4f4e\u7535\u5e73\u200b</li> </ul> <p>\u200b\u4ece\u200b\u4e0a\u9762\u200b\u7684\u200b\u4f8b\u5b50\u200b\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200b\u600e\u6837\u200b\u5728\u200b\u4e00\u6761\u7ebf\u200b\u4e0a\u200b\u5b9e\u73b0\u200b\u53cc\u5411\u200b\u4f20\u8f93\u200b\uff0c\u200b\u8fd9\u200b\u5c31\u662f\u200bSDA\u200b\u4e0a\u8981\u200b\u4f7f\u7528\u200b\u4e0a\u62c9\u200b\u7535\u963b\u200b\u7684\u200b\u539f\u56e0\u200b\u3002</p> <p>\u200b\u4e3a\u4f55\u200bSCL\u200b\u4e5f\u200b\u8981\u200b\u4f7f\u7528\u200b\u4e0a\u62c9\u200b\u7535\u963b\u200b\uff1f \u200b\u5728\u200b\u7b2c\u200b9\u200b\u4e2a\u200b\u65f6\u949f\u200b\u4e4b\u540e\u200b\uff0c\u200b\u5982\u679c\u200b\u6709\u200b\u67d0\u200b\u4e00\u65b9\u200b\u9700\u8981\u200b\u66f4\u200b\u591a\u200b\u7684\u200b\u65f6\u95f4\u200b\u6765\u200b\u5904\u7406\u200b\u6570\u636e\u200b\uff0c\u200b\u5b83\u200b\u53ef\u4ee5\u200b\u4e00\u76f4\u200b\u9a71\u52a8\u200b\u4e09\u6781\u7ba1\u200b\u628a\u200bSCL\u200b\u62c9\u4f4e\u200b\u3002 \u200b\u5f53\u200bSCL\u200b\u4e3a\u200b\u4f4e\u7535\u5e73\u200b\u65f6\u5019\u200b\uff0c\u200b\u5927\u5bb6\u200b\u90fd\u200b\u4e0d\u200b\u5e94\u8be5\u200b\u4f7f\u7528\u200bIIC\u200b\u603b\u7ebf\u200b\uff0c\u200b\u53ea\u6709\u200b\u5f53\u200bSCL\u200b\u4ece\u200b\u4f4e\u7535\u5e73\u200b\u53d8\u4e3a\u200b\u9ad8\u7535\u5e73\u200b\u7684\u200b\u65f6\u5019\u200b\uff0cIIC\u200b\u603b\u7ebf\u200b\u624d\u80fd\u200b\u88ab\u200b\u4f7f\u7528\u200b\u3002 \u200b\u5f53\u200b\u5b83\u200b\u5c31\u7eea\u200b\u540e\u200b\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u4e0d\u518d\u200b\u9a71\u52a8\u200b\u4e09\u6781\u7ba1\u200b\uff0c\u200b\u8fd9\u200b\u662f\u200b\u4e0a\u200b\u62c9\u200b\u7535\u963b\u200b\u628a\u200bSCL\u200b\u53d8\u4e3a\u200b\u9ad8\u7535\u5e73\u200b\uff0c\u200b\u5176\u4ed6\u200b\u8bbe\u5907\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u7ee7\u7eed\u200b\u4f7f\u7528\u200bI2C\u200b\u603b\u7ebf\u200b\u4e86\u200b\u3002</p> <p>\u200b\u5bf9\u4e8e\u200bIIC\u200b\u534f\u8bae\u200b\u5b83\u200b\u53ea\u80fd\u200b\u89c4\u5b9a\u200b\u600e\u4e48\u200b\u4f20\u8f93\u6570\u636e\u200b\uff0c\u200b\u6570\u636e\u200b\u662f\u200b\u4ec0\u4e48\u200b\u542b\u4e49\u200b\u7531\u200b\u4ece\u200b\u8bbe\u5907\u200b\u51b3\u5b9a\u200b\u3002</p>"},{"location":"04_I2C/03/","title":"03_SMBus\u200b\u534f\u8bae","text":""},{"location":"04_I2C/03/#smbus","title":"SMBus\u200b\u534f\u8bae","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>Linux\u200b\u5185\u6838\u200b\u6587\u6863\u200b\uff1a<code>Documentation\\i2c\\smbus-protocol.rst</code></p> </li> <li> <p>SMBus\u200b\u534f\u8bae\u200b\uff1a</p> </li> <li> <p>http://www.smbus.org/specs/</p> </li> <li><code>SMBus_3_0_20141220.pdf</code></li> <li>I2CTools: <code>https://mirrors.edge.kernel.org/pub/software/utils/i2c-tools/</code></li> </ul>"},{"location":"04_I2C/03/#1-smbusi2c","title":"1. SMBus\u200b\u662f\u200bI2C\u200b\u534f\u8bae\u200b\u7684\u200b\u4e00\u4e2a\u200b\u5b50\u96c6","text":"<p>SMBus: System Management Bus\uff0c\u200b\u7cfb\u7edf\u7ba1\u7406\u200b\u603b\u7ebf\u200b\u3002 SMBus\u200b\u6700\u521d\u200b\u7684\u200b\u76ee\u7684\u200b\u662f\u200b\u4e3a\u200b\u667a\u80fd\u200b\u7535\u6c60\u200b\u3001\u200b\u5145\u7535\u7535\u6c60\u200b\u3001\u200b\u5176\u4ed6\u200b\u5fae\u63a7\u5236\u5668\u200b\u4e4b\u95f4\u200b\u7684\u200b\u901a\u4fe1\u200b\u94fe\u8def\u200b\u800c\u200b\u5b9a\u4e49\u200b\u7684\u200b\u3002 SMBus\u200b\u4e5f\u200b\u88ab\u200b\u7528\u6765\u200b\u8fde\u63a5\u200b\u5404\u79cd\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5305\u62ec\u200b\u7535\u6e90\u200b\u76f8\u5173\u200b\u8bbe\u5907\u200b\uff0c\u200b\u7cfb\u7edf\u200b\u4f20\u611f\u5668\u200b\uff0cEEPROM\u200b\u901a\u8baf\u8bbe\u5907\u200b\u7b49\u7b49\u200b\u3002 SMBus \u200b\u4e3a\u200b\u7cfb\u7edf\u200b\u548c\u200b\u7535\u6e90\u200b\u7ba1\u7406\u200b\u8fd9\u6837\u200b\u7684\u200b\u4efb\u52a1\u200b\u63d0\u4f9b\u200b\u4e86\u200b\u4e00\u6761\u200b\u63a7\u5236\u200b\u603b\u7ebf\u200b\uff0c\u200b\u4f7f\u7528\u200b SMBus \u200b\u7684\u200b\u7cfb\u7edf\u200b\uff0c\u200b\u8bbe\u5907\u200b\u4e4b\u95f4\u200b\u53d1\u9001\u200b\u548c\u200b\u63a5\u6536\u200b\u6d88\u606f\u200b\u90fd\u200b\u662f\u200b\u901a\u8fc7\u200b SMBus\uff0c\u200b\u800c\u200b\u4e0d\u662f\u200b\u4f7f\u7528\u200b\u5355\u72ec\u200b\u7684\u200b\u63a7\u5236\u7ebf\u200b\uff0c\u200b\u8fd9\u6837\u200b\u53ef\u4ee5\u200b\u8282\u7701\u200b\u8bbe\u5907\u200b\u7684\u200b\u7ba1\u200b\u811a\u6570\u200b\u3002 SMBus\u200b\u662f\u200b\u57fa\u4e8e\u200bI2C\u200b\u534f\u8bae\u200b\u7684\u200b\uff0cSMBus\u200b\u8981\u6c42\u200b\u66f4\u200b\u4e25\u683c\u200b\uff0cSMBus\u200b\u662f\u200bI2C\u200b\u534f\u8bae\u200b\u7684\u200b\u5b50\u96c6\u200b\u3002</p> <p></p> <p>SMBus\u200b\u6709\u200b\u54ea\u4e9b\u200b\u66f4\u200b\u4e25\u683c\u200b\u7684\u200b\u8981\u6c42\u200b\uff1f\u200b\u8ddf\u200b\u4e00\u822c\u200b\u7684\u200bI2C\u200b\u534f\u8bae\u200b\u6709\u200b\u54ea\u4e9b\u200b\u5dee\u522b\u200b\uff1f</p> <ul> <li> <p>VDD\u200b\u7684\u200b\u6781\u9650\u503c\u200b\u4e0d\u200b\u4e00\u6837\u200b</p> </li> <li> <p>I2C\u200b\u534f\u8bae\u200b\uff1a\u200b\u8303\u56f4\u200b\u5f88\u5e7f\u200b\uff0c\u200b\u751a\u81f3\u200b\u8ba8\u8bba\u200b\u4e86\u200b\u9ad8\u8fbe\u200b12V\u200b\u7684\u200b\u60c5\u51b5\u200b</p> </li> <li> <p>SMBus\uff1a1.8V~5V</p> </li> <li> <p>\u200b\u6700\u5c0f\u200b\u65f6\u949f\u200b\u9891\u7387\u200b\u3001\u200b\u6700\u5927\u200b\u7684\u200b<code>Clock Stretching</code></p> </li> <li> <p>Clock Stretching\u200b\u542b\u4e49\u200b\uff1a\u200b\u67d0\u4e2a\u200b\u8bbe\u5907\u200b\u9700\u8981\u200b\u66f4\u200b\u591a\u200b\u65f6\u95f4\u200b\u8fdb\u884c\u200b\u5185\u90e8\u200b\u7684\u200b\u5904\u7406\u200b\u65f6\u200b\uff0c\u200b\u5b83\u200b\u53ef\u4ee5\u200b\u628a\u200bSCL\u200b\u62c9\u4f4e\u200b\u5360\u200b\u4f4f\u200bI2C\u200b\u603b\u7ebf\u200b</p> </li> <li> <p>I2C\u200b\u534f\u8bae\u200b\uff1a\u200b\u65f6\u949f\u200b\u9891\u7387\u200b\u6700\u5c0f\u503c\u200b\u65e0\u200b\u9650\u5236\u200b\uff0cClock Stretching\u200b\u65f6\u957f\u200b\u4e5f\u200b\u6ca1\u6709\u200b\u9650\u5236\u200b</p> </li> <li> <p>SMBus\uff1a\u200b\u65f6\u949f\u200b\u9891\u7387\u200b\u6700\u5c0f\u503c\u200b\u662f\u200b10KHz\uff0cClock Stretching\u200b\u7684\u200b\u6700\u5927\u200b\u65f6\u95f4\u200b\u503c\u200b\u4e5f\u200b\u6709\u200b\u9650\u5236\u200b</p> </li> <li> <p>\u200b\u5730\u5740\u200b\u56de\u5e94\u200b(Address Acknowledge)</p> </li> <li> <p>\u200b\u4e00\u4e2a\u200bI2C\u200b\u8bbe\u5907\u200b\u63a5\u6536\u200b\u5230\u200b\u5b83\u200b\u7684\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\u540e\u200b\uff0c\u200b\u662f\u5426\u200b\u5fc5\u987b\u200b\u53d1\u51fa\u200b\u56de\u5e94\u200b\u4fe1\u53f7\u200b\uff1f</p> </li> <li>I2C\u200b\u534f\u8bae\u200b\uff1a\u200b\u6ca1\u6709\u200b\u5f3a\u5236\u200b\u8981\u6c42\u200b\u5fc5\u987b\u200b\u53d1\u51fa\u200b\u56de\u5e94\u200b\u4fe1\u53f7\u200b</li> <li> <p>SMBus\uff1a\u200b\u5f3a\u5236\u200b\u8981\u6c42\u200b\u5fc5\u987b\u200b\u53d1\u51fa\u200b\u56de\u5e94\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u8fd9\u6837\u200b\u5bf9\u65b9\u200b\u624d\u200b\u77e5\u9053\u200b\u8be5\u200b\u8bbe\u5907\u200b\u7684\u200b\u72b6\u6001\u200b\uff1abusy\uff0cfailed\uff0c\u200b\u6216\u662f\u200b\u88ab\u200b\u79fb\u200b\u9664\u4e86\u200b</p> </li> <li> <p>SMBus\u200b\u534f\u8bae\u200b\u660e\u786e\u200b\u4e86\u200b\u6570\u636e\u200b\u7684\u200b\u4f20\u8f93\u200b\u683c\u5f0f\u200b</p> </li> <li>I2C\u200b\u534f\u8bae\u200b\uff1a\u200b\u5b83\u200b\u53ea\u200b\u5b9a\u4e49\u200b\u4e86\u200b\u600e\u4e48\u200b\u4f20\u8f93\u6570\u636e\u200b\uff0c\u200b\u4f46\u662f\u200b\u5e76\u200b\u6ca1\u6709\u200b\u5b9a\u4e49\u6570\u636e\u200b\u7684\u200b\u683c\u5f0f\u200b\uff0c\u200b\u8fd9\u200b\u5b8c\u5168\u200b\u7531\u200b\u8bbe\u5907\u200b\u6765\u200b\u5b9a\u4e49\u200b</li> <li> <p>SMBus\uff1a\u200b\u5b9a\u4e49\u200b\u4e86\u200b\u51e0\u79cd\u200b\u6570\u636e\u683c\u5f0f\u200b(\u200b\u540e\u9762\u200b\u5206\u6790\u200b)</p> </li> <li> <p>REPEATED START Condition(\u200b\u91cd\u590d\u200b\u53d1\u51fa\u200bS\u200b\u4fe1\u53f7\u200b)</p> </li> <li>\u200b\u6bd4\u5982\u200b\u8bfb\u200bEEPROM\u200b\u65f6\u200b\uff0c\u200b\u6d89\u53ca\u200b2\u200b\u4e2a\u200b\u64cd\u4f5c\u200b\uff1a<ul> <li>\u200b\u628a\u200b\u5b58\u50a8\u200b\u5730\u5740\u200b\u53d1\u7ed9\u200b\u8bbe\u5907\u200b</li> <li>\u200b\u8bfb\u6570\u636e\u200b</li> </ul> </li> <li>\u200b\u5728\u200b\u5199\u200b\u3001\u200b\u8bfb\u200b\u4e4b\u95f4\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u4e0d\u200b\u53d1\u51fa\u200bP\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u53d1\u51fa\u200bS\u200b\u4fe1\u53f7\u200b\uff1a\u200b\u8fd9\u4e2a\u200bS\u200b\u4fe1\u53f7\u200b\u5c31\u662f\u200b<code>REPEATED START</code></li> <li>\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b     </li> <li>SMBus Low Power Version </li> <li>SMBus\u200b\u4e5f\u200b\u6709\u200b\u4f4e\u529f\u8017\u200b\u7684\u200b\u7248\u672c\u200b</li> </ul>"},{"location":"04_I2C/03/#2-smbus","title":"2. SMBus\u200b\u534f\u8bae\u200b\u5206\u6790","text":"<p>\u200b\u5bf9\u4e8e\u200bI2C\u200b\u534f\u8bae\u200b\uff0c\u200b\u5b83\u200b\u53ea\u200b\u5b9a\u4e49\u200b\u4e86\u200b\u600e\u4e48\u200b\u4f20\u8f93\u6570\u636e\u200b\uff0c\u200b\u4f46\u662f\u200b\u5e76\u200b\u6ca1\u6709\u200b\u5b9a\u4e49\u6570\u636e\u200b\u7684\u200b\u683c\u5f0f\u200b\uff0c\u200b\u8fd9\u200b\u5b8c\u5168\u200b\u7531\u200b\u8bbe\u5907\u200b\u6765\u200b\u5b9a\u4e49\u200b\u3002 \u200b\u5bf9\u4e8e\u200bSMBus\u200b\u534f\u8bae\u200b\uff0c\u200b\u5b83\u200b\u5b9a\u4e49\u200b\u4e86\u200b\u51e0\u79cd\u200b\u6570\u636e\u683c\u5f0f\u200b\u3002</p> <p>\u200b\u6ce8\u610f\u200b\uff1a</p> <ul> <li>\u200b\u4e0b\u9762\u200b\u6587\u6863\u200b\u4e2d\u200b\u7684\u200b<code>Functionality flag</code>\u200b\u662f\u200bLinux\u200b\u7684\u200b\u67d0\u4e2a\u200bI2C\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u6240\u200b\u652f\u6301\u200b\u7684\u200b\u529f\u80fd\u200b\u3002</li> <li>\u200b\u6bd4\u5982\u200b<code>Functionality flag: I2C_FUNC_SMBUS_QUICK</code>\uff0c\u200b\u8868\u793a\u200b\u9700\u8981\u200bI2C\u200b\u63a7\u5236\u5668\u200b\u652f\u6301\u200b<code>SMBus Quick Command</code></li> </ul>"},{"location":"04_I2C/03/#21-symbols","title":"2.1 symbols(\u200b\u7b26\u53f7\u200b)","text":"<pre><code>S     (1 bit) : Start bit(\u200b\u5f00\u59cb\u200b\u4f4d\u200b)\nSr    (1 bit) : \u200b\u91cd\u590d\u200b\u7684\u200b\u5f00\u59cb\u200b\u4f4d\u200b\nP     (1 bit) : Stop bit(\u200b\u505c\u6b62\u200b\u4f4d\u200b)\nR/W#  (1 bit) : Read/Write bit. Rd equals 1, Wr equals 0.(\u200b\u8bfb\u5199\u200b\u4f4d\u200b)\nA, N  (1 bit) : Accept and reverse accept bit.(\u200b\u56de\u5e94\u200b\u4f4d\u200b)\nAddress(7 bits): I2C 7 bit address. Note that this can be expanded as usual to\n                get a 10 bit I2C address.\n                (\u200b\u5730\u5740\u200b\u4f4d\u200b\uff0c7\u200b\u4f4d\u200b\u5730\u5740\u200b)\nCommand Code  (8 bits): Command byte, a data byte which often selects a register on\n                the device.\n                (\u200b\u547d\u4ee4\u200b\u5b57\u8282\u200b\uff0c\u200b\u4e00\u822c\u200b\u7528\u6765\u200b\u9009\u62e9\u200b\u82af\u7247\u200b\u5185\u90e8\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b)\nData Byte (8 bits): A plain data byte. Sometimes, I write DataLow, DataHigh\n                for 16 bit data.\n                (\u200b\u6570\u636e\u200b\u5b57\u8282\u200b\uff0c8\u200b\u4f4d\u200b\uff1b\u200b\u5982\u679c\u200b\u662f\u200b16\u200b\u4f4d\u200b\u6570\u636e\u200b\u7684\u8bdd\u200b\uff0c\u200b\u7528\u200b2\u200b\u4e2a\u200b\u5b57\u8282\u200b\u6765\u200b\u8868\u793a\u200b\uff1aDataLow\u3001DataHigh)\nCount (8 bits): A data byte containing the length of a block operation.\n                (\u200b\u5728\u200bblock\u200b\u64cd\u4f5c\u200b\u603b\u200b\uff0c\u200b\u8868\u793a\u200b\u6570\u636e\u200b\u957f\u5ea6\u200b)\n[..]:           Data sent by I2C device, as opposed to data sent by the host\n                adapter.\n                (\u200b\u4e2d\u62ec\u53f7\u200b\u8868\u793a\u200bI2C\u200b\u8bbe\u5907\u200b\u53d1\u9001\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u6ca1\u6709\u200b\u4e2d\u62ec\u53f7\u200b\u8868\u793a\u200bhost adapter\u200b\u53d1\u9001\u200b\u7684\u200b\u6570\u636e\u200b)\n</code></pre>"},{"location":"04_I2C/03/#22-smbus-quick-command","title":"2.2 SMBus Quick Command","text":"<p>\u200b\u53ea\u662f\u200b\u7528\u6765\u200b\u53d1\u9001\u200b\u4e00\u4f4d\u200b\u6570\u636e\u200b\uff1aR/W#\u200b\u672c\u610f\u200b\u662f\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u8bfb\u200b\u6216\u200b\u5199\u200b\uff0c\u200b\u4f46\u662f\u200b\u5728\u200bSMBus\u200b\u91cc\u200b\u53ef\u4ee5\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u5176\u4ed6\u200b\u542b\u4e49\u200b\u3002 \u200b\u6bd4\u5982\u200b\u67d0\u4e9b\u200b\u5f00\u5173\u8bbe\u5907\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u6839\u636e\u200b\u8fd9\u200b\u4e00\u4f4d\u200b\u6765\u200b\u51b3\u5b9a\u200b\u662f\u200b\u6253\u5f00\u200b\u8fd8\u662f\u200b\u5173\u95ed\u200b\u3002</p> <pre><code>Functionality flag: I2C_FUNC_SMBUS_QUICK\n</code></pre>"},{"location":"04_I2C/03/#23-smbus-receive-byte","title":"2.3 SMBus Receive Byte","text":"<p>I2C-tools\u200b\u4e2d\u200b\u7684\u200b\u51fd\u6570\u200b\uff1ai2c_smbus_read_byte()\u3002 \u200b\u8bfb\u53d6\u200b\u4e00\u4e2a\u200b\u5b57\u8282\u200b\uff0cHost adapter\u200b\u63a5\u6536\u200b\u5230\u200b\u4e00\u4e2a\u200b\u5b57\u8282\u200b\u540e\u200b\u4e0d\u200b\u9700\u8981\u200b\u53d1\u51fa\u200b\u56de\u5e94\u200b\u4fe1\u53f7\u200b(\u200b\u4e0a\u56fe\u200b\u4e2d\u200bN\u200b\u8868\u793a\u200b\u4e0d\u200b\u56de\u5e94\u200b)\u3002</p> <pre><code>Functionality flag: I2C_FUNC_SMBUS_READ_BYTE\n</code></pre>"},{"location":"04_I2C/03/#24-smbus-send-byte","title":"2.4 SMBus Send Byte","text":"<p>I2C-tools\u200b\u4e2d\u200b\u7684\u200b\u51fd\u6570\u200b\uff1ai2c_smbus_write_byte()\u3002 \u200b\u53d1\u9001\u200b\u4e00\u4e2a\u200b\u5b57\u8282\u200b\u3002</p> <pre><code>Functionality flag: I2C_FUNC_SMBUS_WRITE_BYTE\n</code></pre>"},{"location":"04_I2C/03/#25-smbus-read-byte","title":"2.5 SMBus Read Byte","text":"<p>I2C-tools\u200b\u4e2d\u200b\u7684\u200b\u51fd\u6570\u200b\uff1ai2c_smbus_read_byte_data()\u3002</p> <p>\u200b\u5148\u200b\u53d1\u51fa\u200b<code>Command Code</code>(\u200b\u5b83\u200b\u4e00\u822c\u200b\u8868\u793a\u200b\u82af\u7247\u200b\u5185\u90e8\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u5730\u5740\u200b)\uff0c\u200b\u518d\u200b\u8bfb\u53d6\u200b\u4e00\u4e2a\u200b\u5b57\u8282\u200b\u7684\u200b\u6570\u636e\u200b\u3002 \u200b\u4e0a\u9762\u200b\u4ecb\u7ecd\u200b\u7684\u200b<code>SMBus Receive Byte</code>\u200b\u662f\u200b\u4e0d\u200b\u53d1\u9001\u200bComand\uff0c\u200b\u76f4\u63a5\u200b\u8bfb\u53d6\u6570\u636e\u200b\u3002</p> <pre><code>Functionality flag: I2C_FUNC_SMBUS_READ_BYTE_DATA\n</code></pre>"},{"location":"04_I2C/03/#26-smbus-read-word","title":"2.6 SMBus Read Word","text":"<p>I2C-tools\u200b\u4e2d\u200b\u7684\u200b\u51fd\u6570\u200b\uff1ai2c_smbus_read_word_data()\u3002</p> <p>\u200b\u5148\u200b\u53d1\u51fa\u200b<code>Command Code</code>(\u200b\u5b83\u200b\u4e00\u822c\u200b\u8868\u793a\u200b\u82af\u7247\u200b\u5185\u90e8\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u5730\u5740\u200b)\uff0c\u200b\u518d\u200b\u8bfb\u53d6\u200b2\u200b\u4e2a\u200b\u5b57\u8282\u200b\u7684\u200b\u6570\u636e\u200b\u3002</p> <pre><code>Functionality flag: I2C_FUNC_SMBUS_READ_WORD_DATA\n</code></pre>"},{"location":"04_I2C/03/#27-smbus-write-byte","title":"2.7 SMBus Write Byte","text":"<p>I2C-tools\u200b\u4e2d\u200b\u7684\u200b\u51fd\u6570\u200b\uff1ai2c_smbus_write_byte_data()\u3002</p> <p>\u200b\u5148\u200b\u53d1\u51fa\u200b<code>Command Code</code>(\u200b\u5b83\u200b\u4e00\u822c\u200b\u8868\u793a\u200b\u82af\u7247\u200b\u5185\u90e8\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u5730\u5740\u200b)\uff0c\u200b\u518d\u200b\u53d1\u51fa\u200b1\u200b\u4e2a\u200b\u5b57\u8282\u200b\u7684\u200b\u6570\u636e\u200b\u3002</p> <pre><code>Functionality flag: I2C_FUNC_SMBUS_WRITE_BYTE_DATA\n</code></pre>"},{"location":"04_I2C/03/#28-smbus-write-word","title":"2.8 SMBus Write Word","text":"<p>I2C-tools\u200b\u4e2d\u200b\u7684\u200b\u51fd\u6570\u200b\uff1ai2c_smbus_write_word_data()\u3002</p> <p>\u200b\u5148\u200b\u53d1\u51fa\u200b<code>Command Code</code>(\u200b\u5b83\u200b\u4e00\u822c\u200b\u8868\u793a\u200b\u82af\u7247\u200b\u5185\u90e8\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u5730\u5740\u200b)\uff0c\u200b\u518d\u200b\u53d1\u51fa\u200b1\u200b\u4e2a\u200b\u5b57\u8282\u200b\u7684\u200b\u6570\u636e\u200b\u3002</p> <pre><code>Functionality flag: I2C_FUNC_SMBUS_WRITE_WORD_DATA\n</code></pre>"},{"location":"04_I2C/03/#29-smbus-block-read","title":"2.9 SMBus Block Read","text":"<p>I2C-tools\u200b\u4e2d\u200b\u7684\u200b\u51fd\u6570\u200b\uff1ai2c_smbus_read_block_data()\u3002</p> <p>\u200b\u5148\u200b\u53d1\u51fa\u200b<code>Command Code</code>(\u200b\u5b83\u200b\u4e00\u822c\u200b\u8868\u793a\u200b\u82af\u7247\u200b\u5185\u90e8\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u5730\u5740\u200b)\uff0c\u200b\u518d\u200b\u53d1\u8d77\u200b\u5ea6\u200b\u64cd\u4f5c\u200b\uff1a</p> <ul> <li>\u200b\u5148\u8bfb\u200b\u5230\u200b\u4e00\u4e2a\u200b\u5b57\u8282\u200b(Block Count)\uff0c\u200b\u8868\u793a\u200b\u540e\u7eed\u200b\u8981\u8bfb\u200b\u7684\u200b\u5b57\u8282\u6570\u200b</li> <li>\u200b\u7136\u540e\u200b\u8bfb\u53d6\u200b\u5168\u90e8\u200b\u6570\u636e\u200b</li> </ul> <pre><code>Functionality flag: I2C_FUNC_SMBUS_READ_BLOCK_DATA\n</code></pre>"},{"location":"04_I2C/03/#210-smbus-block-write","title":"2.10 SMBus Block Write","text":"<p>I2C-tools\u200b\u4e2d\u200b\u7684\u200b\u51fd\u6570\u200b\uff1ai2c_smbus_write_block_data()\u3002</p> <p>\u200b\u5148\u200b\u53d1\u51fa\u200b<code>Command Code</code>(\u200b\u5b83\u200b\u4e00\u822c\u200b\u8868\u793a\u200b\u82af\u7247\u200b\u5185\u90e8\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u5730\u5740\u200b)\uff0c\u200b\u518d\u200b\u53d1\u51fa\u200b1\u200b\u4e2a\u200b\u5b57\u8282\u200b\u7684\u200b<code>Byte Conut</code>(\u200b\u8868\u793a\u200b\u540e\u7eed\u200b\u8981\u200b\u53d1\u51fa\u200b\u7684\u200b\u6570\u636e\u200b\u5b57\u8282\u6570\u200b)\uff0c\u200b\u6700\u540e\u200b\u53d1\u51fa\u200b\u5168\u90e8\u200b\u6570\u636e\u200b\u3002</p> <pre><code>Functionality flag: I2C_FUNC_SMBUS_WRITE_BLOCK_DATA\n</code></pre>"},{"location":"04_I2C/03/#211-i2c-block-read","title":"2.11 I2C Block Read","text":"<p>\u200b\u5728\u200b\u4e00\u822c\u200b\u7684\u200bI2C\u200b\u534f\u8bae\u200b\u4e2d\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u8fde\u7eed\u200b\u8bfb\u51fa\u200b\u591a\u4e2a\u200b\u5b57\u8282\u200b\u3002 \u200b\u5b83\u200b\u8ddf\u200b<code>SMBus Block Read</code>\u200b\u7684\u200b\u5dee\u522b\u200b\u5728\u4e8e\u200b\u8bbe\u5907\u200b\u53d1\u51fa\u200b\u7684\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u6570\u636e\u200b\u4e0d\u662f\u200b\u957f\u5ea6\u200bN\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b\uff1a</p> <p></p> <p>I2C-tools\u200b\u4e2d\u200b\u7684\u200b\u51fd\u6570\u200b\uff1ai2c_smbus_read_i2c_block_data()\u3002</p> <p>\u200b\u5148\u200b\u53d1\u51fa\u200b<code>Command Code</code>(\u200b\u5b83\u200b\u4e00\u822c\u200b\u8868\u793a\u200b\u82af\u7247\u200b\u5185\u90e8\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u5730\u5740\u200b)\uff0c\u200b\u518d\u200b\u53d1\u51fa\u200b1\u200b\u4e2a\u200b\u5b57\u8282\u200b\u7684\u200b<code>Byte Conut</code>(\u200b\u8868\u793a\u200b\u540e\u7eed\u200b\u8981\u200b\u53d1\u51fa\u200b\u7684\u200b\u6570\u636e\u200b\u5b57\u8282\u6570\u200b)\uff0c\u200b\u6700\u540e\u200b\u53d1\u51fa\u200b\u5168\u90e8\u200b\u6570\u636e\u200b\u3002</p> <pre><code>Functionality flag: I2C_FUNC_SMBUS_READ_I2C_BLOCK\n</code></pre>"},{"location":"04_I2C/03/#212-i2c-block-write","title":"2.12 I2C Block Write","text":"<p>\u200b\u5728\u200b\u4e00\u822c\u200b\u7684\u200bI2C\u200b\u534f\u8bae\u200b\u4e2d\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u8fde\u7eed\u200b\u53d1\u51fa\u200b\u591a\u4e2a\u200b\u5b57\u8282\u200b\u3002 \u200b\u5b83\u200b\u8ddf\u200b<code>SMBus Block Write</code>\u200b\u7684\u200b\u5dee\u522b\u200b\u5728\u4e8e\u200b\u53d1\u51fa\u200b\u7684\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u6570\u636e\u200b\u4e0d\u662f\u200b\u957f\u5ea6\u200bN\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b\uff1a</p> <p></p> <p>I2C-tools\u200b\u4e2d\u200b\u7684\u200b\u51fd\u6570\u200b\uff1ai2c_smbus_write_i2c_block_data()\u3002</p> <p>\u200b\u5148\u200b\u53d1\u51fa\u200b<code>Command Code</code>(\u200b\u5b83\u200b\u4e00\u822c\u200b\u8868\u793a\u200b\u82af\u7247\u200b\u5185\u90e8\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u5730\u5740\u200b)\uff0c\u200b\u518d\u200b\u53d1\u51fa\u200b1\u200b\u4e2a\u200b\u5b57\u8282\u200b\u7684\u200b<code>Byte Conut</code>(\u200b\u8868\u793a\u200b\u540e\u7eed\u200b\u8981\u200b\u53d1\u51fa\u200b\u7684\u200b\u6570\u636e\u200b\u5b57\u8282\u6570\u200b)\uff0c\u200b\u6700\u540e\u200b\u53d1\u51fa\u200b\u5168\u90e8\u200b\u6570\u636e\u200b\u3002</p> <pre><code>Functionality flag: I2C_FUNC_SMBUS_WRITE_I2C_BLOCK\n</code></pre>"},{"location":"04_I2C/03/#213-smbus-block-write-block-read-process-call","title":"2.13 SMBus Block Write - Block Read Process Call","text":"<p>\u200b\u5148\u5199\u200b\u4e00\u5757\u200b\u6570\u636e\u200b\uff0c\u200b\u518d\u200b\u8bfb\u200b\u4e00\u5757\u200b\u6570\u636e\u200b\u3002</p> <pre><code>Functionality flag: I2C_FUNC_SMBUS_BLOCK_PROC_CALL\n</code></pre>"},{"location":"04_I2C/03/#214-packet-error-checking-pec","title":"2.14 Packet Error Checking (PEC)","text":"<p>PEC\u200b\u662f\u200b\u4e00\u79cd\u200b\u9519\u8bef\u200b\u6821\u9a8c\u7801\u200b\uff0c\u200b\u5982\u679c\u200b\u4f7f\u7528\u200bPEC\uff0c\u200b\u90a3\u4e48\u200b\u5728\u200bP\u200b\u4fe1\u53f7\u200b\u4e4b\u524d\u200b\uff0c\u200b\u6570\u636e\u200b\u53d1\u9001\u200b\u65b9\u8981\u200b\u53d1\u9001\u200b\u4e00\u4e2a\u200b\u5b57\u8282\u200b\u7684\u200bPEC\u200b\u7801\u200b(\u200b\u5b83\u200b\u662f\u200bCRC-8\u200b\u7801\u200b)\u3002</p> <p>\u200b\u4ee5\u200b<code>SMBus Send Byte</code>\u200b\u4e3a\u4f8b\u200b\uff0c\u200b\u4e0b\u56fe\u200b\u4e2d\u200b\uff0c\u200b\u4e00\u4e2a\u200b\u672a\u200b\u4f7f\u7528\u200bPEC\uff0c\u200b\u53e6\u200b\u4e00\u4e2a\u200b\u4f7f\u7528\u200bPEC\uff1a</p> <p></p>"},{"location":"04_I2C/03/#3-smbusi2c","title":"3. SMBus\u200b\u548c\u200bI2C\u200b\u7684\u200b\u5efa\u8bae","text":"<p>\u200b\u56e0\u4e3a\u200b\u5f88\u591a\u200b\u8bbe\u5907\u200b\u90fd\u200b\u5b9e\u73b0\u200b\u4e86\u200bSMBus\uff0c\u200b\u800c\u200b\u4e0d\u662f\u200b\u66f4\u200b\u5bbd\u6cdb\u200b\u7684\u200bI2C\u200b\u534f\u8bae\u200b\uff0c\u200b\u6240\u4ee5\u200b\u4f18\u5148\u200b\u4f7f\u7528\u200bSMBus\u3002 \u200b\u5373\u4f7f\u200bI2C\u200b\u63a7\u5236\u5668\u200b\u6ca1\u6709\u200b\u5b9e\u73b0\u200bSMBus\uff0c\u200b\u8f6f\u4ef6\u200b\u65b9\u9762\u200b\u4e5f\u200b\u662f\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200bI2C\u200b\u534f\u8bae\u200b\u6765\u200b\u6a21\u62df\u200bSMBus\u3002 \u200b\u6240\u4ee5\u200b\uff1aLinux\u200b\u5efa\u8bae\u200b\u4f18\u5148\u200b\u4f7f\u7528\u200bSMBus\u3002</p>"},{"location":"04_I2C/04/","title":"04_I2C\u200b\u7cfb\u7edf\u200b\u7684\u200b\u91cd\u8981\u200b\u7ed3\u6784\u200b\u4f53","text":""},{"location":"04_I2C/04/#i2c","title":"I2C\u200b\u7cfb\u7edf\u200b\u7684\u200b\u91cd\u8981\u200b\u7ed3\u6784\u200b\u4f53","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b: <code>drivers/i2c/i2c-dev.c</code></li> <li>I2CTools: <code>https://mirrors.edge.kernel.org/pub/software/utils/i2c-tools/</code></li> </ul>"},{"location":"04_I2C/04/#1-i2c","title":"1. I2C\u200b\u786c\u4ef6\u200b\u6846\u67b6","text":""},{"location":"04_I2C/04/#2-i2c","title":"2. I2C\u200b\u4f20\u8f93\u200b\u534f\u8bae","text":"<ul> <li>\u200b\u5199\u200b\u64cd\u4f5c\u200b</li> </ul> <ul> <li>\u200b\u8bfb\u200b\u64cd\u4f5c\u200b</li> </ul>"},{"location":"04_I2C/04/#3-linux","title":"3. Linux\u200b\u8f6f\u4ef6\u200b\u6846\u67b6","text":""},{"location":"04_I2C/04/#4","title":"4. \u200b\u91cd\u8981\u200b\u7ed3\u6784\u200b\u4f53","text":"<p>\u200b\u4f7f\u7528\u200b\u4e00\u53e5\u200b\u8bdd\u200b\u6982\u62ec\u200bI2C\u200b\u4f20\u8f93\u200b\uff1aAPP\u200b\u901a\u8fc7\u200bI2C Controller\u200b\u4e0e\u200bI2C Device\u200b\u4f20\u8f93\u6570\u636e\u200b\u3002</p> <p>\u200b\u5728\u200bLinux\u200b\u4e2d\u200b\uff1a</p> <ul> <li> <p>\u200b\u600e\u4e48\u200b\u8868\u793a\u200bI2C Controller</p> </li> <li> <p>\u200b\u4e00\u4e2a\u200b\u82af\u7247\u200b\u91cc\u200b\u53ef\u80fd\u200b\u6709\u200b\u591a\u4e2a\u200bI2C Controller\uff0c\u200b\u6bd4\u5982\u200b\u7b2c\u200b0\u200b\u4e2a\u200b\u3001\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u3001\u2026\u2026</p> </li> <li> <p>\u200b\u5bf9\u4e8e\u200b\u4f7f\u7528\u8005\u200b\uff0c\u200b\u53ea\u8981\u200b\u786e\u5b9a\u200b\u662f\u200b\u7b2c\u51e0\u4e2a\u200bI2C Controller\u200b\u5373\u53ef\u200b</p> </li> <li> <p>\u200b\u4f7f\u7528\u200bi2c_adapter\u200b\u8868\u793a\u200b\u4e00\u4e2a\u200bI2C BUS\uff0c\u200b\u6216\u200b\u79f0\u4e3a\u200bI2C Controller</p> </li> <li> <p>\u200b\u91cc\u9762\u200b\u6709\u200b2\u200b\u4e2a\u200b\u91cd\u8981\u200b\u7684\u200b\u6210\u5458\u200b\uff1a</p> <ul> <li> <p>nr\uff1a\u200b\u7b2c\u51e0\u4e2a\u200bI2C BUS(I2C Controller)</p> </li> <li> <p>i2c_algorithm\uff0c\u200b\u91cc\u9762\u200b\u6709\u200b\u8be5\u200bI2C BUS\u200b\u7684\u200b\u4f20\u8f93\u200b\u51fd\u6570\u200b\uff0c\u200b\u7528\u6765\u200b\u6536\u53d1\u200bI2C\u200b\u6570\u636e\u200b</p> </li> </ul> </li> <li> <p>i2c_adapter</p> </li> </ul> <p></p> <ul> <li> <p>i2c_algorithm     </p> </li> <li> <p>\u200b\u600e\u4e48\u200b\u8868\u793a\u200bI2C Device</p> </li> <li> <p>\u200b\u4e00\u4e2a\u200bI2C Device\uff0c\u200b\u4e00\u5b9a\u200b\u6709\u200b**\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b**</p> </li> <li>\u200b\u5b83\u200b\u8fde\u63a5\u200b\u5728\u200b\u54ea\u4e2a\u200bI2C Controller\u200b\u4e0a\u200b\uff0c\u200b\u5373\u200b\u5bf9\u5e94\u200b\u7684\u200bi2c_adapter\u200b\u662f\u200b\u4ec0\u4e48\u200b</li> <li> <p>\u200b\u4f7f\u7528\u200bi2c_client\u200b\u6765\u200b\u8868\u793a\u200b\u4e00\u4e2a\u200bI2C Device     </p> </li> <li> <p>\u200b\u600e\u4e48\u200b\u8868\u793a\u200b\u8981\u200b\u4f20\u8f93\u200b\u7684\u200b\u6570\u636e\u200b</p> </li> <li> <p>\u200b\u5728\u200b\u4e0a\u9762\u200b\u7684\u200bi2c_algorithm\u200b\u7ed3\u6784\u200b\u4f53\u4e2d\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200b\u8981\u200b\u4f20\u8f93\u200b\u7684\u200b\u6570\u636e\u200b\u88ab\u200b\u79f0\u4e3a\u200b\uff1ai2c_msg</p> </li> <li> <p>i2c_msg     </p> </li> <li> <p>i2c_msg\u200b\u4e2d\u200b\u7684\u200bflags\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u4f20\u8f93\u200b\u65b9\u5411\u200b\uff1abit 0\u200b\u7b49\u4e8e\u200bI2C_M_RD\u200b\u8868\u793a\u200b\u8bfb\u200b\uff0cbit 0\u200b\u7b49\u4e8e\u200b0\u200b\u8868\u793a\u200b\u5199\u200b</p> </li> <li> <p>\u200b\u4e00\u4e2a\u200bi2c_msg\u200b\u8981\u4e48\u200b\u662f\u200b\u8bfb\u200b\uff0c\u200b\u8981\u4e48\u200b\u662f\u200b\u5199\u200b</p> </li> <li> <p>\u200b\u4e3e\u4f8b\u200b\uff1a\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\u4e3a\u200b0x50\u200b\u7684\u200bEEPROM\uff0c\u200b\u8981\u200b\u8bfb\u53d6\u200b\u5b83\u200b\u91cc\u9762\u200b\u5b58\u50a8\u200b\u5730\u5740\u200b\u4e3a\u200b0x10\u200b\u7684\u200b\u4e00\u4e2a\u200b\u5b57\u8282\u200b\uff0c\u200b\u5e94\u8be5\u200b\u6784\u9020\u200b\u51e0\u4e2a\u200bi2c_msg\uff1f</p> <ul> <li> <p>\u200b\u8981\u200b\u6784\u9020\u200b2\u200b\u4e2a\u200bi2c_msg</p> </li> <li> <p>\u200b\u7b2c\u4e00\u4e2a\u200bi2c_msg\u200b\u8868\u793a\u200b\u5199\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u628a\u200b\u8981\u200b\u8bbf\u95ee\u200b\u7684\u200b\u5b58\u50a8\u200b\u5730\u5740\u200b0x10\u200b\u53d1\u7ed9\u200b\u8bbe\u5907\u200b</p> </li> <li> <p>\u200b\u7b2c\u4e8c\u4e2a\u200bi2c_msg\u200b\u8868\u793a\u200b\u8bfb\u200b\u64cd\u4f5c\u200b</p> </li> <li> <p>\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b</p> </li> </ul> <pre><code>u8 data_addr = 0x10;\ni8 data;\nstruct i2c_msg msgs[2];\n\nmsgs[0].addr   = 0x50;\nmsgs[0].flags  = 0;\nmsgs[0].len    = 1;\nmsgs[0].buf    = &amp;data_addr;\n\nmsgs[1].addr   = 0x50;\nmsgs[1].flags  = I2C_M_RD;\nmsgs[1].len    = 1;\nmsgs[1].buf    = &amp;data;\n</code></pre> </li> </ul>"},{"location":"04_I2C/04/#5","title":"5. \u200b\u5185\u6838\u200b\u91cc\u200b\u600e\u4e48\u200b\u4f20\u8f93\u6570\u636e","text":"<p>\u200b\u4f7f\u7528\u200b\u4e00\u53e5\u200b\u8bdd\u200b\u6982\u62ec\u200bI2C\u200b\u4f20\u8f93\u200b\uff1a</p> <ul> <li> <p>APP\u200b\u901a\u8fc7\u200bI2C Controller\u200b\u4e0e\u200bI2C Device\u200b\u4f20\u8f93\u6570\u636e\u200b</p> </li> <li> <p>APP\u200b\u901a\u8fc7\u200bi2c_adapter\u200b\u4e0e\u200bi2c_client\u200b\u4f20\u8f93\u200bi2c_msg</p> </li> <li> <p>\u200b\u5185\u6838\u200b\u51fd\u6570\u200bi2c_transfer</p> </li> <li> <p>i2c_msg\u200b\u91cc\u200b\u542b\u6709\u200baddr\uff0c\u200b\u6240\u4ee5\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u91cc\u200b\u4e0d\u200b\u9700\u8981\u200bi2c_client</p> </li> </ul> <p></p>"},{"location":"04_I2C/05/","title":"05_\u200b\u65e0\u9700\u200b\u7f16\u5199\u200b\u9a71\u52a8\u200b\u76f4\u63a5\u200b\u8bbf\u95ee\u200b\u8bbe\u5907\u200b_I2C-Tools\u200b\u4ecb\u7ecd","text":""},{"location":"04_I2C/05/#_i2c-tools","title":"\u65e0\u9700\u200b\u7f16\u5199\u200b\u9a71\u52a8\u200b\u76f4\u63a5\u200b\u8bbf\u95ee\u200b\u8bbe\u5907\u200b_I2C-Tools\u200b\u4ecb\u7ecd","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b: <code>drivers/i2c/i2c-dev.c</code></li> <li>I2C-Tools-4.2: <code>https://mirrors.edge.kernel.org/pub/software/utils/i2c-tools/</code></li> <li>AP3216C\uff1a</li> <li><code>git clone https://e.coding.net/weidongshan/01_all_series_quickstart.git</code></li> <li>\u200b\u8be5\u200bGIT\u200b\u4ed3\u5e93\u200b\u4e2d\u200b\u7684\u200b\u6587\u4ef6\u200b\u300a\u200b\u5d4c\u5165\u5f0f\u200bLinux\u200b\u5e94\u7528\u200b\u5f00\u53d1\u200b\u5b8c\u5168\u200b\u624b\u518c\u200b_\u200b\u97e6\u200b\u4e1c\u5c71\u200b\u5168\u7cfb\u5217\u200b\u89c6\u9891\u200b\u6587\u6863\u200b\u5168\u96c6\u200b.pdf\u300b<ul> <li>\u200b\u7b2c\u200b10.1\u200b\u7bc7\u200b\uff0c\u200b\u7b2c\u5341\u516d\u7ae0\u200b I2C\u200b\u7f16\u7a0b\u200b</li> </ul> </li> </ul>"},{"location":"04_I2C/05/#1-i2c","title":"1. I2C\u200b\u786c\u4ef6\u200b\u8fde\u63a5","text":""},{"location":"04_I2C/05/#2-i2c","title":"2. \u200b\u65e0\u9700\u200b\u7f16\u5199\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5373\u53ef\u200b\u8bbf\u95ee\u200bI2C\u200b\u8bbe\u5907","text":"<p>APP\u200b\u8bbf\u95ee\u200b\u786c\u4ef6\u200b\u80af\u5b9a\u200b\u662f\u200b\u9700\u8981\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u7684\u200b\uff0c \u200b\u5bf9\u4e8e\u200bI2C\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5185\u6838\u200b\u63d0\u4f9b\u200b\u4e86\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b<code>drivers/i2c/i2c-dev.c</code>\uff0c\u200b\u901a\u8fc7\u200b\u5b83\u200b\u53ef\u4ee5\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u4e0b\u9762\u200b\u7684\u200bI2C\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b\u6765\u200b\u8bbf\u95ee\u200bI2C\u200b\u8bbe\u5907\u200b\u3002 \u200b\u6846\u67b6\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>i2c-tools\u200b\u662f\u200b\u4e00\u5957\u200b\u597d\u7528\u200b\u7684\u200b\u5de5\u5177\u200b\uff0c\u200b\u4e5f\u200b\u662f\u200b\u4e00\u5957\u200b\u793a\u4f8b\u200b\u4ee3\u7801\u200b\u3002</p>"},{"location":"04_I2C/05/#3-i2c-tools","title":"3. \u200b\u4f53\u9a8c\u200bI2C-Tools","text":"<p>\u200b\u4f7f\u7528\u200b\u4e00\u53e5\u200b\u8bdd\u200b\u6982\u62ec\u200bI2C\u200b\u4f20\u8f93\u200b\uff1aAPP\u200b\u901a\u8fc7\u200bI2C Controller\u200b\u4e0e\u200bI2C Device\u200b\u4f20\u8f93\u6570\u636e\u200b\u3002 \u200b\u6240\u4ee5\u200b\u4f7f\u7528\u200bI2C-Tools\u200b\u65f6\u200b\u4e5f\u200b\u9700\u8981\u200b\u6307\u5b9a\u200b\uff1a</p> <ul> <li>\u200b\u54ea\u4e2a\u200bI2C\u200b\u63a7\u5236\u5668\u200b(\u200b\u6216\u200b\u79f0\u4e3a\u200bI2C BUS\u3001I2C Adapter)</li> <li>\u200b\u54ea\u4e2a\u200bI2C\u200b\u8bbe\u5907\u200b(\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b)</li> <li>\u200b\u6570\u636e\u200b\uff1a\u200b\u8bfb\u200b\u8fd8\u662f\u200b\u5199\u200b\u3001\u200b\u6570\u636e\u200b\u672c\u8eab\u200b</li> </ul>"},{"location":"04_I2C/05/#31","title":"3.1 \u200b\u4ea4\u53c9\u200b\u7f16\u8bd1","text":"<ul> <li> <p>\u200b\u5728\u200bUbuntu\u200b\u8bbe\u7f6e\u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200b\u5de5\u5177\u200b\u94fe\u200b</p> </li> <li> <p>STM32MP157</p> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre> </li> <li> <p>IMX6ULL</p> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre> </li> <li> <p>\u200b\u4fee\u6539\u200bI2C-Tools\u200b\u7684\u200bMakefile\u200b\u6307\u5b9a\u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200b\u5de5\u5177\u200b\u94fe\u200b</p> </li> </ul> <pre><code>CC      ?= gcc\nAR      ?= ar\nSTRIP   ?= strip\n\u200b\u6539\u4e3a\u200b(\u200b\u6307\u5b9a\u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200b\u5de5\u5177\u200b\u94fe\u200b\u524d\u7f00\u200b, \u200b\u53bb\u6389\u200b\u95ee\u53f7\u200b)\uff1a\nCC      = $(CROSS_COMPILE)gcc\nAR      = $(CROSS_COMPILE)ar\nSTRIP   = $(CROSS_COMPILE)strip\n</code></pre> <p>\u200b\u5728\u200bMakefile\u200b\u4e2d\u200b\uff0c\u201c?=\u201d\u200b\u5728\u200b\u7b2c\u4e00\u6b21\u200b\u8bbe\u7f6e\u200b\u53d8\u91cf\u200b\u65f6\u624d\u200b\u4f1a\u200b\u8d77\u200b\u6548\u679c\u200b\uff0c\u200b\u5982\u679c\u200b\u4e4b\u524d\u200b\u8bbe\u7f6e\u200b\u8fc7\u8be5\u200b\u53d8\u91cf\u200b\uff0c\u200b\u5219\u200b\u4e0d\u4f1a\u200b\u8d77\u200b\u6548\u679c\u200b\u3002</p> <ul> <li> <p>\u200b\u6267\u884c\u200bmake\u200b\u5373\u53ef\u200b</p> </li> <li> <p>\u200b\u6267\u884c\u200bmake\u200b\u65f6\u200b\uff0c\u200b\u662f\u200b\u52a8\u6001\u200b\u94fe\u63a5\u200b\uff0c\u200b\u9700\u8981\u200b\u628a\u200blibi2c.so\u200b\u4e5f\u200b\u653e\u5230\u200b\u5355\u677f\u200b\u4e0a\u200b</p> </li> <li>\u200b\u60f3\u200b\u9759\u6001\u200b\u94fe\u63a5\u200b\u7684\u8bdd\u200b\uff0c\u200b\u6267\u884c\u200b\uff1a<code>make USE_STATIC_LIB=1</code></li> </ul>"},{"location":"04_I2C/05/#32","title":"3.2 \u200b\u7528\u6cd5","text":"<ul> <li>i2cdetect\uff1aI2C\u200b\u68c0\u6d4b\u200b</li> </ul> <pre><code>// \u200b\u5217\u51fa\u200b\u5f53\u524d\u200b\u7684\u200bI2C Adapter(\u200b\u6216\u200b\u79f0\u4e3a\u200bI2C Bus\u3001I2C Controller)\ni2cdetect -l\n\n// \u200b\u6253\u5370\u200b\u67d0\u4e2a\u200bI2C Adapter\u200b\u7684\u200bFunctionalities, I2CBUS\u200b\u4e3a\u200b0\u30011\u30012\u200b\u7b49\u200b\u6574\u6570\u200b\ni2cdetect -F I2CBUS\n\n// \u200b\u770b\u770b\u200b\u6709\u200b\u54ea\u4e9b\u200bI2C\u200b\u8bbe\u5907\u200b, I2CBUS\u200b\u4e3a\u200b0\u30011\u30012\u200b\u7b49\u200b\u6574\u6570\u200b\ni2cdetect -y -a I2CBUS\n\n// \u200b\u6548\u679c\u200b\u5982\u4e0b\u200b\n# i2cdetect -l\ni2c-1   i2c             STM32F7 I2C(0x40013000)                 I2C adapter\ni2c-2   i2c             STM32F7 I2C(0x5c002000)                 I2C adapter\ni2c-0   i2c             STM32F7 I2C(0x40012000)                 I2C adapter\n\n# i2cdetect -F 0\nFunctionalities implemented by /dev/i2c-0:\nI2C                              yes\nSMBus Quick Command              yes\nSMBus Send Byte                  yes\nSMBus Receive Byte               yes\nSMBus Write Byte                 yes\nSMBus Read Byte                  yes\nSMBus Write Word                 yes\nSMBus Read Word                  yes\nSMBus Process Call               yes\nSMBus Block Write                yes\nSMBus Block Read                 yes\nSMBus Block Process Call         yes\nSMBus PEC                        yes\nI2C Block Write                  yes\nI2C Block Read                   yes\n\n// --\u200b\u8868\u793a\u200b\u6ca1\u6709\u200b\u8be5\u200b\u5730\u5740\u200b\u5bf9\u5e94\u200b\u7684\u200b\u8bbe\u5907\u200b, UU\u200b\u8868\u793a\u200b\u6709\u200b\u8be5\u200b\u8bbe\u5907\u200b\u5e76\u4e14\u200b\u5b83\u200b\u5df2\u7ecf\u200b\u6709\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b,\n// \u200b\u6570\u503c\u200b\u8868\u793a\u200b\u6709\u200b\u8be5\u200b\u8bbe\u5907\u200b\u4f46\u662f\u200b\u6ca1\u6709\u200b\u5bf9\u5e94\u200b\u7684\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\n# i2cdetect -y -a 0  \n     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f\n00: 00 -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n10: -- -- -- -- -- -- -- -- -- -- UU -- -- -- 1e --\n20: -- -- UU -- -- -- -- -- -- -- -- -- -- -- -- --\n30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n70: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n</code></pre> <ul> <li>i2cget\uff1aI2C\u200b\u8bfb\u200b   \u200b\u4f7f\u7528\u200b\u8bf4\u660e\u200b\u5982\u4e0b\u200b\uff1a</li> </ul> <pre><code># i2cget\nUsage: i2cget [-f] [-y] [-a] I2CBUS CHIP-ADDRESS [DATA-ADDRESS [MODE]]\n  I2CBUS is an integer or an I2C bus name\n  ADDRESS is an integer (0x03 - 0x77, or 0x00 - 0x7f if -a is given)\n  MODE is one of:\n    b (read byte data, default)\n    w (read word data)\n    c (write byte/read byte)\n    Append p for SMBus PEC\n</code></pre> <p>\u200b\u4f7f\u7528\u200b\u793a\u4f8b\u200b\uff1a</p> <pre><code>// \u200b\u8bfb\u200b\u4e00\u4e2a\u200b\u5b57\u8282\u200b: I2CBUS\u200b\u4e3a\u200b0\u30011\u30012\u200b\u7b49\u200b\u6574\u6570\u200b, \u200b\u8868\u793a\u200bI2C Bus; CHIP-ADDRESS\u200b\u8868\u793a\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\ni2cget -f -y I2CBUS CHIP-ADDRESS\n\n// \u200b\u8bfb\u200b\u67d0\u4e2a\u200b\u5730\u5740\u200b\u4e0a\u200b\u7684\u200b\u4e00\u4e2a\u200b\u5b57\u8282\u200b: \n//    I2CBUS\u200b\u4e3a\u200b0\u30011\u30012\u200b\u7b49\u200b\u6574\u6570\u200b, \u200b\u8868\u793a\u200bI2C Bus\n//    CHIP-ADDRESS\u200b\u8868\u793a\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\n//    DATA-ADDRESS: \u200b\u82af\u7247\u200b\u4e0a\u200b\u5bc4\u5b58\u5668\u200b\u5730\u5740\u200b\n//    MODE\uff1a\u200b\u6709\u200b2\u200b\u4e2a\u200b\u53d6\u503c\u200b, b-\u200b\u4f7f\u7528\u200b`SMBus Read Byte`\u200b\u5148\u200b\u53d1\u51fa\u200bDATA-ADDRESS, \u200b\u518d\u200b\u8bfb\u200b\u4e00\u4e2a\u200b\u5b57\u8282\u200b, \u200b\u4e2d\u95f4\u200b\u65e0\u200bP\u200b\u4fe1\u53f7\u200b\n//                   c-\u200b\u5148\u200bwrite byte, \u200b\u5728\u200bread byte\uff0c\u200b\u4e2d\u95f4\u200b\u6709\u200bP\u200b\u4fe1\u53f7\u200b \ni2cget -f -y I2CBUS CHIP-ADDRESS DATA-ADDRESS MODE  \n\n// \u200b\u8bfb\u200b\u67d0\u4e2a\u200b\u5730\u5740\u200b\u4e0a\u200b\u7684\u200b2\u200b\u4e2a\u200b\u5b57\u8282\u200b: \n//    I2CBUS\u200b\u4e3a\u200b0\u30011\u30012\u200b\u7b49\u200b\u6574\u6570\u200b, \u200b\u8868\u793a\u200bI2C Bus\n//    CHIP-ADDRESS\u200b\u8868\u793a\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\n//    DATA-ADDRESS: \u200b\u82af\u7247\u200b\u4e0a\u200b\u5bc4\u5b58\u5668\u200b\u5730\u5740\u200b\n//    MODE\uff1aw-\u200b\u8868\u793a\u200b\u5148\u200b\u53d1\u51fa\u200bDATA-ADDRESS\uff0c\u200b\u518d\u200b\u8bfb\u200b2\u200b\u4e2a\u200b\u5b57\u8282\u200b\ni2cget -f -y I2CBUS CHIP-ADDRESS DATA-ADDRESS MODE  \n</code></pre> <ul> <li>i2cset\uff1aI2C\u200b\u5199\u200b \u200b\u4f7f\u7528\u200b\u8bf4\u660e\u200b\u5982\u4e0b\u200b\uff1a</li> </ul> <pre><code># i2cset\nUsage: i2cset [-f] [-y] [-m MASK] [-r] [-a] I2CBUS CHIP-ADDRESS DATA-ADDRESS [VALUE] ... [MODE]\n  I2CBUS is an integer or an I2C bus name\n  ADDRESS is an integer (0x03 - 0x77, or 0x00 - 0x7f if -a is given)\n  MODE is one of:\n    c (byte, no value)\n    b (byte data, default)\n    w (word data)\n  i (I2C block data)\n    s (SMBus block data)\n    Append p for SMBus PEC\n</code></pre> <p>\u200b\u4f7f\u7528\u200b\u793a\u4f8b\u200b\uff1a</p> <pre><code>  // \u200b\u5199\u200b\u4e00\u4e2a\u200b\u5b57\u8282\u200b: I2CBUS\u200b\u4e3a\u200b0\u30011\u30012\u200b\u7b49\u200b\u6574\u6570\u200b, \u200b\u8868\u793a\u200bI2C Bus; CHIP-ADDRESS\u200b\u8868\u793a\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\n  //           DATA-ADDRESS\u200b\u5c31\u662f\u200b\u8981\u200b\u5199\u200b\u7684\u200b\u6570\u636e\u200b\n  i2cset -f -y I2CBUS CHIP-ADDRESS DATA-ADDRESS\n\n  // \u200b\u7ed9\u200baddress\u200b\u5199\u200b1\u200b\u4e2a\u200b\u5b57\u8282\u200b(address, value):\n  //           I2CBUS\u200b\u4e3a\u200b0\u30011\u30012\u200b\u7b49\u200b\u6574\u6570\u200b, \u200b\u8868\u793a\u200bI2C Bus; CHIP-ADDRESS\u200b\u8868\u793a\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\n  //           DATA-ADDRESS: 8\u200b\u4f4d\u200b\u82af\u7247\u200b\u5bc4\u5b58\u5668\u200b\u5730\u5740\u200b; \n  //           VALUE: 8\u200b\u4f4d\u200b\u6570\u503c\u200b\n  //           MODE: \u200b\u53ef\u4ee5\u200b\u7701\u7565\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u5199\u4e3a\u200bb\n  i2cset -f -y I2CBUS CHIP-ADDRESS DATA-ADDRESS VALUE [b]\n\n  // \u200b\u7ed9\u200baddress\u200b\u5199\u200b2\u200b\u4e2a\u200b\u5b57\u8282\u200b(address, value):\n  //           I2CBUS\u200b\u4e3a\u200b0\u30011\u30012\u200b\u7b49\u200b\u6574\u6570\u200b, \u200b\u8868\u793a\u200bI2C Bus; CHIP-ADDRESS\u200b\u8868\u793a\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\n  //           DATA-ADDRESS: 8\u200b\u4f4d\u200b\u82af\u7247\u200b\u5bc4\u5b58\u5668\u200b\u5730\u5740\u200b; \n  //           VALUE: 16\u200b\u4f4d\u200b\u6570\u503c\u200b\n  //           MODE: w\n  i2cset -f -y I2CBUS CHIP-ADDRESS DATA-ADDRESS VALUE w\n\n  // SMBus Block Write\uff1a\u200b\u7ed9\u200baddress\u200b\u5199\u200bN\u200b\u4e2a\u200b\u5b57\u8282\u200b\u7684\u200b\u6570\u636e\u200b\n  //   \u200b\u53d1\u9001\u200b\u7684\u200b\u6570\u636e\u200b\u6709\u200b\uff1aaddress, N, value1, value2, ..., valueN\n  //   \u200b\u8ddf\u200b`I2C Block Write`\u200b\u76f8\u6bd4\u200b, \u200b\u9700\u8981\u200b\u53d1\u9001\u200b\u957f\u5ea6\u200bN\n  //           I2CBUS\u200b\u4e3a\u200b0\u30011\u30012\u200b\u7b49\u200b\u6574\u6570\u200b, \u200b\u8868\u793a\u200bI2C Bus; CHIP-ADDRESS\u200b\u8868\u793a\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\n  //           DATA-ADDRESS: 8\u200b\u4f4d\u200b\u82af\u7247\u200b\u5bc4\u5b58\u5668\u200b\u5730\u5740\u200b; \n  //           VALUE1~N: N\u200b\u4e2a\u200b8\u200b\u4f4d\u200b\u6570\u503c\u200b\n  //           MODE: s\n  i2cset -f -y I2CBUS CHIP-ADDRESS DATA-ADDRESS VALUE1 ... VALUEN s\n\n  // I2C Block Write\uff1a\u200b\u7ed9\u200baddress\u200b\u5199\u200bN\u200b\u4e2a\u200b\u5b57\u8282\u200b\u7684\u200b\u6570\u636e\u200b\n  //   \u200b\u53d1\u9001\u200b\u7684\u200b\u6570\u636e\u200b\u6709\u200b\uff1aaddress, value1, value2, ..., valueN\n  //   \u200b\u8ddf\u200b`SMBus Block Write`\u200b\u76f8\u6bd4\u200b, \u200b\u4e0d\u200b\u9700\u8981\u200b\u53d1\u9001\u200b\u957f\u5ea6\u200bN\n  //           I2CBUS\u200b\u4e3a\u200b0\u30011\u30012\u200b\u7b49\u200b\u6574\u6570\u200b, \u200b\u8868\u793a\u200bI2C Bus; CHIP-ADDRESS\u200b\u8868\u793a\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\n  //           DATA-ADDRESS: 8\u200b\u4f4d\u200b\u82af\u7247\u200b\u5bc4\u5b58\u5668\u200b\u5730\u5740\u200b; \n  //           VALUE1~N: N\u200b\u4e2a\u200b8\u200b\u4f4d\u200b\u6570\u503c\u200b\n  //           MODE: i\n  i2cset -f -y I2CBUS CHIP-ADDRESS DATA-ADDRESS VALUE1 ... VALUEN i\n  ```\n\n* i2ctransfer\uff1aI2C\u200b\u4f20\u8f93\u200b(\u200b\u4e0d\u662f\u200b\u57fa\u4e8e\u200bSMBus)\n  \u200b\u4f7f\u7528\u200b\u8bf4\u660e\u200b\u5982\u4e0b\u200b\uff1a\n\n  ```shell\n  # i2ctransfer\n  Usage: i2ctransfer [-f] [-y] [-v] [-V] [-a] I2CBUS DESC [DATA] [DESC [DATA]]...\n    I2CBUS is an integer or an I2C bus name\n    DESC describes the transfer in the form: {r|w}LENGTH[@address]\n      1) read/write-flag 2) LENGTH (range 0-65535) 3) I2C address (use last one if omitted)\n    DATA are LENGTH bytes for a write message. They can be shortened by a suffix:\n      = (keep value constant until LENGTH)\n      + (increase value by 1 until LENGTH)\n      - (decrease value by 1 until LENGTH)\n      p (use pseudo random generator until LENGTH with value as seed)\n\n  Example (bus 0, read 8 byte at offset 0x64 from EEPROM at 0x50):\n    # i2ctransfer 0 w1@0x50 0x64 r8\n  Example (same EEPROM, at offset 0x42 write 0xff 0xfe ... 0xf0):\n    # i2ctransfer 0 w17@0x50 0x42 0xff-\n  ```\n\n  \u200b\u4f7f\u7528\u200b\u4e3e\u4f8b\u200b\uff1a\n\n  ```shell\n  // Example (bus 0, read 8 byte at offset 0x64 from EEPROM at 0x50):\n  # i2ctransfer -f -y 0 w1@0x50 0x64 r8\n\n  // Example (bus 0, write 3 byte at offset 0x64 from EEPROM at 0x50):\n  # i2ctransfer -f -y 0 w9@0x50 0x64 val1 val2 val3\n\n  // Example \n  // first: (bus 0, write 3 byte at offset 0x64 from EEPROM at 0x50)\n  // and then: (bus 0, read 3 byte at offset 0x64 from EEPROM at 0x50)\n  # i2ctransfer -f -y 0 w9@0x50 0x64 val1 val2 val3 r3@0x50  \n  # i2ctransfer -f -y 0 w9@0x50 0x64 val1 val2 val3 r3 //\u200b\u5982\u679c\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\u4e0d\u53d8\u200b,\u200b\u540e\u9762\u200b\u7684\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\u53ef\u200b\u7701\u7565\u200b\n  ```\n\n#### 3.3 \u200b\u4f7f\u7528\u200bI2C-Tools\u200b\u64cd\u4f5c\u200b\u4f20\u611f\u5668\u200bAP3216C\n\n\u200b\u767e\u95ee\u200b\u7f51\u200b\u7684\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6709\u200b\u5149\u611f\u200b\u82af\u7247\u200bAP3216C\uff1a\n![image-20210225105221181](pic/04_I2C/035_ap3216c_position.png)\n\nAP3216C\u200b\u662f\u200b\u7ea2\u5916\u200b\u3001\u200b\u5149\u5f3a\u200b\u3001\u200b\u8ddd\u79bb\u200b\u4e09\u5408\u4e00\u200b\u7684\u200b\u4f20\u611f\u5668\u200b\uff0c\u200b\u4ee5\u200b\u8bfb\u51fa\u200b\u5149\u5f3a\u200b\u3001\u200b\u8ddd\u79bb\u200b\u503c\u4e3a\u4f8b\u200b\uff0c\u200b\u6b65\u9aa4\u200b\u5982\u4e0b\u200b\uff1a\n\n* \u200b\u590d\u4f4d\u200b\uff1a\u200b\u5f80\u200b\u5bc4\u5b58\u5668\u200b0\u200b\u5199\u5165\u200b0x4\n* \u200b\u4f7f\u80fd\u200b\uff1a\u200b\u5f80\u200b\u5bc4\u5b58\u5668\u200b0\u200b\u5199\u5165\u200b0x3\n* \u200b\u8bfb\u200b\u5149\u5f3a\u200b\uff1a\u200b\u8bfb\u200b\u5bc4\u5b58\u5668\u200b0xC\u30010xD\u200b\u5f97\u5230\u200b2\u200b\u5b57\u8282\u200b\u7684\u200b\u5149\u5f3a\u200b\n* \u200b\u8bfb\u200b\u8ddd\u79bb\u200b\uff1a\u200b\u8bfb\u200b\u5bc4\u5b58\u5668\u200b0xE\u30010xF\u200b\u5f97\u5230\u200b2\u200b\u5b57\u8282\u200b\u7684\u200b\u8ddd\u79bb\u200b\u503c\u200b\n\nAP3216C\u200b\u7684\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\u662f\u200b0x1E\uff0c\u200b\u5047\u8bbe\u200b\u8282\u5728\u200bI2C BUS0\u200b\u4e0a\u200b\uff0c\u200b\u64cd\u4f5c\u547d\u4ee4\u200b\u5982\u4e0b\u200b\uff1a\n\n* \u200b\u4f7f\u7528\u200bSMBus\u200b\u534f\u8bae\u200b\n\n```shell\ni2cset -f -y 0 0x1e 0 0x4\ni2cset -f -y 0 0x1e 0 0x3\ni2cget -f -y 0 0x1e 0xc w\ni2cget -f -y 0 0x1e 0xe w\n</code></pre> <ul> <li>\u200b\u4f7f\u7528\u200bI2C\u200b\u534f\u8bae\u200b</li> </ul> <pre><code>i2ctransfer -f -y 0 w2@0x1e 0 0x4\ni2ctransfer -f -y 0 w2@0x1e 0 0x3\ni2ctransfer -f -y 0 w1@0x1e 0xc r2\ni2ctransfer -f -y 0 w1@0x1e 0xe r2\n</code></pre>"},{"location":"04_I2C/05/#4-i2c-toolsi2c2","title":"4. I2C-Tools\u200b\u7684\u200b\u8bbf\u95ee\u200bI2C\u200b\u8bbe\u5907\u200b\u7684\u200b2\u200b\u79cd\u200b\u65b9\u5f0f","text":"<p>I2C-Tools\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200bSMBus\u200b\u6765\u200b\u8bbf\u95ee\u200bI2C\u200b\u8bbe\u5907\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u4e00\u822c\u200b\u7684\u200bI2C\u200b\u534f\u8bae\u200b\u6765\u200b\u8bbf\u95ee\u200bI2C\u200b\u8bbe\u5907\u200b\u3002 \u200b\u4f7f\u7528\u200b\u4e00\u53e5\u200b\u8bdd\u200b\u6982\u62ec\u200bI2C\u200b\u4f20\u8f93\u200b\uff1aAPP\u200b\u901a\u8fc7\u200bI2C Controller\u200b\u4e0e\u200bI2C Device\u200b\u4f20\u8f93\u6570\u636e\u200b\u3002 \u200b\u5728\u200bAPP\u200b\u91cc\u200b\uff0c\u200b\u6709\u200b\u8fd9\u200b\u51e0\u4e2a\u200b\u95ee\u9898\u200b\uff1a</p> <ul> <li>\u200b\u600e\u4e48\u200b\u6307\u5b9a\u200bI2C\u200b\u63a7\u5236\u5668\u200b\uff1f</li> <li>i2c-dev.c\u200b\u63d0\u4f9b\u200b\u4e3a\u200b\u6bcf\u4e2a\u200bI2C\u200b\u63a7\u5236\u5668\u200b(I2C Bus\u3001I2C Adapter)\u200b\u90fd\u200b\u751f\u6210\u200b\u4e00\u4e2a\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\uff1a/dev/i2c-0\u3001/dev/i2c-1\u200b\u7b49\u5f85\u200b</li> <li>open\u200b\u67d0\u4e2a\u200b/dev/i2c-X\u200b\u8282\u70b9\u200b\uff0c\u200b\u5c31\u662f\u200b\u53bb\u200b\u8bbf\u95ee\u200b\u8be5\u200bI2C\u200b\u63a7\u5236\u5668\u200b\u4e0b\u200b\u7684\u200b\u8bbe\u5907\u200b</li> <li>\u200b\u600e\u4e48\u200b\u6307\u5b9a\u200bI2C\u200b\u8bbe\u5907\u200b\uff1f</li> <li>\u200b\u901a\u8fc7\u200bioctl\u200b\u6307\u5b9a\u200bI2C\u200b\u8bbe\u5907\u200b\u7684\u200b\u5730\u5740\u200b</li> <li>ioctl(file,  I2C_SLAVE, address)<ul> <li>\u200b\u5982\u679c\u200b\u8be5\u200b\u8bbe\u5907\u200b\u5df2\u7ecf\u200b\u6709\u200b\u4e86\u200b\u5bf9\u5e94\u200b\u7684\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u5219\u200b\u8fd4\u56de\u200b\u5931\u8d25\u200b</li> </ul> </li> <li>ioctl(file,  I2C_SLAVE_FORCE, address)<ul> <li>\u200b\u5982\u679c\u200b\u8be5\u200b\u8bbe\u5907\u200b\u5df2\u7ecf\u200b\u6709\u200b\u4e86\u200b\u5bf9\u5e94\u200b\u7684\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</li> <li>\u200b\u4f46\u662f\u200b\u8fd8\u662f\u200b\u60f3\u200b\u901a\u8fc7\u200bi2c-dev\u200b\u9a71\u52a8\u200b\u6765\u200b\u8bbf\u95ee\u200b\u5b83\u200b</li> <li>\u200b\u5219\u200b\u4f7f\u7528\u200b\u8fd9\u4e2a\u200bioctl\u200b\u6765\u200b\u6307\u5b9a\u200bI2C\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b</li> </ul> </li> <li>\u200b\u600e\u4e48\u200b\u4f20\u8f93\u6570\u636e\u200b\uff1f</li> <li>\u200b\u4e24\u79cd\u200b\u65b9\u5f0f\u200b</li> <li>\u200b\u4e00\u822c\u200b\u7684\u200bI2C\u200b\u65b9\u5f0f\u200b\uff1aioctl(file, I2C_RDWR, &amp;rdwr)</li> <li>SMBus\u200b\u65b9\u5f0f\u200b\uff1aioctl(file, I2C_SMBUS, &amp;args)</li> </ul>"},{"location":"04_I2C/05/#5","title":"5. \u200b\u6e90\u7801\u200b\u5206\u6790","text":""},{"location":"04_I2C/05/#51-i2c","title":"5.1 \u200b\u4f7f\u7528\u200bI2C\u200b\u65b9\u5f0f","text":"<p>\u200b\u793a\u4f8b\u200b\u4ee3\u7801\u200b\uff1ai2ctransfer.c</p> <p></p>"},{"location":"04_I2C/05/#52-smbus","title":"5.2 \u200b\u4f7f\u7528\u200bSMBus\u200b\u65b9\u5f0f","text":"<p>\u200b\u793a\u4f8b\u200b\u4ee3\u7801\u200b\uff1ai2cget.c\u3001i2cset.c</p> <p></p>"},{"location":"04_I2C/06/","title":"06_\u200b\u7f16\u5199\u200bAPP\u200b\u76f4\u63a5\u200b\u8bbf\u95ee\u200bEEPROM","text":""},{"location":"04_I2C/06/#appeeprom","title":"\u7f16\u5199\u200bAPP\u200b\u76f4\u63a5\u200b\u8bbf\u95ee\u200bEEPROM","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b: <code>drivers/i2c/i2c-dev.c</code></li> <li>I2C-Tools-4.2: <code>https://mirrors.edge.kernel.org/pub/software/utils/i2c-tools/</code></li> <li>AT24cxx.pdf</li> </ul> <p>\u200b\u672c\u200b\u8282\u200b\u6e90\u7801\u200b\uff1aGIT\u200b\u4ed3\u5e93\u200b\u4e2d\u200b</p> <ul> <li><code>doc_and_source_for_drivers\\IMX6ULL\\source\\04_I2C\\01_at24c02_test</code></li> <li><code>doc_and_source_for_drivers\\STM32MP157\\source\\A7\\04_I2C\\01_at24c02_test</code></li> </ul>"},{"location":"04_I2C/06/#1","title":"1. \u200b\u786c\u4ef6\u200b\u8fde\u63a5","text":"<ul> <li> <p>STM32MP157\u200b\u7684\u200bI2C\u200b\u6a21\u5757\u200b\u8fde\u63a5\u200b\u65b9\u6cd5\u200b   </p> </li> <li> <p>IMX6ULL\u200b\u7684\u200bI2C\u200b\u6a21\u5757\u200b\u8fde\u63a5\u200b\u65b9\u6cd5\u200b   </p> </li> </ul>"},{"location":"04_I2C/06/#2-at24c02","title":"2. AT24C02\u200b\u8bbf\u95ee\u200b\u65b9\u6cd5","text":""},{"location":"04_I2C/06/#21","title":"2.1 \u200b\u8bbe\u5907\u200b\u5730\u5740","text":"<p>\u200b\u4ece\u200b\u82af\u7247\u200b\u624b\u518c\u200b\u4e0a\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200b\uff0cAT24C02\u200b\u7684\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\u8ddf\u200b\u5b83\u200b\u7684\u200bA2\u3001A1\u3001A0\u200b\u5f15\u811a\u200b\u6709\u5173\u200b\uff1a</p> <p></p> <p>\u200b\u6253\u5f00\u200bI2C\u200b\u6a21\u5757\u200b\u7684\u200b\u539f\u7406\u56fe\u200b(\u200b\u8fd9\u200b2\u200b\u4e2a\u200b\u6587\u4ef6\u200b\u662f\u200b\u4e00\u6837\u200b\u7684\u200b)\uff1a</p> <ul> <li><code>STM32MP157\\\u200b\u5f00\u53d1\u677f\u200b\u914d\u5957\u200b\u8d44\u6599\u200b\\\u200b\u539f\u7406\u56fe\u200b\\04_Extend_modules(\u200b\u5916\u8bbe\u200b\u6a21\u5757\u200b)\\eeprom.zip\\i2c_eeprom_module_v1.0.pdf</code></li> <li><code>IMX6ULL\\\u200b\u5f00\u53d1\u677f\u200b\u914d\u5957\u200b\u8d44\u6599\u200b\\\u200b\u539f\u7406\u56fe\u200b\\Extend_modules\\eeprom.zip\\i2c_eeprom_module_v1.0.pdf</code></li> <li>\u200b\u5982\u4e0b\u200b\uff1a   </li> </ul> <p>\u200b\u4ece\u200b\u539f\u7406\u56fe\u200b\u53ef\u77e5\u200b\uff0cA2A1A0\u200b\u90fd\u200b\u662f\u200b0\uff0c\u200b\u6240\u4ee5\u200bAT24C02\u200b\u7684\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\u662f\u200b\uff1a0b1010000\uff0c\u200b\u5373\u200b0x50\u3002</p>"},{"location":"04_I2C/06/#22","title":"2.2 \u200b\u5199\u200b\u6570\u636e","text":""},{"location":"04_I2C/06/#23","title":"2.3 \u200b\u8bfb\u6570\u636e","text":"<p>\u200b\u53ef\u4ee5\u200b\u8bfb\u200b1\u200b\u4e2a\u200b\u5b57\u8282\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u8fde\u7eed\u200b\u8bfb\u51fa\u200b\u591a\u4e2a\u200b\u5b57\u8282\u200b\u3002 \u200b\u8fde\u7eed\u200b\u8bfb\u200b\u591a\u4e2a\u200b\u5b57\u8282\u200b\u65f6\u200b\uff0c\u200b\u82af\u7247\u200b\u5185\u90e8\u200b\u7684\u200b\u5730\u5740\u200b\u4f1a\u200b\u81ea\u52a8\u200b\u7d2f\u52a0\u200b\u3002 \u200b\u5f53\u200b\u5730\u5740\u200b\u5230\u8fbe\u200b\u5b58\u50a8\u7a7a\u95f4\u200b\u6700\u540e\u200b\u4e00\u4e2a\u200b\u5730\u5740\u200b\u65f6\u200b\uff0c\u200b\u4f1a\u200b\u4ece\u200b0\u200b\u5f00\u59cb\u200b\u3002</p> <p></p>"},{"location":"04_I2C/06/#3-i2c-tools","title":"3. \u200b\u4f7f\u7528\u200bI2C-Tools\u200b\u7684\u200b\u51fd\u6570\u200b\u7f16\u7a0b","text":""},{"location":"04_I2C/06/#4","title":"4. \u200b\u7f16\u8bd1","text":""},{"location":"04_I2C/06/#41-ubuntu","title":"4.1 \u200b\u5728\u200bUbuntu\u200b\u8bbe\u7f6e\u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200b\u5de5\u5177\u200b\u94fe","text":"<ul> <li>STM32MP157</li> </ul> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre> <ul> <li>IMX6ULL</li> </ul> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre>"},{"location":"04_I2C/06/#42-i2c-tools","title":"4.2 \u200b\u4f7f\u7528\u200bI2C-Tools\u200b\u7684\u200b\u6e90\u7801","text":""},{"location":"04_I2C/06/#43","title":"4.3 \u200b\u7f16\u8bd1","text":"<p>\u200b\u4e3a\u200bIMX6ULL\u200b\u7f16\u8bd1\u200b\u65f6\u200b\uff0c\u200b\u6709\u200b\u5982\u4e0b\u200b\u9519\u8bef\u200b\uff1a </p> <p>\u200b\u8fd9\u200b\u662f\u56e0\u4e3a\u200bIMX6ULL\u200b\u7684\u200b\u5de5\u5177\u200b\u94fe\u200b\u81ea\u5e26\u200b\u7684\u200binclude\u200b\u76ee\u5f55\u200b\u4e2d\u200b\uff0c\u200b\u6ca1\u6709\u200bsmbus.h\u3002</p> <p>\u200b\u9700\u8981\u200b\u6211\u4eec\u200b\u81ea\u5df1\u200b\u63d0\u4f9b\u200b\u8fd9\u4e2a\u200b\u5934\u6587\u4ef6\u200b\uff0c\u200b\u89e3\u51b3\u200b\u65b9\u6cd5\u200b\uff1a</p> <ul> <li> <p>\u200b\u63d0\u4f9b\u200b\u5934\u6587\u4ef6\u200b\uff1a   </p> </li> <li> <p>\u200b\u4fee\u6539\u200bMakefile\u200b\u6307\u5b9a\u200b\u5934\u200b\u6587\u4ef6\u76ee\u5f55\u200b</p> </li> </ul> <pre><code>all:\n  $(CROSS_COMPILE)gcc -I ./include -o at24c02_test at24c02_test.c i2cbusses.c smbus.c\n</code></pre>"},{"location":"04_I2C/06/#44","title":"4.4 \u200b\u4e0a\u673a\u200b\u6d4b\u8bd5","text":"<p>\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e2d\u200b\u6267\u884c\u200b\u3002</p> <ul> <li> <p>\u200b\u6302\u8f7d\u200bNFS</p> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.1.100)</p> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.1.137</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u200b\u3001\u200b\u6267\u884c\u7a0b\u5e8f\u200b</p> </li> </ul> <p><code>shell   [root@100ask:~]# cp /mnt/at24c02_test   /bin   [root@100ask:~]# at24c02_test 0 w www.100ask.net   [root@100ask:~]# at24c02_test 0 r get data: www.100ask.net</code></p>"},{"location":"04_I2C/07/","title":"07_\u200b\u901a\u7528\u200b\u9a71\u52a8\u200bi2c-dev\u200b\u5206\u6790","text":""},{"location":"04_I2C/07/#i2c-dev","title":"\u901a\u7528\u200b\u9a71\u52a8\u200bi2c-dev\u200b\u5206\u6790","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b: <code>drivers/i2c/i2c-dev.c</code></li> <li>I2C-Tools-4.2: <code>https://mirrors.edge.kernel.org/pub/software/utils/i2c-tools/</code></li> <li>AT24cxx.pdf</li> </ul>"},{"location":"04_I2C/07/#1","title":"1. \u200b\u56de\u987e\u200b\u5b57\u7b26\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>\u200b\u600e\u4e48\u200b\u7f16\u5199\u200b\u5b57\u7b26\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff1f</p> <ul> <li>\u200b\u786e\u5b9a\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u53f7\u200b</li> <li>\u200b\u521b\u5efa\u200bfile_operations\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> <li>\u200b\u5728\u200b\u91cc\u9762\u200b\u586b\u5145\u200bdrv_open/drv_read/drv_ioctl\u200b\u7b49\u200b\u51fd\u6570\u200b</li> <li>\u200b\u6ce8\u518c\u200bfile_operations\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> <li>register_chrdev(major, &amp;fops, name)</li> <li>\u200b\u8c01\u200b\u8c03\u7528\u200bregister_chrdev\uff1f\u200b\u5728\u200b\u5165\u53e3\u200b\u51fd\u6570\u8c03\u7528\u200b</li> <li>\u200b\u6709\u200b\u5165\u53e3\u200b\u81ea\u7136\u200b\u5c31\u200b\u6709\u200b\u51fa\u53e3\u200b</li> <li>\u200b\u5728\u200b\u51fa\u53e3\u200b\u51fd\u6570\u200bunregister_chrdev</li> <li>\u200b\u8f85\u52a9\u200b\u51fd\u6570\u200b(\u200b\u5e2e\u52a9\u200b\u7cfb\u7edf\u200b\u81ea\u52a8\u200b\u521b\u5efa\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b)</li> <li>class_create</li> <li>device_create</li> </ul>"},{"location":"04_I2C/07/#2-i2c-devc","title":"2. i2c-dev.c\u200b\u6ce8\u518c\u200b\u8fc7\u7a0b\u200b\u5206\u6790","text":"<p>#### 2.1 register_chrdev\u200b\u7684\u200b\u5185\u90e8\u200b\u5b9e\u73b0\u200b</p> <p></p>"},{"location":"04_I2C/07/#22-i2c-dev","title":"2.2 i2c-dev\u200b\u9a71\u52a8\u200b\u7684\u200b\u6ce8\u518c\u200b\u8fc7\u7a0b","text":""},{"location":"04_I2C/07/#3-file_operations","title":"3. file_operations\u200b\u51fd\u6570\u200b\u5206\u6790","text":"<p>i2c-dev.c\u200b\u7684\u200b\u6838\u5fc3\u200b\uff1a</p> <pre><code>static const struct file_operations i2cdev_fops = {\n    .owner      = THIS_MODULE,\n    .llseek     = no_llseek,\n    .read       = i2cdev_read,\n    .write      = i2cdev_write,\n    .unlocked_ioctl = i2cdev_ioctl,\n    .compat_ioctl   = compat_i2cdev_ioctl,\n    .open       = i2cdev_open,\n    .release    = i2cdev_release,\n};\n</code></pre> <p>\u200b\u4e3b\u8981\u200b\u7684\u200b\u7cfb\u7edf\u200b\u8c03\u7528\u200b\uff1aopen, ioctl\uff1a </p> <p>\u200b\u8981\u200b\u7406\u89e3\u200b\u8fd9\u4e9b\u200b\u63a5\u53e3\u200b\uff0c\u200b\u8bb0\u4f4f\u200b\u4e00\u53e5\u200b\u8bdd\u200b\uff1aAPP\u200b\u901a\u8fc7\u200bI2C Controller\u200b\u4e0e\u200bI2C Device\u200b\u4f20\u8f93\u6570\u636e\u200b\u3002</p>"},{"location":"04_I2C/07/#31-i2cdev_open","title":"3.1 i2cdev_open","text":""},{"location":"04_I2C/07/#32-i2cdev_ioctl-i2c_slavei2c_slave_force","title":"3.2 i2cdev_ioctl: I2C_SLAVE/I2C_SLAVE_FORCE","text":""},{"location":"04_I2C/07/#33-i2cdev_ioctl-i2c_rdwr","title":"3.3 i2cdev_ioctl: I2C_RDWR","text":""},{"location":"04_I2C/07/#34-i2cdev_ioctl-i2c_smbus","title":"3.4 i2cdev_ioctl: I2C_SMBUS","text":""},{"location":"04_I2C/07/#35","title":"3.5 \u200b\u603b\u7ed3","text":""},{"location":"04_I2C/08_1/","title":"08_I2C\u200b\u7cfb\u7edf\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6a21\u578b","text":""},{"location":"04_I2C/08_1/#i2c","title":"I2C\u200b\u7cfb\u7edf\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6a21\u578b","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux\u200b\u5185\u6838\u200b\u6587\u6863\u200b:</li> <li><code>Documentation\\i2c\\instantiating-devices.rst</code></li> <li><code>Documentation\\i2c\\writing-clients.rst</code></li> <li>Linux\u200b\u5185\u6838\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u793a\u4f8b\u200b:</li> <li><code>drivers/eeprom/at24.c</code></li> </ul>"},{"location":"04_I2C/08_1/#1-i2c","title":"1. I2C\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u7684\u200b\u5c42\u6b21","text":"<p>I2C Core\u200b\u5c31\u662f\u200bI2C\u200b\u6838\u5fc3\u5c42\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u4f5c\u7528\u200b\uff1a</p> <ul> <li>\u200b\u63d0\u4f9b\u200b\u7edf\u4e00\u200b\u7684\u200b\u8bbf\u95ee\u200b\u51fd\u6570\u200b\uff0c\u200b\u6bd4\u5982\u200bi2c_transfer\u3001i2c_smbus_xfer\u200b\u7b49\u200b</li> <li>\u200b\u5b9e\u73b0\u200b<code>I2C\u200b\u603b\u7ebf\u200b-\u200b\u8bbe\u5907\u200b-\u200b\u9a71\u52a8\u200b\u6a21\u578b\u200b</code>\uff0c\u200b\u7ba1\u7406\u200b\uff1aI2C\u200b\u8bbe\u5907\u200b(i2c_client)\u3001I2C\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b(i2c_driver)\u3001I2C\u200b\u63a7\u5236\u5668\u200b(i2c_adapter)</li> </ul>"},{"location":"04_I2C/08_1/#2-i2c-","title":"2. I2C\u200b\u603b\u7ebf\u200b-\u200b\u8bbe\u5907\u200b-\u200b\u9a71\u52a8\u200b\u6a21\u578b","text":""},{"location":"04_I2C/08_1/#21-i2c_driver","title":"2.1 i2c_driver","text":"<p>i2c_driver\u200b\u8868\u660e\u200b\u80fd\u200b\u652f\u6301\u200b\u54ea\u4e9b\u200b\u8bbe\u5907\u200b\uff1a</p> <ul> <li>\u200b\u4f7f\u7528\u200bof_match_table\u200b\u6765\u200b\u5224\u65ad\u200b</li> <li>\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\uff0c\u200b\u67d0\u4e2a\u200bI2C\u200b\u63a7\u5236\u5668\u200b\u8282\u70b9\u200b\u4e0b\u200b\u53ef\u4ee5\u200b\u521b\u5efa\u200bI2C\u200b\u8bbe\u5907\u200b\u7684\u200b\u8282\u70b9\u200b<ul> <li>\u200b\u5982\u679c\u200bI2C\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u7684\u200bcompatible\u200b\u5c5e\u6027\u200b\u8ddf\u200bof_match_table\u200b\u7684\u200b\u67d0\u9879\u200b\u517c\u5bb9\u200b\uff0c\u200b\u5219\u200b\u5339\u914d\u200b\u6210\u529f\u200b</li> </ul> </li> <li>i2c_client.name\u200b\u8ddf\u200b\u67d0\u4e2a\u200bof_match_table[i].compatible\u200b\u503c\u200b\u76f8\u540c\u200b\uff0c\u200b\u5219\u200b\u5339\u914d\u200b\u6210\u529f\u200b</li> <li>\u200b\u4f7f\u7528\u200bid_table\u200b\u6765\u200b\u5224\u65ad\u200b</li> <li>i2c_client.name\u200b\u8ddf\u200b\u67d0\u4e2a\u200bid_table[i].name\u200b\u503c\u200b\u76f8\u540c\u200b\uff0c\u200b\u5219\u200b\u5339\u914d\u200b\u6210\u529f\u200b</li> </ul> <p>i2c_driver\u200b\u8ddf\u200bi2c_client\u200b\u5339\u914d\u200b\u6210\u529f\u200b\u540e\u200b\uff0c\u200b\u5c31\u200b\u8c03\u7528\u200bi2c_driver.probe\u200b\u51fd\u6570\u200b\u3002</p>"},{"location":"04_I2C/08_1/#22-i2c_client","title":"2.2 i2c_client","text":"<p>i2c_client\u200b\u8868\u793a\u200b\u4e00\u4e2a\u200bI2C\u200b\u8bbe\u5907\u200b\uff0c\u200b\u521b\u5efa\u200bi2c_client\u200b\u7684\u200b\u65b9\u6cd5\u200b\u6709\u200b4\u200b\u79cd\u200b\uff1a</p> <ul> <li> <p>\u200b\u65b9\u6cd5\u200b1</p> </li> <li> <p>\u200b\u901a\u8fc7\u200bI2C bus number\u200b\u6765\u200b\u521b\u5efa\u200b</p> <pre><code>int i2c_register_board_info(int busnum, struct i2c_board_info const *info, unsigned len);\n</code></pre> </li> <li> <p>\u200b\u901a\u8fc7\u200b\u8bbe\u5907\u200b\u6811\u6765\u200b\u521b\u5efa\u200b</p> <pre><code>    i2c1: i2c@400a0000 {\n        /* ... master properties skipped ... */\n        clock-frequency = &lt;100000&gt;;\n\n        flash@50 {\n            compatible = \"atmel,24c256\";\n            reg = &lt;0x50&gt;;\n        };\n\n        pca9532: gpio@60 {\n            compatible = \"nxp,pca9532\";\n            gpio-controller;\n            #gpio-cells = &lt;2&gt;;\n            reg = &lt;0x60&gt;;\n        };\n    };\n</code></pre> </li> <li> <p>\u200b\u65b9\u6cd5\u200b2   \u200b\u6709\u65f6\u5019\u200b\u65e0\u6cd5\u200b\u77e5\u9053\u200b\u8be5\u200b\u8bbe\u5907\u200b\u6302\u8f7d\u200b\u54ea\u4e2a\u200bI2C bus\u200b\u4e0b\u200b\uff0c\u200b\u65e0\u6cd5\u200b\u77e5\u9053\u200b\u5b83\u200b\u5bf9\u5e94\u200b\u7684\u200bI2C bus number\u3002   \u200b\u4f46\u662f\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200b\u5176\u4ed6\u200b\u65b9\u6cd5\u200b\u77e5\u9053\u200b\u5bf9\u5e94\u200b\u7684\u200bi2c_adapter\u200b\u7ed3\u6784\u200b\u4f53\u200b\u3002   \u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u4e0b\u9762\u200b\u4e24\u4e2a\u200b\u51fd\u6570\u200b\u6765\u200b\u521b\u5efa\u200bi2c_client\uff1a</p> </li> <li> <p>i2c_new_device</p> <pre><code>  static struct i2c_board_info sfe4001_hwmon_info = {\n    I2C_BOARD_INFO(\"max6647\", 0x4e),\n  };\n\n  int sfe4001_init(struct efx_nic *efx)\n  {\n    (...)\n    efx-&gt;board_info.hwmon_client =\n        i2c_new_device(&amp;efx-&gt;i2c_adap, &amp;sfe4001_hwmon_info);\n\n    (...)\n  }\n</code></pre> </li> <li> <p>i2c_new_probed_device</p> <pre><code>  static const unsigned short normal_i2c[] = { 0x2c, 0x2d, I2C_CLIENT_END };\n\n  static int usb_hcd_nxp_probe(struct platform_device *pdev)\n  {\n    (...)\n    struct i2c_adapter *i2c_adap;\n    struct i2c_board_info i2c_info;\n\n    (...)\n    i2c_adap = i2c_get_adapter(2);\n    memset(&amp;i2c_info, 0, sizeof(struct i2c_board_info));\n    strscpy(i2c_info.type, \"isp1301_nxp\", sizeof(i2c_info.type));\n    isp1301_i2c_client = i2c_new_probed_device(i2c_adap, &amp;i2c_info,\n                           normal_i2c, NULL);\n    i2c_put_adapter(i2c_adap);\n    (...)\n  }\n</code></pre> </li> <li> <p>\u200b\u5dee\u522b\u200b\uff1a</p> <ul> <li> <p>i2c_new_device\uff1a\u200b\u4f1a\u200b\u521b\u5efa\u200bi2c_client\uff0c\u200b\u5373\u4f7f\u200b\u8be5\u200b\u8bbe\u5907\u200b\u5e76\u200b\u4e0d\u200b\u5b58\u5728\u200b</p> </li> <li> <p>i2c_new_probed_device\uff1a</p> </li> <li> <p>\u200b\u5b83\u200b\u6210\u529f\u200b\u7684\u8bdd\u200b\uff0c\u200b\u4f1a\u200b\u521b\u5efa\u200bi2c_client\uff0c\u200b\u5e76\u4e14\u200b\u8868\u793a\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u80af\u5b9a\u200b\u5b58\u5728\u200b</p> </li> <li> <p>I2C\u200b\u8bbe\u5907\u200b\u7684\u200b\u5730\u5740\u200b\u53ef\u80fd\u200b\u53d1\u751f\u53d8\u5316\u200b\uff0c\u200b\u6bd4\u5982\u200bAT24C02\u200b\u7684\u200b\u5f15\u811a\u200bA2A1A0\u200b\u7535\u5e73\u200b\u4e0d\u200b\u4e00\u6837\u200b\u65f6\u200b\uff0c\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\u5c31\u200b\u4e0d\u200b\u4e00\u6837\u200b</p> </li> <li> <p>\u200b\u53ef\u4ee5\u200b\u7f57\u5217\u200b\u51fa\u200b\u53ef\u80fd\u200b\u7684\u200b\u5730\u5740\u200b</p> </li> <li> <p>i2c_new_probed_device\u200b\u4f7f\u7528\u200b\u8fd9\u4e9b\u200b\u5730\u5740\u200b\u5224\u65ad\u200b\u8bbe\u5907\u200b\u662f\u5426\u200b\u5b58\u5728\u200b</p> </li> </ul> </li> <li> <p>\u200b\u65b9\u6cd5\u200b3(\u200b\u4e0d\u200b\u63a8\u8350\u200b)\uff1a\u200b\u7531\u200bi2c_driver.detect\u200b\u51fd\u6570\u200b\u6765\u200b\u5224\u65ad\u200b\u662f\u5426\u200b\u6709\u200b\u5bf9\u5e94\u200b\u7684\u200bI2C\u200b\u8bbe\u5907\u200b\u5e76\u200b\u751f\u6210\u200bi2c_client</p> </li> <li> <p>\u200b\u65b9\u6cd5\u200b4\uff1a\u200b\u901a\u8fc7\u200b\u7528\u6237\u200b\u7a7a\u95f4\u200b(user-space)\u200b\u751f\u6210\u200b \u200b\u8c03\u8bd5\u200b\u65f6\u200b\u3001\u200b\u6216\u8005\u200b\u4e0d\u200b\u65b9\u4fbf\u200b\u901a\u8fc7\u200b\u4ee3\u7801\u200b\u660e\u786e\u200b\u5730\u200b\u751f\u6210\u200bi2c_client\u200b\u65f6\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200b\u7528\u6237\u200b\u7a7a\u95f4\u200b\u6765\u200b\u751f\u6210\u200b\u3002</p> </li> </ul> <pre><code>  // \u200b\u521b\u5efa\u200b\u4e00\u4e2a\u200bi2c_client, .name = \"eeprom\", .addr=0x50, .adapter\u200b\u662f\u200bi2c-3\n  # echo eeprom 0x50 &gt; /sys/bus/i2c/devices/i2c-3/new_device\n\n  // \u200b\u5220\u9664\u200b\u4e00\u4e2a\u200bi2c_client\n  # echo 0x50 &gt; /sys/bus/i2c/devices/i2c-3/delete_device\n</code></pre> <p>\u200b      </p> <p>\u200b      </p>"},{"location":"04_I2C/09/","title":"09_\u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u4e4b\u200bi2c_driver","text":""},{"location":"04_I2C/09/#i2c_driver","title":"\u7f16\u5199\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u4e4b\u200bi2c_driver","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux\u200b\u5185\u6838\u200b\u6587\u6863\u200b:</li> <li><code>Documentation\\i2c\\instantiating-devices.rst</code></li> <li><code>Documentation\\i2c\\writing-clients.rst</code></li> <li>Linux\u200b\u5185\u6838\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u793a\u4f8b\u200b:</li> <li><code>drivers/eeprom/at24.c</code></li> <li>\u200b\u672c\u200b\u8282\u200b\u4ee3\u7801\u200b\uff1aGIT\u200b\u4ed3\u5e93\u200b\u4e2d\u200b</li> <li>\u200b\u6846\u67b6\u200b\uff1a<ul> <li><code>IMX6ULL\\source\\04_I2C\\02_i2c_driver_example</code></li> <li><code>STM32MP157\\source\\A7\\04_I2C\\02_i2c_driver_example</code></li> </ul> </li> <li>AP3216C<ul> <li><code>IMX6ULL\\source\\04_I2C\\03_ap3216c</code></li> <li><code>STM32MP157\\source\\A7\\04_I2C\\03_ap3216c</code></li> </ul> </li> </ul>"},{"location":"04_I2C/09/#1","title":"1. \u200b\u5957\u8def","text":""},{"location":"04_I2C/09/#11-i2c-","title":"1.1 I2C\u200b\u603b\u7ebf\u200b-\u200b\u8bbe\u5907\u200b-\u200b\u9a71\u52a8\u200b\u6a21\u578b","text":""},{"location":"04_I2C/09/#12","title":"1.2 \u200b\u793a\u4f8b","text":"<p>\u200b\u5206\u914d\u200b\u3001\u200b\u8bbe\u7f6e\u200b\u3001\u200b\u6ce8\u518c\u200b\u4e00\u4e2a\u200bi2c_driver\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u7c7b\u4f3c\u200b<code>drivers/eeprom/at24.c</code>\uff1a </p> <p>\u200b\u5728\u200bprobe_new\u200b\u51fd\u6570\u200b\u4e2d\u200b\uff0c\u200b\u5206\u914d\u200b\u3001\u200b\u8bbe\u7f6e\u200b\u3001\u200b\u6ce8\u518c\u200bfile_operations\u200b\u7ed3\u6784\u200b\u4f53\u200b\u3002 \u200b\u5728\u200bfile_operations\u200b\u7684\u200b\u51fd\u6570\u200b\u4e2d\u200b\uff0c\u200b\u4f7f\u7528\u200bi2c_transfer\u200b\u7b49\u200b\u51fd\u6570\u200b\u53d1\u8d77\u200bI2C\u200b\u4f20\u8f93\u200b\u3002</p>"},{"location":"04_I2C/09/#2-i2c_driver","title":"2. \u200b\u7f16\u5199\u200bi2c_driver","text":""},{"location":"04_I2C/09/#21","title":"2.1 \u200b\u5148\u5199\u200b\u4e00\u4e2a\u200b\u6846\u67b6","text":""},{"location":"04_I2C/09/#22-ap3216c","title":"2.2 \u200b\u5728\u200b\u4e3a\u200bAP3216C\u200b\u7f16\u5199\u200b\u4ee3\u7801","text":"<p>\u200b\u767e\u95ee\u200b\u7f51\u200b\u7684\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6709\u200b\u5149\u611f\u200b\u82af\u7247\u200bAP3216C\uff1a </p> <p>AP3216C\u200b\u662f\u200b\u7ea2\u5916\u200b\u3001\u200b\u5149\u5f3a\u200b\u3001\u200b\u8ddd\u79bb\u200b\u4e09\u5408\u4e00\u200b\u7684\u200b\u4f20\u611f\u5668\u200b\uff0c\u200b\u4ee5\u200b\u8bfb\u51fa\u200b\u5149\u5f3a\u200b\u3001\u200b\u8ddd\u79bb\u200b\u503c\u4e3a\u4f8b\u200b\uff0c\u200b\u6b65\u9aa4\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u590d\u4f4d\u200b\uff1a\u200b\u5f80\u200b\u5bc4\u5b58\u5668\u200b0\u200b\u5199\u5165\u200b0x4</li> <li>\u200b\u4f7f\u80fd\u200b\uff1a\u200b\u5f80\u200b\u5bc4\u5b58\u5668\u200b0\u200b\u5199\u5165\u200b0x3</li> <li>\u200b\u8bfb\u200b\u7ea2\u5916\u200b\uff1a\u200b\u8bfb\u200b\u5bc4\u5b58\u5668\u200b0xA\u30010xB\u200b\u5f97\u5230\u200b2\u200b\u5b57\u8282\u200b\u7684\u200b\u7ea2\u5916\u200b\u6570\u636e\u200b</li> <li>\u200b\u8bfb\u200b\u5149\u5f3a\u200b\uff1a\u200b\u8bfb\u200b\u5bc4\u5b58\u5668\u200b0xC\u30010xD\u200b\u5f97\u5230\u200b2\u200b\u5b57\u8282\u200b\u7684\u200b\u5149\u5f3a\u200b</li> <li>\u200b\u8bfb\u200b\u8ddd\u79bb\u200b\uff1a\u200b\u8bfb\u200b\u5bc4\u5b58\u5668\u200b0xE\u30010xF\u200b\u5f97\u5230\u200b2\u200b\u5b57\u8282\u200b\u7684\u200b\u8ddd\u79bb\u200b\u503c\u200b</li> </ul> <p>AP3216C\u200b\u7684\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\u662f\u200b0x1E\u3002</p>"},{"location":"04_I2C/09/#3-i2c_client","title":"3. \u200b\u6784\u9020\u200bi2c_client","text":"<p>\u200b\u4e0b\u8282\u200b\u89c6\u9891\u200b\u3002</p>"},{"location":"04_I2C/10/","title":"10_\u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u4e4b\u200bi2c_client","text":""},{"location":"04_I2C/10/#i2c_client","title":"\u7f16\u5199\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u4e4b\u200bi2c_client","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux\u200b\u5185\u6838\u200b\u6587\u6863\u200b:</li> <li><code>Documentation\\i2c\\instantiating-devices.rst</code></li> <li> <p><code>Documentation\\i2c\\writing-clients.rst</code></p> </li> <li> <p>Linux\u200b\u5185\u6838\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u793a\u4f8b\u200b:</p> </li> <li> <p><code>drivers/eeprom/at24.c</code></p> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u4ee3\u7801\u200b\uff1aGIT\u200b\u4ed3\u5e93\u200b\u4e2d\u200b</p> </li> <li> <p><code>IMX6ULL\\source\\04_I2C\\03_ap3216c_ok</code></p> </li> <li> <p><code>STM32MP157\\source\\A7\\04_I2C\\03_ap3216c_ok</code></p> </li> </ul>"},{"location":"04_I2C/10/#1-i2c-","title":"1. I2C\u200b\u603b\u7ebf\u200b-\u200b\u8bbe\u5907\u200b-\u200b\u9a71\u52a8\u200b\u6a21\u578b","text":""},{"location":"04_I2C/10/#2-i2c_driver","title":"2. \u200b\u7f16\u8bd1\u200bi2c_driver","text":"<ul> <li> <p>\u200b\u589e\u52a0\u200bMakefile</p> </li> <li> <p>\u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe\u200b</p> </li> <li> <p>IMX6ULL</p> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre> </li> <li> <p>STM32MP157</p> <pre><code>source /home/book/100ask_stm32mp157_pro-sdk/ToolChain/openstlinux_eglfs-linux-gnueabi/environment-setup-cortexa7t2hf-neon-vfpv4-ostl-linux-gnueabi\nexport ARCH=arm\nexport CROSS_COMPILE=arm-ostl-linux-gnueabi-\n</code></pre> </li> <li> <p>\u200b\u7f16\u8bd1\u200b</p> </li> </ul>"},{"location":"04_I2C/10/#3","title":"3. \u200b\u7f16\u5199\u200b\u6d4b\u8bd5\u7a0b\u5e8f","text":"<ul> <li> <p>\u200b\u7f16\u7a0b\u200b</p> </li> <li> <p>\u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe\u200b</p> </li> <li> <p>IMX6ULL</p> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre> </li> <li> <p>STM32MP157     \u200b\u6ce8\u610f\u200b\uff1a\u200b\u5bf9\u4e8e\u200bSTM32MP157\uff0c\u200b\u7f16\u8bd1\u200b\u5185\u6838\u200b/\u200b\u9a71\u52a8\u200b\u3001\u200b\u7f16\u8bd1\u200bAPP\u200b\u7684\u200b\u5de5\u5177\u200b\u94fe\u200b\u4e0d\u200b\u4e00\u6837\u200b</p> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre> </li> <li> <p>\u200b\u7f16\u8bd1\u200b</p> </li> </ul> <pre><code>// imx6ull\narm-linux-gnueabihf-gcc -o ap3216c_drv_test ap3216c_drv_test.c\n\n// stm32mp157\narm-buildroot-linux-gnueabihf-gcc -o ap3216c_drv_test ap3216c_drv_test.c\n</code></pre>"},{"location":"04_I2C/10/#4-i2c_client","title":"4. \u200b\u591a\u79cd\u200b\u65b9\u6cd5\u200b\u751f\u6210\u200bi2c_client\u200b\u5e76\u200b\u6d4b\u8bd5","text":""},{"location":"04_I2C/10/#41","title":"4.1 \u200b\u5728\u200b\u7528\u6237\u200b\u6001\u200b\u751f\u6210","text":"<p>\u200b\u793a\u4f8b\u200b\uff1a</p> <pre><code>// \u200b\u5728\u200bI2C BUS0\u200b\u4e0b\u200b\u521b\u5efa\u200bi2c_client\n# echo ap3216c 0x1e &gt; /sys/bus/i2c/devices/i2c-0/new_device\n\n// \u200b\u5220\u9664\u200bi2c_client\n# echo 0x1e &gt; /sys/bus/i2c/devices/i2c-0/delete_device\n</code></pre>"},{"location":"04_I2C/10/#42","title":"4.2 \u200b\u7f16\u5199\u200b\u4ee3\u7801","text":"<ul> <li>i2c_new_device</li> <li>i2c_new_probed_device</li> <li>i2c_register_board_info</li> <li>\u200b\u5185\u6838\u200b\u6ca1\u6709\u200b<code>EXPORT_SYMBOL(i2c_register_board_info)</code></li> <li>\u200b\u4f7f\u7528\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u7684\u200b\u9a71\u52a8\u200b\u5fc5\u987b\u200b\u7f16\u8fdb\u200b\u5185\u6838\u200b\u91cc\u200b\u53bb\u200b</li> </ul>"},{"location":"04_I2C/10/#43","title":"4.3 \u200b\u4f7f\u7528\u200b\u8bbe\u5907\u200b\u6811\u200b\u751f\u6210","text":"<p>\u200b\u5728\u200b\u67d0\u4e2a\u200bI2C\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u8282\u70b9\u200b\u4e0b\u200b\uff0c\u200b\u6dfb\u52a0\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>        ap3216c@1e {\n            compatible = \"lite-on,ap3216c\";\n            reg = &lt;0x1e&gt;;\n        };\n</code></pre>"},{"location":"04_I2C/10/#1-stm32mp157","title":"1. STM32MP157","text":"<ul> <li> <p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dts</code>\uff0c\u200b\u6dfb\u52a0\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>&amp;i2c1 {\n        ap3216c@1e {\n            compatible = \"lite-on,ap3216c\";\n            reg = &lt;0x1e&gt;;\n        };\n};\n</code></pre> <p>\u200b\u6ce8\u610f\u200b\uff1a\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200bi2c1\u200b\u5c31\u662f\u200bI2C BUS0\u3002</p> </li> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bSTM32MP157\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u6811\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b\u54ea\u91cc\u200b</p> <p>\u200b\u7531\u4e8e\u200b\u7248\u672c\u200b\u53d8\u5316\u200b\uff0cSTM32MP157\u200b\u5355\u677f\u200b\u4e0a\u200b\u70e7\u5f55\u200b\u7684\u200b\u7cfb\u7edf\u200b\u53ef\u80fd\u200b\u6709\u200b\u7ec6\u5fae\u5dee\u522b\u200b\u3002 \u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b<code>cat /proc/mounts</code>\u200b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u4e24\u79cd\u200b\u7ed3\u679c\u200b(\u200b\u89c1\u200b\u4e0b\u56fe\u200b)\uff1a</p> <ul> <li> <p>mmcblk2p2\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u5de6\u8fb9\u200b)\uff1a\u200b\u65e0\u9700\u200b\u7279\u6b8a\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u4e0b\u9762\u200b\u628a\u200b\u6587\u4ef6\u200b\u590d\u5236\u5230\u200b/boot\u200b\u76ee\u5f55\u200b\u5373\u53ef\u200b</p> </li> <li> <p>mmcblk2p2\u200b\u6302\u8f7d\u200b\u5728\u200b/mnt\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u53f3\u8fb9\u200b)</p> </li> <li> <p>\u200b\u5728\u200b\u89c6\u9891\u200b\u91cc\u200b\u3001\u200b\u540e\u9762\u200b\u6587\u6863\u200b\u91cc\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u66f4\u65b0\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u7684\u200b\u6587\u4ef6\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8981\u200b\u5148\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u91cd\u65b0\u200b\u6302\u8f7d\u200b\uff1a</p> <ul> <li><code>mount  /dev/mmcblk2p2  /boot</code></li> </ul> </li> </ul> <p></p> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/stm32mp157c-100ask-512d-lcd-v1.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"04_I2C/10/#2-imx6ull","title":"2. IMX6ULL","text":"<ul> <li> <p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code>\uff0c\u200b\u6dfb\u52a0\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>&amp;i2c1 {\n        ap3216c@1e {\n            compatible = \"lite-on,ap3216c\";\n            reg = &lt;0x1e&gt;;\n        };\n};\n</code></pre> <p>\u200b\u6ce8\u610f\u200b\uff1a\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200bi2c1\u200b\u5c31\u662f\u200bI2C BUS0\u3002</p> </li> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bIMX6ULL\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/100ask_imx6ull-14x14.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/100ask_imx6ull-14x14.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"04_I2C/10/#44","title":"4.4 \u200b\u4e0a\u673a\u200b\u6d4b\u8bd5","text":"<p>\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e2d\u200b\u6267\u884c\u200b\u3002</p> <ul> <li> <p>\u200b\u6302\u8f7d\u200bNFS</p> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.1.100)</p> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.1.137</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u200b\u3001\u200b\u6267\u884c\u7a0b\u5e8f\u200b</p> </li> </ul> <p>\u200b\u770b\u200b\u89c6\u9891\u200b\u3002</p> <ul> <li> <p>\u200b\u5148\u200b\u5b89\u88c5\u200bi2c_driver\u200b\u9a71\u52a8\u200b</p> <pre><code>// \u200b\u5bf9\u4e8e\u200bIMX6ULL\uff0c\u200b\u60f3\u200b\u770b\u5230\u200b\u9a71\u52a8\u200b\u6253\u5370\u4fe1\u606f\u200b\uff0c\u200b\u9700\u8981\u200b\u5148\u200b\u6267\u884c\u200b\necho \"7 4 1 7\" &gt; /proc/sys/kernel/printk\n\ninsmod /mnt/ap3216c_drv.ko\n</code></pre> </li> <li> <p>\u200b\u5728\u200b\u751f\u6210\u200bi2c_client     \u200b\u6709\u200b3\u200b\u79cd\u200b\u65b9\u6cd5\u200b\uff0c\u200b\u524d\u9762\u200b\u4ecb\u7ecd\u200b\u4e86\u200b\uff1a\u200b\u7528\u6237\u200b\u6001\u200b\u751f\u6210\u200b\u3001\u200b\u5b89\u88c5\u200bap3216c_client\u200b\u9a71\u52a8\u200b\u3001\u200b\u4f7f\u7528\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> <li> <p>\u200b\u6267\u884c\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b</p> <pre><code>[root@100ask:~]# /mnt/ap3216c_drv_test\nAPP read : 01 00 00 00 8f bf\n</code></pre> </li> </ul>"},{"location":"04_I2C/11/","title":"11_I2C_Adapter\u200b\u9a71\u52a8\u200b\u6846\u67b6\u200b\u8bb2\u89e3\u200b\u4e0e\u200b\u7f16\u5199","text":""},{"location":"04_I2C/11/#i2c_adapter","title":"I2C_Adapter\u200b\u9a71\u52a8\u200b\u6846\u67b6\u200b\u8bb2\u89e3\u200b\u4e0e\u200b\u7f16\u5199","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux\u200b\u5185\u6838\u200b\u6587\u6863\u200b:</li> <li><code>Linux-4.9.88\\Documentation\\devicetree\\bindings\\i2c\\i2c-gpio.txt</code></li> <li> <p><code>Linux-5.4\\Documentation\\devicetree\\bindings\\i2c\\i2c-gpio.yaml</code></p> </li> <li> <p>Linux\u200b\u5185\u6838\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff1a\u200b\u4f7f\u7528\u200bGPIO\u200b\u6a21\u62df\u200bI2C</p> </li> <li> <p><code>Linux-4.9.88\\drivers\\i2c\\busses\\i2c-gpio.c</code></p> </li> <li> <p><code>Linux-5.4\\drivers\\i2c\\busses\\i2c-gpio.c</code></p> </li> <li> <p>Linux\u200b\u5185\u6838\u200b\u771f\u6b63\u200b\u7684\u200bI2C\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b</p> </li> <li> <p>IMX6ULL: <code>Linux-4.9.88\\drivers\\i2c\\busses\\i2c-imx.c</code></p> </li> <li>STM32MP157: <code>Linux-5.4\\drivers\\i2c\\busses\\i2c-stm32f7.c</code></li> <li>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u7684\u200b\u4ee3\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b</li> <li>IMX6ULL\uff1a<code>doc_and_source_for_drivers\\IMX6ULL\\source\\04_I2C\\05_i2c_adapter_framework</code></li> <li>STM32MP157\uff1a<code>doc_and_source_for_drivers\\STM32MP157\\source\\A7\\04_I2C\\05_i2c_adapter_framework</code></li> </ul>"},{"location":"04_I2C/11/#1","title":"1. \u200b\u56de\u987e","text":""},{"location":"04_I2C/11/#11-2c","title":"1.1 2C\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u7684\u200b\u5c42\u6b21","text":""},{"location":"04_I2C/11/#12-i2c-","title":"1.2 I2C\u200b\u603b\u7ebf\u200b-\u200b\u8bbe\u5907\u200b-\u200b\u9a71\u52a8\u200b\u6a21\u578b","text":""},{"location":"04_I2C/11/#2-i2c_adapter","title":"2. I2C_Adapter\u200b\u9a71\u52a8\u200b\u6846\u67b6","text":""},{"location":"04_I2C/11/#21","title":"2.1 \u200b\u6838\u5fc3\u200b\u7684\u200b\u7ed3\u6784\u200b\u4f53","text":""},{"location":"04_I2C/11/#1-i2c_adapter","title":"1. i2c_adapter","text":""},{"location":"04_I2C/11/#2-i2c_algorithm","title":"2. i2c_algorithm","text":"<ul> <li> <p>master_xfer\uff1a\u200b\u8fd9\u200b\u662f\u200b\u6700\u200b\u91cd\u8981\u200b\u7684\u200b\u51fd\u6570\u200b\uff0c\u200b\u5b83\u200b\u5b9e\u73b0\u200b\u4e86\u200b\u4e00\u822c\u200b\u7684\u200bI2C\u200b\u4f20\u8f93\u200b\uff0c\u200b\u7528\u6765\u200b\u4f20\u8f93\u200b\u4e00\u4e2a\u200b\u6216\u200b\u591a\u4e2a\u200bi2c_msg</p> </li> <li> <p>master_xfer_atomic\uff1a</p> </li> <li> <p>\u200b\u53ef\u9009\u200b\u7684\u200b\u51fd\u6570\u200b\uff0c\u200b\u529f\u80fd\u200b\u8ddf\u200bmaster_xfer\u200b\u4e00\u6837\u200b\uff0c\u200b\u5728\u200b<code>atomic context</code>\u200b\u73af\u5883\u200b\u4e0b\u200b\u4f7f\u7528\u200b</p> </li> <li> <p>\u200b\u6bd4\u5982\u200b\u5728\u200b\u5173\u673a\u200b\u4e4b\u524d\u200b\u3001\u200b\u6240\u6709\u200b\u4e2d\u65ad\u200b\u90fd\u200b\u5173\u95ed\u200b\u7684\u200b\u60c5\u51b5\u200b\u4e0b\u200b\uff0c\u200b\u7528\u6765\u200b\u8bbf\u95ee\u200b\u7535\u6e90\u200b\u7ba1\u7406\u200b\u82af\u7247\u200b</p> </li> <li> <p>smbus_xfer\uff1a\u200b\u5b9e\u73b0\u200bSMBus\u200b\u4f20\u8f93\u200b\uff0c\u200b\u5982\u679c\u200b\u4e0d\u200b\u63d0\u4f9b\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\uff0cSMBus\u200b\u4f20\u8f93\u200b\u4f1a\u200b\u4f7f\u7528\u200bmaster_xfer\u200b\u6765\u200b\u6a21\u62df\u200b</p> </li> <li> <p>smbus_xfer_atomic\uff1a</p> </li> <li> <p>\u200b\u53ef\u9009\u200b\u7684\u200b\u51fd\u6570\u200b\uff0c\u200b\u529f\u80fd\u200b\u8ddf\u200bsmbus_xfer\u200b\u4e00\u6837\u200b\uff0c\u200b\u5728\u200b<code>atomic context</code>\u200b\u73af\u5883\u200b\u4e0b\u200b\u4f7f\u7528\u200b</p> </li> <li> <p>\u200b\u6bd4\u5982\u200b\u5728\u200b\u5173\u673a\u200b\u4e4b\u524d\u200b\u3001\u200b\u6240\u6709\u200b\u4e2d\u65ad\u200b\u90fd\u200b\u5173\u95ed\u200b\u7684\u200b\u60c5\u51b5\u200b\u4e0b\u200b\uff0c\u200b\u7528\u6765\u200b\u8bbf\u95ee\u200b\u7535\u6e90\u200b\u7ba1\u7406\u200b\u82af\u7247\u200b</p> </li> <li> <p>functionality\uff1a\u200b\u8fd4\u56de\u200b\u6240\u200b\u652f\u6301\u200b\u7684\u200bflags\uff1a\u200b\u5404\u7c7b\u200bI2C_FUNC_*</p> </li> <li> <p>reg_slave/unreg_slave\uff1a</p> </li> <li> <p>\u200b\u6709\u4e9b\u200bI2C Adapter\u200b\u4e5f\u200b\u53ef\u200b\u5de5\u4f5c\u200b\u4e0e\u200bSlave\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u7528\u6765\u200b\u5b9e\u73b0\u200b\u6216\u200b\u6a21\u62df\u200b\u4e00\u4e2a\u200bI2C\u200b\u8bbe\u5907\u200b</p> </li> <li>reg_slave\u200b\u5c31\u662f\u200b\u8ba9\u200b\u628a\u200b\u4e00\u4e2a\u200bi2c_client\u200b\u6ce8\u518c\u200b\u5230\u200bI2C Adapter\uff0c\u200b\u6362\u53e5\u8bdd\u8bf4\u200b\u5c31\u662f\u200b\u8ba9\u200b\u8fd9\u4e2a\u200bI2C Adapter\u200b\u6a21\u62df\u200b\u8be5\u200bi2c_client</li> <li>unreg_slave\uff1a\u200b\u53cd\u200b\u6ce8\u518c\u200b</li> </ul>"},{"location":"04_I2C/11/#22","title":"2.2 \u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":"<p>\u200b\u5206\u914d\u200b\u3001\u200b\u8bbe\u7f6e\u200b\u3001\u200b\u6ce8\u518c\u200b\u4e00\u4e2a\u200bi2c_adpater\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff1a</p> <ul> <li>i2c_adpater\u200b\u7684\u200b\u6838\u5fc3\u200b\u662f\u200bi2c_algorithm</li> <li>i2c_algorithm\u200b\u7684\u200b\u6838\u5fc3\u200b\u662f\u200bmaster_xfer\u200b\u51fd\u6570\u200b</li> </ul>"},{"location":"04_I2C/11/#1_1","title":"1. \u200b\u6240\u200b\u6d89\u53ca\u200b\u7684\u200b\u51fd\u6570","text":"<ul> <li>\u200b\u5206\u914d\u200b</li> </ul> <pre><code>struct i2c_adpater *adap = kzalloc(sizeof(struct i2c_adpater), GFP_KERNEL);\n</code></pre> <ul> <li>\u200b\u8bbe\u7f6e\u200b</li> </ul> <pre><code>adap-&gt;owner = THIS_MODULE;\nadap-&gt;algo = &amp;stm32f7_i2c_algo;\n</code></pre> <ul> <li>\u200b\u6ce8\u518c\u200b\uff1ai2c_add_adapter/i2c_add_numbered_adapter</li> </ul> <pre><code>ret = i2c_add_adapter(adap);          // \u200b\u4e0d\u7ba1\u200badap-&gt;nr\u200b\u539f\u6765\u200b\u662f\u200b\u4ec0\u4e48\u200b\uff0c\u200b\u90fd\u200b\u52a8\u6001\u200b\u8bbe\u7f6e\u200badap-&gt;nr\nret = i2c_add_numbered_adapter(adap); // \u200b\u5982\u679c\u200badap-&gt;nr == -1 \u200b\u5219\u200b\u52a8\u6001\u5206\u914d\u200bnr; \u200b\u5426\u5219\u200b\u4f7f\u7528\u200b\u8be5\u200bnr   \n</code></pre> <ul> <li>\u200b\u53cd\u200b\u6ce8\u518c\u200b</li> </ul> <pre><code>i2c_del_adapter(adap);\n</code></pre>"},{"location":"04_I2C/11/#2-i2c_algorithm_1","title":"2. i2c_algorithm\u200b\u793a\u4f8b","text":"<ul> <li> <p>Linux-5.4\u200b\u4e2d\u200b\u4f7f\u7528\u200bGPIO\u200b\u6a21\u62df\u200bI2C   </p> </li> <li> <p>Linux-5.4\u200b\u4e2d\u200bSTM32F157\u200b\u7684\u200bI2C\u200b\u9a71\u52a8\u200b   </p> </li> <li> <p>Linux-4.9.88\u200b\u4e2d\u200bIMX6ULL\u200b\u7684\u200bI2C\u200b\u9a71\u52a8\u200b   </p> </li> </ul>"},{"location":"04_I2C/11/#3","title":"3. \u200b\u7f16\u5199\u200b\u4e00\u4e2a\u200b\u6846\u67b6\u200b\u7a0b\u5e8f","text":""},{"location":"04_I2C/11/#31","title":"3.1 \u200b\u8bbe\u5907\u200b\u6811","text":"<p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6784\u9020\u200bI2C Bus\u200b\u8282\u70b9\u200b\uff1a</p> <pre><code>    i2c-bus-virtual {\n         compatible = \"100ask,i2c-bus-virtual\";\n    };\n</code></pre>"},{"location":"04_I2C/11/#32-platform_driver","title":"3.2 platform_driver","text":"<p>\u200b\u5206\u914d\u200b\u3001\u200b\u8bbe\u7f6e\u200b\u3001\u200b\u6ce8\u518c\u200bplatform_driver\u200b\u7ed3\u6784\u200b\u4f53\u200b\u3002</p> <p>\u200b\u6838\u5fc3\u200b\u662f\u200bprobe\u200b\u51fd\u6570\u200b\uff0c\u200b\u5b83\u200b\u8981\u200b\u505a\u200b\u8fd9\u200b\u51e0\u4ef6\u4e8b\u200b\uff1a</p> <ul> <li>\u200b\u6839\u636e\u200b\u8bbe\u5907\u200b\u6811\u200b\u4fe1\u606f\u200b\u8bbe\u7f6e\u200b\u786c\u4ef6\u200b(\u200b\u5f15\u811a\u200b\u3001\u200b\u65f6\u949f\u200b\u7b49\u200b)</li> <li>\u200b\u5206\u914d\u200b\u3001\u200b\u8bbe\u7f6e\u200b\u3001\u200b\u6ce8\u518c\u200bi2c_apdater</li> </ul>"},{"location":"04_I2C/11/#33-i2c_apdater","title":"3.3 i2c_apdater","text":"<p>i2c_apdater\u200b\u6838\u5fc3\u200b\u662f\u200bmaster_xfer\u200b\u51fd\u6570\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u5b9e\u73b0\u200b\u53d6\u51b3\u4e8e\u200b\u786c\u4ef6\u200b\uff0c\u200b\u5927\u6982\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>static int xxx_master_xfer(struct i2c_adapter *adapter,\n                        struct i2c_msg *msgs, int num)\n{\n    for (i = 0; i &lt; num; i++) {\n        struct i2c_msg *msg = msgs[i];\n        {\n            // 1. \u200b\u53d1\u51fa\u200bS\u200b\u4fe1\u53f7\u200b: \u200b\u8bbe\u7f6e\u200b\u5bc4\u5b58\u5668\u200b\u53d1\u51fa\u200bS\u200b\u4fe1\u53f7\u200b\n            CTLREG = S;\n\n            // 2. \u200b\u6839\u636e\u200bFlag\u200b\u53d1\u51fa\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\u548c\u200bR/W\u200b\u4f4d\u200b: \u200b\u628a\u200b\u8fd9\u200b8\u200b\u4f4d\u200b\u6570\u636e\u200b\u5199\u5165\u200b\u67d0\u4e2a\u200bDATAREG\u200b\u5373\u53ef\u200b\u53d1\u51fa\u4fe1\u53f7\u200b\n            //    \u200b\u5224\u65ad\u200b\u662f\u5426\u200b\u6709\u200bACK\n\n            if (!ACK)\n                return ERROR;\n            else {\n                // 3. read / write\n                if (read) {\n                    STATUS = XXX; // \u200b\u8fd9\u200b\u51b3\u5b9a\u200b\u8bfb\u200b\u5230\u200b\u4e00\u4e2a\u200b\u6570\u636e\u200b\u540e\u200b\u662f\u5426\u200b\u53d1\u51fa\u200bACK\u200b\u7ed9\u200b\u5bf9\u65b9\u200b\n                    val = DATAREG; // \u200b\u8fd9\u4f1a\u200b\u53d1\u8d77\u200bI2C\u200b\u8bfb\u200b\u64cd\u4f5c\u200b\n                } else if(write) {\n                    DATAREG = val; // \u200b\u8fd9\u4f1a\u200b\u53d1\u8d77\u200bI2C\u200b\u5199\u200b\u64cd\u4f5c\u200b\n                    val = STATUS;  // \u200b\u5224\u65ad\u200b\u662f\u5426\u200b\u6536\u5230\u200bACK\n                    if (!ACK)\n                        return ERROR;\n                }                \n            }\n            // 4. \u200b\u53d1\u51fa\u200bP\u200b\u4fe1\u53f7\u200b\n            CTLREG = P;\n        }\n    }\n\n    return i;\n}\n</code></pre>"},{"location":"04_I2C/12_1/","title":"12_\u200b\u5b8c\u5584\u200b\u865a\u62df\u200b\u7684\u200bI2C_Adapter\u200b\u9a71\u52a8\u200b\u5e76\u200b\u6a21\u62df\u200bEEPROM","text":""},{"location":"04_I2C/12_1/#i2c_adaptereeprom","title":"\u5b8c\u5584\u200b\u865a\u62df\u200b\u7684\u200bI2C_Adapter\u200b\u9a71\u52a8\u200b\u5e76\u200b\u6a21\u62df\u200bEEPROM","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux\u200b\u5185\u6838\u200b\u6587\u6863\u200b:</li> <li><code>Linux-4.9.88\\Documentation\\devicetree\\bindings\\i2c\\i2c-gpio.txt</code></li> <li> <p><code>Linux-5.4\\Documentation\\devicetree\\bindings\\i2c\\i2c-gpio.yaml</code></p> </li> <li> <p>Linux\u200b\u5185\u6838\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff1a\u200b\u4f7f\u7528\u200bGPIO\u200b\u6a21\u62df\u200bI2C</p> </li> <li> <p><code>Linux-4.9.88\\drivers\\i2c\\busses\\i2c-gpio.c</code></p> </li> <li> <p><code>Linux-5.4\\drivers\\i2c\\busses\\i2c-gpio.c</code></p> </li> <li> <p>Linux\u200b\u5185\u6838\u200b\u771f\u6b63\u200b\u7684\u200bI2C\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b</p> </li> <li> <p>IMX6ULL: <code>Linux-4.9.88\\drivers\\i2c\\busses\\i2c-imx.c</code></p> </li> <li>STM32MP157: <code>Linux-5.4\\drivers\\i2c\\busses\\i2c-stm32f7.c</code></li> <li>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u7684\u200b\u4ee3\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b</li> <li>IMX6ULL\uff1a<code>doc_and_source_for_drivers\\IMX6ULL\\source\\04_I2C\\06_i2c_adapter_virtual_ok</code></li> <li>STM32MP157\uff1a<code>doc_and_source_for_drivers\\STM32MP157\\source\\A7\\04_I2C\\06_i2c_adapter_virtual_ok</code></li> </ul>"},{"location":"04_I2C/12_1/#1-master_xfer","title":"1. \u200b\u5b9e\u73b0\u200bmaster_xfer\u200b\u51fd\u6570","text":"<p>\u200b\u5728\u200b\u865a\u62df\u200b\u7684\u200bI2C_Adapter\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u91cc\u200b\uff0c\u200b\u53ea\u8981\u200b\u5b9e\u73b0\u200b\u4e86\u200b\u5176\u4e2d\u200b\u7684\u200bmaster_xfer\u200b\u51fd\u6570\u200b\uff0c\u200b\u8fd9\u4e2a\u200bI2C Adapter\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u4e86\u200b\u3002 \u200b\u5728\u200bmaster_xfer\u200b\u51fd\u6570\u200b\u91cc\u200b\uff0c\u200b\u6211\u4eec\u200b\u6a21\u62df\u200b\u4e00\u4e2a\u200bEEPROM\uff0c\u200b\u601d\u8def\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u5206\u914d\u200b\u4e00\u4e2a\u200b512\u200b\u81ea\u5df1\u200b\u7684\u200bbuffer\uff0c\u200b\u8868\u793a\u200bEEPROM</li> <li>\u200b\u5bf9\u4e8e\u200bslave address\u200b\u4e3a\u200b0x50\u200b\u7684\u200bi2c_msg\uff0c\u200b\u89e3\u6790\u200b\u5e76\u200b\u5904\u7406\u200b</li> <li>\u200b\u5bf9\u4e8e\u200b\u5199\u200b\uff1a\u200b\u628a\u200bi2c_msg\u200b\u7684\u200b\u6570\u636e\u200b\u5199\u5165\u200bbuffer</li> <li>\u200b\u5bf9\u4e8e\u200b\u8bfb\u200b\uff1a\u200b\u4ece\u200bbuffer\u200b\u4e2d\u200b\u628a\u200b\u6570\u636e\u200b\u5199\u5165\u200bi2c_msg</li> <li>\u200b\u5bf9\u4e8e\u200bslave address\u200b\u4e3a\u200b\u5176\u4ed6\u200b\u503c\u200b\u7684\u200bi2c_msg\uff0c\u200b\u8fd4\u56de\u200b\u9519\u8bef\u200b</li> </ul>"},{"location":"04_I2C/12_1/#2","title":"2. \u200b\u7f16\u7a0b","text":"<p>\u200b\u770b\u200b\u89c6\u9891\u200b</p>"},{"location":"04_I2C/12_1/#3","title":"3. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":""},{"location":"04_I2C/12_1/#31","title":"3.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<ul> <li>IMX6ULL</li> </ul> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre> <ul> <li>STM32MP157   \u200b\u6ce8\u610f\u200b\uff1a\u200b\u5bf9\u4e8e\u200bSTM32MP157\uff0c\u200b\u4ee5\u524d\u200b\u8bf4\u200b\u7f16\u8bd1\u200b\u5185\u6838\u200b/\u200b\u9a71\u52a8\u200b\u3001\u200b\u7f16\u8bd1\u200bAPP\u200b\u7684\u200b\u5de5\u5177\u200b\u94fe\u200b\u4e0d\u200b\u4e00\u6837\u200b\uff0c\u200b\u5176\u5b9e\u200b\u7f16\u8bd1\u200bAPP\u200b\u7528\u200b\u7684\u200b\u5de5\u5177\u200b\u94fe\u200b\u4e5f\u200b\u80fd\u200b\u7528\u6765\u200b\u7f16\u8bd1\u200b\u5185\u6838\u200b\u3002</li> </ul> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"04_I2C/12_1/#32","title":"3.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":"<p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u6839\u200b\u8282\u70b9\u200b\u4e0b\u200b\uff0c\u200b\u6dfb\u52a0\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>    i2c-bus-virtual {\n         compatible = \"100ask,i2c-bus-virtual\";\n    };\n</code></pre>"},{"location":"04_I2C/12_1/#1-stm32mp157","title":"1. STM32MP157","text":"<ul> <li> <p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dts</code>\uff0c\u200b\u6dfb\u52a0\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>/ {\n    i2c-bus-virtual {\n         compatible = \"100ask,i2c-bus-virtual\";\n    };\n};\n</code></pre> </li> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bSTM32MP157\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <ul> <li>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.1.100)</li> </ul> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> <ul> <li>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.1.137</li> </ul> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u6811\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b\u54ea\u91cc\u200b</p> <p>\u200b\u7531\u4e8e\u200b\u7248\u672c\u200b\u53d8\u5316\u200b\uff0cSTM32MP157\u200b\u5355\u677f\u200b\u4e0a\u200b\u70e7\u5f55\u200b\u7684\u200b\u7cfb\u7edf\u200b\u53ef\u80fd\u200b\u6709\u200b\u7ec6\u5fae\u5dee\u522b\u200b\u3002 \u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b<code>cat /proc/mounts</code>\u200b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u4e24\u79cd\u200b\u7ed3\u679c\u200b(\u200b\u89c1\u200b\u4e0b\u56fe\u200b)\uff1a</p> <ul> <li> <p>mmcblk2p2\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u5de6\u8fb9\u200b)\uff1a\u200b\u65e0\u9700\u200b\u7279\u6b8a\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u4e0b\u9762\u200b\u628a\u200b\u6587\u4ef6\u200b\u590d\u5236\u5230\u200b/boot\u200b\u76ee\u5f55\u200b\u5373\u53ef\u200b</p> </li> <li> <p>mmcblk2p2\u200b\u6302\u8f7d\u200b\u5728\u200b/mnt\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u53f3\u8fb9\u200b)</p> </li> <li> <p>\u200b\u5728\u200b\u89c6\u9891\u200b\u91cc\u200b\u3001\u200b\u540e\u9762\u200b\u6587\u6863\u200b\u91cc\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u66f4\u65b0\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u7684\u200b\u6587\u4ef6\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8981\u200b\u5148\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u91cd\u65b0\u200b\u6302\u8f7d\u200b\uff1a</p> <ul> <li><code>mount  /dev/mmcblk2p2  /boot</code></li> </ul> </li> </ul> <p></p> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/stm32mp157c-100ask-512d-lcd-v1.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"04_I2C/12_1/#2-imx6ull","title":"2. IMX6ULL","text":"<ul> <li> <p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code>\uff0c\u200b\u6dfb\u52a0\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>/ {\n    i2c-bus-virtual {\n         compatible = \"100ask,i2c-bus-virtual\";\n    };\n};\n</code></pre> </li> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bIMX6ULL\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/100ask_imx6ull-14x14.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.1.100)</p> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.1.137</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/100ask_imx6ull-14x14.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"04_I2C/12_1/#34","title":"3.4 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u5b89\u88c5\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\uff1a</p> </li> <li> <p>\u200b\u5728\u200bUbuntu\u200b\u4e0a\u200b</p> </li> <li> <p>\u200b\u4fee\u6539\u200b<code>06_i2c_adapter_virtual_ok</code>\u200b\u4e2d\u200b\u7684\u200bMakefile\uff0c\u200b\u6307\u5b9a\u200b\u5185\u6838\u200b\u8def\u5f84\u200b<code>KERN_DIR</code>\uff0c\u200b\u5728\u200b\u6267\u884c\u200b<code>make</code>\u200b\u547d\u4ee4\u200b\u5373\u53ef\u200b\u3002</p> </li> <li> <p>\u200b\u5b89\u88c5\u200b\uff1a</p> </li> <li> <p>\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b</p> </li> <li> <p>\u200b\u6302\u8f7d\u200bNFS\uff0c\u200b\u590d\u5236\u200b\u6587\u4ef6\u200b\uff0cinsmod\uff0c\u200b\u7c7b\u4f3c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b\uff1a</p> <pre><code>mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n// \u200b\u5bf9\u4e8e\u200bIMX6ULL\uff0c\u200b\u60f3\u200b\u770b\u5230\u200b\u9a71\u52a8\u200b\u6253\u5370\u4fe1\u606f\u200b\uff0c\u200b\u9700\u8981\u200b\u5148\u200b\u6267\u884c\u200b\necho \"7 4 1 7\" &gt; /proc/sys/kernel/printk\n\ninsmod /mnt/i2c_adapter_drv.ko\n</code></pre> </li> </ul>"},{"location":"04_I2C/12_1/#35-i2c-tools","title":"3.5 \u200b\u4f7f\u7528\u200bi2c-tools\u200b\u6d4b\u8bd5","text":"<p>\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b\uff0c\u200b\u547d\u4ee4\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u5217\u51fa\u200bI2C\u200b\u603b\u7ebf\u200b</li> </ul> <pre><code>i2cdetect -l\n</code></pre> <p>\u200b\u7ed3\u679c\u200b\u7c7b\u4f3c\u200b\u4e0b\u5217\u200b\u7684\u200b\u4fe1\u606f\u200b\uff1a</p> <pre><code>i2c-1   i2c             21a4000.i2c                             I2C adapter\ni2c-4   i2c             i2c-bus-virtual                         I2C adapter\ni2c-0   i2c             21a0000.i2c                             I2C adapter\n</code></pre> <p>\u200b\u6ce8\u610f\u200b\uff1a\u200b\u4e0d\u540c\u200b\u7684\u200b\u677f\u5b50\u200b\u4e0a\u200b\uff0ci2c-bus-virtual\u200b\u7684\u200b\u603b\u7ebf\u200b\u53f7\u200b\u53ef\u80fd\u200b\u4e0d\u200b\u4e00\u6837\u200b\uff0c\u200b\u4e0a\u200b\u95ee\u200b\u4e2d\u200b\u603b\u7ebf\u200b\u53f7\u200b\u662f\u200b4\u3002</p> <ul> <li>\u200b\u68c0\u67e5\u200b\u865a\u62df\u200b\u603b\u7ebf\u200b\u4e0b\u200b\u7684\u200bI2C\u200b\u8bbe\u5907\u200b</li> </ul> <pre><code>// \u200b\u5047\u8bbe\u200b\u865a\u62df\u200bI2C BUS\u200b\u53f7\u200b\u4e3a\u200b4\n[root@100ask:~]# i2cdetect -y -a 4\n     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f\n00: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n50: 50 -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n70: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n</code></pre> <ul> <li>\u200b\u8bfb\u5199\u200b\u6a21\u62df\u200b\u7684\u200bEEPROM</li> </ul> <pre><code>// \u200b\u5047\u8bbe\u200b\u865a\u62df\u200bI2C BUS\u200b\u53f7\u200b\u4e3a\u200b4\n[root@100ask:~]# i2cset -f -y 4 0x50 0 0x55   // \u200b\u5f80\u200b0\u200b\u5730\u5740\u200b\u5199\u5165\u200b0x55\n[root@100ask:~]# i2cget -f -y 4 0x50 0        // \u200b\u8bfb\u200b0\u200b\u5730\u5740\u200b\n0x55\n</code></pre>"},{"location":"04_I2C/13_1/","title":"13_\u200b\u4f7f\u7528\u200bGPIO\u200b\u6a21\u62df\u200bI2C\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5206\u6790","text":""},{"location":"04_I2C/13_1/#gpioi2c","title":"\u4f7f\u7528\u200bGPIO\u200b\u6a21\u62df\u200bI2C\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5206\u6790","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>i2c_spec.pdf</li> <li>Linux\u200b\u6587\u6863\u200b</li> <li><code>Linux-5.4\\Documentation\\devicetree\\bindings\\i2c\\i2c-gpio.yaml</code></li> <li><code>Linux-4.9.88\\Documentation\\devicetree\\bindings\\i2c\\i2c-gpio.txt</code></li> <li>Linux\u200b\u9a71\u52a8\u200b\u6e90\u7801\u200b</li> <li><code>Linux-5.4\\drivers\\i2c\\busses\\i2c-gpio.c</code></li> <li><code>Linux-4.9.88\\drivers\\i2c\\busses\\i2c-gpio.c</code></li> </ul>"},{"location":"04_I2C/13_1/#1-i2c","title":"1. \u200b\u56de\u987e\u200bI2C\u200b\u534f\u8bae","text":""},{"location":"04_I2C/13_1/#11","title":"1.1 \u200b\u786c\u4ef6\u200b\u8fde\u63a5","text":"<p>I2C\u200b\u5728\u200b\u786c\u4ef6\u200b\u4e0a\u200b\u7684\u200b\u63a5\u6cd5\u200b\u5982\u4e0b\u200b\u6240\u793a\u200b\uff0c\u200b\u4e3b\u63a7\u200b\u82af\u7247\u200b\u5f15\u51fa\u200b\u4e24\u6761\u7ebf\u200bSCL,SDA\u200b\u7ebf\u200b\uff0c\u200b\u5728\u200b\u4e00\u6761\u200bI2C\u200b\u603b\u7ebf\u200b\u4e0a\u200b\u53ef\u4ee5\u200b\u63a5\u200b\u5f88\u591a\u200bI2C\u200b\u8bbe\u5907\u200b\uff0c\u200b\u6211\u4eec\u200b\u8fd8\u4f1a\u653e\u200b\u4e00\u4e2a\u200b\u4e0a\u62c9\u200b\u7535\u963b\u200b\uff08\u200b\u653e\u200b\u4e00\u4e2a\u200b\u4e0a\u62c9\u200b\u7535\u963b\u200b\u7684\u200b\u539f\u56e0\u200b\u4ee5\u540e\u200b\u6211\u4eec\u200b\u518d\u8bf4\u200b\uff09\u3002</p> <p></p>"},{"location":"04_I2C/13_1/#12-i2c","title":"1.2 I2C\u200b\u4fe1\u53f7","text":"<p>I2C\u200b\u534f\u8bae\u200b\u4e2d\u200b\u6570\u636e\u4f20\u8f93\u200b\u7684\u200b\u5355\u4f4d\u200b\u662f\u200b\u5b57\u8282\u200b\uff0c\u200b\u4e5f\u200b\u5c31\u662f\u200b8\u200b\u4f4d\u200b\u3002\u200b\u4f46\u662f\u200b\u8981\u200b\u7528\u5230\u200b9\u200b\u4e2a\u200b\u65f6\u949f\u200b\uff1a\u200b\u524d\u9762\u200b8\u200b\u4e2a\u200b\u65f6\u949f\u200b\u7528\u6765\u200b\u4f20\u8f93\u200b8\u200b\u6570\u636e\u200b\uff0c\u200b\u7b2c\u200b9\u200b\u4e2a\u200b\u65f6\u949f\u200b\u7528\u6765\u200b\u4f20\u8f93\u200b\u56de\u5e94\u200b\u4fe1\u53f7\u200b\u3002\u200b\u4f20\u8f93\u200b\u65f6\u200b\uff0c\u200b\u5148\u200b\u4f20\u8f93\u200b\u6700\u9ad8\u200b\u4f4d\u200b(MSB)\u3002</p> <ul> <li>\u200b\u5f00\u59cb\u200b\u4fe1\u53f7\u200b\uff08S\uff09\uff1aSCL\u200b\u4e3a\u200b\u9ad8\u7535\u5e73\u200b\u65f6\u200b\uff0cSDA\u200b\u5c71\u200b\u9ad8\u7535\u5e73\u200b\u5411\u200b\u4f4e\u7535\u5e73\u200b\u8df3\u53d8\u200b\uff0c\u200b\u5f00\u59cb\u200b\u4f20\u9001\u6570\u636e\u200b\u3002</li> <li>\u200b\u7ed3\u675f\u200b\u4fe1\u53f7\u200b\uff08P\uff09\uff1aSCL\u200b\u4e3a\u200b\u9ad8\u7535\u5e73\u200b\u65f6\u200b\uff0cSDA\u200b\u7531\u200b\u4f4e\u7535\u5e73\u200b\u5411\u200b\u9ad8\u7535\u5e73\u200b\u8df3\u53d8\u200b\uff0c\u200b\u7ed3\u675f\u200b\u4f20\u9001\u6570\u636e\u200b\u3002</li> <li>\u200b\u54cd\u5e94\u200b\u4fe1\u53f7\u200b(ACK)\uff1a\u200b\u63a5\u6536\u5668\u200b\u5728\u200b\u63a5\u6536\u200b\u5230\u200b8\u200b\u4f4d\u200b\u6570\u636e\u200b\u540e\u200b\uff0c\u200b\u5728\u200b\u7b2c\u200b9\u200b\u4e2a\u200b\u65f6\u949f\u200b\u5468\u671f\u200b\uff0c\u200b\u62c9\u4f4e\u200bSDA</li> <li>SDA\u200b\u4e0a\u200b\u4f20\u8f93\u200b\u7684\u200b\u6570\u636e\u200b\u5fc5\u987b\u200b\u5728\u200bSCL\u200b\u4e3a\u200b\u9ad8\u7535\u5e73\u200b\u671f\u95f4\u200b\u4fdd\u6301\u7a33\u5b9a\u200b\uff0cSDA\u200b\u4e0a\u200b\u7684\u200b\u6570\u636e\u200b\u53ea\u80fd\u200b\u5728\u200bSCL\u200b\u4e3a\u200b\u4f4e\u7535\u5e73\u200b\u671f\u95f4\u200b\u53d8\u5316\u200b</li> </ul> <p>I2C\u200b\u534f\u8bae\u200b\u4fe1\u53f7\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"04_I2C/13_1/#13","title":"1.3 \u200b\u534f\u8bae\u200b\u7ec6\u8282","text":"<ul> <li> <p>\u200b\u5982\u4f55\u200b\u5728\u200bSDA\u200b\u4e0a\u200b\u5b9e\u73b0\u200b\u53cc\u5411\u200b\u4f20\u8f93\u200b\uff1f   \u200b\u4e3b\u200b\u82af\u7247\u200b\u901a\u8fc7\u200b\u4e00\u6839\u200bSDA\u200b\u7ebf\u200b\u65e2\u200b\u53ef\u4ee5\u200b\u628a\u200b\u6570\u636e\u200b\u53d1\u7ed9\u200b\u4ece\u200b\u8bbe\u5907\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u4ece\u200bSDA\u200b\u4e0a\u200b\u8bfb\u53d6\u6570\u636e\u200b\uff0c\u200b\u8fde\u63a5\u200bSDA\u200b\u7ebf\u200b\u7684\u200b\u5f15\u811a\u200b\u91cc\u9762\u200b\u5fc5\u7136\u200b\u6709\u200b\u4e24\u4e2a\u200b\u5f15\u811a\u200b\uff08\u200b\u53d1\u9001\u200b\u5f15\u811a\u200b/\u200b\u63a5\u53d7\u200b\u5f15\u811a\u200b\uff09\u3002</p> </li> <li> <p>\u200b\u4e3b\u200b\u3001\u200b\u4ece\u200b\u8bbe\u5907\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200bSDA\u200b\u53d1\u9001\u6570\u636e\u200b\uff0c\u200b\u80af\u5b9a\u200b\u4e0d\u80fd\u200b\u540c\u65f6\u200b\u53d1\u9001\u6570\u636e\u200b\uff0c\u200b\u600e\u4e48\u200b\u9519\u5f00\u200b\u65f6\u95f4\u200b\uff1f   \u200b\u5728\u200b9\u200b\u4e2a\u200b\u65f6\u949f\u200b\u91cc\u200b\uff0c   \u200b\u524d\u200b8\u200b\u4e2a\u200b\u65f6\u949f\u200b\u7531\u4e3b\u200b\u8bbe\u5907\u200b\u53d1\u9001\u6570\u636e\u200b\u7684\u8bdd\u200b\uff0c\u200b\u7b2c\u200b9\u200b\u4e2a\u200b\u65f6\u949f\u200b\u5c31\u200b\u7531\u200b\u4ece\u200b\u8bbe\u5907\u200b\u53d1\u9001\u6570\u636e\u200b\uff1b   \u200b\u524d\u200b8\u200b\u4e2a\u200b\u65f6\u949f\u200b\u7531\u200b\u4ece\u200b\u8bbe\u5907\u200b\u53d1\u9001\u6570\u636e\u200b\u7684\u8bdd\u200b\uff0c\u200b\u7b2c\u200b9\u200b\u4e2a\u200b\u65f6\u949f\u200b\u5c31\u200b\u7531\u4e3b\u200b\u8bbe\u5907\u200b\u53d1\u9001\u6570\u636e\u200b\u3002</p> </li> <li>\u200b\u53cc\u65b9\u200b\u8bbe\u5907\u200b\u4e2d\u200b\uff0c\u200b\u67d0\u4e2a\u200b\u8bbe\u5907\u200b\u53d1\u9001\u6570\u636e\u200b\u65f6\u200b\uff0c\u200b\u53e6\u4e00\u65b9\u200b\u600e\u6837\u624d\u80fd\u200b\u4e0d\u200b\u5f71\u54cd\u200bSDA\u200b\u4e0a\u200b\u7684\u200b\u6570\u636e\u200b\uff1f   \u200b\u8bbe\u5907\u200b\u7684\u200bSDA\u200b\u4e2d\u6709\u200b\u4e00\u4e2a\u200b\u4e09\u6781\u7ba1\u200b\uff0c\u200b\u4f7f\u7528\u200b\u5f00\u6781\u200b/\u200b\u5f00\u200b\u6f0f\u7535\u200b\u8def\u200b(\u200b\u4e09\u6781\u7ba1\u200b\u662f\u200b\u5f00\u6781\u200b\uff0cCMOS\u200b\u7ba1\u662f\u200b\u5f00\u6f0f\u200b\uff0c\u200b\u4f5c\u7528\u200b\u4e00\u6837\u200b)\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\uff1a   </li> </ul> <p>\u200b\u771f\u503c\u8868\u200b\u5982\u4e0b\u200b\uff1a </p> <p>\u200b\u4ece\u200b\u771f\u503c\u8868\u200b\u548c\u200b\u7535\u8def\u56fe\u200b\u6211\u4eec\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200b\uff1a</p> <ul> <li>\u200b\u5f53\u67d0\u200b\u4e00\u4e2a\u200b\u82af\u7247\u200b\u4e0d\u60f3\u200b\u5f71\u54cd\u200bSDA\u200b\u7ebf\u65f6\u200b\uff0c\u200b\u90a3\u200b\u5c31\u200b\u4e0d\u200b\u9a71\u52a8\u200b\u8fd9\u4e2a\u200b\u4e09\u6781\u7ba1\u200b</li> <li>\u200b\u60f3\u200b\u8ba9\u200bSDA\u200b\u8f93\u51fa\u200b\u9ad8\u7535\u5e73\u200b\uff0c\u200b\u53cc\u65b9\u200b\u90fd\u200b\u4e0d\u200b\u9a71\u52a8\u200b\u4e09\u6781\u7ba1\u200b(SDA\u200b\u901a\u8fc7\u200b\u4e0a\u62c9\u200b\u7535\u963b\u200b\u53d8\u4e3a\u200b\u9ad8\u7535\u5e73\u200b)</li> <li>\u200b\u60f3\u200b\u8ba9\u200bSDA\u200b\u8f93\u51fa\u200b\u4f4e\u7535\u5e73\u200b\uff0c\u200b\u5c31\u200b\u9a71\u52a8\u200b\u4e09\u6781\u7ba1\u200b</li> </ul> <p>\u200b\u4ece\u200b\u4e0b\u9762\u200b\u7684\u200b\u4f8b\u5b50\u200b\u53ef\u4ee5\u200b\u770b\u770b\u200b\u6570\u636e\u200b\u662f\u200b\u600e\u4e48\u200b\u4f20\u200b\u7684\u200b\uff08\u200b\u5b9e\u73b0\u200b\u53cc\u5411\u200b\u4f20\u8f93\u200b\uff09\u3002 \u200b\u4e3e\u4f8b\u200b\uff1a\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u53d1\u9001\u200b\uff088bit\uff09\u200b\u7ed9\u200b\u4ece\u200b\u8bbe\u5907\u200b</p> <ul> <li>\u200b\u524d\u200b8\u200b\u4e2a\u200bclk</li> <li>\u200b\u4ece\u200b\u8bbe\u5907\u200b\u4e0d\u8981\u200b\u5f71\u54cd\u200bSDA\uff0c\u200b\u4ece\u200b\u8bbe\u5907\u200b\u4e0d\u200b\u9a71\u52a8\u200b\u4e09\u6781\u7ba1\u200b</li> <li> <p>\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u51b3\u5b9a\u200b\u6570\u636e\u200b\uff0c\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u8981\u200b\u53d1\u9001\u200b1\u200b\u65f6\u200b\u4e0d\u200b\u9a71\u52a8\u200b\u4e09\u6781\u7ba1\u200b\uff0c\u200b\u8981\u200b\u53d1\u9001\u200b0\u200b\u65f6\u200b\u9a71\u52a8\u200b\u4e09\u6781\u7ba1\u200b</p> </li> <li> <p>\u200b\u7b2c\u200b9\u200b\u4e2a\u200bclk\uff0c\u200b\u7531\u200b\u4ece\u200b\u8bbe\u5907\u200b\u51b3\u5b9a\u200b\u6570\u636e\u200b</p> </li> <li>\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u4e0d\u200b\u9a71\u52a8\u200b\u4e09\u6781\u7ba1\u200b</li> <li>\u200b\u4ece\u200b\u8bbe\u5907\u200b\u51b3\u5b9a\u200b\u6570\u636e\u200b\uff0c\u200b\u8981\u200b\u53d1\u51fa\u200b\u56de\u5e94\u200b\u4fe1\u53f7\u200b\u7684\u8bdd\u200b\uff0c\u200b\u5c31\u200b\u9a71\u52a8\u200b\u4e09\u6781\u7ba1\u200b\u8ba9\u200bSDA\u200b\u53d8\u4e3a\u200b0</li> <li>\u200b\u4ece\u200b\u8fd9\u91cc\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200bACK\u200b\u4fe1\u53f7\u200b\u662f\u200b\u4f4e\u7535\u5e73\u200b</li> </ul> <p>\u200b\u4ece\u200b\u4e0a\u9762\u200b\u7684\u200b\u4f8b\u5b50\u200b\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200b\u600e\u6837\u200b\u5728\u200b\u4e00\u6761\u7ebf\u200b\u4e0a\u200b\u5b9e\u73b0\u200b\u53cc\u5411\u200b\u4f20\u8f93\u200b\uff0c\u200b\u8fd9\u200b\u5c31\u662f\u200bSDA\u200b\u4e0a\u8981\u200b\u4f7f\u7528\u200b\u4e0a\u62c9\u200b\u7535\u963b\u200b\u7684\u200b\u539f\u56e0\u200b\u3002</p> <p>\u200b\u4e3a\u4f55\u200bSCL\u200b\u4e5f\u200b\u8981\u200b\u4f7f\u7528\u200b\u4e0a\u62c9\u200b\u7535\u963b\u200b\uff1f \u200b\u5728\u200b\u7b2c\u200b9\u200b\u4e2a\u200b\u65f6\u949f\u200b\u4e4b\u540e\u200b\uff0c\u200b\u5982\u679c\u200b\u6709\u200b\u67d0\u200b\u4e00\u65b9\u200b\u9700\u8981\u200b\u66f4\u200b\u591a\u200b\u7684\u200b\u65f6\u95f4\u200b\u6765\u200b\u5904\u7406\u200b\u6570\u636e\u200b\uff0c\u200b\u5b83\u200b\u53ef\u4ee5\u200b\u4e00\u76f4\u200b\u9a71\u52a8\u200b\u4e09\u6781\u7ba1\u200b\u628a\u200bSCL\u200b\u62c9\u4f4e\u200b\u3002 \u200b\u5f53\u200bSCL\u200b\u4e3a\u200b\u4f4e\u7535\u5e73\u200b\u65f6\u5019\u200b\uff0c\u200b\u5927\u5bb6\u200b\u90fd\u200b\u4e0d\u200b\u5e94\u8be5\u200b\u4f7f\u7528\u200bIIC\u200b\u603b\u7ebf\u200b\uff0c\u200b\u53ea\u6709\u200b\u5f53\u200bSCL\u200b\u4ece\u200b\u4f4e\u7535\u5e73\u200b\u53d8\u4e3a\u200b\u9ad8\u7535\u5e73\u200b\u7684\u200b\u65f6\u5019\u200b\uff0cIIC\u200b\u603b\u7ebf\u200b\u624d\u80fd\u200b\u88ab\u200b\u4f7f\u7528\u200b\u3002 \u200b\u5f53\u200b\u5b83\u200b\u5c31\u7eea\u200b\u540e\u200b\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u4e0d\u518d\u200b\u9a71\u52a8\u200b\u4e09\u6781\u7ba1\u200b\uff0c\u200b\u8fd9\u200b\u662f\u200b\u4e0a\u200b\u62c9\u200b\u7535\u963b\u200b\u628a\u200bSCL\u200b\u53d8\u4e3a\u200b\u9ad8\u7535\u5e73\u200b\uff0c\u200b\u5176\u4ed6\u200b\u8bbe\u5907\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u7ee7\u7eed\u200b\u4f7f\u7528\u200bI2C\u200b\u603b\u7ebf\u200b\u4e86\u200b\u3002</p>"},{"location":"04_I2C/13_1/#2-gpioi2c","title":"2. \u200b\u4f7f\u7528\u200bGPIO\u200b\u6a21\u62df\u200bI2C\u200b\u7684\u200b\u8981\u70b9","text":"<ul> <li>\u200b\u5f15\u811a\u200b\u8bbe\u200b\u4e3a\u200bGPIO</li> <li>GPIO\u200b\u8bbe\u200b\u4e3a\u200b\u8f93\u51fa\u200b\u3001\u200b\u5f00\u6781\u200b/\u200b\u5f00\u6f0f\u200b(open collector/open drain)</li> <li>\u200b\u8981\u200b\u6709\u200b\u4e0a\u200b\u62c9\u200b\u7535\u963b\u200b</li> </ul>"},{"location":"04_I2C/13_1/#3","title":"3. \u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5206\u6790","text":""},{"location":"04_I2C/13_1/#31","title":"3.1 \u200b\u5e73\u53f0\u200b\u603b\u7ebf\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u6a21\u578b","text":""},{"location":"04_I2C/13_1/#32","title":"3.2 \u200b\u8bbe\u5907\u200b\u6811","text":"<p>\u200b\u5bf9\u4e8e\u200bGPIO\u200b\u5f15\u811a\u200b\u7684\u200b\u5b9a\u4e49\u200b\uff0c\u200b\u6709\u200b\u4e24\u79cd\u200b\u65b9\u6cd5\u200b\uff1a</p> <ul> <li>\u200b\u8001\u200b\u65b9\u6cd5\u200b\uff1agpios</li> <li>\u200b\u65b0\u200b\u65b9\u6cd5\u200b\uff1asda-gpios\u3001scl-gpios</li> </ul> <p></p>"},{"location":"04_I2C/13_1/#33","title":"3.3 \u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5206\u6790","text":""},{"location":"04_I2C/13_1/#1-i2c-gpio","title":"1. I2C-GPIO\u200b\u9a71\u52a8\u200b\u5c42\u6b21","text":""},{"location":"04_I2C/13_1/#2","title":"2. \u200b\u4f20\u8f93\u200b\u51fd\u6570\u200b\u5206\u6790","text":"<p>\u200b\u770b\u200b\u89c6\u9891\u200b\u5206\u6790\u200bi2c_outb\u200b\u51fd\u6570\u200b\uff1a<code>drivers\\i2c\\algos\\i2c-algo-bit.c</code> </p>"},{"location":"04_I2C/13_1/#4-i2c-gpio","title":"4. \u200b\u600e\u4e48\u200b\u4f7f\u7528\u200bI2C-GPIO","text":"<p>\u200b\u8bbe\u7f6e\u200b\u8bbe\u5907\u200b\u6570\u200b\uff0c\u200b\u5728\u200b\u91cc\u9762\u200b\u6dfb\u52a0\u200b\u4e00\u4e2a\u200b\u8282\u70b9\u200b\u5373\u53ef\u200b\uff0c\u200b\u793a\u4f8b\u200b\u4ee3\u7801\u200b\u770b\u200b\u4e0a\u9762\u200b\uff1a</p> <ul> <li> <p>compatible = \"i2c-gpio\";</p> </li> <li> <p>\u200b\u4f7f\u7528\u200bpinctrl\u200b\u628a\u200b SDA\u3001SCL\u200b\u6240\u200b\u6d89\u53ca\u200b\u5f15\u811a\u200b\u914d\u7f6e\u200b\u4e3a\u200bGPIO\u3001\u200b\u5f00\u6781\u200b</p> </li> <li> <p>\u200b\u53ef\u200b\u9009\u200b</p> </li> <li> <p>\u200b\u6307\u5b9a\u200bSDA\u3001SCL\u200b\u6240\u7528\u200b\u7684\u200bGPIO</p> </li> <li> <p>\u200b\u6307\u5b9a\u200b\u9891\u7387\u200b(2\u200b\u79cd\u200b\u65b9\u6cd5\u200b)\uff1a</p> </li> <li>i2c-gpio,delay-us = &lt;5&gt;;    /* ~100 kHz */</li> <li> <p>clock-frequency = &lt;400000&gt;;</p> </li> <li> </li> <li> </li> <li> <p>i2c-gpio,sda-open-drain\uff1a</p> </li> <li> <p>\u200b\u5b83\u200b\u8868\u793a\u200b\u5176\u4ed6\u200b\u9a71\u52a8\u200b\u3001\u200b\u5176\u4ed6\u200b\u7cfb\u7edf\u200b\u5df2\u7ecf\u200b\u628a\u200bSDA\u200b\u8bbe\u7f6e\u200b\u4e3a\u200bopen drain\u200b\u4e86\u200b</p> </li> <li>\u200b\u5728\u200b\u9a71\u52a8\u200b\u91cc\u200b\u4e0d\u200b\u9700\u8981\u200b\u5728\u200b\u8bbe\u7f6e\u200b\u4e3a\u200bopen drain</li> <li> <p>\u200b\u5982\u679c\u200b\u9700\u8981\u200b\u9a71\u52a8\u200b\u4ee3\u7801\u200b\u81ea\u5df1\u200b\u53bb\u200b\u8bbe\u7f6e\u200bSDA\u200b\u4e3a\u200bopen drain\uff0c\u200b\u5c31\u200b\u4e0d\u8981\u200b\u63d0\u4f9b\u200b\u8fd9\u4e2a\u200b\u5c5e\u6027\u200b</p> </li> <li> <p>i2c-gpio,scl-open-drain\uff1a</p> </li> <li> <p>\u200b\u5b83\u200b\u8868\u793a\u200b\u5176\u4ed6\u200b\u9a71\u52a8\u200b\u3001\u200b\u5176\u4ed6\u200b\u7cfb\u7edf\u200b\u5df2\u7ecf\u200b\u628a\u200bSCL\u200b\u8bbe\u7f6e\u200b\u4e3a\u200bopen drain\u200b\u4e86\u200b</p> </li> <li>\u200b\u5728\u200b\u9a71\u52a8\u200b\u91cc\u200b\u4e0d\u200b\u9700\u8981\u200b\u5728\u200b\u8bbe\u7f6e\u200b\u4e3a\u200bopen drain</li> <li>\u200b\u5982\u679c\u200b\u9700\u8981\u200b\u9a71\u52a8\u200b\u4ee3\u7801\u200b\u81ea\u5df1\u200b\u53bb\u200b\u8bbe\u7f6e\u200bSCL\u200b\u4e3a\u200bopen drain\uff0c\u200b\u5c31\u200b\u4e0d\u8981\u200b\u63d0\u4f9b\u200b\u8fd9\u4e2a\u200b\u5c5e\u6027\u200b</li> </ul>"},{"location":"04_I2C/13_1/#address-cells-1","title":"address-cells = &lt;1&gt;;","text":""},{"location":"04_I2C/13_1/#size-cells-0","title":"size-cells = &lt;0&gt;;","text":""},{"location":"04_I2C/14/","title":"14_\u200b\u4f7f\u7528\u200bGPIO\u200b\u64cd\u4f5c\u200bI2C\u200b\u8bbe\u5907\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":""},{"location":"04_I2C/14/#gpioi2c_imx6ull","title":"\u4f7f\u7528\u200bGPIO\u200b\u64cd\u4f5c\u200bI2C\u200b\u8bbe\u5907\u200b_IMX6ULL","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>i2c_spec.pdf</li> <li>Linux\u200b\u6587\u6863\u200b</li> <li><code>Linux-5.4\\Documentation\\devicetree\\bindings\\i2c\\i2c-gpio.yaml</code></li> <li><code>Linux-4.9.88\\Documentation\\devicetree\\bindings\\i2c\\i2c-gpio.txt</code></li> <li>Linux\u200b\u9a71\u52a8\u200b\u6e90\u7801\u200b</li> <li><code>Linux-5.4\\drivers\\i2c\\busses\\i2c-gpio.c</code></li> <li><code>Linux-4.9.88\\drivers\\i2c\\busses\\i2c-gpio.c</code></li> <li>\u200b\u6269\u5c55\u200b\u677f\u200b\u539f\u7406\u56fe\u200b\uff1a<code>imx6ull_extend_v10.pdf</code></li> <li>\u200b\u672c\u200b\u8282\u200b\u5bf9\u5e94\u200b\u7684\u200b\u4ee3\u7801\u200b\uff1a</li> <li><code>doc_and_source_for_drivers\\IMX6ULL\\source\\04_I2C\\07_i2c_gpio_dts_imx6ull</code></li> </ul>"},{"location":"04_I2C/14/#1","title":"1. \u200b\u786c\u4ef6\u200b\u8fde\u63a5","text":"<ul> <li>IMX6ULL\uff1a\u200b\u628a\u200bI2C\u200b\u6a21\u5757\u200b\u63a5\u5230\u200bGPIO   </li> </ul>"},{"location":"04_I2C/14/#2","title":"2. \u200b\u6839\u636e\u200b\u539f\u7406\u56fe\u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"04_I2C/14/#21","title":"2.1 \u200b\u539f\u7406\u56fe","text":""},{"location":"04_I2C/14/#22","title":"2.2 \u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811","text":"<pre><code>i2c_gpio_100ask {\n    compatible = \"i2c-gpio\";\n    gpios = &lt;&amp;gpio4 20 0 /* sda */\n             &amp;gpio4 21 0 /* scl */\n            &gt;;\n    i2c-gpio,delay-us = &lt;5&gt;;    /* ~100 kHz */\n    #address-cells = &lt;1&gt;;\n    #size-cells = &lt;0&gt;;\n};\n</code></pre> <p>\u200b\u628a\u200b\u4e0a\u8ff0\u200b\u4ee3\u7801\u200b\uff0c\u200b\u653e\u5165\u200b<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code>\u200b\u7684\u200b\u6839\u200b\u8282\u70b9\u200b\u4e0b\u9762\u200b\u3002</p>"},{"location":"04_I2C/14/#3-i2c-gpio","title":"3. \u200b\u786e\u8ba4\u200b\u5185\u6838\u200b\u5df2\u7ecf\u200b\u914d\u7f6e\u200b\u4e86\u200bI2C-GPIO","text":"<p>\u200b\u67e5\u770b\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u7684\u200b<code>.config</code>\uff0c\u200b\u5982\u679c\u200b\u672a\u200b\u8bbe\u7f6e\u200b<code>CONFIG_I2C_GPIO</code>\uff0c\u200b\u4e0a\u673a\u200b\u5b9e\u9a8c\u200b\u65f6\u200b\u9700\u8981\u200b\u914d\u7f6e\u200b\u5185\u6838\u200b\u3001\u200b\u7f16\u8bd1\u200bI2C-GPIO\u200b\u9a71\u52a8\u200b\u3002</p>"},{"location":"04_I2C/14/#4","title":"4. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":""},{"location":"04_I2C/14/#41","title":"4.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<ul> <li>IMX6ULL</li> </ul> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre>"},{"location":"04_I2C/14/#42","title":"4.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bIMX6ULL\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/100ask_imx6ull-14x14.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <ul> <li>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.1.100)</li> </ul> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> <ul> <li>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.1.137</li> </ul> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/100ask_imx6ull-14x14.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"04_I2C/14/#43-i2c-gpio","title":"4.3 \u200b\u7f16\u8bd1\u200bI2C-GPIO\u200b\u9a71\u52a8","text":""},{"location":"04_I2C/14/#1_1","title":"1. \u200b\u914d\u7f6e\u200b\u5185\u6838","text":"<p>\u200b\u5728\u200bIMX6ULL\u200b\u5185\u6838\u200b\u6e90\u7801\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b<code>make menuconfig</code>\u200b\u547d\u4ee4\u200b\uff0c\u200b\u5982\u4e0b\u200b\u914d\u7f6e\u200b\u5185\u6838\u200b\uff1a</p> <pre><code>Device Drivers  ---&gt;\n    I2C support  ---&gt;\n        I2C Hardware Bus support  ---&gt;\n            &lt;M&gt; GPIO-based bitbanging I2C      // \u200b\u8f93\u5165\u200bM\uff0c\u200b\u7f16\u8bd1\u200b\u4e3a\u200b\u6a21\u5757\u200b        \n</code></pre>"},{"location":"04_I2C/14/#2_1","title":"2. \u200b\u7f16\u8bd1\u200b\u6a21\u5757","text":"<p>\u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe\u540e\u200b\uff0c\u200b\u5728\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>make modules   // \u200b\u5f97\u5230\u200b drivers/i2c/busses/i2c-gpio.ko\n</code></pre>"},{"location":"04_I2C/14/#5","title":"5. \u200b\u6d4b\u8bd5","text":"<p>\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>[root@100ask:~]# i2cdetect -l    // \u200b\u52a0\u8f7d\u200bi2c-gpio.ko\u200b\u524d\u200b\u53ea\u200b\u770b\u5230\u200b2\u200b\u6761\u200bI2C BUS\ni2c-1   i2c             21a4000.i2c                             I2C adapter\ni2c-0   i2c             21a0000.i2c                             I2C adapter\n[root@100ask:~]#\n[root@100ask:~]# insmod /mnt/i2c-gpio.ko   \n[   45.067602] i2c-gpio i2c_gpio_100ask: using pins 116 (SDA) and 117 (SCL)\n[root@100ask:~]# i2cdetect -l     // \u200b\u52a0\u8f7d\u200bi2c-gpio.ko\u200b\u540e\u200b\u770b\u5230\u200b3\u200b\u6761\u200bI2C BUS\ni2c-1   i2c             21a4000.i2c                             I2C adapter\ni2c-4   i2c             i2c_gpio_100ask                         I2C adapter\ni2c-0   i2c             21a0000.i2c                             I2C adapter\n[root@100ask:~]#\n[root@100ask:~]# i2cdetect -y 4     // \u200b\u68c0\u6d4b\u200b\u5230\u200b0x50\u200b\u7684\u200b\u8bbe\u5907\u200b\n     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f\n00:          -- -- -- -- -- -- -- -- -- -- -- -- --\n10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n50: 50 -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n70: -- -- -- -- -- -- -- --\n[root@100ask:~]#\n[root@100ask:~]# i2cset -f -y 4 0x50 0 0x55   // \u200b\u5f80\u200b0\u200b\u5730\u5740\u200b\u5199\u5165\u200b0x55\n[root@100ask:~]# i2cget -f -y 4 0x50 0        // \u200b\u8bfb\u200b0\u200b\u5730\u5740\u200b\n0x55\n</code></pre>"},{"location":"04_I2C/15_1/","title":"15_\u200b\u5177\u4f53\u200b\u82af\u7247\u200b\u7684\u200bI2C_Adapter\u200b\u9a71\u52a8\u200b\u5206\u6790","text":""},{"location":"04_I2C/15_1/#i2c_adapter","title":"\u5177\u4f53\u200b\u82af\u7247\u200b\u7684\u200bI2C_Adapter\u200b\u9a71\u52a8\u200b\u5206\u6790","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux\u200b\u5185\u6838\u200b\u771f\u6b63\u200b\u7684\u200bI2C\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b</li> <li>IMX6ULL: <code>Linux-4.9.88\\drivers\\i2c\\busses\\i2c-imx.c</code></li> <li>STM32MP157: <code>Linux-5.4\\drivers\\i2c\\busses\\i2c-stm32f7.c</code></li> <li>\u200b\u82af\u7247\u200b\u624b\u518c\u200b</li> <li>IMXX6ULL\uff1a<code>IMX6ULLRM.pdf</code><ul> <li><code>Chapter 31: I2C Controller (I2C)</code></li> </ul> </li> <li>STM32MP157\uff1a<code>DM00327659.pdf</code><ul> <li><code>52 Inter-integrated circuit (I2C) interface</code></li> </ul> </li> </ul>"},{"location":"04_I2C/15_1/#1-i2c","title":"1. I2C\u200b\u63a7\u5236\u5668\u200b\u5185\u90e8\u7ed3\u6784","text":""},{"location":"04_I2C/15_1/#11","title":"1.1 \u200b\u901a\u7528\u200b\u7684\u200b\u7b80\u5316\u200b\u7ed3\u6784","text":""},{"location":"04_I2C/15_1/#12-imx6ulli2c","title":"1.2 IMX6ULL\u200b\u7684\u200bI2C\u200b\u63a7\u5236\u5668\u200b\u5185\u90e8\u7ed3\u6784","text":""},{"location":"04_I2C/15_1/#13-stm32mp157i2c","title":"1.3 STM32MP157\u200b\u7684\u200bI2C\u200b\u63a7\u5236\u5668\u200b\u5185\u90e8\u7ed3\u6784","text":""},{"location":"04_I2C/15_1/#2-i2c","title":"2. I2C\u200b\u63a7\u5236\u5668\u200b\u64cd\u4f5c\u65b9\u6cd5","text":"<ul> <li>\u200b\u4f7f\u80fd\u200b\u65f6\u949f\u200b\u3001\u200b\u8bbe\u7f6e\u200b\u65f6\u949f\u200b</li> <li>\u200b\u53d1\u9001\u6570\u636e\u200b\uff1a</li> <li>\u200b\u628a\u200b\u6570\u636e\u200b\u5199\u5165\u200b**tx_register**\uff0c\u200b\u7b49\u5f85\u200b\u4e2d\u65ad\u200b\u53d1\u751f\u200b</li> <li>\u200b\u4e2d\u65ad\u200b\u53d1\u751f\u200b\u540e\u200b\uff0c\u200b\u5224\u65ad\u200b\u72b6\u6001\u200b\uff1a\u200b\u662f\u5426\u200b\u53d1\u751f\u200b\u9519\u8bef\u200b\u3001\u200b\u662f\u5426\u200b\u5f97\u5230\u200b\u56de\u5e94\u200b\u4fe1\u53f7\u200b(ACK)</li> <li>\u200b\u628a\u200b\u4e0b\u200b\u4e00\u4e2a\u200b\u6570\u636e\u200b\u5199\u5165\u200b**tx_register**\uff0c\u200b\u7b49\u5f85\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u5982\u6b64\u200b\u5faa\u73af\u200b</li> <li>\u200b\u63a5\u6536\u6570\u636e\u200b\uff1a</li> <li>\u200b\u8bbe\u7f6e\u200b**controller_register**\uff0c\u200b\u8fdb\u5165\u200b\u63a5\u6536\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u542f\u52a8\u200b\u63a5\u6536\u200b\uff0c\u200b\u7b49\u5f85\u200b\u4e2d\u65ad\u200b\u53d1\u751f\u200b</li> <li>\u200b\u4e2d\u65ad\u200b\u53d1\u751f\u200b\u540e\u200b\uff0c\u200b\u5224\u65ad\u200b\u72b6\u6001\u200b\uff0c\u200b\u8bfb\u53d6\u200b**rx_register**\u200b\u5f97\u5230\u200b\u6570\u636e\u200b</li> <li>\u200b\u5982\u6b64\u200b\u5faa\u73af\u200b</li> </ul>"},{"location":"04_I2C/15_1/#3","title":"3. \u200b\u5206\u6790\u200b\u4ee3\u7801","text":""},{"location":"04_I2C/15_1/#31","title":"3.1 \u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li>IMX6ULL:  <code>arch/arm/boot/dts/imx6ull.dtsi</code></li> </ul> <pre><code>i2c1: i2c@021a0000 {\n      #address-cells = &lt;1&gt;;\n      #size-cells = &lt;0&gt;;\n      compatible = \"fsl,imx6ul-i2c\", \"fsl,imx21-i2c\";\n      reg = &lt;0x021a0000 0x4000&gt;;\n      interrupts = &lt;GIC_SPI 36 IRQ_TYPE_LEVEL_HIGH&gt;;\n      clocks = &lt;&amp;clks IMX6UL_CLK_I2C1&gt;;\n      status = \"disabled\";   // \u200b\u5728\u200b100ask_imx6ull-14x14.dts\u200b\u628a\u200b\u5b83\u200b\u6539\u4e3a\u200b\u4e86\u200b\"okay\"\n};\n</code></pre> <ul> <li>STM32MP157:  <code>arch/arm/boot/dts/stm32mp151.dtsi</code></li> </ul> <pre><code>i2c1: i2c@40012000 {\n      compatible = \"st,stm32mp15-i2c\";\n      reg = &lt;0x40012000 0x400&gt;;\n      interrupt-names = \"event\", \"error\";\n      interrupts-extended = &lt;&amp;exti 21 IRQ_TYPE_LEVEL_HIGH&gt;,\n                            &lt;&amp;intc GIC_SPI 32 IRQ_TYPE_LEVEL_HIGH&gt;;\n      clocks = &lt;&amp;rcc I2C1_K&gt;;\n      resets = &lt;&amp;rcc I2C1_R&gt;;\n      #address-cells = &lt;1&gt;;\n      #size-cells = &lt;0&gt;;\n      dmas = &lt;&amp;dmamux1 33 0x400 0x80000001&gt;,\n             &lt;&amp;dmamux1 34 0x400 0x80000001&gt;;\n      dma-names = \"rx\", \"tx\";\n      power-domains = &lt;&amp;pd_core&gt;;\n      st,syscfg-fmp = &lt;&amp;syscfg 0x4 0x1&gt;;\n      wakeup-source;\n      status = \"disabled\";   // \u200b\u5728\u200bstm32mp15xx-100ask.dtsi\u200b\u628a\u200b\u5b83\u200b\u6539\u4e3a\u200b\u4e86\u200b\"okay\"\n};\n</code></pre>"},{"location":"04_I2C/15_1/#32","title":"3.2 \u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5206\u6790","text":"<p>\u200b\u8bfb\u200bI2C\u200b\u6570\u636e\u200b\u65f6\u200b\uff0c\u200b\u8981\u200b\u5148\u200b\u53d1\u51fa\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\uff0c\u200b\u8fd9\u200b\u662f\u200b\u5199\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u7136\u540e\u200b\u518d\u200b\u53d1\u8d77\u200b\u8bfb\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u6d89\u53ca\u200b\u5199\u200b\u3001\u200b\u8bfb\u200b\u64cd\u4f5c\u200b\u3002\u200b\u6240\u4ee5\u200b\u4ee5\u8bfb\u200bI2C\u200b\u6570\u636e\u200b\u4e3a\u4f8b\u200b\u8bb2\u89e3\u200b\u6838\u5fc3\u200b\u4ee3\u7801\u200b\u3002</p> <ul> <li> <p>IMX6ULL\uff1a\u200b\u51fd\u6570\u200b<code>i2c_imx_xfer</code>\u200b\u5206\u6790\u200b\uff1a   </p> </li> <li> <p>STM32MP157\uff1a\u200b\u51fd\u6570\u200b<code>stm32f7_i2c_xfer</code>\u200b\u5206\u6790\u200b   \u200b\u8fd9\u200b\u51fd\u6570\u200b\u5b8c\u5168\u200b\u6709\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6765\u200b\u9a71\u52a8\u200b\uff1a\u200b\u542f\u52a8\u200b\u4f20\u8f93\u200b\u540e\u200b\uff0c\u200b\u5c31\u200b\u7b49\u5f85\u200b\uff1b\u200b\u5728\u200b\u4e2d\u65ad\u200b\u670d\u52a1\u7a0b\u5e8f\u200b\u91cc\u200b\u4f20\u8f93\u200b\u4e0b\u200b\u4e00\u4e2a\u200b\u6570\u636e\u200b\uff0c\u200b\u77e5\u9053\u200b\u4f20\u8f93\u200b\u5b8c\u6bd5\u200b\u3002</p> </li> <li> <p>\u200b\u542f\u52a8\u200b\u4f20\u8f93\u200b     </p> </li> <li> <p>\u200b\u901a\u8fc7\u200b\u4e2d\u65ad\u200b\u8fdb\u884c\u200b\u540e\u7eed\u200b\u4f20\u8f93\u200b     </p> </li> </ul>"},{"location":"05_Input/01/","title":"01_Input\u200b\u5b50\u7cfb\u7edf\u200b\u89c6\u9891\u200b\u4ecb\u7ecd","text":""},{"location":"05_Input/01/#input","title":"Input\u200b\u5b50\u7cfb\u7edf\u200b\u89c6\u9891\u200b\u4ecb\u7ecd","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux 5.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Documentation\\input\\input-programming.rst</li> <li>Documentation\\input\\event-codes.rst</li> <li>Linux 4.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Documentation\\input\\input-programming.txt</li> <li>Documentation\\input\\event-codes.txt</li> </ul>"},{"location":"05_Input/01/#1","title":"1. \u200b\u8f93\u5165\u200b\u8bbe\u5907\u200b\u7684\u200b\u79cd\u7c7b","text":"<p>\u200b\u8f93\u5165\u200b\u8bbe\u5907\u200b\u79cd\u7c7b\u200b\u5f88\u591a\u200b\uff0c\u200b\u6709\u200bGPIO\u200b\u6309\u952e\u200b\u3001\u200b\u9f20\u6807\u200b\u3001\u200b\u7535\u963b\u200b\u89e6\u6478\u5c4f\u200b\u3001\u200b\u7535\u5bb9\u200b\u89e6\u6478\u5c4f\u200b\u3001USB\u200b\u952e\u76d8\u200b\u3001\u200b\u9065\u63a7\u200b\u624b\u67c4\u200b\u7b49\u7b49\u200b\u3002 \u200b\u5b89\u88c5\u200b\u5b83\u200b\u80fd\u200b\u4ea7\u751f\u200b\u7684\u200b\u6570\u636e\u7c7b\u578b\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5206\u4e3a\u200b(\u200b\u524d\u9762\u200b3\u200b\u9879\u200b\u6bd4\u8f83\u200b\u5bb9\u6613\u200b\u7406\u89e3\u200b\uff0c\u200b\u540e\u9762\u200b\u7684\u200b\u5c31\u200b\u5c5e\u4e8e\u200b\u6269\u5c55\u200b\u4e86\u200b)\uff1a</p> <ul> <li>\u200b\u6309\u952e\u200b\uff1aEV_KEY\uff0c\u200b\u6bd4\u5982\u200b\u952e\u76d8\u200b</li> <li>\u200b\u76f8\u5bf9\u200b\u4f4d\u79fb\u200b\uff1aEV_REL\uff0c\u200b\u6bd4\u5982\u200b\u9f20\u6807\u200b</li> <li>\u200b\u7edd\u5bf9\u200b\u4f4d\u79fb\u200b\uff1aEV_ABS\uff0c\u200b\u6bd4\u5982\u200b\u89e6\u6478\u5c4f\u200b</li> <li>\u200b\u6742\u9879\u200b\uff1aEV_MSC</li> <li>\u200b\u8f6f\u4ef6\u200b\uff1aEV_SW</li> <li>LED\uff1aEV_LED</li> <li>\u200b\u58f0\u97f3\u200b\uff1aEV_SND</li> <li>\u200b\u4f1a\u200b\u81ea\u52a8\u200b\u53d1\u51fa\u200b\u91cd\u590d\u200b\u6309\u952e\u200b\uff1aEV_REP</li> <li>\u200b\u7535\u6e90\u5f00\u5173\u200b\u3001\u200b\u6309\u952e\u200b\uff1aEV_PWR</li> </ul>"},{"location":"05_Input/01/#2","title":"2. \u200b\u8f93\u5165\u200b\u8bbe\u5907\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":"<p>\u200b\u6709\u6ca1\u6709\u200b\u4e00\u4e2a\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u80fd\u200b\u652f\u6301\u200b\u90a3\u4e48\u200b\u591a\u200b\u7684\u200b\u8bbe\u5907\u200b\uff1f\u200b\u6ca1\u6709\u200b\uff01 \u200b\u6709\u6ca1\u6709\u200b\u4e00\u5957\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u5bb9\u6613\u200b\u6269\u5c55\u200b\uff0c\u200b\u6700\u7ec8\u200b\u80fd\u200b\u652f\u6301\u200b\u90a3\u4e48\u200b\u591a\u200b\u7684\u200b\u8bbe\u5907\u200b\uff1f\u200b\u6709\u200b\uff01 \u200b\u8fd9\u200b\u5c31\u662f\u200b\u8f93\u5165\u200b\u5b50\u7cfb\u7edf\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u6846\u67b6\u200b\u5982\u4e0b\u200b\uff1a </p>"},{"location":"05_Input/01/#3","title":"3. \u200b\u8bb2\u200b\u4ec0\u4e48\u200b\u5185\u5bb9","text":""},{"location":"05_Input/01/#31","title":"3.1 \u200b\u6846\u67b6","text":""},{"location":"05_Input/01/#32-evdevc","title":"3.2 evdev.c\u200b\u5256\u6790","text":""},{"location":"05_Input/01/#33-input_dev","title":"3.3 input_dev\u200b\u9a71\u52a8\u200b\u7f16\u5199","text":""},{"location":"05_Input/01/#34-gpio","title":"3.4 GPIO\u200b\u6309\u952e\u200b\u9a71\u52a8\u200b\u5206\u6790\u200b\u4e0e\u200b\u4f7f\u7528","text":"<ul> <li>\u200b\u5206\u6790\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200bGPIO\u200b\u6309\u952e\u200b\u9a71\u52a8\u200b\uff1adrivers\\input\\keyboard\\gpio_keys.c</li> <li>\u200b\u4f7f\u7528\u200b</li> </ul>"},{"location":"05_Input/01/#35-qemu","title":"3.5 \u200b\u5728\u200bQEMU\u200b\u4e0a\u200b\u5b9e\u73b0\u200b\u6700\u200b\u7b80\u5355\u200b\u7684\u200b\u89e6\u6478\u5c4f\u200b\u9a71\u52a8","text":""},{"location":"05_Input/01/#36-i2c","title":"3.6 I2C\u200b\u63a5\u53e3\u200b\u7684\u200b\u89e6\u6478\u5c4f\u200b\u9a71\u52a8\u200b\u5206\u6790\u200b\u4e0e\u200b\u5b9e\u8df5","text":""},{"location":"05_Input/01/#37-uinput","title":"3.7 UInput: \u200b\u7528\u6237\u200b\u6001\u200b\u6a21\u62df\u200b\u8f93\u5165\u200b\u8bbe\u5907","text":""},{"location":"05_Input/02/","title":"02_\u200b\u5148\u200b\u5b66\u4e60\u200b\u8f93\u5165\u200b\u7cfb\u7edf\u200b\u5e94\u7528\u200b\u7f16\u7a0b","text":""},{"location":"05_Input/02/#_1","title":"\u5148\u200b\u5b66\u4e60\u200b\u8f93\u5165\u200b\u7cfb\u7edf\u200b\u5e94\u7528\u200b\u7f16\u7a0b","text":""},{"location":"05_Input/02/#1-linux","title":"1. \u200b\u767e\u95ee\u200b\u7f51\u200bLinux\u200b\u89c6\u9891\u200b\u4f53\u7cfb","text":""},{"location":"05_Input/02/#2","title":"2. \u200b\u5efa\u8bae","text":"<p>\u200b\u5728\u200b\u300aLinux\u200b\u7cfb\u5217\u200b\u6559\u7a0b\u200b\u4e4b\u200b\u5feb\u901f\u200b\u5165\u95e8\u200b\u300b\u200b\u7684\u200b\u300a\u200b\u5d4c\u5165\u5f0f\u200bLinux\u200b\u5e94\u7528\u200b\u5f00\u53d1\u200b\u57fa\u7840\u77e5\u8bc6\u200b\u300b\u200b\u7684\u200b\u89c6\u9891\u200b\u91cc\u200b\uff0c \u200b\u6211\u4eec\u200b\u8bb2\u89e3\u200b\u4e86\u200b9\u200b\u8282\u200b\u7684\u200b\u8f93\u5165\u200b\u7cfb\u7edf\u200b\u5e94\u7528\u200b\u7f16\u7a0b\u200b\uff1a</p> <pre><code>1.\u200b\u8f93\u5165\u200b\u7cfb\u7edf\u200b\u6846\u67b6\u200b\u53ca\u200b\u8c03\u8bd5\u200b\n2.\u200b\u73b0\u573a\u200b\u7f16\u7a0b\u200b\u8bfb\u53d6\u200b\u83b7\u53d6\u200b\u8f93\u5165\u200b\u8bbe\u5907\u200b\u4fe1\u606f\u200b\n3.\u200b\u67e5\u8be2\u200b_\u200b\u4f11\u7720\u200b\u5524\u9192\u200b_\u200b\u65b9\u5f0f\u200b\u8bfb\u53d6\u200b\u8f93\u5165\u200b\u6570\u636e\u200b\n4.POLL_SELECT_\u200b\u65b9\u5f0f\u200b\u8bfb\u53d6\u200b\u8f93\u5165\u200b\u6570\u636e\u200b\n5.\u200b\u5f02\u6b65\u200b\u901a\u77e5\u200b\u65b9\u5f0f\u200b\u8bfb\u53d6\u200b\u8f93\u5165\u200b\u6570\u636e\u200b\n6.\u200b\u7535\u963b\u200b\u5c4f\u200b\u548c\u200b\u7535\u5bb9\u200b\u5c4f\u200b\n7.tslib\u200b\u6846\u67b6\u200b\u5206\u6790\u200b\n8.tslib\u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200b\u4e0e\u200b\u6d4b\u8bd5\u200b\n9.\u200b\u7f16\u5199\u200b\u57fa\u4e8e\u200btslib\u200b\u7684\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b\n</code></pre> <p>\u200b\u5f3a\u70c8\u5efa\u8bae\u200b\u5148\u200b\u5b66\u4e60\u200b\u8fd9\u200b9\u200b\u4e2a\u200b\u89c6\u9891\u200b\uff0c\u200b\u81f3\u5c11\u200b\u5fc5\u987b\u200b\u5b66\u4e60\u200b\u5176\u4e2d\u200b\u8fd9\u200b4\u200b\u4e2a\u200b\u89c6\u9891\u200b\uff1a</p> <pre><code>1.\u200b\u8f93\u5165\u200b\u7cfb\u7edf\u200b\u6846\u67b6\u200b\u53ca\u200b\u8c03\u8bd5\u200b\n2.\u200b\u73b0\u573a\u200b\u7f16\u7a0b\u200b\u8bfb\u53d6\u200b\u83b7\u53d6\u200b\u8f93\u5165\u200b\u8bbe\u5907\u200b\u4fe1\u606f\u200b\n3.\u200b\u67e5\u8be2\u200b_\u200b\u4f11\u7720\u200b\u5524\u9192\u200b_\u200b\u65b9\u5f0f\u200b\u8bfb\u53d6\u200b\u8f93\u5165\u200b\u6570\u636e\u200b\n6.\u200b\u7535\u963b\u200b\u5c4f\u200b\u548c\u200b\u7535\u5bb9\u200b\u5c4f\u200b\n</code></pre>"},{"location":"05_Input/02/#3","title":"3. \u200b\u89c6\u9891\u200b\u5728\u200b\u54ea\u91cc","text":"<p>\u200b\u4f60\u200b\u5f53\u7136\u200b\u53ef\u4ee5\u200b\u53bb\u200b\u5b66\u4e60\u200b\u300a\u200b\u5d4c\u5165\u5f0f\u200bLinux\u200b\u5e94\u7528\u200b\u5f00\u53d1\u200b\u57fa\u7840\u77e5\u8bc6\u200b\u300b\u200b\u4e2d\u200b\u7684\u200b\u8f93\u5165\u200b\u7cfb\u7edf\u200b\u5e94\u7528\u200b\u7f16\u7a0b\u200b\u7684\u200b\u89c6\u9891\u200b\uff0c \u200b\u4e3a\u4e86\u200b\u65b9\u4fbf\u200b\u5927\u5bb6\u200b\u5b66\u4e60\u200b\uff0c\u200b\u4e3a\u4e86\u200b\u4fdd\u6301\u200b\u89c6\u9891\u200b\u7684\u200b\u5b8c\u6574\u6027\u200b\uff0c\u200b\u6211\u4eec\u200b\u628a\u200b\u8fd9\u4e9b\u200b\u89c6\u9891\u200b\u4e5f\u200b\u653e\u5230\u200b\u4e86\u200b\u300a\u200b\u9a71\u52a8\u200b\u5927\u5168\u200b\u300b\u200b\u91cc\u200b\u3002</p>"},{"location":"05_Input/02/#31-linux","title":"3.1 \u200b\u5728\u200b\u300a\u200b\u5d4c\u5165\u5f0f\u200bLinux\u200b\u5e94\u7528\u200b\u5f00\u53d1\u200b\u57fa\u7840\u200b\u300b\u200b\u91cc","text":"<p>\u200b\u6253\u5f00\u200b\u5b98\u7f51\u200b\uff0c\u200b\u6839\u636e\u200b\u4e0b\u56fe\u200b\u627e\u5230\u200b\u89c6\u9891\u200b </p>"},{"location":"05_Input/02/#32","title":"3.2 \u200b\u5728\u200b\u9a71\u52a8\u200b\u5927\u5168\u200b\u91cc","text":"<p>\u200b\u4e3a\u4e86\u200b\u4fdd\u6301\u200b\u89c6\u9891\u200b\u7684\u200b\u5b8c\u6574\u6027\u200b\uff0c\u200b\u6211\u4eec\u200b\u628a\u200b\u8fd9\u200b9\u200b\u4e2a\u200b\u89c6\u9891\u200b\u4e5f\u200b\u653e\u5230\u200b\u4e86\u200b\u9a71\u52a8\u200b\u5927\u5168\u200b\u91cc\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"05_Input/02/#4","title":"4. \u200b\u6587\u6863\u200b\u3001\u200b\u6e90\u7801\u200b\u3001\u200b\u56fe\u7247\u200b\u5728\u200b\u54ea","text":"<p>\u200b\u8f93\u5165\u200b\u7cfb\u7edf\u200b\u5e94\u7528\u200b\u7f16\u7a0b\u200b\u5bf9\u5e94\u200b\u7684\u200b\u6587\u6863\u200b\u3001\u200b\u6e90\u7801\u200b\u3001\u200b\u56fe\u7247\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u4ece\u200b\u5b83\u200b\u7684\u200b\u539f\u59cb\u200bGIT\u200b\u4ed3\u5e93\u200b\u83b7\u5f97\u200b\u3002 \u200b\u4e3a\u4e86\u200b\u4fdd\u6301\u200b\u89c6\u9891\u200b\u7684\u200b\u5b8c\u6574\u6027\u200b\uff0c\u200b\u6211\u4eec\u200b\u628a\u200b\u8fd9\u4e9b\u200b\u8d44\u6599\u200b\u4e5f\u200b\u653e\u5230\u200b\u7684\u200b\u9a71\u52a8\u200b\u5927\u5168\u200b\u7684\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\u3002</p> <ul> <li>\u200b\u5728\u200b\u300aLinux\u200b\u7cfb\u5217\u200b\u6559\u7a0b\u200b\u4e4b\u200b\u5feb\u901f\u200b\u5165\u95e8\u200b\u300b\u200b\u7684\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b</li> </ul> <pre><code>git clone https://e.coding.net/weidongshan/01_all_series_quickstart.git\n</code></pre> <ul> <li>\u200b\u5728\u200b\u300a\u200b\u9a71\u52a8\u200b\u5927\u5168\u200b\u300b\u200b\u7684\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b</li> </ul> <pre><code>git clone https://e.coding.net/weidongshan/linux/doc_and_source_for_drivers.git\n</code></pre> <p>\u200b\u5b83\u4eec\u200b\u7684\u200b\u4f4d\u7f6e\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b(\u200b\u5de6\u8fb9\u200b\u662f\u200b\u539f\u59cb\u200b\u4ed3\u5e93\u200b\uff0c\u200b\u53f3\u8fb9\u200b\u662f\u200b\u9a71\u52a8\u200b\u5927\u5168\u200b\u4ed3\u5e93\u200b)\uff1a</p> <p></p>"},{"location":"05_Input/04_1/","title":"DRV_01_Input\u200b\u5b50\u7cfb\u7edf\u200b\u6846\u67b6\u200b\u8be6\u89e3","text":""},{"location":"05_Input/04_1/#input","title":"Input\u200b\u5b50\u7cfb\u7edf\u200b\u6846\u67b6\u200b\u8be6\u89e3","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux 5.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Documentation\\input\\input-programming.rst</li> <li>Documentation\\input\\event-codes.rst</li> <li>Linux 4.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Documentation\\input\\input-programming.txt</li> <li>Documentation\\input\\event-codes.txt</li> </ul>"},{"location":"05_Input/04_1/#1","title":"1. \u200b\u56de\u987e\u200b\u5b57\u7b26\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p> \u200b\u600e\u4e48\u200b\u7f16\u5199\u200b\u5b57\u7b26\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff1f</p> <ul> <li>\u200b\u786e\u5b9a\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u53f7\u200b</li> <li>\u200b\u521b\u5efa\u200bfile_operations\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> <li>\u200b\u5728\u200b\u91cc\u9762\u200b\u586b\u5145\u200bdrv_open/drv_read/drv_ioctl\u200b\u7b49\u200b\u51fd\u6570\u200b</li> <li>\u200b\u6ce8\u518c\u200bfile_operations\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> <li>register_chrdev(major, &amp;fops, name)</li> <li>\u200b\u8c01\u200b\u8c03\u7528\u200bregister_chrdev\uff1f\u200b\u5728\u200b\u5165\u53e3\u200b\u51fd\u6570\u8c03\u7528\u200b</li> <li>\u200b\u6709\u200b\u5165\u53e3\u200b\u81ea\u7136\u200b\u5c31\u200b\u6709\u200b\u51fa\u53e3\u200b</li> <li>\u200b\u5728\u200b\u51fa\u53e3\u200b\u51fd\u6570\u200bunregister_chrdev</li> <li>\u200b\u8f85\u52a9\u200b\u51fd\u6570\u200b(\u200b\u5e2e\u52a9\u200b\u7cfb\u7edf\u200b\u81ea\u52a8\u200b\u521b\u5efa\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b)</li> <li>class_create</li> <li>device_create</li> </ul>"},{"location":"05_Input/04_1/#2-input","title":"2. Input\u200b\u5b50\u7cfb\u7edf\u200b\u6846\u67b6","text":""},{"location":"05_Input/04_1/#3-input","title":"3. Input\u200b\u5b50\u7cfb\u7edf\u200b\u5185\u90e8\u200b\u5b9e\u73b0","text":""},{"location":"05_Input/04_1/#31","title":"3.1 \u200b\u91cd\u8981\u200b\u7ed3\u6784\u200b\u4f53","text":"<ul> <li> <p>\u200b\u5de6\u8fb9\u200b\u7684\u200binput_dev\u200b\u8868\u793a\u200b\u8f93\u5165\u200b\u8bbe\u5907\u200b   </p> </li> <li> <p>\u200b\u53f3\u8fb9\u200b\u7684\u200binput_handler\u200b\u8868\u793a\u200b\"\u200b\u5904\u7406\u7a0b\u5e8f\u200b\" </p> </li> <li> <p>\u200b\u5339\u914d\u200b\u4e4b\u540e\u200b\u4f7f\u7528\u200binput_handle\u200b\u4fdd\u5b58\u200b2\u200b\u8005\u200b\u4e4b\u95f4\u200b\u7684\u200b\u8054\u7cfb\u200b</p> </li> </ul> <p></p> <ul> <li>\u200b\u8bbe\u5907\u200b\u83b7\u53d6\u200b\u3001\u200b\u4e0a\u62a5\u200b\u6570\u636e\u200b\uff1ainput_event</li> </ul> <p></p>"},{"location":"05_Input/04_1/#32","title":"3.2 \u200b\u6ce8\u518c\u200b\u6d41\u7a0b\u200b\u6f14\u793a","text":"<p>\u200b\u770b\u200b\u89c6\u9891\u200b\u3002</p> <ul> <li>\u200b\u6ce8\u518c\u200binput_dev\uff1ainput_register_device</li> <li>\u200b\u628a\u200binput_dev\u200b\u653e\u5165\u200binput.c\u200b\u7684\u200binput_dev_list\u200b\u94fe\u8868\u200b</li> <li>\u200b\u5bf9\u4e8e\u200binput.c\u200b\u7684\u200binput_handler_list\u200b\u94fe\u8868\u200b\u4e2d\u200b\u7684\u200b\u6bcf\u200b\u4e00\u4e2a\u200binput_handler\uff0c\u200b\u4e00\u4e00\u200b\u6bd4\u8f83\u200b</li> <li>\u200b\u5982\u679c\u200b\u5339\u914d\u200b\u5219\u200b\u8c03\u7528\u200binput_handler.connect</li> <li>\u200b\u6ce8\u518c\u200binput_handler: input_register_handler</li> <li>\u200b\u628a\u200binput_dev\u200b\u653e\u5165\u200binput.c\u200b\u7684\u200binput_handler_list\u200b\u94fe\u8868\u200b</li> <li>\u200b\u5bf9\u4e8e\u200binput.c\u200b\u7684\u200binput_dev_list\u200b\u94fe\u8868\u200b\u4e2d\u200b\u7684\u200b\u6bcf\u200b\u4e00\u4e2a\u200binput_dev\uff0c\u200b\u4e00\u4e00\u200b\u6bd4\u8f83\u200b</li> <li> <p>\u200b\u5982\u679c\u200b\u5339\u914d\u200b\u5219\u200b\u8c03\u7528\u200binput_handler.connect</p> </li> <li> <p>\u200b\u600e\u4e48\u200b\u5224\u65ad\u200binput_dev\u200b\u548c\u200binput_handler\u200b\u662f\u5426\u200b\u5339\u914d\u200b</p> </li> <li>input_handler\u200b\u4e2d\u6709\u200b\u4e00\u4e2a\u200bid_table\uff0c\u200b\u8868\u793a\u200b\u5b83\u200b\u652f\u6301\u200b\u54ea\u7c7b\u200b\u8bbe\u5907\u200b</li> <li>input_handler\u200b\u8fd8\u6709\u200b\u4e00\u4e2a\u200bmatch\u200b\u51fd\u6570\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u7528\u6765\u200b\u8fdb\u884c\u200b\u590d\u6742\u200b\u7684\u200b\u5224\u65ad\u200b</li> <li>match\u200b\u51fd\u6570\u200b\u53ef\u4ee5\u200b\u7701\u7565\u200b</li> <li> <p>\u200b\u5224\u65ad\u200b\u662f\u5426\u200b\u5339\u914d\u200b\u6d41\u7a0b\u200b</p> <ul> <li>\u200b\u5982\u679c\u200b\u6ca1\u6709\u200bmatch\u200b\u51fd\u6570\u200b\uff1ainput_dev\u200b\u8ddf\u200bid_table\u200b\u6bd4\u8f83\u200b\u5373\u53ef\u200b</li> <li>\u200b\u5982\u679c\u200b\u6709\u200bmatch\u200b\u51fd\u6570\u200b\uff1ainput_dev\u200b\u5148\u200b\u8ddf\u200bid_table\u200b\u6bd4\u8f83\u200b\uff0c\u200b\u6210\u529f\u200b\u540e\u200b\u518d\u200b\u7528\u200bmatch\u200b\u51fd\u6570\u200b\u518d\u6b21\u200b\u5224\u65ad\u200b</li> </ul> </li> <li> <p>\u200b\u5339\u914d\u200b\u540e\u200b\u505a\u200b\u7684\u200b\u4e8b\u60c5\u200b</p> </li> <li> <p>\u200b\u8c03\u7528\u200binput_handler.connect</p> <ul> <li>\u200b\u521b\u5efa\u200b/\u200b\u6ce8\u518c\u200b\u4e00\u4e2a\u200binput_handle\uff0c\u200b\u628a\u200binput_dev, input_handler\u200b\u653e\u5728\u200b\u91cc\u9762\u200b</li> </ul> <pre><code>\u200b\u7c7b\u4f3c\u200b\uff1a\n    evdev-&gt;handle.dev = input_get_device(dev);\n  evdev-&gt;handle.handler = handler;\n\n  error = input_register_handle(&amp;evdev-&gt;handle);\n</code></pre> <ul> <li>\u200b\u6ce8\u518c\u200b\u5b57\u7b26\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</li> </ul> <pre><code>\u200b\u7c7b\u4f3c\u200b\uff1a\n  cdev_init(&amp;evdev-&gt;cdev, &amp;evdev_fops);\n\n  error = cdev_device_add(&amp;evdev-&gt;cdev, &amp;evdev-&gt;dev);\n</code></pre> </li> </ul>"},{"location":"05_Input/04_1/#33","title":"3.3 \u200b\u8bfb\u53d6\u200b\u4e00\u4e2a\u200b\u6570\u636e\u200b\u7684\u200b\u6d41\u7a0b\u200b\u6f14\u793a","text":"<ul> <li> <p>APP\u200b\u8c03\u7528\u200bopen\u200b\u51fd\u6570\u200b\u6253\u5f00\u200b<code>/dev/input/event0</code></p> </li> <li> <p>\u200b\u5728\u200b\u9a71\u52a8\u7a0b\u5e8f\u200bevdev_open\u200b\u91cc\u200b\uff0c\u200b\u521b\u5efa\u200b\u4e00\u4e2a\u200bevdev_client\uff0c\u200b\u8868\u793a\u200b\u4e00\u4e2a\u200b\"\u200b\u5ba2\u6237\u200b\"</p> </li> <li> <p>APP\u200b\u8c03\u7528\u200bread/poll\u200b\u8bfb\u53d6\u200b\u3001\u200b\u7b49\u5f85\u200b\u6570\u636e\u200b</p> </li> <li> <p>\u200b\u6ca1\u6709\u200b\u6570\u636e\u200b\u65f6\u200b\u4f11\u7720\u200b\uff1a<code>wait_event_interruptible(evdev-&gt;wait, ...)</code></p> </li> <li> <p>\u200b\u70b9\u51fb\u200b\u3001\u200b\u64cd\u4f5c\u200b\u8f93\u5165\u200b\u8bbe\u5907\u200b\uff0c\u200b\u4ea7\u751f\u200b\u4e2d\u65ad\u200b</p> </li> <li> <p>\u200b\u5728\u200b\u4e2d\u65ad\u200b\u670d\u52a1\u7a0b\u5e8f\u200b\u91cc\u200b</p> </li> <li> <p>\u200b\u4ece\u200b\u786c\u4ef6\u200b\u8bfb\u53d6\u200b\u5230\u200b\u6570\u636e\u200b</p> </li> <li> <p>\u200b\u4f7f\u7528\u200b\u4ee5\u4e0b\u200b\u51fd\u6570\u200b\u4e0a\u62a5\u200b\u6570\u636e\u200b</p> <pre><code>void input_event(struct input_dev *dev,\n         unsigned int type, unsigned int code, int value);\n\nstatic inline void input_sync(struct input_dev *dev); // \u200b\u5b9e\u8d28\u200b\u4e5f\u200b\u662f\u200b input_event\n</code></pre> </li> <li> <p>input_event\u200b\u505a\u200b\u4ec0\u4e48\u200b\uff1f</p> </li> <li> <p>\u200b\u4ece\u200bdev-&gt;h_list\u200b\u4e2d\u200b\u53d6\u51fa\u200binput_handle\uff0c\u200b\u4ece\u200binput_handle\u200b\u53d6\u51fa\u200binput_handler</p> </li> <li>\u200b\u4f18\u5148\u200b\u8c03\u7528\u200binput_handler-&gt;filter\u200b\u6765\u200b\u5904\u7406\u200b</li> <li> <p>\u200b\u5982\u679c\u200b\u6ca1\u6709\u200binput_handler-&gt;filter\u200b\u6216\u8005\u200b\u6ca1\u200b\u5904\u7406\u200b\u6210\u529f\u200b</p> <ul> <li>\u200b\u8c03\u7528\u200binput_handler-&gt;events</li> <li>\u200b\u6ca1\u6709\u200binput_handler-&gt;events\u200b\u7684\u8bdd\u200b\uff0c\u200b\u8c03\u7528\u200binput_handler-&gt;event</li> </ul> </li> <li> <p>\u200b\u4ee5\u200bevdev.c\u200b\u4e3a\u4f8b\u200b</p> </li> <li>\u200b\u5b83\u200b\u6709\u200bevdev_events\uff1a\u200b\u7528\u6765\u200b\u5904\u7406\u200b\u591a\u4e2a\u200b\u4e8b\u4ef6\u200b</li> <li>\u200b\u4e5f\u200b\u6709\u200bevdev_event\uff1a\u200b\u5b9e\u8d28\u200b\u8fd8\u662f\u200b\u8c03\u7528\u200bevdev_events</li> <li>\u200b\u5524\u9192\u200b\"\u200b\u5ba2\u6237\u200b\"\uff1awake_up_interruptible(&amp;evdev-&gt;wait);</li> </ul>"},{"location":"05_Input/04_2/","title":"DRV_02_\u200b\u7f16\u5199\u200binput_dev\u200b\u9a71\u52a8\u200b\u6846\u67b6","text":""},{"location":"05_Input/04_2/#input_dev","title":"\u7f16\u5199\u200binput_dev\u200b\u9a71\u52a8\u200b\u6846\u67b6","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux 5.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Documentation\\input\\input-programming.rst</li> <li>Documentation\\input\\event-codes.rst</li> <li>Linux 4.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Documentation\\input\\input-programming.txt</li> <li> <p>Documentation\\input\\event-codes.txt</p> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u4ee3\u7801\u200b\uff1aGIT\u200b\u4ed3\u5e93\u200b\u4e2d\u200b</p> </li> </ul> <pre><code>IMX6ULL\\source\\05_Input\\02_input_dev_framework\nSTM32MP157\\source\\A7\\05_Input\\02_input_dev_framework\n</code></pre>"},{"location":"05_Input/04_2/#1","title":"1. \u200b\u56de\u987e\u200b\u6846\u67b6","text":""},{"location":"05_Input/04_2/#2-input_dev","title":"2. \u200b\u600e\u4e48\u200b\u7f16\u5199\u200binput_dev\u200b\u9a71\u52a8","text":""},{"location":"05_Input/04_2/#21-input_dev","title":"2.1 \u200b\u5206\u914d\u200b/\u200b\u8bbe\u7f6e\u200b/\u200b\u6ce8\u518c\u200binput_dev","text":""},{"location":"05_Input/04_2/#22","title":"2.2 \u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u64cd\u4f5c","text":"<ul> <li> <p>\u200b\u7533\u8bf7\u200b\u4e2d\u65ad\u200b</p> </li> <li> <p>\u200b\u5728\u200b\u4e2d\u65ad\u200b\u670d\u52a1\u7a0b\u5e8f\u200b\u91cc\u200b</p> </li> <li> <p>\u200b\u8bfb\u53d6\u200b\u786c\u4ef6\u200b\u83b7\u5f97\u200b\u6570\u636e\u200b</p> </li> <li> <p>\u200b\u4e0a\u62a5\u200b\u6570\u636e\u200b</p> <pre><code>void input_event(struct input_dev *dev,\n         unsigned int type, unsigned int code, int value);\n\nstatic inline void input_sync(struct input_dev *dev); // \u200b\u5b9e\u8d28\u200b\u4e5f\u200b\u662f\u200b input_event\n</code></pre> </li> </ul>"},{"location":"05_Input/04_2/#3","title":"3. \u200b\u73b0\u573a\u200b\u7f16\u7a0b","text":"<ul> <li>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u521b\u5efa\u200b\u4e00\u4e2a\u200b\u8282\u70b9\u200b</li> <li>\u200b\u6307\u5b9a\u200b\u786c\u4ef6\u8d44\u6e90\u200b\u7b49\u200b\u4fe1\u606f\u200b</li> <li>\u200b\u7f16\u8bd1\u200b\u4e00\u4e2a\u200bplartform_driver\u200b\u9a71\u52a8\u200b</li> <li>\u200b\u5728\u200bprobe\u200b\u51fd\u6570\u200b\u91cc\u200b<ul> <li>\u200b\u4ece\u200b\u8bbe\u5907\u200b\u6811\u200b\u83b7\u5f97\u200b\u8d44\u6e90\u200b</li> <li>\u200b\u5206\u914d\u200b/\u200b\u8bbe\u7f6e\u200b/\u200b\u6ce8\u518c\u200binput_dev</li> <li>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u64cd\u4f5c\u200b</li> <li>request_irq\u200b\u7b49\u200b</li> </ul> </li> </ul>"},{"location":"05_Input/04_3/","title":"DRV_03_\u200b\u7f16\u5199\u200b\u6700\u200b\u7b80\u5355\u200b\u7684\u200b\u89e6\u6478\u5c4f\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b_\u200b\u57fa\u4e8e\u200bQEMU","text":""},{"location":"05_Input/04_3/#_qemu","title":"\u7f16\u5199\u200b\u6700\u200b\u7b80\u5355\u200b\u7684\u200b\u89e6\u6478\u5c4f\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b_\u200b\u57fa\u4e8e\u200bQEMU","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux 5.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li> <p>Documentation\\input\\input-programming.rst</p> </li> <li> <p>Documentation\\input\\event-codes.rst</p> </li> <li>Linux 4.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Documentation\\input\\input-programming.txt</li> <li> <p>Documentation\\input\\event-codes.txt</p> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u4ee3\u7801\u200b\uff1aGIT\u200b\u4ed3\u5e93\u200b\u4e2d\u200b</p> </li> </ul> <p><code>shell   IMX6ULL\\source\\05_Input\\03_touchscreen_qemu\\     01_irq_ok     02_all_ok STM32MP157\\source\\A7\\05_Input\\03_touchscreen_qemu\\     01_irq_ok     02_all_ok</code></p>"},{"location":"05_Input/04_3/#1","title":"1. \u200b\u5199\u200b\u5728\u200b\u524d\u9762\u200b\u7684\u8bdd","text":"<p>\u200b\u76ee\u524d\u200b\u767e\u95ee\u200b\u7f51\u200b\u4e3b\u63a8\u200b\u7684\u200b\u5f00\u53d1\u677f\u200b\u662f\u200bIMX6ULL\u3001STM32MP157\u3002 \u200b\u4f46\u662f\u200b\u4e5f\u200b\u63a8\u51fa\u200b\u4e86\u200b\u4e00\u5757\u200b\u865a\u62df\u200b\u7684\u200b\u5f00\u53d1\u677f\u200b\uff1aIMX6ULL_QEMU\uff0c\u200b\u5bf9\u200bQEMU\u200b\u8fdb\u884c\u200b\u4e86\u200b\u5927\u91cf\u200b\u7684\u200b\u4fee\u6539\u200b\uff0c\u200b\u6bd4\u5982\u200b\u589e\u52a0\u200b\u4e86\u200b\u66f4\u200b\u591a\u200b\u5916\u8bbe\u200b\u7684\u200b\u6a21\u62df\u200b\u3002 \u200b\u4f7f\u7528\u200bQEMU\u200b\u7684\u200b\u539f\u56e0\u200b\u6709\u200b3\uff1a</p> <ul> <li>\u200b\u964d\u4f4e\u200b\u5b66\u4e60\u200b\u6210\u672c\u200b</li> <li>\u200b\u521d\u5b66\u200b\u9636\u6bb5\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u4e0d\u4e70\u200b\u5f00\u53d1\u677f\u200b\uff0c\u200b\u4f7f\u7528\u200bQEMU\u200b\u5373\u53ef\u200b\u5165\u95e8\u200b\u3002</li> <li>\u200b\u6df1\u5165\u200b\u5b66\u4e60\u200b\u5185\u6838\u200b\u53ca\u200b\u9a71\u52a8\u200b</li> <li>\u200b\u4f7f\u7528\u200bQEMU\u200b\u53ef\u4ee5\u200b\u975e\u5e38\u200b\u65b9\u4fbf\u200b\u5730\u200b\u8c03\u8bd5\u200b\u5185\u6838\u200b\u3001\u200b\u67e5\u770b\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6267\u884c\u200b\u8fc7\u7a0b\u200b</li> <li>\u200b\u6709\u52a9\u4e8e\u200b\u6df1\u5165\u7814\u7a76\u200b\u5185\u6838\u200b\u53ca\u200b\u9a71\u52a8\u200b</li> <li>\u200b\u5b66\u4e60\u200b\u67d0\u4e9b\u200b\u9a71\u52a8\u200b\u65f6\u200b\u53ef\u4ee5\u200b\u7528\u200bQEMU\u200b\u6a21\u62df\u200b\u786c\u4ef6\u200b\uff0c\u200b\u7b80\u5316\u200b\u786c\u4ef6\u200b\u7684\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u628a\u200b\u7cbe\u529b\u200b\u653e\u5728\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6\u200b\u672c\u8eab\u200b</li> </ul> <p>\u200b\u540e\u9762\u200b\u7684\u200b\u89c6\u9891\u200b\u91cc\u200b\uff0c\u200b\u4f1a\u200b\u4f7f\u7528\u200bQEMU\u200b\u6765\u200b\u8bb2\u89e3\u200b\u67d0\u4e9b\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u3002 \u200b\u6ce8\u610f\u200b\uff1a</p> <ul> <li>\u200b\u4f7f\u7528\u200bQEMU\u200b\u4e0d\u662f\u200b\u5fc5\u987b\u200b\u7684\u200b</li> <li>QEMU\u200b\u53ea\u662f\u200b\u63d0\u4f9b\u200b\u53e6\u200b\u4e00\u4e2a\u200b\u89d2\u5ea6\u200b\u7684\u200b\u5b66\u4e60\u200b\u65b9\u6cd5\u200b\uff0c\u200b\u6bd4\u5982\u200b\uff1a</li> <li>LCD\u200b\u9a71\u52a8\u200b\uff1a\u200b\u4f7f\u7528\u200bQEMU\u200b\u53ef\u4ee5\u200b\u65f6\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u7b80\u5316\u200b\u786c\u4ef6\u200b\u7684\u200b\u64cd\u4f5c\u200b</li> <li>\u200b\u4e2d\u65ad\u200b\u5b50\u7cfb\u7edf\u200b\uff1a\u200b\u53ef\u4ee5\u200b\u8ddf\u8e2a\u200b\u8c03\u7528\u200b\u8fc7\u7a0b\u200b</li> <li>\u200b\u4f60\u200b\u53ef\u4ee5\u200b\u53ea\u200b\u770b\u200bQEMU\u200b\u76f8\u5173\u200b\u7684\u200b\u89c6\u9891\u200b\uff0c\u200b\u4e0d\u200b\u4f7f\u7528\u200bQEMU\u200b\u6765\u200b\u64cd\u4f5c\u200b</li> <li>\u200b\u5728\u200b\u771f\u5b9e\u200b\u7684\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u8bb2\u89e3\u200b\u7684\u200b\u5185\u5bb9\u200b\uff0c\u200b\u4f1a\u200b\u8986\u76d6\u200bQEMU\u200b\u89c6\u9891\u200b\u7684\u200b\u77e5\u8bc6\u200b</li> </ul>"},{"location":"05_Input/04_3/#2","title":"2. \u200b\u51c6\u5907\u200b\u5de5\u4f5c","text":"<p>\u200b\u5728\u200b2021.03.27\uff0c\u200b\u6211\u4eec\u200b\u7ed9\u200bQEMU\u200b\u589e\u52a0\u200b\u4e86\u200b\u65b0\u200b\u7684\u200b\u529f\u80fd\u200b\uff1a\u200b\u6a21\u62df\u200b\u89e6\u6478\u5c4f\u200b\u3002 \u200b\u5982\u679c\u200b\u4f60\u200b\u662f\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u65f6\u95f4\u200b\u4e4b\u524d\u200b\u4e0b\u8f7d\u200b\u4e86\u200b\u767e\u95ee\u200b\u7f51\u200b\u7684\u200bQEMU\u200b\u6620\u50cf\u200b\uff0c\u200b\u90a3\u4e48\u200b\u9700\u8981\u200b\u91cd\u65b0\u200b\u4e0b\u8f7d\u200b\u3002 \u200b\u4e0b\u8f7d\u200b\u3001\u200b\u4f7f\u7528\u200b\u65b9\u6cd5\u200b\u8bf7\u200b\u53c2\u8003\u200b\uff1ahttp://wiki.100ask.org/Qemu</p> <p>\u200b\u4e0b\u9762\u200b\u4ee5\u200bUbuntu 18.04\u200b\u7b80\u5355\u200b\u4ecb\u7ecd\u200b\u4e00\u4e0b\u200b\u3002</p>"},{"location":"05_Input/04_3/#21","title":"2.1 \u200b\u4e0b\u8f7d","text":"<p>\u200b\u6267\u884c\u547d\u4ee4\u200b\uff1a</p> <pre><code>git  clone  https://e.coding.net/weidongshan/ubuntu-18.04_imx6ul_qemu_system.git\n</code></pre>"},{"location":"05_Input/04_3/#22","title":"2.2 \u200b\u5b89\u88c5\u200b\u8fd0\u884c\u200b\u73af\u5883","text":"<p>\u200b\u6267\u884c\u547d\u4ee4\u200b\uff1a</p> <pre><code>$ cd buntu-18.04_imx6ul_qemu_system\n$./install_sdl.sh // \u200b\u63d0\u793a\u200b\u8f93\u5165\u200b\u7528\u6237\u200b\u5bc6\u7801\u200b\uff0c\u200b\u7b49\u5f85\u200b\u5b89\u88c5\u200b\u5b8c\u6210\u200b\n</code></pre>"},{"location":"05_Input/04_3/#23-qemu","title":"2.3 \u200b\u8fd0\u884c\u200bQEMU","text":"<p>\u200b\u6267\u884c\u547d\u4ee4\u200b\uff1a</p> <pre><code>$./qemu-imx6ull-gui.sh // \u200b\u542f\u52a8\u200b\u540e\u200b\uff0c\u200b\u767b\u5f55\u540d\u200b\u662f\u200broot\uff0c\u200b\u65e0\u9700\u200b\u5bc6\u7801\u200b\n</code></pre>"},{"location":"05_Input/04_3/#3-qemu","title":"3. QEMU\u200b\u89e6\u6478\u5c4f\u200b\u64cd\u4f5c\u65b9\u6cd5","text":"<p>\u200b\u5bc4\u5b58\u5668\u200b\u8bf4\u660e\u200b\u5982\u4e0b\u200b\uff1a</p> \u200b\u5730\u5740\u200b \u200b\u5bc4\u5b58\u5668\u200b \u200b\u8bf4\u660e\u200b 0x021B4000 touch_pressure_register \u200b\u8bb0\u5f55\u200b\u89e6\u6478\u5c4f\u200b\u538b\u529b\u200b\u503c\u200b\uff0c\u200b\u53ea\u6709\u200b0\u30011\u200b\u4e24\u4e2a\u200b\u53d6\u503c\u200b\uff0c1\u200b\u8868\u793a\u200b\u88ab\u200b\u6309\u200b\u4e0b\u200b\uff0c0\u200b\u8868\u793a\u200b\u677e\u5f00\u200b 0x021B4004 touch_x_register \u200b\u8bb0\u5f55\u200b\u89e6\u6478\u5c4f\u200bX\u200b\u5750\u6807\u200b 0x021B4008 touch_y_register \u200b\u8bb0\u5f55\u200b\u89e6\u6478\u5c4f\u200bY\u200b\u5750\u6807\u200b 0x021B400C touch_clean_register \u200b\u5199\u5165\u200b\u4efb\u610f\u200b\u503c\u200b\uff0c\u200b\u5c31\u200b\u4f1a\u200b\u6e05\u96f6\u200b\u4e0a\u8ff0\u200b3\u200b\u4e2a\u200b\u5bc4\u5b58\u5668\u200b(\u200b\u4ec5\u200b\u7528\u4e8e\u200b\u6d4b\u8bd5\u200b\uff0c\u200b\u4e0d\u7528\u200b\u4e5f\u200b\u53ef\u200b) <p>\u200b\u64cd\u4f5c\u200b\u539f\u7406\u200b\uff1a</p> <ul> <li>\u200b\u9f20\u6807\u200b\u5728\u200b\u5c4f\u5e55\u200b\u4e0a\u200b\u6309\u200b\u4e0b\u200b\u3001\u200b\u677e\u5f00\u200b</li> <li>QEMU\u200b\u6539\u53d8\u200bGPIO\u200b\u7535\u5e73\u200b\u3001\u200b\u4ea7\u751f\u200b\u4e2d\u65ad\u200b</li> <li> <p>\u200b\u5728\u200btouch_pressure_register\u200b\u4e2d\u200b\u8bb0\u5f55\u200b\u538b\u529b\u200b\u503c\u200b</p> </li> <li> <p>\u200b\u9f20\u6807\u200b\u5728\u200b\u5c4f\u5e55\u200b\u4e0a\u200b\u6ed1\u52a8\u200b</p> </li> <li>\u200b\u5728\u200btouch_x_register\u3001touch_y_register\u200b\u4e2d\u200b\u8bb0\u5f55\u200b\u5750\u6807\u200b</li> <li>\u200b\u4ec5\u80fd\u200b\u6a21\u62df\u200b\u5355\u70b9\u200b\u89e6\u6478\u200b\uff0c\u200b\u4e0d\u80fd\u200b\u6a21\u62df\u200b\u591a\u70b9\u200b\u89e6\u6478\u200b</li> </ul>"},{"location":"05_Input/04_3/#4","title":"4. \u200b\u7f16\u5199\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<ul> <li> <p>request_irq</p> </li> <li> <p>\u200b\u5728\u200b\u4e2d\u65ad\u200b\u5904\u7406\u51fd\u6570\u200b\u91cc\u200b</p> </li> <li> <p>\u200b\u4e0a\u62a5\u200b\u6309\u4e0b\u200b\u3001\u200b\u677e\u5f00\u200b\u7684\u200b\u4e8b\u4ef6\u200b</p> </li> <li> <p>\u200b\u5982\u679c\u200b\u89e6\u6478\u5c4f\u200b\u88ab\u200b\u6309\u200b\u4e0b\u200b\uff0c\u200b\u542f\u52a8\u200b\u5b9a\u65f6\u5668\u200b</p> </li> <li> <p>\u200b\u5982\u679c\u200b\u89e6\u6478\u5c4f\u200b\u88ab\u200b\u677e\u5f00\u200b\uff0c\u200b\u53d6\u6d88\u200b\u5b9a\u65f6\u5668\u200b</p> </li> <li> <p>\u200b\u5728\u200b\u5b9a\u65f6\u5668\u200b\u51fd\u6570\u200b\u91cc\u200b</p> </li> <li> <p>\u200b\u5982\u679c\u200b\u89e6\u6478\u5c4f\u200b\u8fd8\u662f\u200b\u88ab\u200b\u6309\u200b\u4e0b\u200b\u7684\u200b\u72b6\u6001\u200b\uff0c\u200b\u4e0a\u62a5\u200b\u5750\u6807\u503c\u200b\uff0c\u200b\u5e76\u200b\u8bbe\u7f6e\u200b\u4e0b\u200b\u4e00\u4e2a\u200b\u8d85\u65f6\u200b\u65f6\u95f4\u200b</p> </li> </ul>"},{"location":"05_Input/04_3/#5","title":"5. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":""},{"location":"05_Input/04_3/#51","title":"5.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<p>\u200b\u5728\u200bUbuntu\u200b\u4e2d\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-qemu/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre>"},{"location":"05_Input/04_3/#52","title":"5.2 \u200b\u7f16\u8bd1\u200b\u5185\u6838\u200b/\u200b\u8bbe\u5907\u200b\u6811","text":"<p>\u200b\u5728\u200bUbuntu\u200b\u4e2d\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>book@100ask:~/100ask_imx6ull-qemu$ cd linux-4.9.88\nbook@100ask:~/100ask_imx6ull-qemu/linux-4.9.88$ make mrproper\nbook@100ask:~/100ask_imx6ull-qemu/linux-4.9.88$ make 100ask_imx6ull_qemu_defconfig\nbook@100ask:~/100ask_imx6ull-qemu/linux-4.9.88$ make zImage -jN //\u200b\u7f16\u8bd1\u200bzImage\u200b\u5185\u6838\u200b\u955c\u50cf\u200b\uff0c\u200b\u5176\u4e2d\u200bN\u200b\u53c2\u6570\u200b\u53ef\u4ee5\u200b\u6839\u636e\u200bCPU\u200b\u4e2a\u6570\u200b\uff0c\u200b\u6765\u200b\u52a0\u901f\u200b\u7f16\u8bd1\u7cfb\u7edf\u200b\u3002\nbook@100ask:~/100ask_imx6ull-qemu/linux-4.9.88$ make dtbs //\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\n</code></pre> <p>\u200b\u6210\u529f\u200b\u7684\u8bdd\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\uff1a</p> <pre><code>arch/arm/boot/zImage // \u200b\u5185\u6838\u200b\narch/arm/boot/dts/100ask_imx6ull_qemu.dtb // \u200b\u8bbe\u5907\u200b\u6811\u200b\n</code></pre> <p>\u200b\u590d\u5236\u5230\u200b\u5982\u4e0b\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cd ubuntu-18.04_imx6ul_qemu_system/imx6ull-system-image\n$ ls\n100ask_imx6ull_qemu.dtb  rootfs.img  rootfs.tar.gz  zImage\n</code></pre>"},{"location":"05_Input/04_3/#53-qemu","title":"5.3 \u200b\u542f\u52a8\u200bQEMU","text":"<p>\u200b\u5728\u200bUbuntu\u200b\u4e2d\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>$ cd ubuntu-18.04_imx6ul_qemu_system\n$ ./qemu-imx6ull-gui.sh\n</code></pre>"},{"location":"05_Input/04_3/#54-nfs","title":"5.4 \u200b\u6302\u8f7d\u200bNFS","text":"<p>\u200b\u5728\u200bQEMU\u200b\u4e2d\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>$ mount -t nfs -o nolock,vers=3 10.0.2.2:/home/book/nfs_rootfs /mnt\n</code></pre> <p>\u200b\u5f00\u542f\u200bprintk\uff1a</p> <pre><code>echo \"7 4 1 7\" &gt; /proc/sys/kernel/printk\n</code></pre>"},{"location":"05_Input/04_3/#55-tslib","title":"5.5 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u4f7f\u7528\u200btslib","text":"<p>\u200b\u5728\u200bUbuntu\u200b\u4e0a\u200b\u6267\u884c\u200b\u4e0b\u5217\u200b\u547d\u4ee4\u200b\u3002</p> <ul> <li>\u200b\u7f16\u8bd1\u200b</li> </ul> <pre><code>tar xJf tslib-1.21.tar.xz\ncd tslib-1.21\n./configure --host=arm-linux-gnueabihf  --prefix=/\nmake\nmake install DESTDIR=$PWD/tmp\n</code></pre> <ul> <li>\u200b\u590d\u5236\u200b\u5934\u6587\u4ef6\u200b/\u200b\u5e93\u5230\u200b\u5de5\u5177\u200b\u94fe\u200b(\u200b\u975e\u200b\u5fc5\u987b\u200b, \u200b\u7f16\u8bd1\u200b\u5176\u4ed6\u200bAPP\u200b\u65f6\u200b\u9700\u8981\u200b)</li> </ul> <pre><code>cd tslib-1.21/tmp/\n\ncp include/* /home/book/100ask_imx6ull-qemu/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin/../lib/gcc/arm-linux-gnueabihf/6.2.1/../../../../arm-linux-gnueabihf/include\n\ncp -d lib/*so*  /home/book/100ask_imx6ull-qemu/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin/../arm-linux-gnueabihf/libc/usr/lib/\n</code></pre> <ul> <li>\u200b\u590d\u5236\u200b\u5e93\u200b\u3001APP\u200b\u5230\u200b\u5f00\u53d1\u677f\u200b</li> </ul> <p>\u200b\u5047\u8bbe\u200b\u5728\u200bUbuntu\u200b\u7684\u200b/home/book/nfs_rootfs\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6709\u200btslib-1.21\u3002   \u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>mount -t nfs -o nolock,vers=3 10.0.2.2:/home/book/nfs_rootfs /mnt\ncp  /mnt/tslib-1.21/tmp/lib/*  -drf     /lib\ncp  /mnt/tslib-1.21/tmp/bin/*            /bin\ncp  /mnt/tslib-1.21/tmp/etc/ts.conf  -d  /etc\n</code></pre> <ul> <li>\u200b\u4f7f\u7528\u200btslib <pre><code>export TSLIB_TSDEVICE=/dev/input/event3\nexport TSLIB_CALIBFILE=/etc/pointercal\nexport TSLIB_CONFFILE=/etc/ts.conf\nexport TSLIB_PLUGINDIR=/lib/ts\nexport TSLIB_CONSOLEDEVICE=none\nexport TSLIB_FBDEVICE=/dev/fb0\n\nts_calibrate\n\nts_test\n</code></pre></li> </ul>"},{"location":"05_Input/04_3/#55-qemu","title":"5.5 \u200b\u9000\u51fa\u200bQEMU","text":"<pre><code>\u200b\u8981\u200b\u9000\u51fa\u200bQEMU\uff0c\u200b\u53ef\u4ee5\u200b\u540c\u65f6\u200b\u6309\u4f4f\u200bctrl+a\uff0c\u200b\u677e\u5f00\u200b\u540e\u200b\u518d\u200b\u8f93\u5165\u200b'x'\n</code></pre>"},{"location":"05_Input/04_3/#56","title":"5.6 \u200b\u6539\u8fdb\u200b\u9a71\u52a8","text":"<p>\u200b\u5982\u679c\u200b\u5728\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u91cc\u200b\u8bbe\u7f6e\u200b\u5c5e\u6027\u200b\u4f4d\u200b\uff1a</p> <pre><code>    __set_bit(INPUT_PROP_DIRECT, g_input_dev-&gt;propbit);\n</code></pre> <p>\u200b\u90a3\u4e48\u200btslib\u200b\u53ef\u4ee5\u200b\u81ea\u52a8\u200b\u626b\u63cf\u200b\u5230\u200b\u89e6\u6478\u5c4f\u200b\u8bbe\u5907\u200b\uff0c \u200b\u4f7f\u7528\u200btslib\u200b\u65f6\u200b\u5c31\u200b\u4e0d\u200b\u9700\u8981\u200b\u8bbe\u7f6e\u200b\u8fd9\u4e9b\u200b\u73af\u5883\u53d8\u91cf\u200b\uff1a</p> <pre><code>export TSLIB_TSDEVICE=/dev/input/event3\nexport TSLIB_CALIBFILE=/etc/pointercal\nexport TSLIB_CONFFILE=/etc/ts.conf\nexport TSLIB_PLUGINDIR=/lib/ts\nexport TSLIB_CONSOLEDEVICE=none\nexport TSLIB_FBDEVICE=/dev/fb0\n</code></pre>"},{"location":"05_Input/04_4/","title":"DRV_04_GPIO\u200b\u6309\u952e\u200b\u9a71\u52a8\u200b\u5206\u6790\u200b\u4e0e\u200b\u4f7f\u7528","text":""},{"location":"05_Input/04_4/#gpio","title":"GPIO\u200b\u6309\u952e\u200b\u9a71\u52a8\u200b\u5206\u6790\u200b\u4e0e\u200b\u4f7f\u7528","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>Linux 5.x\u200b\u5185\u6838\u200b</p> </li> <li> <p>Documentation\\devicetree\\bindings\\input\\gpio-keys.txt</p> </li> <li>drivers\\input\\keyboard\\gpio_keys.c</li> <li>Linux 4.x\u200b\u5185\u6838\u200b</li> <li>Documentation\\devicetree\\bindings\\input\\gpio-keys.txt</li> <li> <p>drivers\\input\\keyboard\\gpio_keys.c</p> </li> <li> <p>\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> <li> <p>IMX6ULL\uff1a<code>Linux-4.9.88/arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code></p> </li> <li>STM32MP157\uff1a<code>Linux-5.4/arch/arm/boot/dts/stm32mp15xx-100ask.dtsi</code></li> <li>QEMU\uff1a<code>linux-4.9.88/arch/arm/boot/dts/100ask_imx6ull_qemu.dts</code></li> </ul>"},{"location":"05_Input/04_4/#1","title":"1. \u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":""},{"location":"05_Input/04_4/#2","title":"2. \u200b\u8bbe\u5907\u200b\u6811\u200b\u793a\u4f8b","text":""},{"location":"05_Input/04_4/#21","title":"2.1 \u200b\u8bbe\u5907\u200b\u6811\u200b\u8bb2\u89e3","text":"<p>\u200b\u5c5e\u6027\u200b\uff1a</p> <ul> <li> <p>\u200b\u5fc5\u5907\u200b\uff1a<code>compatible = \"gpio-keys\";</code></p> </li> <li> <p>\u200b\u53ef\u200b\u9009\u200b\uff1a</p> </li> <li> <p><code>autorepeat</code>: \u200b\u8868\u793a\u200b\u81ea\u52a8\u200b\u91cd\u590d\u200b\uff0c\u200b\u6309\u4e0b\u200b\u6309\u952e\u200b\u4e0d\u200b\u677e\u5f00\u200b\uff0c\u200b\u9a71\u52a8\u200b\u4f1a\u200b\u81ea\u52a8\u200b\u91cd\u590d\u200b\u4e0a\u62a5\u200b\u6309\u952e\u200b\u503c\u200b</p> </li> <li> <p>\u200b\u5bf9\u4e8e\u200b\u6bcf\u200b\u4e00\u4e2a\u200bGPIO\u200b\u6309\u952e\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u4e00\u4e2a\u200b\u5b50\u200b\u8282\u70b9\u200b\uff0c\u200b\u6709\u200b\u8fd9\u4e9b\u200b\u5c5e\u6027\u200b\uff1a</p> </li> <li><code>gpios</code>\uff1a\u200b\u4f7f\u7528\u200b\u54ea\u4e2a\u200bGPIO</li> <li><code>interrupts</code>\uff1a\u200b\u5bf9\u5e94\u200b\u7684\u200b\u4e2d\u65ad\u200b</li> <li><code>linux,code</code>\uff1a\u200b\u5bf9\u5e94\u200b\u7684\u200b\u6309\u952e\u200b\u503c\u200b</li> <li>\u200b\u6ce8\u610f\u200b\uff1a<code>gpios</code>\u200b\u548c\u200b<code>interrupts</code>\u200b\u81f3\u5c11\u200b\u8981\u200b\u4fdd\u7559\u200b\u4e00\u4e2a\u200b\uff0c\u200b\u4e0d\u80fd\u200b\u90fd\u200b\u7701\u7565\u200b</li> <li><code>debounce-interval</code>:  \u200b\u6d88\u9664\u200b\u6296\u52a8\u200b\u7684\u200b\u95f4\u9694\u200b\uff0c\u200b\u5355\u4f4d\u200b\uff1ams\uff0c\u200b\u9ed8\u8ba4\u200b\u662f\u200b5ms</li> </ul>"},{"location":"05_Input/04_4/#22-100ask_imx6ull","title":"2.2 100ASK_IMX6ULL","text":"<pre><code>gpio-keys {\n    compatible = \"gpio-keys\";\n    pinctrl-names = \"default\";\n\n    user1 {\n        label = \"User1 Button\";\n        gpios = &lt;&amp;gpio5 1 GPIO_ACTIVE_LOW&gt;;\n        gpio-key,wakeup;\n        linux,code = &lt;KEY_1&gt;;\n    };\n\n    user2 {\n        label = \"User2 Button\";\n        gpios = &lt;&amp;gpio4 14 GPIO_ACTIVE_LOW&gt;;\n        gpio-key,wakeup;\n        linux,code = &lt;KEY_2&gt;;\n    };\n};\n</code></pre>"},{"location":"05_Input/04_4/#23-100ask_stm32mp157","title":"2.3 100ASK_STM32MP157","text":"<pre><code>joystick {\n        compatible = \"gpio-keys\";\n        #size-cells = &lt;0&gt;;\n        button-0 {\n                 label = \"usr_button0\";\n                 linux,code = &lt;KEY_A&gt;;\n                interrupt-parent = &lt;&amp;gpiog&gt;;\n                interrupts = &lt;3 IRQ_TYPE_EDGE_RISING&gt;;\n        };\n       button-1 {\n                 label = \"usr_button1\";\n                 linux,code = &lt;KEY_ENTER&gt;;\n                interrupt-parent = &lt;&amp;gpiog&gt;;\n                interrupts = &lt;2 IRQ_TYPE_EDGE_RISING&gt;;\n        };\n\n};\n</code></pre>"},{"location":"05_Input/04_4/#24-qemu","title":"2.4 QEMU","text":"<pre><code>gpio-keys@0 {\n                compatible = \"gpio-keys\";\n                pinctrl-names = \"default\";\n                pinctrl-0 = &lt;&amp;pinctrl_gpio_keys&gt;;\n                status = \"okay\";\n\n                Key0{\n                        label = \"Key 0\";\n                        gpios = &lt;&amp;gpio5 1 GPIO_ACTIVE_HIGH&gt;;\n                        linux,code = &lt;KEY_1&gt;;\n                };\n};\n\ngpio-keys@1 {\n                compatible = \"gpio-keys\";\n                pinctrl-names = \"default\";\n                pinctrl-0 = &lt;&amp;pinctrl_gpio_key1&gt;;\n                status = \"okay\";\n\n                Key0{\n                        label = \"Key 1\";\n                        gpios = &lt;&amp;gpio1 18 GPIO_ACTIVE_HIGH&gt;;\n                        linux,code = &lt;KEY_2&gt;;\n                };\n};\n</code></pre>"},{"location":"05_Input/04_4/#3-gpio_keysc","title":"3. gpio_keys.c\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5206\u6790","text":""},{"location":"05_Input/04_4/#31","title":"3.1 \u200b\u5957\u8def","text":"<ul> <li>\u200b\u6839\u636e\u200b\u8bbe\u5907\u200b\u6811\u200b\u83b7\u5f97\u200b\u786c\u4ef6\u200b\u4fe1\u606f\u200b\uff1a\u200b\u54ea\u4e2a\u200bGPIO\u3001\u200b\u5bf9\u4e8e\u200b\u4ec0\u4e48\u200b\u6309\u952e\u200b</li> <li>\u200b\u5206\u914d\u200b/\u200b\u8bbe\u7f6e\u200b/\u200b\u6ce8\u518c\u200binput_dev\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> <li>request_irq: \u200b\u5728\u200b\u4e2d\u65ad\u200b\u5904\u7406\u51fd\u6570\u200b\u4e2d\u200b\u786e\u5b9a\u200b\u6309\u952e\u200b\u503c\u200b\u3001\u200b\u4e0a\u62a5\u200b\u6309\u952e\u200b\u503c\u200b</li> <li>\u200b\u6709\u200b\u4e24\u79cd\u200bIRQ\u200b\u51fd\u6570\u200b</li> <li><code>gpio_keys_gpio_isr</code>\uff1a\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\u7684\u200b\u7528\u200b<code>gpios</code>\u200b\u6765\u200b\u63cf\u8ff0\u200b\u7528\u5230\u200b\u7684\u200b\u5f15\u811a\u200b</li> <li><code>gpio_keys_irq_isr</code>\uff1a\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\u7684\u200b\u7528\u200b<code>interrupts</code>\u200b\u6765\u200b\u63cf\u8ff0\u200b\u7528\u5230\u200b\u7684\u200b\u5f15\u811a\u200b</li> </ul>"},{"location":"05_Input/04_4/#32-gpio_keys_gpio_isr","title":"3.2  gpio_keys_gpio_isr\u200b\u5206\u6790","text":"<p>\u200b\u7406\u60f3\u200b\u72b6\u51b5\u200b\u662f\u200b\uff1a\u200b\u6309\u4e0b\u200b\u3001\u200b\u677e\u5f00\u200b\u6309\u952e\u200b\uff0c\u200b\u5404\u200b\u4ea7\u751f\u200b\u4e00\u6b21\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u4e5f\u200b\u53ea\u200b\u4ea7\u751f\u200b\u4e00\u6b21\u200b\u4e2d\u65ad\u200b\u3002 \u200b\u4f46\u662f\u200b\u5bf9\u4e8e\u200b\u673a\u68b0\u200b\u5f00\u5173\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u91d1\u5c5e\u200b\u5f39\u7247\u200b\u4f1a\u200b\u53cd\u590d\u200b\u9707\u52a8\u200b\u3002GPIO\u200b\u7535\u5e73\u200b\u4f1a\u200b\u53cd\u590d\u200b\u53d8\u5316\u200b\uff0c\u200b\u6700\u540e\u200b\u624d\u200b\u7a33\u5b9a\u200b\u3002\u200b\u4e00\u822c\u200b\u662f\u200b\u51e0\u5341\u200b\u6beb\u79d2\u200b\u624d\u200b\u4f1a\u200b\u7a33\u5b9a\u200b\u3002 \u200b\u5982\u679c\u200b\u4e0d\u200b\u5904\u7406\u200b\u6296\u52a8\u200b\u7684\u8bdd\u200b\uff0c\u200b\u7528\u6237\u200b\u53ea\u200b\u64cd\u4f5c\u200b\u4e00\u6b21\u200b\u6309\u952e\u200b\uff0c\u200b\u4f1a\u200b\u53d1\u751f\u200b\u591a\u6b21\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u53ef\u80fd\u200b\u4f1a\u200b\u4e0a\u62a5\u200b\u591a\u4e2a\u200b\u6570\u636e\u200b\u3002</p> <p></p> <p>\u200b\u600e\u4e48\u200b\u5904\u7406\u200b\u6309\u952e\u200b\u6296\u52a8\u200b\uff1f</p> <ul> <li>\u200b\u5728\u200b\u6309\u952e\u200b\u4e2d\u65ad\u200b\u7a0b\u5e8f\u200b\u4e2d\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5faa\u73af\u200b\u5224\u65ad\u200b\u51e0\u5341\u200b\u4eb3\u200b\u79d2\u200b\uff0c\u200b\u53d1\u73b0\u200b\u7535\u5e73\u200b\u7a33\u5b9a\u200b\u4e4b\u540e\u200b\u518d\u200b\u4e0a\u62a5\u200b</li> <li>\u200b\u4f7f\u7528\u200b\u5b9a\u65f6\u5668\u200b</li> </ul> <p>\u200b\u663e\u7136\u200b\u7b2c\u200b1\u200b\u79cd\u200b\u65b9\u6cd5\u200b\u592a\u200b\u8017\u65f6\u200b\uff0c\u200b\u8fdd\u80cc\u200b\u201c\u200b\u4e2d\u65ad\u200b\u8981\u200b\u5c3d\u5feb\u200b\u5904\u7406\u200b\u201d\u200b\u7684\u200b\u539f\u5219\u200b\uff0c\u200b\u4f60\u200b\u7684\u200b\u7cfb\u7edf\u200b\u4f1a\u200b\u5f88\u200b\u5361\u200b\u3002</p> <p>\u200b\u600e\u4e48\u200b\u4f7f\u7528\u200b\u5b9a\u65f6\u5668\u200b\uff1f\u200b\u770b\u200b\u4e0b\u56fe\u200b\uff1a</p> <p></p> <p>\u200b\u6838\u5fc3\u200b\u5728\u4e8e\u200b\uff1a\u200b\u5728\u200bGPIO\u200b\u4e2d\u65ad\u200b\u4e2d\u200b\u5e76\u200b\u4e0d\u200b\u7acb\u523b\u200b\u8bb0\u5f55\u200b\u6309\u952e\u200b\u503c\u200b\uff0c\u200b\u800c\u662f\u200b\u4fee\u6539\u200b\u5b9a\u65f6\u5668\u200b\u8d85\u65f6\u200b\u65f6\u95f4\u200b\uff0c10ms\u200b\u540e\u200b\u518d\u200b\u5904\u7406\u200b\u3002 \u200b\u5982\u679c\u200b10ms\u200b\u5185\u200b\u53c8\u200b\u53d1\u751f\u200b\u4e86\u200bGPIO\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u90a3\u200b\u5c31\u200b\u8ba4\u4e3a\u200b\u662f\u200b\u6296\u52a8\u200b\uff0c\u200b\u8fd9\u65f6\u200b\u518d\u6b21\u200b\u4fee\u6539\u200b\u8d85\u65f6\u200b\u65f6\u95f4\u200b\u4e3a\u200b10ms\u3002 \u200b\u53ea\u6709\u200b10ms\u200b\u4e4b\u5185\u200b\u518d\u200b\u65e0\u200bGPIO\u200b\u4e2d\u65ad\u200b\u53d1\u751f\u200b\uff0c\u200b\u90a3\u4e48\u200b\u5b9a\u65f6\u5668\u200b\u7684\u200b\u51fd\u6570\u200b\u624d\u200b\u4f1a\u200b\u88ab\u200b\u8c03\u7528\u200b\u3002 \u200b\u5728\u200b\u5b9a\u65f6\u5668\u200b\u51fd\u6570\u200b\u4e2d\u200b\u4e0a\u62a5\u200b\u6309\u952e\u200b\u503c\u200b\u3002</p>"},{"location":"05_Input/04_4/#33-gpio_keys_irq_isr","title":"3.3 gpio_keys_irq_isr\u200b\u5206\u6790","text":"<p>\u200b\u6709\u4e2a\u200b\u53d8\u91cf\u200bkey_pressed\uff0c\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u5f53\u524d\u200b\u6309\u952e\u200b\u72b6\u6001\u200b\uff1a\u200b\u521d\u59cb\u503c\u200b\u662f\u200bfalse\uff0c\u200b\u8868\u793a\u200b\u6309\u952e\u200b\u6ca1\u6709\u200b\u88ab\u200b\u6309\u200b\u4e0b\u200b\u3002</p> <ul> <li> <p>\u200b\u53d1\u751f\u200b\u4e2d\u65ad\u200b</p> </li> <li> <p>\u200b\u4e0a\u62a5\u200b\"\u200b\u6309\u4e0b\u200b\u7684\u200b\u503c\u200b\"\uff1a<code>input_event(input, EV_KEY, button-&gt;code, 1); input_sync(input);</code></p> </li> <li> <p>\u200b\u5982\u679c\u200b\u4e0d\u200b\u5ef6\u8fdf\u200b(!bdata-&gt;release_delay)</p> </li> <li>\u200b\u9a6c\u4e0a\u200b\u4e0a\u62a5\u200b\"\u200b\u677e\u5f00\u200b\u7684\u200b\u503c\u200b\"\uff1a<code>input_event(input, EV_KEY, button-&gt;code, 0); input_sync(input);</code></li> <li>\u200b\u5982\u679c\u200b\u5ef6\u8fdf\u200b(bdata-&gt;release_delay)</li> <li> <p>\u200b\u542f\u52a8\u200b\u5b9a\u65f6\u5668\u200b\uff0c\u200b\u8fc7\u200b\u82e5\u5e72\u200b\u6beb\u79d2\u200b\u518d\u200b\u4e0a\u62a5\u200b\"\u200b\u677e\u5f00\u200b\u7684\u200b\u503c\u200b\"</p> </li> <li> <p>\u200b\u6240\u4ee5\u200b\uff0c\u200b\u4f7f\u7528\u200bgpio_keys_irq_isr\u200b\u65f6\u200b\uff0c\u200b\u4e00\u6b21\u200b\u4e2d\u65ad\u200b\u5c31\u200b\u4f1a\u200b\u5bfc\u81f4\u200b\u4e0a\u62a5\u200b2\u200b\u4e2a\u200b\u4e8b\u4ef6\u200b\uff1a\u200b\u6309\u4e0b\u200b\u3001\u200b\u677e\u5f00\u200b</p> </li> <li> <p>\u200b\u7f3a\u70b9\u200b\uff1a\u200b\u65e0\u6cd5\u200b\u51c6\u786e\u200b\u5224\u65ad\u200b\u4e00\u4e2a\u200b\u6309\u952e\u200b\u786e\u5b9e\u200b\u5df2\u7ecf\u200b\u88ab\u200b\u677e\u5f00\u200b\u4e86\u200b</p> </li> </ul>"},{"location":"05_Input/04_4/#4-qemu","title":"4. QEMU\u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<p>IMX6ULL\u3001STM32MP157\u200b\u7684\u200b\u51fa\u5382\u200b\u7cfb\u7edf\u200b\u90fd\u200b\u5df2\u7ecf\u200b\u914d\u7f6e\u200b\u7684\u200bGPIO\u200b\u6309\u952e\u200b\u3002 \u200b\u53ef\u4ee5\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u786e\u8ba4\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\uff1a</p> <pre><code>cat /proc/bus/input/devices\n</code></pre> <p>\u200b\u7136\u540e\u200b\u6267\u884c\u200b<code>hexdump  /dev/input/event?</code>(?\u200b\u8868\u793a\u200b\u67d0\u4e2a\u200b\u6570\u503c\u200b)\uff0c\u200b\u5e76\u4e14\u200b\u64cd\u4f5c\u200b\u6309\u952e\u200b\u6765\u200b\u89c2\u5bdf\u200b\u8f93\u51fa\u200b\u4fe1\u606f\u200b\u3002</p>"},{"location":"05_Input/04_4/#_1","title":"DRV_04_GPIO\u200b\u6309\u952e\u200b\u9a71\u52a8\u200b\u5206\u6790\u200b\u4e0e\u200b\u4f7f\u7528","text":"<p>\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u5728\u200bQEMU\u200b\u4e0a\u200b\u505a\u200b\u5b9e\u9a8c\u200b\uff1a\u200b\u539f\u7406\u56fe\u200b\u5982\u4e0b\u200b\uff1a </p>"},{"location":"05_Input/04_4/#41","title":"4.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<p>\u200b\u5728\u200bUbuntu\u200b\u4e2d\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-qemu/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre>"},{"location":"05_Input/04_4/#42","title":"4.2 \u200b\u914d\u7f6e\u200b\u5185\u6838","text":"<p>QEMU\u200b\u7684\u200b\u5185\u6838\u200b\u91cc\u200b\u5df2\u7ecf\u200b\u914d\u7f6e\u200b\u4e86\u200bGPIO\u200b\u6309\u952e\u200b\u7684\u200b\u8bbe\u5907\u200b\u6811\u200b\uff0c\u200b\u53ea\u200b\u9700\u8981\u200b\u7f16\u8bd1\u200b\u51fa\u200bgpio_keys\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5373\u53ef\u200b\u3002 \u200b\u914d\u7f6e\u200b\u5185\u6838\u200b\uff1a\u200b\u6267\u884c\u200b<code>make menuconfig</code></p> <pre><code>-&gt; Device Drivers\n  -&gt; Input device support\n    -&gt; Generic input layer   \n      -&gt; Keyboards\n         &lt;M&gt;   GPIO Buttons      \n</code></pre>"},{"location":"05_Input/04_4/#43","title":"4.3 \u200b\u7f16\u8bd1\u200b\u9a71\u52a8","text":"<pre><code>book@100ask:~/100ask_imx6ull-qemu$ cd linux-4.9.88\nbook@100ask:~/100ask_imx6ull-qemu/linux-4.9.88$ make modules\n</code></pre> <p>\u200b\u6210\u529f\u200b\u7684\u8bdd\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\uff1a</p> <pre><code>drivers/input/keyboard/gpio_keys.ko\n</code></pre> <p>\u200b\u590d\u5236\u5230\u200b\u5982\u4e0b\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp drivers/input/keyboard/gpio_keys.ko ~/nfs_rootfs/\n</code></pre>"},{"location":"05_Input/04_4/#44-qemu","title":"4.4 \u200b\u542f\u52a8\u200bQEMU","text":"<p>\u200b\u5728\u200bUbuntu\u200b\u4e2d\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>$ cd ubuntu-18.04_imx6ul_qemu_system\n$ ./qemu-imx6ull-gui.sh\n</code></pre>"},{"location":"05_Input/04_4/#45-nfs","title":"4.5 \u200b\u6302\u8f7d\u200bNFS\u3001\u200b\u5b9e\u9a8c","text":"<p>\u200b\u5728\u200bQEMU\u200b\u4e2d\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>$ mount -t nfs -o nolock,vers=3 10.0.2.2:/home/book/nfs_rootfs /mnt\n$ insmod /mnt/gpio_keys.ko\n$ cat /proc/bus/input/devices   // \u200b\u786e\u8ba4\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\n$ hexdump /dev/input/event3\n</code></pre> <p>\u200b\u5728\u200bQEMU\u200b\u7684\u200bGUI\u200b\u754c\u9762\u200b\u64cd\u4f5c\u200b\uff1a</p> <p></p>"},{"location":"05_Input/04_5/","title":"DRV_05_I2C\u200b\u63a5\u53e3\u200b\u89e6\u6478\u5c4f\u200b\u9a71\u52a8\u200b\u5206\u6790","text":""},{"location":"05_Input/04_5/#i2c","title":"I2C\u200b\u63a5\u53e3\u200b\u89e6\u6478\u5c4f\u200b\u9a71\u52a8\u200b\u5206\u6790","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>Linux 5.x\u200b\u5185\u6838\u200b</p> </li> <li> <p>Documentation\\devicetree\\bindings\\input\\touchscreen\\goodix.txt</p> </li> <li>drivers/input/touchscreen/goodix.c</li> <li>Linux 4.x\u200b\u5185\u6838\u200b</li> <li>Documentation\\devicetree\\bindings\\input\\touchscreen\\goodix.txt</li> <li> <p>drivers/input/touchscreen/gt9xx/gt9xx.c</p> </li> <li> <p>\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> <li> <p>IMX6ULL\uff1a<code>Linux-4.9.88/arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code></p> </li> <li>STM32MP157\uff1a<code>Linux-5.4/arch/arm/boot/dts/stm32mp15xx-100ask.dtsi</code></li> </ul>"},{"location":"05_Input/04_5/#1","title":"1. \u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":""},{"location":"05_Input/04_5/#2","title":"2. \u200b\u8bbe\u5907\u200b\u6811\u200b\u793a\u4f8b","text":""},{"location":"05_Input/04_5/#21","title":"2.1 \u200b\u8bbe\u5907\u200b\u6811\u200b\u8bb2\u89e3","text":"<p>\u200b\u793a\u4f8b\u200b\uff1a</p> <pre><code>i2c@00000000 {\n    /* ... */\n\n    gt928@5d {\n        compatible = \"goodix,gt928\";\n        reg = &lt;0x5d&gt;;\n        interrupt-parent = &lt;&amp;gpio&gt;;\n        interrupts = &lt;0 0&gt;;\n\n        irq-gpios = &lt;&amp;gpio1 0 0&gt;;\n        reset-gpios = &lt;&amp;gpio1 1 0&gt;;\n    };\n\n    /* ... */\n};\n</code></pre> <p>\u200b\u4f5c\u4e3a\u200b\u4e00\u4e2a\u200bI2C\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5728\u200b\u67d0\u4e2a\u200bI2C\u200b\u63a7\u5236\u5668\u200b\u8282\u70b9\u200b\u4e0b\u200b\u521b\u5efa\u200b\u4e00\u4e2a\u200b\u5b50\u200b\u8282\u70b9\u200b\u3002 \u200b\u5c5e\u6027\u200b\uff1a</p> <ul> <li>\u200b\u5fc5\u5907\u200b\uff0c\u200b\u6839\u636e\u200b\u8fd9\u4e2a\u200b\u5c5e\u6027\u200b\u627e\u5230\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff1a<code>compatible = \"xxxx\";</code></li> <li>\u200b\u5fc5\u5907\u200b\uff0cI2C\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\uff1a<code>reg = &lt;0xXX&gt;;</code></li> <li> <p>\u200b\u53ef\u200b\u9009\u200b\uff1a</p> </li> <li> <p>\u200b\u4e2d\u65ad\u200b</p> </li> <li>\u200b\u590d\u4f4d\u200b\u5f15\u811a\u200b</li> </ul>"},{"location":"05_Input/04_5/#22-100ask_imx6ull","title":"2.2 100ASK_IMX6ULL","text":"<pre><code>&amp;i2c2 {\n    gt9xx@5d {\n            compatible = \"goodix,gt9xx\";\n            reg = &lt;0x5d&gt;;\n            status = \"okay\";\n            interrupt-parent = &lt;&amp;gpio1&gt;;\n            interrupts = &lt;5 IRQ_TYPE_EDGE_FALLING&gt;;\n            pinctrl-names = \"default\";\n            pinctrl-0 = &lt;&amp;pinctrl_tsc_reset &amp;pinctrl_touchscreen_int&gt;;\n            /*pinctrl-1 = &lt;&amp;pinctrl_tsc_irq&gt;;*/\n            /*\n             pinctrl-names = \"default\", \"int-output-low\", \"int-output-high\", \"int-input\";\n             pinctrl-0 = &lt;&amp;ts_int_default&gt;;\n             pinctrl-1 = &lt;&amp;ts_int_output_low&gt;;\n             pinctrl-2 = &lt;&amp;ts_int_output_high&gt;;\n             pinctrl-3 = &lt;&amp;ts_int_input&gt;;\n            */\n            reset-gpios = &lt;&amp;gpio5 2 GPIO_ACTIVE_LOW&gt;;\n            irq-gpios = &lt;&amp;gpio1 5 IRQ_TYPE_EDGE_FALLING&gt;;\n            irq-flags = &lt;2&gt;;                /*1:rising 2: falling*/\n\n            touchscreen-max-id = &lt;5&gt;;\n            touchscreen-size-x = &lt;800&gt;;\n            touchscreen-size-y = &lt;480&gt;;\n            touchscreen-max-w = &lt;1024&gt;;\n            touchscreen-max-p = &lt;1024&gt;;\n            /*touchscreen-key-map = &lt;172&gt;, &lt;158&gt;;*/ /*KEY_HOMEPAGE, KEY_BACK*/\n\n            goodix,type-a-report = &lt;0&gt;;\n            goodix,driver-send-cfg = &lt;0&gt;;\n            goodix,create-wr-node = &lt;1&gt;;\n            goodix,wakeup-with-reset = &lt;0&gt;;\n            goodix,resume-in-workqueue = &lt;0&gt;;\n            goodix,int-sync = &lt;0&gt;;\n            goodix,swap-x2y = &lt;0&gt;;\n            goodix,esd-protect = &lt;0&gt;;\n            goodix,pen-suppress-finger = &lt;0&gt;;\n            goodix,auto-update = &lt;0&gt;;\n            goodix,auto-update-cfg = &lt;0&gt;;\n            goodix,power-off-sleep = &lt;0&gt;;\n            /* ...... */\n    };\n};  \n</code></pre>"},{"location":"05_Input/04_5/#23-100ask_stm32mp157","title":"2.3 100ASK_STM32MP157","text":"<pre><code>&amp;i2c4 {\n    gt911@5d {\n        compatible = \"goodix,gt928\";\n        reg = &lt;0x5d&gt;;\n        interrupt-parent = &lt;&amp;gpioe&gt;;\n        interrupts = &lt;4 IRQ_TYPE_EDGE_FALLING&gt;;\n        reset-gpios = &lt;&amp;gpioe 12 GPIO_ACTIVE_LOW&gt;;\n        irq-gpios = &lt;&amp;gpioe 4 IRQ_TYPE_EDGE_FALLING&gt;;\n        irq-flags = &lt;2&gt;;                /*1:rising 2: falling*/\n        touchscreen-max-id = &lt;5&gt;;\n        touchscreen-size-x = &lt;1024&gt;;\n        touchscreen-size-y = &lt;600&gt;;\n    };\n};\n</code></pre>"},{"location":"05_Input/04_5/#3","title":"3. \u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5206\u6790","text":""},{"location":"05_Input/04_5/#31-input_dev","title":"3.1 \u200b\u5206\u914d\u200b/\u200b\u8bbe\u7f6e\u200b/\u200b\u6ce8\u518c\u200binput_dev","text":"<ul> <li>IMX6ULL Linux 4.x</li> </ul> <pre><code>gtp_probe\n    ret = gtp_request_input_dev(ts);\n            ts-&gt;input_dev = input_allocate_device();\n            ......\n            ret = input_register_device(ts-&gt;input_dev);\n\n    ret = gtp_request_irq(ts);          \n</code></pre> <ul> <li>STM32MP157 Linux 5.x</li> </ul> <pre><code>goodix_ts_probe\n        error = request_firmware_nowait(THIS_MODULE, true, ts-&gt;cfg_name,\n                        &amp;client-&gt;dev, GFP_KERNEL, ts,\n                        goodix_config_cb);\n\ngoodix_config_cb\n    goodix_configure_dev(ts);\n        ts-&gt;input_dev = devm_input_allocate_device(&amp;ts-&gt;client-&gt;dev);\n        ......\n        error = input_register_device(ts-&gt;input_dev);\n\n        error = goodix_request_irq(ts);     \n</code></pre>"},{"location":"05_Input/04_5/#32","title":"3.2 \u200b\u6ce8\u518c\u200b\u4e2d\u65ad\u200b\u5904\u7406\u51fd\u6570","text":"<ul> <li>IMX6ULL Linux 4.x</li> </ul> <pre><code>        ret = request_threaded_irq(ts-&gt;client-&gt;irq, NULL,\n                gtp_irq_handler,\n                ts-&gt;pdata-&gt;irq_flags | IRQF_ONESHOT,\n                ts-&gt;client-&gt;name,\n                ts);\n</code></pre> <ul> <li>STM32MP157 Linux 5.x</li> </ul> <pre><code>static int goodix_request_irq(struct goodix_ts_data *ts)\n{\n    return devm_request_threaded_irq(&amp;ts-&gt;client-&gt;dev, ts-&gt;client-&gt;irq,\n                     NULL, goodix_ts_irq_handler,\n                     ts-&gt;irq_flags, ts-&gt;client-&gt;name, ts);\n}\n</code></pre>"},{"location":"05_Input/04_5/#33","title":"3.3 \u200b\u4e2d\u65ad\u200b\u5904\u7406\u51fd\u6570\u200b\u5206\u6790","text":"<p>\u200b\u901a\u8fc7\u200bI2C\u200b\u51fd\u6570\u200b\u8bfb\u53d6\u6570\u636e\u200b\u3001\u200b\u4e0a\u62a5\u200b\u6570\u636e\u200b\u3002</p> <ul> <li>IMX6ULL Linux 4.x</li> </ul> <pre><code>gtp_irq_handler\n    gtp_work_func(ts);\n        point_state = gtp_get_points(ts, points, &amp;key_value);\n            gtp_i2c_read\n                i2c_transfer\n        gtp_mt_slot_report(ts, point_state &amp; 0x0f, points);\n            input_mt_slot\n            input_mt_report_slot_state\n            input_report_abs\n</code></pre> <ul> <li>STM32MP157 Linux 5.x</li> </ul> <pre><code>goodix_ts_irq_handler\n    goodix_process_events(ts);\n        touch_num = goodix_ts_read_input_report(ts, point_data);\n            goodix_i2c_read\n                i2c_transfer\n        goodix_ts_report_touch_9b\n            input_mt_slot\n            input_mt_report_slot_state\n            touchscreen_report_pos\n            input_report_abs\n</code></pre>"},{"location":"05_Input/04_6/","title":"DRV_06_UInput\u200b\u5206\u6790\u200b_\u200b\u7528\u6237\u200b\u6001\u200b\u521b\u5efa\u200binput_dev","text":""},{"location":"05_Input/04_6/#uinput_input_dev","title":"UInput\u200b\u5206\u6790\u200b_\u200b\u7528\u6237\u200b\u6001\u200b\u521b\u5efa\u200binput_dev","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>Linux 5.x\u200b\u5185\u6838\u200b</p> </li> <li> <p>Documentation\\input\\uinput.rst</p> </li> <li> <p>drivers\\input\\misc\\uinput.c</p> </li> <li> <p>Linux 4.x\u200b\u5185\u6838\u200b</p> </li> <li>\u200b\u5185\u6838\u200b\u6ca1\u6709\u200b\u5bf9\u5e94\u200b\u6587\u6863\u200b</li> <li> <p>drivers\\input\\misc\\uinput.c</p> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u5bf9\u5e94\u200b\u7684\u200b\u6e90\u7801\u200b\uff1aGIT\u200b\u4ed3\u5e93\u200b\u4e2d\u200b</p> </li> </ul> <pre><code>doc_and_source_for_drivers\\STM32MP157\\source\\A7\\05_Input\\04_uinput\ndoc_and_source_for_drivers\\IMX6ULL\\source\\05_Input\\04_uinput\n</code></pre>"},{"location":"05_Input/04_6/#1","title":"1. \u200b\u6982\u5ff5","text":"<p>uinput\u200b\u662f\u200b\u4e00\u4e2a\u200b\u5185\u6838\u6a21\u5757\u200b(\u200b\u9a71\u52a8\u200b)\uff0c\u200b\u5b83\u200b\u5141\u8bb8\u200b\u5e94\u7528\u7a0b\u5e8f\u200b\u6a21\u62df\u200b\u8f93\u5165\u200b\u8bbe\u5907\u200b(input_dev)\u3002 \u200b\u5e94\u7528\u7a0b\u5e8f\u200b\u901a\u8fc7\u200b\u8bbf\u95ee\u200b<code>/dev/uinput</code>\u200b\u6216\u200b<code>/dev/input/uinput</code>\uff1a</p> <ul> <li>\u200b\u521b\u5efa\u200b\u4e00\u4e2a\u200b\u865a\u62df\u200b\u7684\u200b\u8f93\u5165\u200b\u8bbe\u5907\u200b</li> <li>\u200b\u8bbe\u7f6e\u200b\u5b83\u200b\u7684\u200b\u5c5e\u6027\u200b</li> <li>APP\u200b\u53d1\u9001\u6570\u636e\u200b\u7ed9\u200b\u5b83\u200b\uff0c\u200b\u8ba9\u200b\u5b83\u200b\u4ea7\u751f\u200b\u8f93\u5165\u200b\u4e8b\u4ef6\u200b</li> <li>uinput\u200b\u5c31\u200b\u4f1a\u200b\u628a\u200b\u8fd9\u4e9b\u200b\u8f93\u5165\u200b\u4e8b\u4ef6\u200b\u5206\u200b\u53d1\u7ed9\u200b\u5176\u4ed6\u200b\u4f7f\u7528\u8005\u200b(APP\u200b\u6216\u200b\u5185\u6838\u200b\u91cc\u200b\u5176\u4ed6\u200b\u6a21\u5757\u200b)</li> </ul> <p>\u200b\u6846\u56fe\u200b\u5982\u4e0b\u200b\uff1a </p>"},{"location":"05_Input/04_6/#2","title":"2. \u200b\u7f16\u5199\u200b\u5e94\u7528\u7a0b\u5e8f","text":""},{"location":"05_Input/04_6/#3","title":"3. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":""},{"location":"05_Input/04_6/#31","title":"3.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<p>\u200b\u5728\u200bUbuntu\u200b\u4e2d\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-qemu/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre>"},{"location":"05_Input/04_6/#32","title":"3.2 \u200b\u914d\u7f6e\u200b\u5185\u6838","text":"<p>\u200b\u914d\u7f6e\u200b\u5185\u6838\u200b\uff1a\u200b\u6267\u884c\u200b<code>make menuconfig</code></p> <pre><code>-&gt; Device Drivers\n  -&gt; Input device support\n    -&gt; Generic input layer   \n      -&gt; Miscellaneous devices\n         &lt;M&gt;   User level driver support\n</code></pre>"},{"location":"05_Input/04_6/#33","title":"3.3 \u200b\u7f16\u8bd1\u200b\u9a71\u52a8","text":"<pre><code>book@100ask:~/100ask_imx6ull-qemu$ cd linux-4.9.88\nbook@100ask:~/100ask_imx6ull-qemu/linux-4.9.88$ make modules\n</code></pre> <p>\u200b\u6210\u529f\u200b\u7684\u8bdd\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\uff1a</p> <pre><code>drivers/input/misc/uinput.ko\n</code></pre> <p>\u200b\u590d\u5236\u5230\u200b\u5982\u4e0b\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp drivers/input/misc/uinput.ko ~/nfs_rootfs/\n</code></pre>"},{"location":"05_Input/04_6/#34","title":"3.4 \u200b\u7f16\u8bd1\u200b\u6d4b\u8bd5\u7a0b\u5e8f","text":"<p>\u200b\u628a\u200b\u4ee3\u7801\u200b<code>04_uinput</code>\u200b\u4e0a\u200b\u4f20\u5230\u200bUbuntu\uff0c\u200b\u8bbe\u7f6e\u200b\u597d\u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200b\u5de5\u5177\u200b\u94fe\u540e\u200b\uff0c\u200b\u5728\u200b<code>04_uinput</code>\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200bmake\u200b\u547d\u4ee4\u200b\u5373\u53ef\u200b\u3002</p> <pre><code>$ make\n$ cp uinput_test ~/nfs_rootfs/\n</code></pre>"},{"location":"05_Input/04_6/#35-qemu","title":"3.5 \u200b\u542f\u52a8\u200bQEMU","text":"<p>\u200b\u5728\u200bUbuntu\u200b\u4e2d\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>$ cd ubuntu-18.04_imx6ul_qemu_system\n$ ./qemu-imx6ull-gui.sh\n</code></pre>"},{"location":"05_Input/04_6/#36-nfs","title":"3.6 \u200b\u6302\u8f7d\u200bNFS\u3001\u200b\u5b9e\u9a8c","text":"<p>\u200b\u5728\u200bQEMU\u200b\u4e2d\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>$ mount -t nfs -o nolock,vers=3 10.0.2.2:/home/book/nfs_rootfs /mnt\n$ insmod /mnt/uinput.ko\n$ ls -l /dev/uinput   // \u200b\u786e\u8ba4\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\n\n// \u200b\u540e\u53f0\u200b\u8fd0\u884c\u200buinput_test\n/mnt/uinput_test &amp;\n\n// \u200b\u770b\u5230\u200b\u63d0\u793a\u200b\u8fd9\u4e2a\u200b\u63d0\u793a\u200b\u65f6\u200b: Will sleep 60s, in this time you should run ts_calibreate\n// \u200b\u8fd0\u884c\u200b\u6821\u51c6\u200b\u7a0b\u5e8f\u200b\n// \u200b\u6ce8\u610f\u200b\uff1a\u200b\u5982\u679c\u200b\u6709\u200b\u771f\u5b9e\u200b\u7684\u200b\u89e6\u6478\u5c4f\u200b\u9a71\u52a8\u200b\uff0c\u200b\u9700\u8981\u200b\u6307\u5b9a\u200b\u4f7f\u7528\u200b\u865a\u62df\u200b\u7684\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\n//      \u200b\u65b9\u6cd5\u200b\u793a\u4f8b\u200b: export TSLIB_TSDEVICE=/dev/input/event3\nts_calibrate\n\n// \u200b\u770b\u5230\u200b\u63d0\u793a\u200b\u8fd9\u4e2a\u200b\u63d0\u793a\u200b\u65f6\u200b: Will sleep 60s, in this time you should run ts_test\n// \u200b\u8fd0\u884c\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b\nts_test\n</code></pre>"},{"location":"05_Input/04_6/#4-uinput","title":"4. \u200b\u7ed3\u5408\u200b\u5e94\u7528\u7a0b\u5e8f\u200b\u5206\u6790\u200buinput","text":""},{"location":"06_Pinctrl/01/","title":"01_Pinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u89c6\u9891\u200b\u4ecb\u7ecd","text":""},{"location":"06_Pinctrl/01/#pinctrl","title":"Pinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u89c6\u9891\u200b\u4ecb\u7ecd","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux 5.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Documentation\\devicetree\\bindings\\pinctrl\\pinctrl-bindings.txt</li> <li>Linux 4.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Documentation\\pinctrl.txt</li> <li>Documentation\\devicetree\\bindings\\pinctrl\\pinctrl-bindings.txt</li> </ul>"},{"location":"06_Pinctrl/01/#1-pinctrl","title":"1. Pinctrl\u200b\u4f5c\u7528","text":"<p>Pinctrl\uff1aPin Controller\uff0c\u200b\u987e\u540d\u601d\u4e49\u200b\uff0c\u200b\u5c31\u662f\u200b\u7528\u6765\u200b\u63a7\u5236\u200b\u5f15\u811a\u200b\u7684\u200b\uff1a</p> <ul> <li>\u200b\u5f15\u811a\u200b\u679a\u4e3e\u200b\u4e0e\u200b\u547d\u540d\u200b(Enumerating and naming)</li> <li>\u200b\u5f15\u811a\u200b\u590d\u7528\u200b(Multiplexing)\uff1a\u200b\u6bd4\u5982\u200b\u7528\u4f5c\u200bGPIO\u3001I2C\u200b\u6216\u200b\u5176\u4ed6\u200b\u529f\u80fd\u200b</li> <li>\u200b\u5f15\u811a\u200b\u914d\u7f6e\u200b(Configuration)\uff1a\u200b\u6bd4\u5982\u200b\u4e0a\u62c9\u200b\u3001\u200b\u4e0b\u6765\u200b\u3001open drain\u3001\u200b\u9a71\u52a8\u200b\u5f3a\u5ea6\u200b\u7b49\u200b</li> </ul> <p>Pinctrl\u200b\u9a71\u52a8\u200b\u7531\u200b\u82af\u7247\u200b\u5382\u5bb6\u200b\u7684\u200bBSP\u200b\u5de5\u7a0b\u5e08\u200b\u63d0\u4f9b\u200b\uff0c\u200b\u4e00\u822c\u200b\u7684\u200b\u9a71\u52a8\u200b\u5de5\u7a0b\u5e08\u200b\u53ea\u200b\u9700\u8981\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\uff1a</p> <ul> <li>\u200b\u6307\u660e\u200b\u4f7f\u7528\u200b\u90a3\u4e9b\u200b\u5f15\u811a\u200b</li> <li>\u200b\u590d\u7528\u200b\u4e3a\u200b\u54ea\u4e9b\u200b\u529f\u80fd\u200b</li> <li>\u200b\u914d\u7f6e\u200b\u4e3a\u200b\u54ea\u4e9b\u200b\u72b6\u6001\u200b</li> </ul> <p>\u200b\u5728\u200b\u4e00\u822c\u200b\u7684\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u91cc\u200b\uff0c\u200b\u751a\u81f3\u200b\u53ef\u4ee5\u200b\u6ca1\u6709\u200bpinctrl\u200b\u7684\u200b\u4ee3\u7801\u200b\u3002</p> <p>\u200b\u5bf9\u4e8e\u200b\u4e00\u822c\u200b\u7684\u200b\u9a71\u52a8\u200b\u5de5\u7a0b\u5e08\u200b\uff0c\u200b\u53ea\u200b\u9700\u8981\u200b\u77e5\u9053\u200b\u201c\u200b\u600e\u4e48\u200b\u4f7f\u7528\u200bpinctrl\u201d\u200b\u5373\u53ef\u200b\u3002</p>"},{"location":"06_Pinctrl/01/#2","title":"2. \u200b\u9884\u8ba1\u200b\u5f55\u5236\u200b\u7684\u200b\u5185\u5bb9","text":"<ul> <li> <p>\u200b\u57fa\u4e8e\u200b\u4f7f\u7528\u200b\u7684\u200b\u89d2\u5ea6\u200b\u9a71\u52a8\u200b\u5de5\u7a0b\u5e08\u200b\u8981\u200b\u638c\u63e1\u200b\u7684\u200bPinctrl\u200b\u91cd\u8981\u200b\u6982\u5ff5\u200b</p> </li> <li> <p>Pinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u4f7f\u7528\u200b\u793a\u4f8b\u200b</p> </li> <li> <p>\u200b\u4e3b\u8981\u200b\u6570\u636e\u7ed3\u6784\u200b\u4e0e\u200b\u8c03\u8bd5\u200b\u65b9\u6cd5\u200b</p> </li> <li> <p>pincontroller\u200b\u7684\u200b\u6570\u636e\u7ed3\u6784\u200b\u6784\u9020\u200b\u8fc7\u7a0b\u200b\u60c5\u666f\u200b\u5206\u6790\u200b(\u200b\u4f1a\u200b\u62c6\u200b\u5206\u4e3a\u200b\u5f88\u591a\u200b\u8282\u200b)</p> </li> <li> <p>\u200b\u6839\u636e\u200b\u5f00\u53d1\u677f\u200b\u7684\u200b\u8bbe\u5907\u200b\u6811\u200b\u4fe1\u606f\u200b\u52a8\u6001\u200b\u5730\u200b\u6f14\u793a\u200b</p> </li> <li> <p>client\u200b\u7aef\u7684\u200b\u6570\u636e\u7ed3\u6784\u200b\u6784\u9020\u200b\u8fc7\u7a0b\u200b\u60c5\u666f\u200b\u5206\u6790\u200b(\u200b\u4f1a\u200b\u62c6\u200b\u5206\u4e3a\u200b\u5f88\u591a\u200b\u8282\u200b)</p> </li> <li> <p>\u200b\u6839\u636e\u200b\u5f00\u53d1\u677f\u200b\u7684\u200b\u8bbe\u5907\u200b\u6811\u200b\u4fe1\u606f\u200b\u52a8\u6001\u200b\u5730\u200b\u6f14\u793a\u200b</p> </li> <li> <p>\u200b\u7f16\u5199\u200b\u4e00\u4e2a\u200b\u865a\u62df\u200b\u7684\u200bpincontroller\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</p> </li> </ul>"},{"location":"06_Pinctrl/03_1/","title":"02_Pinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u4f7f\u7528\u200b\u793a\u4f8b\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":""},{"location":"06_Pinctrl/03_1/#pinctrl_imx6ull","title":"Pinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u4f7f\u7528\u200b\u793a\u4f8b\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux 5.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Documentation\\devicetree\\bindings\\pinctrl\\pinctrl-bindings.txt</li> <li>Linux 4.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Documentation\\pinctrl.txt</li> <li>Documentation\\devicetree\\bindings\\pinctrl\\pinctrl-bindings.txt</li> </ul>"},{"location":"06_Pinctrl/03_1/#1","title":"1. \u200b\u8981\u200b\u505a\u200b\u4ec0\u4e48","text":"<p>\u200b\u4ee5\u200bI2C\u200b\u4e3a\u4f8b\u200b\uff1a</p> <p></p> <ul> <li>\u200b\u67e5\u770b\u200b\u539f\u7406\u56fe\u200b\u786e\u5b9a\u200b\u4f7f\u7528\u200b\u54ea\u4e9b\u200b\u5f15\u811a\u200b\uff1a\u200b\u6bd4\u5982\u200bpinA\u3001pinB</li> <li>\u200b\u751f\u6210\u200bpincontroller\u200b\u8bbe\u5907\u200b\u6811\u200b\u4fe1\u606f\u200b</li> <li>\u200b\u9009\u62e9\u200b\u529f\u80fd\u200b\uff1a\u200b\u6bd4\u5982\u200b\u628a\u200bpinA\u200b\u914d\u7f6e\u200b\u4e3a\u200bI2C_SCL\u3001\u200b\u628a\u200bpinB\u200b\u914d\u7f6e\u200b\u4e3a\u200bI2C_SDA</li> <li>\u200b\u914d\u7f6e\u200b\uff1a\u200b\u6bd4\u5982\u200b\u628a\u200bpinA\u3001pinB\u200b\u914d\u7f6e\u200b\u4e3a\u200bopen drain</li> <li>\u200b\u4f7f\u7528\u200bpincontroller\u200b\u8bbe\u5907\u200b\u6811\u200b\u4fe1\u606f\u200b\uff1a\u200b\u6bd4\u5982\u200b\u5728\u200bi2c\u200b\u8282\u70b9\u200b\u91cc\u200b\u5b9a\u4e49\u200b\"pinctrl-names\"\u3001\"pinctrl-0\"</li> </ul>"},{"location":"06_Pinctrl/03_1/#2-pincontroller","title":"2. \u200b\u751f\u6210\u200bpincontroller\u200b\u8bbe\u5907\u200b\u6811\u200b\u4fe1\u606f","text":"<p>\u200b\u751f\u6210\u200bpincontroller\u200b\u8bbe\u5907\u200b\u6811\u200b\u4fe1\u606f\u200b\uff0c\u200b\u6709\u200b3\u200b\u4e2d\u200b\u65b9\u6cd5\u200b\uff1a</p> <ul> <li>\u200b\u6709\u4e9b\u200b\u82af\u7247\u200b\u6709\u200b\u56fe\u5f62\u5316\u200b\u7684\u200b\u5de5\u5177\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u70b9\u70b9\u200b\u9f20\u6807\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u914d\u7f6e\u200b\u5f15\u811a\u200b\u4fe1\u606f\u200b\uff0c\u200b\u5f97\u5230\u200bpincontroller\u200b\u4e2d\u200b\u7684\u200b\u4fe1\u606f\u200b</li> <li>\u200b\u6709\u4e9b\u200b\u82af\u7247\u200b\uff0c\u200b\u53ea\u80fd\u200b\u770b\u200b\u5382\u5bb6\u200b\u7ed9\u200b\u7684\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u6863\u200b\u6216\u8005\u200b\u53c2\u8003\u200b\u8bbe\u5907\u200b\u6811\u200b\u7684\u200b\u4f8b\u5b50\u200b</li> <li>\u200b\u6700\u5dee\u200b\u7684\u200b\u5c31\u662f\u200b\u9700\u8981\u200b\u9605\u8bfb\u200b\u9a71\u52a8\u200b\u4ee3\u7801\u200b\u624d\u80fd\u200b\u6784\u9020\u200b\u8bbe\u5907\u200b\u6811\u200b\u4fe1\u606f\u200b\u3002</li> </ul>"},{"location":"06_Pinctrl/03_1/#21","title":"2.1 \u200b\u5b89\u88c5\u200b\u5de5\u5177","text":"<p>\u200b\u5bf9\u4e8e\u200bIMX6ULL\uff0c\u200b\u6709\u200b\u5f15\u811a\u200b\u914d\u7f6e\u200b\u5de5\u5177\u200b/\u200b\u8bbe\u5907\u200b\u6811\u200b\u751f\u6210\u200b\u5de5\u5177\u200b\uff1a</p> <ul> <li>\u200b\u6253\u5f00\u200b\uff1ahttp://download.100ask.net/</li> <li>\u200b\u627e\u5230\u200b\u5f00\u53d1\u677f\u200b\uff1a\"100ASK_IMX6ULL_PRO\u200b\u5f00\u53d1\u677f\u200b\"</li> <li>\u200b\u4e0b\u8f7d\u200b\u5f00\u53d1\u677f\u200b\u914d\u5957\u200b\u8d44\u6599\u200b</li> <li>\u200b\u4e0b\u8f7d\u200b\u5b8c\u540e\u200b\uff0c\u200b\u5de5\u5177\u200b\u5728\u200b\u5982\u4e0b\u200b\u76ee\u5f55\u200b\u91cc\u200b\uff1a</li> </ul> <p></p>"},{"location":"06_Pinctrl/03_1/#22-pinctrl","title":"2.2 \u200b\u6839\u636e\u200b\u539f\u7406\u56fe\u200b\u751f\u6210\u200bpinctrl\u200b\u4fe1\u606f","text":"<pre><code>&amp;iomuxc {\n    pinctrl-names = \"default\";\n    pinctrl-0 = &lt;&amp;BOARD_InitPins&gt;;\n    imx6ull-board {\n        i2c1_pins: i2c1_pins {                /*!&lt; Function assigned for the core: Cortex-A7[ca7] */\n            fsl,pins = &lt;\n                MX6UL_PAD_UART4_RX_DATA__I2C1_SDA          0x000018B0\n                MX6UL_PAD_UART4_TX_DATA__I2C1_SCL          0x000018B0\n            &gt;;\n        };\n    };\n};\n</code></pre>"},{"location":"06_Pinctrl/03_1/#3-clientpinctrl","title":"3. \u200b\u5728\u200bclient\u200b\u8282\u70b9\u200b\u4f7f\u7528\u200bpinctrl","text":"<pre><code>&amp;i2c1 {\n    clock-frequency = &lt;100000&gt;;\n    pinctrl-names = \"default\";\n    pinctrl-0 = &lt;&amp;i2c1_pins&gt;;\n    status = \"okay\";\n};\n</code></pre>"},{"location":"06_Pinctrl/03_1/#4","title":"4. \u200b\u4f7f\u7528\u200b\u8fc7\u7a0b","text":"<p>\u200b\u8fd9\u662f\u200b\u900f\u660e\u200b\u7684\u200b\uff0c\u200b\u6211\u4eec\u200b\u7684\u200b\u9a71\u52a8\u200b\u57fa\u672c\u200b\u4e0d\u7528\u200b\u7ba1\u200b\u3002\u200b\u5f53\u200b\u8bbe\u5907\u200b\u5207\u6362\u200b\u72b6\u6001\u200b\u65f6\u200b\uff0c\u200b\u5bf9\u5e94\u200b\u7684\u200bpinctrl\u200b\u5c31\u200b\u4f1a\u200b\u88ab\u200b\u8c03\u7528\u200b\u3002</p> <p>\u200b\u6bd4\u5982\u200b\u5728\u200bplatform_device\u200b\u548c\u200bplatform_driver\u200b\u7684\u200b\u679a\u4e3e\u200b\u8fc7\u7a0b\u200b\u4e2d\u200b\uff0c\u200b\u6d41\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"06_Pinctrl/03_2/","title":"03_Pinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u4f7f\u7528\u200b\u793a\u4f8b","text":""},{"location":"06_Pinctrl/03_2/#pinctrl","title":"Pinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u4f7f\u7528\u200b\u793a\u4f8b","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux 5.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Documentation\\devicetree\\bindings\\pinctrl\\pinctrl-bindings.txt</li> <li>Linux 4.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Documentation\\pinctrl.txt</li> <li>Documentation\\devicetree\\bindings\\pinctrl\\pinctrl-bindings.txt</li> </ul>"},{"location":"06_Pinctrl/03_2/#_1","title":"03_Pinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u4f7f\u7528\u200b\u793a\u4f8b","text":""},{"location":"06_Pinctrl/04_1/","title":"04_Pinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u4e3b\u8981\u200b\u6570\u636e\u7ed3\u6784","text":""},{"location":"06_Pinctrl/04_1/#pinctrl","title":"Pinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u4e3b\u8981\u200b\u6570\u636e\u7ed3\u6784","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux 5.x\u200b\u5185\u6838\u200b</li> <li>Documentation\\devicetree\\bindings\\pinctrl\\pinctrl-bindings.txt</li> <li>arch/arm/boot/dts/stm32mp151.dtsi</li> <li>arch/arm/boot/dts/stm32mp157-100ask-pinctrl.dtsi  </li> <li>arch/arm/boot/dts/stm32mp15xx-100ask.dtsi</li> <li>drivers\\pinctrl\\stm32\\pinctrl-stm32mp157.c</li> <li>drivers\\pinctrl\\stm32\\pinctrl-stm32.c</li> <li>Linux 4.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Documentation\\pinctrl.txt</li> <li>Documentation\\devicetree\\bindings\\pinctrl\\pinctrl-bindings.txt</li> <li>arch/arm/boot/dts/imx6ull-14x14-evk.dts</li> <li>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</li> <li>drivers\\pinctrl\\freescale\\pinctrl-imx6ul.c</li> <li>drivers\\pinctrl\\freescale\\pinctrl-imx.c</li> </ul>"},{"location":"06_Pinctrl/04_1/#1","title":"1. \u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"06_Pinctrl/04_1/#11","title":"1.1 \u200b\u7406\u60f3\u200b\u6a21\u578b","text":""},{"location":"06_Pinctrl/04_1/#12","title":"1.2 \u200b\u5b9e\u9645\u200b\u7684\u200b\u4f8b\u5b50","text":"<ul> <li>IMX6ULL</li> </ul> <ul> <li>STM32MP157</li> </ul>"},{"location":"06_Pinctrl/04_1/#2-pincontroller","title":"2. pincontroller\u200b\u7684\u200b\u6570\u636e\u7ed3\u6784","text":"<p>\u200b\u8bb0\u4f4f\u200bpinctrl\u200b\u7684\u200b\u4e09\u5927\u200b\u4f5c\u7528\u200b\uff0c\u200b\u6709\u52a9\u4e8e\u200b\u7406\u89e3\u200b\u6240\u200b\u6d89\u53ca\u200b\u7684\u200b\u6570\u636e\u7ed3\u6784\u200b\uff1a</p> <ul> <li>\u200b\u5f15\u811a\u200b\u679a\u4e3e\u200b\u4e0e\u200b\u547d\u540d\u200b(Enumerating and naming)</li> <li>\u200b\u5f15\u811a\u200b\u590d\u7528\u200b(Multiplexing)\uff1a\u200b\u6bd4\u5982\u200b\u7528\u4f5c\u200bGPIO\u3001I2C\u200b\u6216\u200b\u5176\u4ed6\u200b\u529f\u80fd\u200b</li> <li>\u200b\u5f15\u811a\u200b\u914d\u7f6e\u200b(Configuration)\uff1a\u200b\u6bd4\u5982\u200b\u4e0a\u62c9\u200b\u3001\u200b\u4e0b\u6765\u200b\u3001open drain\u3001\u200b\u9a71\u52a8\u200b\u5f3a\u5ea6\u200b\u7b49\u200b</li> </ul>"},{"location":"06_Pinctrl/04_1/#21-pinctrl_descpinctrl_dev","title":"2.1 pinctrl_desc\u200b\u548c\u200bpinctrl_dev","text":""},{"location":"06_Pinctrl/04_1/#1_1","title":"1. \u200b\u7ed3\u6784\u200b\u4f53\u200b\u5f15\u5165","text":"<p>pincontroller\u200b\u867d\u7136\u200b\u662f\u200b\u4e00\u4e2a\u200b\u8f6f\u4ef6\u200b\u7684\u200b\u6982\u5ff5\u200b\uff0c\u200b\u4f46\u662f\u200b\u5b83\u200b\u80cc\u540e\u200b\u662f\u200b\u6709\u200b\u786c\u4ef6\u200b\u652f\u6301\u200b\u7684\u200b\uff0c\u200b\u6240\u4ee5\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u4e00\u4e2a\u200b\u7ed3\u6784\u200b\u4f53\u6765\u200b\u8868\u793a\u200b\u5b83\u200b\uff1apinctrl_dev\u3002</p> <p>\u200b\u600e\u4e48\u200b\u6784\u9020\u200b\u51fa\u200bpinctrl_dev\uff1f\u200b\u6211\u4eec\u200b\u53ea\u200b\u9700\u8981\u200b\u63cf\u8ff0\u200b\u5b83\u200b\uff1a\u200b\u63d0\u4f9b\u200b\u4e00\u4e2a\u200bpinctrl_desc\uff0c\u200b\u7136\u540e\u200b\u8c03\u7528\u200bpinctrl_register\u200b\u5c31\u200b\u53ef\u4ee5\u200b\uff1a</p> <pre><code>struct pinctrl_dev *pinctrl_register(struct pinctrl_desc *pctldesc,\n                    struct device *dev, void *driver_data);\n</code></pre> <p>\u200b\u600e\u4e48\u200b\u4f7f\u7528\u200bpinctrl_desc\u3001pinctrl_dev\u200b\u6765\u200b\u63cf\u8ff0\u200b\u4e00\u4e2a\u200bpin controller\uff1f\u200b\u8fd9\u200b\u4e24\u4e2a\u200b\u7ed3\u6784\u200b\u4f53\u200b\u5b9a\u4e49\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>pinctrl_desc\u200b\u793a\u4f8b\u200b\u5982\u4e0b\u200b\uff1a </p>"},{"location":"06_Pinctrl/04_1/#2-1","title":"2. \u200b\u4f5c\u7528\u200b1\uff1a\u200b\u63cf\u8ff0\u200b\u3001\u200b\u83b7\u5f97\u200b\u5f15\u811a","text":"<p>\u200b\u4f7f\u7528\u200b\u7ed3\u6784\u200b\u4f53\u200bpinctrl_pin_desc\u200b\u6765\u200b\u63cf\u8ff0\u200b\u4e00\u4e2a\u200b\u5f15\u811a\u200b\uff0c\u200b\u4e00\u4e2a\u200bpin controller\u200b\u6709\u200b\u591a\u4e2a\u200b\u5f15\u811a\u200b\uff1a</p> <p></p> <p>\u200b\u4f7f\u7528\u200bpinctrl_ops\u200b\u6765\u200b\u64cd\u4f5c\u200b\u5f15\u811a\u200b\uff0c\u200b\u4e3b\u8981\u200b\u529f\u80fd\u200b\u6709\u200b\u4e8c\u200b\uff1a</p> <ul> <li>\u200b\u6765\u200b\u53d6\u51fa\u200b\u67d0\u7ec4\u200b\u7684\u200b\u5f15\u811a\u200b\uff1aget_groups_count\u3001get_group_pins</li> <li>\u200b\u5904\u7406\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200bpin controller\u200b\u4e2d\u200b\u7684\u200b\u67d0\u4e2a\u200b\u8282\u70b9\u200b\uff1adt_node_to_map\uff0c\u200b\u628a\u200bdevice_node\u200b\u8f6c\u6362\u200b\u4e3a\u200b\u4e00\u7cfb\u5217\u200b\u7684\u200bpinctrl_map</li> </ul> <p></p>"},{"location":"06_Pinctrl/04_1/#3-2","title":"3. \u200b\u4f5c\u7528\u200b2\uff1a\u200b\u5f15\u811a\u200b\u590d\u7528","text":""},{"location":"06_Pinctrl/04_1/#4-3","title":"4. \u200b\u4f5c\u7528\u200b3\uff1a\u200b\u5f15\u811a\u200b\u914d\u7f6e","text":""},{"location":"06_Pinctrl/04_1/#5-pinctrl_descpinctrl_dev","title":"5. \u200b\u4f7f\u7528\u200bpinctrl_desc\u200b\u6ce8\u518c\u200b\u5f97\u5230\u200bpinctrl_dev","text":"<p>\u200b\u8c03\u7528\u200bdevm_pinctrl_register\u200b\u6216\u200bpinctrl_register\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u6839\u636e\u200bpinctrl_desc\u200b\u6784\u9020\u200b\u51fa\u200bpinctrl_dev\uff0c\u200b\u5e76\u4e14\u200b\u628a\u200bpinctrl_dev\u200b\u653e\u5165\u200b\u94fe\u8868\u200b\uff1a</p> <pre><code>devm_pinctrl_register\n    pinctrl_register\n        struct pinctrl_dev *pctldev;\n        pctldev = kzalloc(sizeof(*pctldev), GFP_KERNEL);\n\n        pctldev-&gt;owner = pctldesc-&gt;owner;\n        pctldev-&gt;desc = pctldesc;\n        pctldev-&gt;driver_data = driver_data;\n\n        /* check core ops for sanity */\n        ret = pinctrl_check_ops(pctldev);\n\n        /* If we're implementing pinmuxing, check the ops for sanity */\n        ret = pinmux_check_ops(pctldev);\n\n        /* If we're implementing pinconfig, check the ops for sanity */\n        ret = pinconf_check_ops(pctldev);\n\n        /* Register all the pins */\n        ret = pinctrl_register_pins(pctldev, pctldesc-&gt;pins, pctldesc-&gt;npins);\n\n        list_add_tail(&amp;pctldev-&gt;node, &amp;pinctrldev_list);\n</code></pre>"},{"location":"06_Pinctrl/04_1/#3-client","title":"3. client\u200b\u7684\u200b\u6570\u636e\u7ed3\u6784","text":"<p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\uff0c\u200b\u4f7f\u7528\u200bpinctrl\u200b\u65f6\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>/* For a client device requiring named states */\ndevice {\n    pinctrl-names = \"active\", \"idle\";\n    pinctrl-0 = &lt;&amp;state_0_node_a&gt;;\n    pinctrl-1 = &lt;&amp;state_1_node_a &amp;state_1_node_b&gt;;\n};\n</code></pre> <p>\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u8981\u4e48\u200b\u88ab\u200b\u8f6c\u6362\u200b\u4e3a\u200bplatform_device\uff0c\u200b\u6216\u8005\u200b\u5176\u4ed6\u200b\u7ed3\u6784\u200b\u4f53\u200b(\u200b\u6bd4\u5982\u200bi2c_client)\uff0c\u200b\u4f46\u662f\u200b\u91cc\u9762\u200b\u90fd\u200b\u4f1a\u200b\u6709\u200b\u4e00\u4e2a\u200bdevice\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u6bd4\u5982\u200b\uff1a</p> <p></p>"},{"location":"06_Pinctrl/04_1/#31-dev_pin_info","title":"3.1 dev_pin_info","text":"<p>\u200b\u6bcf\u4e2a\u200bdevice\u200b\u7ed3\u6784\u200b\u4f53\u91cc\u200b\u90fd\u200b\u6709\u200b\u4e00\u4e2a\u200bdev_pin_info\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u7528\u6765\u200b\u4fdd\u5b58\u200b\u8bbe\u5907\u200b\u7684\u200bpinctrl\u200b\u4fe1\u606f\u200b\uff1a</p> <p></p>"},{"location":"06_Pinctrl/04_1/#32-pinctrl","title":"3.2 pinctrl","text":"<p>\u200b\u5047\u8bbe\u200b\u82af\u7247\u200b\u4e0a\u200b\u6709\u200b\u591a\u4e2a\u200bpin controller\uff0c\u200b\u90a3\u4e48\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u4f7f\u7528\u200b\u54ea\u4e2a\u200bpin controller\uff1f</p> <p>\u200b\u8fd9\u200b\u9700\u8981\u200b\u901a\u8fc7\u200b\u8bbe\u5907\u200b\u6811\u6765\u200b\u786e\u5b9a\u200b\uff1a</p> <ul> <li>\u200b\u5206\u6790\u200b\u8bbe\u5907\u200b\u6811\u200b\uff0c\u200b\u627e\u5230\u200bpin controller</li> <li>\u200b\u5bf9\u4e8e\u200b\u6bcf\u4e2a\u200b\u72b6\u6001\u200b\uff0c\u200b\u6bd4\u5982\u200bdefault\u3001init\uff0c\u200b\u53bb\u200b\u5206\u6790\u200bpin controller\u200b\u4e2d\u200b\u7684\u200b\u8bbe\u5907\u200b\u6811\u200b\u8282\u70b9\u200b</li> <li>\u200b\u4f7f\u7528\u200bpin controller\u200b\u7684\u200bpinctrl_ops.dt_node_to_map\u200b\u6765\u200b\u5904\u7406\u200b\u8bbe\u5907\u200b\u6811\u200b\u7684\u200bpinctrl\u200b\u8282\u70b9\u200b\u4fe1\u606f\u200b\uff0c\u200b\u5f97\u5230\u200b\u4e00\u7cfb\u5217\u200b\u7684\u200bpinctrl_map</li> <li>\u200b\u8fd9\u4e9b\u200bpinctrl_map\u200b\u653e\u5728\u200bpinctrl.dt_maps\u200b\u94fe\u8868\u200b\u4e2d\u200b</li> <li>\u200b\u6bcf\u4e2a\u200bpinctrl_map\u200b\u90fd\u200b\u88ab\u200b\u8f6c\u6362\u200b\u4e3a\u200bpinctrl_setting\uff0c\u200b\u653e\u5728\u200b\u5bf9\u5e94\u200b\u7684\u200bpinctrl_state.settings\u200b\u94fe\u8868\u200b\u4e2d\u200b</li> </ul> <p></p>"},{"location":"06_Pinctrl/04_1/#33-pinctrl_mappinctrl_setting","title":"3.3 pinctrl_map\u200b\u548c\u200bpinctrl_setting","text":"<p>\u200b\u8bbe\u5907\u200b\u5f15\u7528\u200bpin controller\u200b\u4e2d\u200b\u7684\u200b\u67d0\u4e2a\u200b\u8282\u70b9\u200b\u65f6\u200b\uff0c\u200b\u8fd9\u4e2a\u200b\u8282\u70b9\u200b\u4f1a\u200b\u88ab\u200b\u8f6c\u6362\u200b\u4e3a\u200b\u4e00\u4e9b\u200b\u5217\u200b\u7684\u200bpinctrl_map\uff1a</p> <ul> <li>\u200b\u8f6c\u6362\u200b\u4e3a\u200b\u591a\u5c11\u200b\u4e2a\u200bpinctrl_map\uff0c\u200b\u5b8c\u5168\u200b\u7531\u200b\u5177\u4f53\u200b\u7684\u200b\u9a71\u52a8\u200b\u51b3\u5b9a\u200b</li> <li>\u200b\u6bcf\u4e2a\u200bpinctrl_map\uff0c\u200b\u53c8\u200b\u88ab\u200b\u8f6c\u6362\u200b\u4e3a\u200b\u4e00\u4e2a\u200bpinctrl_setting</li> <li>\u200b\u4e3e\u4f8b\u200b\uff0c\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u91cc\u200b\u6709\u200b\uff1a<code>pinctrl-0 = &lt;&amp;state_0_node_a&gt;</code></li> <li>pinctrl-0\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200b\u72b6\u6001\u200b\uff0c\u200b\u4f1a\u200b\u5f97\u5230\u200b\u4e00\u4e2a\u200bpinctrl_state</li> <li>state_0_node_a\u200b\u8282\u70b9\u200b\u88ab\u200b\u89e3\u6790\u200b\u4e3a\u200b\u4e00\u7cfb\u5217\u200b\u7684\u200bpinctrl_map</li> <li>\u200b\u8fd9\u200b\u4e00\u7cfb\u5217\u200b\u7684\u200bpinctrl_map\u200b\u88ab\u200b\u8f6c\u6362\u200b\u4e3a\u200b\u4e00\u7cfb\u5217\u200b\u7684\u200bpinctrl_setting</li> <li>\u200b\u8fd9\u4e9b\u200bpinctrl_setting\u200b\u88ab\u200b\u653e\u5165\u200bpinctrl_state\u200b\u7684\u200bsettings\u200b\u94fe\u8868\u200b</li> </ul> <p></p>"},{"location":"06_Pinctrl/04_1/#4-pinctrl_setting","title":"4. \u200b\u4f7f\u7528\u200bpinctrl_setting","text":"<p>\u200b\u8c03\u7528\u200b\u8fc7\u7a0b\u200b\uff1a</p> <pre><code>really_probe\n    pinctrl_bind_pins\n        pinctrl_select_state\n            /* Apply all the settings for the new state */\n            list_for_each_entry(setting, &amp;state-&gt;settings, node) {\n                switch (setting-&gt;type) {\n                case PIN_MAP_TYPE_MUX_GROUP:\n                    ret = pinmux_enable_setting(setting);\n                            ret = ops-&gt;set_mux(...);\n                break;\n                case PIN_MAP_TYPE_CONFIGS_PIN:\n                case PIN_MAP_TYPE_CONFIGS_GROUP:\n                    ret = pinconf_apply_setting(setting);\n                            ret = ops-&gt;pin_config_group_set(...);\n                    break;\n                default:\n                    ret = -EINVAL;\n                break;\n            }       \n</code></pre> <p></p>"},{"location":"06_Pinctrl/05_1/","title":"05_Pincontroller\u200b\u6784\u9020\u200b\u8fc7\u7a0b\u200b\u60c5\u666f\u200b\u5206\u6790\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":""},{"location":"06_Pinctrl/05_1/#pincontroller_imx6ull","title":"Pincontroller\u200b\u6784\u9020\u200b\u8fc7\u7a0b\u200b\u60c5\u666f\u200b\u5206\u6790\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux 4.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Documentation\\pinctrl.txt</li> <li>Documentation\\devicetree\\bindings\\pinctrl\\pinctrl-bindings.txt</li> <li>arch/arm/boot/dts/imx6ull-14x14-evk.dts</li> <li>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</li> <li>drivers\\pinctrl\\freescale\\pinctrl-imx6ul.c</li> <li>drivers\\pinctrl\\freescale\\pinctrl-imx.c</li> </ul>"},{"location":"06_Pinctrl/05_1/#1","title":"1. \u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"06_Pinctrl/05_1/#2","title":"2. \u200b\u9a71\u52a8\u200b\u4ee3\u7801\u6267\u884c\u200b\u6d41\u7a0b","text":"<p>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4f4d\u7f6e\u200b\uff1a</p> <pre><code>drivers\\pinctrl\\freescale\\pinctrl-imx6ul.c\ndrivers\\pinctrl\\freescale\\pinctrl-imx.c\n</code></pre> <p>\u200b\u8c03\u7528\u200b\u8fc7\u7a0b\u200b\uff1a</p> <pre><code>imx6ul_pinctrl_probe\n    imx_pinctrl_probe(pdev, pinctrl_info);\n        imx_pinctrl_desc-&gt;name = dev_name(&amp;pdev-&gt;dev);\n        imx_pinctrl_desc-&gt;pins = info-&gt;pins;\n        imx_pinctrl_desc-&gt;npins = info-&gt;npins;\n        imx_pinctrl_desc-&gt;pctlops = &amp;imx_pctrl_ops;\n        imx_pinctrl_desc-&gt;pmxops = &amp;imx_pmx_ops;\n        imx_pinctrl_desc-&gt;confops = &amp;imx_pinconf_ops;\n        imx_pinctrl_desc-&gt;owner = THIS_MODULE;\n\n        ret = imx_pinctrl_probe_dt(pdev, info);\n\n        ipctl-&gt;pctl = devm_pinctrl_register(&amp;pdev-&gt;dev,\n                            imx_pinctrl_desc, ipctl);\n</code></pre>"},{"location":"06_Pinctrl/05_1/#3-1","title":"3. \u200b\u4f5c\u7528\u200b1\uff1a\u200b\u63cf\u8ff0\u200b\u3001\u200b\u83b7\u5f97\u200b\u5f15\u811a\u200b\uff1a\u200b\u89e3\u6790\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"06_Pinctrl/05_1/#31","title":"3.1 \u200b\u5355\u4e2a\u200b\u5f15\u811a","text":"<pre><code>    imx_pinctrl_desc-&gt;pins = info-&gt;pins;\n    imx_pinctrl_desc-&gt;npins = info-&gt;npins;\n</code></pre> <p>\u200b\u53ef\u4ee5\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u67e5\u770b\u200b\uff1a</p> <pre><code>/sys/kernel/debug/pinctrl/20e0000.iomuxc]# cat pins\n</code></pre>"},{"location":"06_Pinctrl/05_1/#32","title":"3.2 \u200b\u67d0\u7ec4\u200b\u5f15\u811a","text":"<pre><code>static const struct pinctrl_ops imx_pctrl_ops = {\n    .get_groups_count = imx_get_groups_count,\n    .get_group_name = imx_get_group_name,\n    .get_group_pins = imx_get_group_pins,\n    .pin_dbg_show = imx_pin_dbg_show,\n    .dt_node_to_map = imx_dt_node_to_map,\n    .dt_free_map = imx_dt_free_map,\n\n};\n</code></pre> <p>\u200b\u67d0\u7ec4\u200b\u5f15\u811a\u200b\u4e2d\u200b\uff0c\u200b\u6709\u200b\u54ea\u4e9b\u200b\u5f15\u811a\u200b\uff1f\u200b\u8fd9\u8981\u200b\u5206\u6790\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1aimx_pinctrl_probe_dt\u3002</p> <pre><code>[root@100ask:/sys/kernel/debug/pinctrl/20e0000.iomuxc]# cat pingroups\n</code></pre>"},{"location":"06_Pinctrl/05_1/#33","title":"3.3 \u200b\u8bbe\u5907\u200b\u6811\u200b\u89e3\u6790\u200b\u60c5\u666f\u200b\u5206\u6790","text":"<p>\u200b\u5206\u6790\u200b\uff1aimx_pinctrl_probe_dt</p>"},{"location":"06_Pinctrl/05_1/#4-2","title":"4. \u200b\u4f5c\u7528\u200b2\uff1a\u200b\u5f15\u811a\u200b\u590d\u7528","text":"<p>\u200b\u4e0b\u8282\u200b\u89c6\u9891\u200b\u8bb2\u89e3\u200b\u3002</p>"},{"location":"06_Pinctrl/05_1/#5-3","title":"5. \u200b\u4f5c\u7528\u200b3\uff1a\u200b\u5f15\u811a\u200b\u914d\u7f6e","text":"<p>\u200b\u4e0b\u8282\u200b\u89c6\u9891\u200b\u8bb2\u89e3\u200b\u3002</p>"},{"location":"06_Pinctrl/06_1/","title":"06_client\u200b\u7aef\u200b\u4f7f\u7528\u200bpinctrl\u200b\u8fc7\u7a0b\u200b\u7684\u200b\u60c5\u666f\u200b\u5206\u6790\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":""},{"location":"06_Pinctrl/06_1/#clientpinctrl_imx6ull","title":"client\u200b\u7aef\u200b\u4f7f\u7528\u200bpinctrl\u200b\u8fc7\u7a0b\u200b\u7684\u200b\u60c5\u666f\u200b\u5206\u6790\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a * Linux 5.x\u200b\u5185\u6838\u200b   * Documentation\\devicetree\\bindings\\pinctrl\\pinctrl-bindings.txt   * arch/arm/boot/dts/stm32mp151.dtsi   * arch/arm/boot/dts/stm32mp157-100ask-pinctrl.dtsi   * arch/arm/boot/dts/stm32mp15xx-100ask.dtsi   * drivers\\pinctrl\\stm32\\pinctrl-stm32mp157.c   * drivers\\pinctrl\\stm32\\pinctrl-stm32.c</p> <ul> <li>Linux 4.x\u200b\u5185\u6838\u200b</li> <li>Documentation\\pinctrl.txt</li> <li>Documentation\\devicetree\\bindings\\pinctrl\\pinctrl-bindings.txt</li> <li>arch/arm/boot/dts/imx6ull-14x14-evk.dts</li> <li>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</li> <li>drivers\\pinctrl\\freescale\\pinctrl-imx6ul.c</li> <li>drivers\\pinctrl\\freescale\\pinctrl-imx.c</li> </ul>"},{"location":"06_Pinctrl/06_1/#1-client","title":"1. \u200b\u56de\u987e\u200bclient\u200b\u7684\u200b\u6570\u636e\u7ed3\u6784","text":"<p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\uff0c\u200b\u4f7f\u7528\u200bpinctrl\u200b\u65f6\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u8981\u4e48\u200b\u88ab\u200b\u8f6c\u6362\u200b\u4e3a\u200bplatform_device\uff0c\u200b\u6216\u8005\u200b\u5176\u4ed6\u200b\u7ed3\u6784\u200b\u4f53\u200b(\u200b\u6bd4\u5982\u200bi2c_client)\uff0c\u200b\u4f46\u662f\u200b\u91cc\u9762\u200b\u90fd\u200b\u4f1a\u200b\u6709\u200b\u4e00\u4e2a\u200bdevice\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u6bd4\u5982\u200b\uff1a</p> <p></p>"},{"location":"06_Pinctrl/06_1/#11-dev_pin_info","title":"1.1 dev_pin_info","text":"<p>\u200b\u6bcf\u4e2a\u200bdevice\u200b\u7ed3\u6784\u200b\u4f53\u91cc\u200b\u90fd\u200b\u6709\u200b\u4e00\u4e2a\u200bdev_pin_info\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u7528\u6765\u200b\u4fdd\u5b58\u200b\u8bbe\u5907\u200b\u7684\u200bpinctrl\u200b\u4fe1\u606f\u200b\uff1a</p> <p></p>"},{"location":"06_Pinctrl/06_1/#12-pinctrl","title":"1.2 pinctrl","text":"<p>\u200b\u5047\u8bbe\u200b\u82af\u7247\u200b\u4e0a\u200b\u6709\u200b\u591a\u4e2a\u200bpin controller\uff0c\u200b\u90a3\u4e48\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u4f7f\u7528\u200b\u54ea\u4e2a\u200bpin controller\uff1f</p> <p>\u200b\u8fd9\u200b\u9700\u8981\u200b\u901a\u8fc7\u200b\u8bbe\u5907\u200b\u6811\u6765\u200b\u786e\u5b9a\u200b\uff1a</p> <ul> <li>\u200b\u5206\u6790\u200b\u8bbe\u5907\u200b\u6811\u200b\uff0c\u200b\u627e\u5230\u200bpin controller</li> <li>\u200b\u5bf9\u4e8e\u200b\u6bcf\u4e2a\u200b\u72b6\u6001\u200b\uff0c\u200b\u6bd4\u5982\u200bdefault\u3001init\uff0c\u200b\u53bb\u200b\u5206\u6790\u200bpin controller\u200b\u4e2d\u200b\u7684\u200b\u8bbe\u5907\u200b\u6811\u200b\u8282\u70b9\u200b</li> <li>\u200b\u4f7f\u7528\u200bpin controller\u200b\u7684\u200bpinctrl_ops.dt_node_to_map\u200b\u6765\u200b\u5904\u7406\u200b\u8bbe\u5907\u200b\u6811\u200b\u7684\u200bpinctrl\u200b\u8282\u70b9\u200b\u4fe1\u606f\u200b\uff0c\u200b\u5f97\u5230\u200b\u4e00\u7cfb\u5217\u200b\u7684\u200bpinctrl_map</li> <li>\u200b\u8fd9\u4e9b\u200bpinctrl_map\u200b\u653e\u5728\u200bpinctrl.dt_maps\u200b\u94fe\u8868\u200b\u4e2d\u200b</li> <li>\u200b\u6bcf\u4e2a\u200bpinctrl_map\u200b\u90fd\u200b\u88ab\u200b\u8f6c\u6362\u200b\u4e3a\u200bpinctrl_setting\uff0c\u200b\u653e\u5728\u200b\u5bf9\u5e94\u200b\u7684\u200bpinctrl_state.settings\u200b\u94fe\u8868\u200b\u4e2d\u200b</li> </ul> <p></p>"},{"location":"06_Pinctrl/06_1/#13-pinctrl_mappinctrl_setting","title":"1.3 pinctrl_map\u200b\u548c\u200bpinctrl_setting","text":"<p>\u200b\u8bbe\u5907\u200b\u5f15\u7528\u200bpin controller\u200b\u4e2d\u200b\u7684\u200b\u67d0\u4e2a\u200b\u8282\u70b9\u200b\u65f6\u200b\uff0c\u200b\u8fd9\u4e2a\u200b\u8282\u70b9\u200b\u4f1a\u200b\u88ab\u200b\u8f6c\u6362\u200b\u4e3a\u200b\u4e00\u4e9b\u200b\u5217\u200b\u7684\u200bpinctrl_map\uff1a</p> <ul> <li>\u200b\u8f6c\u6362\u200b\u4e3a\u200b\u591a\u5c11\u200b\u4e2a\u200bpinctrl_map\uff0c\u200b\u5b8c\u5168\u200b\u7531\u200b\u5177\u4f53\u200b\u7684\u200b\u9a71\u52a8\u200b\u51b3\u5b9a\u200b</li> <li>\u200b\u6bcf\u4e2a\u200bpinctrl_map\uff0c\u200b\u53c8\u200b\u88ab\u200b\u8f6c\u6362\u200b\u4e3a\u200b\u4e00\u4e2a\u200bpinctrl_setting</li> <li>\u200b\u4e3e\u4f8b\u200b\uff0c\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u91cc\u200b\u6709\u200b\uff1a<code>pinctrl-0 = &lt;&amp;state_0_node_a&gt;</code></li> <li>pinctrl-0\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200b\u72b6\u6001\u200b\uff0c\u200b\u4f1a\u200b\u5f97\u5230\u200b\u4e00\u4e2a\u200bpinctrl_state</li> <li>state_0_node_a\u200b\u8282\u70b9\u200b\u88ab\u200b\u89e3\u6790\u200b\u4e3a\u200b\u4e00\u7cfb\u5217\u200b\u7684\u200bpinctrl_map</li> <li>\u200b\u8fd9\u200b\u4e00\u7cfb\u5217\u200b\u7684\u200bpinctrl_map\u200b\u88ab\u200b\u8f6c\u6362\u200b\u4e3a\u200b\u4e00\u7cfb\u5217\u200b\u7684\u200bpinctrl_setting</li> <li>\u200b\u8fd9\u4e9b\u200bpinctrl_setting\u200b\u88ab\u200b\u653e\u5165\u200bpinctrl_state\u200b\u7684\u200bsettings\u200b\u94fe\u8868\u200b</li> </ul> <p></p>"},{"location":"06_Pinctrl/06_1/#2-clientpinctrl","title":"2. client\u200b\u8282\u70b9\u200b\u7684\u200bpinctrl\u200b\u6784\u9020\u200b\u8fc7\u7a0b","text":""},{"location":"06_Pinctrl/06_1/#21","title":"2.1 \u200b\u51fd\u6570\u8c03\u7528","text":"<pre><code>really_probe\n    pinctrl_bind_pins\n        dev-&gt;pins = devm_kzalloc(dev, sizeof(*(dev-&gt;pins)), GFP_KERNEL);\n\n        dev-&gt;pins-&gt;p = devm_pinctrl_get(dev);\n                            pinctrl_get\n                                create_pinctrl(dev);\n                                    ret = pinctrl_dt_to_map(p);\n\n                                    for_each_maps(maps_node, i, map) {\n                                        ret = add_setting(p, map);\n                                    }\n\n        dev-&gt;pins-&gt;default_state = pinctrl_lookup_state(dev-&gt;pins-&gt;p,\n                    PINCTRL_STATE_DEFAULT);         \n</code></pre>"},{"location":"06_Pinctrl/06_1/#22","title":"2.2 \u200b\u60c5\u666f\u200b\u5206\u6790","text":""},{"location":"06_Pinctrl/06_1/#1-pinctrl_map","title":"1. \u200b\u8bbe\u5907\u200b\u6811\u200b\u8f6c\u6362\u200b\u4e3a\u200bpinctrl_map","text":""},{"location":"06_Pinctrl/06_1/#2-pinctrl_mappinctrl_setting","title":"2. pinctrl_map\u200b\u8f6c\u6362\u200b\u4e3a\u200bpinctrl_setting","text":""},{"location":"06_Pinctrl/06_1/#3-state","title":"3. \u200b\u5207\u6362\u200bstate\u200b\u60c5\u666f\u200b\u5206\u6790","text":""},{"location":"06_Pinctrl/06_1/#31","title":"3.1 \u200b\u51fd\u6570\u8c03\u7528\u200b\u8fc7\u7a0b","text":"<p>\u200b\u6d89\u53ca\u200bpinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u7684\u200b\u5176\u4ed6\u200b2\u200b\u4e2a\u200b\u4f5c\u7528\u200b\uff1a\u200b\u5f15\u811a\u200b\u590d\u7528\u200b\u3001\u200b\u5f15\u811a\u200b\u914d\u7f6e\u200b</p> <pre><code>really_probe\n    pinctrl_bind_pins\n        pinctrl_select_state\n            /* Apply all the settings for the new state */\n            list_for_each_entry(setting, &amp;state-&gt;settings, node) {\n                switch (setting-&gt;type) {\n                case PIN_MAP_TYPE_MUX_GROUP:\n                    ret = pinmux_enable_setting(setting);\n                            ret = ops-&gt;set_mux(...);\n                break;\n                case PIN_MAP_TYPE_CONFIGS_PIN:\n                case PIN_MAP_TYPE_CONFIGS_GROUP:\n                    ret = pinconf_apply_setting(setting);\n                            ret = ops-&gt;pin_config_group_set(...);\n                    break;\n                default:\n                    ret = -EINVAL;\n                break;\n            }       \n</code></pre>"},{"location":"06_Pinctrl/06_1/#32","title":"3.2 \u200b\u60c5\u666f\u200b\u5206\u6790","text":""},{"location":"06_Pinctrl/06_1/#_1","title":"06_client\u200b\u7aef\u200b\u4f7f\u7528\u200bpinctrl\u200b\u8fc7\u7a0b\u200b\u7684\u200b\u60c5\u666f\u200b\u5206\u6790\u200b_\u200b\u57fa\u4e8e\u200bIMX6ULL","text":""},{"location":"06_Pinctrl/07_1/","title":"07_\u200b\u7f16\u5199\u200b\u865a\u62df\u200b\u7684\u200bPinctrl\u200b\u9a71\u52a8\u7a0b\u5e8f","text":""},{"location":"06_Pinctrl/07_1/#pinctrl","title":"\u7f16\u5199\u200b\u865a\u62df\u200b\u7684\u200bPinctrl\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a * Linux 5.x\u200b\u5185\u6838\u200b   * Documentation\\devicetree\\bindings\\pinctrl\\pinctrl-bindings.txt   * arch/arm/boot/dts/stm32mp151.dtsi   * arch/arm/boot/dts/stm32mp157-100ask-pinctrl.dtsi   * arch/arm/boot/dts/stm32mp15xx-100ask.dtsi   * drivers\\pinctrl\\stm32\\pinctrl-stm32mp157.c   * drivers\\pinctrl\\stm32\\pinctrl-stm32.c</p> <ul> <li>Linux 4.x\u200b\u5185\u6838\u200b</li> <li>Documentation\\pinctrl.txt</li> <li>Documentation\\devicetree\\bindings\\pinctrl\\pinctrl-bindings.txt</li> <li>arch/arm/boot/dts/imx6ull-14x14-evk.dts</li> <li>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</li> <li>drivers\\pinctrl\\freescale\\pinctrl-imx6ul.c</li> <li> <p>drivers\\pinctrl\\freescale\\pinctrl-imx.c</p> </li> <li> <p>\u200b\u672c\u8bfe\u200b\u5bf9\u5e94\u200b\u7684\u200b\u6e90\u7801\u200b</p> </li> <li> <p>GIT\u200b\u4ed3\u5e93\u200b\u4e2d\u200b(\u200b\u672a\u200b\u6d4b\u8bd5\u200b\uff0c\u200b\u4e0b\u4e00\u8bfe\u200b\u624d\u200b\u6d4b\u8bd5\u200b)</p> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\source\\06_Pinctrl\\01_virtual_pinctrl\ndoc_and_source_for_drivers\\STM32MP157\\source\\A7\\06_Pinctrl\\01_virtual_pinctrl\n</code></pre> </li> </ul>"},{"location":"06_Pinctrl/07_1/#1-pinctrl","title":"1. \u200b\u56de\u987e\u200bPinctrl\u200b\u7684\u200b\u4e09\u5927\u200b\u4f5c\u7528","text":"<p>\u200b\u8bb0\u4f4f\u200bpinctrl\u200b\u7684\u200b\u4e09\u5927\u200b\u4f5c\u7528\u200b\uff0c\u200b\u6709\u52a9\u4e8e\u200b\u7406\u89e3\u200b\u6240\u200b\u6d89\u53ca\u200b\u7684\u200b\u6570\u636e\u7ed3\u6784\u200b\uff1a</p> <ul> <li>\u200b\u5f15\u811a\u200b\u679a\u4e3e\u200b\u4e0e\u200b\u547d\u540d\u200b(Enumerating and naming)</li> <li>\u200b\u5355\u4e2a\u200b\u5f15\u811a\u200b</li> <li>\u200b\u5404\u7ec4\u200b\u5f15\u811a\u200b</li> <li>\u200b\u5f15\u811a\u200b\u590d\u7528\u200b(Multiplexing)\uff1a\u200b\u6bd4\u5982\u200b\u7528\u4f5c\u200bGPIO\u3001I2C\u200b\u6216\u200b\u5176\u4ed6\u200b\u529f\u80fd\u200b</li> <li>\u200b\u5f15\u811a\u200b\u914d\u7f6e\u200b(Configuration)\uff1a\u200b\u6bd4\u5982\u200b\u4e0a\u62c9\u200b\u3001\u200b\u4e0b\u200b\u62c9\u200b\u3001open drain\u3001\u200b\u9a71\u52a8\u200b\u5f3a\u5ea6\u200b\u7b49\u200b</li> </ul> <p>Pinctrl\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u7684\u200b\u6838\u5fc3\u200b\u662f\u200b\u6784\u9020\u200b\u4e00\u4e2a\u200bpinctrl_desc\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff1a</p> <p></p>"},{"location":"06_Pinctrl/07_1/#11-1","title":"1.1 \u200b\u4f5c\u7528\u200b1\uff1a\u200b\u63cf\u8ff0\u200b\u3001\u200b\u83b7\u5f97\u200b\u5f15\u811a","text":"<p>\u200b\u5206\u4e3a\u200b2\u200b\u90e8\u5206\u200b\uff1a</p> <ul> <li>\u200b\u63cf\u8ff0\u200b\u3001\u200b\u83b7\u5f97\u200b\u5355\u4e2a\u200b\u5f15\u811a\u200b\u7684\u200b\u4fe1\u606f\u200b</li> <li>\u200b\u63cf\u8ff0\u200b\u3001\u200b\u83b7\u5f97\u200b\u67d0\u7ec4\u200b\u5f15\u811a\u200b\u7684\u200b\u4fe1\u606f\u200b</li> </ul> <p></p>"},{"location":"06_Pinctrl/07_1/#12-2","title":"1.2 \u200b\u4f5c\u7528\u200b2\uff1a\u200b\u5f15\u811a\u200b\u590d\u7528","text":"<p>\u200b\u7528\u6765\u200b\u628a\u200b\u67d0\u7ec4\u200b\u5f15\u811a\u200b(group)\u200b\u590d\u7528\u200b\u4e3a\u200b\u67d0\u4e2a\u200b\u529f\u80fd\u200b(function)\u3002</p> <p></p>"},{"location":"06_Pinctrl/07_1/#13-3","title":"1.3 \u200b\u4f5c\u7528\u200b3\uff1a\u200b\u5f15\u811a\u200b\u914d\u7f6e","text":"<p>\u200b\u7528\u6765\u200b\u914d\u7f6e\u200b\uff1a\u200b\u67d0\u4e2a\u200b\u5f15\u811a\u200b(pin)\u200b\u6216\u200b\u67d0\u7ec4\u200b\u5f15\u811a\u200b(group)\u3002</p> <p></p>"},{"location":"06_Pinctrl/07_1/#2-pinctrl","title":"2. \u200b\u7f16\u5199\u200bPinctrl\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u8981\u200b\u505a\u200b\u4ec0\u4e48","text":"<p>\u200b\u6211\u4eec\u200b\u8981\u200b\u505a\u200b\u7684\u200b\u4e8b\u60c5\u200b\uff1a</p> <ul> <li>pin controller\uff1a</li> <li>\u200b\u521b\u5efa\u200b\u8bbe\u5907\u200b\u6811\u200b\u8282\u70b9\u200b</li> <li>\u200b\u7f16\u5199\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</li> <li>\u200b\u6d4b\u8bd5\u200b\uff1a</li> <li>\u200b\u521b\u5efa\u200bclient\u200b\u8bbe\u5907\u200b\u6811\u200b\u8282\u70b9\u200b</li> <li>\u200b\u7f16\u5199\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</li> </ul>"},{"location":"06_Pinctrl/07_1/#3","title":"3. \u200b\u786c\u4ef6\u200b\u529f\u80fd","text":"<p>\u200b\u5047\u8bbe\u200b\u8fd9\u4e2a\u200b\u865a\u62df\u200b\u7684\u200bpin controller\u200b\u6709\u200b4\u200b\u4e2a\u200b\u5f15\u811a\u200b\uff1a</p> <p></p> <ul> <li>pin0,1,2,3\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u914d\u7f6e\u200b\u4e3a\u200bGPIO\u200b\u529f\u80fd\u200b</li> <li>pin0,1\u200b\u8fd8\u200b\u53ef\u4ee5\u200b\u914d\u7f6e\u200b\u4e3a\u200bI2C\u200b\u529f\u80fd\u200b</li> <li>pin2,3\u200b\u8fd8\u200b\u53ef\u4ee5\u200b\u914d\u7f6e\u200b\u4e3a\u200bUART\u200b\u529f\u80fd\u200b</li> </ul>"},{"location":"06_Pinctrl/07_1/#4","title":"4. \u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6","text":"<pre><code>virtual_pincontroller {\n    compatible = \"100ask,virtual_pinctrl\";\n    i2cgrp: i2cgrp {\n            functions = \"i2c\", \"i2c\";\n            groups = \"pin0\", \"pin1\";\n            configs = &lt;0x11223344  0x55667788&gt;;\n    };\n};\n\nvirtual_i2c {\n    compatible = \"100ask,virtual_i2c\";\n    pinctrl-names = \"default\";\n    pinctrl-0 = &lt;&amp;i2cgrp&gt;;\n};\n</code></pre>"},{"location":"06_Pinctrl/07_1/#5-pinctrl","title":"5. \u200b\u7f16\u5199\u200bPinctrl\u200b\u9a71\u52a8\u7a0b\u5e8f","text":""},{"location":"06_Pinctrl/07_1/#51-pinctrl_desc","title":"5.1 \u200b\u6838\u5fc3\u200b\uff1apinctrl_desc","text":"<ul> <li>\u200b\u5206\u914d\u200bpinctrl_desc\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> <li>\u200b\u8bbe\u7f6e\u200bpinctrl_desc\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> <li>\u200b\u6ce8\u518c\u200bpinctrl_desc\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> </ul>"},{"location":"06_Pinctrl/07_1/#52","title":"5.2 \u200b\u8f85\u52a9\u200b\u51fd\u6570","text":"<pre><code>include/linux/of.h\n    for_each_child_of_node\n    of_get_child_count\n    of_find_property\n    of_property_read_u32\n    of_property_read_u32_index\n    of_property_read_string_index\n</code></pre>"},{"location":"06_Pinctrl/07_1/#6-client","title":"6. \u200b\u7f16\u5199\u200b\u6d4b\u8bd5\u200b\u7528\u200b\u7684\u200bclient\u200b\u9a71\u52a8","text":"<p>\u200b\u7f16\u5199\u200b\u3001\u200b\u6ce8\u518c\u200b\u4e00\u4e2a\u200bplatform_driver\u200b\u5373\u53ef\u200b\u3002</p>"},{"location":"06_Pinctrl/08_1/","title":"08_\u200b\u8c03\u8bd5\u200b\u865a\u62df\u200b\u7684\u200bPinctrl\u200b\u9a71\u52a8\u7a0b\u5e8f","text":""},{"location":"06_Pinctrl/08_1/#pinctrl","title":"\u8c03\u8bd5\u200b\u865a\u62df\u200b\u7684\u200bPinctrl\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a * Linux 5.x\u200b\u5185\u6838\u200b   * Documentation\\devicetree\\bindings\\pinctrl\\pinctrl-bindings.txt   * arch/arm/boot/dts/stm32mp151.dtsi   * arch/arm/boot/dts/stm32mp157-100ask-pinctrl.dtsi   * arch/arm/boot/dts/stm32mp15xx-100ask.dtsi   * drivers\\pinctrl\\stm32\\pinctrl-stm32mp157.c   * drivers\\pinctrl\\stm32\\pinctrl-stm32.c</p> <ul> <li>Linux 4.x\u200b\u5185\u6838\u200b</li> <li>Documentation\\pinctrl.txt</li> <li>Documentation\\devicetree\\bindings\\pinctrl\\pinctrl-bindings.txt</li> <li>arch/arm/boot/dts/imx6ull-14x14-evk.dts</li> <li>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</li> <li>drivers\\pinctrl\\freescale\\pinctrl-imx6ul.c</li> <li> <p>drivers\\pinctrl\\freescale\\pinctrl-imx.c</p> </li> <li> <p>\u200b\u672c\u8bfe\u200b\u5bf9\u5e94\u200b\u7684\u200b\u6e90\u7801\u200b</p> </li> <li> <p>GIT\u200b\u4ed3\u5e93\u200b\u4e2d\u200b</p> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\source\\06_Pinctrl\\02_virtual_pinctrl_ok\ndoc_and_source_for_drivers\\STM32MP157\\source\\A7\\06_Pinctrl\\02_virtual_pinctrl_ok\n</code></pre> </li> </ul>"},{"location":"06_Pinctrl/08_1/#1","title":"1. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":""},{"location":"06_Pinctrl/08_1/#11","title":"1.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":""},{"location":"06_Pinctrl/08_1/#1-stm32mp157","title":"1. STM32MP157","text":"<p>\u200b\u6ce8\u610f\u200b\uff1a\u200b\u5bf9\u4e8e\u200bSTM32MP157\uff0c\u200b\u4ee5\u524d\u200b\u8bf4\u200b\u7f16\u8bd1\u200b\u5185\u6838\u200b/\u200b\u9a71\u52a8\u200b\u3001\u200b\u7f16\u8bd1\u200bAPP\u200b\u7684\u200b\u5de5\u5177\u200b\u94fe\u200b\u4e0d\u200b\u4e00\u6837\u200b\uff0c\u200b\u5176\u5b9e\u200b\u7f16\u8bd1\u200bAPP\u200b\u7528\u200b\u7684\u200b\u5de5\u5177\u200b\u94fe\u200b\u4e5f\u200b\u80fd\u200b\u7528\u6765\u200b\u7f16\u8bd1\u200b\u5185\u6838\u200b\u3002</p> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"06_Pinctrl/08_1/#2-imx6ull","title":"2. IMX6ULL","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre>"},{"location":"06_Pinctrl/08_1/#12","title":"1.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"06_Pinctrl/08_1/#1-stm32mp157_1","title":"1. STM32MP157","text":"<ul> <li> <p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dts</code>\uff0c\u200b\u6dfb\u52a0\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>/ {\n    virtual_pincontroller {\n        compatible = \"100ask,virtual_pinctrl\";\n        i2cgrp: i2cgrp {\n                functions = \"i2c\", \"i2c\";\n                groups = \"pin0\", \"pin1\";\n                configs = &lt;0x11223344  0x55667788&gt;;\n        };\n    };\n\n    virtual_i2c {\n        compatible = \"100ask,virtual_i2c\";\n        pinctrl-names = \"default\";\n        pinctrl-0 = &lt;&amp;i2cgrp&gt;;\n    };\n};\n</code></pre> </li> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bSTM32MP157\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <ul> <li>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.1.100)</li> </ul> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> <ul> <li>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.1.137</li> </ul> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u6811\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b\u54ea\u91cc\u200b</p> </li> </ul> <p>\u200b\u7531\u4e8e\u200b\u7248\u672c\u200b\u53d8\u5316\u200b\uff0cSTM32MP157\u200b\u5355\u677f\u200b\u4e0a\u200b\u70e7\u5f55\u200b\u7684\u200b\u7cfb\u7edf\u200b\u53ef\u80fd\u200b\u6709\u200b\u7ec6\u5fae\u5dee\u522b\u200b\u3002   \u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b<code>cat /proc/mounts</code>\u200b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u4e24\u79cd\u200b\u7ed3\u679c\u200b(\u200b\u89c1\u200b\u4e0b\u56fe\u200b)\uff1a</p> <ul> <li> <p>mmcblk2p2\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u5de6\u8fb9\u200b)\uff1a\u200b\u65e0\u9700\u200b\u7279\u6b8a\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u4e0b\u9762\u200b\u628a\u200b\u6587\u4ef6\u200b\u590d\u5236\u5230\u200b/boot\u200b\u76ee\u5f55\u200b\u5373\u53ef\u200b</p> </li> <li> <p>mmcblk2p2\u200b\u6302\u8f7d\u200b\u5728\u200b/mnt\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u53f3\u8fb9\u200b)</p> <ul> <li>\u200b\u5728\u200b\u89c6\u9891\u200b\u91cc\u200b\u3001\u200b\u540e\u9762\u200b\u6587\u6863\u200b\u91cc\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u66f4\u65b0\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u7684\u200b\u6587\u4ef6\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8981\u200b\u5148\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u91cd\u65b0\u200b\u6302\u8f7d\u200b\uff1a</li> <li><code>mount  /dev/mmcblk2p2  /boot</code></li> </ul> <p></p> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/stm32mp157c-100ask-512d-lcd-v1.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"06_Pinctrl/08_1/#2-imx6ull_1","title":"2. IMX6ULL","text":"<ul> <li> <p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code>\uff0c\u200b\u6dfb\u52a0\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>/ {\n    virtual_pincontroller {\n        compatible = \"100ask,virtual_pinctrl\";\n        i2cgrp: i2cgrp {\n                functions = \"i2c\", \"i2c\";\n                groups = \"pin0\", \"pin1\";\n                configs = &lt;0x11223344  0x55667788&gt;;\n        };\n    };\n\n    virtual_i2c {\n        compatible = \"100ask,virtual_i2c\";\n        pinctrl-names = \"default\";\n        pinctrl-0 = &lt;&amp;i2cgrp&gt;;\n    };\n};\n</code></pre> </li> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bIMX6ULL\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/100ask_imx6ull-14x14.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.1.100)</p> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.1.137</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/100ask_imx6ull-14x14.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"06_Pinctrl/08_1/#13","title":"1.3 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u5b89\u88c5\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\uff1a</p> </li> <li> <p>\u200b\u5728\u200bUbuntu\u200b\u4e0a\u200b</p> </li> <li> <p>\u200b\u4fee\u6539\u200b<code>02_virtual_pinctrl_ok</code>\u200b\u4e2d\u200b\u7684\u200bMakefile\uff0c\u200b\u6307\u5b9a\u200b\u5185\u6838\u200b\u8def\u5f84\u200b<code>KERN_DIR</code>\uff0c\u200b\u5728\u200b\u6267\u884c\u200b<code>make</code>\u200b\u547d\u4ee4\u200b\u5373\u53ef\u200b\u3002</p> </li> <li> <p>\u200b\u5b89\u88c5\u200b\uff1a</p> </li> <li> <p>\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b</p> </li> <li> <p>\u200b\u6302\u8f7d\u200bNFS\uff0c\u200b\u590d\u5236\u200b\u6587\u4ef6\u200b\uff0cinsmod\uff0c\u200b\u7c7b\u4f3c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b\uff1a</p> <p><pre><code>mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n// \u200b\u5bf9\u4e8e\u200bIMX6ULL\uff0c\u200b\u60f3\u200b\u770b\u5230\u200b\u9a71\u52a8\u200b\u6253\u5370\u4fe1\u606f\u200b\uff0c\u200b\u9700\u8981\u200b\u5148\u200b\u6267\u884c\u200b\necho \"7 4 1 7\" &gt; /proc/sys/kernel/printk\n\ninsmod -f /mnt/virtual_pinctrl_driver.ko\ninsmod -f /mnt/virtual_pinctrl_client.ko\n</code></pre> * \u200b\u89c2\u5bdf\u200b\u5185\u6838\u200b\u6253\u5370\u200b\u7684\u200b\u4fe1\u606f\u200b</p> </li> </ul>"},{"location":"06_Pinctrl/08_1/#2-pinctrl","title":"2. Pinctrl\u200b\u8c03\u8bd5\u4fe1\u606f","text":"<p>\u200b\u5f00\u53d1\u677f\u200b\u7684\u200b<code>/sys/kernel/debug/pinctrl/</code>\u200b\u76ee\u5f55\u200b\u4e0b\u200b\uff0c\u200b\u6bcf\u200b\u4e00\u4e2a\u200bpin controller\u200b\u90fd\u200b\u6709\u200b\u4e00\u4e2a\u200b\u76ee\u5f55\u200b\uff0c\u200b\u6bd4\u5982\u200bvirtual_pincontroller\u3002 \u200b\u91cc\u9762\u200b\u6709\u200b\u5f88\u591a\u200b\u6587\u4ef6\u200b\uff0c\u200b\u4f5c\u7528\u200b\u5982\u4e0b\u200b\uff1a</p> Pinctrl\u200b\u7684\u200b\u865a\u62df\u200b\u6587\u4ef6\u200b \u200b\u4f5c\u7528\u200b \u200b\u89e3\u91ca\u200b pins \u200b\u5355\u4e2a\u200b\u5f15\u811a\u200b\u4fe1\u606f\u200b pingroups \u200b\u5f15\u811a\u200b\u7684\u200b\u7ec4\u200b\u4fe1\u606f\u200b pinmux-pins \u200b\u5355\u4e2a\u200b\u5f15\u811a\u200b\u7684\u200b\u590d\u7528\u200b\u4fe1\u606f\u200b pinmux-functions function\u200b\u4e0b\u200b\u7684\u200bgroup(\u200b\u652f\u6301\u200b\u8be5\u200bfunction\u200b\u7684\u200bgroup) pinconf-pins \u200b\u5355\u4e2a\u200b\u5f15\u811a\u200b\u7684\u200b\u914d\u7f6e\u200b pinconf-groups \u200b\u5f15\u811a\u200b\u7ec4\u200b\u7684\u200b\u914d\u7f6e\u200b pinconf-config \u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200b\u5199\u200b\u5b83\u200b\u4fee\u6539\u200b\u6307\u5b9a\u200b\u8bbe\u5907\u200b\u3001\u200b\u6307\u5b9a\u200b\u72b6\u6001\u200b\u4e0b\u200b\u3001\u200b\u6307\u5b9a\u200b(\u200b\u7ec4\u200b)\u200b\u5f15\u811a\u200b\u7684\u200bconfig\u200b\u503c\u200b <ul> <li>\u200b\u5355\u4e2a\u200b\u5f15\u811a\u200b\u4fe1\u606f\u200b</li> </ul> <pre><code>cat /sys/kernel/debug/pinctrl/virtual_pincontroller/pins\nregistered pins: 4\npin 0 (pin0) virtual_pincontroller\npin 1 (pin1) virtual_pincontroller\npin 2 (pin2) virtual_pincontroller\npin 3 (pin3) virtual_pincontroller\n</code></pre> <ul> <li>\u200b\u5f15\u811a\u200b\u7684\u200b\u7ec4\u200b\u4fe1\u606f\u200b</li> </ul> <pre><code>cat /sys/kernel/debug/pinctrl/virtual_pincontroller/pingroups\nregistered pin groups:\ngroup: pin0\npin 0 (pin0)\n\ngroup: pin1\npin 1 (pin1)\n\ngroup: pin2\npin 2 (pin2)\n\ngroup: pin3\npin 3 (pin3)\n</code></pre> <ul> <li>\u200b\u5355\u4e2a\u200b\u5f15\u811a\u200b\u7684\u200b\u590d\u7528\u200b\u4fe1\u606f\u200b</li> </ul> <pre><code>cat /sys/kernel/debug/pinctrl/virtual_pincontroller/pinmux-pins\nPinmux settings per pin\nFormat: pin (name): mux_owner gpio_owner hog?\npin 0 (pin0): virtual_i2c (GPIO UNCLAIMED) function i2c group pin0\npin 1 (pin1): virtual_i2c (GPIO UNCLAIMED) function i2c group pin1\npin 2 (pin2): (MUX UNCLAIMED) (GPIO UNCLAIMED)\npin 3 (pin3): (MUX UNCLAIMED) (GPIO UNCLAIMED)\n</code></pre> <ul> <li>function\u200b\u4e0b\u200b\u7684\u200bgroup(\u200b\u652f\u6301\u200b\u8be5\u200bfunction\u200b\u7684\u200bgroup)</li> </ul> <pre><code>cat /sys/kernel/debug/pinctrl/virtual_pincontroller/pinmux-functions\nfunction: gpio, groups = [ pin0 pin1 pin2 pin3 ]\nfunction: i2c, groups = [ pin0 pin1 ]\nfunction: uart, groups = [ pin2 pin3 ]\n</code></pre> <ul> <li>\u200b\u5355\u4e2a\u200b\u5f15\u811a\u200b\u7684\u200b\u914d\u7f6e\u200b</li> </ul> <pre><code>cat /sys/kernel/debug/pinctrl/virtual_pincontroller/pinconf-pins\nPin config settings per pin\nFormat: pin (name): configs\npin 0 (pin0): 0x11223344\npin 1 (pin1): 0x55667788\npin 2 (pin2): 0x0\npin 3 (pin3): 0x0\n</code></pre> <ul> <li>\u200b\u5f15\u811a\u200b\u7ec4\u200b\u7684\u200b\u914d\u7f6e\u200b</li> </ul> <pre><code>cat /sys/kernel/debug/pinctrl/virtual_pincontroller/pinconf-groups\nPin config settings per pin group\nFormat: group (name): configs\n0 (pin0): 0x11223344\n1 (pin1): 0x55667788\n2 (pin2): 0x0\n3 (pin3): 0x0\n</code></pre> <ul> <li>\u200b\u4fee\u6539\u200b\u914d\u7f6e\u200b\u503c\u200b   \u200b\u5185\u6838\u200b\u6e90\u7801\u200b\uff1a   <pre><code>drivers\\pinctrl\\pinconf.c\n    pinconf_dbg_config_write\n</code></pre></li> </ul> <p>\u200b\u5982\u679c\u200bpin controller\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e2d\u200b\u7684\u200bpinconf_ops\u200b\u63d0\u4f9b\u200b\u4e86\u200bpin_config_dbg_parse_modify\u200b\u51fd\u6570\u200b\uff0c \u200b\u5c31\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200b<code>pinconf-config</code>\u200b\u6587\u4ef6\u200b\u4fee\u6539\u200b\u67d0\u4e2a\u200bpin\u200b\u6216\u200b\u67d0\u4e2a\u200bgroup\u200b\u7684\u200b\u914d\u7f6e\u200b\u503c\u200b\u3002</p> <pre><code>// \u200b\u683c\u5f0f\u200b: modify &lt;config&gt; &lt;devicename&gt; &lt;state&gt; &lt;pin_name|group_name&gt; &lt;newvalue&gt;\necho \"modify config_pin virtual_i2c default pin0 0xaabb\" &gt; /sys/kernel/debug/pinctrl/virtual_pincontroller/pinconf-config\n\ncat /sys/kernel/debug/pinctrl/virtual_pincontroller/pinconf-config\n</code></pre>"},{"location":"07_GPIO/01_1/","title":"01_GPIO\u200b\u5b50\u7cfb\u7edf\u200b\u89c6\u9891\u200b\u4ecb\u7ecd","text":""},{"location":"07_GPIO/01_1/#gpio","title":"GPIO\u200b\u5b50\u7cfb\u7edf\u200b\u89c6\u9891\u200b\u4ecb\u7ecd","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux 5.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Linux-5.4\\Documentation\\driver-api</li> <li>Linux-5.4\\Documentation\\devicetree\\bindings\\gpio\\gpio.txt</li> <li>Linux 4.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Linux-4.9.88\\Documentation\\gpio</li> <li>Linux-4.9.88\\Documentation\\devicetree\\bindings\\gpio\\gpio.txt</li> </ul>"},{"location":"07_GPIO/01_1/#1-gpio","title":"1. GPIO\u200b\u5b50\u7cfb\u7edf\u200b\u7684\u200b\u4f5c\u7528","text":"<p>\u200b\u82af\u7247\u200b\u5185\u90e8\u200b\u6709\u200b\u5f88\u591a\u200b\u5f15\u811a\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u5f15\u811a\u200b\u53ef\u4ee5\u200b\u63a5\u5230\u200bGPIO\u200b\u6a21\u5757\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u63a5\u5230\u200bI2C\u200b\u7b49\u200b\u6a21\u5757\u200b\u3002</p> <p>\u200b\u901a\u8fc7\u200bPinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u6765\u200b\u9009\u62e9\u200b\u5f15\u811a\u200b\u7684\u200b\u529f\u80fd\u200b(mux function)\u3001\u200b\u914d\u7f6e\u200b\u5f15\u811a\u200b\uff1a</p> <p></p> <p>\u200b\u5f53\u200b\u4e00\u4e2a\u200b\u5f15\u811a\u200b\u88ab\u200b\u590d\u7528\u200b\u4e3a\u200bGPIO\u200b\u529f\u80fd\u200b\u65f6\u200b\uff0c\u200b\u6211\u4eec\u200b\u53ef\u4ee5\u200b\u53bb\u200b\u8bbe\u7f6e\u200b\u5b83\u200b\u7684\u200b\u65b9\u5411\u200b\u3001\u200b\u8bbe\u7f6e\u200b/\u200b\u8bfb\u53d6\u200b\u5b83\u200b\u7684\u200b\u503c\u200b\u3002</p> <p>GPIO\u200b\u540d\u4e3a\u200b\"General Purpose Input/Output\"\uff0c\u200b\u901a\u7528\u200b\u76ee\u7684\u200b\u8f93\u5165\u200b/\u200b\u8f93\u51fa\u200b\uff0c\u200b\u5c31\u662f\u200b\u5e38\u7528\u200b\u7684\u200b\u5f15\u811a\u200b\u3002</p> <p>GPIO\u200b\u53ef\u80fd\u200b\u662f\u200b\u82af\u7247\u200b\u81ea\u5e26\u200b\u7684\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u80fd\u200b\u901a\u8fc7\u200bI2C\u3001SPI\u200b\u63a5\u53e3\u200b\u6269\u5c55\u200b\uff1a</p> <p></p> <p>GPIO\u200b\u6709\u200b\u4e00\u4e9b\u200b\u901a\u7528\u200b\u529f\u80fd\u200b\u3001\u200b\u901a\u7528\u200b\u5c5e\u6027\u200b\u3002</p>"},{"location":"07_GPIO/01_1/#11","title":"1.1 \u200b\u901a\u7528\u200b\u529f\u80fd","text":"<ul> <li>\u200b\u53ef\u4ee5\u200b\u8bbe\u200b\u4e3a\u200b\u8f93\u51fa\u200b\uff1a\u200b\u8ba9\u200b\u5b83\u200b\u8f93\u51fa\u200b\u9ad8\u200b\u4f4e\u7535\u5e73\u200b\uff1b</li> <li>\u200b\u53ef\u4ee5\u200b\u8bbe\u200b\u4e3a\u200b\u8f93\u5165\u200b\uff0c\u200b\u8bfb\u53d6\u200b\u5f15\u811a\u200b\u5f53\u524d\u200b\u7535\u5e73\u200b\uff1b</li> <li>\u200b\u53ef\u4ee5\u200b\u7528\u6765\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b</li> </ul> <p>\u200b\u5bf9\u4e8e\u200b\u82af\u7247\u200b\u81ea\u5e26\u200b\u7684\u200bGPIO\uff0c\u200b\u5b83\u200b\u7684\u200b\u8bbf\u95ee\u200b\u65f6\u200b\u5f88\u5feb\u200b\u7684\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5728\u200b\u83b7\u5f97\u200bspinlocks\u200b\u7684\u200b\u60c5\u51b5\u200b\u4e0b\u200b\u64cd\u4f5c\u200b\u5b83\u200b\u3002</p> <p>\u200b\u4f46\u662f\u200b\uff0c\u200b\u5bf9\u4e8e\u200b\u901a\u8fc7\u200bI2C\u3001SPI\u200b\u7b49\u200b\u63a5\u53e3\u200b\u6269\u5c55\u200b\u7684\u200bGPIO\uff0c\u200b\u8bbf\u95ee\u200b\u5b83\u4eec\u200b\u65f6\u200b\u53ef\u80fd\u200b\u5bfc\u81f4\u200b\u4f11\u7720\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8fd9\u4e9b\u200b\"GPIO Expander\"\u200b\u5c31\u200b\u4e0d\u80fd\u200b\u5728\u200b\u83b7\u5f97\u200bspinlocks\u200b\u7684\u200b\u60c5\u51b5\u200b\u4e0b\u200b\u4f7f\u7528\u200b\u3002</p>"},{"location":"07_GPIO/01_1/#12","title":"1.2 \u200b\u901a\u7528\u200b\u5c5e\u6027","text":"<ul> <li>Active-High and Active-Low</li> </ul> <p>\u200b\u4ee5\u200bLED\u200b\u4e3a\u4f8b\u200b\uff0c\u200b\u9700\u8981\u200b\u8bbe\u7f6e\u200bGPIO\u200b\u7535\u5e73\u200b\u3002\u200b\u4f46\u662f\u200b\u6709\u4e9b\u200b\u7535\u8def\u200b\u53ef\u80fd\u200b\u662f\u200b\u9ad8\u7535\u5e73\u200b\u70b9\u4eae\u200bLED\uff0c\u200b\u6709\u4e9b\u200b\u662f\u200b\u4f4e\u7535\u5e73\u200b\u70b9\u4eae\u200bLED\u3002</p> <p>\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>gpiod_set_value(gpio, 1);  // \u200b\u8f93\u51fa\u200b\u9ad8\u7535\u5e73\u200b\u70b9\u4eae\u200bLED\ngpiod_set_value(gpio, 0);  // \u200b\u8f93\u51fa\u200b\u4f4e\u7535\u5e73\u200b\u70b9\u4eae\u200bLED\n</code></pre> <p>\u200b\u5bf9\u5e94\u200b\u540c\u4e00\u4e2a\u200b\u76ee\u6807\u200b\uff1a\u200b\u70b9\u4eae\u200bLED\uff0c\u200b\u5bf9\u4e8e\u200b\u4e0d\u540c\u200b\u7684\u200bLED\uff0c\u200b\u5c31\u200b\u9700\u8981\u200b\u4e0d\u540c\u200b\u7684\u200b\u4ee3\u7801\u200b\uff0c\u200b\u539f\u56e0\u200b\u5728\u4e8e\u200b\u4e0a\u9762\u200b\u7684\u200b\u4ee3\u7801\u200b\u4e2d\u200b1\u30010\u200b\u8868\u793a\u200b\u7684\u200b\u662f\u200b\"\u200b\u7269\u7406\u200b\u503c\u200b\"\u3002</p> <p>\u200b\u5982\u679c\u200b\u80fd\u200b\u4f7f\u7528\u200b\"\u200b\u903b\u8f91\u503c\u200b\"\uff0c\u200b\u540c\u6837\u200b\u7684\u200b\u903b\u8f91\u503c\u200b\u5728\u200b\u4e0d\u540c\u200b\u7684\u200b\u914d\u7f6e\u200b\u4e0b\u200b\u8f93\u51fa\u200b\u5bf9\u5e94\u200b\u7684\u200b\u7269\u7406\u200b\u503c\u200b\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u4fdd\u6301\u200b\u4ee3\u7801\u200b\u4e00\u81f4\u200b\uff0c\u200b\u6bd4\u5982\u200b\uff1a</p> <pre><code>gpiod_set_value(gpio, 1);  // \u200b\u8f93\u51fa\u200b\u903b\u8f91\u200b1\n                           // \u200b\u5728\u200bActive-High\u200b\u7684\u200b\u60c5\u51b5\u200b\u4e0b\u200b\u5b83\u200b\u4f1a\u200b\u8f93\u51fa\u200b\u9ad8\u7535\u5e73\u200b\n                           // \u200b\u5728\u200bActive-Low\u200b\u7684\u200b\u60c5\u51b5\u200b\u4e0b\u200b\u5b83\u200b\u4f1a\u200b\u8f93\u51fa\u200b\u4f4e\u7535\u5e73\u200b\n</code></pre> <ul> <li>Open Drain and Open Source</li> </ul> <p>\u200b\u6709\u200b\u591a\u4e2a\u200bGPIO\u200b\u9a71\u52a8\u200b\u540c\u65f6\u200b\u9a71\u52a8\u200b\u4e00\u4e2a\u200b\u7535\u8def\u200b\u65f6\u200b\uff0c\u200b\u5c31\u200b\u9700\u8981\u200b\u8bbe\u7f6e\u200bOpen Drain\u200b\u6216\u200bOpen Source\u3002</p> <ul> <li>Open Drain\uff1a\u200b\u5f15\u811a\u200b\u88ab\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b\u4f4e\u7535\u5e73\u200b\u65f6\u624d\u200b\u4f1a\u200b\u9a71\u52a8\u200b\u7535\u8def\u200b\uff0c\u200b\u5178\u578b\u200b\u573a\u666f\u200b\u662f\u200bI2C\u200b\u63a5\u53e3\u200b\u3002</li> <li>Open Source\uff1a\u200b\u5f15\u811a\u200b\u88ab\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b\u9ad8\u7535\u5e73\u200b\u65f6\u624d\u200b\u4f1a\u200b\u9a71\u52a8\u200b\u7535\u8def\u200b</li> </ul>"},{"location":"07_GPIO/01_1/#13-gpio","title":"1.3 GPIO\u200b\u5b50\u7cfb\u7edf\u200b\u7684\u200b\u4f5c\u7528","text":"<p>\u200b\u7ba1\u7406\u200bGPIO\uff0c\u200b\u65e2\u200b\u80fd\u200b\u652f\u6301\u200b\u82af\u7247\u200b\u672c\u8eab\u200b\u7684\u200bGPIO\uff0c\u200b\u4e5f\u200b\u80fd\u200b\u652f\u6301\u200b\u6269\u5c55\u200b\u7684\u200bGPIO\u3002</p> <p>\u200b\u63d0\u4f9b\u200b\u7edf\u4e00\u200b\u7684\u200b\u3001\u200b\u7b80\u4fbf\u200b\u7684\u200b\u8bbf\u95ee\u200b\u63a5\u53e3\u200b\uff0c\u200b\u5b9e\u73b0\u200b\uff1a\u200b\u8f93\u5165\u200b\u3001\u200b\u8f93\u51fa\u200b\u3001\u200b\u4e2d\u65ad\u200b\u3002</p>"},{"location":"07_GPIO/01_1/#2","title":"2. \u200b\u9884\u8ba1\u200b\u5f55\u5236\u200b\u7684\u200b\u5185\u5bb9","text":"<ul> <li>\u200b\u4f7f\u7528\u200bGPIO\u200b\u5b50\u7cfb\u7edf\u200b\u8981\u200b\u638c\u63e1\u200b\u7684\u200b\u91cd\u8981\u200b\u6982\u5ff5\u200b</li> <li>\u200b\u57fa\u4e8e\u200bGPIO\u200b\u5b50\u7cfb\u7edf\u200b\u7684\u200bLED\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</li> <li>LED\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e0a\u673a\u200b\u5b9e\u9a8c\u200b(\u200b\u5206\u4e3a\u200b\u591a\u4e2a\u200b\u5355\u677f\u200b)</li> <li>GPIO\u200b\u5b50\u7cfb\u7edf\u200b\u5c42\u6b21\u200b\u4e0e\u200b\u6570\u636e\u7ed3\u6784\u200b</li> <li>\u200b\u5177\u4f53\u200b\u5355\u677f\u200b\u4e0a\u200bGPIO\u200b\u5b50\u7cfb\u7edf\u200b\u6e90\u7801\u200b\u5206\u6790\u200b(\u200b\u5206\u4e3a\u200b\u591a\u4e2a\u200b\u5355\u677f\u200b)</li> <li>\u200b\u7f16\u5199\u200b\u4e00\u4e2a\u200bGPIO\u200b\u6269\u5c55\u200b\u82af\u7247\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</li> <li>GPIO\u200b\u5b50\u7cfb\u7edf\u200b\u4e0e\u200bPinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u7684\u200b\u4ea4\u4e92\u200b</li> <li>GPIO\u200b\u5b50\u7cfb\u7edf\u200b\u7684\u200bsysfs\u200b\u63a5\u53e3\u200b</li> </ul>"},{"location":"07_GPIO/05_1/","title":"02_GPIO\u200b\u5b50\u7cfb\u7edf\u200b\u5c42\u6b21\u200b\u4e0e\u200b\u6570\u636e\u7ed3\u6784","text":""},{"location":"07_GPIO/05_1/#gpio","title":"GPIO\u200b\u5b50\u7cfb\u7edf\u200b\u5c42\u6b21\u200b\u4e0e\u200b\u6570\u636e\u7ed3\u6784","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux 5.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Linux-5.4\\Documentation\\driver-api</li> <li>Linux-5.4\\Documentation\\devicetree\\bindings\\gpio\\gpio.txt</li> <li>Linux-5.4\\drivers\\gpio\\gpio-74x164.c</li> <li>Linux 4.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Linux-4.9.88\\Documentation\\gpio</li> <li>Linux-4.9.88\\Documentation\\devicetree\\bindings\\gpio\\gpio.txt</li> <li>Linux-4.9.88\\drivers\\gpio\\gpio-74x164.c</li> </ul>"},{"location":"07_GPIO/05_1/#1-gpio","title":"1. GPIO\u200b\u5b50\u7cfb\u7edf\u200b\u7684\u200b\u5c42\u6b21","text":""},{"location":"07_GPIO/05_1/#11","title":"1.1 \u200b\u5c42\u6b21","text":""},{"location":"07_GPIO/05_1/#12-gpiolib","title":"1.2 GPIOLIB\u200b\u5411\u4e0a\u200b\u63d0\u4f9b\u200b\u7684\u200b\u63a5\u53e3","text":"descriptor-based legacy \u200b\u8bf4\u660e\u200b \u200b\u83b7\u5f97\u200bGPIO gpiod_get gpio_request gpiod_get_index gpiod_get_array gpio_request_array devm_gpiod_get devm_gpiod_get_index devm_gpiod_get_array \u200b\u8bbe\u7f6e\u200b\u65b9\u5411\u200b gpiod_direction_input gpio_direction_input gpiod_direction_output gpio_direction_output \u200b\u8bfb\u503c\u200b\u3001\u200b\u5199\u503c\u200b gpiod_get_value gpio_get_value gpiod_set_value gpio_set_value \u200b\u91ca\u653e\u200bGPIO gpio_free gpio_free gpiod_put gpio_free_array gpiod_put_array devm_gpiod_put devm_gpiod_put_array"},{"location":"07_GPIO/05_1/#13-gpiolib","title":"1.3 GPIOLIB\u200b\u5411\u4e0b\u200b\u63d0\u4f9b\u200b\u7684\u200b\u63a5\u53e3","text":""},{"location":"07_GPIO/05_1/#2-3","title":"2. \u200b\u91cd\u8981\u200b\u7684\u200b3\u200b\u4e2a\u200b\u6838\u5fc3\u200b\u6570\u636e\u7ed3\u6784","text":"<p>\u200b\u8bb0\u4f4f\u200bGPIO Controller\u200b\u7684\u200b\u8981\u7d20\u200b\uff0c\u200b\u8fd9\u200b\u6709\u52a9\u4e8e\u200b\u7406\u89e3\u200b\u5b83\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff1a</p> <ul> <li>\u200b\u4e00\u4e2a\u200bGPIO Controller\u200b\u91cc\u200b\u6709\u200b\u591a\u5c11\u200b\u4e2a\u200b\u5f15\u811a\u200b\uff1f\u200b\u6709\u200b\u54ea\u4e9b\u200b\u5f15\u811a\u200b\uff1f</li> <li>\u200b\u9700\u8981\u200b\u63d0\u4f9b\u200b\u51fd\u6570\u200b\uff0c\u200b\u8bbe\u7f6e\u200b\u5f15\u811a\u200b\u65b9\u5411\u200b\u3001\u200b\u8bfb\u53d6\u200b/\u200b\u8bbe\u7f6e\u200b\u6570\u503c\u200b</li> <li>\u200b\u9700\u8981\u200b\u63d0\u4f9b\u200b\u51fd\u6570\u200b\uff0c\u200b\u628a\u200b\u5f15\u811a\u200b\u8f6c\u6362\u200b\u4e3a\u200b\u4e2d\u65ad\u200b</li> </ul> <p>\u200b\u4ee5\u200bLinux\u200b\u9762\u5411\u5bf9\u8c61\u7f16\u7a0b\u200b\u7684\u200b\u601d\u60f3\u200b\uff0c\u200b\u4e00\u4e2a\u200bGPIO Controller\u200b\u5fc5\u5b9a\u4f1a\u200b\u4f7f\u7528\u200b\u4e00\u4e2a\u200b\u7ed3\u6784\u200b\u4f53\u6765\u200b\u8868\u793a\u200b\uff0c\u200b\u8fd9\u4e2a\u200b\u7ed3\u6784\u200b\u4f53\u200b\u5fc5\u5b9a\u200b\u542b\u6709\u200b\u8fd9\u4e9b\u200b\u4fe1\u606f\u200b\uff1a</p> <ul> <li>GPIO\u200b\u5f15\u811a\u200b\u4fe1\u606f\u200b</li> <li>\u200b\u63a7\u5236\u200b\u5f15\u811a\u200b\u7684\u200b\u51fd\u6570\u200b</li> <li>\u200b\u4e2d\u65ad\u200b\u76f8\u5173\u200b\u7684\u200b\u51fd\u6570\u200b</li> </ul>"},{"location":"07_GPIO/05_1/#21-gpio_device","title":"2.1 gpio_device","text":"<p>\u200b\u6bcf\u4e2a\u200bGPIO Controller\u200b\u7528\u200b\u4e00\u4e2a\u200bgpio_device\u200b\u6765\u200b\u8868\u793a\u200b\uff1a</p> <ul> <li>\u200b\u91cc\u9762\u200b\u6bcf\u200b\u4e00\u4e2a\u200bgpio\u200b\u5f15\u811a\u200b\u7528\u200b\u4e00\u4e2a\u200bgpio_desc\u200b\u6765\u200b\u8868\u793a\u200b</li> <li>gpio\u200b\u5f15\u811a\u200b\u7684\u200b\u51fd\u6570\u200b(\u200b\u5f15\u811a\u200b\u63a7\u5236\u200b\u3001\u200b\u4e2d\u65ad\u200b\u76f8\u5173\u200b)\uff0c\u200b\u90fd\u200b\u653e\u5728\u200bgpio_chip\u200b\u91cc\u200b</li> </ul> <p></p>"},{"location":"07_GPIO/05_1/#22-gpio_chip","title":"2.2 gpio_chip","text":"<p>\u200b\u6211\u4eec\u200b\u5e76\u4e0d\u9700\u8981\u200b\u81ea\u5df1\u200b\u521b\u5efa\u200bgpio_device\uff0c\u200b\u7f16\u5199\u200b\u9a71\u52a8\u200b\u65f6\u8981\u200b\u521b\u5efa\u200b\u7684\u200b\u662f\u200bgpio_chip\uff0c\u200b\u91cc\u9762\u200b\u63d0\u4f9b\u200b\u4e86\u200b\uff1a</p> <ul> <li>\u200b\u63a7\u5236\u200b\u5f15\u811a\u200b\u7684\u200b\u51fd\u6570\u200b</li> <li>\u200b\u4e2d\u65ad\u200b\u76f8\u5173\u200b\u7684\u200b\u51fd\u6570\u200b</li> <li>\u200b\u5f15\u811a\u200b\u4fe1\u606f\u200b\uff1a\u200b\u652f\u6301\u200b\u591a\u5c11\u200b\u4e2a\u200b\u5f15\u811a\u200b\uff1f\u200b\u5404\u4e2a\u200b\u5f15\u811a\u200b\u7684\u200b\u540d\u5b57\u200b\uff1f</li> </ul> <p></p>"},{"location":"07_GPIO/05_1/#23-gpio_desc","title":"2.3 gpio_desc","text":"<p>\u200b\u6211\u4eec\u200b\u53bb\u200b\u4f7f\u7528\u200bGPIO\u200b\u5b50\u7cfb\u7edf\u200b\u65f6\u200b\uff0c\u200b\u9996\u5148\u200b\u662f\u200b\u83b7\u5f97\u200b\u67d0\u4e2a\u200b\u5f15\u811a\u200b\u5bf9\u5e94\u200b\u7684\u200bgpio_desc\u3002</p> <p>gpio_device\u200b\u8868\u793a\u200b\u4e00\u4e2a\u200bGPIO Controller\uff0c\u200b\u91cc\u9762\u200b\u652f\u6301\u200b\u591a\u4e2a\u200bGPIO\u3002</p> <p>\u200b\u5728\u200bgpio_device\u200b\u4e2d\u6709\u200b\u4e00\u4e2a\u200bgpio_desc\u200b\u6570\u7ec4\u200b\uff0c\u200b\u6bcf\u4e00\u200b\u5f15\u811a\u200b\u6709\u200b\u4e00\u9879\u200bgpio_desc\u3002</p> <p></p>"},{"location":"07_GPIO/05_1/#3-gpio-controller","title":"3. \u200b\u600e\u4e48\u200b\u7f16\u5199\u200bGPIO Controller\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>\u200b\u5206\u914d\u200b\u3001\u200b\u8bbe\u7f6e\u200b\u3001\u200b\u6ce8\u518c\u200bgpioc_chip\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u793a\u4f8b\u200b\uff1a<code>drivers\\gpio\\gpio-74x164.c</code></p> <p></p>"},{"location":"07_GPIO/06_1/","title":"03_IMX6ULL\u200b\u7684\u200bGPIO\u200b\u9a71\u52a8\u200b\u6e90\u7801\u200b\u5206\u6790","text":""},{"location":"07_GPIO/06_1/#imx6ullgpio","title":"IMX6ULL\u200b\u7684\u200bGPIO\u200b\u9a71\u52a8\u200b\u6e90\u7801\u200b\u5206\u6790","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux 4.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Linux-4.9.88\\Documentation\\gpio</li> <li>Linux-4.9.88\\Documentation\\devicetree\\bindings\\gpio\\gpio.txt</li> <li>Linux-4.9.88\\drivers\\gpio\\gpio-mxc.c</li> <li>Linux-4.9.88\\arch\\arm\\boot\\dts\\imx6ull.dtsi</li> </ul>"},{"location":"07_GPIO/06_1/#1","title":"1. \u200b\u8bbe\u5907\u200b\u6811","text":"<p>Linux-4.9.88\\arch\\arm\\boot\\dts\\imx6ull.dtsi\uff1a</p> <pre><code>aliases {\n        can0 = &amp;flexcan1;\n        can1 = &amp;flexcan2;\n        ethernet0 = &amp;fec1;\n        ethernet1 = &amp;fec2;\n        gpio0 = &amp;gpio1;\n};\n\ngpio1: gpio@0209c000 {\n        compatible = \"fsl,imx6ul-gpio\", \"fsl,imx35-gpio\";\n        reg = &lt;0x0209c000 0x4000&gt;;\n        interrupts = &lt;GIC_SPI 66 IRQ_TYPE_LEVEL_HIGH&gt;,\n                     &lt;GIC_SPI 67 IRQ_TYPE_LEVEL_HIGH&gt;;\n        gpio-controller;\n        #gpio-cells = &lt;2&gt;;\n        interrupt-controller;\n        #interrupt-cells = &lt;2&gt;;\n};\n</code></pre> <p>GPIO\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\uff0c\u200b\u6709\u200b\u4e24\u9879\u200b\u662f\u200b\u5fc5\u987b\u200b\u7684\u200b\uff1a</p> <ul> <li>gpio-controller : \u200b\u8868\u660e\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200bGPIO\u200b\u63a7\u5236\u5668\u200b</li> <li>gpio-cells : \u200b\u6307\u5b9a\u200b\u4f7f\u7528\u200b\u591a\u5c11\u200b\u4e2a\u200bcell(\u200b\u5c31\u662f\u200b\u6574\u6570\u200b)\u200b\u6765\u200b\u63cf\u8ff0\u200b\u4e00\u4e2a\u200b\u5f15\u811a\u200b</li> </ul> <p>\u200b\u5f53\u200b\u89e3\u6790\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u4e2d\u200b\u7684\u200bGPIO\u200b\u4fe1\u606f\u200b\u65f6\u200b\uff0c\u200b\u9700\u8981\u200b\u7528\u5230\u200b\u4e0a\u9762\u200b\u7684\u200b\u5c5e\u6027\u200b\u3002</p> <p>\u200b\u6bd4\u5982\u200b\u4e0b\u9762\u200b\u7684\u200b<code>led-gpios</code>\uff0c\u200b\u5728\u200b<code>#gpio-cells = &lt;2&gt;</code>\u200b\u7684\u200b\u60c5\u51b5\u200b\u4e0b\u200b\uff0c\u200b\u5b83\u200b\u8868\u793a\u200b\u7684\u200b\u5f15\u811a\u200b\u6570\u91cf\u200b\u662f\u200b1\u3002</p> <pre><code>        myled {\n            compatible = \"100ask,leddrv\";\n            led-gpios = &lt;&amp;gpio1 10 GPIO_ACTIVE_LOW&gt;;\n        };\n</code></pre>"},{"location":"07_GPIO/06_1/#2","title":"2. \u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>Linux-4.9.88\\drivers\\gpio\\gpio-mxc.c</p>"},{"location":"07_GPIO/06_1/#21-gpio_chip","title":"2.1 \u200b\u5206\u914d\u200bgpio_chip","text":"<pre><code>static int mxc_gpio_probe(struct platform_device *pdev)\n{\n    struct device_node *np = pdev-&gt;dev.of_node;\n    struct mxc_gpio_port *port;\n    struct resource *iores;\n    int irq_base = 0;\n    int err;\n\n    mxc_gpio_get_hw(pdev);\n\n    port = devm_kzalloc(&amp;pdev-&gt;dev, sizeof(*port), GFP_KERNEL);\n    if (!port)\n        return -ENOMEM;\n</code></pre>"},{"location":"07_GPIO/06_1/#22-gpio_chip","title":"2.2 \u200b\u8bbe\u7f6e\u200bgpio_chip","text":""},{"location":"07_GPIO/06_1/#23-gpio_chip","title":"2.3 \u200b\u6ce8\u518c\u200bgpio_chip","text":"<pre><code>    err = devm_gpiochip_add_data(&amp;pdev-&gt;dev, &amp;port-&gt;gc, port);\n    if (err)\n        goto out_bgio;\n</code></pre>"},{"location":"07_GPIO/07_1/","title":"04_\u200b\u7f16\u5199\u200b\u4e00\u4e2a\u200b\u865a\u62df\u200bGPIO\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f","text":""},{"location":"07_GPIO/07_1/#gpio","title":"\u7f16\u5199\u200b\u4e00\u4e2a\u200b\u865a\u62df\u200bGPIO\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux 5.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Linux-5.4\\Documentation\\driver-api</li> <li>Linux-5.4\\Documentation\\devicetree\\bindings\\gpio\\gpio.txt</li> <li> <p>Linux-5.4\\drivers\\gpio\\gpio-74x164.c</p> </li> <li> <p>Linux 4.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</p> </li> <li>Linux-4.9.88\\Documentation\\gpio</li> <li>Linux-4.9.88\\Documentation\\devicetree\\bindings\\gpio\\gpio.txt</li> <li> <p>Linux-4.9.88\\drivers\\gpio\\gpio-74x164.c</p> </li> <li> <p>\u200b\u672c\u7ae0\u200b\u8bfe\u7a0b\u200b\u6e90\u7801\u200b\u4f4d\u4e8e\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b(\u200b\u672a\u200b\u8c03\u8bd5\u200b)</p> </li> </ul> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\source\\07_GPIO\\02_virtual_gpio\ndoc_and_source_for_drivers\\STM32MP157\\source\\A7\\07_GPIO\\02_virtual_gpio\n</code></pre>"},{"location":"07_GPIO/07_1/#1","title":"1. \u200b\u786c\u4ef6\u200b\u529f\u80fd","text":"<p>\u200b\u5047\u8bbe\u200b\u8fd9\u4e2a\u200b\u865a\u62df\u200b\u7684\u200bGPIO Controller\u200b\u6709\u200b4\u200b\u4e2a\u200b\u5f15\u811a\u200b\uff1a</p> <p></p>"},{"location":"07_GPIO/07_1/#2","title":"2. \u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6","text":"<pre><code>gpio_virt: virtual_gpiocontroller {\n    compatible = \"100ask,virtual_gpio\";\n    gpio-controller;\n    #gpio-cells = &lt;2&gt;;\n    ngpios = &lt;4&gt;;\n};\n</code></pre>"},{"location":"07_GPIO/07_1/#3","title":"3. \u200b\u7f16\u5199\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>\u200b\u73b0\u573a\u200b\u7f16\u5199\u200b\u3002</p> <p>\u200b\u6838\u5fc3\u200b\uff1a\u200b\u5206\u914d\u200b/\u200b\u8bbe\u7f6e\u200b/\u200b\u6ce8\u518c\u200b\u4e00\u4e2a\u200bgpio_chip\u200b\u7ed3\u6784\u200b\u4f53\u200b\u3002</p>"},{"location":"07_GPIO/08_1/","title":"05_\u200b\u8c03\u8bd5\u200b\u4e0e\u200b\u4f7f\u7528\u200b\u865a\u62df\u200b\u7684\u200bGPIO\u200b\u63a7\u5236\u5668","text":""},{"location":"07_GPIO/08_1/#gpio","title":"\u8c03\u8bd5\u200b\u4e0e\u200b\u4f7f\u7528\u200b\u865a\u62df\u200b\u7684\u200bGPIO\u200b\u63a7\u5236\u5668","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux 5.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Linux-5.4\\Documentation\\driver-api</li> <li>Linux-5.4\\Documentation\\devicetree\\bindings\\gpio\\gpio.txt</li> <li> <p>Linux-5.4\\drivers\\gpio\\gpio-74x164.c</p> </li> <li> <p>Linux 4.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</p> </li> <li>Linux-4.9.88\\Documentation\\gpio</li> <li>Linux-4.9.88\\Documentation\\devicetree\\bindings\\gpio\\gpio.txt</li> <li> <p>Linux-4.9.88\\drivers\\gpio\\gpio-74x164.c</p> </li> <li> <p>\u200b\u672c\u7ae0\u200b\u8bfe\u7a0b\u200b\u6e90\u7801\u200b\u4f4d\u4e8e\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b</p> </li> </ul> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\source\\07_GPIO\\03_virtual_gpio_ok\ndoc_and_source_for_drivers\\STM32MP157\\source\\A7\\07_GPIO\\03_virtual_gpio_ok\n</code></pre>"},{"location":"07_GPIO/08_1/#1","title":"1. \u200b\u786c\u4ef6\u200b\u529f\u80fd","text":"<p>\u200b\u5047\u8bbe\u200b\u4f7f\u7528\u200b\u8fd9\u4e2a\u200b\u865a\u62df\u200b\u7684\u200bGPIO Controller\u200b\u7684\u200bpinA\u200b\u6765\u200b\u63a7\u5236\u200bLED\uff1a</p> <p></p>"},{"location":"07_GPIO/08_1/#2","title":"2. \u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6","text":"<pre><code>gpio_virt: virtual_gpiocontroller {\n    compatible = \"100ask,virtual_gpio\";\n    gpio-controller;\n    #gpio-cells = &lt;2&gt;;\n    ngpios = &lt;4&gt;;\n};\n\nmyled {\n    compatible = \"100ask,leddrv\";\n    led-gpios = &lt;&amp;gpio_virt 0 GPIO_ACTIVE_LOW&gt;;\n};\n</code></pre>"},{"location":"07_GPIO/08_1/#3","title":"3. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":""},{"location":"07_GPIO/08_1/#31","title":"3.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":""},{"location":"07_GPIO/08_1/#1-stm32mp157","title":"1. STM32MP157","text":"<p>\u200b\u6ce8\u610f\u200b\uff1a\u200b\u5bf9\u4e8e\u200bSTM32MP157\uff0c\u200b\u4ee5\u524d\u200b\u8bf4\u200b\u7f16\u8bd1\u200b\u5185\u6838\u200b/\u200b\u9a71\u52a8\u200b\u3001\u200b\u7f16\u8bd1\u200bAPP\u200b\u7684\u200b\u5de5\u5177\u200b\u94fe\u200b\u4e0d\u200b\u4e00\u6837\u200b\uff0c\u200b\u5176\u5b9e\u200b\u7f16\u8bd1\u200bAPP\u200b\u7528\u200b\u7684\u200b\u5de5\u5177\u200b\u94fe\u200b\u4e5f\u200b\u80fd\u200b\u7528\u6765\u200b\u7f16\u8bd1\u200b\u5185\u6838\u200b\u3002</p> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"07_GPIO/08_1/#2-imx6ull","title":"2. IMX6ULL","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre>"},{"location":"07_GPIO/08_1/#32","title":"3.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"07_GPIO/08_1/#1-stm32mp157_1","title":"1. STM32MP157","text":"<ul> <li> <p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dts</code>\uff0c\u200b\u6dfb\u52a0\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>/ {\n    gpio_virt: virtual_gpiocontroller {\n        compatible = \"100ask,virtual_gpio\";\n        gpio-controller;\n        #gpio-cells = &lt;2&gt;;\n        ngpios = &lt;4&gt;;\n    };\n\n    myled {\n        compatible = \"100ask,leddrv\";\n        led-gpios = &lt;&amp;gpio_virt 2 GPIO_ACTIVE_LOW&gt;;\n    };\n};\n</code></pre> </li> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bSTM32MP157\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <ul> <li>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.1.100)</li> </ul> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> <ul> <li>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.1.137</li> </ul> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u6811\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b\u54ea\u91cc\u200b</p> </li> </ul> <p>\u200b\u7531\u4e8e\u200b\u7248\u672c\u200b\u53d8\u5316\u200b\uff0cSTM32MP157\u200b\u5355\u677f\u200b\u4e0a\u200b\u70e7\u5f55\u200b\u7684\u200b\u7cfb\u7edf\u200b\u53ef\u80fd\u200b\u6709\u200b\u7ec6\u5fae\u5dee\u522b\u200b\u3002   \u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b<code>cat /proc/mounts</code>\u200b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u4e24\u79cd\u200b\u7ed3\u679c\u200b(\u200b\u89c1\u200b\u4e0b\u56fe\u200b)\uff1a</p> <ul> <li> <p>mmcblk2p2\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u5de6\u8fb9\u200b)\uff1a\u200b\u65e0\u9700\u200b\u7279\u6b8a\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u4e0b\u9762\u200b\u628a\u200b\u6587\u4ef6\u200b\u590d\u5236\u5230\u200b/boot\u200b\u76ee\u5f55\u200b\u5373\u53ef\u200b</p> </li> <li> <p>mmcblk2p2\u200b\u6302\u8f7d\u200b\u5728\u200b/mnt\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u53f3\u8fb9\u200b)</p> <ul> <li>\u200b\u5728\u200b\u89c6\u9891\u200b\u91cc\u200b\u3001\u200b\u540e\u9762\u200b\u6587\u6863\u200b\u91cc\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u66f4\u65b0\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u7684\u200b\u6587\u4ef6\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8981\u200b\u5148\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u91cd\u65b0\u200b\u6302\u8f7d\u200b\uff1a</li> <li><code>mount  /dev/mmcblk2p2  /boot</code></li> </ul> <p></p> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/stm32mp157c-100ask-512d-lcd-v1.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"07_GPIO/08_1/#2-imx6ull_1","title":"2. IMX6ULL","text":"<ul> <li> <p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code>\uff0c\u200b\u6dfb\u52a0\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>/ {\n    gpio_virt: virtual_gpiocontroller {\n        compatible = \"100ask,virtual_gpio\";\n        gpio-controller;\n        #gpio-cells = &lt;2&gt;;\n        ngpios = &lt;4&gt;;\n    };\n\n    myled {\n        compatible = \"100ask,leddrv\";\n        led-gpios = &lt;&amp;gpio_virt 2 GPIO_ACTIVE_LOW&gt;;\n    };\n};\n</code></pre> </li> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bIMX6ULL\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/100ask_imx6ull-14x14.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.1.100)</p> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.1.137</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/100ask_imx6ull-14x14.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"07_GPIO/08_1/#33","title":"3.3 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u5b89\u88c5\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\uff1a</p> </li> <li> <p>\u200b\u5728\u200bUbuntu\u200b\u4e0a\u200b</p> </li> <li> <p>\u200b\u4fee\u6539\u200b<code>01_led</code>\u3001<code>02_virtual_gpio</code>\u200b\u4e2d\u200b\u7684\u200bMakefile\uff0c\u200b\u6307\u5b9a\u200b\u5185\u6838\u200b\u8def\u5f84\u200b<code>KERN_DIR</code>\uff0c\u200b\u5728\u200b\u6267\u884c\u200b<code>make</code>\u200b\u547d\u4ee4\u200b\u5373\u53ef\u200b\u3002</p> </li> <li> <p>\u200b\u5b89\u88c5\u200b\uff1a</p> </li> <li> <p>\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b</p> </li> <li> <p>\u200b\u6302\u8f7d\u200bNFS\uff0c\u200b\u590d\u5236\u200b\u6587\u4ef6\u200b\uff0cinsmod\uff0c\u200b\u7c7b\u4f3c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b\uff1a</p> <p><pre><code>mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n// \u200b\u5bf9\u4e8e\u200bIMX6ULL\uff0c\u200b\u60f3\u200b\u770b\u5230\u200b\u9a71\u52a8\u200b\u6253\u5370\u4fe1\u606f\u200b\uff0c\u200b\u9700\u8981\u200b\u5148\u200b\u6267\u884c\u200b\necho \"7 4 1 7\" &gt; /proc/sys/kernel/printk\n\ninsmod -f /mnt/virtual_gpio_driver.ko\ninsmod -f /mnt/leddrv.ko\n\nls /dev/100ask_led0\n/mnt/ledtest /dev/100ask_led0 on\n/mnt/ledtest /dev/100ask_led0 off\n</code></pre> * \u200b\u89c2\u5bdf\u200b\u5185\u6838\u200b\u6253\u5370\u200b\u7684\u200b\u4fe1\u606f\u200b</p> </li> </ul>"},{"location":"07_GPIO/08_1/#4-stm32mp157bug","title":"4. STM32MP157\u200b\u4e0a\u200b\u7684\u200bbug","text":"<p>\u200b\u5728\u200bSTM32MP157\u200b\u4e0a\u200b\u505a\u200b\u5982\u4e0b\u200b\u5b9e\u9a8c\u200b\u65f6\u200b\uff1a</p> <pre><code>echo 509 &gt; /sys/class/gpio/export\necho out &gt; /sys/class/gpio/gpio509/direction\ncat /sys/class/gpio/gpio509/value\n</code></pre> <p>\u200b\u53d1\u73b0\u200b\u5bf9\u4e8e\u200b<code>value</code>\u200b\u6267\u884c\u200b\u4e00\u6b21\u200bcat\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u5bfc\u81f4\u200b<code>virt_gpio_get_value</code>\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b3\u200b\u6b21\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>cat /sys/class/gpio/gpio509/value\n[   96.283263] get pin 1, it's val = 0\n[   96.297803] get pin 1, it's val = 0\n[   96.312604] get pin 1, it's val = 0\n</code></pre> <p><code>cat value</code>\u200b\u8fd9\u4e2a\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u4f1a\u200b\u5bfc\u81f4\u200b\u9a71\u52a8\u200b<code>drivers/gpio/gpiolib-sysfs.c</code>\u200b\u4e2d\u200b\u7684\u200bvalue_show\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b\u3002</p> <p>value_show\u200b\u53ea\u4f1a\u200b\u8c03\u7528\u200b\u4e00\u6b21\u200bGPIO Controller\u200b\u4e2d\u200b\u7684\u200bget\u200b\u51fd\u6570\u200b\u3002</p> <p>\u200b\u6240\u4ee5\u200b\uff0c\u200b\u6211\u4eec\u200b\u7f16\u5199\u200b\u4e86\u200b\u4e00\u4e2a\u200bread.c\u200b\u7a0b\u5e8f\u200b\uff0c\u200b\u6e90\u7801\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>#include &lt;stdio.h&gt;\n#include &lt;sys/types.h&gt;\n#include &lt;sys/stat.h&gt;\n#include &lt;fcntl.h&gt;\n#include &lt;unistd.h&gt;\n\nint main(int argc, char **argv)\n{\n        int fd = open(argv[1], O_RDONLY);\n\n        char buf[10];\n\n        read(fd, buf, 10);\n        printf(\"%s\\n\", buf);\n        return 0;\n}\n</code></pre> <p>\u200b\u7f16\u8bd1\u200bread.c:</p> <pre><code>arm-buildroot-linux-gnueabihf-gcc -o read read.c\n</code></pre> <p>\u200b\u653e\u5230\u200b\u677f\u5b50\u200b\u4e0a\u200b\u6267\u884c\u200b\uff0c\u200b\u53d1\u73b0\u200b\u8bfb\u53d6\u200bvalue\u200b\u6587\u4ef6\u200b\u4e00\u6b21\u200b\uff0c\u200b\u53ea\u4f1a\u200b\u5bfc\u81f4\u200bget\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b\u4e00\u6b21\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code># ./read /sys/class/gpio/gpio509/value\n[  298.663613] get pin 1, it's val = 0\n1\n</code></pre> <p>\u200b\u6240\u4ee5\u200b\uff1a\u200b\u95ee\u9898\u200b\u5728\u4e8e\u200bcat\u200b\u547d\u4ee4\u200b\uff0c\u200b\u867d\u7136\u200b\u6211\u4eec\u200b\u6267\u884c\u200b\u4e86\u200b\u4e00\u6b21\u200bcat\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u4f46\u662f\u200b\u5b83\u200b\u53d1\u8d77\u200b\u4e86\u200b3\u200b\u6b21\u8bfb\u200bvalue\u200b\u6587\u4ef6\u200b\u7684\u200b\u64cd\u4f5c\u200b\u3002</p> <p>\u200b\u81f3\u4e8e\u200bcat\u200b\u7684\u200bbug\u200b\u5728\u200b\u54ea\u200b\uff0c\u200b\u65e0\u5173\u7d27\u8981\u200b\uff0c\u200b\u5148\u4e0d\u82b1\u200b\u65f6\u95f4\u200b\u53bb\u67e5\u200b\u3002</p>"},{"location":"07_GPIO/09_1/","title":"06_GPIO\u200b\u5b50\u7cfb\u7edf\u200b\u4e0e\u200bPinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u7684\u200b\u4ea4\u4e92","text":""},{"location":"07_GPIO/09_1/#gpiopinctrl","title":"GPIO\u200b\u5b50\u7cfb\u7edf\u200b\u4e0e\u200bPinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u7684\u200b\u4ea4\u4e92","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux 5.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Linux-5.4\\Documentation\\driver-api</li> <li>Linux-5.4\\Documentation\\devicetree\\bindings\\gpio\\gpio.txt</li> <li> <p>Linux-5.4\\drivers\\gpio\\gpio-74x164.c</p> </li> <li> <p>Linux 4.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</p> </li> <li>Linux-4.9.88\\Documentation\\gpio</li> <li>Linux-4.9.88\\Documentation\\devicetree\\bindings\\gpio\\gpio.txt</li> <li>Linux-4.9.88\\drivers\\gpio\\gpio-74x164.c</li> </ul>"},{"location":"07_GPIO/09_1/#1-gpiopinctrl","title":"1. \u200b\u4f7f\u7528\u200bGPIO\u200b\u524d\u200b\u5e94\u8be5\u200b\u8bbe\u7f6e\u200bPinctrl","text":"<p>\u200b\u5047\u8bbe\u200b\u4f7f\u7528\u200b\u8fd9\u4e2a\u200b\u865a\u62df\u200b\u7684\u200bGPIO Controller\u200b\u7684\u200bpinA\u200b\u6765\u200b\u63a7\u5236\u200bLED\uff1a</p> <p></p> <p>\u200b\u8981\u200b\u4f7f\u7528\u200bpinA\u200b\u6765\u200b\u63a7\u5236\u200bLED\uff0c\u200b\u9996\u5148\u200b\u8981\u200b\u901a\u8fc7\u200bPinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u628a\u200b\u5b83\u200b\u8bbe\u7f6e\u200b\u4e3a\u200bGPIO\u200b\u529f\u80fd\u200b\uff0c\u200b\u7136\u540e\u200b\u624d\u80fd\u200b\u8bbe\u7f6e\u200b\u5b83\u200b\u4e3a\u200b\u8f93\u51fa\u200b\u5f15\u811a\u200b\u3001\u200b\u8bbe\u7f6e\u200b\u5b83\u200b\u7684\u200b\u8f93\u51fa\u200b\u503c\u200b\u3002</p> <p>\u200b\u6240\u4ee5\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\u91cc\u200b\uff0c\u200b\u5e94\u8be5\u200b\u6dfb\u52a0\u200bPinctrl\u200b\u7684\u200b\u5185\u5bb9\u200b\uff1a</p> <pre><code>virtual_pincontroller {\n    compatible = \"100ask,virtual_pinctrl\";\n    myled_pin: myled_pin {\n            functions = \"gpio\";\n            groups = \"pin0\";\n            configs = &lt;0x11223344&gt;;\n    };\n};\n\ngpio_virt: virtual_gpiocontroller {\n    compatible = \"100ask,virtual_gpio\";\n    gpio-controller;\n    #gpio-cells = &lt;2&gt;;\n    ngpios = &lt;4&gt;;\n};\n\nmyled {\n    compatible = \"100ask,leddrv\";\n    led-gpios = &lt;&amp;gpio_virt 0 GPIO_ACTIVE_LOW&gt;;\n    pinctrl-names = \"default\";\n    pinctrl-0 = &lt;&amp;myled_pin&gt;;   \n};\n</code></pre> <p>\u200b\u4f46\u662f\u200b\u5f88\u591a\u200b\u82af\u7247\u200b\uff0c\u200b\u5e76\u200b\u4e0d\u200b\u8981\u6c42\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\u628a\u200b\u628a\u200b\u5f15\u811a\u200b\u590d\u7528\u200b\u4e3a\u200bGPIO\u200b\u529f\u80fd\u200b\u3002</p> <p>\u200b\u6bd4\u5982\u200bSTM32MP157\uff0c\u200b\u5728\u200b\u5b83\u200b\u7684\u200b\u8bbe\u5907\u200b\u6811\u200b\u5de5\u5177\u200b<code>STM32CubeMX</code>\u200b\u5373\u4f7f\u200b\u628a\u200b\u5f15\u811a\u200b\u914d\u7f6e\u200b\u4e3a\u200bGPIO\u200b\u529f\u80fd\u200b\uff0c\u200b\u5b83\u200b\u4e5f\u200b\u4e0d\u4f1a\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\u51fa\u73b0\u200b\u3002</p> <p>\u200b\u539f\u56e0\u200b\u5728\u4e8e\u200b\uff1aGPIO\u200b\u8d70\u200b\u4e86\u200b\u540e\u95e8\u200b\u3002</p> <p>\u200b\u73b0\u5b9e\u200b\u7684\u200b\u82af\u7247\u200b\u4e2d\u200b\uff0c\u200b\u5e76\u200b\u6ca1\u6709\u200bPinctrl\u200b\u8fd9\u6837\u200b\u7684\u200b\u786c\u4ef6\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u529f\u80fd\u200b\u5927\u90e8\u5206\u200b\u662f\u200b\u5728\u200bGPIO\u200b\u6a21\u5757\u200b\u4e2d\u200b\u5b9e\u73b0\u200b\u7684\u200b\u3002</p> <p>Pinctrl\u200b\u662f\u200b\u4e00\u4e2a\u200b\u8f6f\u4ef6\u200b\u865a\u62df\u200b\u5904\u7406\u200b\u7684\u200b\u6982\u5ff5\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u5b9e\u73b0\u200b\u672c\u6765\u200b\u5c31\u200b\u8ddf\u200bGPIO\u200b\u5bc6\u5207\u76f8\u5173\u200b\u3002</p> <p>\u200b\u751a\u81f3\u200b\u4e00\u4e9b\u200b\u5f15\u811a\u200b\u9ed8\u8ba4\u200b\u5c31\u662f\u200bGPIO\u200b\u529f\u80fd\u200b\u3002</p> <p>\u200b\u6309\u7406\u8bf4\u200b\uff1a</p> <p>\u200b\u4e00\u4e2a\u200b\u5f15\u811a\u200b\u53ef\u80fd\u200b\u88ab\u200b\u7528\u4f5c\u200bGPIO\uff0c\u200b\u4e5f\u200b\u53ef\u80fd\u200b\u88ab\u200b\u7528\u4f5c\u200bI2C\uff0cGPIO\u200b\u548c\u200bI2C\u200b\u8fd9\u4e9b\u200b\u529f\u80fd\u200b\u65f6\u200b\u76f8\u540c\u200b\u4f4e\u4f4d\u200b\u7684\u200b\u3002</p> <p>\u200b\u8981\u200b\u7528\u4f5c\u200bGPIO\uff0c\u200b\u9700\u8981\u200b\u5148\u200b\u901a\u8fc7\u200bPinctrl\u200b\u628a\u200b\u5f15\u811a\u200b\u590d\u7528\u200b\u4e3a\u200bGPIO\u200b\u529f\u80fd\u200b\u3002</p> <p>\u200b\u4f46\u662f\u200bPinctrl\u200b\u548c\u200bGPIO\u200b\u5173\u7cfb\u5bc6\u5207\u200b\uff0c\u200b\u5f53\u200b\u4f60\u200b\u4f7f\u7528\u200bgpiod_get\u200b\u83b7\u5f97\u200bGPIO\u200b\u5f15\u811a\u200b\u65f6\u200b\uff0c\u200b\u5b83\u200b\u5c31\u200b<code>\u200b\u5077\u5077\u5730\u200b</code>\u200b\u901a\u8fc7\u200bPinctrl\u200b\u628a\u200b\u5f15\u811a\u200b\u590d\u7528\u200b\u4e3a\u200bGPIO\u200b\u529f\u80fd\u200b\u4e86\u200b\u3002</p>"},{"location":"07_GPIO/09_1/#2-gpiopinctrl","title":"2. GPIO\u200b\u548c\u200bPinctrl\u200b\u7684\u200b\u6620\u5c04\u200b\u5173\u7cfb","text":""},{"location":"07_GPIO/09_1/#21","title":"2.1 \u200b\u793a\u4f8b","text":"<p>\u200b\u4ece\u200b\u4e0a\u200b\u56fe\u200b\u53ef\u77e5\u200b\uff1a</p> <ul> <li>\u200b\u5de6\u8fb9\u200b\u7684\u200bPinctrl\u200b\u652f\u6301\u200b8\u200b\u4e2a\u200b\u5f15\u811a\u200b\uff0c\u200b\u5728\u200bPinctrl\u200b\u7684\u200b\u5185\u90e8\u200b\u7f16\u53f7\u200b\u4e3a\u200b0~7</li> <li>\u200b\u56fe\u4e2d\u200b\u6709\u200b2\u200b\u4e2a\u200bGPIO\u200b\u63a7\u5236\u5668\u200b</li> <li>GPIO0\u200b\u5185\u90e8\u200b\u5f15\u811a\u200b\u7f16\u53f7\u200b\u4e3a\u200b0<sub>3\uff0c\u200b\u5047\u8bbe\u200b\u5728\u200bGPIO\u200b\u5b50\u7cfb\u7edf\u200b\u4e2d\u200b\u5168\u5c40\u200b\u7f16\u53f7\u200b\u4e3a\u200b100</sub>103</li> <li> <p>GPIO1\u200b\u5185\u90e8\u200b\u5f15\u811a\u200b\u7f16\u53f7\u200b\u4e3a\u200b0<sub>3\uff0c\u200b\u5047\u8bbe\u200b\u5728\u200bGPIO\u200b\u5b50\u7cfb\u7edf\u200b\u4e2d\u200b\u5168\u5c40\u200b\u7f16\u53f7\u200b\u4e3a\u200b104</sub>107</p> </li> <li> <p>\u200b\u5047\u8bbe\u200b\u6211\u4eec\u200b\u8981\u200b\u4f7f\u7528\u200bpin1_1\uff0c\u200b\u5e94\u8be5\u200b\u8fd9\u6837\u200b\u505a\u200b\uff1a</p> </li> <li>\u200b\u6839\u636e\u200bGPIO1\u200b\u7684\u200b\u5185\u90e8\u200b\u7f16\u53f7\u200b1\uff0c\u200b\u53ef\u4ee5\u200b\u6362\u7b97\u200b\u4e3a\u200bPinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u4e2d\u200b\u7684\u200b\u7f16\u53f7\u200b5</li> <li>\u200b\u4f7f\u7528\u200bPinctrl\u200b\u7684\u200b\u51fd\u6570\u200b\uff0c\u200b\u628a\u200b\u7b2c\u200b5\u200b\u4e2a\u200b\u5f15\u811a\u200b\u914d\u7f6e\u200b\u4e3a\u200bGPIO\u200b\u529f\u80fd\u200b</li> </ul>"},{"location":"07_GPIO/09_1/#22","title":"2.2 \u200b\u6570\u636e\u7ed3\u6784","text":""},{"location":"07_GPIO/09_1/#3-gpiopinctrl","title":"3. GPIO\u200b\u8c03\u7528\u200bPinctrl\u200b\u7684\u200b\u8fc7\u7a0b","text":"<p>GPIO\u200b\u5b50\u7cfb\u7edf\u200b\u4e2d\u200b\u7684\u200brequest\u200b\u51fd\u6570\u200b\uff0c\u200b\u7528\u6765\u200b\u7533\u8bf7\u200b\u67d0\u4e2a\u200bGPIO\u200b\u5f15\u811a\u200b\uff0c</p> <p>\u200b\u5b83\u4f1a\u200b\u5bfc\u81f4\u200bPinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u4e2d\u200b\u7684\u200b\u8fd9\u200b2\u200b\u4e2a\u200b\u51fd\u6570\u200b\u4e4b\u4e00\u200b\u88ab\u200b\u8c03\u7528\u200b\uff1a<code>pmxops-&gt;gpio_request_enable</code>\u200b\u6216\u200b<code>pmxops-&gt;request</code></p> <p></p> <p>\u200b\u8c03\u7528\u200b\u5173\u7cfb\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>gpiod_get\n    gpiod_get_index\n        desc = of_find_gpio(dev, con_id, idx, &amp;lookupflags);\n        ret = gpiod_request(desc, con_id ? con_id : devname);\n                    ret = gpiod_request_commit(desc, label);\n                                if (chip-&gt;request) {\n                                    ret = chip-&gt;request(chip, offset);\n                                }\n</code></pre> <p>\u200b\u6211\u4eec\u200b\u7f16\u5199\u200bGPIO\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u65f6\u200b\uff0c\u200b\u6240\u200b\u8bbe\u7f6e\u200b<code>chip-&gt;request</code>\u200b\u51fd\u6570\u200b\uff0c\u200b\u4e00\u822c\u200b\u76f4\u63a5\u200b\u8c03\u7528\u200b<code>gpiochip_generic_request</code>\uff0c\u200b\u5b83\u200b\u5bfc\u81f4\u200bPinctrl\u200b\u628a\u200b\u5f15\u811a\u200b\u590d\u7528\u200b\u4e3a\u200bGPIO\u200b\u529f\u80fd\u200b\u3002</p> <pre><code>gpiochip_generic_request(struct gpio_chip *chip, unsigned offset)\n    pinctrl_request_gpio(chip-&gt;gpiodev-&gt;base + offset)\n        ret = pinctrl_get_device_gpio_range(gpio, &amp;pctldev, &amp;range); // gpio\u200b\u662f\u200b\u5f15\u811a\u200b\u7684\u200b\u5168\u5c40\u200b\u7f16\u53f7\u200b\n\n        /* Convert to the pin controllers number space */\n        pin = gpio_to_pin(range, gpio);\n\n        ret = pinmux_request_gpio(pctldev, range, pin, gpio);\n                    ret = pin_request(pctldev, pin, owner, range);\n</code></pre> <p>Pinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u4e2d\u200b\u7684\u200bpin_request\u200b\u51fd\u6570\u200b\u5c31\u200b\u4f1a\u200b\u628a\u200b\u5f15\u811a\u200b\u914d\u7f6e\u200b\u4e3a\u200bGPIO\u200b\u529f\u80fd\u200b\uff1a</p> <pre><code>static int pin_request(struct pinctrl_dev *pctldev,\n               int pin, const char *owner,\n               struct pinctrl_gpio_range *gpio_range)\n{\n    const struct pinmux_ops *ops = pctldev-&gt;desc-&gt;pmxops;\n\n    /*\n     * If there is no kind of request function for the pin we just assume\n     * we got it by default and proceed.\n     */\n    if (gpio_range &amp;&amp; ops-&gt;gpio_request_enable)\n        /* This requests and enables a single GPIO pin */\n        status = ops-&gt;gpio_request_enable(pctldev, gpio_range, pin);\n    else if (ops-&gt;request)\n        status = ops-&gt;request(pctldev, pin);\n    else\n        status = 0;\n}\n</code></pre>"},{"location":"07_GPIO/09_1/#3","title":"3. \u200b\u6211\u4eec\u200b\u8981\u200b\u505a\u200b\u4ec0\u4e48","text":"<p>\u200b\u5982\u679c\u200b\u4e0d\u60f3\u200b\u5728\u200b\u4f7f\u7528\u200bGPIO\u200b\u5f15\u811a\u200b\u65f6\u200b\uff0c\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\u8bbe\u7f6e\u200bPinctrl\u200b\u4fe1\u606f\u200b\uff0c</p> <p>\u200b\u5982\u679c\u200b\u60f3\u200b\u8ba9\u200bGPIO\u200b\u548c\u200bPinctrl\u200b\u4e4b\u95f4\u200b\u5efa\u7acb\u8054\u7cfb\u200b\uff0c</p> <p>\u200b\u6211\u4eec\u200b\u9700\u8981\u200b\u505a\u200b\u8fd9\u4e9b\u200b\u4e8b\u60c5\u200b\uff1a</p>"},{"location":"07_GPIO/09_1/#31-gpiopinctrl","title":"3.1 \u200b\u8868\u660e\u200bGPIO\u200b\u548c\u200bPinctrl\u200b\u95f4\u200b\u7684\u200b\u8054\u7cfb","text":"<p>\u200b\u5728\u200bGPIO\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\u4f7f\u7528\u200b<code>gpio-ranges</code>\u200b\u6765\u200b\u63cf\u8ff0\u200b\u5b83\u4eec\u200b\u4e4b\u95f4\u200b\u7684\u200b\u8054\u7cfb\u200b\uff1a</p> <ul> <li> <p>GPIO\u200b\u7cfb\u7edf\u200b\u4e2d\u6709\u200b\u5f15\u811a\u200b\u53f7\u200b</p> </li> <li> <p>Pinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u4e2d\u200b\u4e5f\u200b\u6709\u200b\u81ea\u5df1\u200b\u7684\u200b\u5f15\u811a\u200b\u53f7\u200b</p> </li> <li> <p>2\u200b\u4e2a\u200b\u53f7\u7801\u200b\u8981\u200b\u5efa\u7acb\u200b\u6620\u5c04\u200b\u5173\u7cfb\u200b</p> </li> <li> <p>\u200b\u5728\u200bGPIO\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\u4f7f\u7528\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\u5efa\u7acb\u200b\u6620\u5c04\u200b\u5173\u7cfb\u200b</p> <pre><code>// \u200b\u5f53\u524d\u200bGPIO\u200b\u63a7\u5236\u5668\u200b\u7684\u200b0\u200b\u53f7\u200b\u5f15\u811a\u200b, \u200b\u5bf9\u5e94\u200bpinctrlA\u200b\u4e2d\u200b\u7684\u200b128\u200b\u53f7\u200b\u5f15\u811a\u200b, \u200b\u6570\u91cf\u200b\u4e3a\u200b12\ngpio-ranges = &lt;&amp;pinctrlA 0 128 12&gt;; \n</code></pre> </li> </ul>"},{"location":"07_GPIO/09_1/#32","title":"3.2 \u200b\u89e3\u6790\u200b\u8fd9\u4e9b\u200b\u8054\u7cfb","text":"<p>\u200b\u5728\u200bGPIO\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e2d\u200b\uff0c\u200b\u89e3\u6790\u200b\u8ddf\u200bPinctrl\u200b\u4e4b\u95f4\u200b\u7684\u200b\u8054\u7cfb\u200b\uff1a\u200b\u5904\u7406\u200b<code>gpio-ranges</code>:</p> <ul> <li> <p>\u200b\u8fd9\u200b\u4e0d\u200b\u9700\u8981\u200b\u6211\u4eec\u200b\u81ea\u5df1\u200b\u5199\u200b\u4ee3\u7801\u200b</p> </li> <li> <p>\u200b\u6ce8\u518c\u200bgpio_chip\u200b\u65f6\u4f1a\u200b\u81ea\u52a8\u200b\u8c03\u7528\u200b</p> <pre><code>int gpiochip_add_data(struct gpio_chip *chip, void *data)\n    status = of_gpiochip_add(chip);\n                status = of_gpiochip_add_pin_range(chip);\n\nof_gpiochip_add_pin_range\n    for (;; index++) {\n        ret = of_parse_phandle_with_fixed_args(np, \"gpio-ranges\", 3,\n                index, &amp;pinspec);\n\n        pctldev = of_pinctrl_get(pinspec.np); // \u200b\u6839\u636e\u200bgpio-ranges\u200b\u7684\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u53c2\u6570\u200b\u627e\u5230\u200bpctldev\n\n        // \u200b\u589e\u52a0\u200b\u6620\u5c04\u200b\u5173\u7cfb\u200b   \n        /* npins != 0: linear range */\n        ret = gpiochip_add_pin_range(chip,\n                                     pinctrl_dev_get_devname(pctldev),\n                                     pinspec.args[0],\n                                     pinspec.args[1],\n                                     pinspec.args[2]);\n</code></pre> </li> </ul>"},{"location":"07_GPIO/09_1/#33","title":"3.3 \u200b\u7f16\u7a0b","text":"<ul> <li> <p>\u200b\u5728\u200bGPIO\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e2d\u200b\uff0c\u200b\u63d0\u4f9b\u200b<code>gpio_chip-&gt;request</code></p> </li> <li> <p>\u200b\u5728\u200bPinctrl\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e2d\u200b\uff0c\u200b\u63d0\u4f9b\u200b<code>pmxops-&gt;gpio_request_enable</code>\u200b\u6216\u200b<code>pmxops-&gt;request</code></p> </li> </ul>"},{"location":"07_GPIO/10_1/","title":"07_\u200b\u7f16\u7a0b\u200b_GPIO\u200b\u4f7f\u7528\u200bPinctrl","text":""},{"location":"07_GPIO/10_1/#_gpiopinctrl","title":"\u7f16\u7a0b\u200b_GPIO\u200b\u4f7f\u7528\u200bPinctrl","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux 5.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Linux-5.4\\Documentation\\driver-api</li> <li>Linux-5.4\\Documentation\\devicetree\\bindings\\gpio\\gpio.txt</li> <li> <p>Linux-5.4\\drivers\\gpio\\gpio-74x164.c</p> </li> <li> <p>Linux 4.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</p> </li> <li>Linux-4.9.88\\Documentation\\gpio</li> <li>Linux-4.9.88\\Documentation\\devicetree\\bindings\\gpio\\gpio.txt</li> <li> <p>Linux-4.9.88\\drivers\\gpio\\gpio-74x164.c</p> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u4ee3\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u4e2d\u200b</p> </li> </ul> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\source\\07_GPIO\\04_gpio_use_pinctrl_ok\ndoc_and_source_for_drivers\\STM32MP157\\source\\A7\\07_GPIO\\04_gpio_use_pinctrl_ok\n</code></pre>"},{"location":"07_GPIO/10_1/#1","title":"1. \u200b\u6211\u4eec\u200b\u8981\u200b\u505a\u200b\u4ec0\u4e48","text":"<p>\u200b\u5047\u8bbe\u200b\u4f7f\u7528\u200b\u8fd9\u4e2a\u200b\u865a\u62df\u200b\u7684\u200bGPIO Controller\u200b\u7684\u200bpinA\u200b\u6765\u200b\u63a7\u5236\u200bLED\uff1a</p> <p></p> <p>\u200b\u5982\u679c\u200b\u4e0d\u60f3\u200b\u5728\u200b\u4f7f\u7528\u200bGPIO\u200b\u5f15\u811a\u200b\u65f6\u200b\uff0c\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\u8bbe\u7f6e\u200bPinctrl\u200b\u4fe1\u606f\u200b\uff0c</p> <p>\u200b\u5982\u679c\u200b\u60f3\u200b\u8ba9\u200bGPIO\u200b\u548c\u200bPinctrl\u200b\u4e4b\u95f4\u200b\u5efa\u7acb\u8054\u7cfb\u200b\uff0c</p> <p>\u200b\u6211\u4eec\u200b\u9700\u8981\u200b\u505a\u200b\u8fd9\u4e9b\u200b\u4e8b\u60c5\u200b\uff1a</p>"},{"location":"07_GPIO/10_1/#11-gpiopinctrl","title":"1.1 \u200b\u8868\u660e\u200bGPIO\u200b\u548c\u200bPinctrl\u200b\u95f4\u200b\u7684\u200b\u8054\u7cfb","text":"<p>\u200b\u5728\u200bGPIO\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\u4f7f\u7528\u200b<code>gpio-ranges</code>\u200b\u6765\u200b\u63cf\u8ff0\u200b\u5b83\u4eec\u200b\u4e4b\u95f4\u200b\u7684\u200b\u8054\u7cfb\u200b\uff1a</p> <ul> <li> <p>GPIO\u200b\u7cfb\u7edf\u200b\u4e2d\u6709\u200b\u5f15\u811a\u200b\u53f7\u200b</p> </li> <li> <p>Pinctrl\u200b\u5b50\u7cfb\u7edf\u200b\u4e2d\u200b\u4e5f\u200b\u6709\u200b\u81ea\u5df1\u200b\u7684\u200b\u5f15\u811a\u200b\u53f7\u200b</p> </li> <li> <p>2\u200b\u4e2a\u200b\u53f7\u7801\u200b\u8981\u200b\u5efa\u7acb\u200b\u6620\u5c04\u200b\u5173\u7cfb\u200b</p> </li> <li> <p>\u200b\u5728\u200bGPIO\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\u4f7f\u7528\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\u5efa\u7acb\u200b\u6620\u5c04\u200b\u5173\u7cfb\u200b</p> <pre><code>// \u200b\u5f53\u524d\u200bGPIO\u200b\u63a7\u5236\u5668\u200b\u7684\u200b0\u200b\u53f7\u200b\u5f15\u811a\u200b, \u200b\u5bf9\u5e94\u200bpinctrlA\u200b\u4e2d\u200b\u7684\u200b128\u200b\u53f7\u200b\u5f15\u811a\u200b, \u200b\u6570\u91cf\u200b\u4e3a\u200b12\ngpio-ranges = &lt;&amp;pinctrlA 0 128 12&gt;; \n</code></pre> </li> </ul>"},{"location":"07_GPIO/10_1/#12","title":"1.2 \u200b\u89e3\u6790\u200b\u8fd9\u4e9b\u200b\u8054\u7cfb","text":"<p>\u200b\u5728\u200bGPIO\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e2d\u200b\uff0c\u200b\u89e3\u6790\u200b\u8ddf\u200bPinctrl\u200b\u4e4b\u95f4\u200b\u7684\u200b\u8054\u7cfb\u200b\uff1a\u200b\u5904\u7406\u200b<code>gpio-ranges</code>:</p> <ul> <li> <p>\u200b\u8fd9\u200b\u4e0d\u200b\u9700\u8981\u200b\u6211\u4eec\u200b\u81ea\u5df1\u200b\u5199\u200b\u4ee3\u7801\u200b</p> </li> <li> <p>\u200b\u6ce8\u518c\u200bgpio_chip\u200b\u65f6\u4f1a\u200b\u81ea\u52a8\u200b\u8c03\u7528\u200b</p> <pre><code>int gpiochip_add_data(struct gpio_chip *chip, void *data)\n    status = of_gpiochip_add(chip);\n                status = of_gpiochip_add_pin_range(chip);\n\nof_gpiochip_add_pin_range\n    for (;; index++) {\n        ret = of_parse_phandle_with_fixed_args(np, \"gpio-ranges\", 3,\n                index, &amp;pinspec);\n\n        pctldev = of_pinctrl_get(pinspec.np); // \u200b\u6839\u636e\u200bgpio-ranges\u200b\u7684\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u53c2\u6570\u200b\u627e\u5230\u200bpctldev\n\n        // \u200b\u589e\u52a0\u200b\u6620\u5c04\u200b\u5173\u7cfb\u200b   \n        /* npins != 0: linear range */\n        ret = gpiochip_add_pin_range(chip,\n                                     pinctrl_dev_get_devname(pctldev),\n                                     pinspec.args[0],\n                                     pinspec.args[1],\n                                     pinspec.args[2]);\n</code></pre> </li> </ul>"},{"location":"07_GPIO/10_1/#13","title":"1.3 \u200b\u7f16\u7a0b","text":"<ul> <li> <p>\u200b\u5728\u200bGPIO\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e2d\u200b\uff0c\u200b\u63d0\u4f9b\u200b<code>gpio_chip-&gt;request</code></p> </li> <li> <p>\u200b\u5728\u200bPinctrl\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e2d\u200b\uff0c\u200b\u63d0\u4f9b\u200b<code>pmxops-&gt;gpio_request_enable</code>\u200b\u6216\u200b<code>pmxops-&gt;request</code></p> </li> </ul>"},{"location":"07_GPIO/10_1/#2","title":"2. \u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811","text":"<pre><code>pinctrl_virt: virtual_pincontroller {\n    compatible = \"100ask,virtual_pinctrl\";\n};\n\ngpio_virt: virtual_gpiocontroller {\n    compatible = \"100ask,virtual_gpio\";\n    gpio-controller;\n    #gpio-cells = &lt;2&gt;;\n    ngpios = &lt;4&gt;;\n    gpio-ranges = &lt;&amp;pinctrl_virt 0 0 4&gt;; \n};\n\nmyled {\n    compatible = \"100ask,leddrv\";\n    led-gpios = &lt;&amp;gpio_virt 0 GPIO_ACTIVE_LOW&gt;;\n};\n</code></pre>"},{"location":"07_GPIO/10_1/#3","title":"3. \u200b\u7f16\u7a0b","text":""},{"location":"07_GPIO/10_1/#31-gpio","title":"3.1 GPIO\u200b\u63a7\u5236\u5668\u200b\u7f16\u7a0b","text":"<p>gpio_chip\u200b\u4e2d\u200b\u63d0\u4f9b\u200brequest\u200b\u51fd\u6570\u200b\uff1a</p> <pre><code>chip-&gt;request = gpiochip_generic_request;\n</code></pre>"},{"location":"07_GPIO/10_1/#32-pinctrl","title":"3.2 Pinctrl\u200b\u7f16\u7a0b","text":"<pre><code>static const struct pinmux_ops virtual_pmx_ops = {\n    .get_functions_count = virtual_pmx_get_funcs_count,\n    .get_function_name = virtual_pmx_get_func_name,\n    .get_function_groups = virtual_pmx_get_groups,\n    .set_mux = virtual_pmx_set,\n    .gpio_request_enable = virtual_pmx_gpio_request_enable,\n};\n</code></pre>"},{"location":"07_GPIO/10_1/#4","title":"4. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":""},{"location":"07_GPIO/10_1/#41","title":"4.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":""},{"location":"07_GPIO/10_1/#1-stm32mp157","title":"1. STM32MP157","text":"<p>\u200b\u6ce8\u610f\u200b\uff1a\u200b\u5bf9\u4e8e\u200bSTM32MP157\uff0c\u200b\u4ee5\u524d\u200b\u8bf4\u200b\u7f16\u8bd1\u200b\u5185\u6838\u200b/\u200b\u9a71\u52a8\u200b\u3001\u200b\u7f16\u8bd1\u200bAPP\u200b\u7684\u200b\u5de5\u5177\u200b\u94fe\u200b\u4e0d\u200b\u4e00\u6837\u200b\uff0c\u200b\u5176\u5b9e\u200b\u7f16\u8bd1\u200bAPP\u200b\u7528\u200b\u7684\u200b\u5de5\u5177\u200b\u94fe\u200b\u4e5f\u200b\u80fd\u200b\u7528\u6765\u200b\u7f16\u8bd1\u200b\u5185\u6838\u200b\u3002</p> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"07_GPIO/10_1/#2-imx6ull","title":"2. IMX6ULL","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre>"},{"location":"07_GPIO/10_1/#42","title":"4.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"07_GPIO/10_1/#1-stm32mp157_1","title":"1. STM32MP157","text":"<ul> <li> <p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dts</code>\uff0c\u200b\u6dfb\u52a0\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>/ {\n   pinctrl_virt: virtual_pincontroller {\n        compatible = \"100ask,virtual_pinctrl\";\n        myled_pin: myled_pin {\n                        functions = \"gpio\";\n                        groups = \"pin0\";\n                        configs = &lt;0x11223344&gt;;\n        };\n        i2cgrp: i2cgrp {\n                functions = \"i2c\", \"i2c\";\n                groups = \"pin0\", \"pin1\";\n                configs = &lt;0x11223344  0x55667788&gt;;\n        };\n    };\n\n    gpio_virt: virtual_gpiocontroller {\n        compatible = \"100ask,virtual_gpio\";\n        gpio-controller;\n        #gpio-cells = &lt;2&gt;;\n        ngpios = &lt;4&gt;;\n        gpio-ranges = &lt;&amp;pinctrl_virt 0 0 4&gt;; \n    };\n\n    myled {\n        compatible = \"100ask,leddrv\";\n        led-gpios = &lt;&amp;gpio_virt 2 GPIO_ACTIVE_LOW&gt;;\n    };\n};\n</code></pre> </li> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bSTM32MP157\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <ul> <li>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.1.100)</li> </ul> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> <ul> <li>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.1.137</li> </ul> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u6811\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b\u54ea\u91cc\u200b</p> </li> </ul> <p>\u200b\u7531\u4e8e\u200b\u7248\u672c\u200b\u53d8\u5316\u200b\uff0cSTM32MP157\u200b\u5355\u677f\u200b\u4e0a\u200b\u70e7\u5f55\u200b\u7684\u200b\u7cfb\u7edf\u200b\u53ef\u80fd\u200b\u6709\u200b\u7ec6\u5fae\u5dee\u522b\u200b\u3002   \u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b<code>cat /proc/mounts</code>\u200b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u4e24\u79cd\u200b\u7ed3\u679c\u200b(\u200b\u89c1\u200b\u4e0b\u56fe\u200b)\uff1a</p> <ul> <li> <p>mmcblk2p2\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u5de6\u8fb9\u200b)\uff1a\u200b\u65e0\u9700\u200b\u7279\u6b8a\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u4e0b\u9762\u200b\u628a\u200b\u6587\u4ef6\u200b\u590d\u5236\u5230\u200b/boot\u200b\u76ee\u5f55\u200b\u5373\u53ef\u200b</p> </li> <li> <p>mmcblk2p2\u200b\u6302\u8f7d\u200b\u5728\u200b/mnt\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u53f3\u8fb9\u200b)</p> <ul> <li>\u200b\u5728\u200b\u89c6\u9891\u200b\u91cc\u200b\u3001\u200b\u540e\u9762\u200b\u6587\u6863\u200b\u91cc\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u66f4\u65b0\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u7684\u200b\u6587\u4ef6\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8981\u200b\u5148\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u91cd\u65b0\u200b\u6302\u8f7d\u200b\uff1a</li> <li><code>mount  /dev/mmcblk2p2  /boot</code></li> </ul> <p></p> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/stm32mp157c-100ask-512d-lcd-v1.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"07_GPIO/10_1/#2-imx6ull_1","title":"2. IMX6ULL","text":"<ul> <li> <p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code>\uff0c\u200b\u6dfb\u52a0\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>/ {\n   pinctrl_virt: virtual_pincontroller {\n        compatible = \"100ask,virtual_pinctrl\";\n        myled_pin: myled_pin {\n                        functions = \"gpio\";\n                        groups = \"pin0\";\n                        configs = &lt;0x11223344&gt;;\n        };\n        i2cgrp: i2cgrp {\n                functions = \"i2c\", \"i2c\";\n                groups = \"pin0\", \"pin1\";\n                configs = &lt;0x11223344  0x55667788&gt;;\n        };\n    };\n\n    gpio_virt: virtual_gpiocontroller {\n        compatible = \"100ask,virtual_gpio\";\n        gpio-controller;\n        #gpio-cells = &lt;2&gt;;\n        ngpios = &lt;4&gt;;\n        gpio-ranges = &lt;&amp;pinctrl_virt 0 0 4&gt;; \n    };\n\n    myled {\n        compatible = \"100ask,leddrv\";\n        led-gpios = &lt;&amp;gpio_virt 2 GPIO_ACTIVE_LOW&gt;;\n    };\n};\n</code></pre> </li> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bIMX6ULL\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/100ask_imx6ull-14x14.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.1.100)</p> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.1.137</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/100ask_imx6ull-14x14.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"07_GPIO/10_1/#43","title":"4.3 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u5b89\u88c5\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\uff1a</p> </li> <li> <p>\u200b\u5728\u200bUbuntu\u200b\u4e0a\u200b</p> </li> <li> <p>\u200b\u8fdb\u5165\u200b<code>04_gpio_use_pinctrl_ok</code>\u200b\u4e0b\u200b\u7684\u200b3\u200b\u4e2a\u200b\u9a71\u52a8\u200b\u76ee\u5f55\u200b\uff0c\u200b\u90fd\u200b\u6267\u884c\u200bmake\u200b\u547d\u4ee4\u200b</p> </li> <li> <p>\u200b\u5b89\u88c5\u200b\uff1a</p> </li> <li> <p>\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b</p> </li> <li> <p>\u200b\u6302\u8f7d\u200bNFS\uff0c\u200b\u590d\u5236\u200b\u6587\u4ef6\u200b\uff0cinsmod\uff0c\u200b\u7c7b\u4f3c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b\uff1a</p> <pre><code>mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n// \u200b\u5bf9\u4e8e\u200bIMX6ULL\uff0c\u200b\u60f3\u200b\u770b\u5230\u200b\u9a71\u52a8\u200b\u6253\u5370\u4fe1\u606f\u200b\uff0c\u200b\u9700\u8981\u200b\u5148\u200b\u6267\u884c\u200b\necho \"7 4 1 7\" &gt; /proc/sys/kernel/printk\n\ninsmod -f /mnt/virtual_pinctrl_driver.ko\ninsmod -f /mnt/virtual_gpio_driver.ko\ninsmod -f /mnt/leddrv.ko\n\nls /dev/100ask_led0\n/mnt/ledtest /dev/100ask_led0 on\n/mnt/ledtest /dev/100ask_led0 off\n</code></pre> </li> <li> <p>\u200b\u89c2\u5bdf\u200b\u5185\u6838\u200b\u6253\u5370\u200b\u7684\u200b\u4fe1\u606f\u200b</p> </li> </ul>"},{"location":"07_GPIO/10_1/#5","title":"5. \u200b\u518d\u6b21\u200b\u5f00\u540e\u95e8","text":"<p>\u200b\u5728\u200bSTM32MP157\u200b\u7684\u200b\u5185\u6838\u200b\u4e2d\u200b\uff0c</p> <p>Pinctrl\u200b\u9a71\u52a8\u200b\u4e2d\u200b\u5e76\u200b\u6ca1\u6709\u200b\u63d0\u4f9b\u200b<code>pmxops-&gt;gpio_request_enable</code>\u200b\u6216\u200b<code>pmxops-&gt;request</code>\uff0c</p> <p>\u200b\u4e3a\u4ec0\u4e48\u200b\u4e5f\u200b\u53ef\u200b\u4e00\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200bGPIO\u200b\u529f\u80fd\u200b\uff1f</p> <p>\u200b\u5b83\u200b\u7684\u200bgpio_chip\u200b\u7ed3\u6784\u200b\u4f53\u4e2d\u200b\uff0c\u200b\u6709\u200b<code>direction_input</code>\u3001<code>direction_output</code>\uff0c\u200b\u8fd9\u200b2\u200b\u4e2a\u200b\u51fd\u6570\u200b\u7684\u200b\u8c03\u7528\u200b\u5173\u7cfb\u200b\u5982\u4e0b\u200b:</p> <pre><code>direction_output/direction_input\n    pinctrl_gpio_direction\n        ret = pinmux_gpio_direction(pctldev, range, pin, input);\n                    ret = ops-&gt;gpio_set_direction(pctldev, range, pin, input);\n                                stm32_pmx_gpio_set_direction\n                                    stm32_pmx_set_mode  // \u200b\u5b83\u4f1a\u200b\u8bbe\u7f6e\u200b\u5f15\u811a\u200b\u4e3a\u200bGPIO\u200b\u529f\u80fd\u200b                  \n</code></pre>"},{"location":"07_GPIO/10_1/#6-imx6ull","title":"6. IMX6ULL\u200b\u7684\u200b\u7279\u6b8a\u200b\u60c5\u51b5","text":"<p>IMX6ULL\u200b\u4f7f\u7528\u200bGPIO\u200b\u65f6\u200b\u5fc5\u987b\u200b\u8bbe\u7f6e\u200bPinctrl\uff0c\u200b\u5982\u679c\u200b\u4e0d\u200b\u8bbe\u7f6e\u200b\uff0c\u200b\u53ea\u6709\u200b\u90a3\u4e9b\u200b\u9ed8\u8ba4\u200b\u5c31\u662f\u200bGPIO\u200b\u529f\u80fd\u200b\u7684\u200b\u5f15\u811a\u200b\u53ef\u4ee5\u200b\u6b63\u5e38\u200b\u4f7f\u7528\u200b\u3002</p> <p>\u200b\u539f\u56e0\u200b\uff1a</p> <ul> <li>GPIO\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\uff0c\u200b\u6ca1\u6709\u200b<code>gpio-ranges</code></li> <li>Pinctrl\u200b\u9a71\u52a8\u200b\u4e2d\u200b\u5e76\u200b\u6ca1\u6709\u200b\u63d0\u4f9b\u200b<code>pmxops-&gt;gpio_request_enable</code>\u200b\u6216\u200b<code>pmxops-&gt;request</code></li> <li>gpio_chip\u200b\u7ed3\u6784\u200b\u4f53\u4e2d\u200b<code>direction_input</code>\u3001<code>direction_output</code>\uff0c\u200b\u5e76\u200b\u6ca1\u6709\u200b\u914d\u7f6e\u200b\u5f15\u811a\u200b\u4e3a\u200bGPIO\u200b\u529f\u80fd\u200b</li> </ul>"},{"location":"07_GPIO/11_1/","title":"08_GPIO\u200b\u5b50\u7cfb\u7edf\u200b\u7684\u200bsysfs\u200b\u63a5\u53e3","text":""},{"location":"07_GPIO/11_1/#gpiosysfs","title":"GPIO\u200b\u5b50\u7cfb\u7edf\u200b\u7684\u200bsysfs\u200b\u63a5\u53e3","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux 5.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</li> <li>Linux-5.4\\Documentation\\driver-api</li> <li>Linux-5.4\\Documentation\\devicetree\\bindings\\gpio\\gpio.txt</li> <li> <p>Linux-5.4\\drivers\\gpio\\gpiolib-sysfs.c</p> </li> <li> <p>Linux 4.x\u200b\u5185\u6838\u200b\u6587\u6863\u200b</p> </li> <li>Linux-4.9.88\\Documentation\\gpio</li> <li>Linux-4.9.88\\Documentation\\devicetree\\bindings\\gpio\\gpio.txt</li> <li> <p>Linux-4.9.88\\drivers\\gpio\\gpiolib-sysfs.c</p> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u4ee3\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u4e2d\u200b</p> </li> </ul> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\source\\07_GPIO\\04_gpio_use_pinctrl_ok\ndoc_and_source_for_drivers\\STM32MP157\\source\\A7\\07_GPIO\\04_gpio_use_pinctrl_ok\n</code></pre>"},{"location":"07_GPIO/11_1/#1","title":"1. \u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e3a\u200b<code>drivers\\gpio\\gpiolib-sysfs.c</code>\uff0c\u200b\u8fd9\u91cc\u200b\u4e0d\u200b\u6253\u7b97\u200b\u5206\u6790\u200b\u5b83\u200b\u3002</p>"},{"location":"07_GPIO/11_1/#2-sysfs","title":"2. \u200b\u5e38\u7528\u200b\u7684\u200bSYSFS\u200b\u6587\u4ef6","text":""},{"location":"07_GPIO/11_1/#21-gpio","title":"2.1 \u200b\u6709\u200b\u54ea\u4e9b\u200bGPIO\u200b\u63a7\u5236\u5668","text":"<p><code>/sys/bus/gpio/devices</code>\u200b\u76ee\u5f55\u200b\u4e0b\u200b\uff0c\u200b\u5217\u51fa\u200b\u4e86\u200b\u6240\u6709\u200b\u7684\u200bGPIO\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u5982\u4e0b\u200b\u8868\u793a\u200b\u6709\u200b11\u200b\u4e2a\u200bGPIO\u200b\u63a7\u5236\u5668\u200b\uff1a</p> <pre><code>/sys/bus/gpio/devices/gpiochip0\n/sys/bus/gpio/devices/gpiochip1\n/sys/bus/gpio/devices/gpiochip2\n/sys/bus/gpio/devices/gpiochip3\n/sys/bus/gpio/devices/gpiochip4\n/sys/bus/gpio/devices/gpiochip5\n/sys/bus/gpio/devices/gpiochip6\n/sys/bus/gpio/devices/gpiochip7\n/sys/bus/gpio/devices/gpiochip8\n/sys/bus/gpio/devices/gpiochip9\n/sys/bus/gpio/devices/gpiochip10\n</code></pre>"},{"location":"07_GPIO/11_1/#22-gpio","title":"2.2 \u200b\u6bcf\u4e2a\u200bGPIO\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u8be6\u7ec6\u4fe1\u606f","text":"<p><code>/sys/class/gpio/gpiochipXXX</code>\u200b\u4e0b\u200b\uff0c\u200b\u6709\u200b\u8fd9\u4e9b\u200b\u4fe1\u606f\u200b\uff1a</p> <pre><code>/sys/class/gpio/gpiochip508]# ls -1\nbase     // \u200b\u8fd9\u4e2a\u200bGPIO\u200b\u63a7\u5236\u5668\u200b\u7684\u200bGPIO\u200b\u7f16\u53f7\u200b\ndevice\nlabel    // \u200b\u540d\u5b57\u200b\nngpio    // \u200b\u5f15\u811a\u200b\u4e2a\u6570\u200b\npower\nsubsystem\nuevent\n</code></pre>"},{"location":"07_GPIO/11_1/#23-gpio","title":"2.3 \u200b\u67e5\u770b\u200bGPIO\u200b\u4f7f\u7528\u200b\u60c5\u51b5","text":"<pre><code>cat /sys/kernel/debug/gpio\n</code></pre>"},{"location":"07_GPIO/11_1/#24-sysfsgpio","title":"2.4 \u200b\u901a\u8fc7\u200bSYSFS\u200b\u4f7f\u7528\u200bGPIO","text":"<p>\u200b\u5982\u679c\u200b\u53ea\u662f\u200b\u7b80\u5355\u200b\u7684\u200b\u5f15\u811a\u200b\u63a7\u5236\u200b(\u200b\u6bd4\u5982\u200b\u8f93\u51fa\u200b\u3001\u200b\u67e5\u8be2\u200b\u8f93\u5165\u200b\u503c\u200b)\uff0c\u200b\u53ef\u4ee5\u200b\u4e0d\u200b\u7f16\u5199\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u3002</p> <p>\u200b\u4f46\u662f\u200b\u6d89\u53ca\u200b\u4e2d\u65ad\u200b\u7684\u8bdd\u200b\uff0c\u200b\u5c31\u200b\u9700\u8981\u200b\u7f16\u5199\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e86\u200b\u3002</p>"},{"location":"07_GPIO/11_1/#1-gpio","title":"1. \u200b\u786e\u5b9a\u200bGPIO\u200b\u7f16\u53f7","text":"<p>\u200b\u67e5\u770b\u200b\u6bcf\u4e2a\u200b<code>/sys/class/gpio/gpiochipXXX</code>\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u7684\u200blabel\uff0c\u200b\u786e\u5b9a\u200b\u662f\u200b\u4f60\u200b\u8981\u200b\u7528\u200b\u7684\u200bGPIO\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u4e5f\u200b\u79f0\u4e3a\u200bGPIO Bank\u3002</p> <p>\u200b\u6839\u636e\u200b\u5b83\u200b\u540d\u5b57\u200bgpiochipXXX\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200b\u57fa\u503c\u200b\u662f\u200bXXX\u3002</p> <p>\u200b\u57fa\u503c\u200b\u52a0\u4e0a\u200b\u5f15\u811a\u200boffset\uff0c\u200b\u5c31\u662f\u200b\u8fd9\u4e2a\u200b\u5f15\u811a\u200b\u7684\u200b\u7f16\u53f7\u200b\u3002</p>"},{"location":"07_GPIO/11_1/#2","title":"2. \u200b\u5bfc\u51fa\u200b/\u200b\u8bbe\u7f6e\u200b\u65b9\u5411\u200b/\u200b\u8bfb\u5199\u200b\u503c","text":"<p>\u200b\u4e3e\u4f8b\u200b\uff1a</p> <pre><code>echo 509 &gt; /sys/class/gpio/export\necho out &gt; /sys/class/gpio/gpio509/direction\necho 1 &gt; /sys/class/gpio/gpio509/value\necho 509 &gt; /sys/class/gpio/unexport\n\necho 509 &gt; /sys/class/gpio/export\necho in &gt; /sys/class/gpio/gpio509/direction\ncat /sys/class/gpio/gpio509/value\necho 509 &gt; /sys/class/gpio/unexport\n</code></pre>"},{"location":"08_Interrupt/08_1/","title":"01_\u200b\u4e2d\u65ad\u200b\u76f8\u5173\u200b\u7684\u200b\u5176\u4ed6\u200b\u9a71\u52a8\u7a0b\u5e8f","text":""},{"location":"08_Interrupt/08_1/#_1","title":"\u4e2d\u65ad\u200b\u76f8\u5173\u200b\u7684\u200b\u5176\u4ed6\u200b\u9a71\u52a8\u7a0b\u5e8f","text":""},{"location":"08_Interrupt/08_1/#1","title":"1. \u200b\u6982\u8ff0","text":"<p>\u200b\u6709\u200b\u4e86\u200b\u4e2d\u65ad\u200b\u4e4b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5b9e\u73b0\u200b\u5f88\u591a\u200b\u529f\u80fd\u200b\uff0c\u200b\u6216\u8005\u8bf4\u200b\u8fd9\u4e9b\u200b\u529f\u80fd\u200b\u8ddf\u200b\u4e2d\u65ad\u200b\u7684\u200b\u5173\u7cfb\u200b\u6bd4\u8f83\u200b\u5bc6\u5207\u200b\u3002</p> <p>\u200b\u6bd4\u5982\u200b\uff1a</p> <ul> <li>\u200b\u4f11\u7720\u200b\u4e0e\u200b\u5524\u9192\u200b</li> <li>POLL\u200b\u673a\u5236\u200b</li> <li>\u200b\u5f02\u6b65\u200b\u901a\u77e5\u200b</li> <li>\u200b\u963b\u585e\u200b\u4e0e\u975e\u200b\u963b\u585e\u200b</li> <li>\u200b\u5b9a\u65f6\u5668\u200b</li> <li>\u200b\u4e2d\u65ad\u200b\u4e0b\u200b\u534a\u90e8\u200btasklet</li> <li>\u200b\u5de5\u4f5c\u200b\u961f\u5217\u200b</li> <li>\u200b\u4e2d\u65ad\u200b\u7684\u200b\u7ebf\u7a0b\u200b\u5316\u200b\u5904\u7406\u200b</li> </ul> <p>\u200b\u8fd9\u4e9b\u200b\u89c6\u9891\u200b\uff0c\u200b\u5728\u200b**Linux\u200b\u9a71\u52a8\u200b\u57fa\u7840\u200b**\u200b\u7684\u200b\u89c6\u9891\u200b\u91cc\u200b\u90fd\u200b\u8bb2\u200b\u8fc7\u200b\uff0c\u200b\u89c6\u9891\u200b\u53ef\u4ee5\u200b\u5728\u200bhttp://www.100ask.net\u200b\u770b\u5230\u200b\uff1a</p> <p></p> <p>\u200b\u914d\u5957\u200b\u7684\u200b\u6e90\u7801\u200b\u3001\u200b\u6587\u6863\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff1a</p> <pre><code>git clone https://e.coding.net/weidongshan/01_all_series_quickstart.git\n</code></pre>"},{"location":"08_Interrupt/09_1/","title":"\u4e2d\u65ad\u200b\u7684\u200b\u786c\u4ef6\u200b\u6846\u67b6","text":""},{"location":"08_Interrupt/09_1/#11-3","title":"1.1 \u200b\u4e2d\u65ad\u200b\u8def\u5f84\u200b\u4e0a\u200b\u7684\u200b3\u200b\u4e2a\u200b\u90e8\u4ef6","text":"<ul> <li>\u200b\u4e2d\u65ad\u200b\u6e90\u200b   \u200b\u4e2d\u65ad\u200b\u6e90\u200b\u591a\u79cd\u591a\u6837\u200b\uff0c\u200b\u6bd4\u5982\u200bGPIO\u3001\u200b\u5b9a\u65f6\u5668\u200b\u3001UART\u3001DMA\u200b\u7b49\u7b49\u200b\u3002   \u200b\u5b83\u4eec\u200b\u90fd\u200b\u6709\u200b\u81ea\u5df1\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u8fdb\u884c\u200b\u76f8\u5173\u200b\u8bbe\u7f6e\u200b\uff1a\u200b\u4f7f\u80fd\u200b\u4e2d\u65ad\u200b\u3001\u200b\u4e2d\u65ad\u200b\u72b6\u6001\u200b\u3001\u200b\u4e2d\u65ad\u200b\u7c7b\u578b\u200b\u7b49\u7b49\u200b\u3002</li> <li>\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b   \u200b\u5404\u79cd\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u53d1\u51fa\u200b\u7684\u200b\u4e2d\u65ad\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u6c47\u805a\u200b\u5230\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u3002   \u200b\u53ef\u4ee5\u200b\u5728\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u4e2d\u200b\u8bbe\u7f6e\u200b\u5404\u4e2a\u200b\u4e2d\u65ad\u200b\u7684\u200b\u4f18\u5148\u7ea7\u200b\u3002   \u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u4f1a\u200b\u5411\u200bCPU\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u4fe1\u53f7\u200b\uff0cCPU\u200b\u53ef\u4ee5\u200b\u8bfb\u53d6\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u5224\u65ad\u200b\u5f53\u524d\u200b\u5904\u7406\u200b\u7684\u200b\u662f\u200b\u54ea\u4e2a\u200b\u4e2d\u65ad\u200b\u3002   \u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u6709\u200b\u591a\u79cd\u200b\u5b9e\u73b0\u200b\uff0c\u200b\u6bd4\u5982\u200b\uff1a</li> <li>STM32F103\u200b\u4e2d\u200b\u88ab\u200b\u79f0\u4e3a\u200bNVIC\uff1aNested vectored interrupt controller(\u200b\u5d4c\u5957\u200b\u5411\u91cf\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b)</li> <li>ARM9\u200b\u4e2d\u200b\u4e00\u822c\u200b\u662f\u200b\u82af\u7247\u200b\u5382\u5bb6\u200b\u81ea\u5df1\u200b\u5b9e\u73b0\u200b\u7684\u200b\uff0c\u200b\u6ca1\u6709\u200b\u7edf\u4e00\u6807\u51c6\u200b</li> <li>Cortex A7\u200b\u4e2d\u200b\u4f7f\u7528\u200bGIC(Generic Interrupt Controller)</li> <li>CPU   CPU\u200b\u6bcf\u200b\u6267\u884c\u200b\u5b8c\u200b\u4e00\u6761\u200b\u6307\u4ee4\u200b\uff0c\u200b\u90fd\u200b\u4f1a\u200b\u5224\u65ad\u200b\u4e00\u4e0b\u200b\u662f\u5426\u200b\u6709\u200b\u4e2d\u65ad\u200b\u53d1\u751f\u200b\u4e86\u200b\u3002   CPU\u200b\u4e5f\u200b\u6709\u200b\u81ea\u5df1\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u8bbe\u7f6e\u200b\u5b83\u200b\u6765\u200b\u4f7f\u200b\u80fd\u200b/\u200b\u7981\u6b62\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u8fd9\u662f\u200b\u4e2d\u65ad\u200b\u5904\u7406\u200b\u7684\u200b\u603b\u5f00\u5173\u200b\u3002</li> </ul>"},{"location":"08_Interrupt/09_1/#12-stm32f103gpio","title":"1.2 STM32F103\u200b\u7684\u200bGPIO\u200b\u4e2d\u65ad","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a<code>STM32F103\u200b\u6570\u636e\u200b\u624b\u518c\u200b.pdf</code>\u3001<code>ARM Cortex-M3\u200b\u4e0e\u200bCortex-M4\u200b\u6743\u5a01\u200b\u6307\u5357\u200b.pdf</code>\u3001<code>PM0056.pdf</code></p> <p>\u200b\u5bf9\u4e8e\u200bGPIO\u200b\u4e2d\u65ad\u200b\uff0cSTM32F103\u200b\u53c8\u200b\u5f15\u5165\u200b\u4e86\u200b<code>External interrupt/event controller (EXTI)</code>\u3002 \u200b\u7528\u6765\u200b\u8bbe\u7f6e\u200bGPIO\u200b\u7684\u200b\u4e2d\u65ad\u200b\u7c7b\u578b\u200b\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\uff1a</p> <p></p> <p>EXTI\u200b\u53ef\u4ee5\u200b\u7ed9\u200bNVIC\u200b\u63d0\u4f9b\u200b16\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\u4fe1\u53f7\u200b\uff1aEXTI0~EXTI15\u3002 \u200b\u90a3\u4e48\u200b\u67d0\u4e2a\u200bEXTIx\uff0c\u200b\u5b83\u200b\u6765\u81ea\u200b\u54ea\u4e9b\u200bGPIO\u200b\u5462\u200b\uff1f\u200b\u8fd9\u200b\u9700\u8981\u200b\u8bbe\u7f6e\u200bGPIO\u200b\u63a7\u5236\u5668\u200b\u3002</p>"},{"location":"08_Interrupt/09_1/#121-gpio","title":"1.2.1 GPIO\u200b\u63a7\u5236\u5668","text":"<p>STM32F103\u200b\u7684\u200bGPIO\u200b\u63a7\u5236\u5668\u200b\u4e2d\u6709\u200bAFIO_EXTICR1~AFIO_EXTICR4\u200b\u4e00\u5171\u200b4\u200b\u4e2a\u200b\u5bc4\u5b58\u5668\u200b \u200b\u540d\u4e3a\u200b\uff1aExternal interrupt configuration register\uff0c\u200b\u5916\u90e8\u200b\u4e2d\u65ad\u200b\u914d\u7f6e\u200b\u5bc4\u5b58\u5668\u200b\u3002 \u200b\u7528\u6765\u200b\u9009\u62e9\u200b\u67d0\u4e2a\u200b\u5916\u90e8\u200b\u4e2d\u65ad\u200bEXTIx\u200b\u7684\u200b\u4e2d\u65ad\u200b\u6e90\u200b\uff0c\u200b\u793a\u4f8b\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u6ce8\u610f\u200b\uff1a\u200b\u4ece\u200b\u4e0a\u200b\u56fe\u200b\u53ef\u77e5\u200b\uff0cEXTI0\u200b\u53ea\u80fd\u200b\u4ece\u200bPA0\u3001\u2026\u2026\u3001PG0\u200b\u4e2d\u200b\u9009\u62e9\u200b\u4e00\u4e2a\u200b\uff0c\u200b\u8fd9\u200b\u4e5f\u200b\u610f\u5473\u7740\u200bPA0\u3001\u2026\u2026\u3001PG0\u200b\u4e2d\u200b\u53ea\u6709\u200b\u4e00\u4e2a\u200b\u5f15\u811a\u200b\u53ef\u4ee5\u200b\u7528\u4e8e\u200b\u4e2d\u65ad\u200b\u3002\u200b\u8fd9\u200b\u8ddf\u200b\u5176\u4ed6\u200b\u82af\u7247\u200b\u4e0d\u200b\u4e00\u6837\u200b\uff0c\u200b\u5f88\u591a\u200b\u82af\u7247\u200b\u7684\u200b\u4efb\u4e00\u200bGPIO\u200b\u5f15\u811a\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u540c\u65f6\u200b\u7528\u4e8e\u200b\u4e2d\u65ad\u200b\u3002 </p>"},{"location":"08_Interrupt/09_1/#122-exti","title":"1.2.2 EXTI","text":"<p>\u200b\u5728\u200bGPIO\u200b\u63a7\u5236\u5668\u200b\u4e2d\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u8bbe\u7f6e\u200b\u67d0\u4e2a\u200bGPIO\u200b\u5f15\u811a\u200b\u4f5c\u4e3a\u200b\u4e2d\u65ad\u200b\u6e90\u200b\uff0c\u200b\u7ed9\u200bEXTI\u200b\u63d0\u4f9b\u200b\u4e2d\u65ad\u200b\u4fe1\u53f7\u200b\u3002 \u200b\u4f46\u662f\u200b\uff0c\u200b\u8fd9\u4e2a\u200b\u4e2d\u65ad\u200b\u7684\u200b\u89e6\u53d1\u200b\u65b9\u5f0f\u200b\u662f\u200b\u600e\u4e48\u200b\u7684\u200b\uff1f\u200b\u9ad8\u7535\u5e73\u200b\u89e6\u53d1\u200b\u3001\u200b\u4f4e\u7535\u5e73\u200b\u89e6\u53d1\u200b\u3001\u200b\u4e0a\u5347\u200b\u6cbf\u200b\u89e6\u53d1\u200b\u3001\u200b\u4e0b\u964d\u200b\u6cbf\u200b\u89e6\u53d1\u200b\uff1f \u200b\u8fd9\u200b\u9700\u8981\u200b\u8fdb\u4e00\u6b65\u200b\u8bbe\u7f6e\u200b\u3002 EXTI\u200b\u6846\u56fe\u200b\u5982\u4e0b\u200b\uff1a </p> <p>\u200b\u6cbf\u7740\u200b\u4e0a\u9762\u200b\u6846\u56fe\u200b\u4e2d\u200b\u7684\u200b\u7ea2\u7ebf\u200b\uff0c\u200b\u6211\u4eec\u200b\u8981\u200b\u8bbe\u7f6e\u200b\uff1a</p> <ul> <li>Falling trigger selection register\uff1a\u200b\u662f\u5426\u200b\u9009\u62e9\u200b\u4e0b\u964d\u200b\u6cbf\u200b\u89e6\u53d1\u200b</li> <li>Rising trigger selection register\uff1a\u200b\u662f\u5426\u200b\u9009\u62e9\u200b\u4e0a\u5347\u200b\u6cbf\u200b\u89e6\u53d1\u200b</li> <li>Interrupt mask register\uff1a\u200b\u662f\u5426\u200b\u5c4f\u853d\u200b\u4e2d\u65ad\u200b</li> </ul> <p>\u200b\u5f53\u200b\u53d1\u751f\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u8bfb\u53d6\u200b\u4e0b\u5217\u200b\u5bc4\u5b58\u5668\u200b\u5224\u65ad\u200b\u662f\u5426\u200b\u53d1\u751f\u200b\u4e86\u200b\u4e2d\u65ad\u200b\u3001\u200b\u53d1\u751f\u200b\u4e86\u200b\u54ea\u4e2a\u200b\u4e2d\u65ad\u200b\uff1a</p> <ul> <li>Pending reqeust register</li> </ul> <p>\u200b\u8981\u200b\u4f7f\u7528\u200bEXTI\uff0c\u200b\u6d41\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u7ffb\u8bd1\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u914d\u7f6e\u200bEXTI_IMR\uff1a\u200b\u5141\u8bb8\u200bEXTI\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b</li> <li>\u200b\u914d\u7f6e\u200bEXTI_RTSR\u3001EXTI_FTSR\uff0c\u200b\u9009\u62e9\u200b\u4e2d\u65ad\u200b\u89e6\u53d1\u200b\u65b9\u5f0f\u200b</li> <li>\u200b\u914d\u7f6e\u200bNVIC\u200b\u4e2d\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u5141\u8bb8\u200bNVIC\u200b\u628a\u200b\u4e2d\u65ad\u200b\u53d1\u7ed9\u200bCPU</li> </ul>"},{"location":"08_Interrupt/09_1/#123-nvic","title":"1.2.3 NVIC","text":"<p>\u200b\u591a\u4e2a\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u6c47\u805a\u200b\u5230\u200bNVIC\uff0cNVIC\u200b\u7684\u200b\u804c\u8d23\u200b\u5c31\u200b\u662f\u4ece\u200b\u591a\u4e2a\u200b\u4e2d\u65ad\u200b\u6e90\u4e2d\u200b\u53d6\u51fa\u200b\u4f18\u5148\u7ea7\u200b\u6700\u9ad8\u200b\u7684\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5411\u200bCPU\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u4fe1\u53f7\u200b\u3002 \u200b\u5904\u7406\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u7a0b\u5e8f\u200b\u53ef\u4ee5\u200b\u5199\u200bNVIC\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u6e05\u9664\u200b\u4e2d\u65ad\u200b\u3002 \u200b\u6d89\u53ca\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\uff1a </p> <p>\u200b\u6211\u4eec\u200b\u6682\u65f6\u200b\u53ea\u200b\u9700\u8981\u200b\u5173\u6ce8\u200b\uff1aISER(\u200b\u4e2d\u65ad\u200b\u8bbe\u7f6e\u200b\u4f7f\u80fd\u200b\u5bc4\u5b58\u5668\u200b)\u3001ICPR(\u200b\u4e2d\u65ad\u200b\u6e05\u9664\u200b\u6302\u200b\u8d77\u200b\u5bc4\u5b58\u5668\u200b)\u3002 \u200b\u8981\u200b\u6ce8\u610f\u200b\u7684\u200b\u662f\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u5bc4\u5b58\u5668\u200b\u6709\u200b\u5f88\u591a\u200b\u4e2a\u200b\uff0c\u200b\u6bd4\u5982\u200bISER0\u3001ISER1\u200b\u7b49\u7b49\u200b\u3002\u200b\u91cc\u9762\u200b\u7684\u200b\u6bcf\u200b\u4e00\u4f4d\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\u3002 ISER0\u200b\u4e2d\u200b\u7684\u200bbit0\u200b\u5bf9\u5e94\u200b\u5f02\u5e38\u200b\u5411\u91cf\u200b\u8868\u4e2d\u200b\u7684\u200b\u7b2c\u200b16\u200b\u9879\u200b(\u200b\u5411\u91cf\u200b\u8868\u4ece\u200b\u7b2c\u200b0\u200b\u9879\u200b\u5f00\u59cb\u200b)\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\uff1a</p> <p></p>"},{"location":"08_Interrupt/09_1/#124-cpu","title":"1.2.4 CPU","text":"<p>cortex M3/M4\u200b\u5904\u7406\u5668\u200b\u5185\u90e8\u200b\u6709\u200b\u8fd9\u200b\u51e0\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\uff1a</p>"},{"location":"08_Interrupt/09_1/#1-primask","title":"1. PRIMASK","text":"<p>\u200b\u628a\u200bPRIMASK\u200b\u7684\u200bbit0\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b1\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u5c4f\u853d\u200b\u6240\u6709\u200b**\u200b\u4f18\u5148\u7ea7\u200b\u53ef\u200b\u914d\u7f6e\u200b**\u200b\u7684\u200b\u4e2d\u65ad\u200b\u3002   \u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u8fd9\u4e9b\u200b\u6307\u4ee4\u200b\u6765\u200b\u8bbe\u7f6e\u200b\u5b83\u200b\uff1a</p> <pre><code>CPSIE I  ; \u200b\u6e05\u9664\u200bPRIMASK\uff0c\u200b\u4f7f\u80fd\u200b\u4e2d\u65ad\u200b\nCPSID I  ; \u200b\u8bbe\u7f6e\u200bPRIMASK\uff0c\u200b\u7981\u6b62\u200b\u4e2d\u65ad\u200b\n\n\u200b\u6216\u8005\u200b\uff1a\nMOV R0, #1\nMSR  PRIMASK R0  ; \u200b\u5c06\u200b1\u200b\u5199\u5165\u200bPRIMASK\u200b\u7981\u6b62\u200b\u6240\u6709\u200b\u4e2d\u65ad\u200b\n\nMOV R0, #0\nMSR PRIMASK, R0  ; \u200b\u5c06\u200b0\u200b\u5199\u5165\u200bPRIMASK\u200b\u4f7f\u80fd\u200b\u6240\u6709\u200b\u4e2d\u65ad\u200b\n</code></pre>"},{"location":"08_Interrupt/09_1/#2-faultmask","title":"2. FAULTMASK","text":"<p>FAULTMASK\u200b\u548c\u200bPRIMASK\u200b\u5f88\u200b\u50cf\u200b\uff0c\u200b\u5b83\u200b\u66f4\u8fdb\u4e00\u6b65\u200b\uff0c\u200b\u51fa\u6765\u200b\u4e00\u822c\u200b\u7684\u200b\u4e2d\u65ad\u200b\u5916\u200b\uff0c\u200b\u628a\u200bHardFault\u200b\u90fd\u200b\u7981\u6b62\u200b\u4e86\u200b\u3002   \u200b\u53ea\u6709\u200bNMI\u200b\u53ef\u4ee5\u200b\u53d1\u751f\u200b\u3002   \u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u8fd9\u4e9b\u200b\u6307\u4ee4\u200b\u6765\u200b\u8bbe\u7f6e\u200b\u5b83\u200b\uff1a</p> <pre><code>CPSIE F  ; \u200b\u6e05\u9664\u200bFAULTMASK\nCPSID F  ; \u200b\u8bbe\u7f6e\u200bFAULTMASK\n\n\u200b\u6216\u8005\u200b\uff1a\nMOV R0, #1\nMSR  FAULTMASK R0  ; \u200b\u5c06\u200b1\u200b\u5199\u5165\u200bFAULTMASK\u200b\u7981\u6b62\u200b\u4e2d\u65ad\u200b\n\nMOV R0, #0\nMSR FAULTMASK, R0  ; \u200b\u5c06\u200b0\u200b\u5199\u5165\u200bFAULTMASK\u200b\u4f7f\u80fd\u200b\u4e2d\u65ad\u200b\n</code></pre>"},{"location":"08_Interrupt/09_1/#3-basepri","title":"3. BASEPRI","text":"<p>BASEPRI\u200b\u7528\u6765\u200b\u5c4f\u853d\u200b\u8fd9\u4e9b\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u5b83\u4eec\u200b\u7684\u200b\u4f18\u5148\u7ea7\u200b\uff0c\u200b\u5176\u503c\u200b\u5927\u4e8e\u200b\u6216\u200b\u7b49\u4e8e\u200bBASEPRI\u3002   \u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u8fd9\u4e9b\u200b\u6307\u4ee4\u200b\u6765\u200b\u8bbe\u7f6e\u200b\u5b83\u200b\uff1a</p> <pre><code>MOVS R0, #0x60\nMSR BASEPRI, R0   ; \u200b\u7981\u6b62\u200b\u4f18\u5148\u7ea7\u200b\u5728\u200b0x60~0xFF\u200b\u95f4\u200b\u7684\u200b\u4e2d\u65ad\u200b\n\nMRS R0, BASEPRI   ; \u200b\u8bfb\u53d6\u200bBASEPRI\n\nMOVS R0, #0\nMSR BASEPRI, R0    ; \u200b\u53d6\u6d88\u200bBASEPRI\u200b\u5c4f\u853d\u200b\n</code></pre>"},{"location":"08_Interrupt/09_1/#13-stm32mp157gpio","title":"1.3 STM32MP157\u200b\u7684\u200bGPIO\u200b\u4e2d\u65ad","text":"<p>STM32MP157\u200b\u7684\u200bGPIO\u200b\u4e2d\u65ad\u200b\u5728\u200b\u786c\u4ef6\u200b\u4e0a\u200b\u7684\u200b\u6846\u67b6\u200b\uff0c\u200b\u8ddf\u200bSTM32F103\u200b\u662f\u200b\u7c7b\u4f3c\u200b\u7684\u200b\u3002 \u200b\u5b83\u4eec\u200b\u7684\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u4e0d\u200b\u4e00\u6837\u200b\uff0cSTM32MP157\u200b\u4e2d\u200b\u4f7f\u7528\u200b\u7684\u200b\u662f\u200bGIC\uff1a </p>"},{"location":"08_Interrupt/09_1/#131-gpio","title":"1.3.1 GPIO\u200b\u63a7\u5236\u5668","text":"<p>\u200b\u5bf9\u4e8e\u200bSTM32MP157\uff0c\u200b\u9664\u4e86\u200b\u628a\u200bGPIO\u200b\u5f15\u811a\u200b\u914d\u7f6e\u200b\u4e3a\u200b\u8f93\u5165\u200b\u529f\u80fd\u200b\u5916\u200b\uff0cGPIO\u200b\u63a7\u5236\u5668\u200b\u91cc\u200b\u6ca1\u6709\u200b\u4e2d\u65ad\u200b\u76f8\u5173\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u3002 \u200b\u8bf7\u200b\u53c2\u8003\u200b\u524d\u9762\u200b\u7684\u200b\u8bfe\u7a0b\u200b\u300a01_\u200b\u4f7f\u7528\u200b\u6309\u952e\u200b\u63a7\u5236\u200bLED(STM32MP157)\u300b\u3002</p>"},{"location":"08_Interrupt/09_1/#132-exti","title":"1.3.2 EXTI","text":"<p>GPIO\u200b\u5f15\u811a\u200b\u53ef\u4ee5\u200b\u5411\u200bCPU\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u6240\u6709\u200b\u7684\u200bGPIO\u200b\u5f15\u811a\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u5417\u200b\uff1f \u200b\u4e0d\u662f\u200b\u7684\u200b\uff0c\u200b\u9700\u8981\u200b\u5728\u200bEXTI\u200b\u63a7\u5236\u5668\u200b\u4e2d\u200b\u8bbe\u7f6e\u200b\u3001\u200b\u9009\u62e9\u200b\u3002 GPIO\u200b\u5f15\u811a\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\u7684\u200b\u65b9\u5f0f\u200b\u662f\u200b\u600e\u6837\u200b\u7684\u200b\uff1f\u200b\u9ad8\u7535\u5e73\u200b\u89e6\u53d1\u200b\u3001\u200b\u4f4e\u7535\u5e73\u200b\u89e6\u53d1\u200b\u3001\u200b\u4e0a\u5347\u200b\u6cbf\u200b\u89e6\u53d1\u200b\u3001\u200b\u4e0b\u964d\u200b\u6cbf\u200b\u89e6\u53d1\u200b\uff1f \u200b\u8fd9\u200b\u9700\u8981\u200b\u8fdb\u4e00\u6b65\u200b\u8bbe\u7f6e\u200b\u3002 \u200b\u8fd9\u4e9b\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u5728\u200bEXTI\u200b\u4e2d\u200b\u914d\u7f6e\u200b\uff0cEXTI\u200b\u6846\u56fe\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u6cbf\u7740\u200b\u7ea2\u7ebf\u200b\u8d70\u200b\uff1a</p>"},{"location":"08_Interrupt/09_1/#1-extimux","title":"1. \u200b\u8bbe\u7f6e\u200b<code>EXTImux</code>","text":"<p>\u200b\u9009\u62e9\u200b\u54ea\u4e9b\u200bGPIO\u200b\u53ef\u4ee5\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u3002 \u200b\u53ea\u6709\u200b16\u200b\u4e2a\u200bEXTI\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u4ece\u200bEXTI0~EXTI15\uff1b\u200b\u6bcf\u4e2a\u200bEXTIx\u200b\u4e2d\u65ad\u200b\u53ea\u80fd\u200b\u4ece\u200bPAx\u3001PBx\u3001\u2026\u2026\u200b\u4e2d\u200b\u9009\u62e9\u200b\u67d0\u4e2a\u200b\u5f15\u811a\u200b\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b\uff1a </p> <p>\u200b\u6ce8\u610f\u200b\uff1a\u200b\u4ece\u200b\u4e0a\u200b\u56fe\u200b\u53ef\u77e5\u200b\uff0cEXTI0\u200b\u53ea\u80fd\u200b\u4ece\u200bPA0\u3001\u2026\u2026\u200b\u4e2d\u200b\u9009\u62e9\u200b\u4e00\u4e2a\u200b\uff0c\u200b\u8fd9\u200b\u4e5f\u200b\u610f\u5473\u7740\u200bPA0\u3001\u2026\u2026\u200b\u4e2d\u200b\u53ea\u6709\u200b\u4e00\u4e2a\u200b\u5f15\u811a\u200b\u53ef\u4ee5\u200b\u7528\u4e8e\u200b\u4e2d\u65ad\u200b\u3002\u200b\u8fd9\u200b\u8ddf\u200b\u5176\u4ed6\u200b\u82af\u7247\u200b\u4e0d\u200b\u4e00\u6837\u200b\uff0c\u200b\u5f88\u591a\u200b\u82af\u7247\u200b\u7684\u200b\u4efb\u4e00\u200bGPIO\u200b\u5f15\u811a\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u540c\u65f6\u200b\u7528\u4e8e\u200b\u4e2d\u65ad\u200b\u3002</p> <p>\u200b\u901a\u8fc7\u200bEXTI_EXTICR1\u200b\u7b49\u200b\u5bc4\u5b58\u5668\u200b\u6765\u200b\u8bbe\u7f6e\u200bEXTIx\u200b\u7684\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u662f\u200b\u54ea\u4e2a\u200bGPIO\u200b\u5f15\u811a\u200b\uff0c\u200b\u5165\u200b\u4e0b\u56fe\u200b\u6240\u793a\u200b\uff1a</p> <p></p>"},{"location":"08_Interrupt/09_1/#2-event-trigger","title":"2. \u200b\u8bbe\u7f6e\u200b<code>Event Trigger</code>","text":"<p>\u200b\u8bbe\u7f6e\u200b\u4e2d\u65ad\u200b\u89e6\u53d1\u200b\u65b9\u5f0f\u200b\uff1a</p> <p></p>"},{"location":"08_Interrupt/09_1/#3-masking","title":"3. \u200b\u8bbe\u7f6e\u200b<code>Masking</code>","text":"<p>\u200b\u5141\u8bb8\u200b\u67d0\u4e2a\u200bEXTI\u200b\u4e2d\u65ad\u200b\uff1a</p> <p></p>"},{"location":"08_Interrupt/09_1/#4","title":"4. \u200b\u67e5\u770b\u200b\u4e2d\u65ad\u200b\u72b6\u6001\u200b\u3001\u200b\u6e05\u200b\u4e2d\u65ad","text":""},{"location":"08_Interrupt/09_1/#133-gic","title":"1.3.3 GIC","text":"<p>ARM\u200b\u4f53\u7cfb\u7ed3\u6784\u200b\u5b9a\u4e49\u200b\u4e86\u200b\u901a\u7528\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\uff08GIC\uff09\uff0c\u200b\u8be5\u200b\u63a7\u5236\u5668\u200b\u5305\u62ec\u200b\u4e00\u7ec4\u200b\u7528\u4e8e\u200b\u7ba1\u7406\u200b\u5355\u6838\u200b\u6216\u200b\u591a\u200b\u6838\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\u7684\u200b\u4e2d\u65ad\u200b\u7684\u200b\u786c\u4ef6\u8d44\u6e90\u200b\u3002GIC\u200b\u63d0\u4f9b\u200b\u4e86\u200b\u5185\u5b58\u200b\u6620\u5c04\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u53ef\u200b\u7528\u4e8e\u200b\u7ba1\u7406\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u548c\u200b\u884c\u4e3a\u200b\uff0c\u200b\u4ee5\u53ca\u200b\uff08\u200b\u5728\u200b\u591a\u200b\u6838\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\uff09\u200b\u7528\u4e8e\u200b\u5c06\u200b\u4e2d\u65ad\u200b\u8def\u7531\u200b\u5230\u200b\u5404\u4e2a\u200bCPU\u200b\u6838\u200b\u3002\u200b\u5b83\u200b\u4f7f\u200b\u8f6f\u4ef6\u200b\u80fd\u591f\u200b\u5c4f\u853d\u200b\uff0c\u200b\u542f\u7528\u200b\u548c\u200b\u7981\u7528\u200b\u6765\u81ea\u200b\u5404\u4e2a\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u7684\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u4ee5\u200b\uff08\u200b\u5728\u200b\u786c\u4ef6\u200b\u4e2d\u200b\uff09\u200b\u5bf9\u200b\u5404\u4e2a\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u8fdb\u884c\u200b\u4f18\u5148\u7ea7\u200b\u6392\u5e8f\u200b\u548c\u200b\u751f\u6210\u200b\u8f6f\u4ef6\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\u3002\u200b\u5b83\u200b\u8fd8\u200b\u63d0\u4f9b\u200b\u5bf9\u200bTrustZone\u200b\u5b89\u5168\u6027\u200b\u6269\u5c55\u200b\u7684\u200b\u652f\u6301\u200b\u3002GIC\u200b\u63a5\u53d7\u200b\u7cfb\u7edf\u200b\u7ea7\u522b\u200b\u4e2d\u65ad\u200b\u7684\u200b\u4ea7\u751f\u200b\uff0c\u200b\u5e76\u200b\u53ef\u4ee5\u200b\u53d1\u4fe1\u53f7\u200b\u901a\u77e5\u200b\u7ed9\u200b\u5b83\u200b\u6240\u200b\u8fde\u63a5\u200b\u7684\u200b\u6bcf\u4e2a\u200b\u5185\u6838\u200b\uff0c\u200b\u4ece\u800c\u200b\u6709\u200b\u53ef\u80fd\u200b\u5bfc\u81f4\u200bIRQ\u200b\u6216\u200bFIQ\u200b\u5f02\u5e38\u200b\u53d1\u751f\u200b\u3002</p> <p>GIC\u200b\u6bd4\u8f83\u590d\u6742\u200b\uff0c\u200b\u4e0b\u200b\u4e00\u4e2a\u200b\u89c6\u9891\u200b\u518d\u200b\u8be6\u7ec6\u200b\u8bb2\u89e3\u200b\u3002</p>"},{"location":"08_Interrupt/09_1/#134-cpu","title":"1.3.4 CPU","text":"<p>CPU\u200b\u7684\u200bCPSR\u200b\u5bc4\u5b58\u5668\u200b\u4e2d\u6709\u200b\u4e00\u4f4d\u200b\uff1aI\u200b\u4f4d\u200b\uff0c\u200b\u7528\u6765\u200b\u4f7f\u80fd\u200b/\u200b\u7981\u6b62\u200b\u4e2d\u65ad\u200b\u3002 </p> <p>\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u4ee5\u4e0b\u200b\u6c47\u7f16\u200b\u6307\u4ee4\u200b\u4fee\u6539\u200bI\u200b\u4f4d\u200b\uff1a</p> <pre><code>  CPSIE I  ; \u200b\u6e05\u9664\u200bI\u200b\u4f4d\u200b\uff0c\u200b\u4f7f\u80fd\u200b\u4e2d\u65ad\u200b\n  CPSID I  ; \u200b\u8bbe\u7f6e\u200bI\u200b\u4f4d\u200b\uff0c\u200b\u7981\u6b62\u200b\u4e2d\u65ad\u200b\n</code></pre>"},{"location":"08_Interrupt/09_1/#14-imx6ullgpio","title":"1.4 IMX6ULL\u200b\u7684\u200bGPIO\u200b\u4e2d\u65ad","text":"<p>IMX6ULL\u200b\u7684\u200bGPIO\u200b\u4e2d\u65ad\u200b\u5728\u200b\u786c\u4ef6\u200b\u4e0a\u200b\u7684\u200b\u6846\u67b6\u200b\uff0c\u200b\u8ddf\u200bSTM32MP157\u200b\u662f\u200b\u7c7b\u4f3c\u200b\u7684\u200b\u3002 IMX6ULL\u200b\u4e2d\u200b\u6ca1\u6709\u200bEXTI\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u5bf9\u200bGPIO\u200b\u7684\u200b\u4e2d\u65ad\u200b\u914d\u7f6e\u200b\u3001\u200b\u63a7\u5236\u200b\uff0c\u200b\u90fd\u200b\u5728\u200bGPIO\u200b\u6a21\u5757\u200b\u5185\u90e8\u200b\u5b9e\u73b0\u200b\uff1a</p> <p></p>"},{"location":"08_Interrupt/09_1/#141-gpio","title":"1.4.1 GPIO\u200b\u63a7\u5236\u5668","text":""},{"location":"08_Interrupt/09_1/#1-gpio","title":"1. \u200b\u914d\u7f6e\u200bGPIO\u200b\u4e2d\u65ad","text":"<p>\u200b\u6bcf\u7ec4\u200bGPIO\u200b\u4e2d\u200b\u90fd\u200b\u6709\u200b\u5bf9\u5e94\u200b\u7684\u200bGPIOx_ICR1\u3001GPIOx_ICR2\u200b\u5bc4\u5b58\u5668\u200b(interrupt configuration register )\u3002 \u200b\u6bcf\u4e2a\u200b\u5f15\u811a\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u914d\u7f6e\u200b\u4e3a\u200b\u4e2d\u65ad\u200b\u5f15\u811a\u200b\uff0c\u200b\u5e76\u200b\u914d\u7f6e\u200b\u5b83\u200b\u7684\u200b\u89e6\u53d1\u200b\u65b9\u5f0f\u200b\uff1a </p>"},{"location":"08_Interrupt/09_1/#2-gpio","title":"2. \u200b\u4f7f\u80fd\u200bGPIO\u200b\u4e2d\u65ad","text":""},{"location":"08_Interrupt/09_1/#3","title":"3. \u200b\u5224\u65ad\u200b\u4e2d\u65ad\u200b\u72b6\u6001\u200b\u3001\u200b\u6e05\u200b\u4e2d\u65ad","text":""},{"location":"08_Interrupt/09_1/#142-gic","title":"1.4.2 GIC","text":"<p>ARM\u200b\u4f53\u7cfb\u7ed3\u6784\u200b\u5b9a\u4e49\u200b\u4e86\u200b\u901a\u7528\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\uff08GIC\uff09\uff0c\u200b\u8be5\u200b\u63a7\u5236\u5668\u200b\u5305\u62ec\u200b\u4e00\u7ec4\u200b\u7528\u4e8e\u200b\u7ba1\u7406\u200b\u5355\u6838\u200b\u6216\u200b\u591a\u200b\u6838\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\u7684\u200b\u4e2d\u65ad\u200b\u7684\u200b\u786c\u4ef6\u8d44\u6e90\u200b\u3002GIC\u200b\u63d0\u4f9b\u200b\u4e86\u200b\u5185\u5b58\u200b\u6620\u5c04\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u53ef\u200b\u7528\u4e8e\u200b\u7ba1\u7406\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u548c\u200b\u884c\u4e3a\u200b\uff0c\u200b\u4ee5\u53ca\u200b\uff08\u200b\u5728\u200b\u591a\u200b\u6838\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\uff09\u200b\u7528\u4e8e\u200b\u5c06\u200b\u4e2d\u65ad\u200b\u8def\u7531\u200b\u5230\u200b\u5404\u4e2a\u200bCPU\u200b\u6838\u200b\u3002\u200b\u5b83\u200b\u4f7f\u200b\u8f6f\u4ef6\u200b\u80fd\u591f\u200b\u5c4f\u853d\u200b\uff0c\u200b\u542f\u7528\u200b\u548c\u200b\u7981\u7528\u200b\u6765\u81ea\u200b\u5404\u4e2a\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u7684\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u4ee5\u200b\uff08\u200b\u5728\u200b\u786c\u4ef6\u200b\u4e2d\u200b\uff09\u200b\u5bf9\u200b\u5404\u4e2a\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u8fdb\u884c\u200b\u4f18\u5148\u7ea7\u200b\u6392\u5e8f\u200b\u548c\u200b\u751f\u6210\u200b\u8f6f\u4ef6\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\u3002\u200b\u5b83\u200b\u8fd8\u200b\u63d0\u4f9b\u200b\u5bf9\u200bTrustZone\u200b\u5b89\u5168\u6027\u200b\u6269\u5c55\u200b\u7684\u200b\u652f\u6301\u200b\u3002GIC\u200b\u63a5\u53d7\u200b\u7cfb\u7edf\u200b\u7ea7\u522b\u200b\u4e2d\u65ad\u200b\u7684\u200b\u4ea7\u751f\u200b\uff0c\u200b\u5e76\u200b\u53ef\u4ee5\u200b\u53d1\u4fe1\u53f7\u200b\u901a\u77e5\u200b\u7ed9\u200b\u5b83\u200b\u6240\u200b\u8fde\u63a5\u200b\u7684\u200b\u6bcf\u4e2a\u200b\u5185\u6838\u200b\uff0c\u200b\u4ece\u800c\u200b\u6709\u200b\u53ef\u80fd\u200b\u5bfc\u81f4\u200bIRQ\u200b\u6216\u200bFIQ\u200b\u5f02\u5e38\u200b\u53d1\u751f\u200b\u3002</p> <p>GIC\u200b\u6bd4\u8f83\u590d\u6742\u200b\uff0c\u200b\u4e0b\u200b\u4e00\u4e2a\u200b\u89c6\u9891\u200b\u518d\u200b\u8be6\u7ec6\u200b\u8bb2\u89e3\u200b\u3002</p>"},{"location":"08_Interrupt/09_1/#143-cpu","title":"1.4.3 CPU","text":"<p>CPU\u200b\u7684\u200bCPSR\u200b\u5bc4\u5b58\u5668\u200b\u4e2d\u6709\u200b\u4e00\u4f4d\u200b\uff1aI\u200b\u4f4d\u200b\uff0c\u200b\u7528\u6765\u200b\u4f7f\u80fd\u200b/\u200b\u7981\u6b62\u200b\u4e2d\u65ad\u200b\u3002 </p> <p>\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u4ee5\u4e0b\u200b\u6c47\u7f16\u200b\u6307\u4ee4\u200b\u4fee\u6539\u200bI\u200b\u4f4d\u200b\uff1a</p> <pre><code>  CPSIE I  ; \u200b\u6e05\u9664\u200bI\u200b\u4f4d\u200b\uff0c\u200b\u4f7f\u80fd\u200b\u4e2d\u65ad\u200b\n  CPSID I  ; \u200b\u8bbe\u7f6e\u200bI\u200b\u4f4d\u200b\uff0c\u200b\u7981\u6b62\u200b\u4e2d\u65ad\u200b\n</code></pre>"},{"location":"08_Interrupt/10_1/","title":"GIC\u200b\u4ecb\u7ecd\u200b\u4e0e\u200b\u7f16\u7a0b","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>GIC\u200b\u7684\u200b\u5b98\u65b9\u200b\u6587\u6863\u200b\uff1aGIT\u200b\u4ed3\u5e93\u200b   ```shell doc_and_source_for_drivers\\IMX6ULL\\doc_pic\\08_Interrupt:   doc_and_source_for_drivers\\STM32MP157\\doc_pic\\08_Interrupt:</p> <p>ARM\u00ae Generic Interrupt Controller Architecture Specification Architecture version 2.0(IHI0048B_b_gic_architecture_specification_v2).pdf   ```</p> </li> <li> <p>\u200b\u6e90\u7801\u200b\uff1aGIT\u200b\u4ed3\u5e93\u200b</p> </li> </ul> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\source\\08_Interrupt\\02_gic\ndoc_and_source_for_drivers\\STM32MP157\\source\\A7\\08_Interrupt\\02_gic\n</code></pre>"},{"location":"08_Interrupt/10_1/#11-gic","title":"1.1 GIC\u200b\u4ecb\u7ecd","text":"<p>\u200b   ARM\u200b\u4f53\u7cfb\u7ed3\u6784\u200b\u5b9a\u4e49\u200b\u4e86\u200b\u901a\u7528\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\uff08GIC\uff09\uff0c\u200b\u8be5\u200b\u63a7\u5236\u5668\u200b\u5305\u62ec\u200b\u4e00\u7ec4\u200b\u7528\u4e8e\u200b\u7ba1\u7406\u200b\u5355\u6838\u200b\u6216\u200b\u591a\u200b\u6838\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\u7684\u200b\u4e2d\u65ad\u200b\u7684\u200b\u786c\u4ef6\u8d44\u6e90\u200b\u3002GIC\u200b\u63d0\u4f9b\u200b\u4e86\u200b\u5185\u5b58\u200b\u6620\u5c04\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u53ef\u200b\u7528\u4e8e\u200b\u7ba1\u7406\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u548c\u200b\u884c\u4e3a\u200b\uff0c\u200b\u4ee5\u53ca\u200b\uff08\u200b\u5728\u200b\u591a\u200b\u6838\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\uff09\u200b\u7528\u4e8e\u200b\u5c06\u200b\u4e2d\u65ad\u200b\u8def\u7531\u200b\u5230\u200b\u5404\u4e2a\u200bCPU\u200b\u6838\u200b\u3002\u200b\u5b83\u200b\u4f7f\u200b\u8f6f\u4ef6\u200b\u80fd\u591f\u200b\u5c4f\u853d\u200b\uff0c\u200b\u542f\u7528\u200b\u548c\u200b\u7981\u7528\u200b\u6765\u81ea\u200b\u5404\u4e2a\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u7684\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u4ee5\u200b\uff08\u200b\u5728\u200b\u786c\u4ef6\u200b\u4e2d\u200b\uff09\u200b\u5bf9\u200b\u5404\u4e2a\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u8fdb\u884c\u200b\u4f18\u5148\u7ea7\u200b\u6392\u5e8f\u200b\u548c\u200b\u751f\u6210\u200b\u8f6f\u4ef6\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\u3002\u200b\u5b83\u200b\u8fd8\u200b\u63d0\u4f9b\u200b\u5bf9\u200bTrustZone\u200b\u5b89\u5168\u6027\u200b\u6269\u5c55\u200b\u7684\u200b\u652f\u6301\u200b\u3002GIC\u200b\u63a5\u53d7\u200b\u7cfb\u7edf\u200b\u7ea7\u522b\u200b\u4e2d\u65ad\u200b\u7684\u200b\u4ea7\u751f\u200b\uff0c\u200b\u5e76\u200b\u53ef\u4ee5\u200b\u53d1\u4fe1\u53f7\u200b\u901a\u77e5\u200b\u7ed9\u200b\u5b83\u200b\u6240\u200b\u8fde\u63a5\u200b\u7684\u200b\u6bcf\u4e2a\u200b\u5185\u6838\u200b\uff0c\u200b\u4ece\u800c\u200b\u6709\u200b\u53ef\u80fd\u200b\u5bfc\u81f4\u200bIRQ\u200b\u6216\u200bFIQ\u200b\u5f02\u5e38\u200b\u53d1\u751f\u200b\u3002</p> <p>\u200b\u4ece\u200b\u8f6f\u4ef6\u200b\u89d2\u5ea6\u200b\u6765\u770b\u200b\uff0cGIC\u200b\u5177\u6709\u200b\u4e24\u4e2a\u200b\u4e3b\u8981\u200b\u529f\u80fd\u6a21\u5757\u200b\uff0c\u200b\u7b80\u5355\u200b\u753b\u56fe\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u2460 \u200b\u5206\u53d1\u200b\u5668\u200b(Distributor)     \u200b\u7cfb\u7edf\u200b\u4e2d\u200b\u7684\u200b\u6240\u6709\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u90fd\u200b\u8fde\u63a5\u200b\u5230\u200b\u8be5\u200b\u5355\u5143\u200b\u3002\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200b\u4ef2\u88c1\u200b\u5355\u5143\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u6765\u200b\u63a7\u5236\u200b\u5404\u4e2a\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u7684\u200b\u5c5e\u6027\u200b\uff0c\u200b\u4f8b\u5982\u200b\u4f18\u5148\u7ea7\u200b\u3001\u200b\u72b6\u6001\u200b\u3001\u200b\u5b89\u5168\u6027\u200b\u3001\u200b\u8def\u7531\u200b\u4fe1\u606f\u200b\u548c\u200b\u4f7f\u200b\u80fd\u200b\u72b6\u6001\u200b\u3002 \u200b\u5206\u53d1\u200b\u5668\u200b\u628a\u200b\u4e2d\u65ad\u200b\u8f93\u51fa\u200b\u5230\u200b\u201cCPU\u200b\u63a5\u53e3\u200b\u5355\u5143\u200b\u201d\uff0c\u200b\u540e\u8005\u200b\u51b3\u5b9a\u200b\u5c06\u200b\u54ea\u4e2a\u200b\u4e2d\u65ad\u200b\u8f6c\u53d1\u7ed9\u200bCPU\u200b\u6838\u200b\u3002</p> <p>\u2461 CPU\u200b\u63a5\u53e3\u200b\u5355\u5143\u200b\uff08CPU Interface\uff09     CPU\u200b\u6838\u200b\u901a\u8fc7\u200b\u63a7\u5236\u5668\u200b\u7684\u200bCPU\u200b\u63a5\u53e3\u200b\u5355\u5143\u200b\u63a5\u6536\u200b\u4e2d\u65ad\u200b\u3002CPU\u200b\u63a5\u53e3\u200b\u5355\u5143\u200b\u5bc4\u5b58\u5668\u200b\u7528\u4e8e\u200b\u5c4f\u853d\u200b\uff0c\u200b\u8bc6\u522b\u200b\u548c\u200b\u63a7\u5236\u200b\u8f6c\u53d1\u200b\u5230\u200bCPU\u200b\u6838\u200b\u7684\u200b\u4e2d\u65ad\u200b\u7684\u200b\u72b6\u6001\u200b\u3002\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\u7684\u200b\u6bcf\u4e2a\u200bCPU\u200b\u6838\u5fc3\u200b\u90fd\u200b\u6709\u200b\u4e00\u4e2a\u200b\u5355\u72ec\u200b\u7684\u200bCPU\u200b\u63a5\u53e3\u200b\u3002     \u200b\u4e2d\u65ad\u200b\u5728\u200b\u8f6f\u4ef6\u200b\u4e2d\u200b\u7531\u200b\u4e00\u4e2a\u200b\u79f0\u4e3a\u200b\u4e2d\u65ad\u200bID\u200b\u7684\u200b\u6570\u5b57\u200b\u6807\u8bc6\u200b\u3002\u200b\u4e2d\u65ad\u200bID\u200b\u552f\u4e00\u200b\u5bf9\u5e94\u200b\u4e8e\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u3002\u200b\u8f6f\u4ef6\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u4e2d\u65ad\u200bID\u200b\u6765\u200b\u8bc6\u522b\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u5e76\u200b\u8c03\u7528\u200b\u76f8\u5e94\u200b\u7684\u200b\u5904\u7406\u7a0b\u5e8f\u200b\u6765\u200b\u5904\u7406\u200b\u4e2d\u65ad\u200b\u3002\u200b\u5448\u73b0\u200b\u7ed9\u200b\u8f6f\u4ef6\u200b\u7684\u200b\u4e2d\u65ad\u200bID\u200b\u7531\u200b\u7cfb\u7edf\u200b\u8bbe\u8ba1\u200b\u786e\u5b9a\u200b\uff0c\u200b\u4e00\u822c\u200b\u5728\u200bSOC\u200b\u7684\u200b\u6570\u636e\u200b\u624b\u518c\u200b\u6709\u200b\u8bb0\u5f55\u200b\u3002</p> <p>\u200b\u4e2d\u65ad\u200b\u53ef\u4ee5\u200b\u6709\u200b\u591a\u79cd\u4e0d\u540c\u200b\u7684\u200b\u7c7b\u578b\u200b\uff1a</p> <p>\u2460 \u200b\u8f6f\u4ef6\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\uff08SGI\uff0cSoftware Generated Interrupt\uff09     \u200b\u8fd9\u200b\u662f\u200b\u7531\u200b\u8f6f\u4ef6\u200b\u901a\u8fc7\u200b\u5199\u5165\u200b\u4e13\u7528\u200b\u4ef2\u88c1\u200b\u5355\u5143\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u5373\u200b\u8f6f\u4ef6\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\u5bc4\u5b58\u5668\u200b\uff08ICDSGIR\uff09\u200b\u663e\u5f0f\u200b\u751f\u6210\u200b\u7684\u200b\u3002\u200b\u5b83\u200b\u6700\u200b\u5e38\u7528\u200b\u4e8e\u200bCPU\u200b\u6838\u200b\u95f4\u901a\u4fe1\u200b\u3002SGI\u200b\u65e2\u200b\u53ef\u4ee5\u200b\u53d1\u7ed9\u200b\u6240\u6709\u200b\u7684\u200b\u6838\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u53d1\u9001\u7ed9\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\u9009\u5b9a\u200b\u7684\u200b\u4e00\u7ec4\u200b\u6838\u5fc3\u200b\u3002\u200b\u4e2d\u65ad\u200b\u53f7\u200b0-15\u200b\u4fdd\u7559\u200b\u7528\u4e8e\u200bSGI\u200b\u7684\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u3002\u200b\u7528\u4e8e\u200b\u901a\u4fe1\u200b\u7684\u200b\u786e\u5207\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u7531\u200b\u8f6f\u4ef6\u200b\u51b3\u5b9a\u200b\u3002 </p> <p>\u2461 \u200b\u79c1\u6709\u200b\u5916\u8bbe\u200b\u4e2d\u65ad\u200b\uff08PPI\uff0cPrivate Peripheral Interrupt\uff09     \u200b\u8fd9\u200b\u662f\u200b\u7531\u200b\u5355\u4e2a\u200bCPU\u200b\u6838\u200b\u79c1\u6709\u200b\u7684\u200b\u5916\u8bbe\u200b\u751f\u6210\u200b\u7684\u200b\u3002PPI\u200b\u7684\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u4e3a\u200b16-31\u3002\u200b\u5b83\u4eec\u200b\u6807\u8bc6\u200bCPU\u200b\u6838\u200b\u79c1\u6709\u200b\u7684\u200b\u4e2d\u65ad\u200b\u6e90\u200b\uff0c\u200b\u5e76\u4e14\u200b\u72ec\u7acb\u200b\u4e8e\u200b\u53e6\u200b\u4e00\u4e2a\u200b\u5185\u6838\u200b\u4e0a\u200b\u7684\u200b\u76f8\u540c\u200b\u4e2d\u65ad\u200b\u6e90\u200b\uff0c\u200b\u6bd4\u5982\u200b\uff0c\u200b\u6bcf\u4e2a\u200b\u6838\u200b\u7684\u200b\u8ba1\u65f6\u5668\u200b\u3002</p> <p>\u2462 \u200b\u5171\u4eab\u200b\u5916\u8bbe\u200b\u4e2d\u65ad\u200b\uff08SPI\uff0cShared Peripheral Interrupt\uff09     \u200b\u8fd9\u200b\u662f\u200b\u7531\u200b\u5916\u8bbe\u200b\u751f\u6210\u200b\u7684\u200b\uff0c\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u53ef\u4ee5\u200b\u5c06\u200b\u5176\u200b\u8def\u7531\u200b\u5230\u200b\u591a\u4e2a\u200b\u6838\u200b\u3002\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u4e3a\u200b32-1020\u3002SPI\u200b\u7528\u4e8e\u200b\u4ece\u200b\u6574\u4e2a\u200b\u7cfb\u7edf\u200b\u53ef\u200b\u8bbf\u95ee\u200b\u7684\u200b\u5404\u79cd\u200b\u5916\u56f4\u8bbe\u5907\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u4fe1\u53f7\u200b\u3002</p> <p>\u200b    \u200b\u4e2d\u65ad\u200b\u53ef\u4ee5\u200b\u662f\u200b\u8fb9\u6cbf\u200b\u89e6\u53d1\u200b\u7684\u200b\uff08\u200b\u5728\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u68c0\u6d4b\u200b\u5230\u200b\u76f8\u5173\u200b\u8f93\u5165\u200b\u7684\u200b\u4e0a\u5347\u200b\u6cbf\u65f6\u200b\u8ba4\u4e3a\u200b\u4e2d\u65ad\u200b\u89e6\u53d1\u200b\uff0c\u200b\u5e76\u4e14\u200b\u4e00\u76f4\u200b\u4fdd\u6301\u200b\u5230\u200b\u6e05\u9664\u200b\u4e3a\u6b62\u200b\uff09\u200b\u6216\u200b\u7535\u5e73\u200b\u89e6\u53d1\u200b\uff08\u200b\u4ec5\u200b\u5728\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u76f8\u5173\u200b\u8f93\u5165\u200b\u4e3a\u200b\u9ad8\u65f6\u200b\u89e6\u53d1\u200b\uff09\u3002</p> <p>\u200b\u4e2d\u65ad\u200b\u53ef\u4ee5\u200b\u5904\u4e8e\u200b\u591a\u79cd\u4e0d\u540c\u200b\u72b6\u6001\u200b\uff1a</p> <p>\u2460 \u200b\u975e\u200b\u6d3b\u52a8\u72b6\u6001\u200b\uff08Inactive\uff09\u2013\u200b\u8fd9\u200b\u610f\u5473\u7740\u200b\u8be5\u200b\u4e2d\u65ad\u200b\u672a\u200b\u89e6\u53d1\u200b\u3002 \u2461 \u200b\u6302\u200b\u8d77\u200b\uff08Pending\uff09\u2013\u200b\u8fd9\u200b\u610f\u5473\u7740\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u5df2\u200b\u88ab\u200b\u89e6\u53d1\u200b\uff0c\u200b\u4f46\u200b\u6b63\u5728\u200b\u7b49\u5f85\u200bCPU\u200b\u6838\u200b\u5904\u7406\u200b\u3002\u200b\u5f85\u5904\u7406\u200b\u7684\u200b\u4e2d\u65ad\u200b\u8981\u200b\u901a\u8fc7\u200b\u8f6c\u53d1\u200b\u5230\u200bCPU\u200b\u63a5\u53e3\u200b\u5355\u5143\u200b\uff0c\u200b\u7136\u540e\u200b\u518d\u200b\u7531\u200bCPU\u200b\u63a5\u53e3\u200b\u5355\u5143\u200b\u8f6c\u53d1\u200b\u5230\u200b\u5185\u6838\u200b\u3002 \u2462 \u200b\u6d3b\u52a8\u200b\uff08Active\uff09\u2013\u200b\u63cf\u8ff0\u200b\u4e86\u200b\u4e00\u4e2a\u200b\u5df2\u200b\u88ab\u200b\u5185\u6838\u200b\u63a5\u6536\u200b\u5e76\u200b\u6b63\u5728\u200b\u5904\u7406\u200b\u7684\u200b\u4e2d\u65ad\u200b\u3002 \u2463 \u200b\u6d3b\u52a8\u200b\u548c\u200b\u6302\u200b\u8d77\u200b\uff08Active and pending\uff09\u2013\u200b\u63cf\u8ff0\u200b\u4e86\u200b\u4e00\u79cd\u200b\u60c5\u51b5\u200b\uff0c\u200b\u5176\u4e2d\u200bCPU\u200b\u6838\u200b\u6b63\u5728\u200b\u4e3a\u200b\u4e2d\u65ad\u200b\u670d\u52a1\u200b\uff0c\u200b\u800c\u200bGIC\u200b\u53c8\u200b\u6536\u5230\u200b\u6765\u81ea\u200b\u540c\u4e00\u200b\u6e90\u200b\u7684\u200b\u4e2d\u65ad\u200b\u3002</p> <p>\u200b   \u200b\u4e2d\u65ad\u200b\u7684\u200b\u4f18\u5148\u7ea7\u200b\u548c\u200b\u53ef\u200b\u63a5\u6536\u200b\u4e2d\u65ad\u200b\u7684\u200b\u6838\u200b\u90fd\u200b\u5728\u200b\u5206\u53d1\u200b\u5668\u200b(distributor)\u200b\u4e2d\u200b\u914d\u7f6e\u200b\u3002\u200b\u5916\u8bbe\u200b\u53d1\u7ed9\u200b\u5206\u53d1\u200b\u5668\u200b\u7684\u200b\u4e2d\u65ad\u200b\u5c06\u200b\u6807\u8bb0\u200b\u4e3a\u200bpending\u200b\u72b6\u6001\u200b\uff08\u200b\u6216\u200bActive and Pending\u200b\u72b6\u6001\u200b\uff0c\u200b\u5982\u200b\u89e6\u53d1\u200b\u65f6\u200b\u679c\u200b\u72b6\u6001\u200b\u662f\u200bactive\uff09\u3002distributor\u200b\u786e\u5b9a\u200b\u53ef\u4ee5\u200b\u4f20\u9012\u200b\u7ed9\u200bCPU\u200b\u6838\u200b\u7684\u200b\u4f18\u5148\u7ea7\u200b\u6700\u9ad8\u200b\u7684\u200bpending\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5e76\u200b\u5c06\u200b\u5176\u200b\u8f6c\u53d1\u7ed9\u200b\u5185\u6838\u200b\u7684\u200bCPU interface\u3002\u200b\u901a\u8fc7\u200bCPU interface\uff0c\u200b\u8be5\u200b\u4e2d\u65ad\u200b\u53c8\u200b\u5411\u200bCPU\u200b\u6838\u200b\u53d1\u51fa\u4fe1\u53f7\u200b\uff0c\u200b\u6b64\u65f6\u200bCPU\u200b\u6838\u5c06\u200b\u89e6\u53d1\u200bFIQ\u200b\u6216\u200bIRQ\u200b\u5f02\u5e38\u200b\u3002</p> <p>\u200b   \u200b\u4f5c\u4e3a\u200b\u54cd\u5e94\u200b\uff0cCPU\u200b\u6838\u200b\u6267\u884c\u200b\u5f02\u5e38\u200b\u5904\u7406\u7a0b\u5e8f\u200b\u3002\u200b\u5f02\u5e38\u200b\u5904\u7406\u7a0b\u5e8f\u200b\u5fc5\u987b\u200b\u4ece\u200bCPU interface\u200b\u5bc4\u5b58\u5668\u200b\u67e5\u8be2\u200b\u4e2d\u65ad\u200bID\uff0c\u200b\u5e76\u200b\u5f00\u59cb\u200b\u4e3a\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u63d0\u4f9b\u200b\u670d\u52a1\u200b\u3002\u200b\u5b8c\u6210\u200b\u540e\u200b\uff0c\u200b\u5904\u7406\u7a0b\u5e8f\u200b\u5fc5\u987b\u200b\u5199\u5165\u200bCPU interface\u200b\u5bc4\u5b58\u5668\u200b\u4ee5\u200b\u62a5\u544a\u200b\u5904\u7406\u200b\u7ed3\u675f\u200b\u3002\u200b\u7136\u540e\u200bCPU interface\u200b\u51c6\u5907\u200b\u8f6c\u53d1\u200bdistributor\u200b\u53d1\u7ed9\u200b\u5b83\u200b\u7684\u200b\u4e0b\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\u3002</p> <p>\u200b   \u200b\u5728\u200b\u5904\u7406\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u4e2d\u65ad\u200b\u7684\u200b\u72b6\u6001\u200b\u5f00\u59cb\u200b\u4e3a\u200bpending\uff0cactive\uff0c\u200b\u7ed3\u675f\u200b\u65f6\u200b\u53d8\u6210\u200binactive\u3002\u200b\u4e2d\u65ad\u200b\u72b6\u6001\u200b\u4fdd\u5b58\u200b\u5728\u200bdistributor\u200b\u5bc4\u5b58\u5668\u200b\u4e2d\u200b\u3002</p> <p>\u200b\u4e0b\u56fe\u200b\u662f\u200bGIC\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u903b\u8f91\u200b\u7ed3\u6784\u200b\uff1a</p> <p></p>"},{"location":"08_Interrupt/10_1/#111","title":"1.1.1 \u200b\u914d\u7f6e","text":"<p>\u200b   GIC\u200b\u4f5c\u4e3a\u200b\u5185\u5b58\u200b\u6620\u5c04\u200b\u7684\u200b\u5916\u56f4\u8bbe\u5907\u200b\uff0c\u200b\u88ab\u200b\u8f6f\u4ef6\u200b\u8bbf\u95ee\u200b\u3002\u200b\u6240\u6709\u200b\u5185\u6838\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u8bbf\u95ee\u200b\u516c\u5171\u200b\u7684\u200bdistributor\u200b\u5355\u5143\u200b\uff0c\u200b\u4f46\u662f\u200bCPU interface\u200b\u662f\u200b\u5907\u4efd\u200b\u7684\u200b\uff0c\u200b\u4e5f\u5c31\u662f\u8bf4\u200b\uff0c\u200b\u6bcf\u4e2a\u200bCPU\u200b\u6838\u90fd\u200b\u4f7f\u7528\u200b\u76f8\u540c\u200b\u7684\u200b\u5730\u5740\u200b\u6765\u200b\u8bbf\u95ee\u200b\u5176\u200b\u4e13\u7528\u200bCPU\u200b\u63a5\u53e3\u200b\u3002\u200b\u4e00\u4e2a\u200bCPU\u200b\u6838\u200b\u4e0d\u200b\u53ef\u80fd\u200b\u8bbf\u95ee\u200b\u53e6\u200b\u4e00\u4e2a\u200bCPU\u200b\u6838\u200b\u7684\u200bCPU\u200b\u63a5\u53e3\u200b\u3002</p> <p>Distributor\u200b\u62e5\u6709\u200b\u8bb8\u591a\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200b\u5b83\u4eec\u200b\u914d\u7f6e\u200b\u5404\u4e2a\u200b\u4e2d\u65ad\u200b\u7684\u200b\u5c5e\u6027\u200b\u3002\u200b\u8fd9\u4e9b\u200b\u53ef\u200b\u914d\u7f6e\u200b\u5c5e\u6027\u200b\u662f\u200b\uff1a *  \u200b\u4e2d\u65ad\u200b\u4f18\u5148\u7ea7\u200b\uff1aDistributor\u200b\u4f7f\u7528\u200b\u5b83\u200b\u6765\u200b\u786e\u5b9a\u200b\u63a5\u4e0b\u6765\u200b\u5c06\u200b\u54ea\u4e2a\u200b\u4e2d\u65ad\u200b\u8f6c\u53d1\u200b\u5230\u200bCPU\u200b\u63a5\u53e3\u200b\u3002 * \u200b\u4e2d\u65ad\u200b\u914d\u7f6e\u200b\uff1a\u200b\u8fd9\u200b\u786e\u5b9a\u200b\u4e2d\u65ad\u200b\u662f\u200b\u5bf9\u200b\u7535\u5e73\u200b\u89e6\u53d1\u200b\u8fd8\u662f\u200b\u8fb9\u6cbf\u200b\u89e6\u53d1\u200b\u3002 * \u200b\u4e2d\u65ad\u200b\u76ee\u6807\u200b\uff1a\u200b\u8fd9\u200b\u786e\u5b9a\u200b\u4e86\u200b\u53ef\u4ee5\u200b\u5c06\u200b\u4e2d\u65ad\u200b\u53d1\u7ed9\u200b\u54ea\u4e9b\u200bCPU\u200b\u6838\u200b\u3002 * \u200b\u4e2d\u65ad\u200b\u542f\u7528\u200b\u6216\u200b\u7981\u7528\u200b\u72b6\u6001\u200b\uff1a\u200b\u53ea\u6709\u200bDistributor\u200b\u4e2d\u200b\u542f\u7528\u200b\u7684\u200b\u90a3\u4e9b\u200b\u4e2d\u65ad\u200b\u53d8\u4e3a\u200b\u6302\u200b\u8d77\u200b\u72b6\u6001\u200b\u65f6\u200b\uff0c\u200b\u624d\u200b\u6709\u200b\u8d44\u683c\u200b\u8f6c\u53d1\u200b\u3002 * \u200b\u4e2d\u65ad\u200b\u5b89\u5168\u6027\u200b\uff1a\u200b\u786e\u5b9a\u200b\u5c06\u200b\u4e2d\u65ad\u200b\u5206\u914d\u200b\u7ed9\u200bSecure\u200b\u8fd8\u662f\u200bNormal world\u200b\u8f6f\u4ef6\u200b\u3002 * \u200b\u4e2d\u65ad\u200b\u72b6\u6001\u200b\u3002</p> <p>Distributor\u200b\u8fd8\u200b\u63d0\u4f9b\u200b\u4f18\u5148\u7ea7\u200b\u5c4f\u853d\u200b\uff0c\u200b\u53ef\u200b\u9632\u6b62\u200b\u4f4e\u4e8e\u200b\u67d0\u4e2a\u200b\u4f18\u5148\u7ea7\u200b\u7684\u200b\u4e2d\u65ad\u200b\u53d1\u9001\u7ed9\u200bCPU\u200b\u6838\u200b\u3002   \u200b\u6bcf\u4e2a\u200bCPU\u200b\u6838\u4e0a\u200b\u7684\u200bCPU interface\uff0c\u200b\u4e13\u6ce8\u200b\u4e8e\u200b\u63a7\u5236\u200b\u548c\u200b\u5904\u7406\u200b\u53d1\u9001\u7ed9\u200b\u8be5\u200bCPU\u200b\u6838\u200b\u7684\u200b\u4e2d\u65ad\u200b\u3002</p>"},{"location":"08_Interrupt/10_1/#112","title":"1.1.2 \u200b\u521d\u59cb\u5316","text":"<p>\u200b   Distributor\u200b\u548c\u200bCPU interface\u200b\u5728\u200b\u590d\u4f4d\u200b\u65f6\u5747\u200b\u88ab\u200b\u7981\u7528\u200b\u3002\u200b\u590d\u4f4d\u200b\u540e\u200b\uff0c\u200b\u5fc5\u987b\u200b\u521d\u59cb\u5316\u200bGIC\uff0c\u200b\u624d\u80fd\u200b\u5c06\u200b\u4e2d\u65ad\u200b\u4f20\u9012\u200b\u7ed9\u200bCPU\u200b\u6838\u200b\u3002 \u200b   \u200b\u5728\u200bDistributor\u200b\u4e2d\u200b\uff0c\u200b\u8f6f\u4ef6\u200b\u5fc5\u987b\u200b\u914d\u7f6e\u200b\u4f18\u5148\u7ea7\u200b\u3001\u200b\u76ee\u6807\u200b\u6838\u200b\u3001\u200b\u5b89\u5168\u6027\u200b\u5e76\u200b\u542f\u7528\u200b\u5355\u4e2a\u200b\u4e2d\u65ad\u200b\uff1b\u200b\u968f\u540e\u200b\u5fc5\u987b\u200b\u901a\u8fc7\u200b\u5176\u200b\u63a7\u5236\u200b\u5bc4\u5b58\u5668\u200b\u4f7f\u80fd\u200b\u3002 \u200b   \u200b\u5bf9\u4e8e\u200b\u6bcf\u4e2a\u200bCPU interface\uff0c\u200b\u8f6f\u4ef6\u200b\u5fc5\u987b\u200b\u5bf9\u200b\u4f18\u5148\u7ea7\u200b\u548c\u200b\u62a2\u5360\u200b\u8bbe\u7f6e\u200b\u8fdb\u884c\u200b\u7f16\u7a0b\u200b\u3002\u200b\u6bcf\u4e2a\u200bCPU\u200b\u63a5\u53e3\u200b\u6a21\u5757\u200b\u672c\u8eab\u200b\u5fc5\u987b\u200b\u901a\u8fc7\u200b\u5176\u200b\u63a7\u5236\u200b\u5bc4\u5b58\u5668\u200b\u4f7f\u80fd\u200b\u3002 \u200b   \u200b\u5728\u200bCPU\u200b\u6838\u200b\u53ef\u4ee5\u200b\u5904\u7406\u200b\u4e2d\u65ad\u200b\u4e4b\u524d\u200b\uff0c\u200b\u8f6f\u4ef6\u200b\u4f1a\u200b\u901a\u8fc7\u200b\u5728\u200b\u5411\u91cf\u200b\u8868\u4e2d\u200b\u8bbe\u7f6e\u200b\u6709\u6548\u200b\u7684\u200b\u4e2d\u65ad\u5411\u91cf\u200b\u5e76\u200b\u6e05\u9664\u200bCPSR\u200b\u4e2d\u200b\u7684\u200b\u4e2d\u65ad\u200b\u5c4f\u853d\u200b\u4f4d\u6765\u200b\u8ba9\u200bCPU\u200b\u6838\u200b\u53ef\u4ee5\u200b\u63a5\u6536\u200b\u4e2d\u65ad\u200b\u3002 \u200b   \u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200b\u7981\u7528\u200bDistributor\u200b\u5355\u5143\u200b\u6765\u200b\u7981\u7528\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\u7684\u200b\u6574\u4e2a\u200b\u4e2d\u65ad\u200b\u673a\u5236\u200b\uff1b\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200b\u7981\u7528\u200b\u5355\u4e2a\u200bCPU\u200b\u7684\u200bCPU\u200b\u63a5\u53e3\u200b\u6a21\u5757\u200b\u6216\u8005\u200b\u5728\u200bCPSR\u200b\u4e2d\u200b\u8bbe\u7f6e\u200b\u5c4f\u853d\u200b\u4f4d\u6765\u200b\u7981\u6b62\u200b\u5411\u200b\u5355\u4e2a\u200bCPU\u200b\u6838\u200b\u7684\u200b\u4e2d\u65ad\u200b\u4f20\u9012\u200b\u3002\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u5728\u200bDistributor\u200b\u4e2d\u200b\u7981\u7528\u200b\uff08\u200b\u6216\u200b\u542f\u7528\u200b\uff09\u200b\u5355\u4e2a\u200b\u4e2d\u65ad\u200b\u3002 \u200b   \u200b\u4e3a\u4e86\u200b\u4f7f\u200b\u67d0\u4e2a\u200b\u4e2d\u65ad\u200b\u53ef\u4ee5\u200b\u89e6\u53d1\u200bCPU\u200b\u6838\u200b\uff0c\u200b\u5fc5\u987b\u200b\u5c06\u200b\u5404\u4e2a\u200b\u4e2d\u65ad\u200b\uff0cDistributor\u200b\u548c\u200bCPU interface\u200b\u5168\u90e8\u200b\u4f7f\u80fd\u200b\uff0c\u200b\u5e76\u200b</p> <p>\u200b\u5c06\u200bCPSR\u200b\u4e2d\u65ad\u200b\u5c4f\u853d\u200b\u4f4d\u200b\u6e05\u96f6\u200b\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\uff1a </p>"},{"location":"08_Interrupt/10_1/#113-gic","title":"1.1.3 GIC\u200b\u4e2d\u65ad\u200b\u5904\u7406","text":"<p>\u200b   \u200b\u5f53\u200bCPU\u200b\u6838\u200b\u63a5\u6536\u200b\u5230\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u5b83\u4f1a\u200b\u8df3\u8f6c\u200b\u5230\u200b\u4e2d\u65ad\u5411\u91cf\u200b\u8868\u200b\u6267\u884c\u200b\u3002 \u200b   \u200b\u9876\u5c42\u200b\u4e2d\u65ad\u200b\u5904\u7406\u7a0b\u5e8f\u200b\u8bfb\u53d6\u200bCPU\u200b\u63a5\u53e3\u200b\u6a21\u5757\u200b\u7684\u200bInterrupt Acknowledge Register\uff0c\u200b\u4ee5\u200b\u83b7\u53d6\u200b\u4e2d\u65ad\u200bID\u3002\u200b\u9664\u4e86\u200b\u8fd4\u56de\u200b\u4e2d\u65ad\u200bID\u200b\u4e4b\u5916\u200b\uff0c\u200b\u8bfb\u53d6\u200b\u64cd\u4f5c\u200b\u8fd8\u4f1a\u200b\u4f7f\u200b\u8be5\u200b\u4e2d\u65ad\u200b\u5728\u200bDistributor\u200b\u4e2d\u200b\u6807\u8bb0\u200b\u4e3a\u200bactive\u200b\u72b6\u6001\u200b\u3002\u200b\u4e00\u65e6\u200b\u77e5\u9053\u200b\u4e86\u200b\u4e2d\u65ad\u200bID\uff08\u200b\u6807\u8bc6\u200b\u4e2d\u65ad\u200b\u6e90\u200b\uff09\uff0c\u200b\u9876\u5c42\u200b\u5904\u7406\u7a0b\u5e8f\u200b\u73b0\u5728\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u5206\u6d3e\u200b\u7279\u5b9a\u200b\u4e8e\u200b\u8bbe\u5907\u200b\u7684\u200b\u5904\u7406\u7a0b\u5e8f\u200b\u6765\u200b\u5904\u7406\u200b\u4e2d\u65ad\u200b\u3002 \u200b   \u200b\u5f53\u200b\u7279\u5b9a\u200b\u4e8e\u200b\u8bbe\u5907\u200b\u7684\u200b\u5904\u7406\u7a0b\u5e8f\u200b\u5b8c\u6210\u200b\u6267\u884c\u200b\u65f6\u200b\uff0c\u200b\u9876\u7ea7\u200b\u5904\u7406\u7a0b\u5e8f\u200b\u5c06\u200b\u76f8\u540c\u200b\u7684\u200b\u4e2d\u65ad\u200bID\u200b\u5199\u5165\u200bCPU interface\u200b\u6a21\u5757\u200b\u4e2d\u200b\u7684\u200bEnd of Interrupt register\u200b\u4e2d\u65ad\u200b\u7ed3\u675f\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u6307\u793a\u200b\u4e2d\u65ad\u200b\u5904\u7406\u200b\u7ed3\u675f\u200b\u3002\u200b\u9664\u4e86\u200b\u628a\u200b\u5f53\u524d\u200b\u4e2d\u65ad\u200b\u79fb\u9664\u200bactive\u200b\u72b6\u6001\u200b\u4e4b\u5916\u200b\uff0c\u200b\u8fd9\u200b\u5c06\u200b\u4f7f\u200b\u6700\u7ec8\u200b\u4e2d\u65ad\u200b\u72b6\u6001\u200b\u53d8\u4e3a\u200binactive\u200b\u6216\u200bpending\uff08\u200b\u5982\u679c\u200b\u72b6\u6001\u200b\u4e3a\u200binactive and pending\uff09\uff0c\u200b\u8fd9\u200b\u5c06\u200b\u4f7f\u200bCPU interface\u200b\u80fd\u591f\u200b\u5c06\u200b\u66f4\u200b\u591a\u200b\u5f85\u5904\u7406\u200bpending\u200b\u7684\u200b\u4e2d\u65ad\u200b\u8f6c\u53d1\u7ed9\u200bCPU\u200b\u6838\u200b\u3002\u200b\u8fd9\u6837\u200b\u5c31\u200b\u7ed3\u675f\u200b\u4e86\u200b\u5355\u4e2a\u200b\u4e2d\u65ad\u200b\u7684\u200b\u5904\u7406\u200b\u3002 \u200b   \u200b\u540c\u4e00\u200bCPU\u200b\u6838\u4e0a\u200b\u53ef\u80fd\u200b\u6709\u200b\u591a\u4e2a\u200b\u4e2d\u65ad\u200b\u7b49\u5f85\u200b\u670d\u52a1\u200b\uff0c\u200b\u4f46\u662f\u200bCPU interface\u200b\u4e00\u6b21\u200b\u53ea\u80fd\u200b\u53d1\u51fa\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\u4fe1\u53f7\u200b\u3002\u200b\u9876\u5c42\u200b\u4e2d\u65ad\u200b\u5904\u7406\u7a0b\u5e8f\u200b\u91cd\u590d\u200b\u4e0a\u8ff0\u200b\u987a\u5e8f\u200b\uff0c\u200b\u76f4\u5230\u200b\u8bfb\u53d6\u200b\u7279\u6b8a\u200b\u7684\u200b\u4e2d\u65ad\u200bID\u200b\u503c\u200b1023\uff0c\u200b\u8868\u660e\u200b\u8be5\u200b\u5185\u6838\u200b\u4e0d\u518d\u200b\u6709\u200b\u4efb\u4f55\u200b\u5f85\u5904\u7406\u200b\u7684\u200b\u4e2d\u65ad\u200b\u3002\u200b\u8fd9\u4e2a\u200b\u7279\u6b8a\u200b\u7684\u200b\u4e2d\u65ad\u200bID\u200b\u88ab\u200b\u79f0\u4e3a\u200b\u4f2a\u200b\u4e2d\u65ad\u200bID\uff08spurious interrupt ID\uff09\u3002 \u200b   \u200b\u4f2a\u200b\u4e2d\u65ad\u200bID\u200b\u662f\u200b\u4fdd\u7559\u503c\u200b\uff0c\u200b\u4e0d\u80fd\u200b\u5206\u914d\u200b\u7ed9\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\u7684\u200b\u4efb\u4f55\u200b\u8bbe\u5907\u200b\u3002</p>"},{"location":"08_Interrupt/10_1/#12-gic","title":"1.2 GIC\u200b\u7684\u200b\u5bc4\u5b58\u5668","text":"<p>\u200b   GIC\u200b\u5206\u4e3a\u200b\u4e24\u200b\u90e8\u5206\u200b\uff1aDistributor\u200b\u548c\u200bCPU interface\uff0c\u200b\u5b83\u4eec\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u90fd\u200b\u6709\u200b\u76f8\u5e94\u200b\u7684\u200b\u524d\u7f00\u200b\uff1a\u201cGICD_\u201d\u3001\u201cGICC_\u201d\u3002\u200b\u8fd9\u4e9b\u200b\u5bc4\u5b58\u5668\u200b\u90fd\u200b\u662f\u200b\u6620\u5c04\u200b\u4e3a\u200b\u5185\u5b58\u200b\u63a5\u53e3\u200b(memery map)\uff0cCPU\u200b\u53ef\u4ee5\u200b\u76f4\u63a5\u200b\u8bfb\u5199\u200b\u3002</p>"},{"location":"08_Interrupt/10_1/#121-distributor","title":"1.2.1 Distributor \u200b\u5bc4\u5b58\u5668\u200b\u63cf\u8ff0","text":""},{"location":"08_Interrupt/10_1/#1-distributor-control-register-gicd_ctlr","title":"1. Distributor Control Register, GICD_CTLR","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b 1 EnableGrp1 R/W \u200b\u7528\u4e8e\u200b\u5c06\u200bpending Group 1\u200b\u4e2d\u65ad\u200b\u4ece\u200bDistributor\u200b\u8f6c\u53d1\u200b\u5230\u200bCPU interfaces  0\uff1agroup 1\u200b\u4e2d\u65ad\u200b\u4e0d\u200b\u8f6c\u53d1\u200b  1\uff1a\u200b\u6839\u636e\u200b\u4f18\u5148\u7ea7\u200b\u89c4\u5219\u200b\u8f6c\u53d1\u200bGroup 1\u200b\u4e2d\u65ad\u200b 0 EnableGrp0 R/W \u200b\u7528\u4e8e\u200b\u5c06\u200bpending Group 0\u200b\u4e2d\u65ad\u200b\u4ece\u200bDistributor\u200b\u8f6c\u53d1\u200b\u5230\u200bCPU interfaces  0\uff1agroup 0\u200b\u4e2d\u65ad\u200b\u4e0d\u200b\u8f6c\u53d1\u200b  1\uff1a\u200b\u6839\u636e\u200b\u4f18\u5148\u7ea7\u200b\u89c4\u5219\u200b\u8f6c\u53d1\u200bGroup 0\u200b\u4e2d\u65ad"},{"location":"08_Interrupt/10_1/#2-interrupt-controller-type-register-gicd_typer","title":"2. Interrupt Controller Type Register, GICD_TYPER","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b 15:11 LSPI R \u200b\u5982\u679c\u200bGIC\u200b\u5b9e\u73b0\u200b\u4e86\u200b\u5b89\u5168\u200b\u6269\u5c55\u200b\uff0c\u200b\u5219\u200b\u6b64\u200b\u5b57\u200b\u6bb5\u200b\u7684\u200b\u503c\u200b\u662f\u200b\u5df2\u200b\u5b9e\u73b0\u200b\u7684\u200b\u53ef\u200b\u9501\u5b9a\u200bSPI\u200b\u7684\u200b\u6700\u5927\u200b\u6570\u91cf\u200b\uff0c\u200b\u8303\u56f4\u200b\u4e3a\u200b0\uff080b00000\uff09\u200b\u5230\u200b31\uff080b11111\uff09\u3002  \u200b\u5982\u679c\u200b\u6b64\u5b57\u200b\u6bb5\u200b\u4e3a\u200b0b00000\uff0c\u200b\u5219\u200bGIC\u200b\u4e0d\u4f1a\u200b\u5b9e\u73b0\u200b\u914d\u7f6e\u200b\u9501\u5b9a\u200b\u3002  \u200b\u5982\u679c\u200bGIC\u200b\u6ca1\u6709\u200b\u5b9e\u73b0\u200b\u5b89\u5168\u200b\u6269\u5c55\u200b\uff0c\u200b\u5219\u200b\u4fdd\u7559\u200b\u8be5\u5b57\u6bb5\u200b\u3002 10 SecurityExtn R \u200b\u8868\u793a\u200bGIC\u200b\u662f\u5426\u200b\u5b9e\u65bd\u200b\u5b89\u5168\u200b\u6269\u5c55\u200b\uff1a  0\u200b\u672a\u200b\u5b9e\u65bd\u200b\u5b89\u5168\u200b\u6269\u5c55\u200b\uff1b  1\u200b\u5b9e\u65bd\u200b\u4e86\u200b\u5b89\u5168\u200b\u6269\u5c55\u200b 7:5 CPUNumber R \u200b\u8868\u793a\u200b\u5df2\u200b\u5b9e\u73b0\u200b\u7684\u200bCPU  interfaces\u200b\u7684\u200b\u6570\u91cf\u200b\u3002  \u200b\u5df2\u200b\u5b9e\u73b0\u200b\u7684\u200bCPU interfaces\u200b\u6570\u91cf\u200b\u6bd4\u8be5\u200b\u5b57\u200b\u6bb5\u200b\u7684\u200b\u503c\u200b\u5927\u200b1\u3002  \u200b\u4f8b\u5982\u200b\uff0c\u200b\u5982\u679c\u200b\u6b64\u5b57\u200b\u6bb5\u200b\u4e3a\u200b0b011\uff0c\u200b\u5219\u200b\u6709\u200b\u56db\u4e2a\u200bCPU interfaces\u3002 4:0 ITLinesNumber R \u200b\u8868\u793a\u200bGIC\u200b\u652f\u6301\u200b\u7684\u200b\u6700\u5927\u200b\u4e2d\u65ad\u200b\u6570\u200b\u3002  \u200b\u5982\u679c\u200bITLinesNumber = N\uff0c\u200b\u5219\u200b\u6700\u5927\u200b\u4e2d\u65ad\u200b\u6570\u4e3a\u200b32*(N+1)\u3002  \u200b\u4e2d\u65ad\u200bID\u200b\u7684\u200b\u8303\u56f4\u200b\u662f\u200b0\u200b\u5230\u200b\uff08ID\u200b\u7684\u200b\u6570\u91cf\u200b\u2013 1\uff09\u3002  \u200b\u4f8b\u5982\u200b\uff1a0b00011\u200b\u6700\u200b\u591a\u200b128\u200b\u6761\u4e2d\u200b\u65ad\u7ebf\u200b\uff0c\u200b\u4e2d\u65ad\u200bID 0-127\u3002  \u200b\u4e2d\u65ad\u200b\u7684\u200b\u6700\u5927\u200b\u6570\u91cf\u200b\u4e3a\u200b1020\uff080b11111\uff09\u3002  \u200b\u65e0\u8bba\u200b\u6b64\u5b57\u6bb5\u200b\u5b9a\u4e49\u200b\u7684\u200b\u4e2d\u65ad\u200bID\u200b\u7684\u200b\u8303\u56f4\u200b\u5982\u4f55\u200b\uff0c\u200b\u90fd\u200b\u5c06\u200b\u4e2d\u65ad\u200bID  1020-1023\u200b\u4fdd\u7559\u200b\u7528\u4e8e\u200b\u7279\u6b8a\u200b\u76ee\u7684"},{"location":"08_Interrupt/10_1/#3-distributor-implementer-identification-register-gicd_iidr","title":"3. Distributor Implementer Identification Register, GICD_IIDR","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b 31:24 ProductID R \u200b\u4ea7\u54c1\u200b\u6807\u8bc6\u200bID 23:20 \u200b\u4fdd\u7559\u200b 19:16 Variant R \u200b\u901a\u5e38\u200b\u662f\u200b\u4ea7\u54c1\u200b\u7684\u200b\u4e3b\u8981\u200b\u7248\u672c\u53f7\u200b 15:12 Revision R \u200b\u901a\u5e38\u200b\u6b64\u5b57\u6bb5\u200b\u7528\u4e8e\u200b\u533a\u5206\u200b\u4ea7\u54c1\u200b\u7684\u200b\u6b21\u200b\u7248\u672c\u53f7\u200b 11:0 Implementer R \u200b\u542b\u6709\u200b\u5b9e\u73b0\u200b\u8fd9\u4e2a\u200bGIC\u200b\u7684\u200b\u516c\u53f8\u200b\u7684\u200bJEP106\u200b\u4ee3\u7801\u200b\uff1b  [11:8]\uff1aJEP106 continuation code\uff0c\u200b\u5bf9\u4e8e\u200bARM\u200b\u5b9e\u73b0\u200b\uff0c\u200b\u6b64\u5b57\u200b\u6bb5\u200b\u4e3a\u200b0x4\uff1b  [7]\uff1a\u200b\u59cb\u7ec8\u200b\u4e3a\u200b0\uff1b  [6:0]\uff1a\u200b\u5b9e\u73b0\u200b\u8005\u200b\u7684\u200bJEP106code\uff0c\u200b\u5bf9\u4e8e\u200bARM\u200b\u5b9e\u73b0\u200b\uff0c\u200b\u6b64\u5b57\u200b\u6bb5\u200b\u4e3a\u200b0x3B"},{"location":"08_Interrupt/10_1/#4-interrupt-group-registers-gicd_igrouprn","title":"4. Interrupt Group Registers, GICD_IGROUPRn","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b 31:0 Group  status bits R/W \u200b\u7ec4\u200b\u72b6\u6001\u200b\u4f4d\u200b\uff0c\u200b\u5bf9\u4e8e\u200b\u6bcf\u4e2a\u200b\u4f4d\u200b\uff1a  0\uff1a\u200b\u76f8\u5e94\u200b\u7684\u200b\u4e2d\u65ad\u200b\u4e3a\u200bGroup 0\uff1b  1\uff1a\u200b\u76f8\u5e94\u200b\u7684\u200b\u4e2d\u65ad\u200b\u4e3a\u200bGroup 1\u3002 <p>\u200b\u5bf9\u4e8e\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5982\u4f55\u200b\u8bbe\u7f6e\u200b\u5b83\u200b\u7684\u200bGroup \uff1f\u200b\u9996\u5148\u200b\u627e\u5230\u200b\u5bf9\u5e94\u200b\u7684\u200bGICD_IGROUPRn\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u5373\u200bn\u200b\u662f\u200b\u591a\u5c11\u200b\uff1f\u200b\u8fd8\u8981\u200b\u786e\u5b9a\u200b\u4f7f\u7528\u200b\u8fd9\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\u91cc\u200b\u54ea\u4e00\u4f4d\u200b\u3002 \u200b\u5bf9\u4e8e\u200binterrtups ID m\uff0c\u200b\u5982\u4e0b\u200b\u8ba1\u7b97\u200b\uff1a</p> <pre><code>n = m DIV 32\uff0cGICD_IGROUPRn\u200b\u91cc\u200b\u7684\u200bn\u200b\u5c31\u200b\u786e\u5b9a\u200b\u4e86\u200b\uff1b\nGICD_IGROUPRn\u200b\u5728\u200bGIC\u200b\u5185\u90e8\u200b\u7684\u200b\u504f\u79fb\u200b\u5730\u5740\u200b\u662f\u200b\u591a\u5c11\u200b\uff1f0x080+(4*n)\n\u200b\u4f7f\u7528\u200bGICD_IPRIORITYRn\u200b\u4e2d\u200b\u54ea\u4e00\u4f4d\u200b\u6765\u200b\u8868\u793a\u200binterrtups ID m\uff1f\nbit = m mod 32\u3002\n</code></pre>"},{"location":"08_Interrupt/10_1/#5-interrupt-set-enable-registers-gicd_isenablern","title":"5. Interrupt Set-Enable Registers, GICD_ISENABLERn","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b 31:0 Set-enable  bits R/W \u200b\u5bf9\u4e8e\u200bSPI\u200b\u548c\u200bPPI\u200b\u7c7b\u578b\u200b\u7684\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u6bcf\u200b\u4e00\u4f4d\u200b\u63a7\u5236\u200b\u5bf9\u5e94\u200b\u4e2d\u65ad\u200b\u7684\u200b\u8f6c\u53d1\u200b\u884c\u4e3a\u200b\uff1a\u200b\u4ece\u200bDistributor\u200b\u8f6c\u53d1\u200b\u5230\u200bCPU interface\uff1a  \u200b\u8bfb\u200b\uff1a  0\uff1a\u200b\u8868\u793a\u200b\u5f53\u524d\u200b\u662f\u200b\u7981\u6b62\u200b\u8f6c\u53d1\u200b\u7684\u200b\uff1b  1\uff1a\u200b\u8868\u793a\u200b\u5f53\u524d\u200b\u662f\u200b\u4f7f\u200b\u80fd\u200b\u8f6c\u53d1\u200b\u7684\u200b\uff1b  \u200b\u5199\u200b\uff1a  0\uff1a\u200b\u65e0\u6548\u200b  1\uff1a\u200b\u4f7f\u80fd\u200b\u8f6c\u53d1\u200b <p>\u200b\u5bf9\u4e8e\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5982\u4f55\u200b\u627e\u5230\u200bGICD_ISENABLERn\u200b\u5e76\u200b\u786e\u5b9a\u200b\u76f8\u5e94\u200b\u7684\u200b\u4f4d\u200b\uff1f <pre><code>\u200b\u5bf9\u4e8e\u200binterrtups ID m\uff0c\u200b\u5982\u4e0b\u200b\u8ba1\u7b97\u200b\uff1a\nn = m DIV 32\uff0cGICD_ISENABLERn\u200b\u91cc\u200b\u7684\u200bn\u200b\u5c31\u200b\u786e\u5b9a\u200b\u4e86\u200b\uff1b\nGICD_ISENABLERn\u200b\u5728\u200bGIC\u200b\u5185\u90e8\u200b\u7684\u200b\u504f\u79fb\u200b\u5730\u5740\u200b\u662f\u200b\u591a\u5c11\u200b\uff1f0x100+(4*n)\n\u200b\u4f7f\u7528\u200bGICD_ISENABLERn\u200b\u4e2d\u200b\u54ea\u4e00\u4f4d\u200b\u6765\u200b\u8868\u793a\u200binterrtups ID m\uff1f\nbit = m mod 32\u3002\n</code></pre></p>"},{"location":"08_Interrupt/10_1/#6-interrupt-clear-enable-registers-gicd_icenablern","title":"6. Interrupt Clear-Enable Registers, GICD_ICENABLERn","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b 31:0 Clear-enable  bits R/W \u200b\u5bf9\u4e8e\u200bSPI\u200b\u548c\u200bPPI\u200b\u7c7b\u578b\u200b\u7684\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u6bcf\u200b\u4e00\u4f4d\u200b\u63a7\u5236\u200b\u5bf9\u5e94\u200b\u4e2d\u65ad\u200b\u7684\u200b\u8f6c\u53d1\u200b\u884c\u4e3a\u200b\uff1a\u200b\u4ece\u200bDistributor\u200b\u8f6c\u53d1\u200b\u5230\u200bCPU interface\uff1a  \u200b\u8bfb\u200b\uff1a  0\uff1a\u200b\u8868\u793a\u200b\u5f53\u524d\u200b\u662f\u200b\u7981\u6b62\u200b\u8f6c\u53d1\u200b\u7684\u200b\uff1b  1\uff1a\u200b\u8868\u793a\u200b\u5f53\u524d\u200b\u662f\u200b\u4f7f\u200b\u80fd\u200b\u8f6c\u53d1\u200b\u7684\u200b\uff1b  \u200b\u5199\u200b\uff1a  0\uff1a\u200b\u65e0\u6548\u200b  1\uff1a\u200b\u7981\u6b62\u200b\u8f6c\u53d1\u200b <p>\u200b\u5bf9\u4e8e\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5982\u4f55\u200b\u627e\u5230\u200bGICD_ICENABLERn\u200b\u5e76\u200b\u786e\u5b9a\u200b\u76f8\u5e94\u200b\u7684\u200b\u4f4d\u200b\uff1f <pre><code>\u200b\u5bf9\u4e8e\u200binterrtups ID m\uff0c\u200b\u5982\u4e0b\u200b\u8ba1\u7b97\u200b\uff1a\nn = m DIV 32\uff0cGICD_ICENABLERn\u200b\u91cc\u200b\u7684\u200bn\u200b\u5c31\u200b\u786e\u5b9a\u200b\u4e86\u200b\uff1b\nGICD_ICENABLERn\u200b\u5728\u200bGIC\u200b\u5185\u90e8\u200b\u7684\u200b\u504f\u79fb\u200b\u5730\u5740\u200b\u662f\u200b\u591a\u5c11\u200b\uff1f0x180+(4*n)\n\u200b\u4f7f\u7528\u200bGICD_ICENABLERn\u200b\u4e2d\u200b\u54ea\u4e00\u4f4d\u200b\u6765\u200b\u8868\u793a\u200binterrtups ID m\uff1f\nbit = m mod 32\u3002\n</code></pre></p>"},{"location":"08_Interrupt/10_1/#7-interrupt-set-active-registers-gicd_isactivern","title":"7. Interrupt Set-Active Registers, GICD_ISACTIVERn","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b 31:0 Set-active  bits R/W \u200b\u8bfb\u200b\uff1a  0\uff1a\u200b\u8868\u793a\u200b\u76f8\u5e94\u200b\u4e2d\u65ad\u200b\u4e0d\u662f\u200bactive\u200b\u72b6\u6001\u200b\uff1b  1\uff1a\u200b\u8868\u793a\u200b\u76f8\u5e94\u200b\u4e2d\u65ad\u200b\u662f\u200bactive\u200b\u72b6\u6001\u200b\uff1b  \u200b\u5199\u200b\uff1a  0\uff1a\u200b\u65e0\u6548\u200b  1\uff1a\u200b\u628a\u200b\u76f8\u5e94\u200b\u4e2d\u65ad\u200b\u8bbe\u7f6e\u200b\u4e3a\u200bactive\u200b\u72b6\u6001\u200b\uff0c\u200b\u5982\u679c\u200b\u4e2d\u65ad\u200b\u5df2\u200b\u5904\u4e8e\u200bActive\u200b\u72b6\u6001\u200b\uff0c\u200b\u5219\u200b\u5199\u5165\u200b\u65e0\u6548\u200b <p>\u200b\u5bf9\u4e8e\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5982\u4f55\u200b\u627e\u5230\u200bGICD_ISACTIVERn\u200b\u5e76\u200b\u786e\u5b9a\u200b\u76f8\u5e94\u200b\u7684\u200b\u4f4d\u200b\uff1f <pre><code>\u200b\u5bf9\u4e8e\u200binterrtups ID m\uff0c\u200b\u5982\u4e0b\u200b\u8ba1\u7b97\u200b\uff1a\nn = m DIV 32\uff0cGICD_ISACTIVERn\u200b\u91cc\u200b\u7684\u200bn\u200b\u5c31\u200b\u786e\u5b9a\u200b\u4e86\u200b\uff1b\nGICD_ISACTIVERn\u200b\u5728\u200bGIC\u200b\u5185\u90e8\u200b\u7684\u200b\u504f\u79fb\u200b\u5730\u5740\u200b\u662f\u200b\u591a\u5c11\u200b\uff1f0x300+(4*n)\n\u200b\u4f7f\u7528\u200bGICD_ISACTIVERn \u200b\u4e2d\u200b\u54ea\u4e00\u4f4d\u200b\u6765\u200b\u8868\u793a\u200binterrtups ID m\uff1f\nbit = m mod 32\u3002\n</code></pre></p>"},{"location":"08_Interrupt/10_1/#8-interrupt-clear-active-registers-gicd_icactivern","title":"8. Interrupt Clear-Active Registers, GICD_ICACTIVERn","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b 31:0 Clear-active  bits R/W \u200b\u8bfb\u200b\uff1a  0\uff1a\u200b\u8868\u793a\u200b\u76f8\u5e94\u200b\u4e2d\u65ad\u200b\u4e0d\u662f\u200bactive\u200b\u72b6\u6001\u200b\uff1b  1\uff1a\u200b\u8868\u793a\u200b\u76f8\u5e94\u200b\u4e2d\u65ad\u200b\u662f\u200bactive\u200b\u72b6\u6001\u200b\uff1b  \u200b\u5199\u200b\uff1a  0\uff1a\u200b\u65e0\u6548\u200b  1\uff1a\u200b\u628a\u200b\u76f8\u5e94\u200b\u4e2d\u65ad\u200b\u8bbe\u7f6e\u200b\u4e3a\u200bdeactive\u200b\u72b6\u6001\u200b\uff0c\u200b\u5982\u679c\u200b\u4e2d\u65ad\u200b\u5df2\u200b\u5904\u4e8e\u200bdective\u200b\u72b6\u6001\u200b\uff0c\u200b\u5219\u200b\u5199\u5165\u200b\u65e0\u6548\u200b <p>\u200b\u5bf9\u4e8e\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5982\u4f55\u200b\u627e\u5230\u200bGICD_ICACTIVERn\u200b\u5e76\u200b\u786e\u5b9a\u200b\u76f8\u5e94\u200b\u7684\u200b\u4f4d\u200b\uff1f <pre><code>\u200b\u5bf9\u4e8e\u200binterrtups ID m\uff0c\u200b\u5982\u4e0b\u200b\u8ba1\u7b97\u200b\uff1a\nn = m DIV 32\uff0cGICD_ICACTIVERn\u200b\u91cc\u200b\u7684\u200bn\u200b\u5c31\u200b\u786e\u5b9a\u200b\u4e86\u200b\uff1b\nGICD_ICACTIVERn \u200b\u5728\u200bGIC\u200b\u5185\u90e8\u200b\u7684\u200b\u504f\u79fb\u200b\u5730\u5740\u200b\u662f\u200b\u591a\u5c11\u200b\uff1f0x380+(4*n)\n\u200b\u4f7f\u7528\u200bGICD_ICACTIVERn\u200b\u4e2d\u200b\u54ea\u4e00\u4f4d\u200b\u6765\u200b\u8868\u793a\u200binterrtups ID m\uff1f\nbit = m mod 32\u3002\n</code></pre></p>"},{"location":"08_Interrupt/10_1/#9-interrupt-priority-registers-gicd_ipriorityrn","title":"9. Interrupt Priority Registers, GICD_IPRIORITYRn","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b 31:24 Priority, byte  offset 3 R/W \u200b\u5bf9\u4e8e\u200b\u6bcf\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u90fd\u200b\u6709\u200b\u5bf9\u5e94\u200b\u7684\u200b8\u200b\u4f4d\u200b\u6570\u636e\u200b\u7528\u6765\u200b\u63cf\u8ff0\u200b\uff1a\u200b\u5b83\u200b\u7684\u200b\u4f18\u5148\u7ea7\u200b\u3002  \u200b\u6bcf\u4e2a\u200b\u4f18\u5148\u7ea7\u200b\u5b57\u6bb5\u200b\u90fd\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200b\u4f18\u5148\u7ea7\u200b\u503c\u200b\uff0c\u200b\u503c\u8d8a\u200b\u5c0f\u200b\uff0c\u200b\u76f8\u5e94\u200b\u4e2d\u65ad\u200b\u7684\u200b\u4f18\u5148\u7ea7\u200b\u8d8a\u9ad8\u200b 23:16 Priority,  byte offset 2 R/W 15:8 Priority,  byte offset 1 R/W 7:0 Priority,  byte offset 0 R/W <p>\u200b\u5bf9\u4e8e\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5982\u4f55\u200b\u8bbe\u7f6e\u200b\u5b83\u200b\u7684\u200b\u4f18\u5148\u7ea7\u200b(Priority)\uff0c\u200b\u9996\u5148\u200b\u627e\u5230\u200b\u5bf9\u5e94\u200b\u7684\u200bGICD_IPRIORITYRn\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u5373\u200bn\u200b\u662f\u200b\u591a\u5c11\u200b\uff1f\u200b\u8fd8\u8981\u200b\u786e\u5b9a\u200b\u4f7f\u7528\u200b\u8fd9\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\u91cc\u200b\u54ea\u200b\u4e00\u4e2a\u200b\u5b57\u8282\u200b\u3002 <pre><code>\u200b\u5bf9\u4e8e\u200binterrtups ID m\uff0c\u200b\u5982\u4e0b\u200b\u8ba1\u7b97\u200b\uff1a\nn = m DIV 4\uff0cGICD_IPRIORITYRn\u200b\u91cc\u200b\u7684\u200bn\u200b\u5c31\u200b\u786e\u5b9a\u200b\u4e86\u200b\uff1b\nGICD_IPRIORITYRn\u200b\u5728\u200bGIC\u200b\u5185\u90e8\u200b\u7684\u200b\u504f\u79fb\u200b\u5730\u5740\u200b\u662f\u200b\u591a\u5c11\u200b\uff1f0x400+(4*n)\n\u200b\u4f7f\u7528\u200bGICD_IPRIORITYRn\u200b\u4e2d\u200b4\u200b\u4e2a\u200b\u5b57\u8282\u200b\u4e2d\u200b\u7684\u200b\u54ea\u200b\u4e00\u4e2a\u200b\u6765\u200b\u8868\u793a\u200binterrtups ID m\u200b\u7684\u200b\u4f18\u5148\u7ea7\u200b\uff1f\nbyte offset = m mod 4\u3002\nbyte offset 0\u200b\u5bf9\u5e94\u200b\u5bc4\u5b58\u5668\u200b\u91cc\u200b\u7684\u200b[7:0]\uff1b\nbyte offset 1\u200b\u5bf9\u5e94\u200b\u5bc4\u5b58\u5668\u200b\u91cc\u200b\u7684\u200b[15:8]\uff1b\nbyte offset 2\u200b\u5bf9\u5e94\u200b\u5bc4\u5b58\u5668\u200b\u91cc\u200b\u7684\u200b[23:16]\uff1b\nbyte offset 3\u200b\u5bf9\u5e94\u200b\u5bc4\u5b58\u5668\u200b\u91cc\u200b\u7684\u200b[31:24]\u3002\n</code></pre></p>"},{"location":"08_Interrupt/10_1/#10-interrupt-processor-targets-registers-gicd_itargetsrn","title":"10. Interrupt Processor Targets Registers, GICD_ITARGETSRn","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b 31:24 CPU targets, byte offset 3 R/W \u200b\u5bf9\u4e8e\u200b\u6bcf\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u90fd\u200b\u6709\u200b\u5bf9\u5e94\u200b\u7684\u200b8\u200b\u4f4d\u200b\u6570\u636e\u200b\u7528\u6765\u200b\u63cf\u8ff0\u200b\uff1a\u200b\u8fd9\u4e2a\u200b\u4e2d\u65ad\u200b\u53ef\u4ee5\u200b\u53d1\u7ed9\u200b\u54ea\u4e9b\u200bCPU\u3002  \u200b\u5904\u7406\u5668\u200b\u7f16\u53f7\u200b\u4ece\u200b0\u200b\u5f00\u59cb\u200b\uff0c8\u200b\u4f4d\u6570\u200b\u91cc\u200b\u6bcf\u4e2a\u200b\u4f4d\u5747\u200b\u6307\u4ee3\u200b\u76f8\u5e94\u200b\u7684\u200b\u5904\u7406\u5668\u200b\u3002  \u200b\u4f8b\u5982\u200b\uff0c\u200b\u503c\u200b0x3\u200b\u8868\u793a\u200b\u5c06\u200b\u4e2d\u65ad\u200b\u53d1\u9001\u5230\u200b\u5904\u7406\u5668\u200b0\u200b\u548c\u200b1\u3002  \u200b\u5f53\u200b\u8bfb\u53d6\u200bGICD_ITARGETSR0\uff5eGICD_ITARGETSR7\u200b\u65f6\u200b\uff0c\u200b\u8bfb\u53d6\u200b\u91cc\u9762\u200b\u4efb\u610f\u200b\u5b57\u8282\u200b\uff0c\u200b\u8fd4\u56de\u200b\u7684\u200b\u90fd\u200b\u662f\u200b\u6267\u884c\u200b\u8fd9\u4e2a\u200b\u8bfb\u200b\u64cd\u4f5c\u200b\u7684\u200bCPU\u200b\u7684\u200b\u7f16\u53f7\u200b\u3002 23:16 CPU targets, byte offset 2 R/W 15:8 CPU targets, byte offset 1 R/W 7:0 CPU targets, byte offset 0 R/W <p>\u200b\u5bf9\u4e8e\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5982\u4f55\u200b\u8bbe\u7f6e\u200b\u5b83\u200b\u7684\u200b\u76ee\u676f\u200bCPU\uff1f\u200b\u4f18\u5148\u7ea7\u200b(Priority)\uff0c\u200b\u9996\u5148\u200b\u627e\u5230\u200b\u5bf9\u5e94\u200b\u7684\u200bGICD_ITARGETSRn\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u5373\u200bn\u200b\u662f\u200b\u591a\u5c11\u200b\uff1f\u200b\u8fd8\u8981\u200b\u786e\u5b9a\u200b\u4f7f\u7528\u200b\u8fd9\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\u91cc\u200b\u54ea\u200b\u4e00\u4e2a\u200b\u5b57\u8282\u200b\u3002 <pre><code>\u200b\u5bf9\u4e8e\u200binterrtups ID m\uff0c\u200b\u5982\u4e0b\u200b\u8ba1\u7b97\u200b\uff1a\nn = m DIV 4\uff0cGICD_ITARGETSRn\u200b\u91cc\u200b\u7684\u200bn\u200b\u5c31\u200b\u786e\u5b9a\u200b\u4e86\u200b\uff1b\nGICD_ITARGETSRn\u200b\u5728\u200bGIC\u200b\u5185\u90e8\u200b\u7684\u200b\u504f\u79fb\u200b\u5730\u5740\u200b\u662f\u200b\u591a\u5c11\u200b\uff1f0x800+(4*n)\n\u200b\u4f7f\u7528\u200bGICD_ITARGETSRn\u200b\u4e2d\u200b4\u200b\u4e2a\u200b\u5b57\u8282\u200b\u4e2d\u200b\u7684\u200b\u54ea\u200b\u4e00\u4e2a\u200b\u6765\u200b\u8868\u793a\u200binterrtups ID m\u200b\u7684\u200b\u76ee\u6807\u200bCPU\uff1f\nbyte offset = m mod 4\u3002\nbyte offset 0\u200b\u5bf9\u5e94\u200b\u5bc4\u5b58\u5668\u200b\u91cc\u200b\u7684\u200b[7:0]\uff1b\nbyte offset 1\u200b\u5bf9\u5e94\u200b\u5bc4\u5b58\u5668\u200b\u91cc\u200b\u7684\u200b[15:8]\uff1b\nbyte offset 2\u200b\u5bf9\u5e94\u200b\u5bc4\u5b58\u5668\u200b\u91cc\u200b\u7684\u200b[23:16]\uff1b\nbyte offset 3\u200b\u5bf9\u5e94\u200b\u5bc4\u5b58\u5668\u200b\u91cc\u200b\u7684\u200b[31:24]\u3002\n</code></pre></p>"},{"location":"08_Interrupt/10_1/#11-interrupt-configuration-registers-gicd_icfgrn","title":"11. Interrupt Configuration Registers, GICD_ICFGRn","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b [2*F*+1:2*F*] Int_config, field F R/W \u200b\u5bf9\u4e8e\u200b\u6bcf\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u90fd\u200b\u6709\u200b\u5bf9\u5e94\u200b\u7684\u200b2\u200b\u4f4d\u200b\u6570\u636e\u200b\u7528\u6765\u200b\u63cf\u8ff0\u200b\uff1a\u200b\u5b83\u200b\u7684\u200b\u8fb9\u6cbf\u200b\u89e6\u53d1\u200b\uff0c\u200b\u8fd8\u662f\u200b\u7535\u5e73\u200b\u89e6\u53d1\u200b\u3002  \u200b\u5bf9\u4e8e\u200bInt_config [1]\uff0c\u200b\u5373\u200b\u9ad8\u4f4d\u200b[2F + 1]\uff0c\u200b\u542b\u4e49\u200b\u4e3a\u200b\uff1a  0\uff1a\u200b\u76f8\u5e94\u200b\u7684\u200b\u4e2d\u65ad\u200b\u662f\u200b\u7535\u5e73\u200b\u89e6\u53d1\u200b\uff1b  1\uff1a\u200b\u76f8\u5e94\u200b\u7684\u200b\u4e2d\u65ad\u200b\u662f\u200b\u8fb9\u6cbf\u200b\u89e6\u53d1\u200b\u3002     \u200b\u5bf9\u4e8e\u200bInt_config [0]\uff0c\u200b\u5373\u200b\u4f4e\u4f4d\u200b[2F]\uff0c\u200b\u662f\u200b\u4fdd\u7559\u200b\u4f4d\u200b\u3002 <p>\u200b\u5bf9\u4e8e\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5982\u4f55\u200b\u627e\u5230\u200bGICD_ICFGRn\u200b\u5e76\u200b\u786e\u5b9a\u200b\u76f8\u5e94\u200b\u7684\u200b\u4f4d\u57df\u200bF\uff1f <pre><code>\u200b\u5bf9\u4e8e\u200binterrtups ID m\uff0c\u200b\u5982\u4e0b\u200b\u8ba1\u7b97\u200b\uff1a\nn = m DIV 16\uff0cGICD_ICFGRn\u200b\u91cc\u200b\u7684\u200bn\u200b\u5c31\u200b\u786e\u5b9a\u200b\u4e86\u200b\uff1b\nGICD_ICACTIVERn \u200b\u5728\u200bGIC\u200b\u5185\u90e8\u200b\u7684\u200b\u504f\u79fb\u200b\u5730\u5740\u200b\u662f\u200b\u591a\u5c11\u200b\uff1f0xC00+(4*n)\nF = m mod 16\u3002\n</code></pre></p>"},{"location":"08_Interrupt/10_1/#12-identification-registers-peripheral-id2-register-icpidr2","title":"12. Identification registers: Peripheral ID2 Register, ICPIDR2","text":"\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b [31:0] - R/W \u200b\u7531\u200b\u5b9e\u73b0\u200b\u5b9a\u4e49\u200b [7:4] ArchRev R \u200b\u8be5\u5b57\u200b\u6bb5\u200b\u7684\u200b\u503c\u200b\u53d6\u51b3\u4e8e\u200bGIC\u200b\u67b6\u6784\u200b\u7248\u672c\u200b\uff1a  0x1\uff1aGICv1\uff1b  0x2\uff1aGICv2\u3002 [3:0] - R/W \u200b\u7531\u200b\u5b9e\u73b0\u200b\u5b9a\u4e49"},{"location":"08_Interrupt/10_1/#122-cpu-interface","title":"1.2.2 CPU interface\u200b\u5bc4\u5b58\u5668\u200b\u63cf\u8ff0","text":""},{"location":"08_Interrupt/10_1/#1-cpu-interface-control-register-gicc_ctlr","title":"1. CPU Interface Control Register, GICC_CTLR","text":"<p>\u200b   \u200b\u6b64\u200b\u5bc4\u5b58\u5668\u200b\u7528\u6765\u200b\u63a7\u5236\u200bCPU interface\u200b\u4f20\u7ed9\u200bCPU\u200b\u7684\u200b\u4e2d\u65ad\u200b\u4fe1\u53f7\u200b\u3002\u200b\u5bf9\u4e8e\u200b\u4e0d\u540c\u200b\u7248\u672c\u200b\u7684\u200bGIC\uff0c\u200b\u8fd9\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\u91cc\u200b\u5404\u4e2a\u200b\u4f4d\u200b\u7684\u200b\u542b\u4e49\u200b\u5927\u6709\u200b\u4e0d\u540c\u200b\u3002\u200b\u4ee5\u200bGICv2\u200b\u4e3a\u4f8b\u200b\uff0c\u200b\u6709\u200b\u5982\u4e0b\u200b2\u200b\u79cd\u200b\u683c\u5f0f\u200b\uff1a</p> <p> </p> <p>\u200b   \u200b\u4ee5\u200b<code>GIC2 with Security Extensions, Non-secure copy</code> \u200b\u4e3a\u4f8b\u200b\uff0cGICC_CTLR\u200b\u4e2d\u200b\u5404\u4e2a\u200b\u4f4d\u200b\u7684\u200b\u5b9a\u4e49\u200b\u5982\u4e0b\u200b\uff1a</p> \u200b\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b [31:10] - \u200b\u4fdd\u7559\u200b [9] EOImodeNS R/W \u200b\u63a7\u5236\u200b\u5bf9\u200bGICC_EOIR\u200b\u548c\u200bGICC_DIR\u200b\u5bc4\u5b58\u5668\u200b\u7684\u200b\u975e\u200b\u5b89\u5168\u200b\u8bbf\u95ee\u200b\uff1a  0\uff1aGICC_EOIR\u200b\u5177\u6709\u200b\u964d\u4f4e\u200b\u4f18\u5148\u7ea7\u200b\u548c\u200bdeactivate\u200b\u4e2d\u65ad\u200b\u7684\u200b\u529f\u80fd\u200b\uff1b  \u200b\u5bf9\u200bGICC_DIR\u200b\u7684\u200b\u8bbf\u95ee\u200b\u662f\u200b\u672a\u5b9a\u4e49\u200b\u7684\u200b\u3002  1\uff1aGICC_EOIR\u200b\u4ec5\u200b\u5177\u6709\u200b\u964d\u4f4e\u200b\u4f18\u5148\u7ea7\u200b\u529f\u80fd\u200b\uff1b  GICC_DIR\u200b\u5bc4\u5b58\u5668\u200b\u5177\u6709\u200bdeactivate\u200b\u4e2d\u65ad\u200b\u529f\u80fd\u200b\u3002 [8:7] - \u200b\u4fdd\u7559\u200b [6] IRQBypDisGrp1 R/W \u200b\u5f53\u200bCPU interface\u200b\u7684\u200bIRQ\u200b\u4fe1\u53f7\u200b\u88ab\u200b\u7981\u7528\u200b\u65f6\u200b\uff0c\u200b\u8be5\u200b\u4f4d\u200b\u63a7\u5236\u200b\u662f\u5426\u200b\u5411\u200b\u5904\u7406\u5668\u200b\u53d1\u9001\u200bbypass IRQ\u200b\u4fe1\u53f7\u200b\uff1a  0\uff1a\u200b\u5c06\u200bbypass IRQ\u200b\u4fe1\u53f7\u200b\u53d1\u9001\u7ed9\u200b\u5904\u7406\u5668\u200b\uff1b  1\uff1a\u200b\u5c06\u200bbypass IRQ\u200b\u4fe1\u53f7\u200b\u4e0d\u200b\u53d1\u9001\u5230\u200b\u5904\u7406\u5668\u200b\u3002 [5] FIQBypDisGrp1 R/W \u200b\u5f53\u200bCPU interface\u200b\u7684\u200bFIQ\u200b\u4fe1\u53f7\u200b\u88ab\u200b\u7981\u7528\u200b\u65f6\u200b\uff0c\u200b\u8be5\u200b\u4f4d\u200b\u63a7\u5236\u200b\u662f\u5426\u200b\u5411\u200b\u5904\u7406\u5668\u200b\u53d1\u9001\u200bbypass FIQ\u200b\u4fe1\u53f7\u200b\uff1a  0\uff1a\u200b\u5c06\u200bbypass FIQ\u200b\u4fe1\u53f7\u200b\u53d1\u9001\u7ed9\u200b\u5904\u7406\u5668\u200b\uff1b  1\uff1a\u200b\u65c1\u8def\u200bFIQ\u200b\u4fe1\u53f7\u200b\u4e0d\u200b\u53d1\u9001\u5230\u200b\u5904\u7406\u5668\u200b [4:1] - \u200b\u4fdd\u7559\u200b [0] - R/W \u200b\u4f7f\u80fd\u200bCPU interface\u200b\u5411\u200b\u8fde\u63a5\u200b\u7684\u200b\u5904\u7406\u5668\u200b\u53d1\u51fa\u200b\u7684\u200b\u7ec4\u200b1\u200b\u4e2d\u65ad\u200b\u7684\u200b\u4fe1\u53f7\u200b:  0\uff1a\u200b\u7981\u7528\u200b\u4e2d\u65ad\u200b\u4fe1\u53f7\u200b  1\uff1a\u200b\u4f7f\u80fd\u200b\u4e2d\u65ad\u200b\u4fe1\u53f7"},{"location":"08_Interrupt/10_1/#2-interrupt-priority-mask-register-gicc_pmr","title":"2. Interrupt Priority Mask Register, GICC_PMR","text":"<p>\u200b   \u200b\u63d0\u4f9b\u200b\u4f18\u5148\u7ea7\u200b\u8fc7\u6ee4\u200b\u529f\u80fd\u200b\uff0c\u200b\u4f18\u5148\u7ea7\u200b\u9ad8\u4e8e\u200b\u67d0\u503c\u200b\u7684\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u624d\u200b\u4f1a\u200b\u53d1\u9001\u7ed9\u200bCPU\u3002</p> <p> </p> \u200b\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b [31:8] - \u200b\u4fdd\u7559\u200b [7:0] - R/W \u200b\u4f18\u5148\u7ea7\u200b\u9ad8\u4e8e\u200b\u8fd9\u4e2a\u200b\u503c\u200b\u7684\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u624d\u200b\u4f1a\u200b\u53d1\u9001\u7ed9\u200bCPU <p><code>[7:0]</code>\u200b\u5171\u200b8\u200b\u4f4d\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u8868\u793a\u200b256\u200b\u4e2a\u200b\u4f18\u5148\u7ea7\u200b\u3002\u200b\u4f46\u662f\u200b\u67d0\u4e9b\u200b\u82af\u7247\u200b\u91cc\u200b\u7684\u200bGIC\u200b\u652f\u6301\u200b\u7684\u200b\u4f18\u5148\u7ea7\u200b\u5c11\u4e8e\u200b256\u200b\u4e2a\u200b\uff0c\u200b\u5219\u200b\u67d0\u4e9b\u200b\u4f4d\u4e3a\u200bRAZ / WI\uff0c\u200b\u5982\u4e0b\u200b\u6240\u793a\u200b\uff1a</p> <p><pre><code>\u200b\u5982\u679c\u200b\u6709\u200b128\u200b\u4e2a\u200b\u7ea7\u522b\u200b\uff0c\u200b\u5219\u200b\u5bc4\u5b58\u5668\u200b\u4e2d\u200bbit[0] = 0b0\uff0c\u200b\u5373\u200b\u4f7f\u7528\u200b[7:1]\u200b\u6765\u200b\u8868\u793a\u200b\u4f18\u5148\u7ea7\u200b\uff1b\n\u200b\u5982\u679c\u200b\u6709\u200b64\u200b\u4e2a\u200b\u7ea7\u522b\u200b\uff0c\u200b\u5219\u200b\u5bc4\u5b58\u5668\u200b\u4e2d\u200bbit[1:0] = 0b00\uff0c\u200b\u5373\u200b\u4f7f\u7528\u200b[7:2]\u200b\u6765\u200b\u8868\u793a\u200b\u4f18\u5148\u7ea7\u200b\uff1b\n\u200b\u5982\u679c\u200b\u6709\u200b32\u200b\u4e2a\u200b\u7ea7\u522b\u200b\uff0c\u200b\u5219\u200b\u5bc4\u5b58\u5668\u200b\u4e2d\u200bbit[2:0] = 0b000\uff0c\u200b\u5373\u200b\u4f7f\u7528\u200b[7:3]\u200b\u6765\u200b\u8868\u793a\u200b\u4f18\u5148\u7ea7\u200b\uff1b\n\u200b\u5982\u679c\u200b\u6709\u200b16\u200b\u4e2a\u200b\u7ea7\u522b\u200b\uff0c\u200b\u5219\u200b\u5bc4\u5b58\u5668\u200b\u4e2d\u200bbit[3:0] = 0b0000\uff0c\u200b\u5373\u200b\u4f7f\u7528\u200b[7:4]\u200b\u6765\u200b\u8868\u793a\u200b\u4f18\u5148\u7ea7\u200b\uff1b\n</code></pre> \u200b\u6ce8\u610f\u200b\uff1aimx6ull\u200b\u6700\u591a\u4e3a\u200b32\u200b\u4e2a\u200b\u7ea7\u522b\u200b</p>"},{"location":"08_Interrupt/10_1/#3-binary-point-register-gicc_bpr","title":"3. Binary Point Register, GICC_BPR","text":"<p>\u200b   \u200b\u6b64\u200b\u5bc4\u5b58\u5668\u200b\u7528\u6765\u200b\u628a\u200b8\u200b\u4f4d\u200b\u7684\u200b\u4f18\u5148\u7ea7\u200b\u5b57\u6bb5\u200b\u62c6\u200b\u5206\u4e3a\u200b\u7ec4\u200b\u4f18\u5148\u7ea7\u200b\u548c\u5b50\u200b\u4f18\u5148\u7ea7\u200b\uff0c\u200b\u7ec4\u200b\u4f18\u5148\u7ea7\u200b\u7528\u6765\u200b\u51b3\u5b9a\u200b\u4e2d\u65ad\u200b\u62a2\u5360\u200b\u3002</p> <p> </p> \u200b\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b [31:3] - \u200b\u4fdd\u7559\u200b [2:0] Binary  point R/W \u200b\u6b64\u5b57\u200b\u6bb5\u200b\u7684\u200b\u503c\u200b\u63a7\u5236\u200b\u5982\u4f55\u200b\u5c06\u200b8bit\u200b\u4e2d\u65ad\u200b\u4f18\u5148\u7ea7\u200b\u5b57\u6bb5\u200b\u62c6\u200b\u5206\u4e3a\u200b\u7ec4\u200b\u4f18\u5148\u7ea7\u200b\u548c\u5b50\u200b\u4f18\u5148\u7ea7\u200b\uff0c\u200b\u7ec4\u200b\u4f18\u5148\u7ea7\u200b\u7528\u6765\u200b\u51b3\u5b9a\u200b\u4e2d\u65ad\u200b\u62a2\u5360\u200b\u3002  \u200b\u66f4\u200b\u591a\u200b\u4fe1\u606f\u200b\u8fd8\u200b\u5f97\u200b\u770b\u770b\u200bGIC\u200b\u624b\u518c\u200b\u3002"},{"location":"08_Interrupt/10_1/#4-interrupt-acknowledge-register-gicc_iar","title":"4. Interrupt Acknowledge Register, GICC_IAR","text":"<p>\u200b   CPU\u200b\u8bfb\u6b64\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u83b7\u5f97\u200b\u5f53\u524d\u200b\u4e2d\u65ad\u200b\u7684\u200binterrtup ID\u3002</p> <p> </p> \u200b\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b [31:13] - \u200b\u4fdd\u7559\u200b [12:10] CPUID R \u200b\u5bf9\u4e8e\u200bSGI\u200b\u7c7b\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5b83\u200b\u8868\u793a\u200b\u8c01\u200b\u53d1\u51fa\u200b\u4e86\u200b\u4e2d\u65ad\u200b\u3002\u200b\u4f8b\u5982\u200b\uff0c\u200b\u503c\u4e3a\u200b3\u200b\u8868\u793a\u200b\u8be5\u200b\u8bf7\u6c42\u200b\u662f\u200b\u901a\u8fc7\u200b\u5bf9\u200bCPU  interface 3\u200b\u4e0a\u200b\u7684\u200bGICD_SGIR\u200b\u7684\u200b\u5199\u200b\u64cd\u4f5c\u200b\u751f\u6210\u200b\u7684\u200b\u3002 [9:0] Interrupt ID R \u200b\u4e2d\u65ad\u200bID"},{"location":"08_Interrupt/10_1/#5-interrupt-register-gicc_eoir","title":"5. Interrupt Register, GICC_EOIR","text":"<p>\u200b   \u200b\u5199\u6b64\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u8868\u793a\u200b\u67d0\u200b\u4e2d\u65ad\u200b\u5df2\u7ecf\u200b\u5904\u7406\u5b8c\u6bd5\u200b\u3002GICC_IAR\u200b\u7684\u200b\u503c\u200b\u8868\u793a\u200b\u5f53\u524d\u200b\u5728\u200b\u5904\u7406\u200b\u7684\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u628a\u200bGICC_IAR\u200b\u7684\u200b\u503c\u200b\u5199\u5165\u200bGICC_EOIR\u200b\u5c31\u200b\u8868\u793a\u200b\u4e2d\u65ad\u200b\u5904\u7406\u200b\u5b8c\u200b\u4e86\u200b\u3002</p> <p> </p> \u200b\u4f4d\u57df\u200b \u200b\u540d\u200b \u200b\u8bfb\u5199\u200b \u200b\u63cf\u8ff0\u200b [31:13] - \u200b\u4fdd\u7559\u200b [12:10] CPUID W \u200b\u5bf9\u4e8e\u200bSGI\u200b\u7c7b\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u503c\u200b\u8ddf\u200bGICD_IAR. CPUID\u200b\u7684\u200b\u76f8\u540c\u200b\u3002 [9:0] EOIINTID W \u200b\u4e2d\u65ad\u200bID\uff0c\u200b\u5b83\u200b\u7684\u200b\u503c\u200b\u8ddf\u200bGICD_IAR\u200b\u91cc\u200b\u7684\u200b\u4e2d\u65ad\u200bID\u200b\u76f8\u540c"},{"location":"08_Interrupt/10_1/#13-gic","title":"1.3 GIC\u200b\u7f16\u7a0b","text":"<p>\u200b\u4f7f\u7528\u200bcortex A7\u200b\u5904\u7406\u5668\u200b\u7684\u200b\u82af\u7247\u200b\uff0c\u200b\u4e00\u822c\u200b\u90fd\u200b\u662f\u200b\u4f7f\u7528\u200bGIC v2\u200b\u7684\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u3002 \u200b\u5904\u7406\u200bGIC\u200b\u7684\u200b\u57fa\u200b\u5730\u5740\u200b\u4e0d\u200b\u4e00\u6837\u200b\u5916\u200b\uff0c\u200b\u5bf9\u200bGIC\u200b\u7684\u200b\u64cd\u4f5c\u200b\u90fd\u200b\u662f\u200b\u4e00\u6837\u200b\u7684\u200b\u3002 \u200b\u5728\u200bNXP\u200b\u5b98\u7f51\u200b\u53ef\u4ee5\u200b\u627e\u5230\u200bIMX6ULL\u200b\u7684\u200bSDK\u200b\u5305\u200b\u3002 \u200b\u4e0b\u8f7d\u200b\u540e\u200b\u53ef\u4ee5\u200b\u53c2\u8003\u200b\u8fd9\u4e2a\u200b\u6587\u4ef6\u200b\uff1acore_ca7.h\uff0c\u200b\u91cc\u9762\u200b\u542b\u6709\u200bGIC\u200b\u7684\u200b\u521d\u59cb\u5316\u200b\u4ee3\u7801\u200b\u3002</p>"},{"location":"08_Interrupt/11_1/","title":"04_\u200b\u5f02\u5e38\u200b\u5411\u91cf\u200b\u8868\u200b\u7684\u200b\u5b89\u88c5\u200b\u4e0e\u200b\u8c03\u7528","text":""},{"location":"08_Interrupt/11_1/#_1","title":"\u5f02\u5e38\u200b\u5411\u91cf\u200b\u8868\u200b\u7684\u200b\u5b89\u88c5\u200b\u4e0e\u200b\u8c03\u7528","text":""},{"location":"08_Interrupt/11_1/#1","title":"1. \u200b\u56de\u987e\u200b\u4e2d\u65ad\u200b\u7684\u200b\u53d1\u751f\u200b\u3001\u200b\u5904\u7406\u8fc7\u7a0b","text":"<ul> <li>\u200b\u4e2d\u65ad\u200b\u53d1\u751f\u200b\u7684\u200b\u786c\u4ef6\u200b\u8fc7\u7a0b\u200b</li> </ul> <ul> <li>\u200b\u4e2d\u65ad\u200b\u5904\u7406\u200b\u7684\u200b\u8f6f\u4ef6\u200b\u5904\u7406\u200b\u6d41\u7a0b\u200b</li> <li>CPU\u200b\u6267\u884c\u200b\u5b8c\u200b\u5f53\u524d\u200b\u6307\u4ee4\u200b\uff0c\u200b\u68c0\u67e5\u200b\u5230\u200b\u53d1\u751f\u200b\u4e86\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u8df3\u200b\u5230\u200b\u5411\u91cf\u200b\u8868\u200b</li> <li>\u200b\u4fdd\u5b58\u200b\u73b0\u573a\u200b\u3001\u200b\u6267\u884c\u200bGIC\u200b\u63d0\u4f9b\u200b\u7684\u200b\u5904\u7406\u51fd\u6570\u200b\u3001\u200b\u6062\u590d\u200b\u73b0\u573a\u200b</li> </ul>"},{"location":"08_Interrupt/11_1/#2","title":"2. \u200b\u5f02\u5e38\u200b\u5411\u91cf\u200b\u8868\u200b\u7684\u200b\u5b89\u88c5","text":""},{"location":"08_Interrupt/11_1/#21","title":"2.1 \u200b\u590d\u5236\u200b\u5411\u91cf\u200b\u8868","text":"<ul> <li>\u200b\u6c47\u7f16\u200b\u4ee3\u7801\u200b</li> </ul> <pre><code>// arch\\arm\\kernel\\head.S\n1. bl   __lookup_processor_type\n   ...... \n2. bl   __create_page_tables\n3. ldr  r13, =__mmap_switched\n4. b    __enable_mmu\n   b    __turn_mmu_on\n   mov  r3, r13\n   ret  r3\n5. __mmap_switched: // arch\\arm\\kernel\\head-common.S\n6. b    start_kernel\n</code></pre> <ul> <li>\u200b\u590d\u5236\u200b\u5411\u91cf\u200b\u8868\u200b</li> </ul> <pre><code>start_kernel // init\\main.c\n    setup_arch(&amp;command_line); // arch\\arm\\kernel\\setup.c\n        paging_init(mdesc);    // arch\\arm\\mm\\mmu.c\n            devicemaps_init(mdesc); // arch\\arm\\mm\\mmu.c\n                vectors = early_alloc(PAGE_SIZE * 2); // 1.\u200b\u5206\u914d\u200b\u65b0\u200b\u5411\u91cf\u200b\u8868\u200b\n                early_trap_init(vectors);             // 2.\u200b\u4ece\u200b\u4ee3\u7801\u200b\u628a\u200b\u5411\u91cf\u200b\u8868\u200b\u590d\u5236\u5230\u200b\u65b0\u200b\u5411\u91cf\u200b\u8868\u200b\n\n                // 3. \u200b\u6620\u5c04\u200b\u65b0\u200b\u5411\u91cf\u200b\u8868\u5230\u200b\u865a\u62df\u5730\u5740\u200b0xffff0000\n                /*\n                 * Create a mapping for the machine vectors at the high-vectors\n                 * location (0xffff0000).  If we aren't using high-vectors, also\n                 * create a mapping at the low-vectors virtual address.\n                 */\n                map.pfn = __phys_to_pfn(virt_to_phys(vectors));\n                map.virtual = 0xffff0000;\n                map.length = PAGE_SIZE;\n            #ifdef CONFIG_KUSER_HELPERS\n                map.type = MT_HIGH_VECTORS;\n            #else\n                map.type = MT_LOW_VECTORS;\n            #endif\n                create_mapping(&amp;map);\n</code></pre>"},{"location":"08_Interrupt/11_1/#22","title":"2.2 \u200b\u5411\u91cf\u200b\u8868\u5728\u200b\u54ea","text":"<p>\u200b\u4e0a\u9762\u200b\u4ee3\u7801\u200b\u4e2d\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200b\u4ee3\u7801\u200b\u4e2d\u200b\u5411\u91cf\u200b\u8868\u200b\u4f4d\u4e8e\u200b<code>__vectors_start</code>\uff0c\u200b\u5b83\u200b\u5728\u200b<code>arch/arm/kernel/vmlinux.lds</code>\u200b\u4e2d\u200b\u5b9a\u4e49\u200b\uff1a</p> <pre><code> __vectors_start = .;\n .vectors 0xffff0000 : AT(__vectors_start) {\n  *(.vectors)\n }\n . = __vectors_start + SIZEOF(.vectors);\n __vectors_end = .;\n __stubs_start = .;\n .stubs ADDR(.vectors) + 0x1000 : AT(__stubs_start) {\n  *(.stubs)\n }\n</code></pre> <p>\u200b\u5728\u200b\u4ee3\u7801\u200b\u91cc\u200b\u641c\u200b<code>.vectors</code>\uff0c\u200b\u53ef\u4ee5\u200b\u627e\u5230\u200b\u5411\u91cf\u200b\u8868\u200b\uff1a</p> <p></p>"},{"location":"08_Interrupt/11_1/#3","title":"3. \u200b\u4e2d\u65ad\u5411\u91cf","text":"<p>\u200b\u53d1\u751f\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0cCPU\u200b\u8df3\u200b\u5230\u200b\u5411\u91cf\u200b\u8868\u53bb\u200b\u6267\u884c\u200b<code>b vector_irq</code>\u3002</p> <p>vector_irq\u200b\u51fd\u6570\u200b\u4f7f\u7528\u200b\u5b8f\u6765\u200b\u5b9a\u4e49\u200b\uff1a</p> <p></p>"},{"location":"08_Interrupt/11_1/#4","title":"4. \u200b\u5904\u7406\u200b\u6d41\u7a0b","text":""},{"location":"08_Interrupt/11_1/#5","title":"5. \u200b\u5904\u7406\u51fd\u6570","text":""},{"location":"08_Interrupt/12_1/","title":"05_GIC\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5bf9\u200b\u4e2d\u65ad\u200b\u7684\u200b\u5904\u7406\u200b\u6d41\u7a0b","text":""},{"location":"08_Interrupt/12_1/#gic","title":"GIC\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5bf9\u200b\u4e2d\u65ad\u200b\u7684\u200b\u5904\u7406\u200b\u6d41\u7a0b","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>linux kernel\u200b\u7684\u200b\u4e2d\u65ad\u200b\u5b50\u7cfb\u7edf\u200b\u4e4b\u200b\uff08\u200b\u4e03\u200b\uff09\uff1aGIC\u200b\u4ee3\u7801\u200b\u5206\u6790\u200b</li> </ul> <p>\u200b\u4f7f\u7528\u200b\u9010\u6b65\u200b\u6f14\u8fdb\u200b\u7684\u200b\u65b9\u6cd5\u200b\u624d\u80fd\u200b\u5f62\u8c61\u200b\u5730\u200b\u7406\u89e3\u200b\u3002</p>"},{"location":"08_Interrupt/12_1/#1","title":"1. \u200b\u4e00\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u5904\u7406\u200b\u6d41\u7a0b","text":"<p>\u200b\u5bf9\u4e8e\u200birq_desc\uff0c\u200b\u5185\u6838\u200b\u6709\u200b\u4e24\u79cd\u200b\u5206\u914d\u200b\u65b9\u6cd5\u200b\uff1a</p> <ul> <li>\u200b\u4e00\u6b21\u200b\u5206\u914d\u200b\u5b8c\u200b\u6240\u6709\u200b\u7684\u200birq_desc</li> <li>\u200b\u6309\u9700\u5206\u914d\u200b(\u200b\u7528\u5230\u200b\u67d0\u4e2a\u200b\u4e2d\u65ad\u200b\u624d\u200b\u5206\u914d\u200b\u5b83\u200b\u7684\u200birq_desc</li> </ul> <p>\u200b\u73b0\u5728\u200b\u7684\u200b\u5185\u6838\u200b\u57fa\u672c\u200b\u4f7f\u7528\u200b\u7b2c\u200b1\u200b\u79cd\u200b\u65b9\u6cd5\u200b\u3002</p> <p></p> <ul> <li>\u200b\u5047\u8bbe\u200bGIC\u200b\u53ef\u4ee5\u200b\u5411\u200bCPU\u200b\u53d1\u51fa\u200b16<sub>1019\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u6570\u5b57\u200b\u88ab\u200b\u79f0\u4e3a\u200bhwirq\u30020</sub>15\u200b\u7528\u4e8e\u200bProcess\u200b\u4e4b\u95f4\u200b\u901a\u4fe1\u200b\uff0c\u200b\u6bd4\u8f83\u200b\u7279\u6b8a\u200b\u3002</li> <li>\u200b\u5047\u8bbe\u200b\u8981\u200b\u4f7f\u7528\u200bUART\u200b\u6a21\u5757\u200b\uff0c\u200b\u5b83\u200b\u53d1\u51fa\u200b\u7684\u200b\u4e2d\u65ad\u200b\u8fde\u63a5\u200b\u5230\u200bGIC\u200b\u7684\u200b32\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5206\u914d\u200b\u7684\u200birq_desc\u200b\u5e8f\u53f7\u200b\u4e3a\u200b16</li> <li>\u200b\u5728\u200bGIC domain\u200b\u4e2d\u200b\u4f1a\u200b\u8bb0\u5f55\u200b(32, 16)</li> <li>\u200b\u90a3\u4e48\u200b\u6ce8\u518c\u200b\u4e2d\u65ad\u200b\u65f6\u200b\u5c31\u662f\u200b\uff1a<code>request_irq(16, ...)</code></li> <li>\u200b\u53d1\u751f\u200bUART\u200b\u4e2d\u65ad\u200b\u65f6\u200b</li> <li>\u200b\u7a0b\u5e8f\u200b\u4ece\u200bGIC\u200b\u4e2d\u200b\u8bfb\u53d6\u200b\u5bc4\u5b58\u5668\u200b\u77e5\u9053\u200b\u53d1\u751f\u200b\u4e86\u200b32\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u901a\u8fc7\u200bGIC irq_domain\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200bvirq\u200b\u4e3a\u200b16</li> <li>\u200b\u8c03\u7528\u200birq_desc[16]\u200b\u4e2d\u200b\u7684\u200bhandleA\u200b\u51fd\u6570\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u4f5c\u7528\u200b\u662f\u200b\u8c03\u7528\u200baction\u200b\u94fe\u8868\u200b\u4e2d\u200b\u7528\u6237\u6ce8\u518c\u200b\u7684\u200b\u51fd\u6570\u200b</li> </ul>"},{"location":"08_Interrupt/12_1/#2","title":"2. \u200b\u591a\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u5904\u7406\u200b\u6d41\u7a0b","text":"<ul> <li>\u200b\u5047\u8bbe\u200bGPIO\u200b\u6a21\u5757\u200b\u4e0b\u200b\u6709\u200b4\u200b\u4e2a\u200b\u5f15\u811a\u200b\uff0c\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u4ea7\u751f\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u90fd\u200b\u8fde\u63a5\u200b\u5230\u200bGIC\u200b\u7684\u200b33\u200b\u53f7\u200b\u4e2d\u65ad\u200b</li> <li>GPIO\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u770b\u4f5c\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u5bf9\u4e8e\u200b\u5b83\u200b\u7684\u200b4\u200b\u4e2a\u200b\u4e2d\u65ad\u200b</li> <li>\u200b\u5bf9\u4e8e\u200bGPIO\u200b\u6a21\u5757\u200b\u4e2d\u200b0~3\u200b\u8fd9\u200b\u56db\u4e2a\u200bhwirq\uff0c\u200b\u4e00\u822c\u200b\u90fd\u200b\u4f1a\u200b\u4e00\u4e0b\u5b50\u200b\u5206\u914d\u200b\u56db\u4e2a\u200birq_desc</li> <li>\u200b\u5047\u8bbe\u200b\u8fd9\u200b4\u200b\u4e2a\u200birq_desc\u200b\u7684\u200b\u5e8f\u53f7\u200b\u4e3a\u200b100~103\uff0c\u200b\u5728\u200bGPIO domain\u200b\u4e2d\u200b\u8bb0\u5f55\u200b(0,100) (1,101)(2,102) (3,103)</li> <li>\u200b\u5bf9\u4e8e\u200bKEY\uff0c\u200b\u6ce8\u518c\u200b\u4e2d\u65ad\u200b\u65f6\u200b\u5c31\u662f\u200b\uff1a<code>request_irq(102, ...)</code></li> <li>\u200b\u6309\u4e0b\u200bKEY\u200b\u65f6\u200b\uff1a</li> <li>\u200b\u7a0b\u5e8f\u200b\u4ece\u200bGIC\u200b\u4e2d\u200b\u8bfb\u53d6\u200b\u5bc4\u5b58\u5668\u200b\u77e5\u9053\u200b\u53d1\u751f\u200b\u4e86\u200b33\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u901a\u8fc7\u200bGIC irq_domain\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200bvirq\u200b\u4e3a\u200b16</li> <li>\u200b\u8c03\u7528\u200birq_desc[16]\u200b\u4e2d\u200b\u7684\u200bhandleB\u200b\u51fd\u6570\u200b<ul> <li>handleB\u200b\u8bfb\u53d6\u200bGPIO\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u786e\u5b9a\u200b\u662f\u200bGPIO\u200b\u91cc\u200b2\u200b\u53f7\u200b\u5f15\u811a\u200b\u53d1\u751f\u200b\u4e2d\u65ad\u200b</li> <li>\u200b\u901a\u8fc7\u200bGPIO irq_domain\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200bvirq\u200b\u4e3a\u200b102</li> <li>\u200b\u8c03\u7528\u200birq_desc[102]\u200b\u4e2d\u200b\u7684\u200bhandleA\u200b\u51fd\u6570\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u4f5c\u7528\u200b\u662f\u200b\u8c03\u7528\u200baction\u200b\u94fe\u8868\u200b\u4e2d\u200b\u7528\u6237\u6ce8\u518c\u200b\u7684\u200b\u51fd\u6570\u200b</li> </ul> </li> </ul>"},{"location":"08_Interrupt/13_1/","title":"06_GIC\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5206\u6790","text":""},{"location":"08_Interrupt/13_1/#gic","title":"GIC\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5206\u6790","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>linux kernel\u200b\u7684\u200b\u4e2d\u65ad\u200b\u5b50\u7cfb\u7edf\u200b\u4e4b\u200b\uff08\u200b\u4e03\u200b\uff09\uff1aGIC\u200b\u4ee3\u7801\u200b\u5206\u6790\u200b</p> </li> <li> <p>Linux 4.9.88\u200b\u5185\u6838\u200b\u6e90\u7801\u200b</p> </li> <li> <p><code>Linux-4.9.88\\drivers\\irqchip\\irq-gic.c</code></p> </li> <li> <p><code>Linux-4.9.88/arch/arm/boot/dts/imx6ull.dtsi</code></p> </li> <li> <p>Linux 5.4\u200b\u5185\u6838\u200b\u6e90\u7801\u200b</p> </li> <li> <p><code>Linux-5.4\\drivers\\irqchip\\irq-gic.c</code></p> </li> <li><code>Linux-5.4/arch/arm/boot/dts/stm32mp151.dtsi</code></li> </ul>"},{"location":"08_Interrupt/13_1/#1-gic","title":"1. \u200b\u56de\u987e\u200bGIC\u200b\u4e2d\u65ad\u200b\u5904\u7406\u200b\u6d41\u7a0b","text":"<p>\u200b\u4f7f\u7528\u200b\u9010\u6b65\u200b\u6f14\u8fdb\u200b\u7684\u200b\u65b9\u6cd5\u200b\u624d\u80fd\u200b\u5f62\u8c61\u200b\u5730\u200b\u7406\u89e3\u200b\u3002</p>"},{"location":"08_Interrupt/13_1/#11","title":"1.1 \u200b\u4e00\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u5904\u7406\u200b\u6d41\u7a0b","text":"<p>\u200b\u5bf9\u4e8e\u200birq_desc\uff0c\u200b\u5185\u6838\u200b\u6709\u200b\u4e24\u79cd\u200b\u5206\u914d\u200b\u65b9\u6cd5\u200b\uff1a</p> <ul> <li>\u200b\u4e00\u6b21\u200b\u5206\u914d\u200b\u5b8c\u200b\u6240\u6709\u200b\u7684\u200birq_desc</li> <li>\u200b\u6309\u9700\u5206\u914d\u200b(\u200b\u7528\u5230\u200b\u67d0\u4e2a\u200b\u4e2d\u65ad\u200b\u624d\u200b\u5206\u914d\u200b\u5b83\u200b\u7684\u200birq_desc</li> </ul> <p>\u200b\u73b0\u5728\u200b\u7684\u200b\u5185\u6838\u200b\u57fa\u672c\u200b\u4f7f\u7528\u200b\u7b2c\u200b1\u200b\u79cd\u200b\u65b9\u6cd5\u200b\u3002</p> <p></p> <ul> <li>\u200b\u5047\u8bbe\u200bGIC\u200b\u53ef\u4ee5\u200b\u5411\u200bCPU\u200b\u53d1\u51fa\u200b16<sub>1019\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u6570\u5b57\u200b\u88ab\u200b\u79f0\u4e3a\u200bhwirq\u30020</sub>15\u200b\u7528\u4e8e\u200bProcess\u200b\u4e4b\u95f4\u200b\u901a\u4fe1\u200b\uff0c\u200b\u6bd4\u8f83\u200b\u7279\u6b8a\u200b\u3002</li> <li>\u200b\u5047\u8bbe\u200b\u8981\u200b\u4f7f\u7528\u200bUART\u200b\u6a21\u5757\u200b\uff0c\u200b\u5b83\u200b\u53d1\u51fa\u200b\u7684\u200b\u4e2d\u65ad\u200b\u8fde\u63a5\u200b\u5230\u200bGIC\u200b\u7684\u200b32\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5206\u914d\u200b\u7684\u200birq_desc\u200b\u5e8f\u53f7\u200b\u4e3a\u200b16</li> <li>\u200b\u5728\u200bGIC domain\u200b\u4e2d\u200b\u4f1a\u200b\u8bb0\u5f55\u200b(32, 16)</li> <li>\u200b\u90a3\u4e48\u200b\u6ce8\u518c\u200b\u4e2d\u65ad\u200b\u65f6\u200b\u5c31\u662f\u200b\uff1a<code>request_irq(16, ...)</code></li> <li>\u200b\u53d1\u751f\u200bUART\u200b\u4e2d\u65ad\u200b\u65f6\u200b</li> <li>\u200b\u7a0b\u5e8f\u200b\u4ece\u200bGIC\u200b\u4e2d\u200b\u8bfb\u53d6\u200b\u5bc4\u5b58\u5668\u200b\u77e5\u9053\u200b\u53d1\u751f\u200b\u4e86\u200b32\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u901a\u8fc7\u200bGIC irq_domain\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200bvirq\u200b\u4e3a\u200b16</li> <li>\u200b\u8c03\u7528\u200birq_desc[16]\u200b\u4e2d\u200b\u7684\u200bhandleA\u200b\u51fd\u6570\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u4f5c\u7528\u200b\u662f\u200b\u8c03\u7528\u200baction\u200b\u94fe\u8868\u200b\u4e2d\u200b\u7528\u6237\u6ce8\u518c\u200b\u7684\u200b\u51fd\u6570\u200b</li> </ul>"},{"location":"08_Interrupt/13_1/#12","title":"1.2 \u200b\u591a\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u5904\u7406\u200b\u6d41\u7a0b","text":"<ul> <li>\u200b\u5047\u8bbe\u200bGPIO\u200b\u6a21\u5757\u200b\u4e0b\u200b\u6709\u200b4\u200b\u4e2a\u200b\u5f15\u811a\u200b\uff0c\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u4ea7\u751f\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u90fd\u200b\u8fde\u63a5\u200b\u5230\u200bGIC\u200b\u7684\u200b33\u200b\u53f7\u200b\u4e2d\u65ad\u200b</li> <li>GPIO\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u770b\u4f5c\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u5bf9\u4e8e\u200b\u5b83\u200b\u7684\u200b4\u200b\u4e2a\u200b\u4e2d\u65ad\u200b</li> <li>\u200b\u5bf9\u4e8e\u200bGPIO\u200b\u6a21\u5757\u200b\u4e2d\u200b0~3\u200b\u8fd9\u200b\u56db\u4e2a\u200bhwirq\uff0c\u200b\u4e00\u822c\u200b\u90fd\u200b\u4f1a\u200b\u4e00\u4e0b\u5b50\u200b\u5206\u914d\u200b\u56db\u4e2a\u200birq_desc</li> <li>\u200b\u5047\u8bbe\u200b\u8fd9\u200b4\u200b\u4e2a\u200birq_desc\u200b\u7684\u200b\u5e8f\u53f7\u200b\u4e3a\u200b100~103\uff0c\u200b\u5728\u200bGPIO domain\u200b\u4e2d\u200b\u8bb0\u5f55\u200b(0,100) (1,101)(2,102) (3,103)</li> <li>\u200b\u5bf9\u4e8e\u200bKEY\uff0c\u200b\u6ce8\u518c\u200b\u4e2d\u65ad\u200b\u65f6\u200b\u5c31\u662f\u200b\uff1a<code>request_irq(102, ...)</code></li> <li>\u200b\u6309\u4e0b\u200bKEY\u200b\u65f6\u200b\uff1a</li> <li>\u200b\u7a0b\u5e8f\u200b\u4ece\u200bGIC\u200b\u4e2d\u200b\u8bfb\u53d6\u200b\u5bc4\u5b58\u5668\u200b\u77e5\u9053\u200b\u53d1\u751f\u200b\u4e86\u200b33\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u901a\u8fc7\u200bGIC irq_domain\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200bvirq\u200b\u4e3a\u200b17</li> <li>\u200b\u8c03\u7528\u200birq_desc[17]\u200b\u4e2d\u200b\u7684\u200bhandleB\u200b\u51fd\u6570\u200b<ul> <li>handleB\u200b\u8bfb\u53d6\u200bGPIO\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u786e\u5b9a\u200b\u662f\u200bGPIO\u200b\u91cc\u200b2\u200b\u53f7\u200b\u5f15\u811a\u200b\u53d1\u751f\u200b\u4e2d\u65ad\u200b</li> <li>\u200b\u901a\u8fc7\u200bGPIO irq_domain\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200bvirq\u200b\u4e3a\u200b102</li> <li>\u200b\u8c03\u7528\u200birq_desc[102]\u200b\u4e2d\u200b\u7684\u200bhandleA\u200b\u51fd\u6570\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u4f5c\u7528\u200b\u662f\u200b\u8c03\u7528\u200baction\u200b\u94fe\u8868\u200b\u4e2d\u200b\u7528\u6237\u6ce8\u518c\u200b\u7684\u200b\u51fd\u6570\u200b</li> </ul> </li> </ul>"},{"location":"08_Interrupt/13_1/#2-gic","title":"2. GIC\u200b\u4e2d\u200b\u7684\u200b\u91cd\u8981\u200b\u51fd\u6570\u200b\u548c\u200b\u7ed3\u6784\u200b\u4f53","text":"<p>\u200b\u6cbf\u7740\u200b\u4e2d\u65ad\u200b\u7684\u200b\u5904\u7406\u200b\u6d41\u7a0b\u200b\uff0cGIC\u200b\u6d89\u53ca\u200b\u8fd9\u200b4\u200b\u4e2a\u200b\u91cd\u8981\u200b\u90e8\u5206\u200b\uff1a</p> <ul> <li>CPU\u200b\u4ece\u200b\u5f02\u5e38\u200b\u5411\u91cf\u200b\u8868\u4e2d\u200b\u8c03\u7528\u200bhandle_arch_irq\uff0c\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u6307\u9488\u200b\u662f\u200b\u6709\u200bGIC\u200b\u9a71\u52a8\u200b\u8bbe\u7f6e\u200b\u7684\u200b</li> <li>GIC\u200b\u624d\u200b\u77e5\u9053\u200b\u600e\u4e48\u200b\u5224\u65ad\u200b\u53d1\u751f\u200b\u7684\u200b\u662f\u200b\u54ea\u4e2a\u200bGIC\u200b\u4e2d\u65ad\u200b</li> <li>\u200b\u4ece\u200bGIC\u200b\u83b7\u5f97\u200bhwirq\u200b\u540e\u200b\uff0c\u200b\u8981\u200b\u8f6c\u6362\u200b\u4e3a\u200bvirq\uff1a\u200b\u9700\u8981\u200b\u6709\u200bGIC Domain</li> <li>\u200b\u8c03\u7528\u200birq_desc[virq].handle_irq\u200b\u51fd\u6570\u200b\uff1a\u200b\u8fd9\u200b\u4e5f\u200b\u5e94\u8be5\u200b\u7531\u200bGIC\u200b\u9a71\u52a8\u200b\u63d0\u4f9b\u200b</li> <li>\u200b\u5904\u7406\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u8981\u200b\u5c4f\u853d\u200b\u4e2d\u65ad\u200b\u3001\u200b\u6e05\u9664\u200b\u4e2d\u65ad\u200b\u7b49\u200b\uff1a\u200b\u8fd9\u4e9b\u200b\u51fd\u6570\u200b\u4fdd\u5b58\u200b\u5728\u200birq_chip\u200b\u91cc\u200b\uff0c\u200b\u7531\u200bGIC\u200b\u9a71\u52a8\u200b\u63d0\u4f9b\u200b</li> </ul> <p>\u200b\u4ece\u200b\u786c\u4ef6\u200b\u4e0a\u200b\u770b\u200b\uff0cGIC\u200b\u7684\u200b\u529f\u80fd\u200b\u662f\u200b\u4ec0\u4e48\u200b\uff1f</p> <ul> <li>\u200b\u53ef\u4ee5\u200b\u4f7f\u80fd\u200b\u3001\u200b\u5c4f\u853d\u200b\u4e2d\u65ad\u200b</li> <li>\u200b\u53d1\u751f\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u4ece\u200bGIC\u200b\u91cc\u200b\u5224\u65ad\u200b\u662f\u200b\u54ea\u4e2a\u200b\u4e2d\u65ad\u200b</li> </ul> <p>\u200b\u5728\u200b\u5185\u6838\u200b\u91cc\u200b\uff0c\u200b\u4f7f\u7528\u200bgic_chip_data\u200b\u7ed3\u6784\u200b\u4f53\u200b\u8868\u793a\u200bGIC\uff0cgic_chip_data\u200b\u91cc\u200b\u6709\u200b\u4ec0\u4e48\u200b\uff1f</p> <ul> <li> <p>irq_chip\uff1a\u200b\u4e2d\u65ad\u200b\u4f7f\u80fd\u200b\u3001\u200b\u5c4f\u853d\u200b\u3001\u200b\u6e05\u9664\u200b\uff0c\u200b\u653e\u5728\u200birq_chip\u200b\u4e2d\u200b\u7684\u200b\u5404\u4e2a\u200b\u51fd\u6570\u200b\u91cc\u200b\u5b9e\u73b0\u200b   </p> </li> <li> <p>irq_domain</p> </li> <li>\u200b\u7533\u8bf7\u200b\u4e2d\u65ad\u200b\u65f6\u200b<ul> <li>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u5b9a\u200bhwirq\u3001flag\uff0c\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200birq_domain\u200b\u7684\u200b\u51fd\u6570\u200b\u6765\u200b\u89e3\u6790\u200b\u8bbe\u5907\u200b\u6811\u200b</li> <li>\u200b\u6839\u636e\u200bhwirq\u200b\u53ef\u4ee5\u200b\u5206\u914d\u200bvirq\uff0c\u200b\u628a\u200b(hwirq, virq)\u200b\u5b58\u5165\u200birq_domain\u200b\u4e2d\u200b</li> </ul> </li> <li>\u200b\u53d1\u751f\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u4ece\u200bGIC\u200b\u8bfb\u51fa\u200bhwirq\uff0c\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200birq_domain\u200b\u627e\u5230\u200bvirq\uff0c\u200b\u4ece\u800c\u200b\u627e\u5230\u200b\u5904\u7406\u51fd\u6570\u200b</li> </ul> <p>\u200b\u6240\u4ee5\u200b\uff0cGIC\u200b\u7528\u200bgic_chip_data\u200b\u6765\u200b\u8868\u793a\u200b\uff0cgic_chip_data\u200b\u4e2d\u200b\u91cd\u8981\u200b\u7684\u200b\u6210\u5458\u200b\u662f\u200b\uff1airq_chip\u3001irq_domain\u3002</p>"},{"location":"08_Interrupt/13_1/#3-gic","title":"3. GIC\u200b\u521d\u59cb\u5316\u200b\u8fc7\u7a0b","text":"<pre><code>start_kernel (init\\main.c)\n    init_IRQ (arch\\arm\\kernel\\irq.c)\n        irqchip_init (drivers\\irqchip\\irqchip.c)\n            of_irq_init (drivers\\of\\irq.c)\n                desc-&gt;irq_init_cb = match-&gt;data;\n\n                ret = desc-&gt;irq_init_cb(desc-&gt;dev,\n                            desc-&gt;interrupt_parent);\n</code></pre>"},{"location":"08_Interrupt/13_1/#21-gic","title":"2.1 \u200b\u5185\u6838\u200b\u652f\u6301\u200b\u591a\u79cd\u200bGIC","text":"<p>\u200b\u6309\u7167\u200b\u8bbe\u5907\u200b\u6811\u200b\u7684\u200b\u5957\u8def\u200b\uff1a</p> <ul> <li>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6ce8\u518c\u200bplatform_driver</li> <li>\u200b\u5b83\u200b\u7684\u200bof_match_table\u200b\u91cc\u200b\u6709\u200b\u591a\u4e2a\u200bof_device_id\uff0c\u200b\u8868\u793a\u200b\u80fd\u200b\u652f\u6301\u200b\u591a\u4e2a\u200b\u8bbe\u5907\u200b</li> <li>\u200b\u6709\u200b\u591a\u79cd\u200b\u7248\u672c\u200b\u7684\u200bGIC\uff0c\u200b\u5728\u200b\u5185\u6838\u200b\u4e3a\u200b\u6bcf\u200b\u4e00\u7c7b\u200bGIC\u200b\u5b9a\u4e49\u200b\u4e00\u4e2a\u200b\u7ed3\u6784\u200b\u4f53\u200bof_device_id\uff0c\u200b\u5e76\u200b\u653e\u5728\u200b\u4e00\u4e2a\u200b\u6bb5\u91cc\u200b\uff1a</li> </ul> <pre><code>// drivers\\irqchip\\irq-gic.c\nIRQCHIP_DECLARE(gic_400, \"arm,gic-400\", gic_of_init);\nIRQCHIP_DECLARE(arm11mp_gic, \"arm,arm11mp-gic\", gic_of_init);\nIRQCHIP_DECLARE(arm1176jzf_dc_gic, \"arm,arm1176jzf-devchip-gic\", gic_of_init);\nIRQCHIP_DECLARE(cortex_a15_gic, \"arm,cortex-a15-gic\", gic_of_init);\nIRQCHIP_DECLARE(cortex_a9_gic, \"arm,cortex-a9-gic\", gic_of_init);\nIRQCHIP_DECLARE(cortex_a7_gic, \"arm,cortex-a7-gic\", gic_of_init);\nIRQCHIP_DECLARE(msm_8660_qgic, \"qcom,msm-8660-qgic\", gic_of_init);\nIRQCHIP_DECLARE(msm_qgic2, \"qcom,msm-qgic2\", gic_of_init);\nIRQCHIP_DECLARE(pl390, \"arm,pl390\", gic_of_init);\n</code></pre> <p>\u200b\u628a\u200b\u5b8f\u200b<code>IRQCHIP_DECLARE</code>\u200b\u5c55\u5f00\u200b\uff1a</p> <pre><code>// include\\linux\\irqchip.h\n#define IRQCHIP_DECLARE(name, compat, fn) OF_DECLARE_2(irqchip, name, compat, fn)\n\n#define OF_DECLARE_2(table, name, compat, fn) \\\n        _OF_DECLARE(table, name, compat, fn, of_init_fn_2)\n\n#define _OF_DECLARE(table, name, compat, fn, fn_type)           \\\n    static const struct of_device_id __of_table_##name      \\\n        __used __section(__irqchip_of_table)            \\\n         = { .compatible = compat,              \\\n             .data = (fn == (fn_type)NULL) ? fn : fn  }\n</code></pre> <p>\u200b\u5c55\u5f00\u200b\u793a\u4f8b\u200b\uff1a</p> <pre><code>IRQCHIP_DECLARE(cortex_a7_gic, \"arm,cortex-a7-gic\", gic_of_init);\n\u200b\u5c55\u5f00\u200b\u540e\u200b\u5f97\u5230\u200b\uff1a\nstatic const struct of_device_id __of_table_cortex_a7_gic       \\\n    __used __section(__irqchip_of_table)            \\\n     = { .compatible = \"arm,cortex-a7-gic\",             \\\n         .data = gic_of_init  }\n</code></pre>"},{"location":"08_Interrupt/13_1/#22-gic","title":"2.2 \u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u5b9a\u200bGIC","text":"<p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\u6307\u5b9a\u200bGIC\uff0c\u200b\u5185\u6838\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6839\u636e\u200b\u8bbe\u5907\u200b\u6811\u6765\u200b\u9009\u62e9\u200b\u3001\u200b\u521d\u59cb\u5316\u200bGIC\u3002</p> <p><code>drivers\\irqchip\\irqchip.c</code>\u200b\u4e2d\u200b\u5e76\u200b\u6ca1\u6709\u200b\u5b9a\u4e49\u200b\u4e00\u4e2a\u200bplatform_driver\uff0c\u200b\u4f46\u662f\u200b\u5957\u8def\u200b\u662f\u200b\u4e00\u6837\u200b\u7684\u200b\u3002</p> <p></p> <p>\u200b\u8c03\u7528\u200b\u8fc7\u7a0b\u200b\uff1a</p> <p></p> <p>of_irq_init:</p> <ul> <li>\u200b\u5185\u6838\u200b\u6709\u200b\u4e00\u4e2a\u200b__irqchip_of_table\u200b\u6570\u7ec4\u200b\uff0c\u200b\u91cc\u9762\u200b\u6709\u200b\u591a\u4e2a\u200bof_device_id\uff0c\u200b\u8868\u793a\u200b\u591a\u79cd\u200bGIC</li> <li>\u200b\u8981\u200b\u4f7f\u7528\u200b\u54ea\u7c7b\u200bGIC\uff1f\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u5b9a\u200b</li> <li>\u200b\u6839\u636e\u200b\u8bbe\u5907\u200b\u6811\u200b\uff0c\u200b\u627e\u5230\u200b__irqchip_of_table\u200b\u6811\u7ec4\u200b\u4e2d\u200b\u5bf9\u5e94\u200b\u7684\u200b\u9879\u200b\uff0c\u200b\u8c03\u7528\u200b\u5b83\u200b\u7684\u200b\u521d\u59cb\u5316\u200b\u51fd\u6570\u200b</li> <li><code>IRQCHIP_DECLARE(cortex_a7_gic, \"arm,cortex-a7-gic\", gic_of_init);</code> </li> </ul>"},{"location":"08_Interrupt/13_1/#23-gic_of_init","title":"2.3 gic_of_init\u200b\u5206\u6790","text":"<p>\u200b\u770b\u200b\u89c6\u9891\u200b</p>"},{"location":"08_Interrupt/13_1/#3-gic_1","title":"3. \u200b\u7533\u8bf7\u200bGIC\u200b\u4e2d\u65ad","text":""},{"location":"08_Interrupt/13_1/#31","title":"3.1 \u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u5b9a\u200b\u4e2d\u65ad","text":""},{"location":"08_Interrupt/13_1/#32","title":"3.2 \u200b\u5185\u6838\u200b\u5bf9\u200b\u8bbe\u5907\u200b\u6811\u200b\u7684\u200b\u5904\u7406","text":"<p>\u200b\u51fd\u6570\u8c03\u7528\u200b\u8fc7\u7a0b\u200b\u5982\u4e0b\u200b\uff0c\u200b\u4f7f\u7528\u200b\u56fe\u7247\u200b\u5f62\u5f0f\u200b\u53ef\u4ee5\u200b\u4e00\u76ee\u4e86\u7136\u200b\uff1a</p> <p></p> <p>\u200b\u51fd\u6570\u8c03\u7528\u200b\u8fc7\u7a0b\u200b\u5982\u4e0b\u200b\uff0c\u200b\u4f7f\u7528\u200b\u6587\u5b57\u200b\u683c\u5f0f\u200b\u65b9\u4fbf\u200b\u590d\u5236\u200b\uff1a</p> <ul> <li>\u200b\u4e3a\u200b\u8bbe\u5907\u200b\u6811\u200b\u8282\u70b9\u200b\u5206\u914d\u200b\u8bbe\u5907\u200b   <pre><code>of_device_alloc (drivers/of/platform.c)\n    dev = platform_device_alloc(\"\", -1);  // \u200b\u5206\u914d\u200b platform_device   \n    num_irq = of_irq_count(np);  // \u200b\u8ba1\u7b97\u200b\u4e2d\u65ad\u200b\u6570\u200b\n\n    // drivers/of/irq.c, \u200b\u6839\u636e\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u4e2d\u200b\u7684\u200b\u4e2d\u65ad\u200b\u4fe1\u606f\u200b, \u200b\u6784\u9020\u200b\u4e2d\u65ad\u200b\u8d44\u6e90\u200b\n    of_irq_to_resource_table(np, res, num_irq) \n        of_irq_to_resource // drivers\\of\\irq.c\n            int irq = irq_of_parse_and_map(dev, index);  // \u200b\u83b7\u5f97\u200bvirq, \u200b\u4e2d\u65ad\u200b\u53f7\u200b\n</code></pre> <ul> <li>\u200b\u89e3\u6790\u200b\u8bbe\u5907\u200b\u6811\u200b\u6620\u5c04\u200b\u4e2d\u65ad\u200b: irq_of_parse_and_map</li> </ul> </li> </ul> <pre><code>// drivers/of/irq.c, \u200b\u89e3\u6790\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\u7684\u200b\u4e2d\u65ad\u200b\u4fe1\u606f\u200b, \u200b\u4fdd\u5b58\u200b\u5728\u200bof_phandle_args\u200b\u7ed3\u6784\u200b\u4f53\u4e2d\u200b\nof_irq_parse_one(dev, index, &amp;oirq)\n\n// kernel/irq/irqdomain.c, \u200b\u521b\u5efa\u200b\u4e2d\u65ad\u200b\u6620\u5c04\u200b\nirq_create_of_mapping(&amp;oirq);             \n  irq_create_fwspec_mapping(&amp;fwspec);\n      // \u200b\u8c03\u7528\u200birq_domain-&gt;ops\u200b\u7684\u200btranslate\u200b\u6216\u200bxlate,\u200b\u628a\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u91cc\u200b\u7684\u200b\u4e2d\u65ad\u200b\u4fe1\u606f\u200b\u89e3\u6790\u200b\u4e3a\u200bhwirq, type\n      irq_domain_translate(domain, fwspec, &amp;hwirq, &amp;type)  \n\n      // \u200b\u770b\u770b\u200b\u8fd9\u4e2a\u200bhwirq\u200b\u662f\u5426\u200b\u5df2\u7ecf\u200b\u6620\u5c04\u200b, \u200b\u5982\u679c\u200bvirq\u200b\u975e\u200b0\u200b\u5c31\u200b\u76f4\u63a5\u200b\u8fd4\u56de\u200b\n      virq = irq_find_mapping(domain, hwirq); \n\n      // \u200b\u5426\u5219\u200b\u521b\u5efa\u200b\u6620\u5c04\u200b   \n      if (irq_domain_is_hierarchy(domain)) {\n          // \u200b\u8fd4\u56de\u200b\u672a\u200b\u5360\u7528\u200b\u7684\u200bvirq\n          // \u200b\u5e76\u7528\u200birq_domain-&gt;ops-&gt;alloc\u200b\u51fd\u6570\u200b\u8bbe\u7f6e\u200birq_desc\n          virq = irq_domain_alloc_irqs(domain, 1, NUMA_NO_NODE, fwspec);\n          if (virq &lt;= 0)\n              return 0;\n      } else {\n          /* Create mapping */\n          // \u200b\u8fd4\u56de\u200b\u672a\u200b\u5360\u7528\u200b\u7684\u200bvirq\n          // \u200b\u5e76\u200b\u901a\u8fc7\u200birq_domain_associate\u200b\u8c03\u7528\u200birq_domain-&gt;ops-&gt;map\u200b\u8bbe\u7f6e\u200birq_desc\n          virq = irq_create_mapping(domain, hwirq);\n          if (!virq)\n              return virq;\n      }\n</code></pre>"},{"location":"08_Interrupt/13_1/#4-gic","title":"4. GIC\u200b\u4e2d\u65ad\u200b\u5904\u7406\u200b\u6d41\u7a0b\u200b\u6e90\u7801\u200b\u5206\u6790","text":"<p>\u200b\u770b\u200b\u89c6\u9891\u200b\u3002</p>"},{"location":"08_Interrupt/14_1/","title":"07_\u200b\u4e24\u7c7b\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u5904\u7406\u200b\u6d41\u7a0b\u200b_\u200b\u94fe\u5f0f\u200b\u548c\u200b\u5c42\u7ea7","text":""},{"location":"08_Interrupt/14_1/#_","title":"\u4e24\u7c7b\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u5904\u7406\u200b\u6d41\u7a0b\u200b_\u200b\u94fe\u5f0f\u200b\u548c\u200b\u5c42\u7ea7","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>linux kernel\u200b\u7684\u200b\u4e2d\u65ad\u200b\u5b50\u7cfb\u7edf\u200b\u4e4b\u200b\uff08\u200b\u4e03\u200b\uff09\uff1aGIC\u200b\u4ee3\u7801\u200b\u5206\u6790\u200b</p> </li> <li> <p>Linux 4.9.88\u200b\u5185\u6838\u200b\u6e90\u7801\u200b</p> </li> <li> <p><code>Linux-4.9.88\\drivers\\gpio\\gpio-mxc.c</code></p> </li> <li> <p><code>Linux-4.9.88\\arch\\arm\\boot\\dts\\imx6ull.dtsi</code></p> </li> <li> <p>Linux 5.4\u200b\u5185\u6838\u200b\u6e90\u7801\u200b</p> </li> <li> <p><code>Linux-5.4\\drivers\\pinctrl\\stm32\\pinctrl-stm32mp157.c</code></p> </li> <li><code>Linux-5.4\\drivers\\irqchip\\irq-stm32-exti.c</code></li> <li><code>Linux-5.4\\arch\\arm\\boot\\dts\\stm32mp151.dtsi</code></li> </ul>"},{"location":"08_Interrupt/14_1/#1","title":"1. \u200b\u4e0b\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u7c7b\u522b","text":"<p>\u200b\u5728\u200b\u540e\u7eed\u200b\u8bfe\u7a0b\u200b\u4e2d\u200b\u6211\u4eec\u200b\u628a\u200bGIC\u200b\u4e4b\u4e0b\u200b\u7684\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u5206\u4e3a\u200b\u4e24\u7c7b\u200b\uff1a\u200b\u94fe\u5f0f\u200b(chained)\u3001\u200b\u5c42\u7ea7\u200b(hierarchy)\u3002</p> <p>\u200b\u8fd9\u4e2a\u200b\u5206\u7c7b\u200b\u5e76\u200b\u6ca1\u6709\u200b\u5b98\u65b9\u200b\u5b9a\u4e49\u200b\uff0c\u200b\u662f\u200b\u6211\u4eec\u200b\u6839\u636e\u200b\u4ee3\u7801\u200b\u6982\u62ec\u200b\u51fa\u6765\u200b\u7684\u200b(Linux\u200b\u5185\u6838\u200b\u672c\u6765\u200b\u5c31\u200b\u7f3a\u4e4f\u200b\u6587\u6863\u200b)\u3002</p> <p></p>"},{"location":"08_Interrupt/14_1/#11-chained","title":"1.1 \u200b\u94fe\u5f0f\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b(chained)","text":"<p>\u200b\u4e0a\u56fe\u200b\u4e2d\u200b\uff0c\u200b\u5de6\u8fb9\u200b\u7684\u200b\"chained intc\"\u200b\u5c31\u662f\u200b\u94fe\u5f0f\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u3002</p> <p>\u200b\u5b83\u200b\u5e95\u4e0b\u200b\u7684\u200b4\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\u89e6\u53d1\u200b\u65f6\u200b\uff0c\u200b\u90fd\u200b\u4f1a\u200b\u5bfc\u81f4\u200bGIC\u200b\u7684\u200b33\u200b\u53f7\u200b\u4e2d\u65ad\u200b\u88ab\u200b\u89e6\u53d1\u200b\u3002</p> <p>\u200b\u5904\u7406\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u9700\u8981\u200b**\u200b\u5206\u8fa8\u200b**\uff1a\u200b\u662f\u200b\u8c01\u200b\u89e6\u53d1\u200b\u4e86\u200bGIC 33\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff1f\u200b\u8fd9\u200b\u9700\u8981\u200b\u8bfb\u53d6\u200b\"chained intc\"\u200b\u4e2d\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u3002</p>"},{"location":"08_Interrupt/14_1/#12-hierarchy","title":"1.2 \u200b\u5c42\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b(hierarchy)","text":"<p>\u200b\u4e0a\u56fe\u200b\u4e2d\u200b\uff0c\u200b\u53f3\u8fb9\u200b\u8fb9\u200b\u7684\u200b\"hierarchy intc\"\u200b\u5c31\u662f\u200b\u5c42\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u3002</p> <p>\u200b\u5b83\u200b\u5e95\u4e0b\u200b\u7684\u200b4\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u8ddf\u200bGIC\u200b\u4e2d\u200b\u7684\u200b4\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\u4e00\u4e00\u5bf9\u5e94\u200b\u3002</p> <p>\u200b\u5904\u7406\u200bGIC 100~103\u200b\u53f7\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u4e0d\u200b\u9700\u8981\u200b\u8bfb\u53d6\u200b\"hierarchy intc\"\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u6765\u200b**\u200b\u5206\u8fa8\u200b**\u200b\u662f\u200b\u8c01\u200b\u89e6\u53d1\u200b\u4e86\u200b\u4e2d\u65ad\u200b\u3002</p>"},{"location":"08_Interrupt/14_1/#2","title":"2. \u200b\u94fe\u5f0f\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u5904\u7406\u200b\u6d41\u7a0b","text":"<p>\u200b\u4e0b\u56fe\u200b\u4e2d\u200b\uff1a</p> <ul> <li>handleA\u3001irq_dataA\u200b\u7531\u200bGIC\u200b\u9a71\u52a8\u200b\u63d0\u4f9b\u200b</li> <li>handleB\u3001irq_dataB\u200b\u7531\u200bGPIO\u200b\u9a71\u52a8\u200b\u63d0\u4f9b\u200b</li> <li>handleC\u200b\u4e5f\u200b\u662f\u200bGPIO\u200b\u9a71\u52a8\u200b\u63d0\u4f9b\u200b</li> </ul> <p></p> <ul> <li>\u200b\u5047\u8bbe\u200bGPIO\u200b\u6a21\u5757\u200b\u4e0b\u200b\u6709\u200b4\u200b\u4e2a\u200b\u5f15\u811a\u200b\uff0c\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u4ea7\u751f\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u90fd\u200b\u8fde\u63a5\u200b\u5230\u200bGIC\u200b\u7684\u200b33\u200b\u53f7\u200b\u4e2d\u65ad\u200b</li> <li>GPIO\u200b\u5c31\u662f\u200b\u4e00\u4e2a\u200b\u94fe\u5f0f\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u5b83\u200b\u5e95\u4e0b\u200b\u6709\u200b4\u200b\u4e2a\u200b\u4e2d\u65ad\u200b</li> <li>\u200b\u5bf9\u4e8e\u200bGPIO\u200b\u6a21\u5757\u200b\u4e2d\u200b0~3\u200b\u8fd9\u200b\u56db\u4e2a\u200bhwirq\uff0c\u200b\u5206\u914d\u200b\u56db\u4e2a\u200birq_desc</li> <li>\u200b\u53ef\u4ee5\u200b\u4e00\u4e0b\u5b50\u200b\u5206\u914d\u200b4\u200b\u4e2a\u200b\uff1alegacy\uff0c\u200b\u8001\u200b\u65b9\u6cd5\u200b</li> <li>\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u7528\u5230\u200b\u65f6\u200b\u518d\u200b\u5206\u914d\u200b\uff1alinear\uff0c\u200b\u65b0\u200b\u65b9\u6cd5\u200b</li> <li>\u200b\u5047\u8bbe\u200b\u8fd9\u200b4\u200b\u4e2a\u200birq_desc\u200b\u7684\u200b\u5e8f\u53f7\u200b\u4e3a\u200b100~103\uff0c\u200b\u5728\u200bGPIO domain\u200b\u4e2d\u200b\u8bb0\u5f55\u200b(0,100) (1,101)(2,102) (3,103)</li> <li>\u200b\u5bf9\u4e8e\u200bKEY\uff0c\u200b\u6ce8\u518c\u200b\u4e2d\u65ad\u200b\u65f6\u200b\u5c31\u662f\u200b\uff1a<code>request_irq(102, ...)</code></li> <li>\u200b\u6309\u4e0b\u200bKEY\u200b\u65f6\u200b\uff1a</li> <li>\u200b\u7a0b\u5e8f\u200b\u4ece\u200bGIC\u200b\u4e2d\u200b\u8bfb\u53d6\u200b\u5bc4\u5b58\u5668\u200b\u77e5\u9053\u200b\u53d1\u751f\u200b\u4e86\u200b33\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u901a\u8fc7\u200bGIC irq_domain\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200bvirq\u200b\u4e3a\u200b17</li> <li>\u200b\u5904\u7406\u200bvirq 17\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u8c03\u7528\u200birq_desc[17].handle_irq\uff0c\u200b\u5373\u200bhandleB<ul> <li>mask/ack\u200b\u4e2d\u65ad\u200b: \u200b\u8c03\u7528\u200birq_desc[17].irq_data-&gt;irq_chip\u200b\u7684\u200b\u51fd\u6570\u200b\uff0c\u200b\u5373\u200birq_dataA</li> <li>\u200b\u7ec6\u5206\u200b\u4e2d\u65ad\u200b\u6e90\u200b\u3001\u200b\u5904\u7406\u200b</li> <li>\u200b\u8bfb\u53d6\u200bGPIO\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u786e\u5b9a\u200b\u662f\u200bGPIO\u200b\u91cc\u200b2\u200b\u53f7\u200b\u5f15\u811a\u200b\u53d1\u751f\u200b\u4e2d\u65ad\u200b</li> <li>\u200b\u901a\u8fc7\u200bGPIO irq_domain\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200bvirq\u200b\u4e3a\u200b102</li> <li>\u200b\u5904\u7406\u200bvirq 102\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u8c03\u7528\u200birq_desc[102].handle_irq\uff0c\u200b\u5373\u200bhandleC<ul> <li>mask/ack\u200b\u4e2d\u65ad\u200b: \u200b\u8c03\u7528\u200birq_desc[102].irq_data-&gt;irq_chip\u200b\u7684\u200b\u51fd\u6570\u200b</li> <li>\u200b\u8c03\u7528\u200birq_desc[102].action\u200b\u94fe\u8868\u200b\u4e2d\u200b\u7528\u6237\u6ce8\u518c\u200b\u7684\u200b\u51fd\u6570\u200b</li> <li>unmask\u200b\u4e2d\u65ad\u200b: \u200b\u8c03\u7528\u200birq_desc[102].irq_data-&gt;irq_chip\u200b\u7684\u200b\u51fd\u6570\u200b</li> </ul> </li> <li>unmask\u200b\u4e2d\u65ad\u200b: \u200b\u8c03\u7528\u200birq_desc[17].irq_data-&gt;irq_chip\u200b\u7684\u200b\u51fd\u6570\u200b</li> </ul> </li> </ul>"},{"location":"08_Interrupt/14_1/#3","title":"3. \u200b\u5c42\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u5904\u7406\u200b\u6d41\u7a0b","text":"<p>\u200b\u4e0b\u56fe\u200b\u4e2d\u200b\uff1a</p> <ul> <li>handleA\u3001irq_dataA\u200b\u7531\u200bGIC\u200b\u9a71\u52a8\u200b\u63d0\u4f9b\u200b</li> <li>irq_dataB\u200b\u7531\u200bGPIO\u200b\u9a71\u52a8\u200b\u63d0\u4f9b\u200b\uff0c\u200b\u4e0d\u200b\u9700\u8981\u200bhandleB</li> </ul> <p></p> <ul> <li>\u200b\u5047\u8bbe\u200bGPIO\u200b\u6a21\u5757\u200b\u4e0b\u200b\u6709\u200b4\u200b\u4e2a\u200b\u5f15\u811a\u200b\uff0c\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u4ea7\u751f\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5206\u522b\u200b\u94fe\u63a5\u200b\u5230\u200bGIC\u200b\u7684\u200b100~103\u200b\u53f7\u200b\u4e2d\u65ad\u200b</li> <li>GPIO\u200b\u5c31\u662f\u200b\u4e00\u4e2a\u200b\u5c42\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b</li> <li>\u200b\u5bf9\u4e8e\u200bGPIO\u200b\u6a21\u5757\u200b\u4e2d\u200b0~3\u200b\u8fd9\u200b\u56db\u4e2a\u200bhwirq\uff0c\u200b\u5206\u914d\u200b\u56db\u4e2a\u200birq_desc\uff0c\u200b\u7528\u5230\u200b\u65f6\u200b\u518d\u200b\u5206\u914d\u200b</li> <li>\u200b\u5047\u8bbe\u200b\u8fd9\u200b4\u200b\u4e2a\u200birq_desc\u200b\u7684\u200b\u5e8f\u53f7\u200b\u4e3a\u200b234~237</li> <li>\u200b\u5728\u200bGIC domain\u200b\u4e2d\u200b\u8bb0\u5f55\u200b(100,234) (101,235)(102,236) (103,237)</li> <li>\u200b\u5728\u200bGPIO domain\u200b\u4e2d\u200b\u8bb0\u5f55\u200b(0,234) (1,235)(2,236) (3,237)</li> <li>\u200b\u5bf9\u4e8e\u200bKEY\uff0c\u200b\u6ce8\u518c\u200b\u4e2d\u65ad\u200b\u65f6\u200b\u5c31\u662f\u200b\uff1a<code>request_irq(236, ...)</code></li> <li>\u200b\u6309\u4e0b\u200bKEY\u200b\u65f6\u200b\uff1a</li> <li>\u200b\u7a0b\u5e8f\u200b\u4ece\u200bGIC\u200b\u4e2d\u200b\u8bfb\u53d6\u200b\u5bc4\u5b58\u5668\u200b\u77e5\u9053\u200b\u53d1\u751f\u200b\u4e86\u200b102\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u901a\u8fc7\u200bGIC irq_domain\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200bvirq\u200b\u4e3a\u200b236</li> <li>\u200b\u5904\u7406\u200bvirq 236\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u8c03\u7528\u200birq_desc[236].handle_irq\uff0c\u200b\u5373\u200bhandleA<ul> <li>mask/ack\u200b\u4e2d\u65ad\u200b: </li> <li>\u200b\u8c03\u7528\u200birq_desc[236].irq_data-&gt;irq_chip\u200b\u7684\u200b\u51fd\u6570\u200b\uff0c\u200b\u5373\u200birq_dataB<ul> <li>\u200b\u5b83\u4f1a\u200b\u8c03\u7528\u200b\u7236\u7ea7\u200birq_dataA-&gt;irq_chip\u200b\u7684\u200b\u51fd\u6570\u200b</li> </ul> </li> <li>\u200b\u8c03\u7528\u200birq_desc[236].action\u200b\u94fe\u8868\u200b\u4e2d\u200b\u7528\u6237\u6ce8\u518c\u200b\u7684\u200b\u51fd\u6570\u200b</li> <li>unmask\u200b\u4e2d\u65ad\u200b: </li> <li>\u200b\u8c03\u7528\u200birq_desc[236].irq_data-&gt;irq_chip\u200b\u7684\u200b\u51fd\u6570\u200b\uff0c\u200b\u5373\u200birq_dataB<ul> <li>\u200b\u5b83\u4f1a\u200b\u8c03\u7528\u200b\u7236\u7ea7\u200birq_dataA-&gt;irq_chip\u200b\u7684\u200b\u51fd\u6570\u200b</li> </ul> </li> </ul> </li> </ul>"},{"location":"08_Interrupt/14_1/#4","title":"4. \u200b\u5904\u7406\u200b\u6d41\u7a0b\u200b\u5bf9\u6bd4","text":""},{"location":"08_Interrupt/15_1/","title":"08_\u200b\u94fe\u5f0f\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b\u7f16\u5199","text":""},{"location":"08_Interrupt/15_1/#_1","title":"\u94fe\u5f0f\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b\u7f16\u5199","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>linux kernel\u200b\u7684\u200b\u4e2d\u65ad\u200b\u5b50\u7cfb\u7edf\u200b\u4e4b\u200b\uff08\u200b\u4e03\u200b\uff09\uff1aGIC\u200b\u4ee3\u7801\u200b\u5206\u6790\u200b</p> </li> <li> <p>Linux 4.9.88\u200b\u5185\u6838\u200b\u6e90\u7801\u200b</p> </li> <li> <p><code>Linux-4.9.88\\drivers\\gpio\\gpio-mxc.c</code></p> </li> <li> <p><code>Linux-4.9.88\\arch\\arm\\boot\\dts\\imx6ull.dtsi</code></p> </li> <li> <p>Linux 5.4\u200b\u5185\u6838\u200b\u6e90\u7801\u200b</p> </li> <li> <p><code>Linux-5.4\\drivers\\pinctrl\\stm32\\pinctrl-stm32mp157.c</code></p> </li> <li><code>Linux-5.4\\drivers\\irqchip\\irq-stm32-exti.c</code></li> <li> <p><code>Linux-5.4\\arch\\arm\\boot\\dts\\stm32mp151.dtsi</code></p> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b</p> </li> </ul> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\source\\08_Interrupt\\03_virtual_int_controller_legacy\ndoc_and_source_for_drivers\\STM32MP157\\source\\A7\\08_Interrupt\\03_virtual_int_controller_legacy\n</code></pre>"},{"location":"08_Interrupt/15_1/#1","title":"1. \u200b\u94fe\u5f0f\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u91cd\u8981\u200b\u51fd\u6570\u200b\u548c\u200b\u7ed3\u6784\u200b\u4f53","text":""},{"location":"08_Interrupt/15_1/#11","title":"1.1 \u200b\u56de\u987e\u200b\u5904\u7406\u200b\u6d41\u7a0b","text":"<p>\u200b\u4e3a\u200b\u65b9\u4fbf\u200b\u63cf\u8ff0\u200b\uff0c\u200b\u5047\u8bbe\u200b\u4e0b\u7ea7\u200b\u7684\u200b\u94fe\u5f0f\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u5c31\u662f\u200bGPIO\u200b\u63a7\u5236\u5668\u200b\u3002</p> <p></p> <p>\u200b\u6cbf\u7740\u200b\u4e2d\u65ad\u200b\u7684\u200b\u5904\u7406\u200b\u6d41\u7a0b\u200b\uff0cGIC\u200b\u4e4b\u4e0b\u200b\u7684\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u6d89\u53ca\u200b\u8fd9\u200b4\u200b\u4e2a\u200b\u91cd\u8981\u200b\u90e8\u5206\u200b\uff1ahandleB\u3001GPIO Domain\u3001handleC\u3001irq_chip</p> <ul> <li> <p>handleB\uff1a\u200b\u5904\u7406\u200bGIC 33\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0chandleB\u200b\u7531\u200bGPIO\u200b\u9a71\u52a8\u200b\u63d0\u4f9b\u200b</p> </li> <li> <p>\u200b\u5c4f\u853d\u200bGIC 33\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u8c03\u7528\u200birq_dataA\u200b\u7684\u200birq_chip\u200b\u7684\u200b\u51fd\u6570\u200b\uff0cirq_dataA\u200b\u7531\u200bGIC\u200b\u9a71\u52a8\u200b\u63d0\u4f9b\u200b</p> </li> <li>\u200b\u7ec6\u5206\u200b\u5e76\u200b\u5904\u7406\u200b\u67d0\u4e2a\u200bGPIO\u200b\u4e2d\u65ad\u200b\uff1a<ul> <li>\u200b\u8bfb\u53d6\u200bGPIO\u200b\u5bc4\u5b58\u5668\u200b\u5f97\u5230\u200bhwirq\uff0c\u200b\u901a\u8fc7\u200b**GPIO Domain**\u200b\u8f6c\u6362\u200b\u4e3a\u200bvirq\uff0c\u200b\u5047\u8bbe\u200b\u662f\u200b102</li> <li>\u200b\u8c03\u7528\u200birq_desc[102].handle_irq\uff0c\u200b\u5373\u200bhandleC</li> </ul> </li> <li> <p>\u200b\u6e05\u9664\u200bGIC 33\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u8c03\u7528\u200birq_dataA\u200b\u7684\u200birq_chip\u200b\u7684\u200b\u51fd\u6570\u200b\uff0c\u200b\u7531\u200bGIC\u200b\u9a71\u52a8\u200b\u63d0\u4f9b\u200b</p> </li> <li> <p>handleC\uff1a\u200b\u5904\u7406\u200bGPIO 2\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0chandleC\u200b\u7531\u200bGPIO\u200b\u9a71\u52a8\u200b\u63d0\u4f9b\u200b</p> </li> <li> <p>\u200b\u5c4f\u853d\u200bGPIO 2\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u8c03\u7528\u200birq_dataB\u200b\u7684\u200b**irq_chip**\u200b\u7684\u200b\u51fd\u6570\u200b\uff0c\u200b\u7531\u200bGPIO\u200b\u9a71\u52a8\u200b\u63d0\u4f9b\u200b</p> </li> <li>\u200b\u5904\u7406\u200b\uff1a\u200b\u8c03\u7528\u200bactions\u200b\u94fe\u8868\u200b\u4e2d\u200b\u7528\u6237\u6ce8\u518c\u200b\u7684\u200b\u51fd\u6570\u200b</li> <li>\u200b\u6e05\u9664\u200bGPIO 2\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u8c03\u7528\u200birq_dataB\u200b\u7684\u200birq_chip\u200b\u7684\u200b\u51fd\u6570\u200b\uff0c\u200b\u7531\u200bGPIO\u200b\u9a71\u52a8\u200b\u63d0\u4f9b\u200b</li> </ul>"},{"location":"08_Interrupt/15_1/#12-irq_domain","title":"1.2 irq_domain\u200b\u7684\u200b\u6838\u5fc3\u4f5c\u7528","text":"<p>\u200b\u600e\u4e48\u200b\u628a\u200bhandleB\u3001GPIO Domain\u3001handleC\u3001irq_chip\u200b\u8fd9\u200b4\u200b\u4e2a\u200b\u7ed3\u6784\u200b\u4f53\u200b\u7ec4\u7ec7\u200b\u8d77\u6765\u200b\uff0cirq_domain\u200b\u662f\u200b\u6838\u5fc3\u200b\u3002</p> <p>\u200b\u6211\u4eec\u200b\u4ece\u200b\u4f7f\u7528\u200b\u4e2d\u65ad\u200b\u7684\u200b\u6d41\u7a0b\u200b\u6765\u200b\u8bb2\u89e3\u200b\u3002</p> <ul> <li>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u5b9a\u200b\u4f7f\u7528\u200b\u54ea\u4e2a\u200b\u4e2d\u65ad\u200b</li> </ul> <pre><code>    gpio_keys_100ask {\n        compatible = \"100ask,gpio_key\";\n      interrupt-parent = &lt;&amp;gpio5&gt;;\n      interrupts = &lt;3 IRQ_TYPE_EDGE_BOTH&gt;,\n    };\n</code></pre> <ul> <li> <p>\u200b\u5185\u6838\u200b\u89e3\u6790\u200b\u3001\u200b\u5904\u7406\u200b\u8bbe\u5907\u200b\u6811\u200b\u7684\u200b\u4e2d\u65ad\u200b\u4fe1\u606f\u200b</p> </li> <li> <p>\u200b\u6839\u636e\u200b<code>interrupt-parent</code>\u200b\u627e\u5230\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6ce8\u518c\u200b\u7684\u200birq_domain</p> </li> <li> <p>\u200b\u4f7f\u7528\u200birq_domain.ops\u200b\u4e2d\u200b\u7684\u200btranslate\u200b\u6216\u200bxlate\u200b\u51fd\u6570\u200b\u89e3\u6790\u200b\u8bbe\u5907\u200b\u6811\u200b\uff0c\u200b\u5f97\u5230\u200bhwirq\u200b\u548c\u200btype</p> </li> <li> <p>\u200b\u5206\u914d\u200b/\u200b\u627e\u5230\u200birq_desc\uff0c\u200b\u5f97\u5230\u200bvirq</p> <ul> <li>\u200b\u628a\u200b(hwirq, virq)\u200b\u7684\u200b\u5173\u7cfb\u200b\u5b58\u5165\u200birq_domain</li> <li>\u200b\u628a\u200bvirq\u200b\u5b58\u5165\u200bplatform_device\u200b\u7684\u200bresource\u200b\u4e2d\u200b</li> </ul> </li> <li> <p>\u200b\u4f7f\u7528\u200birq_domain.ops\u200b\u4e2d\u200b\u7684\u200balloc\u200b\u6216\u200bmap\u200b\u51fd\u6570\u200b\u8fdb\u884c\u200b\u8bbe\u7f6e\u200b</p> <ul> <li>\u200b\u53ef\u80fd\u200b\u662f\u200b\u66ff\u6362\u200birq_desc[virq].handle_irq\u200b\u51fd\u6570\u200b</li> <li>\u200b\u53ef\u80fd\u200b\u662f\u200b\u66ff\u6362\u200birq_desc[virq].irq_data\uff0c\u200b\u91cc\u9762\u200b\u6709\u200birq_chip</li> </ul> </li> <li> <p>\u200b\u7528\u6237\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6ce8\u518c\u200b\u4e2d\u65ad\u200b</p> </li> <li> <p>\u200b\u4ece\u200bplatform_device\u200b\u7684\u200bresource\u200b\u4e2d\u200b\u5f97\u5230\u200b\u4e2d\u65ad\u200b\u53f7\u200bvirq</p> </li> <li> <p>request_irq(virq, ..., func)</p> </li> <li> <p>\u200b\u53d1\u751f\u200b\u4e2d\u65ad\u200b\u3001\u200b\u5904\u7406\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u5904\u7406\u200b\u6d41\u7a0b\u200b\u89c1\u200b\u4e0a\u9762\u200b\u3002</p> </li> </ul>"},{"location":"08_Interrupt/15_1/#2","title":"2. \u200b\u786c\u4ef6\u200b\u6a21\u578b","text":"<p>\u200b\u4e0b\u56fe\u200b\u4e2d\u200b\u5217\u51fa\u200b\u4e86\u200b\u94fe\u5f0f\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u3001\u200b\u5c42\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u672c\u200b\u8282\u200b\u8bfe\u7a0b\u200b\u53ea\u200b\u6d89\u53ca\u200b\u5de6\u8fb9\u200b\u7684\u200b\u94fe\u5f0f\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u3002</p> <p>\u200b\u5185\u6838\u200b\u4e2d\u6709\u200b\u5404\u7c7b\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u5b83\u4eec\u200b\u6d89\u53ca\u200b\u7684\u200b\u786c\u4ef6\u200b\u8fc7\u4e8e\u200b\u590d\u6742\u200b\uff0c\u200b\u4ece\u200b\u8fd9\u4e9b\u200b\u6742\u4e71\u200b\u7684\u200b\u4ee3\u7801\u200b\u4e2d\u200b\u53bb\u200b\u8bb2\u6e05\u695a\u200b\u4e2d\u65ad\u200b\u4f53\u7cfb\u200b\uff0c\u200b\u6bd4\u8f83\u200b\u96be\u200b\u3002</p> <p>\u200b\u6211\u4eec\u200b\u5b9e\u73b0\u200b\u4e00\u4e9b\u200b\u865a\u62df\u200b\u7684\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b\u3002</p> <p>\u200b\u5b9e\u9645\u200b\u677f\u5b50\u200b\u4e2d\u200b\uff0c\u200b\u6211\u4eec\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200b\u6309\u952e\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\u3002</p> <p>\u200b\u5bf9\u4e8e\u200b\u8fd9\u4e9b\u200b\u865a\u62df\u200b\u7684\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u6211\u4eec\u200b\u6ca1\u6709\u200b\u771f\u5b9e\u200b\u6309\u952e\u200b\uff0c\u200b\u901a\u8fc7\u200bdevmem\u200b\u6307\u4ee4\u200b\u5199\u200bGIC\u200b\u7684\u200bPENDING\u200b\u5bc4\u5b58\u5668\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\u3002</p> <p></p>"},{"location":"08_Interrupt/15_1/#3","title":"3. \u200b\u7f16\u7a0b","text":"<p>\u200b\u4f1a\u200b\u6d89\u53ca\u200b2\u200b\u4e2a\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff1a\u200b\u865a\u62df\u200b\u7684\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b\uff0c\u200b\u6309\u952e\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u4ee5\u53ca\u200b\u5bf9\u5e94\u200b\u7684\u200b\u8bbe\u5907\u200b\u6811\u200b\u3002</p>"},{"location":"08_Interrupt/16_1/","title":"09_legacy\u200b\u65b9\u5f0f\u200b\u4ee3\u7801\u200b\u7684\u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":""},{"location":"08_Interrupt/16_1/#legacy","title":"legacy\u200b\u65b9\u5f0f\u200b\u4ee3\u7801\u200b\u7684\u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>linux kernel\u200b\u7684\u200b\u4e2d\u65ad\u200b\u5b50\u7cfb\u7edf\u200b\u4e4b\u200b\uff08\u200b\u4e03\u200b\uff09\uff1aGIC\u200b\u4ee3\u7801\u200b\u5206\u6790\u200b</p> </li> <li> <p>Linux 4.9.88\u200b\u5185\u6838\u200b\u6e90\u7801\u200b</p> </li> <li> <p><code>Linux-4.9.88\\drivers\\gpio\\gpio-mxc.c</code></p> </li> <li> <p><code>Linux-4.9.88\\arch\\arm\\boot\\dts\\imx6ull.dtsi</code></p> </li> <li> <p>Linux 5.4\u200b\u5185\u6838\u200b\u6e90\u7801\u200b</p> </li> <li> <p><code>Linux-5.4\\drivers\\pinctrl\\stm32\\pinctrl-stm32mp157.c</code></p> </li> <li><code>Linux-5.4\\drivers\\irqchip\\irq-stm32-exti.c</code></li> <li> <p><code>Linux-5.4\\arch\\arm\\boot\\dts\\stm32mp151.dtsi</code></p> </li> <li> <p>\u200b\u82af\u7247\u200b\u624b\u518c\u200b</p> </li> <li> <p>IMX6ULL: imx6ullrm.pdf</p> </li> <li> <p>STM32MP157: DM00327659.pdf</p> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b</p> </li> </ul> <pre><code>doc_and_source_for_drivers\\\n  IMX6ULL\\source\\08_Interrupt\\\n      04_virtual_int_controller_legacy_ok\n\ndoc_and_source_for_drivers\\\n  STM32MP157\\source\\A7\\08_Interrupt\\\n      04_virtual_int_controller_legacy_ok\n</code></pre>"},{"location":"08_Interrupt/16_1/#1-n","title":"1. \u200b\u786e\u5b9a\u200b\u4e2d\u65ad\u200b\u53f7\u200bn","text":"<p>\u200b\u67e5\u770b\u200b\u82af\u7247\u200b\u624b\u518c\u200b\uff0c\u200b\u9009\u62e9\u200b\u4e00\u4e2a\u200b\u4fdd\u7559\u200b\u7684\u200b\u3001\u200b\u672a\u200b\u4f7f\u7528\u200b\u7684\u200bGIC SPI\u200b\u4e2d\u65ad\u200b\u5373\u53ef\u200b\u3002</p>"},{"location":"08_Interrupt/16_1/#11-imx6ull","title":"1.1 IMX6ULL","text":"<p>\u200b\u770b\u200b\u82af\u7247\u200b\u624b\u518c\u200b\u7b2c\u200b3\u200b\u7ae0\u200b\uff1a</p> <p></p> <p>\u200b\u770b\u4e0a\u200b\u56fe\u200b\uff0c\u200b\u9009\u62e9\u200b122\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5b83\u200b\u662f\u200bSPI\u200b\u91cc\u200b\u7684\u200b122\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0cGIC\u200b\u91cc\u200b\u7684\u200b\u7f16\u53f7\u200b\u662f\u200b(32+122)=154\u3002</p>"},{"location":"08_Interrupt/16_1/#12-stm32mp157","title":"1.2 STM32MP157","text":"<p>\u200b\u770b\u200b\u82af\u7247\u200b\u624b\u518c\u200b\u7b2c\u200b21.2\u200b\u8282\u200b\uff1a</p> <p></p> <p>\u200b\u770b\u4e0a\u200b\u56fe\u200b\uff0c\u200b\u9009\u62e9\u200b210\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5b83\u200b\u662f\u200bSPI\u200b\u91cc\u200b\u7684\u200b210\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0cGIC\u200b\u91cc\u200b\u7684\u200b\u7f16\u53f7\u200b\u662f\u200b(32+210)=242\u3002</p>"},{"location":"08_Interrupt/16_1/#2","title":"2. \u200b\u600e\u4e48\u200b\u89e6\u53d1\u200b\u4e2d\u65ad","text":"<p>\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200bdevmem\u200b\u547d\u4ee4\u200b\u76f4\u63a5\u200b\u5199\u200bGIC\u200b\u7684\u200bPENDING\u200b\u5bc4\u5b58\u200b\u533a\u200b\u3002</p> <p></p> <p>GICD_ISPENDRn\u200b\u6709\u200b\u591a\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u6bcf\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\u4e2d\u200b\u6bcf\u200b\u4e00\u4f4d\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200bGIC\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5199\u5165\u200b1\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u89e6\u53d1\u200b\u8be5\u200b\u4e2d\u65ad\u200b\u3002</p> <p>\u200b\u5199\u200b\u54ea\u200b\u4e00\u4e2a\u200bGICD_ISPENDRn\u200b\u5bc4\u5b58\u5668\u200b\uff1f\u200b\u5199\u200b\u54ea\u4e00\u4f4d\u200b\uff1f\u200b\u4f7f\u7528\u200b\u4e0b\u5217\u200b\u516c\u5f0f\u200b\u6765\u200b\u786e\u5b9a\u200b\uff1a</p> <p></p> <p>\u200b\u67e5\u770b\u200b\u5185\u6838\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200bimx6ull.dtsi\u3001stm32mp151.dtsi\uff0c\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200b\uff1a</p> <ul> <li>IMX6ULL\u200b\u7684\u200bGIC Distributor \u200b\u5730\u5740\u200b\u662f\u200b\uff1a0x00a01000   </li> <li>STM32MP157\u200b\u7684\u200bGIC Distributor \u200b\u5730\u5740\u200b\u662f\u200b\uff1a0xa0021000   </li> </ul> \u200b\u82af\u7247\u200b SPI\u200b\u4e2d\u65ad\u200b\u53f7\u200b GIC\u200b\u4e2d\u65ad\u200b\u53f7\u200b n,bit GICD_ISPENDRn\u200b\u5730\u5740\u200b \u200b\u547d\u4ee4\u200b IMX6LLL 122 154 4,26 0xa01210 devmem 0xa01210 32 0x4000000 STM32MP157 210 242 7,18 0xa002121c devmem 0xa002121c 32 0x40000"},{"location":"08_Interrupt/16_1/#3","title":"3. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":""},{"location":"08_Interrupt/16_1/#31","title":"3.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":""},{"location":"08_Interrupt/16_1/#1-stm32mp157","title":"1. STM32MP157","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"08_Interrupt/16_1/#2-imx6ull","title":"2. IMX6ULL","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre>"},{"location":"08_Interrupt/16_1/#32","title":"3.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"08_Interrupt/16_1/#1-stm32mp157_1","title":"1. STM32MP157","text":"<ul> <li> <p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dts</code>\uff0c\u200b\u6dfb\u52a0\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>/ {\n    virtual_intc: virtual_intc_100ask {\n        compatible = \"100ask,virtual_intc\";\n\n        interrupt-controller;\n        #interrupt-cells = &lt;2&gt;;\n\n        interrupt-parent = &lt;&amp;intc&gt;;\n        interrupts = &lt;GIC_SPI 210 IRQ_TYPE_LEVEL_HIGH&gt;;\n\n    };\n\n    gpio_keys_100ask {\n        compatible = \"100ask,gpio_key\";\n        interrupt-parent = &lt;&amp;virtual_intc&gt;;\n        interrupts = &lt;0 IRQ_TYPE_LEVEL_HIGH&gt;,\n                     &lt;1 IRQ_TYPE_LEVEL_HIGH&gt;,\n                     &lt;2 IRQ_TYPE_LEVEL_HIGH&gt;,\n                     &lt;3 IRQ_TYPE_LEVEL_HIGH&gt;;\n    };\n};\n</code></pre> </li> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bSTM32MP157\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <ul> <li>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.1.100)</li> </ul> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> <ul> <li>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.1.137</li> </ul> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> </ul> <pre><code>[root@100ask:~]# mount  /dev/mmcblk2p2  /boot\n[root@100ask:~]# cp /mnt/stm32mp157c-100ask-512d-lcd-v1.dtb /boot\n[root@100ask:~]# sync\n</code></pre> <ul> <li>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</li> </ul>"},{"location":"08_Interrupt/16_1/#2-imx6ull_1","title":"2. IMX6ULL","text":"<ul> <li> <p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code>\uff0c\u200b\u6dfb\u52a0\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>/ {\n    virtual_intc: virtual_intc_100ask {\n        compatible = \"100ask,virtual_intc\";\n\n        interrupt-controller;\n        #interrupt-cells = &lt;2&gt;;\n\n        interrupt-parent = &lt;&amp;intc&gt;;\n        interrupts = &lt;GIC_SPI 122 IRQ_TYPE_LEVEL_HIGH&gt;;\n\n    };\n\n    gpio_keys_100ask {\n        compatible = \"100ask,gpio_key\";\n        interrupt-parent = &lt;&amp;virtual_intc&gt;;\n        interrupts = &lt;0 IRQ_TYPE_LEVEL_HIGH&gt;,\n                     &lt;1 IRQ_TYPE_LEVEL_HIGH&gt;,\n                     &lt;2 IRQ_TYPE_LEVEL_HIGH&gt;,\n                     &lt;3 IRQ_TYPE_LEVEL_HIGH&gt;;\n    };\n};\n</code></pre> </li> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bIMX6ULL\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/100ask_imx6ull-14x14.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.1.100)</p> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.1.137</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/100ask_imx6ull-14x14.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"08_Interrupt/16_1/#33","title":"3.3 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u5b89\u88c5\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\uff1a</p> </li> <li> <p>\u200b\u5728\u200bUbuntu\u200b\u4e0a\u200b</p> </li> <li> <p>\u200b\u4fee\u6539\u200b<code>04_virtual_int_controller_legacy_ok</code>\u200b\u4e2d\u200b\u7684\u200bMakefile\uff0c\u200b\u6307\u5b9a\u200b\u5185\u6838\u200b\u8def\u5f84\u200b<code>KERN_DIR</code>\uff0c\u200b\u5728\u200b\u6267\u884c\u200b<code>make</code>\u200b\u547d\u4ee4\u200b\u5373\u53ef\u200b\u3002</p> </li> <li> <p>\u200b\u5b89\u88c5\u200b\uff1a</p> </li> <li> <p>\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b</p> </li> <li> <p>\u200b\u6302\u8f7d\u200bNFS\uff0c\u200b\u590d\u5236\u200b\u6587\u4ef6\u200b\uff0cinsmod\uff0c\u200b\u7c7b\u4f3c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b\uff1a</p> <pre><code>mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n// \u200b\u5bf9\u4e8e\u200bIMX6ULL\uff0c\u200b\u60f3\u200b\u770b\u5230\u200b\u9a71\u52a8\u200b\u6253\u5370\u4fe1\u606f\u200b\uff0c\u200b\u9700\u8981\u200b\u5148\u200b\u6267\u884c\u200b\necho \"7 4 1 7\" &gt; /proc/sys/kernel/printk\n\ninsmod -f /mnt/virtual_int_controller.ko\n// \u200b\u5b89\u88c5\u200bvirtual_int_controller\u200b\u4e4b\u540e\u200b\u5373\u53ef\u200b\u8fdb\u5165\u200b/sys/kernel/irq\u200b\u76ee\u5f55\u200b\u67e5\u770b\u200b\u5206\u914d\u200b\u7684\u200b\u4e2d\u65ad\u200b\u53f7\u200b\n\ninsmod -f /mnt/gpio_key_drv.ko\ncat /proc/interrupts\n\n// \u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\ndevmem 0xa01210 32 0x4000000 // imx6ull\ndevmem 0xa002121c 32 0x40000 // stm32mp157\n</code></pre> </li> <li> <p>\u200b\u89c2\u5bdf\u200b\u5185\u6838\u200b\u6253\u5370\u200b\u7684\u200b\u4fe1\u606f\u200b</p> </li> </ul>"},{"location":"08_Interrupt/17_1/","title":"10_\u200b\u94fe\u5f0f\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b\u7f16\u5199\u200b_linear\u200b\u65b9\u5f0f\u200b\u672c","text":""},{"location":"08_Interrupt/17_1/#_linear","title":"\u94fe\u5f0f\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b\u7f16\u5199\u200b_linear\u200b\u65b9\u5f0f","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>linux kernel\u200b\u7684\u200b\u4e2d\u65ad\u200b\u5b50\u7cfb\u7edf\u200b\u4e4b\u200b\uff08\u200b\u4e03\u200b\uff09\uff1aGIC\u200b\u4ee3\u7801\u200b\u5206\u6790\u200b</p> </li> <li> <p>Linux 4.9.88\u200b\u5185\u6838\u200b\u6e90\u7801\u200b</p> </li> <li> <p><code>Linux-4.9.88\\drivers\\gpio\\gpio-mxc.c</code></p> </li> <li> <p><code>Linux-4.9.88\\arch\\arm\\boot\\dts\\imx6ull.dtsi</code></p> </li> <li> <p>Linux 5.4\u200b\u5185\u6838\u200b\u6e90\u7801\u200b</p> </li> <li> <p><code>Linux-5.4\\drivers\\pinctrl\\stm32\\pinctrl-stm32mp157.c</code></p> </li> <li><code>Linux-5.4\\drivers\\irqchip\\irq-stm32-exti.c</code></li> <li> <p><code>Linux-5.4\\arch\\arm\\boot\\dts\\stm32mp151.dtsi</code></p> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b</p> </li> </ul> <pre><code>doc_and_source_for_drivers\\\n  IMX6ULL\\source\\08_Interrupt\\\n      05_virtual_int_controller_linear_ok\n\ndoc_and_source_for_drivers\\\n  STM32MP157\\source\\A7\\08_Interrupt\\\n      05_virtual_int_controller_linear_ok\n</code></pre>"},{"location":"08_Interrupt/17_1/#1","title":"1. \u200b\u4e24\u79cd\u200b\u65b9\u5f0f\u200b\u7684\u200b\u5bf9\u6bd4","text":"<p>linear\u3001legacy\u200b\u65b9\u5f0f\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u7528\u6765\u200b\u7f16\u5199\u200b\u94fe\u5f0f\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b\uff0c\u200b\u5b83\u4eec\u200b\u7684\u200b\u5173\u7cfb\u200b\u5982\u4e0b\u200b\u8868\u200b\u6240\u793a\u200b\u3002</p> legacy linear \u200b\u51fd\u6570\u200b irq_domain_add_legacy irq_domain_add_linear irq_desc \u200b\u4e00\u6b21\u6027\u200b\u5206\u914d\u200b\u5b8c\u200b \u200b\u7528\u5230\u200b\u518d\u200b\u5206\u914d\u200b (hwirq,virq) domain-&gt;linear_revmap[hwirq] = irq_data-&gt;irq; \u200b\u540c\u200b\u5de6\u8fb9"},{"location":"08_Interrupt/17_1/#2","title":"2. \u200b\u7f16\u7a0b","text":""},{"location":"08_Interrupt/17_1/#3","title":"3. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<p>\u200b\u8ddf\u4e0a\u200b\u8282\u200b\u89c6\u9891\u200b\u64cd\u4f5c\u200b\u5b8c\u5168\u200b\u4e00\u6837\u200b\uff0c\u200b\u53c2\u8003\u200b\u300a16_legacy\u200b\u65b9\u5f0f\u200b\u4ee3\u7801\u200b\u7684\u200b\u4e0a\u673a\u200b\u5b9e\u9a8c\u200b.md\u300b</p>"},{"location":"08_Interrupt/18_1/","title":"11_\u200b\u5c42\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b\u7f16\u5199","text":""},{"location":"08_Interrupt/18_1/#_1","title":"\u5c42\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b\u7f16\u5199","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>linux kernel\u200b\u7684\u200b\u4e2d\u65ad\u200b\u5b50\u7cfb\u7edf\u200b\u4e4b\u200b\uff08\u200b\u4e03\u200b\uff09\uff1aGIC\u200b\u4ee3\u7801\u200b\u5206\u6790\u200b</p> </li> <li> <p>Linux 4.9.88\u200b\u5185\u6838\u200b\u6e90\u7801\u200b</p> </li> <li> <p><code>Linux-4.9.88\\drivers\\gpio\\gpio-mxc.c</code></p> </li> <li> <p><code>Linux-4.9.88\\arch\\arm\\boot\\dts\\imx6ull.dtsi</code></p> </li> <li> <p>Linux 5.4\u200b\u5185\u6838\u200b\u6e90\u7801\u200b</p> </li> <li> <p><code>Linux-5.4\\drivers\\pinctrl\\stm32\\pinctrl-stm32mp157.c</code></p> </li> <li><code>Linux-5.4\\drivers\\irqchip\\irq-stm32-exti.c</code></li> <li> <p><code>Linux-5.4\\arch\\arm\\boot\\dts\\stm32mp151.dtsi</code></p> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b</p> </li> </ul> <pre><code>doc_and_source_for_drivers\\\n  IMX6ULL\\source\\08_Interrupt\\\n      06_virtual_int_controller_hierarchy\n\ndoc_and_source_for_drivers\\\n  STM32MP157\\source\\A7\\08_Interrupt\\\n      06_virtual_int_controller_hierarchy\n</code></pre>"},{"location":"08_Interrupt/18_1/#1","title":"1. \u200b\u5c42\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u91cd\u8981\u200b\u51fd\u6570\u200b\u548c\u200b\u7ed3\u6784\u200b\u4f53","text":""},{"location":"08_Interrupt/18_1/#11","title":"1.1 \u200b\u56de\u987e\u200b\u5904\u7406\u200b\u6d41\u7a0b","text":"<p>\u200b\u4e3a\u200b\u65b9\u4fbf\u200b\u63cf\u8ff0\u200b\uff0c\u200b\u5047\u8bbe\u200b\u4e0b\u7ea7\u200b\u7684\u200b\u5c42\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u5c31\u662f\u200bGPIO\u200b\u63a7\u5236\u5668\u200b\u3002</p> <p>\u200b\u4e0b\u56fe\u200b\u4e2d\u200b\uff1a</p> <ul> <li>handleA\u3001irq_dataA\u200b\u7531\u200bGIC\u200b\u9a71\u52a8\u200b\u63d0\u4f9b\u200b</li> <li>irq_dataB\u200b\u7531\u200bGPIO\u200b\u9a71\u52a8\u200b\u63d0\u4f9b\u200b\uff0c\u200b\u4e0d\u200b\u9700\u8981\u200bhandleB</li> </ul> <p></p> <ul> <li>\u200b\u5047\u8bbe\u200bGPIO\u200b\u6a21\u5757\u200b\u4e0b\u200b\u6709\u200b4\u200b\u4e2a\u200b\u5f15\u811a\u200b\uff0c\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u4ea7\u751f\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5206\u522b\u200b\u94fe\u63a5\u200b\u5230\u200bGIC\u200b\u7684\u200b100~103\u200b\u53f7\u200b\u4e2d\u65ad\u200b</li> <li>GPIO\u200b\u5c31\u662f\u200b\u4e00\u4e2a\u200b\u5c42\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b</li> <li>\u200b\u5bf9\u4e8e\u200bGPIO\u200b\u6a21\u5757\u200b\u4e2d\u200b0~3\u200b\u8fd9\u200b\u56db\u4e2a\u200bhwirq\uff0c\u200b\u5206\u914d\u200b\u56db\u4e2a\u200birq_desc\uff0c\u200b\u7528\u5230\u200b\u65f6\u200b\u518d\u200b\u5206\u914d\u200b</li> <li>\u200b\u5047\u8bbe\u200b\u8fd9\u200b4\u200b\u4e2a\u200birq_desc\u200b\u7684\u200b\u5e8f\u53f7\u200b\u4e3a\u200b234~237</li> <li>\u200b\u5728\u200bGIC domain\u200b\u4e2d\u200b\u8bb0\u5f55\u200b(100,234) (101,235)(102,236) (103,237)</li> <li>\u200b\u5728\u200bGPIO domain\u200b\u4e2d\u200b\u8bb0\u5f55\u200b(0,234) (1,235)(2,236) (3,237)</li> <li>\u200b\u5bf9\u4e8e\u200bKEY\uff0c\u200b\u6ce8\u518c\u200b\u4e2d\u65ad\u200b\u65f6\u200b\u5c31\u662f\u200b\uff1a<code>request_irq(236, ...)</code></li> <li>\u200b\u6309\u4e0b\u200bKEY\u200b\u65f6\u200b\uff1a</li> <li>\u200b\u7a0b\u5e8f\u200b\u4ece\u200bGIC\u200b\u4e2d\u200b\u8bfb\u53d6\u200b\u5bc4\u5b58\u5668\u200b\u77e5\u9053\u200b\u53d1\u751f\u200b\u4e86\u200b102\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u901a\u8fc7\u200bGIC irq_domain\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200bvirq\u200b\u4e3a\u200b236</li> <li>\u200b\u5904\u7406\u200bvirq 236\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u8c03\u7528\u200birq_desc[236].handle_irq\uff0c\u200b\u5373\u200bhandleA<ul> <li>mask/ack\u200b\u4e2d\u65ad\u200b: </li> <li>\u200b\u8c03\u7528\u200birq_desc[236].irq_data-&gt;irq_chip\u200b\u7684\u200b\u51fd\u6570\u200b\uff0c\u200b\u5373\u200birq_dataB<ul> <li>\u200b\u5b83\u4f1a\u200b\u8c03\u7528\u200b\u7236\u7ea7\u200birq_dataA-&gt;irq_chip\u200b\u7684\u200b\u51fd\u6570\u200b</li> </ul> </li> <li>\u200b\u8c03\u7528\u200birq_desc[236].action\u200b\u94fe\u8868\u200b\u4e2d\u200b\u7528\u6237\u6ce8\u518c\u200b\u7684\u200b\u51fd\u6570\u200b</li> <li>unmask\u200b\u4e2d\u65ad\u200b: </li> <li>\u200b\u8c03\u7528\u200birq_desc[236].irq_data-&gt;irq_chip\u200b\u7684\u200b\u51fd\u6570\u200b\uff0c\u200b\u5373\u200birq_dataB<ul> <li>\u200b\u5b83\u4f1a\u200b\u8c03\u7528\u200b\u7236\u7ea7\u200birq_dataA-&gt;irq_chip\u200b\u7684\u200b\u51fd\u6570\u200b</li> </ul> </li> </ul> </li> </ul>"},{"location":"08_Interrupt/18_1/#12-irq_domain","title":"1.2 irq_domain\u200b\u7684\u200b\u6838\u5fc3\u4f5c\u7528","text":"<p>\u200b\u600e\u4e48\u200b\u628a\u200bhandleA\u3001GIC Domain\u200b\u548c\u200bGPIO Domain\u3001irq_chipA\u200b\u548c\u200birq_chipB\u200b\u8fd9\u200b4\u200b\u4e2a\u200b\u7ed3\u6784\u200b\u4f53\u200b\u7ec4\u7ec7\u200b\u8d77\u6765\u200b\uff0cirq_domain\u200b\u662f\u200b\u6838\u5fc3\u200b\u3002</p> <p>\u200b\u4e3a\u200b\u65b9\u4fbf\u200b\u63cf\u8ff0\u200b\uff0c\u200b\u6211\u4eec\u200b\u628a\u200b\u4e0a\u200b\u56fe\u200b\u4e2d\u200b\u7684\u200b\u5c42\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u5f53\u505a\u200bGPIO\u200b\u63a7\u5236\u5668\u200b\u3002</p> <p>\u200b\u6211\u4eec\u200b\u4ece\u200b\u4f7f\u7528\u200b\u4e2d\u65ad\u200b\u7684\u200b\u6d41\u7a0b\u200b\u6765\u200b\u8bb2\u89e3\u200b\u3002</p> <ul> <li>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u5b9a\u200b\u4f7f\u7528\u200b\u54ea\u4e2a\u200b\u4e2d\u65ad\u200b</li> </ul> <pre><code>    gpio_keys_100ask {\n        compatible = \"100ask,gpio_key\";\n      interrupt-parent = &lt;&amp;gpio5&gt;;\n      interrupts = &lt;3 IRQ_TYPE_EDGE_BOTH&gt;,\n    };\n</code></pre> <ul> <li> <p>\u200b\u5185\u6838\u200b\u89e3\u6790\u200b\u3001\u200b\u5904\u7406\u200b\u8bbe\u5907\u200b\u6811\u200b\u7684\u200b\u4e2d\u65ad\u200b\u4fe1\u606f\u200b</p> </li> <li> <p>\u200b\u6839\u636e\u200b<code>interrupt-parent</code>\u200b\u627e\u5230\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6ce8\u518c\u200b\u7684\u200bGPIO irq_domain</p> </li> <li>GPIO irq_domain\u200b\u5bf9\u200b\u8bbe\u5907\u200b\u6811\u200b\u7684\u200b\u89e3\u6790\u200b<ul> <li>\u200b\u4f7f\u7528\u200bGPIO irq_domain.ops\u200b\u4e2d\u200b\u7684\u200btranslate\u200b\u6216\u200bxlate\u200b\u51fd\u6570\u200b\u89e3\u6790\u200b\u8bbe\u5907\u200b\u6811\u200b\uff0c\u200b\u5f97\u5230\u200bhwirq\u200b\u548c\u200btype</li> <li>\u200b\u5206\u914d\u200b/\u200b\u627e\u5230\u200birq_desc\uff0c\u200b\u5f97\u5230\u200bvirq</li> <li>\u200b\u628a\u200b(hwirq, virq)\u200b\u7684\u200b\u5173\u7cfb\u200b\u5b58\u5165\u200bGPIO irq_domain</li> <li>\u200b\u628a\u200bvirq\u200b\u5b58\u5165\u200bplatform_device\u200b\u7684\u200bresource\u200b\u4e2d\u200b</li> <li>\u200b\u4fee\u6539\u200b\u5f97\u5230\u200b\u5bf9\u5e94\u200b\u7684\u200bGIC_hwirq\uff0c\u200b\u8c03\u7528\u200b\u7236\u7ea7\u200bGIC irq_domain\u200b\u7ee7\u7eed\u200b\u89e3\u6790\u200b</li> <li>\u200b\u628a\u200b(GIC_hwirq, virq)\u200b\u7684\u200b\u5173\u7cfb\u200b\u5b58\u5165\u200bGIC irq_domain</li> <li>\u200b\u6ce8\u610f\u200b\uff1a\u200b\u5bf9\u4e8e\u200b\u540c\u4e00\u4e2a\u200b\u786c\u4ef6\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5b83\u200b\u5728\u200b\u4e24\u4e2a\u200birq_domain\u200b\u91cc\u200b\u7684\u200bvirq\u200b\u662f\u200b\u76f8\u540c\u200b\u7684\u200b\uff0chwirq\u200b\u53ef\u80fd\u200b\u4e0d\u200b\u4e00\u6837\u200b\u3002</li> </ul> </li> <li> <p>GPIO irq_domain\u200b\u5bf9\u200b\u8bbe\u5907\u200b\u6811\u200b\u7684\u200b\u8bbe\u7f6e\u200b</p> <ul> <li>\u200b\u4f7f\u7528\u200bGPIO irq_domain.ops\u200b\u4e2d\u200b\u7684\u200balloc\u200b\u51fd\u6570\u200b\u8fdb\u884c\u200b\u8bbe\u7f6e\u200b</li> <li>\u200b\u66ff\u6362\u200birq_desc[virq].irq_data\uff0c\u200b\u91cc\u9762\u200b\u6709\u200birq_chip\u200b\u6539\u4e3a\u200birq_chipB\uff0c\u200b\u5373\u200bGPIO\u200b\u7684\u200birq_chip</li> <li>\u200b\u8c03\u7528\u200b\u7236\u7ea7\u200bGIC irq_domain\u200b\u7684\u200balloc\u200b\u7ee7\u7eed\u200b\u8bbe\u7f6e\u200b<ul> <li>\u200b\u8bbe\u7f6e\u200birq_desc[virq].handle_irq\u200b\u4e3a\u200bGIC\u200b\u7684\u200bhandle_irq\uff0c\u200b\u5373\u200b\u4e0a\u200b\u56fe\u200b\u4e2d\u200b\u7684\u200bhandleA</li> </ul> </li> </ul> </li> <li> <p>\u200b\u7528\u6237\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6ce8\u518c\u200b\u4e2d\u65ad\u200b</p> </li> <li> <p>\u200b\u4ece\u200bplatform_device\u200b\u7684\u200bresource\u200b\u4e2d\u200b\u5f97\u5230\u200b\u4e2d\u65ad\u200b\u53f7\u200bvirq</p> </li> <li> <p>request_irq(virq, ..., func)</p> </li> <li> <p>\u200b\u53d1\u751f\u200b\u4e2d\u65ad\u200b\u3001\u200b\u5904\u7406\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u5904\u7406\u200b\u6d41\u7a0b\u200b\u89c1\u200b\u4e0a\u9762\u200b\u3002</p> </li> </ul>"},{"location":"08_Interrupt/18_1/#2","title":"2. \u200b\u786c\u4ef6\u200b\u6a21\u578b","text":"<p>\u200b\u4e0b\u56fe\u200b\u4e2d\u200b\u5217\u51fa\u200b\u4e86\u200b\u94fe\u5f0f\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u3001\u200b\u5c42\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u672c\u200b\u8282\u200b\u8bfe\u7a0b\u200b\u4e4b\u200b\u8bbe\u8ba1\u200b\u53f3\u8fb9\u200b\u7684\u200b\u5c42\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u3002</p> <p>\u200b\u5185\u6838\u200b\u4e2d\u6709\u200b\u5404\u7c7b\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u5b83\u4eec\u200b\u6d89\u53ca\u200b\u7684\u200b\u786c\u4ef6\u200b\u8fc7\u4e8e\u200b\u590d\u6742\u200b\uff0c\u200b\u4ece\u200b\u8fd9\u4e9b\u200b\u6742\u4e71\u200b\u7684\u200b\u4ee3\u7801\u200b\u4e2d\u200b\u53bb\u200b\u8bb2\u6e05\u695a\u200b\u4e2d\u65ad\u200b\u4f53\u7cfb\u200b\uff0c\u200b\u6bd4\u8f83\u200b\u96be\u200b\u3002</p> <p>\u200b\u6211\u4eec\u200b\u5b9e\u73b0\u200b\u4e00\u4e9b\u200b\u865a\u62df\u200b\u7684\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b\u3002</p> <p>\u200b\u5b9e\u9645\u200b\u677f\u5b50\u200b\u4e2d\u200b\uff0c\u200b\u6211\u4eec\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200b\u6309\u952e\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\u3002</p> <p>\u200b\u5bf9\u4e8e\u200b\u8fd9\u4e9b\u200b\u865a\u62df\u200b\u7684\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u6211\u4eec\u200b\u6ca1\u6709\u200b\u771f\u5b9e\u200b\u6309\u952e\u200b\uff0c\u200b\u901a\u8fc7\u200bdevmem\u200b\u6307\u4ee4\u200b\u5199\u200bGIC\u200b\u7684\u200bPENDING\u200b\u5bc4\u5b58\u5668\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\u3002</p> <p></p>"},{"location":"08_Interrupt/18_1/#3","title":"3. \u200b\u7f16\u7a0b","text":"<p>\u200b\u4f1a\u200b\u6d89\u53ca\u200b2\u200b\u4e2a\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff1a\u200b\u865a\u62df\u200b\u7684\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b\uff0c\u200b\u6309\u952e\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u4ee5\u53ca\u200b\u5bf9\u5e94\u200b\u7684\u200b\u8bbe\u5907\u200b\u6811\u200b\u3002</p> <p>\u200b\u865a\u62df\u200b\u7684\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b\u4e2d\u200b\uff0c\u200b\u6d89\u53ca\u200b2\u200b\u4e2a\u200b\u9012\u5f52\u200b\u5904\u7406\u200b\u3002</p>"},{"location":"08_Interrupt/18_1/#31-alloc","title":"3.1 alloc\u200b\u7684\u200b\u9012\u5f52\u200b\u5904\u7406","text":""},{"location":"08_Interrupt/18_1/#32-irq_chip","title":"3.2 irq_chip\u200b\u7684\u200b\u9012\u5f52\u200b\u5904\u7406","text":""},{"location":"08_Interrupt/19_1/","title":"12_\u200b\u5c42\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":""},{"location":"08_Interrupt/19_1/#_1","title":"\u5c42\u7ea7\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>linux kernel\u200b\u7684\u200b\u4e2d\u65ad\u200b\u5b50\u7cfb\u7edf\u200b\u4e4b\u200b\uff08\u200b\u4e03\u200b\uff09\uff1aGIC\u200b\u4ee3\u7801\u200b\u5206\u6790\u200b</p> </li> <li> <p>Linux 4.9.88\u200b\u5185\u6838\u200b\u6e90\u7801\u200b</p> </li> <li> <p><code>Linux-4.9.88\\drivers\\gpio\\gpio-mxc.c</code></p> </li> <li> <p><code>Linux-4.9.88\\arch\\arm\\boot\\dts\\imx6ull.dtsi</code></p> </li> <li> <p>Linux 5.4\u200b\u5185\u6838\u200b\u6e90\u7801\u200b</p> </li> <li> <p><code>Linux-5.4\\drivers\\pinctrl\\stm32\\pinctrl-stm32mp157.c</code></p> </li> <li><code>Linux-5.4\\drivers\\irqchip\\irq-stm32-exti.c</code></li> <li> <p><code>Linux-5.4\\arch\\arm\\boot\\dts\\stm32mp151.dtsi</code></p> </li> <li> <p>\u200b\u82af\u7247\u200b\u624b\u518c\u200b</p> </li> <li> <p>IMX6ULL: imx6ullrm.pdf</p> </li> <li> <p>STM32MP157: DM00327659.pdf</p> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b</p> </li> </ul> <pre><code>doc_and_source_for_drivers\\\n  IMX6ULL\\source\\08_Interrupt\\\n      07_virtual_int_controller_hierarchy_ok\n\ndoc_and_source_for_drivers\\\n  STM32MP157\\source\\A7\\08_Interrupt\\\n      07_virtual_int_controller_hierarchy_ok\n</code></pre>"},{"location":"08_Interrupt/19_1/#1-n","title":"1. \u200b\u786e\u5b9a\u200b\u4e2d\u65ad\u200b\u53f7\u200bn","text":"<p>\u200b\u67e5\u770b\u200b\u82af\u7247\u200b\u624b\u518c\u200b\uff0c\u200b\u9009\u62e9\u200b\u4e00\u4e2a\u200b\u4fdd\u7559\u200b\u7684\u200b\u3001\u200b\u672a\u200b\u4f7f\u7528\u200b\u7684\u200bGIC SPI\u200b\u4e2d\u65ad\u200b\u5373\u53ef\u200b\u3002</p>"},{"location":"08_Interrupt/19_1/#11-imx6ull","title":"1.1 IMX6ULL","text":"<p>\u200b\u770b\u200b\u82af\u7247\u200b\u624b\u518c\u200b\u7b2c\u200b3\u200b\u7ae0\u200b\uff1a</p> <p></p> <p>\u200b\u770b\u4e0a\u200b\u56fe\u200b\uff0c\u200b\u9009\u62e9\u200b122\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5b83\u200b\u662f\u200bSPI\u200b\u91cc\u200b\u7684\u200b122\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0cGIC\u200b\u91cc\u200b\u7684\u200b\u7f16\u53f7\u200b\u662f\u200b(32+122)=154\u3002</p>"},{"location":"08_Interrupt/19_1/#12-stm32mp157","title":"1.2 STM32MP157","text":"<p>\u200b\u770b\u200b\u82af\u7247\u200b\u624b\u518c\u200b\u7b2c\u200b21.2\u200b\u8282\u200b\uff1a</p> <p></p> <p>\u200b\u770b\u4e0a\u200b\u56fe\u200b\uff0c\u200b\u9009\u62e9\u200b210\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5b83\u200b\u662f\u200bSPI\u200b\u91cc\u200b\u7684\u200b210\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0cGIC\u200b\u91cc\u200b\u7684\u200b\u7f16\u53f7\u200b\u662f\u200b(32+210)=242\u3002</p>"},{"location":"08_Interrupt/19_1/#2","title":"2. \u200b\u600e\u4e48\u200b\u89e6\u53d1\u200b\u4e2d\u65ad","text":"<p>\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200bdevmem\u200b\u547d\u4ee4\u200b\u76f4\u63a5\u200b\u5199\u200bGIC\u200b\u7684\u200bPENDING\u200b\u5bc4\u5b58\u200b\u533a\u200b\u3002</p> <p></p> <p>GICD_ISPENDRn\u200b\u6709\u200b\u591a\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u6bcf\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\u4e2d\u200b\u6bcf\u200b\u4e00\u4f4d\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200bGIC\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5199\u5165\u200b1\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u89e6\u53d1\u200b\u8be5\u200b\u4e2d\u65ad\u200b\u3002</p> <p>\u200b\u5199\u200b\u54ea\u200b\u4e00\u4e2a\u200bGICD_ISPENDRn\u200b\u5bc4\u5b58\u5668\u200b\uff1f\u200b\u5199\u200b\u54ea\u4e00\u4f4d\u200b\uff1f\u200b\u4f7f\u7528\u200b\u4e0b\u5217\u200b\u516c\u5f0f\u200b\u6765\u200b\u786e\u5b9a\u200b\uff1a</p> <p></p> <p>\u200b\u67e5\u770b\u200b\u5185\u6838\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200bimx6ull.dtsi\u3001stm32mp151.dtsi\uff0c\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200b\uff1a</p> <ul> <li>IMX6ULL\u200b\u7684\u200bGIC Distributor \u200b\u5730\u5740\u200b\u662f\u200b\uff1a0x00a01000   </li> <li>STM32MP157\u200b\u7684\u200bGIC Distributor \u200b\u5730\u5740\u200b\u662f\u200b\uff1a0xa0021000   </li> </ul> \u200b\u82af\u7247\u200b SPI\u200b\u4e2d\u65ad\u200b\u53f7\u200b GIC\u200b\u4e2d\u65ad\u200b\u53f7\u200b n,bit GICD_ISPENDRn\u200b\u5730\u5740\u200b \u200b\u547d\u4ee4\u200b IMX6LLL 122 154 4,26 0xa01210 devmem 0xa01210 32 0x4000000 123 155 4,27 0xa01210 devmem 0xa01210 32 0x8000000 124 156 4,28 0xa01210 devmem 0xa01210 32 0x10000000 125 157 4,29 0xa01210 devmem 0xa01210 32 0x20000000 STM32MP157 210 242 7,18 0xa002121c devmem 0xa002121c 32 0x40000 211 243 7,19 0xa002121c devmem 0xa002121c 32 0x80000 212 244 7,20 0xa002121c devmem 0xa002121c 32 0x100000 213 245 7,21 0xa002121c devmem 0xa002121c 32 0x200000"},{"location":"08_Interrupt/19_1/#3","title":"3. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":""},{"location":"08_Interrupt/19_1/#31","title":"3.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":""},{"location":"08_Interrupt/19_1/#1-stm32mp157","title":"1. STM32MP157","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"08_Interrupt/19_1/#2-imx6ull","title":"2. IMX6ULL","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre>"},{"location":"08_Interrupt/19_1/#32","title":"3.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"08_Interrupt/19_1/#1-stm32mp157_1","title":"1. STM32MP157","text":"<ul> <li> <p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dts</code>\uff0c\u200b\u6dfb\u52a0\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>/ {\n   virtual_intc: virtual_intc_100ask {\n        compatible = \"100ask,virtual_intc\";\n\n        interrupt-controller;\n        #interrupt-cells = &lt;2&gt;;\n\n        interrupt-parent = &lt;&amp;intc&gt;;\n        //upper_hwirq_base = &lt;122&gt;;  // imx6ull\n        upper_hwirq_base = &lt;210&gt;;  // stm32mp157\n    };\n\n    gpio_keys_100ask {\n        compatible = \"100ask,gpio_key\";\n        interrupt-parent = &lt;&amp;virtual_intc&gt;;\n        interrupts = &lt;0 IRQ_TYPE_LEVEL_HIGH&gt;,\n                     &lt;1 IRQ_TYPE_LEVEL_HIGH&gt;,\n                     &lt;2 IRQ_TYPE_LEVEL_HIGH&gt;,\n                     &lt;3 IRQ_TYPE_LEVEL_HIGH&gt;;\n    };\n};\n</code></pre> </li> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bSTM32MP157\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <ul> <li>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.1.100)</li> </ul> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> <ul> <li>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.1.137</li> </ul> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> </ul> <pre><code>[root@100ask:~]# mount  /dev/mmcblk2p2  /boot\n[root@100ask:~]# cp /mnt/stm32mp157c-100ask-512d-lcd-v1.dtb /boot\n[root@100ask:~]# sync\n</code></pre> <ul> <li>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</li> </ul>"},{"location":"08_Interrupt/19_1/#2-imx6ull_1","title":"2. IMX6ULL","text":"<ul> <li> <p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code>\uff0c\u200b\u6dfb\u52a0\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>/ {\n   virtual_intc: virtual_intc_100ask {\n        compatible = \"100ask,virtual_intc\";\n\n        interrupt-controller;\n        #interrupt-cells = &lt;2&gt;;\n\n        interrupt-parent = &lt;&amp;intc&gt;;\n        upper_hwirq_base = &lt;122&gt;;  // imx6ull\n        //upper_hwirq_base = &lt;210&gt;;  // stm32mp157\n    };\n\n    gpio_keys_100ask {\n        compatible = \"100ask,gpio_key\";\n        interrupt-parent = &lt;&amp;virtual_intc&gt;;\n        interrupts = &lt;0 IRQ_TYPE_LEVEL_HIGH&gt;,\n                     &lt;1 IRQ_TYPE_LEVEL_HIGH&gt;,\n                     &lt;2 IRQ_TYPE_LEVEL_HIGH&gt;,\n                     &lt;3 IRQ_TYPE_LEVEL_HIGH&gt;;\n    };\n\n};\n</code></pre> </li> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bIMX6ULL\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/100ask_imx6ull-14x14.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.1.100)</p> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.1.137</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/100ask_imx6ull-14x14.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"08_Interrupt/19_1/#33","title":"3.3 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u5b89\u88c5\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\uff1a</p> </li> <li> <p>\u200b\u5728\u200bUbuntu\u200b\u4e0a\u200b</p> </li> <li> <p>\u200b\u4fee\u6539\u200b<code>07_virtual_int_controller_hierarchy_ok</code>\u200b\u4e2d\u200b\u7684\u200bMakefile\uff0c\u200b\u6307\u5b9a\u200b\u5185\u6838\u200b\u8def\u5f84\u200b<code>KERN_DIR</code>\uff0c\u200b\u5728\u200b\u6267\u884c\u200b<code>make</code>\u200b\u547d\u4ee4\u200b\u5373\u53ef\u200b\u3002</p> </li> <li> <p>\u200b\u5b89\u88c5\u200b\uff1a</p> </li> <li> <p>\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b</p> </li> <li> <p>\u200b\u6302\u8f7d\u200bNFS\uff0c\u200b\u590d\u5236\u200b\u6587\u4ef6\u200b\uff0cinsmod\uff0c\u200b\u7c7b\u4f3c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b\uff1a</p> <pre><code>mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n// \u200b\u5bf9\u4e8e\u200bIMX6ULL\uff0c\u200b\u60f3\u200b\u770b\u5230\u200b\u9a71\u52a8\u200b\u6253\u5370\u4fe1\u606f\u200b\uff0c\u200b\u9700\u8981\u200b\u5148\u200b\u6267\u884c\u200b\necho \"7 4 1 7\" &gt; /proc/sys/kernel/printk\n\ninsmod -f /mnt/virtual_int_controller.ko\n// \u200b\u5b89\u88c5\u200bvirtual_int_controller\u200b\u4e4b\u540e\u200b\u5373\u53ef\u200b\u8fdb\u5165\u200b/sys/kernel/irq\u200b\u76ee\u5f55\u200b\u67e5\u770b\u200b\u5206\u914d\u200b\u7684\u200b\u4e2d\u65ad\u200b\u53f7\u200b\n\ninsmod -f /mnt/gpio_key_drv.ko\ncat /proc/interrupts\n\n// \u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\n// \u200b\u5bf9\u4e8e\u200bIMX6ULL\ndevmem 0xa01210 32 0x4000000\ndevmem 0xa01210 32 0x8000000\ndevmem 0xa01210 32 0x10000000\ndevmem 0xa01210 32 0x20000000\n\n// \u200b\u5bf9\u4e8e\u200bstm32mp157\ndevmem 0xa002121c 32 0x40000 \ndevmem 0xa002121c 32 0x80000\ndevmem 0xa002121c 32 0x100000  // \u200b\u5b83\u200b\u4e0d\u80fd\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b,\u200b\u53ef\u80fd\u200b\u662f\u200b\u88ab\u200b\u5360\u7528\u200b\u4e86\u200b\ndevmem 0xa002121c 32 0x200000\n</code></pre> </li> <li> <p>\u200b\u89c2\u5bdf\u200b\u5185\u6838\u200b\u6253\u5370\u200b\u7684\u200b\u4fe1\u606f\u200b</p> </li> </ul>"},{"location":"09_UART/01_1/","title":"01_UART\u200b\u5b50\u7cfb\u7edf\u200b\u89c6\u9891\u200b\u4ecb\u7ecd","text":""},{"location":"09_UART/01_1/#uart","title":"UART\u200b\u5b50\u7cfb\u7edf\u200b\u89c6\u9891\u200b\u4ecb\u7ecd","text":""},{"location":"09_UART/01_1/#1-uart","title":"1. UART\u200b\u7684\u200b\u4f5c\u7528","text":"<p>UART\uff1a\u200b\u901a\u7528\u200b\u5f02\u6b65\u200b\u6536\u53d1\u200b\u4f20\u8f93\u5668\u200b\uff08Universal Asynchronous Receiver/Transmitter)\uff0c\u200b\u7b80\u79f0\u200b\u4e32\u53e3\u200b\u3002</p> <ul> <li> <p>\u200b\u8c03\u8bd5\u200b\uff1a\u200b\u79fb\u690d\u200bu-boot\u3001\u200b\u5185\u6838\u200b\u65f6\u200b\uff0c\u200b\u4e3b\u8981\u200b\u4f7f\u7528\u200b\u4e32\u53e3\u200b\u67e5\u770b\u200b\u6253\u5370\u4fe1\u606f\u200b</p> </li> <li> <p>\u200b\u5916\u63a5\u200b\u5404\u79cd\u200b\u6a21\u5757\u200b</p> </li> </ul> <p></p>"},{"location":"09_UART/01_1/#2","title":"2. \u200b\u9884\u8ba1\u200b\u5f55\u5236\u200b\u7684\u200b\u5185\u5bb9","text":"<p>\u200b\u672c\u200b\u6559\u7a0b\u200b\u542c\u53d6\u200b\u4e86\u200b\u5b66\u5458\u200b\u7684\u200b\u5efa\u8bae\u200b\uff0c\u200b\u589e\u52a0\u200b\u4e86\u200b\u5f88\u591a\u200b\u529f\u80fd\u200b\uff1a</p> <p></p> <ul> <li>UART\u200b\u534f\u8bae\u200b</li> <li>UART\u200b\u5e94\u7528\u7a0b\u5e8f\u200b\u7f16\u7a0b\u200b</li> <li>TTY\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4f53\u7cfb\u200b</li> <li>/dev/tty\u3001/dev/tty0\u3001/dev/tty1\u3001/dev/console\u200b\u7684\u200b\u5173\u7cfb\u200b</li> <li>UART\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5206\u6790\u200b</li> <li>\u200b\u5b9e\u73b0\u200b\u4e00\u4e2a\u200b\u865a\u62df\u200b\u7684\u200bUART\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</li> <li>\u200b\u5185\u6838\u200bprintk\u200b\u6253\u5370\u200b\u7cfb\u7edf\u5206\u6790\u200b</li> <li>early print</li> <li>printk</li> <li>\u200b\u5b9e\u73b0\u200b\u4e00\u4e2a\u200b\u865a\u62df\u200b\u7684\u200bprintk\u200b\u529f\u80fd\u200b</li> <li>485\u200b\u7684\u200b\u4f7f\u7528\u200b</li> </ul>"},{"location":"09_UART/02_1/","title":"\u786c\u4ef6\u200b\u77e5\u8bc6\u200b_UART\u200b\u786c\u4ef6\u200b\u4ecb\u7ecd","text":""},{"location":"09_UART/02_1/#1","title":"1. \u200b\u4e32\u53e3\u200b\u7684\u200b\u786c\u4ef6\u200b\u4ecb\u7ecd","text":"<p>UART\u200b\u7684\u200b\u5168\u79f0\u200b\u662f\u200bUniversal Asynchronous Receiver and Transmitter\uff0c\u200b\u5373\u200b\u5f02\u6b65\u200b\u53d1\u9001\u200b\u548c\u200b\u63a5\u6536\u200b\u3002 \u200b\u4e32\u53e3\u200b\u5728\u200b\u5d4c\u5165\u5f0f\u200b\u4e2d\u200b\u7528\u9014\u200b\u975e\u5e38\u200b\u7684\u200b\u5e7f\u6cdb\u200b\uff0c\u200b\u4e3b\u8981\u200b\u7684\u200b\u7528\u9014\u200b\u6709\u200b\uff1a</p> <ul> <li>\u200b\u6253\u5370\u200b\u8c03\u8bd5\u4fe1\u606f\u200b\uff1b</li> <li>\u200b\u5916\u63a5\u200b\u5404\u79cd\u200b\u6a21\u5757\u200b\uff1aGPS\u3001\u200b\u84dd\u7259\u200b\uff1b</li> </ul> <p>\u200b\u4e32\u53e3\u200b\u56e0\u4e3a\u200b\u7ed3\u6784\u200b\u7b80\u5355\u200b\u3001\u200b\u7a33\u5b9a\u200b\u53ef\u9760\u200b\uff0c\u200b\u5e7f\u200b\u53d7\u6b22\u8fce\u200b\u3002</p> <p>\u200b\u901a\u8fc7\u200b\u4e09\u6839\u200b\u7ebf\u200b\u5373\u53ef\u200b\uff0c\u200b\u53d1\u9001\u200b\u3001\u200b\u63a5\u6536\u200b\u3001\u200b\u5730\u200b\u7ebf\u200b\u3002  \u200b\u901a\u8fc7\u200bTxD-&gt;RxD\u200b\u628a\u200bARM\u200b\u5f00\u53d1\u677f\u200b\u8981\u200b\u53d1\u9001\u200b\u7684\u200b\u4fe1\u606f\u200b\u53d1\u9001\u7ed9\u200bPC\u200b\u673a\u200b\u3002 \u200b\u901a\u8fc7\u200bRxD-&gt;TxD\u200b\u7ebf\u200b\u628a\u200bPC\u200b\u673a\u8981\u200b\u53d1\u9001\u200b\u7684\u200b\u4fe1\u606f\u200b\u53d1\u9001\u7ed9\u200bARM\u200b\u5f00\u53d1\u677f\u200b\u3002 \u200b\u6700\u200b\u4e0b\u9762\u200b\u7684\u200b\u5730\u7ebf\u200b\u7edf\u4e00\u200b\u53c2\u8003\u200b\u5730\u200b\u3002</p>"},{"location":"09_UART/02_1/#2","title":"2. \u200b\u4e32\u53e3\u200b\u7684\u200b\u53c2\u6570","text":"<ul> <li>\u200b\u6ce2\u7279\u7387\u200b\uff1a\u200b\u4e00\u822c\u200b\u9009\u200b\u6ce2\u7279\u7387\u200b\u90fd\u200b\u4f1a\u200b\u6709\u200b9600,19200,115200\u200b\u7b49\u200b\u9009\u9879\u200b\u3002\u200b\u5176\u5b9e\u200b\u610f\u601d\u200b\u5c31\u662f\u200b\u6bcf\u79d2\u200b\u4f20\u8f93\u200b\u8fd9\u4e48\u200b\u591a\u4e2a\u200b\u6bd4\u7279\u200b\u4f4d\u6570\u200b(bit)\u3002</li> <li>\u200b\u8d77\u59cb\u200b\u4f4d\u200b:\u200b\u5148\u200b\u53d1\u51fa\u200b\u4e00\u4e2a\u200b\u903b\u8f91\u200b\u201d0\u201d\u200b\u7684\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u8868\u793a\u200b\u4f20\u8f93\u6570\u636e\u200b\u7684\u200b\u5f00\u59cb\u200b\u3002</li> <li>\u200b\u6570\u636e\u4f4d\u200b\uff1a\u200b\u53ef\u4ee5\u200b\u662f\u200b5~8\u200b\u4f4d\u200b\u903b\u8f91\u200b\u201d0\u201d\u200b\u6216\u200b\u201d1\u201d\u3002\u200b\u5982\u200bASCII\u200b\u7801\u200b\uff087\u200b\u4f4d\u200b\uff09\uff0c\u200b\u6269\u5c55\u200bBCD\u200b\u7801\u200b\uff088\u200b\u4f4d\u200b\uff09\u3002\u200b\u5c0f\u7aef\u200b\u4f20\u8f93\u200b\u3002</li> <li>\u200b\u6821\u9a8c\u4f4d\u200b\uff1a\u200b\u6570\u636e\u4f4d\u200b\u52a0\u4e0a\u200b\u8fd9\u200b\u4e00\u4f4d\u200b\u540e\u200b\uff0c\u200b\u4f7f\u5f97\u200b\u201c1\u201d\u200b\u7684\u200b\u4f4d\u6570\u200b\u5e94\u4e3a\u200b\u5076\u6570\u200b(\u200b\u5076\u200b\u6821\u9a8c\u200b)\u200b\u6216\u200b\u5947\u6570\u200b(\u200b\u5947\u200b\u6821\u9a8c\u200b)\uff0c\u200b\u4ee5\u6b64\u200b\u6765\u200b\u6821\u9a8c\u200b\u6570\u636e\u200b\u4f20\u9001\u200b\u7684\u200b\u6b63\u786e\u6027\u200b\u3002</li> <li>\u200b\u505c\u6b62\u200b\u4f4d\u200b\uff1a\u200b\u5b83\u200b\u662f\u200b\u4e00\u4e2a\u200b\u5b57\u7b26\u200b\u6570\u636e\u200b\u7684\u200b\u7ed3\u675f\u200b\u6807\u5fd7\u200b\u3002</li> </ul> <p>\u200b\u600e\u4e48\u200b\u53d1\u9001\u200b\u4e00\u200b\u5b57\u8282\u200b\u6570\u636e\u200b\uff0c\u200b\u6bd4\u5982\u200b\u2018A\u2018? \u2018A\u2019\u200b\u7684\u200bASCII\u200b\u503c\u200b\u662f\u200b0x41,\u200b\u4e8c\u8fdb\u5236\u200b\u5c31\u662f\u200b01000001\uff0c\u200b\u600e\u6837\u200b\u628a\u200b\u8fd9\u200b8\u200b\u4f4d\u200b\u6570\u636e\u200b\u53d1\u9001\u7ed9\u200bPC\u200b\u673a\u200b\u5462\u200b\uff1f * \u200b\u53cc\u65b9\u200b\u7ea6\u5b9a\u200b\u597d\u200b\u6ce2\u7279\u7387\u200b\uff08\u200b\u6bcf\u200b\u4e00\u4f4d\u200b\u5360\u636e\u200b\u7684\u200b\u65f6\u95f4\u200b\uff09\uff1b</p> <ul> <li> <p>\u200b\u89c4\u5b9a\u200b\u4f20\u8f93\u200b\u534f\u8bae\u200b</p> </li> <li> <p>\u200b\u539f\u6765\u200b\u662f\u200b\u9ad8\u7535\u5e73\u200b\uff0cARM\u200b\u62c9\u200b\u4f4e\u7535\u5e73\u200b\uff0c\u200b\u4fdd\u6301\u200b1bit\u200b\u65f6\u95f4\u200b\uff1b</p> </li> <li>PC\u200b\u5728\u200b\u4f4e\u7535\u5e73\u200b\u5f00\u59cb\u200b\u5904\u200b\u8ba1\u65f6\u200b\uff1b</li> <li>ARM\u200b\u6839\u636e\u200b\u6570\u636e\u200b\u4f9d\u6b21\u200b\u9a71\u52a8\u200bTxD\u200b\u7684\u200b\u7535\u5e73\u200b\uff0c\u200b\u540c\u65f6\u200bPC\u200b\u4f9d\u6b21\u200b\u8bfb\u53d6\u200bRxD\u200b\u5f15\u811a\u200b\u7535\u5e73\u200b\uff0c\u200b\u83b7\u5f97\u200b\u6570\u636e\u200b\uff1b</li> </ul> <p></p> <p>\u200b\u524d\u9762\u200b\u56fe\u4e2d\u200b\u63d0\u53ca\u200b\u5230\u200b\u4e86\u200b\u903b\u8f91\u200b\u7535\u5e73\u200b\uff0c\u200b\u4e5f\u5c31\u662f\u8bf4\u200b\u4ee3\u8868\u200b\u4fe1\u53f7\u200b1\u200b\u7684\u200b\u5f15\u811a\u200b\u7535\u5e73\u200b\u662f\u200b\u4eba\u4e3a\u200b\u89c4\u5b9a\u200b\u7684\u200b\u3002 \u200b\u5982\u56fe\u200b\u662f\u200bTTL/CMOS\u200b\u903b\u8f91\u200b\u7535\u5e73\u200b\u4e0b\u200b\uff0c\u200b\u4f20\u8f93\u200b\u2018A\u2019\u200b\u65f6\u200b\u7684\u200b\u6ce2\u5f62\u200b\uff1a  \u200b\u5728\u200bxV\u200b\u81f3\u200b5V\u200b\u4e4b\u95f4\u200b\uff0c\u200b\u5c31\u200b\u8ba4\u4e3a\u200b\u662f\u200b\u903b\u8f91\u200b1\uff0c\u200b\u5728\u200b0V\u200b\u81f3\u200byV\u200b\u4e4b\u95f4\u200b\u5c31\u200b\u4e3a\u200b\u903b\u8f91\u200b0\u3002</p> <p>\u200b\u5982\u56fe\u200b\u662f\u200bRS-232\u200b\u903b\u8f91\u200b\u7535\u5e73\u200b\u4e0b\u200b\uff0c\u200b\u4f20\u8f93\u200b\u2018A\u2019\u200b\u65f6\u200b\u7684\u200b\u6ce2\u5f62\u200b\uff1a  \u200b\u5728\u200b-12V\u200b\u81f3\u200b-3V\u200b\u4e4b\u95f4\u200b\uff0c\u200b\u5c31\u200b\u8ba4\u4e3a\u200b\u662f\u200b\u903b\u8f91\u200b1\uff0c\u200b\u5728\u200b+3V\u200b\u81f3\u200b+12V\u200b\u4e4b\u95f4\u200b\u5c31\u200b\u4e3a\u200b\u903b\u8f91\u200b0\u3002</p> <p>RS-232\u200b\u7684\u200b\u7535\u5e73\u200b\u6bd4\u200bTTL/CMOS\u200b\u9ad8\u200b\uff0c\u200b\u80fd\u200b\u4f20\u8f93\u200b\u66f4\u8fdc\u200b\u7684\u200b\u8ddd\u79bb\u200b\uff0c\u200b\u5728\u200b\u5de5\u4e1a\u200b\u4e0a\u7528\u200b\u5f97\u200b\u6bd4\u8f83\u200b\u591a\u200b\u3002</p> <p>\u200b\u5e02\u9762\u4e0a\u200b\u5927\u591a\u6570\u200bARM\u200b\u82af\u7247\u200b\u90fd\u200b\u4e0d\u6b62\u200b\u4e00\u4e2a\u200b\u4e32\u53e3\u200b\uff0c\u200b\u4e00\u822c\u200b\u4f7f\u7528\u200b\u4e32\u53e3\u200b0\u200b\u6765\u200b\u8c03\u8bd5\u200b\uff0c\u200b\u5176\u5b83\u200b\u4e32\u53e3\u200b\u6765\u200b\u5916\u63a5\u200b\u6a21\u5757\u200b\u3002</p>"},{"location":"09_UART/02_1/#3","title":"3. \u200b\u4e32\u53e3\u200b\u7535\u5e73","text":"<p>ARM\u200b\u82af\u7247\u200b\u4e0a\u200b\u5f97\u200b\u4e32\u53e3\u200b\u90fd\u200b\u662f\u200bTTL\u200b\u7535\u5e73\u200b\u7684\u200b\uff0c\u200b\u901a\u8fc7\u200b\u677f\u5b50\u200b\u4e0a\u200b\u6216\u8005\u200b\u5916\u63a5\u200b\u7684\u200b\u7535\u5e73\u200b\u8f6c\u6362\u200b\u82af\u7247\u200b\uff0c\u200b\u8f6c\u200b\u6210\u200bRS232\u200b\u63a5\u53e3\u200b\uff0c\u200b\u8fde\u63a5\u200b\u5230\u200b\u7535\u8111\u200b\u7684\u200bRS232\u200b\u4e32\u53e3\u200b\u4e0a\u200b\uff0c\u200b\u5b9e\u73b0\u200b\u4e24\u8005\u200b\u7684\u200b\u6570\u636e\u4f20\u8f93\u200b\u3002  \u200b\u73b0\u5728\u200b\u7684\u200b\u7535\u8111\u200b\u8d8a\u6765\u8d8a\u200b\u5c11\u6709\u200bRS232\u200b\u4e32\u53e3\u200b\u7684\u200b\u63a5\u53e3\u200b\uff0c\u200b\u5f53\u200bUSB\u200b\u662f\u200b\u51e0\u4e4e\u200b\u90fd\u200b\u6709\u200b\u7684\u200b\u3002\u200b\u56e0\u6b64\u200b\u4f7f\u7528\u200bUSB\u200b\u4e32\u53e3\u200b\u82af\u7247\u200b\u5c06\u200bARM\u200b\u82af\u7247\u200b\u4e0a\u200b\u7684\u200bTTL\u200b\u7535\u5e73\u200b\u8f6c\u6362\u6210\u200bUSB\u200b\u4e32\u53e3\u200b\u534f\u8bae\u200b\uff0c\u200b\u5373\u53ef\u200b\u901a\u8fc7\u200bUSB\u200b\u4e0e\u200b\u7535\u8111\u200b\u6570\u636e\u4f20\u8f93\u200b\u3002  \u200b\u4e0a\u9762\u200b\u7684\u200b\u4e24\u79cd\u200b\u65b9\u5f0f\u200b\uff0c\u200b\u5bf9\u200bARM\u200b\u82af\u7247\u200b\u7684\u200b\u7f16\u7a0b\u200b\u64cd\u4f5c\u200b\u90fd\u200b\u662f\u200b\u4e00\u6837\u200b\u7684\u200b\u3002</p>"},{"location":"09_UART/02_1/#4","title":"4. \u200b\u4e32\u53e3\u200b\u5185\u90e8\u7ed3\u6784","text":"<p>ARM\u200b\u82af\u7247\u200b\u662f\u200b\u5982\u4f55\u200b\u53d1\u9001\u200b/\u200b\u63a5\u6536\u6570\u636e\u200b\uff1f \u200b\u5982\u56fe\u6240\u793a\u200b\u4e32\u53e3\u200b\u7ed3\u6784\u56fe\u200b\uff1a  \u200b\u8981\u200b\u53d1\u9001\u6570\u636e\u200b\u65f6\u200b\uff0cCPU\u200b\u63a7\u5236\u200b\u5185\u5b58\u200b\u8981\u200b\u53d1\u9001\u200b\u7684\u200b\u6570\u636e\u200b\u901a\u8fc7\u200bFIFO\u200b\u4f20\u7ed9\u200bUART\u200b\u5355\u4f4d\u200b\uff0cUART\u200b\u91cc\u9762\u200b\u7684\u200b\u79fb\u4f4d\u200b\u5668\u200b\uff0c\u200b\u4f9d\u6b21\u200b\u5c06\u200b\u6570\u636e\u200b\u53d1\u9001\u200b\u51fa\u53bb\u200b\uff0c\u200b\u5728\u200b\u53d1\u9001\u200b\u5b8c\u6210\u200b\u540e\u200b\u4ea7\u751f\u200b\u4e2d\u65ad\u200b\u63d0\u9192\u200bCPU\u200b\u4f20\u8f93\u200b\u5b8c\u6210\u200b\u3002 \u200b\u63a5\u6536\u6570\u636e\u200b\u65f6\u200b\uff0c\u200b\u83b7\u53d6\u200b\u63a5\u6536\u200b\u5f15\u811a\u200b\u7684\u200b\u7535\u5e73\u200b\uff0c\u200b\u9010\u4f4d\u200b\u653e\u8fdb\u200b\u63a5\u6536\u200b\u79fb\u4f4d\u200b\u5668\u200b\uff0c\u200b\u518d\u200b\u653e\u5165\u200bFIFO\uff0c\u200b\u5199\u5165\u200b\u5185\u5b58\u200b\u3002\u200b\u5728\u200b\u63a5\u6536\u200b\u5b8c\u6210\u200b\u540e\u200b\u4ea7\u751f\u200b\u4e2d\u65ad\u200b\u63d0\u9192\u200bCPU\u200b\u4f20\u8f93\u200b\u5b8c\u6210\u200b\u3002</p>"},{"location":"09_UART/03_1/","title":"03_TTY\u200b\u4f53\u7cfb\u200b\u4e2d\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u7684\u200b\u5dee\u522b","text":""},{"location":"09_UART/03_1/#tty","title":"TTY\u200b\u4f53\u7cfb\u200b\u4e2d\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u7684\u200b\u5dee\u522b","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b</p> <ul> <li>\u200b\u89e3\u5bc6\u200bTTY</li> <li>\u200b\u5f7b\u5e95\u200b\u7406\u89e3\u200bLinux\u200b\u7684\u200b\u5404\u79cd\u200b\u7ec8\u7aef\u200b\u7c7b\u578b\u200b\u4ee5\u53ca\u200b\u6982\u5ff5\u200b</li> <li>Linux\u200b\u7ec8\u7aef\u200b\u548c\u200bLine discipline\u200b\u56fe\u89e3\u200b</li> <li>What Are Teletypes, and Why Were They Used with Computers?</li> </ul>"},{"location":"09_UART/03_1/#1","title":"1. \u200b\u50bb\u50bb\u200b\u5206\u4e0d\u6e05","text":"<p>/dev/ttyS0\u3001/dev/ttySAC0\u3001/dev/tty\u3001/dev/tty0\u3001/dev/tty1\u3001/dev/console\uff0c</p> <p>\u200b\u5b83\u4eec\u200b\u6709\u200b\u4ec0\u4e48\u200b\u5dee\u522b\u200b\uff1f</p> \u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b \u200b\u542b\u4e49\u200b /dev/ttyS0\u3001/dev/ttySAC0 \u200b\u4e32\u53e3\u200b /dev/tty1\u3001/dev/tty2\u3001/dev/tty3\u3001\u2026\u2026 \u200b\u865a\u62df\u200b\u7ec8\u7aef\u8bbe\u5907\u200b\u8282\u70b9\u200b /dev/tty0 \u200b\u524d\u53f0\u200b\u7ec8\u7aef\u200b /dev/tty \u200b\u7a0b\u5e8f\u200b\u81ea\u5df1\u200b\u7684\u200b\u7ec8\u7aef\u200b\uff0c\u200b\u53ef\u80fd\u200b\u662f\u200b\u4e32\u53e3\u200b\u3001\u200b\u4e5f\u200b\u53ef\u80fd\u200b\u662f\u200b\u865a\u62df\u200b\u7ec8\u7aef\u200b /dev/console \u200b\u63a7\u5236\u53f0\u200b\uff0c\u200b\u53c8\u200b\u5185\u6838\u200b\u7684\u200bcmdline\u200b\u53c2\u6570\u200b\u786e\u5b9a\u200b <p>TTY/Terminal/Console/UART\uff0c</p> <p>\u200b\u5b83\u4eec\u200b\u6709\u200b\u4ec0\u4e48\u200b\u5dee\u522b\u200b\uff1f</p> \u200b\u672f\u8bed\u200b \u200b\u542b\u4e49\u200b TTY \u200b\u6765\u81ea\u200bteletype\uff0c\u200b\u6700\u200b\u53e4\u8001\u200b\u7684\u200b\u8f93\u5165\u8f93\u51fa\u200b\u8bbe\u5907\u200b\uff0c\u200b\u73b0\u5728\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u5185\u6838\u200b\u7684\u200b\u4e00\u5957\u200b\u9a71\u52a8\u200b\u7cfb\u7edf\u200b Terminal \u200b\u7ec8\u7aef\u200b\uff0c\u200b\u6697\u542b\u200b\u8fdc\u7aef\u200b\u4e4b\u610f\u200b\uff0c\u200b\u4e5f\u200b\u662f\u200b\u4e00\u4e2a\u200b\u8f93\u5165\u8f93\u51fa\u200b\u8bbe\u5907\u200b\uff0c\u200b\u53ef\u80fd\u200b\u662f\u200b\u771f\u5b9e\u200b\u8bbe\u5907\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u80fd\u200b\u662f\u200b\u865a\u62df\u200b\u8bbe\u5907\u200b Console \u200b\u63a7\u5236\u53f0\u200b\uff0c\u200b\u542b\u200b\u63a7\u5236\u200b\u4e4b\u610f\u200b\uff0c\u200b\u4e5f\u200b\u662f\u200b\u4e00\u79cd\u200bTerminal\uff0c\u200b\u6743\u9650\u200b\u66f4\u5927\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u67e5\u770b\u200b\u5185\u6838\u200b\u6253\u5370\u4fe1\u606f\u200b UART \u200b\u4e32\u53e3\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5305\u542b\u200b\u5728\u200bTTY\u200b\u9a71\u52a8\u200b\u4f53\u7cfb\u200b\u4e4b\u5185"},{"location":"09_UART/03_1/#2","title":"2. \u200b\u8981\u200b\u8bb2\u200b\u5386\u53f2\u200b\u4e86","text":""},{"location":"09_UART/03_1/#21-teletype","title":"2.1 \u200b\u7535\u4f20\u673a\u200bteletype","text":"<p>teletype\uff0c\u200b\u66f4\u200b\u51c6\u786e\u200b\u5730\u200b\u8bf4\u200b\u662f\u200bteleprinter\uff0c\u200b\u662f\u200b\u4e00\u79cd\u200b\u901a\u4fe1\u200b\u8bbe\u5907\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u7528\u6765\u200b\u53d1\u9001\u200b\u3001\u200b\u63a5\u6536\u200b\u6587\u672c\u200b\u4fe1\u606f\u200b\u3002</p> <p>teletype\u200b\u662f\u200b\u4e00\u5bb6\u200b\u516c\u53f8\u200b\u7684\u200b\u540d\u5b57\u200b\uff0c\u200b\u5b83\u200b\u751f\u4ea7\u200b\u7684\u200bteleprinter\u200b\u5b9e\u5728\u200b\u592a\u200b\u6709\u540d\u200b\uff0c\u200b\u7ed3\u679c\u200b\u516c\u53f8\u200b\u540d\u200b\u53d8\u6210\u200b\u4e86\u200b\u8fd9\u200b\u7c7b\u4ea7\u54c1\u200b\u7684\u200b\u540d\u5b57\u200b\uff1ateleprinter\u200b\u90fd\u200b\u88ab\u200b\u79f0\u4e3a\u200bteletype\u200b\u4e86\u200b\u3002</p> <p></p> <p>teletype\u200b\u88ab\u200b\u7528\u6765\u200b\u4f20\u8f93\u200b\u5546\u4e1a\u200b\u7535\u62a5\u200b\uff0c\u200b\u60f3\u50cf\u200b\u4e00\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u628a\u200b\u4e24\u53f0\u200bteletype\u200b\u7684\u200b\u7ebf\u7f06\u200b\u63a5\u200b\u5728\u200b\u4e00\u8d77\u200b\uff0c\u200b\u6216\u8005\u200b\u4f7f\u7528\u200b\u65e0\u7ebf\u200b\u6280\u672f\u200b\u8fde\u63a5\u200b\u4e24\u53f0\u200bteletype</li> <li>\u200b\u8fd9\u8fb9\u200b\u6253\u5b57\u200b\uff0c\u200b\u53e6\u4e00\u8fb9\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u63a5\u6536\u200b\u5230\u200b\u4fe1\u606f\u200b\u5e76\u200b\u901a\u8fc7\u200b\u7eb8\u5f20\u200b\u6253\u5370\u200b\u51fa\u6765\u200b</li> <li>\u200b\u6ce8\u610f\u200b\uff1a\u200b\u8fd9\u4e24\u53f0\u200bteletype\u200b\u53ef\u4ee5\u200b\u79bb\u5f97\u200b\u5f88\u200b\u8fdc\u200b</li> </ul>"},{"location":"09_UART/03_1/#22","title":"2.2 \u200b\u8ba1\u7b97\u673a\u200b\u9700\u8981\u200b\u63a7\u5236","text":""},{"location":"09_UART/03_1/#221-teletype","title":"2.2.1 \u200b\u4f7f\u7528\u200bteletype","text":"<p>teletype\u200b\u7684\u200b\u7b80\u79f0\u200b\u5c31\u662f\u200bTTY\u3002</p> <p>\u200b\u6700\u200b\u53e4\u8001\u200b\u7684\u200b\u8ba1\u7b97\u673a\u200b\u652f\u6301\u200b\u7684\u200b\u662f\u200b\u6279\u5904\u7406\u200b\u6a21\u578b\u200b\uff1a</p> <ul> <li>\u200b\u600e\u4e48\u200b\u7f16\u7a0b\u200b\uff1f\u200b\u5361\u7247\u200b\u6253\u5b54\u200b\uff0c\u200b\u7136\u540e\u200b\u5582\u7ed9\u200b\u8ba1\u7b97\u673a\u200b\u3002</li> <li>\u200b\u600e\u4e48\u200b\u5f97\u5230\u200b\u8f93\u51fa\u200b\u4fe1\u606f\u200b\uff1f\u200b\u8ba1\u7b97\u673a\u200b\u6839\u636e\u200b\u7ed3\u679c\u200b\u5728\u200b\u5361\u7247\u200b\u4e0a\u200b\u6253\u5b54\u200b\uff0c\u200b\u9700\u8981\u200b\u4e13\u4eba\u200b\u7ffb\u8bd1\u200b\u8fd9\u4e9b\u200b\u5361\u7247\u200b\u3002</li> </ul> <p>\u200b\u5982\u679c\u200b\u628a\u200b\u4e24\u53f0\u200bteletype\u200b\u7684\u200b\u5176\u4e2d\u200b\u4e00\u53f0\u200b\uff0c\u200b\u66ff\u6362\u200b\u4e3a\u200b\u8ba1\u7b97\u673a\u200b\uff0c\u200b\u4e0d\u200b\u5c31\u200b\u66f4\u200b\u65b9\u4fbf\u200b\u4e86\u200b\u5417\u200b\uff1f\u200b\u53ef\u4ee5\u200b\u5373\u65f6\u200b\u8f93\u5165\u200b\u6307\u4ee4\u200b\u3001\u200b\u5373\u65f6\u200b\u770b\u5230\u200b\u7ed3\u679c\u200b\u3002</p> <p>\u200b\u4e8e\u662f\u200bteletype\u200b\u53d8\u6210\u200b\u4e86\u200b\u8ba1\u7b97\u673a\u200b\u7684\u200b\u7ec8\u7aef\u200b\u3001Terminal\uff0c\u200b\u8fdc\u7aef\u200b\u4e4b\u610f\u200b\u3002</p> <p>teletype\u200b\u548c\u200b\u8ba1\u7b97\u673a\u200b\u53ef\u4ee5\u200b\u653e\u5728\u200b\u4e00\u4e2a\u200b\u623f\u95f4\u200b\u91cc\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u653e\u5728\u200b\u5f88\u8fdc\u200b\u5f88\u200b\u8fdc\u200b\u7684\u200b\u5730\u65b9\u200b\u3002</p> <p></p> <p>teletype\u200b\u662f\u200b\u901a\u8fc7\u200b\u4e32\u53e3\u200b(UART)\u200b\u8ddf\u200b\u8ba1\u7b97\u673a\u200b\u76f8\u8fde\u200b\u7684\u200b\uff1a</p> <p></p> <p>\u200b\u90a3\u65f6\u200b\u8ba1\u7b97\u673a\u200b\u5f88\u200b\u8d35\u200b\uff0c\u200b\u53d1\u5c55\u200b\u51fa\u200b\u591a\u7528\u6237\u200b\u7cfb\u7edf\u200b\uff0c\u200b\u591a\u4e2a\u200b\u7528\u6237\u200b\u53ef\u4ee5\u200b\u5206\u200b\u65f6\u200b\u4f7f\u7528\u200b\u8ba1\u7b97\u673a\u200b\uff0c\u200b\u964d\u4f4e\u6210\u672c\u200b\uff1a</p> <p></p>"},{"location":"09_UART/03_1/#222-teletype","title":"2.2.2 teletype\u200b\u88ab\u200b\u6dd8\u6c70\u200b\u4e86","text":"<p>1960\u200b\u5e74\u4ee3\u200b\uff0cCRT\u200b\u663e\u793a\u5668\u200b+\u200b\u952e\u76d8\u200b\uff0c\u200b\u66ff\u4ee3\u200b\u4e86\u200bteletype\uff1a</p> <ul> <li>\u200b\u663e\u793a\u5668\u200b\u66ff\u4ee3\u200b\u4e86\u200b\u7eb8\u5f20\u200b</li> <li>\u200b\u901f\u5ea6\u200b\u66f4\u200b\u5feb\u200b</li> <li>\u200b\u6210\u672c\u200b\u66f4\u200b\u4f4e\u200b</li> <li>\u200b\u5b83\u200b\u4ecd\u7136\u200b\u53ea\u662f\u200b\u4e00\u4e2a\u200b\u7ec8\u7aef\u200b(terminal)\uff0c\u200b\u901a\u8fc7\u200b\u7ebf\u7f06\u200b\u8fde\u63a5\u200b\u5230\u200b\u8ba1\u7b97\u673a\u200b</li> <li>\u200b\u867d\u7136\u200b\u4e0d\u518d\u200b\u662f\u200bteletype\uff0c\u200b\u4f46\u662f\u200b\u5b83\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4ecd\u7136\u200b\u53eb\u505a\u200bTTY</li> </ul> <p></p>"},{"location":"09_UART/03_1/#223","title":"2.2.3 \u200b\u4e2a\u4eba\u7535\u8111\u200b\u548c\u200b\u865a\u62df\u200b\u7ec8\u7aef","text":"<p>\u200b\u4e0a\u200b\u56fe\u957f\u200b\u5f97\u200b\u50cf\u200b\u7535\u8111\u200b\uff0c\u200b\u4f46\u662f\u200b\u5b83\u200b\u53ea\u662f\u200b\u4e00\u4e2a\u200b\u7ec8\u7aef\u200b\uff0c\u200b\u5b83\u200b\u8981\u200b\u8fde\u63a5\u200b\u5230\u200b\u8ba1\u7b97\u673a\u200b\u624d\u80fd\u200b\u5de5\u4f5c\u200b\u3002</p> <p>\u200b\u8fd9\u624d\u200b\u662f\u200b\u7535\u8111\u200b\uff1a\u200b\u8ba1\u7b97\u200b\u5355\u5143\u200b(CPU\u3001\u200b\u786c\u76d8\u200b\u3001\u200b\u5185\u5b58\u200b\u7b49\u7b49\u200b)\u3001\u200b\u7ec8\u7aef\u200b(\u200b\u952e\u76d8\u200b\u3001\u200b\u663e\u793a\u5668\u200b)\u200b\u90fd\u200b\u9f50\u5168\u200b\u4e86\u200b\uff1a</p> <p></p> <p>\u200b\u786c\u4ef6\u200b\u4e0a\u200b\u53ea\u6709\u200b\u4e00\u5957\u200b\u952e\u76d8\u200b\u3001\u200b\u663e\u793a\u5668\u200b\u3002</p> <p>\u200b\u4f46\u662f\u200b\u5728\u200bLinux\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\uff0c\u200b\u6211\u4eec\u200b\u53ef\u4ee5\u200b\u6253\u5f00\u200b\u591a\u4e2a\u200b\u547d\u4ee4\u884c\u200b\u7a0b\u5e8f\u200b(\u200b\u4e5f\u200b\u53eb\u200bterminal\u3001shell)\uff0c\u200b\u6bcf\u4e2a\u200b\u7a0b\u5e8f\u200b\u90fd\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200b\"\u200b\u865a\u62df\u200b\u7ec8\u7aef\u200b\"\u3002</p>"},{"location":"09_UART/03_1/#3-ubuntu","title":"3. \u200b\u5728\u200bUbuntu\u200b\u4e0a\u200b\u6f14\u793a","text":"<p>\u200b\u6309\u4f4f\u200b\u952e\u76d8\u200b\uff1aCtrl+Alt+F3\u200b\u542f\u52a8\u200b\u4e00\u4e2a\u200b\u865a\u62df\u200b\u7ec8\u7aef\u200b\uff0cCtrl+Alt+F4\u200b\u518d\u542f\u52a8\u200b\u4e00\u4e2a\u200b\u865a\u62df\u200b\u7ec8\u7aef\u200b\u3002</p> <p>\u200b\u5728\u200b\u91cc\u9762\u200b\u5207\u6362\u200b\u4e3a\u200broot\u200b\u7528\u6237\u200b\uff1a</p> <pre><code>sudo passwd root // \u200b\u5982\u679c\u200bsu root\u200b\u4e0d\u200b\u6210\u529f\u200b\uff0c\u200b\u5c31\u200b\u5148\u200b\u8bbe\u7f6e\u200broot\u200b\u5bc6\u7801\u200b\nsu root\n</code></pre>"},{"location":"09_UART/03_1/#31","title":"3.1 \u200b\u5404\u7c7b\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u7684\u200b\u5dee\u522b","text":"<p>\u200b\u7531\u4e8e\u200b\u5386\u53f2\u200b\u539f\u56e0\u200b\uff0c\u200b\u4e0b\u56fe\u200b\u4e2d\u200b\u4e24\u6761\u200b\u7ea2\u7ebf\u200b\u4e4b\u5185\u200b\u7684\u200b\u4ee3\u7801\u200b\u88ab\u200b\u79f0\u4e3a\u200bTTY\u200b\u5b50\u7cfb\u7edf\u200b\u3002</p> <p>\u200b\u5b83\u200b\u65e2\u200b\u652f\u6301\u200bUART\uff0c\u200b\u4e5f\u200b\u652f\u6301\u200b\u952e\u76d8\u200b\u3001\u200b\u663e\u793a\u5668\u200b\uff0c\u200b\u8fd8\u200b\u652f\u6301\u200b\u66f4\u200b\u590d\u6742\u200b\u7684\u200b\u529f\u80fd\u200b(\u200b\u6bd4\u5982\u200b\u4f2a\u200b\u7ec8\u7aef\u200b)\u3002</p> <p></p>"},{"location":"09_UART/03_1/#32-devttynn123","title":"3.2 /dev/ttyN(N=1,2,3,...)","text":"<p>/dev/tty3\u3001/dev/tty4\uff1a\u200b\u8868\u793a\u200b\u67d0\u4e2a\u200b\u7a0b\u5e8f\u200b\u4f7f\u7528\u200b\u7684\u200b\u865a\u62df\u200b\u7ec8\u7aef\u200b</p> <pre><code>// \u200b\u5728\u200btty3\u3001tty4\u200b\u7ec8\u7aef\u200b\u6765\u56de\u200b\u5207\u6362\u200b\uff0c\u200b\u6267\u884c\u547d\u4ee4\u200b\n\necho hello &gt; /dev/tty3\necho hi    &gt; /dev/tty4\n</code></pre>"},{"location":"09_UART/03_1/#33-devtty0","title":"3.3 /dev/tty0","text":"<p>/dev/tty0\uff1a\u200b\u8868\u793a\u200b\u524d\u53f0\u200b\u7a0b\u5e8f\u200b\u7684\u200b\u865a\u62df\u200b\u7ec8\u7aef\u200b</p> <ul> <li> <p>\u200b\u4f60\u200b\u6b63\u5728\u200b\u64cd\u4f5c\u200b\u7684\u200b\u754c\u9762\u200b\uff0c\u200b\u5c31\u662f\u200b\u524d\u53f0\u200b\u7a0b\u5e8f\u200b</p> </li> <li> <p>\u200b\u5176\u4ed6\u200b\u540e\u53f0\u7a0b\u5e8f\u200b\u8bbf\u95ee\u200b/dev/tty0\u200b\u7684\u8bdd\u200b\uff0c\u200b\u5c31\u662f\u200b\u8bbf\u95ee\u200b\u524d\u53f0\u200b\u7a0b\u5e8f\u200b\u7684\u200b\u7ec8\u7aef\u200b\uff0c\u200b\u5207\u6362\u200b\u524d\u53f0\u200b\u7a0b\u5e8f\u200b\u65f6\u200b\uff0c/dev/tty0\u200b\u662f\u200b\u53d8\u5316\u200b\u7684\u200b</p> </li> </ul> <pre><code>// 1. \u200b\u5728\u200btty3\u200b\u7ec8\u7aef\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b\n// 2. \u200b\u7136\u540e\u200b\u5728\u200btty3\u3001tty4\u200b\u6765\u56de\u200b\u5207\u6362\u200b\n\nwhile [ 1 ]; do echo msg_from_tty3 &gt; /dev/tty0; sleep 5; done\n</code></pre>"},{"location":"09_UART/03_1/#34-devtty","title":"3.4  /dev/tty","text":"<p>/dev/tty\u200b\u8868\u793a\u200b\u672c\u200b\u7a0b\u5e8f\u200b\u7684\u200b\u7ec8\u7aef\u200b\uff0c\u200b\u53ef\u80fd\u200b\u662f\u200b\u865a\u62df\u200b\u7ec8\u7aef\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u80fd\u200b\u662f\u200b\u771f\u5b9e\u200b\u7684\u200b\u4e2d\u65ad\u200b\u3002</p> <p>\u200b\u7a0b\u5e8f\u200bA\u200b\u5728\u200b\u524d\u53f0\u200b\u3001\u200b\u540e\u53f0\u200b\u95f4\u200b\u5207\u6362\u200b\uff0c\u200b\u5b83\u200b\u81ea\u5df1\u200b\u7684\u200b/dev/tty\u200b\u90fd\u200b\u4e0d\u4f1a\u200b\u53d8\u200b\u3002</p> <pre><code>// 1. \u200b\u5728\u200btty3\u200b\u7ec8\u7aef\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b\n// 2. \u200b\u7136\u540e\u200b\u5728\u200btty3\u3001tty4\u200b\u6765\u56de\u200b\u5207\u6362\u200b\n\nwhile [ 1 ]; do echo msg_from_tty3 &gt; /dev/tty; sleep 5; done\n</code></pre>"},{"location":"09_UART/03_1/#35-terminalconsole","title":"3.5 Terminal\u200b\u548c\u200bConsole\u200b\u7684\u200b\u5dee\u522b","text":"<p>Terminal\u200b\u542b\u6709\u200b\u8fdc\u200b\u7aef\u7684\u200b\u610f\u601d\u200b\uff0c\u200b\u4e2d\u6587\u200b\u4e3a\u200b\uff1a\u200b\u7ec8\u7aef\u200b\u3002Console\u200b\u7ffb\u8bd1\u200b\u4e3a\u200b\u63a7\u5236\u53f0\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u7406\u89e3\u200b\u4e3a\u200b\u6743\u9650\u200b\u66f4\u5927\u200b\u3001\u200b\u80fd\u200b\u67e5\u770b\u200b\u66f4\u200b\u591a\u200b\u4fe1\u606f\u200b\u3002</p> <p>\u200b\u6bd4\u5982\u200b\u6211\u4eec\u200b\u53ef\u4ee5\u200b\u5728\u200bConsole\u200b\u4e0a\u200b\u770b\u5230\u200b\u5185\u6838\u200b\u7684\u200b\u6253\u5370\u4fe1\u606f\u200b\uff0c\u200b\u4ece\u200b\u8fd9\u4e2a\u200b\u89d2\u5ea6\u200b\u4e0a\u200b\u770b\u200b\uff1a</p> <ul> <li>Console\u200b\u662f\u200b\u67d0\u200b\u4e00\u4e2a\u200bTerminal</li> <li>Terminal\u200b\u5e76\u200b\u4e0d\u200b\u90fd\u200b\u662f\u200bConsole\u3002</li> <li>\u200b\u6211\u4eec\u200b\u53ef\u4ee5\u200b\u4ece\u200b\u591a\u4e2a\u200bTerminal\u200b\u4e2d\u200b\u9009\u62e9\u200b\u67d0\u200b\u4e00\u4e2a\u200b\u4f5c\u4e3a\u200bConsole</li> <li>\u200b\u5f88\u591a\u200b\u65f6\u5019\u200b\uff0c\u200b\u4e24\u4e2a\u200b\u6982\u5ff5\u200b\u6df7\u7528\u200b\uff0c\u200b\u5e76\u200b\u65e0\u200b\u660e\u786e\u200b\u7684\u200b\u3001\u200b\u5b98\u65b9\u200b\u7684\u200b\u5b9a\u4e49\u200b</li> </ul>"},{"location":"09_UART/03_1/#36-devconsole","title":"3.6 /dev/console","text":"<p>\u200b\u9009\u200b\u54ea\u4e2a\u200b\uff1f\u200b\u5185\u6838\u200b\u7684\u200b\u6253\u5370\u4fe1\u606f\u200b\u4ece\u200b\u54ea\u4e2a\u200b\u8bbe\u5907\u200b\u4e0a\u200b\u663e\u793a\u200b\u51fa\u6765\u200b\uff1f \u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200b\u5185\u6838\u200b\u7684\u200bcmdline\u200b\u6765\u200b\u6307\u5b9a\u200b\uff0c \u200b\u6bd4\u5982\u200b: console=ttyS0 console=tty \u200b\u6211\u200b\u4e0d\u60f3\u200b\u53bb\u200b\u5206\u8fa8\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u662f\u200b\u4e32\u53e3\u200b\u8fd8\u662f\u200b\u865a\u62df\u200b\u7ec8\u7aef\u200b\uff0c \u200b\u6709\u6ca1\u6709\u200b\u529e\u6cd5\u200b\u5f97\u5230\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\uff1f \u200b\u6709\u200b\uff01\u200b\u901a\u8fc7\u200b/dev/console\uff01 console=ttyS0\u200b\u65f6\u200b\uff1a/dev/console\u200b\u5c31\u662f\u200bttyS0 console=tty\u200b\u65f6\u200b\uff1a/dev/console\u200b\u5c31\u662f\u200b\u524d\u53f0\u200b\u7a0b\u5e8f\u200b\u7684\u200b\u865a\u62df\u200b\u7ec8\u7aef\u200b console=tty0\u200b\u65f6\u200b\uff1a/dev/console\u200b\u5c31\u662f\u200b\u524d\u53f0\u200b\u7a0b\u5e8f\u200b\u7684\u200b\u865a\u62df\u200b\u7ec8\u7aef\u200b console=ttyN\u200b\u65f6\u200b\uff1a/dev/console\u200b\u5c31\u662f\u200b/dev/ttyN console\u200b\u6709\u200b\u591a\u4e2a\u200b\u53d6\u503c\u200b\u65f6\u200b\uff0c\u200b\u4f7f\u7528\u200b\u6700\u540e\u200b\u4e00\u4e2a\u200b\u53d6\u503c\u200b\u6765\u200b\u5224\u65ad\u200b</p>"},{"location":"09_UART/04_1/","title":"04_TTY\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":""},{"location":"09_UART/04_1/#tty","title":"TTY\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b</p> <ul> <li>\u200b\u89e3\u5bc6\u200bTTY</li> <li>\u200b\u5f7b\u5e95\u200b\u7406\u89e3\u200bLinux\u200b\u7684\u200b\u5404\u79cd\u200b\u7ec8\u7aef\u200b\u7c7b\u578b\u200b\u4ee5\u53ca\u200b\u6982\u5ff5\u200b</li> <li>Linux\u200b\u7ec8\u7aef\u200b\u548c\u200bLine discipline\u200b\u56fe\u89e3\u200b</li> <li>What Are Teletypes, and Why Were They Used with Computers?</li> </ul>"},{"location":"09_UART/04_1/#1","title":"1. \u200b\u884c\u200b\u89c4\u7a0b\u200b\u7684\u200b\u5f15\u5165","text":"<p>\u200b\u4ee5\u4e0b\u200b\u6587\u5b57\u200b\u5f15\u7528\u200b\u81ea\u200b\u53c2\u8003\u8d44\u6599\u200b**\u200b\u89e3\u5bc6\u200bTTY**\uff1a</p> <p>\u200b\u5927\u591a\u6570\u200b\u7528\u6237\u200b\u90fd\u200b\u4f1a\u200b\u5728\u200b\u8f93\u5165\u200b\u65f6\u200b\u72af\u9519\u200b\uff0c\u200b\u6240\u4ee5\u200b\u9000\u683c\u200b\u952e\u4f1a\u200b\u5f88\u200b\u6709\u7528\u200b\u3002\u200b\u8fd9\u200b\u5f53\u7136\u200b\u53ef\u4ee5\u200b\u7531\u200b\u5e94\u7528\u7a0b\u5e8f\u200b\u672c\u8eab\u200b\u6765\u200b\u5b9e\u73b0\u200b\uff0c\u200b\u4f46\u662f\u200b\u6839\u636e\u200bUNIX\u200b\u8bbe\u8ba1\u200b\u201c\u200b\u54f2\u5b66\u200b\u201d\uff0c\u200b\u5e94\u7528\u7a0b\u5e8f\u200b\u5e94\u200b\u5c3d\u53ef\u80fd\u200b\u4fdd\u6301\u200b\u7b80\u5355\u200b\u3002\u200b\u4e3a\u4e86\u200b\u65b9\u4fbf\u200b\u8d77\u200b\u89c1\u200b\uff0c\u200b\u64cd\u4f5c\u7cfb\u7edf\u200b\u63d0\u4f9b\u200b\u4e86\u200b\u4e00\u4e2a\u200b\u7f16\u8f91\u200b\u7f13\u51b2\u533a\u200b\u548c\u200b\u4e00\u4e9b\u200b\u57fa\u672c\u200b\u7684\u200b\u7f16\u8f91\u200b\u547d\u4ee4\u200b\uff08\u200b\u9000\u683c\u200b\uff0c\u200b\u6e05\u9664\u200b\u5355\u4e2a\u200b\u5355\u8bcd\u200b\uff0c\u200b\u6e05\u9664\u200b\u884c\u200b\uff0c\u200b\u91cd\u65b0\u200b\u6253\u5370\u200b\uff09\uff0c\u200b\u8fd9\u4e9b\u200b\u547d\u4ee4\u200b\u5728\u200b\u884c\u200b\u89c4\u8303\u200b\uff08line discipline\uff09\u200b\u5185\u200b\u9ed8\u8ba4\u200b\u542f\u7528\u200b\u3002\u200b\u9ad8\u7ea7\u200b\u5e94\u7528\u7a0b\u5e8f\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200b\u5c06\u884c\u200b\u89c4\u8303\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b\u539f\u59cb\u200b\u6a21\u5f0f\u200b\uff08raw mode\uff09\u200b\u800c\u200b\u4e0d\u662f\u200b\u9ed8\u8ba4\u200b\u7684\u200b\u6210\u719f\u200b\u6216\u200b\u51c6\u5219\u200b\u6a21\u5f0f\u200b\uff08cooked and canonical\uff09\u200b\u6765\u200b\u7981\u7528\u200b\u8fd9\u4e9b\u200b\u529f\u80fd\u200b\u3002\u200b\u5927\u591a\u6570\u200b\u4ea4\u4e92\u200b\u7a0b\u5e8f\u200b\uff08\u200b\u7f16\u8f91\u5668\u200b\uff0c\u200b\u90ae\u4ef6\u200b\u5ba2\u6237\u7aef\u200b\uff0cshell\uff0c\u200b\u53ca\u200b\u6240\u6709\u200b\u4f9d\u8d56\u200bcurses\u200b\u6216\u200breadline\u200b\u7684\u200b\u7a0b\u5e8f\u200b\uff09\u200b\u5747\u200b\u4ee5\u200b\u539f\u59cb\u200b\u6a21\u5f0f\u200b\u8fd0\u884c\u200b\uff0c\u200b\u5e76\u200b\u81ea\u884c\u5904\u7406\u200b\u6240\u6709\u200b\u7684\u200b\u884c\u200b\u7f16\u8f91\u200b\u547d\u4ee4\u200b\u3002\u200b\u884c\u200b\u89c4\u8303\u200b\u8fd8\u200b\u5305\u542b\u200b\u5b57\u7b26\u200b\u56de\u663e\u200b\u548c\u200b\u56de\u8f66\u200b\u6362\u884c\u200b\uff08\u200b\u8bd1\u8005\u200b\u6ce8\u200b\uff1a\\r\\n \u200b\u548c\u200b \\n\uff09\u200b\u95f4\u200b\u81ea\u52a8\u200b\u8f6c\u6362\u200b\u7684\u200b\u9009\u9879\u200b\u3002\u200b\u5982\u679c\u200b\u4f60\u200b\u559c\u6b22\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u628a\u200b\u5b83\u200b\u770b\u4f5c\u200b\u662f\u200b\u4e00\u4e2a\u200b\u539f\u59cb\u200b\u7684\u200b\u5185\u6838\u200b\u7ea7\u200bsed(1)\u3002</p> <p>\u200b\u53e6\u5916\u200b\uff0c\u200b\u5185\u6838\u200b\u63d0\u4f9b\u200b\u4e86\u200b\u51e0\u79cd\u200b\u4e0d\u540c\u200b\u7684\u200b\u884c\u200b\u89c4\u8303\u200b\u3002\u200b\u4e00\u6b21\u200b\u53ea\u80fd\u200b\u5c06\u200b\u5176\u4e2d\u200b\u4e00\u4e2a\u200b\u8fde\u63a5\u200b\u5230\u200b\u7ed9\u5b9a\u200b\u7684\u200b\u4e32\u884c\u200b\u8bbe\u5907\u200b\u3002\u200b\u884c\u200b\u89c4\u8303\u200b\u7684\u200b\u9ed8\u8ba4\u200b\u89c4\u5219\u200b\u79f0\u4e3a\u200bN_TTY\uff08drivers/char/n_tty.c\uff0c\u200b\u5982\u679c\u200b\u4f60\u200b\u60f3\u200b\u7ee7\u7eed\u200b\u63a2\u7d22\u200b\u7684\u8bdd\u200b\uff09\u3002\u200b\u5176\u4ed6\u200b\u7684\u200b\u89c4\u5219\u200b\u88ab\u200b\u7528\u4e8e\u200b\u5176\u4ed6\u200b\u76ee\u7684\u200b\uff0c\u200b\u4f8b\u5982\u200b\u7ba1\u7406\u200b\u6570\u636e\u5305\u200b\u4ea4\u6362\u200b\uff08ppp\uff0cIrDA\uff0c\u200b\u4e32\u884c\u200b\u9f20\u6807\u200b\uff09\uff0c\u200b\u4f46\u200b\u8fd9\u200b\u4e0d\u200b\u5728\u200b\u672c\u6587\u200b\u7684\u200b\u8ba8\u8bba\u200b\u8303\u56f4\u200b\u4e4b\u5185\u200b\u3002</p>"},{"location":"09_UART/04_1/#2-tty","title":"2. TTY\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":""},{"location":"09_UART/05_1/","title":"05_\u200b\u5728\u200bSTM32MP157\u200b\u4e0a\u200b\u505a\u200b\u4e32\u53e3\u200b\u5b9e\u9a8c\u200b\u7684\u200b\u51c6\u5907\u200b\u5de5\u4f5c","text":""},{"location":"09_UART/05_1/#stm32mp157","title":"\u5728\u200bSTM32MP157\u200b\u4e0a\u200b\u505a\u200b\u4e32\u53e3\u200b\u5b9e\u9a8c\u200b\u7684\u200b\u51c6\u5907\u200b\u5de5\u4f5c","text":"<ul> <li>\u200b\u672c\u200b\u8282\u200b\u8bfe\u7a0b\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b   <code>shell doc_and_source_for_drivers\\STM32MP157\\source\\A7\\09_UART         00_stm32mp157_devicetree_for_uart8</code></li> </ul>"},{"location":"09_UART/05_1/#1-uart","title":"1. \u200b\u51fa\u5382\u200b\u7cfb\u7edf\u200b\u4e0d\u200b\u652f\u6301\u200b\u6269\u5c55\u200b\u677f\u4e0a\u200b\u7684\u200bUART","text":""},{"location":"09_UART/05_1/#2-app","title":"2. \u200b\u53ea\u200b\u5173\u6ce8\u200bAPP\u200b\u5f00\u53d1\u200b\u7684\u8bdd","text":"<p>\u200b\u628a\u200bGIT\u200b\u4ed3\u5e93\u200b\u4e2d\u200b\u8fd9\u4e2a\u200bdtb\u200b\u6587\u4ef6\u200b\u590d\u5236\u5230\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u53bb\u200b\u5c31\u200b\u53ef\u4ee5\u200b\uff1a</p> <pre><code>doc_and_source_for_drivers\\STM32MP157\\source\\A7\\09_UART\\00_stm32mp157_devicetree_for_uart8\\dtb\n    stm32mp157c-100ask-512d-lcd-v1.dtb\n</code></pre> <p>\u200b\u64cd\u4f5c\u65b9\u6cd5\u200b\uff1a</p> <ul> <li> <p>Ubuntu\u200b\u4e0a\u200b\uff1a\u200b\u590d\u5236\u200bdtb\u200b\u6587\u4ef6\u200b\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp stm32mp157c-100ask-512d-lcd-v1.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <ul> <li>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b193.168.1.100)</li> </ul> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n193.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> <ul> <li>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b193.168.1.137</li> </ul> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 193.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> </ul> <pre><code>[root@100ask:~]# mount  /dev/mmcblk2p2  /boot\n[root@100ask:~]# cp /mnt/stm32mp157c-100ask-512d-lcd-v1.dtb /boot\n[root@100ask:~]# sync\n</code></pre> <ul> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> <li> <p>\u200b\u5728\u200b\u4e32\u53e3\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200b\u4ee5\u4e0b\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b</p> </li> </ul> <pre><code>ls  /dev/ttySTM*\n/dev/ttySTM0\n/dev/ttySTM1\n/dev/ttySTM3\n</code></pre>"},{"location":"09_UART/05_1/#3","title":"3. \u200b\u4ece\u5934\u200b\u4fee\u6539\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6","text":""},{"location":"09_UART/05_1/#31","title":"3.1 \u200b\u786e\u5b9a\u200b\u786c\u4ef6\u8d44\u6e90","text":"<p>\u200b\u89c2\u5bdf\u200bSTM32MP157\u200b\u7684\u200b\u6269\u5c55\u200b\u677f\u200b\uff0c\u200b\u80cc\u540e\u200b\u5199\u200b\u7740\u200b: UART8_TX, UART8_RX\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\uff1a</p> <p></p> <p>\u200b\u6253\u5f00\u200bSTM32MP157\u200b\u5e95\u677f\u200b\u539f\u7406\u56fe\u200b\uff0c\u200b\u53ef\u77e5\u200bUART8_TX\u3001UART8_RX\u200b\u4f7f\u7528\u200b\u5f15\u811a\u200bPE1\u3001PE0\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\uff1a</p> <p></p>"},{"location":"09_UART/05_1/#32","title":"3.2 \u200b\u4f7f\u80fd\u200b\u8bbe\u5907\u200b\u6811\u200b\u8282\u70b9","text":"<p>\u200b\u5728\u200bSTM32MP157\u200b\u7684\u200b\u5185\u6838\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b<code>arch/arm/boot/dts/stm32mp151.dtsi</code>\u200b\u4e2d\u200b\uff0c\u200b\u5df2\u7ecf\u200b\u8bbe\u7f6e\u200b\u4e86\u200buart8\u200b\u8282\u70b9\u200b\uff1a</p> <p></p> <p>\u200b\u6211\u4eec\u200b\u9700\u8981\u200b\u4f7f\u80fd\u200b\u8fd9\u4e2a\u200b\u8282\u70b9\u200b\uff0c\u200b\u5f80\u4e0b\u200b\u770b\u200b\u3002</p>"},{"location":"09_UART/05_1/#33-pinctrl","title":"3.3 \u200b\u901a\u8fc7\u200bPinctrl\u200b\u6307\u5b9a\u200b\u5f15\u811a","text":"<p>\u200b\u5149\u4f7f\u200b\u80fd\u200bUART8\u200b\u8fd8\u200b\u4e0d\u884c\u200b\uff0c\u200b\u8fd8\u200b\u9700\u8981\u200b\u4e3a\u200b\u5b83\u200b\u9009\u62e9\u200b\u5f15\u811a\u200b\u3002</p> <p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/stm32mp15xx-100ask.dtsi</code>\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>&amp;uart8 {\n        pinctrl-names = \"default\", \"sleep\";\n        pinctrl-0 = &lt;&amp;uart8_pins_mx&gt;;\n        pinctrl-1 = &lt;&amp;uart8_sleep_pins_mx&gt;;\n        status = \"okay\";\n};\n</code></pre> <p>\u200b\u8fd9\u4e9b\u200bPinctrl\u200b\u4fe1\u606f\u200b\u5df2\u7ecf\u200b\u5728\u200b<code>arm/boot/dts/stm32mp157-100ask-pinctrl.dtsi</code>\u200b\u4e2d\u6709\u200b\u4e86\u200b\uff0c\u200b\u65e0\u9700\u200b\u6211\u4eec\u200b\u6dfb\u52a0\u200b\uff1a</p> <p></p>"},{"location":"09_UART/05_1/#34","title":"3.4 \u200b\u6307\u5b9a\u200b\u8bbe\u5907\u200b\u522b\u540d","text":"<p>UART8\u200b\u5bf9\u5e94\u200b\u7684\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u662f\u200b\u54ea\u4e2a\u200b\uff1f\u200b\u5b83\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u9700\u8981\u200b\u4ece\u200b\"\u200b\u522b\u540d\u200b\"\u200b\u91cc\u200b\u786e\u5b9a\u200b\u7f16\u53f7\u200b\u3002</p> <p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-v1.dts</code>\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>    aliases {\n        ethernet0 = &amp;ethernet0;\n        serial0 = &amp;uart4; //debug\n        serial1 = &amp;usart6; //rs485\n        serial2 = &amp;usart1; //bluetooth\n        serial3 = &amp;uart8;  // extend board uart, /dev/ttySTM3\n    };\n</code></pre>"},{"location":"09_UART/05_1/#35","title":"3.5 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u4f7f\u7528","text":"<ul> <li>\u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe\u200b</li> </ul> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre> <ul> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bSTM32MP157\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <ul> <li>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b193.168.1.100)</li> </ul> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n193.168.1.100:/home/book/nfs_rootfs /mnt\n</code></pre> <ul> <li>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b193.168.1.137</li> </ul> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 193.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> </ul> <pre><code>[root@100ask:~]# mount  /dev/mmcblk2p2  /boot\n[root@100ask:~]# cp /mnt/stm32mp157c-100ask-512d-lcd-v1.dtb /boot\n[root@100ask:~]# sync\n</code></pre> <ul> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> <li> <p>\u200b\u5728\u200b\u4e32\u53e3\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200b\u4ee5\u4e0b\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b</p> </li> </ul> <pre><code>ls  /dev/ttySTM*\n/dev/ttySTM0\n/dev/ttySTM1\n/dev/ttySTM3\n</code></pre>"},{"location":"09_UART/05_2/","title":"05 2","text":""},{"location":"09_UART/05_2/#linux","title":"Linux\u200b\u4e32\u53e3\u200b\u5e94\u7528\u200b\u7f16\u7a0b","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b</p> <ul> <li> <p>Serial Programming Guide for POSIX Operating Systems</p> </li> <li> <p>Linux\u200b\u4e32\u53e3\u200b\u7f16\u7a0b\u200b\uff1a\u200b\u6709\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b</p> </li> <li> <p>Linux\u200b\u4e32\u53e3\u200b\u2014struct termios\u200b\u7ed3\u6784\u200b\u4f53\u200b</p> </li> <li> <p>\u200b\u8fd9\u4e2a\u200b\u662f\u200b\u8f6c\u8f7d\u200b\uff0c\u200b\u6392\u7248\u200b\u66f4\u597d\u200b\u770b\u200b: https://www.cnblogs.com/sky-heaven/p/9675253.html</p> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u8bfe\u7a0b\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b</p> </li> </ul> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\source\\09_UART\n  01_app_send_recv\n  02_gps\ndoc_and_source_for_drivers\\STM32MP157\\source\\A7\\09_UART\n  01_app_send_recv\n  02_gps  \n</code></pre>"},{"location":"09_UART/05_2/#1-api","title":"1. \u200b\u4e32\u53e3\u200bAPI","text":"<p>\u200b\u5728\u200bLinux\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\uff0c\u200b\u64cd\u4f5c\u200b\u8bbe\u5907\u200b\u7684\u200b\u7edf\u4e00\u200b\u63a5\u53e3\u200b\u5c31\u662f\u200b\uff1aopen/ioctl/read/write\u3002</p> <p>\u200b\u5bf9\u4e8e\u200bUART\uff0c\u200b\u53c8\u200b\u5728\u200bioctl\u200b\u4e4b\u4e0a\u200b\u5c01\u88c5\u200b\u4e86\u200b\u5f88\u591a\u200b\u51fd\u6570\u200b\uff0c\u200b\u4e3b\u8981\u200b\u662f\u200b\u7528\u6765\u200b\u8bbe\u7f6e\u200b\u884c\u200b\u89c4\u7a0b\u200b\u3002</p> <p>\u200b\u6240\u4ee5\u200b\u5bf9\u4e8e\u200bUART\uff0c\u200b\u7f16\u7a0b\u200b\u7684\u200b\u5957\u8def\u200b\u5c31\u662f\u200b\uff1a</p> <ul> <li>open</li> <li>\u200b\u8bbe\u7f6e\u200b\u884c\u200b\u89c4\u7a0b\u200b\uff0c\u200b\u6bd4\u5982\u200b\u6ce2\u7279\u7387\u200b\u3001\u200b\u6570\u636e\u4f4d\u200b\u3001\u200b\u505c\u6b62\u200b\u4f4d\u200b\u3001\u200b\u68c0\u9a8c\u4f4d\u200b\u3001RAW\u200b\u6a21\u5f0f\u200b\u3001\u200b\u4e00\u6709\u200b\u6570\u636e\u200b\u5c31\u200b\u8fd4\u56de\u200b</li> <li>read/write</li> </ul> <p>\u200b\u600e\u4e48\u200b\u8bbe\u7f6e\u200b\u884c\u200b\u89c4\u7a0b\u200b\uff1f\u200b\u884c\u200b\u89c4\u7a0b\u200b\u7684\u200b\u53c2\u6570\u200b\u7528\u200b\u7ed3\u6784\u200b\u4f53\u200btermios\u200b\u6765\u200b\u8868\u793a\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u53c2\u8003\u200bLinux\u200b\u4e32\u53e3\u200b\u2014struct termios\u200b\u7ed3\u6784\u200b\u4f53\u200b</p> <p></p> <p>\u200b\u8fd9\u4e9b\u200b\u51fd\u6570\u200b\u5728\u200b\u540d\u79f0\u200b\u4e0a\u200b\u6709\u200b\u4e00\u4e9b\u200b\u60ef\u4f8b\u200b\uff1a</p> <ul> <li>tc\uff1aterminal contorl</li> <li>cf: control flag</li> </ul> <p>\u200b\u4e0b\u9762\u200b\u5217\u51fa\u200b\u4e00\u4e9b\u200b\u51fd\u6570\u200b\uff1a</p> \u200b\u51fd\u6570\u200b\u540d\u200b \u200b\u4f5c\u7528\u200b tcgetattr get terminal attributes\uff0c\u200b\u83b7\u5f97\u200b\u7ec8\u7aef\u200b\u7684\u200b\u5c5e\u6027\u200b tcsetattr set terminal attributes\uff0c\u200b\u4fee\u6539\u200b\u7ec8\u7aef\u200b\u53c2\u6570\u200b tcflush \u200b\u6e05\u7a7a\u200b\u7ec8\u7aef\u200b\u672a\u200b\u5b8c\u6210\u200b\u7684\u200b\u8f93\u5165\u200b/\u200b\u8f93\u51fa\u200b\u8bf7\u6c42\u200b\u53ca\u200b\u6570\u636e\u200b cfsetispeed sets the input baud rate\uff0c\u200b\u8bbe\u7f6e\u200b\u8f93\u5165\u200b\u6ce2\u7279\u7387\u200b cfsetospeed sets the output baud rate\uff0c\u200b\u8bbe\u7f6e\u200b\u8f93\u51fa\u200b\u6ce2\u7279\u7387\u200b cfsetspeed \u200b\u540c\u65f6\u200b\u8bbe\u7f6e\u200b\u8f93\u5165\u200b\u3001\u200b\u8f93\u51fa\u200b\u6ce2\u7279\u7387\u200b <p>\u200b\u51fd\u6570\u200b\u4e0d\u200b\u591a\u200b\uff0c\u200b\u4e3b\u8981\u200b\u662f\u200b\u9700\u8981\u200b\u8bbe\u7f6e\u200b\u597d\u200btermios\u200b\u4e2d\u200b\u7684\u200b\u53c2\u6570\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u53c2\u6570\u200b\u5f88\u200b\u590d\u6742\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u53c2\u8003\u200bLinux\u200b\u4e32\u53e3\u200b\u2014struct termios\u200b\u7ed3\u6784\u200b\u4f53\u200b\u3002</p>"},{"location":"09_UART/05_2/#2","title":"2. \u200b\u4e32\u53e3\u200b\u6536\u53d1\u200b\u5b9e\u9a8c","text":"<p>\u200b\u672c\u200b\u5b9e\u9a8c\u200b\u7528\u8fc7\u200b\u628a\u200b\u4e32\u53e3\u200b\u7684\u200b\u53d1\u9001\u200b\u3001\u200b\u63a5\u6536\u200b\u5f15\u811a\u200b\u77ed\u63a5\u200b\uff0c\u200b\u5b9e\u73b0\u200b\u81ea\u53d1\u200b\u81ea\u6536\u200b\uff1a\u200b\u4f7f\u7528\u200bwrite\u200b\u51fd\u6570\u200b\u53d1\u51fa\u200b\u5b57\u7b26\u200b\uff0c\u200b\u4f7f\u7528\u200bread\u200b\u51fd\u6570\u200b\u8bfb\u53d6\u200b\u5b57\u7b26\u200b\u3002</p>"},{"location":"09_UART/05_2/#21","title":"2.1 \u200b\u63a5\u7ebf","text":""},{"location":"09_UART/05_2/#211-imx6ull","title":"2.1.1 IMX6ULL","text":""},{"location":"09_UART/05_2/#212-stm32mp157","title":"2.1.2 STM32MP157","text":""},{"location":"09_UART/05_2/#22","title":"2.2 \u200b\u7f16\u7a0b","text":""},{"location":"09_UART/05_2/#23","title":"2.3 \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":""},{"location":"09_UART/05_2/#231-imx6ull","title":"2.3.1 IMX6ULL","text":"<p>\u200b\u5148\u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe\u200b\uff1a</p> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre> <p>\u200b\u7f16\u8bd1\u200b\u3001\u200b\u6267\u884c\u7a0b\u5e8f\u200b:</p> <pre><code>1. Ubuntu\u200b\u4e0a\u200b\narm-buildroot-linux-gnueabihf-gcc -o serial_send_recv serial_send_recv.c\n\n2. \u200b\u677f\u5b50\u200b\u4e0a\u200b\n/mnt/serial_send_recv  /dev/ttymxc5\n</code></pre>"},{"location":"09_UART/05_2/#232-stm32mp157","title":"2.3.2 STM32MP157","text":"<p>\u200b\u5148\u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe\u200b\uff1a</p> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre> <p>\u200b\u7f16\u8bd1\u200b\u3001\u200b\u6267\u884c\u7a0b\u5e8f\u200b:</p> <pre><code>1. Ubuntu\u200b\u4e0a\u200b\narm-buildroot-linux-gnueabihf-gcc -o serial_send_recv serial_send_recv.c\n\n2. \u200b\u677f\u5b50\u200b\u4e0a\u200b\n/mnt/serial_send_recv  /dev/ttySTM3\n</code></pre>"},{"location":"09_UART/05_2/#3-gps","title":"3. GPS\u200b\u6a21\u5757\u200b\u5b9e\u9a8c","text":""},{"location":"09_UART/05_2/#31-gps","title":"3.1 GPS\u200b\u7b80\u4ecb","text":"<p>\u200b\u5168\u7403\u5b9a\u4f4d\u7cfb\u7edf\u200b(Global Positioning System\uff0cGPS)\u200b\u662f\u200b\u4e00\u79cd\u200b\u4ee5\u200b\u7a7a\u4e2d\u200b\u536b\u661f\u200b\u4e3a\u200b\u57fa\u7840\u200b\u7684\u200b\u9ad8\u7cbe\u5ea6\u200b\u65e0\u7ebf\u7535\u200b\u5bfc\u822a\u200b\u7684\u200b\u5b9a\u4f4d\u7cfb\u7edf\u200b\uff0c\u200b\u5b83\u200b\u5728\u200b\u5168\u7403\u200b\u4efb\u4f55\u200b\u5730\u65b9\u200b\u4ee5\u53ca\u200b\u8fd1\u5730\u200b\u7a7a\u95f4\u200b\u90fd\u200b\u80fd\u591f\u200b\u63d0\u4f9b\u200b\u51c6\u786e\u200b\u7684\u200b\u5730\u7406\u4f4d\u7f6e\u200b\u3001\u200b\u8f66\u884c\u200b\u901f\u5ea6\u200b\u53ca\u200b\u7cbe\u786e\u200b\u7684\u200b\u65f6\u95f4\u200b\u4fe1\u606f\u200b\u3002GPS\u200b\u4e3b\u8981\u200b\u7531\u4e09\u5927\u200b\u7ec4\u6210\u90e8\u5206\u200b\uff1a\u200b\u7a7a\u95f4\u200b\u90e8\u5206\u200b\u3001\u200b\u5730\u9762\u200b\u76d1\u63a7\u200b\u90e8\u5206\u200b\u548c\u200b\u7528\u6237\u200b\u8bbe\u5907\u200b\u90e8\u5206\u200b\u3002GPS\u200b\u7cfb\u7edf\u200b\u5177\u6709\u200b\u9ad8\u7cbe\u5ea6\u200b\u3001\u200b\u5168\u5929\u5019\u200b\u3001\u200b\u7528\u200b\u5e7f\u6cdb\u200b\u7b49\u200b\u7279\u70b9\u200b\u3002</p> <p>\u200b\u592a\u7a7a\u200b\u536b\u661f\u200b\u90e8\u5206\u200b\u7531\u200b\u591a\u200b\u9897\u536b\u661f\u200b\u7ec4\u6210\u200b\uff0c\u200b\u5206\u6210\u200b\u591a\u4e2a\u200b\u8f68\u9053\u200b\uff0c\u200b\u7ed5\u884c\u200b\u5730\u7403\u200b\u4e00\u5468\u200b\u7ea6\u200b12\u200b\u5c0f\u65f6\u200b\u3002\u200b\u6bcf\u4e2a\u200b\u536b\u661f\u200b\u5747\u200b\u6301\u7eed\u200b\u53d1\u5c04\u200b\u8f7d\u6709\u200b\u536b\u661f\u200b\u8f68\u9053\u200b\u6570\u636e\u200b\u53ca\u200b\u65f6\u95f4\u200b\u7684\u200b\u65e0\u7ebf\u7535\u6ce2\u200b\uff0c\u200b\u63d0\u4f9b\u200b\u5730\u7403\u200b\u4e0a\u200b\u7684\u200b\u5404\u79cd\u200b\u63a5\u6536\u673a\u200b\u6765\u200b\u5e94\u7528\u200b\u3002</p> <p>\u200b\u5730\u9762\u200b\u7ba1\u5236\u200b\u90e8\u5206\u200b\uff0c\u200b\u8fd9\u662f\u200b\u4e3a\u4e86\u200b\u8ffd\u8e2a\u200b\u53ca\u200b\u63a7\u5236\u200b\u592a\u7a7a\u200b\u536b\u661f\u200b\u8fd0\u884c\u200b\u6240\u200b\u8bbe\u7f6e\u200b\u7684\u200b\u5730\u9762\u200b\u7ba1\u5236\u200b\u7ad9\u200b\uff0c\u200b\u4e3b\u8981\u200b\u5de5\u4f5c\u200b\u4e3a\u200b\u8d1f\u8d23\u200b\u4fee\u6b63\u200b\u4e0e\u200b\u7ef4\u62a4\u200b\u6bcf\u4e2a\u200b\u536b\u661f\u200b\u80fd\u591f\u200b\u6b63\u5e38\u200b\u8fd0\u8f6c\u200b\u7684\u200b\u5404\u9879\u200b\u53c2\u6570\u200b\u6570\u636e\u200b\uff0c\u200b\u4ee5\u200b\u786e\u4fdd\u200b\u6bcf\u4e2a\u200b\u536b\u661f\u200b\u90fd\u200b\u80fd\u591f\u200b\u63d0\u4f9b\u200b\u6b63\u786e\u200b\u7684\u200b\u8baf\u606f\u200b\u7ed9\u200b\u4f7f\u7528\u8005\u200b\u63a5\u6536\u673a\u200b\u6765\u200b\u63a5\u6536\u200b</p> <p>\u200b\u4f7f\u7528\u8005\u200b\u63a5\u6536\u673a\u200b\uff08\u200b\u5373\u200b\u7528\u6237\u200b\u8bbe\u5907\u200b\uff09\uff0c\u200b\u8ffd\u8e2a\u200b\u6240\u6709\u200b\u7684\u200bGPS\u200b\u536b\u661f\u200b\uff0c\u200b\u5e76\u200b\u5b9e\u65f6\u200b\u7684\u200b\u8ba1\u7b97\u200b\u51fa\u200b\u63a5\u6536\u673a\u200b\u6240\u5728\u4f4d\u7f6e\u200b\u7684\u200b\u5750\u6807\u200b\u3001\u200b\u79fb\u52a8\u200b\u901f\u5ea6\u200b\u53ca\u200b\u65f6\u95f4\u200b\u3002\u200b\u6211\u4eec\u200b\u65e5\u5e38\u200b\u63a5\u89e6\u200b\u5230\u200b\u7684\u200b\u662f\u200b\u7528\u6237\u200b\u8bbe\u5907\u200b\u90e8\u5206\u200b\uff0c\u200b\u8fd9\u91cc\u200b\u4f7f\u7528\u200b\u5230\u200b\u7684\u200bGPS\u200b\u6a21\u5757\u200b\u5373\u200b\u4e3a\u200b\u7528\u6237\u200b\u8bbe\u5907\u200b\u63a5\u6536\u673a\u200b\u90e8\u5206\u200b\u3002</p>"},{"location":"09_UART/05_2/#32-gps","title":"3.2 GPS\u200b\u6a21\u5757\u200b\u786c\u4ef6","text":"<p>GPS\u200b\u6a21\u5757\u200b\u4e0e\u200b\u5916\u90e8\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u901a\u8baf\u200b\u63a5\u53e3\u200b\u6709\u200b\u591a\u79cd\u200b\u65b9\u5f0f\u200b\uff0c\u200b\u8fd9\u91cc\u200b\u6211\u4eec\u200b\u4f7f\u7528\u200b\u4e32\u53e3\u200b\u8fdb\u884c\u200b\u901a\u8baf\u200b\uff0c\u200b\u6ce2\u7279\u7387\u200b\u4e3a\u200b9600bps,1bit\u200b\u505c\u6b62\u200b\u4f4d\u200b\uff0c\u200b\u65e0\u200b\u6821\u9a8c\u4f4d\u200b\uff0c\u200b\u65e0\u6d41\u63a7\u200b\uff0c\u200b\u9ed8\u8ba4\u200b\u6bcf\u79d2\u200b\u8f93\u51fa\u200b\u4e00\u6b21\u200b\u6807\u51c6\u200b\u683c\u5f0f\u200b\u6570\u636e\u200b\u3002</p> <p>GPS\u200b\u6a21\u5757\u200b\u5916\u89c2\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b\uff0c\u200b\u901a\u8fc7\u200b\u6392\u7ebf\u200b\u4e0e\u200b\u63a7\u5236\u5668\u200b\u8fdb\u884c\u200b\u4f9b\u7535\u200b\u548c\u200b\u901a\u8baf\u200b\u3002\u200b\u8be5\u200b\u6a21\u5757\u200b\u4e3a\u200b\u96c6\u6210\u200b\u6a21\u5757\u200b\uff0c\u200b\u6ca1\u6709\u200b\u76f8\u5173\u200b\u539f\u7406\u56fe\u200b\u3002</p> <p></p>"},{"location":"09_UART/05_2/#33-gps","title":"3.3 GPS\u200b\u6a21\u5757\u200b\u6570\u636e\u683c\u5f0f","text":"<p>GPS\u200b\u4f7f\u7528\u200b\u591a\u79cd\u200b\u6807\u51c6\u200b\u6570\u636e\u683c\u5f0f\u200b\uff0c\u200b\u76ee\u524d\u200b\u6700\u200b\u901a\u7528\u200b\u7684\u200bGNSS\u200b\u683c\u5f0f\u200b\u662f\u200bNMEA0183\u200b\u683c\u5f0f\u200b\u3002NMEA0183\u200b\u662f\u200b\u6700\u7ec8\u200b\u5b9a\u4f4d\u200b\u683c\u5f0f\u200b\uff0c\u200b\u5373\u5c06\u200b\u4e8c\u8fdb\u5236\u200b\u5b9a\u4f4d\u200b\u683c\u5f0f\u200b\u8f6c\u4e3a\u200b\u7edf\u4e00\u6807\u51c6\u200b\u5b9a\u4f4d\u200b\u683c\u5f0f\u200b\uff0c\u200b\u4e0e\u200b\u536b\u661f\u200b\u7c7b\u578b\u200b\u65e0\u5173\u200b\u3002\u200b\u8fd9\u662f\u200b\u4e00\u5957\u200b\u5b9a\u4e49\u200b\u63a5\u6536\u673a\u200b\u8f93\u51fa\u200b\u7684\u200b\u6807\u51c6\u200b\u4fe1\u606f\u200b\uff0c\u200b\u6709\u200b\u51e0\u79cd\u200b\u4e0d\u540c\u200b\u7684\u200b\u683c\u5f0f\u200b\uff0c\u200b\u6bcf\u79cd\u200b\u90fd\u200b\u662f\u200b\u72ec\u7acb\u200b\u76f8\u5173\u200b\u7684\u200bASCII\u200b\u683c\u5f0f\u200b\uff0c\u200b\u9017\u70b9\u200b\u9694\u5f00\u200b\u6570\u636e\u6d41\u200b\uff0c\u200b\u6570\u636e\u6d41\u200b\u957f\u5ea6\u200b\u4ece\u200b30-100\u200b\u5b57\u7b26\u200b\u4e0d\u200b\u7b49\u200b\uff0c\u200b\u901a\u5e38\u200b\u4ee5\u200b\u6bcf\u79d2\u200b\u95f4\u9694\u200b\u6301\u7eed\u200b\u8f93\u51fa\u200b\u3002</p> <p>NVMEA0183\u200b\u683c\u5f0f\u200b\u4e3b\u8981\u200b\u9488\u5bf9\u200b\u6c11\u7528\u200b\u5b9a\u4f4d\u5bfc\u822a\u200b\uff0c\u200b\u4e0e\u200b\u4e13\u4e1a\u200bRTCM2.3/3.0\u200b\u548c\u200bCMR+\u200b\u7684\u200bGNSS\u200b\u6570\u636e\u683c\u5f0f\u200b\u4e0d\u540c\u200b\u3002\u200b\u901a\u8fc7\u200bNMEA0183\u200b\u683c\u5f0f\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5b9e\u73b0\u200bGNSS\u200b\u63a5\u6536\u673a\u200b\u4e0e\u200bPC\u200b\u6216\u200bPDA\u200b\u4e4b\u95f4\u200b\u7684\u200b\u6570\u636e\u4ea4\u6362\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200bUSB\u200b\u548c\u200bCOM\u200b\u53e3\u200b\u7b49\u200b\u901a\u7528\u200b\u6570\u636e\u200b\u63a5\u53e3\u200b\u8fdb\u884c\u200b\u6570\u636e\u4f20\u8f93\u200b\uff0c\u200b\u5176\u200b\u517c\u5bb9\u6027\u200b\u9ad8\u200b\uff0c\u200b\u6570\u636e\u4f20\u8f93\u200b\u7a33\u5b9a\u200b\u3002\u200b\u8fd9\u91cc\u200b\u6211\u4eec\u200b\u4f7f\u7528\u200b\u4e32\u53e3\u200b\u8fdb\u884c\u200b\u662f\u200b\u901a\u8baf\u200b\uff0c\u200b\u901a\u4fe1\u200b\u6846\u56fe\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b\u3002</p> <p></p> <p>\u200b\u6211\u4eec\u200b\u4f7f\u7528\u200b\u4e32\u53e3\u200b\u63a5\u6536\u6570\u636e\u200b\uff0c\u200b\u6536\u5230\u200b\u7684\u200b\u6570\u636e\u200b\u5305\u542b\u200b\uff1a\\(GPGGA\uff08GPS\u200b\u5b9a\u4f4d\u200b\u6570\u636e\u200b\uff09\u3001\\)GPGLL\uff08\u200b\u5730\u7406\u200b\u5b9a\u4f4d\u200b\u4fe1\u606f\u200b\uff09\u3001\\(GPGSA\uff08\u200b\u5f53\u524d\u200b\u536b\u661f\u200b\u4fe1\u606f\u200b\uff09\u3001\\)GPGSV\uff08\u200b\u53ef\u89c1\u200b\u536b\u661f\u200b\u72b6\u6001\u200b\u4fe1\u606f\u200b\uff09\u3001\\(GPRMC\uff08\u200b\u63a8\u8350\u200b\u6700\u5c0f\u200b\u5b9a\u4f4d\u200b\u4fe1\u606f\u200b\uff09\u3001\\)GPVTG\uff08\u200b\u5730\u9762\u200b\u901f\u5ea6\u200b\u4fe1\u606f\u200b\uff09\u3002</p> <p>\u200b\u8fd9\u91cc\u200b\u6211\u4eec\u200b\u53ea\u200b\u5206\u6790\u200b$GPGGA (Global Positioning System Fix Data)\u200b\u5373\u53ef\u200b\uff0c\u200b\u5b83\u200b\u5305\u542b\u200b\u4e86\u200bGPS\u200b\u5b9a\u4f4d\u200b\u7ecf\u7eac\u5ea6\u200b\u3001\u200b\u8d28\u91cf\u200b\u56e0\u5b50\u200b\u3001HDOP\u3001\u200b\u9ad8\u7a0b\u200b\u3001\u200b\u53c2\u8003\u200b\u7ad9\u200b\u53f7\u200b\u7b49\u200b\u5b57\u200b\u6bb5\u200b\u3002\u200b\u5176\u200b\u6807\u51c6\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> <p>$GPGGA\uff0c&lt;1&gt;\uff0c&lt;2&gt;\uff0c&lt;3&gt;\uff0c&lt;4&gt;\uff0c&lt;5&gt;\uff0c&lt;6&gt;\uff0c&lt;7&gt;\uff0c&lt;8&gt;\uff0c&lt;9&gt;\uff0cM\uff0c&lt;10&gt;\uff0cM\uff0c&lt;11&gt;\uff0c&lt;12&gt;*hh </p> <p>$XXGGA\u200b\u8bed\u53e5\u200b\u5404\u5b57\u200b\u6bb5\u200b\u7684\u200b\u542b\u4e49\u200b\u548c\u200b\u53d6\u503c\u200b\u8303\u56f4\u200b\u5404\u5b57\u200b\u6bb5\u200b\u7684\u200b\u542b\u4e49\u200b\u548c\u200b\u53d6\u503c\u200b\u8303\u56f4\u200b\u89c1\u200b\u4e0b\u8868\u200b\u6240\u793a\u200b\uff0cXX\u200b\u53d6\u503c\u200b\u6709\u200b\uff1a</p> <ul> <li>GPGGA\uff1a\u200b\u5355\u200bGPS</li> <li>BDGGA\uff1a\u200b\u5355\u200b\u5317\u6597\u200b</li> <li>GLGGA\uff1a\u200b\u5355\u200bGLONASS </li> <li>GNGGA\uff1a\u200b\u591a\u661f\u200b\u8054\u5408\u200b\u5b9a\u4f4d\u200b </li> </ul> \u200b\u5b57\u200b\u6bb5\u200b \u200b\u542b\u4e49\u200b \u200b\u53d6\u503c\u200b\u8303\u56f4\u200b &lt;1&gt; UTC\u200b\u65f6\u95f4\u200bhhmmss.ss 000000.00~235959.99 &lt;2&gt; \u200b\u7eac\u5ea6\u200b\uff0c\u200b\u683c\u5f0f\u200b\uff1addmm.mmmm 000.00000~8959.9999 &lt;3&gt; \u200b\u5357\u200b\u5317\u534a\u7403\u200b N\u200b\u5317\u7eac\u200b  S\u200b\u5357\u7eac\u200b &lt;4&gt; \u200b\u7ecf\u5ea6\u200b\u683c\u5f0f\u200bdddmm.mmmm 00000.0000~17959.9999 &lt;5&gt; \u200b\u4e1c\u897f\u200b\u534a\u7403\u200b E\u200b\u8868\u793a\u200b\u4e1c\u7ecf\u200b  W\u200b\u8868\u793a\u200b\u897f\u7ecf\u200b &lt;6&gt; GPS\u200b\u72b6\u6001\u200b 0=\u200b\u672a\u200b\u5b9a\u4f4d\u200b  1=GPS\u200b\u5355\u70b9\u200b\u5b9a\u4f4d\u200b\u56fa\u5b9a\u200b\u89e3\u200b  2=\u200b\u5dee\u5206\u200b\u5b9a\u4f4d\u200b  3=PPS\u200b\u89e3\u200b  4=RTK\u200b\u56fa\u5b9a\u200b\u89e3\u200b  5=RTK\u200b\u6d6e\u70b9\u200b\u89e3\u200b  6=\u200b\u4f30\u8ba1\u503c\u200b  7=\u200b\u624b\u5de5\u200b\u8f93\u5165\u200b\u6a21\u5f0f\u200b  8=\u200b\u6a21\u62df\u200b\u6a21\u5f0f\u200b &lt;7&gt; \u200b\u5e94\u7528\u200b\u89e3\u7b97\u200b\u4f4d\u7f6e\u200b\u7684\u200b\u536b\u661f\u200b\u6570\u200b 00~12 &lt;8&gt; HDOP  \u200b\u6c34\u5e73\u200b\u56fe\u5f62\u200b\u5f3a\u5ea6\u200b\u56e0\u5b50\u200b 0.500~99.000\uff08\u200b\u5927\u4e8e\u200b6\u200b\u4e0d\u53ef\u200b\u7528\u200b) &lt;9&gt; \u200b\u6d77\u62d4\u9ad8\u5ea6\u200b -9999.9~99999.9 \u200b\u5730\u7403\u200b\u692d\u7403\u9762\u200b\u76f8\u5bf9\u200b\u5927\u5730\u200b\u6c34\u51c6\u9762\u200b\u7684\u200b\u9ad8\u5ea6\u200b  \uff08\u200b\u9ad8\u7a0b\u200b\u5f02\u5e38\u200b\uff09 -9999.9~99999.9 &lt;11&gt; \u200b\u5dee\u5206\u200b\u65f6\u95f4\u200b \u200b\u4ece\u200b\u6700\u8fd1\u200b\u4e00\u6b21\u200b\u63a5\u6536\u200b\u5230\u200b\u5dee\u5206\u200b\u4fe1\u53f7\u200b\u5f00\u59cb\u200b\u7684\u200b\u79d2\u6570\u200b\uff0c\u200b\u5982\u679c\u200b\u4e0d\u662f\u200b\u5dee\u5206\u200b\u5b9a\u4f4d\u200b\u5c06\u200b\u4e3a\u200b\u7a7a\u200b &lt;12&gt; \u200b\u53c2\u8003\u200b\u7ad9\u200b\u53f7\u200b 0000~1023\uff1b\u200b\u4e0d\u200b\u4f7f\u7528\u200bDGPS\u200b\u65f6\u4e3a\u200b\u7a7a\u200b <p>\u200b\u4f8b\u5b50\u200b\uff1a$GPGGA\uff0c074529.82\uff0c2429.6717\uff0cN\uff0c11804.6973\uff0cE\uff0c1\uff0c8\uff0c1.098\uff0c42.110\uff0c\uff0c\uff0cM\uff0c\uff0c*76\u3002</p>"},{"location":"09_UART/05_2/#34","title":"3.4 \u200b\u7f16\u7a0b","text":""},{"location":"09_UART/05_2/#35","title":"3.5 \u200b\u63a5\u7ebf","text":""},{"location":"09_UART/05_2/#351-imx6ull","title":"3.5.1 IMX6ULL","text":""},{"location":"09_UART/05_2/#352-stm32mp157","title":"3.5.2 STM32MP157","text":""},{"location":"09_UART/05_2/#36","title":"3.6 \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":""},{"location":"09_UART/05_2/#361-imx6ull","title":"3.6.1 IMX6ULL","text":"<p>\u200b\u5148\u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe\u200b\uff1a</p> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre> <p>\u200b\u7f16\u8bd1\u200b\u3001\u200b\u6267\u884c\u7a0b\u5e8f\u200b:</p> <pre><code>1. Ubuntu\u200b\u4e0a\u200b\narm-buildroot-linux-gnueabihf-gcc -o gps_read gps_read.c\n\n2. \u200b\u677f\u5b50\u200b\u4e0a\u200b\n/mnt/gps_read  /dev/ttymxc5\n</code></pre>"},{"location":"09_UART/05_2/#362-stm32mp157","title":"3.6.2 STM32MP157","text":"<p>\u200b\u5148\u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe\u200b\uff1a</p> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre> <p>\u200b\u7f16\u8bd1\u200b\u3001\u200b\u6267\u884c\u7a0b\u5e8f\u200b\uff1a</p> <pre><code>1. Ubuntu\u200b\u4e0a\u200b\narm-buildroot-linux-gnueabihf-gcc -o gps_read gps_read.c\n\n2. \u200b\u677f\u5b50\u200b\u4e0a\u200b\n/mnt/gps_read  /dev/ttySTM3\n</code></pre>"},{"location":"09_UART/07_1/","title":"07_\u200b\u5b57\u7b26\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u7684\u200b\u53e6\u200b\u4e00\u79cd\u200b\u6ce8\u518c\u200b\u65b9\u6cd5","text":""},{"location":"09_UART/07_1/#_1","title":"\u5b57\u7b26\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u7684\u200b\u53e6\u200b\u4e00\u79cd\u200b\u6ce8\u518c\u200b\u65b9\u6cd5","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b</p> <ul> <li> <p>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b\uff1a<code>drivers\\char\\pc8736x_gpio.c</code></p> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u8bfe\u7a0b\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b</p> </li> </ul> <pre><code>\u200b\u9a71\u52a8\u200b\u5927\u5168\u200b:\ndoc_and_source_for_drivers\\IMX6ULL\\source\\09_UART\\\n  03_char_dev_driver\\\n      01b_hello_drv\ndoc_and_source_for_drivers\\STM32MP157\\source\\A7\\09_UART\\\n  03_char_dev_driver\\\n      01b_hello_drv\n\n\u200b\u5feb\u901f\u200b\u5165\u95e8\u200b:\n01_all_series_quickstart\\05_\u200b\u5d4c\u5165\u5f0f\u200bLinux\u200b\u9a71\u52a8\u200b\u5f00\u53d1\u200b\u57fa\u7840\u77e5\u8bc6\u200b\\source\\\n  01b_hello_drv\n</code></pre>"},{"location":"09_UART/07_1/#1","title":"1. \u200b\u5b57\u7b26\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":"<p>\u200b\u7f16\u5199\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u7684\u200b\u5957\u8def\u200b\uff1a * \u200b\u786e\u5b9a\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u53f7\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u8ba9\u200b\u5185\u6838\u200b\u5206\u914d\u200b * \u200b\u5b9a\u4e49\u200b\u81ea\u5df1\u200b\u7684\u200bfile_operations\u200b\u7ed3\u6784\u200b\u4f53\u200b * \u200b\u5b9e\u73b0\u200b\u5bf9\u5e94\u200b\u7684\u200bdrv_open/drv_read/drv_write\u200b\u7b49\u200b\u51fd\u6570\u200b\uff0c\u200b\u586b\u5165\u200bfile_operations\u200b\u7ed3\u6784\u200b\u4f53\u200b * \u200b\u628a\u200bfile_operations\u200b\u7ed3\u6784\u200b\u4f53\u200b\u544a\u8bc9\u200b\u5185\u6838\u200b\uff1aregister_chrdev * \u200b\u8c01\u200b\u6765\u200b\u6ce8\u518c\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u554a\u200b\uff1f\u200b\u5f97\u200b\u6709\u200b\u4e00\u4e2a\u200b\u5165\u53e3\u200b\u51fd\u6570\u200b\uff1a\u200b\u5b89\u88c5\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u65f6\u200b\uff0c\u200b\u5c31\u200b\u4f1a\u200b\u53bb\u200b\u8c03\u7528\u200b\u8fd9\u4e2a\u200b\u5165\u53e3\u200b\u51fd\u6570\u200b * \u200b\u6709\u200b\u5165\u53e3\u200b\u51fd\u6570\u200b\u5c31\u200b\u5e94\u8be5\u200b\u6709\u200b\u51fa\u53e3\u200b\u51fd\u6570\u200b\uff1a\u200b\u5378\u8f7d\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u65f6\u200b\uff0c\u200b\u51fa\u53e3\u200b\u51fd\u6570\u8c03\u7528\u200bunregister_chrdev * \u200b\u5176\u4ed6\u200b\u5b8c\u5584\u200b\uff1a\u200b\u63d0\u4f9b\u200b\u8bbe\u5907\u200b\u4fe1\u606f\u200b\uff0c\u200b\u81ea\u52a8\u200b\u521b\u5efa\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\uff1aclass_create, device_create</p>"},{"location":"09_UART/07_1/#2","title":"2. \u200b\u65b0\u200b\u7684\u200b\u6ce8\u518c\u200b\u65b9\u6cd5","text":"<p>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b\uff1a<code>drivers\\char\\pc8736x_gpio.c</code></p> <ul> <li>\u200b\u6ce8\u518c\u200b\u5b57\u7b26\u200b\u8bbe\u5907\u200b\u533a\u57df\u200b</li> <li>\u200b\u6709\u4e3b\u200b\u8bbe\u5907\u200b\u53f7\u200b\uff1aregister_chrdev_region</li> <li>\u200b\u65e0\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u53f7\u200b\uff1aalloc_chrdev_region</li> <li>\u200b\u5206\u914d\u200b/\u200b\u8bbe\u7f6e\u200b/\u200b\u6ce8\u518c\u200bcdev</li> <li>cdev_alloc</li> <li>cdev_init</li> <li>cdev_add</li> </ul>"},{"location":"09_UART/07_1/#3","title":"3. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":""},{"location":"09_UART/07_1/#31-imx6ull","title":"3.1 IMX6ULL","text":"<p>\u200b\u5148\u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe\u200b\uff1a</p> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre> <p>\u200b\u7f16\u8bd1\u200b\u3001\u200b\u6267\u884c\u7a0b\u5e8f\u200b:</p> <pre><code>Ubuntu:\ncd 01_hello_drv\\\nmake\n\n\u200b\u5f00\u53d1\u677f\u200b:\ninsmod hello_drv.ko\n./hello_drv_test  -w abcd\n./hello_drv_test  -r\n</code></pre>"},{"location":"09_UART/07_1/#32-stm32mp157","title":"3.2 STM32MP157","text":"<p>\u200b\u5148\u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe\u200b\uff1a</p> <pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre> <p>\u200b\u7f16\u8bd1\u200b\u3001\u200b\u6267\u884c\u7a0b\u5e8f\u200b:</p> <pre><code>Ubuntu:\ncd 01_hello_drv\\\nmake\n\n\u200b\u5f00\u53d1\u677f\u200b:\ninsmod hello_drv.ko\n./hello_drv_test  -w abcd\n./hello_drv_test  -r\n</code></pre>"},{"location":"09_UART/08_1/","title":"08_UART\u200b\u9a71\u52a8\u200b\u60c5\u666f\u200b\u5206\u6790\u200b_\u200b\u6ce8\u518c","text":""},{"location":"09_UART/08_1/#uart_","title":"UART\u200b\u9a71\u52a8\u200b\u60c5\u666f\u200b\u5206\u6790\u200b_\u200b\u6ce8\u518c","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b</p> <ul> <li>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b\uff1a</li> </ul> <pre><code>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\uff1a\ndrivers/tty/serial/imx.c\ndrivers/tty/serial/stm32-usart.c\n\n\u200b\u4e32\u53e3\u200b\u6838\u5fc3\u5c42\u200b\uff1a\ndrivers/tty/serial/serial_core.c\n\nTTY\u200b\u5c42\u200b:\ndrivers/tty/tty_io.c\n</code></pre>"},{"location":"09_UART/08_1/#1","title":"1. \u200b\u60c5\u666f\u200b\u5206\u6790\u200b\u5927\u7eb2","text":"<ul> <li>\u200b\u6ce8\u518c\u200b\u8fc7\u7a0b\u200b\u5206\u6790\u200b</li> <li>open\u200b\u8fc7\u7a0b\u200b\u5206\u6790\u200b</li> <li>read\u200b\u8fc7\u7a0b\u200b\u5206\u6790\u200b</li> <li>write\u200b\u8fc7\u7a0b\u200b\u5206\u6790\u200b</li> </ul>"},{"location":"09_UART/08_1/#2","title":"2. \u200b\u6e90\u7801\u200b\u6846\u67b6\u200b\u56de\u987e","text":""},{"location":"09_UART/08_1/#3","title":"3. \u200b\u6ce8\u518c\u200b\u8fc7\u7a0b\u200b\u5206\u6790","text":""},{"location":"09_UART/09_1/","title":"09_UART\u200b\u9a71\u52a8\u200b\u60c5\u666f\u200b\u5206\u6790\u200b_open","text":""},{"location":"09_UART/09_1/#uart_open","title":"UART\u200b\u9a71\u52a8\u200b\u60c5\u666f\u200b\u5206\u6790\u200b_open","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b</p> <ul> <li>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b\uff1a</li> </ul> <pre><code>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\uff1a\ndrivers/tty/serial/imx.c\ndrivers/tty/serial/stm32-usart.c\n\n\u200b\u4e32\u53e3\u200b\u6838\u5fc3\u5c42\u200b\uff1a\ndrivers/tty/serial/serial_core.c\n\nTTY\u200b\u5c42\u200b:\ndrivers/tty/tty_io.c\n</code></pre>"},{"location":"09_UART/09_1/#1","title":"1. \u200b\u60c5\u666f\u200b\u5206\u6790\u200b\u5927\u7eb2","text":"<ul> <li>\u200b\u6ce8\u518c\u200b\u8fc7\u7a0b\u200b\u5206\u6790\u200b</li> <li>open\u200b\u8fc7\u7a0b\u200b\u5206\u6790\u200b</li> <li>read\u200b\u8fc7\u7a0b\u200b\u5206\u6790\u200b</li> <li>write\u200b\u8fc7\u7a0b\u200b\u5206\u6790\u200b</li> </ul>"},{"location":"09_UART/09_1/#2","title":"2. \u200b\u6e90\u7801\u200b\u6846\u67b6\u200b\u56de\u987e","text":""},{"location":"09_UART/09_1/#3","title":"3. \u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u662f\u200b\u54ea\u4e2a","text":"<ul> <li> <p>\u200b\u4e3a\u4ec0\u4e48\u200b\u662f\u200b/dev/ttymxc\u3001/dev/ttySTM\uff1f</p> </li> <li> <p>\u200b\u4e3a\u4ec0\u4e48\u200b\u662f\u200b/dev/ttymxc5\u3001/dev/ttySTM3\uff1f</p> </li> </ul>"},{"location":"09_UART/09_1/#4-open","title":"4. open\u200b\u8fc7\u7a0b\u200b\u5206\u6790","text":"<p>\u200b\u5b83\u200b\u8981\u200b\u505a\u200b\u7684\u200b\u4e8b\u60c5\u200b\uff1a</p> <ul> <li> <p>\u200b\u627e\u5230\u200btty_driver</p> </li> <li> <p>\u200b\u5206\u914d\u200b/\u200b\u8bbe\u7f6e\u200btty_struct</p> </li> <li> <p>\u200b\u884c\u200b\u89c4\u7a0b\u200b\u76f8\u5173\u200b\u7684\u200b\u521d\u59cb\u5316\u200b</p> </li> <li> <p>\u200b\u8c03\u7528\u200btty_driver-&gt;ops-&gt;open              // ops\u200b\u662f\u200bstruct tty_operations\u200b\u6307\u9488\u200b\u7c7b\u578b\u200b, \u200b\u5c31\u662f\u200buart_open</p> </li> <li> <p>tty_port_open // uart\u200b\u4e0b\u200b\u6709\u200b\u591a\u4e2a\u200bport, \u200b\u4e0b\u9762\u200b\u5c31\u662f\u200b\u6253\u5f00\u200b\u67d0\u4e2a\u200bport</p> <ul> <li>port-&gt;ops-&gt;activate(port, tty); // ops\u200b\u662f\u200bstruct tty_port_operations\u200b\u6307\u9488\u200b\u7c7b\u578b\u200b</li> <li>uart_startup(tty, state, 0);<ul> <li>uart_port_startup(tty, state, init_hw);</li> <li>\u200b\u8c03\u7528\u200buart_port-&gt;ops-&gt;startup   // ops\u200b\u662f\u200bstruct uart_ops\u200b\u6307\u9488\u200b\u7c7b\u578b\u200b</li> </ul> </li> </ul> </li> </ul> <p>\u200b\u56fe\u5f62\u5316\u200b\u8bf4\u660e\u200b\uff1a\u200b\u6709\u200b3\u200b\u79cd\u200bops\uff1a</p> <p></p>"},{"location":"09_UART/09_1/#41-tty_open","title":"4.1 tty_open","text":"<pre><code>tty_open\n    // \u200b\u5982\u679c\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u662f\u200b(5,0)\u200b\u4e5f\u200b\u5c31\u662f\u200b/dev/tty, \u200b\u8868\u793a\u200b\u5f53\u524d\u200bTTY\n    // \u200b\u5bf9\u4e8e\u200b\u666e\u901a\u200b\u4e32\u53e3\u200b, \u200b\u7b2c\u4e00\u6b21\u200bopen\u200b\u65f6\u200b\u5fc5\u5b9a\u200b\u5931\u8d25\u200b\n    tty = tty_open_current_tty(device, filp);\n\n    // \u200b\u7b2c\u4e00\u6b21\u200bopen\u200b\u4e32\u53e3\u200b\u65f6\u200b\u8d70\u200b\u8fd9\u4e2a\u200b\u5206\u652f\u200b\n    if (!tty)\n        // \u200b\u901a\u8fc7\u200bdriver\u200b\u6765\u200bopen tty\uff0c\u200b\u5c31\u662f\u200b\u627e\u5230\u200btty_driver\uff0c\u200b\u7136\u540e\u200b\u5206\u914d\u200b/\u200b\u8bbe\u7f6e\u200btty_struct\n        tty = tty_open_by_driver(device, inode, filp);\n                // 1. \u200b\u5148\u200b\u627e\u5230\u200b\u5bf9\u5e94\u200b\u7684\u200btty_driver\n                driver = tty_lookup_driver(device, filp, &amp;index);\n\n                // 2. \u200b\u5982\u679c\u200b\u66fe\u7ecf\u200bopen\u200b\u8fc7\u200b\uff0c\u200b\u4f1a\u200b\u6709\u200b\u5bf9\u5e94\u200b\u7684\u200btty_struct\n                tty = tty_driver_lookup_tty(driver, filp, index);\n\n                // 3. \u200b\u7b2c\u200b1\u200b\u6253\u5f00\u200b\u8fd9\u4e2a\u200b\u4e32\u53e3\u200b\u65f6\u200b\u80af\u5b9a\u200b\u6ca1\u6709\u200b\u5bf9\u5e94\u200b\u7684\u200btty_struct\n                //    \u200b\u6240\u4ee5\u200b\u4f7f\u7528\u200b\u4e0b\u9762\u200b\u7684\u200b\u51fd\u6570\u200b\u521d\u59cb\u5316\u200b\u8bbe\u5907\u200b\n                tty = tty_init_dev(driver, index);\n                            // 3.1 \u200b\u5206\u914d\u200btty_strct\n                            tty = alloc_tty_struct(driver, idx);\n                                        tty-&gt;ops = driver-&gt;ops;\n\n                            // 3.2 \u200b\u5b89\u88c5\u200btty: \u200b\u4e5f\u200b\u5c31\u662f\u200bdriver-&gt;ttys[tty-&gt;index] = tty;\n                            retval = tty_driver_install_tty(driver, tty);\n\n                            // 3.3 \u200b\u8c03\u7528\u200b\u884c\u200b\u89c4\u7a0b\u200b\u7684\u200bopen\u200b\u51fd\u6570\u200b, \u200b\u8fc7\u4e8e\u200b\u590d\u6742\u200b\uff0c\u200b\u4e0d\u200b\u5206\u6790\u200b\n                            //     n_tty.c\u200b\u4e2d\u200b\u7684\u200bn_tty_open\u200b\u51fd\u6570\u200b\n                            retval = tty_ldisc_setup(tty, tty-&gt;link);\n\n\n    ......\n\n    // ops\u200b\u662f\u200btty_operations\u200b\u7c7b\u578b\u200b\n    // \u200b\u5bf9\u4e8e\u200b\u4e32\u53e3\u200bops\u200b\u5c31\u662f\u200bserial_core.c\u200b\u4e2d\u200b\u7684\u200buart_ops\n    // uart_open\n    if (tty-&gt;ops-&gt;open)\n        retval = tty-&gt;ops-&gt;open(tty, filp);\n    else\n        retval = -ENODEV;\n</code></pre>"},{"location":"09_UART/09_1/#42-uart_open","title":"4.2 uart_open","text":"<pre><code>uart_open\n    tty_port_open\n        // ops\u200b\u662f\u200btty_port_operations\u200b\u7c7b\u578b\u200b\uff0c\u200b\u5bf9\u5e94\u200bserial_core.c\u200b\u4e2d\u200b\u7684\u200buart_port_ops\n        // uart_port_activate\n        if (port-&gt;ops-&gt;activate) {\n            int retval = port-&gt;ops-&gt;activate(port, tty);\n            if (retval) {\n                mutex_unlock(&amp;port-&gt;mutex);\n                return retval;\n            }\n        }\n\nuart_port_activate\n    uart_startup\n        uart_port_startup\n            // ops\u200b\u662f\u200buart_ops\u200b\u7c7b\u578b\u200b\uff0c\u200b\u5728\u200b\u786c\u4ef6\u200b\u9a71\u52a8\u200b\u4e2d\u200b\u8bbe\u7f6e\u200b\n            // \u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u9a71\u52a8\u200b\u4e2d\u200buart_port\u200b\u7684\u200buart_ops\u200b\u91cc\u200b\u5fc5\u987b\u200b\u63d0\u4f9b\u200bstartup\u200b\u51fd\u6570\u200b\n            retval = uport-&gt;ops-&gt;startup(uport);\n</code></pre>"},{"location":"09_UART/10_1/","title":"10_UART\u200b\u9a71\u52a8\u200b\u60c5\u666f\u200b\u5206\u6790\u200b_read","text":""},{"location":"09_UART/10_1/#uart_read","title":"UART\u200b\u9a71\u52a8\u200b\u60c5\u666f\u200b\u5206\u6790\u200b_read","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b</p> <ul> <li>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b\uff1a</li> </ul> <pre><code>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\uff1a\ndrivers/tty/serial/imx.c\ndrivers/tty/serial/stm32-usart.c\n\n\u200b\u4e32\u53e3\u200b\u6838\u5fc3\u5c42\u200b\uff1a\ndrivers/tty/serial/serial_core.c\n\nTTY\u200b\u5c42\u200b:\ndrivers/tty/tty_io.c\n</code></pre>"},{"location":"09_UART/10_1/#1","title":"1. \u200b\u60c5\u666f\u200b\u5206\u6790\u200b\u5927\u7eb2","text":"<ul> <li>\u200b\u6ce8\u518c\u200b\u8fc7\u7a0b\u200b\u5206\u6790\u200b</li> <li>open\u200b\u8fc7\u7a0b\u200b\u5206\u6790\u200b</li> <li>read\u200b\u8fc7\u7a0b\u200b\u5206\u6790\u200b</li> <li>write\u200b\u8fc7\u7a0b\u200b\u5206\u6790\u200b</li> </ul>"},{"location":"09_UART/10_1/#2","title":"2. \u200b\u6e90\u7801\u200b\u6846\u67b6\u200b\u56de\u987e","text":""},{"location":"09_UART/10_1/#3","title":"3. \u200b\u4f7f\u7528\u200b\u54ea\u4e2a\u200b\u884c\u200b\u89c4\u7a0b","text":""},{"location":"09_UART/10_1/#31","title":"3.1 \u200b\u884c\u200b\u89c4\u7a0b\u200b\u6ce8\u518c","text":"<p>\u200b\u6587\u4ef6\u200b\uff1a<code>drivers\\tty\\n_tty.c</code></p> <pre><code>void __init n_tty_init(void)\n{\n    tty_register_ldisc(N_TTY, &amp;n_tty_ops);\n}\n</code></pre> <p>\u200b\u4ee5\u540e\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200b\u6807\u53f7\u200bN_TTY\u200b\u627e\u5230\u200b\u8fd9\u4e2a\u200b\u884c\u200b\u89c4\u7a0b\u200b\u3002</p>"},{"location":"09_UART/10_1/#32-open","title":"3.2 open\u200b\u8bbe\u5907\u200b\u65f6\u200b\u786e\u5b9a\u200b\u884c\u200b\u89c4\u7a0b","text":"<pre><code>tty_open\n    tty_open_by_driver\n        tty_init_dev\n            tty = alloc_tty_struct(driver, idx);\n                    tty_ldisc_init(tty);\n                        struct tty_ldisc *ld = tty_ldisc_get(tty, N_TTY);\n                        tty-&gt;ldisc = ld;\n</code></pre>"},{"location":"09_UART/10_1/#4-read","title":"4. read\u200b\u8fc7\u7a0b\u200b\u5206\u6790","text":"<p>\u200b\u6d41\u7a0b\u200b\u4e3a\u200b\uff1a</p> <ul> <li> <p>APP\u200b\u8bfb\u200b</p> </li> <li> <p>\u200b\u4f7f\u7528\u200b\u884c\u200b\u89c4\u7a0b\u200b\u6765\u8bfb\u200b</p> </li> <li> <p>\u200b\u65e0\u200b\u6570\u636e\u200b\u5219\u200b\u4f11\u7720\u200b</p> </li> <li> <p>UART\u200b\u63a5\u6536\u200b\u5230\u200b\u6570\u636e\u200b\uff0c\u200b\u4ea7\u751f\u200b\u4e2d\u65ad\u200b</p> </li> <li> <p>\u200b\u4e2d\u65ad\u200b\u7a0b\u5e8f\u200b\u4ece\u200b\u786c\u4ef6\u200b\u4e0a\u200b\u8bfb\u5165\u200b\u6570\u636e\u200b</p> </li> <li>\u200b\u53d1\u7ed9\u200b\u884c\u200b\u89c4\u7a0b\u200b</li> <li>\u200b\u884c\u200b\u89c4\u7a0b\u200b\u5904\u7406\u200b\u540e\u200b\u5b58\u5165\u200bbuffer</li> <li> <p>\u200b\u884c\u200b\u89c4\u7a0b\u200b\u5524\u9192\u200bAPP</p> </li> <li> <p>APP\u200b\u88ab\u200b\u5524\u9192\u200b\u540e\u200b\uff0c\u200b\u4ece\u884c\u200b\u89c4\u7a0b\u200bbuffer\u200b\u4e2d\u200b\u8bfb\u5165\u200b\u6570\u636e\u200b\uff0c\u200b\u8fd4\u56de\u200b</p> </li> </ul>"},{"location":"09_UART/10_1/#41-tty_read","title":"4.1 tty_read","text":"<p>\u200b\u6587\u4ef6\u200b\uff1a<code>drivers\\tty\\tty_io.c</code></p> <p></p>"},{"location":"09_UART/10_1/#42-ldisk-read","title":"4.2 ldisk read","text":"<p>\u200b\u6587\u4ef6\u200b\uff1a<code>drivers\\tty\\n_tty.c</code></p> <p>\u200b\u51fd\u6570\u200b\uff1a<code>n_tty_read</code> </p> <p></p> <pre><code>copy_from_read_buf\n        const unsigned char *from = read_buf_addr(ldata, tail);\n                                        // return &amp;ldata-&gt;read_buf[i &amp; (N_TTY_BUF_SIZE - 1)];\n        retval = copy_to_user(*b, from, n);\n</code></pre>"},{"location":"09_UART/10_1/#43","title":"4.3 \u200b\u6570\u636e\u200b\u6e90\u5934\u200b: \u200b\u4e2d\u65ad","text":""},{"location":"09_UART/10_1/#431-imx6ull","title":"4.3.1 IMX6ULL","text":"<p>\u200b\u6587\u4ef6\u200b\uff1a<code>drivers\\tty\\serial\\imx.c</code></p> <p>\u200b\u51fd\u6570\u200b\uff1a<code>imx_rxint</code></p> <pre><code>imx_rxint\n    // \u200b\u8bfb\u53d6\u200b\u786c\u4ef6\u200b\u72b6\u6001\u200b\n    // \u200b\u5f97\u5230\u200b\u6570\u636e\u200b\n    // \u200b\u5728\u200b\u5bf9\u5e94\u200b\u7684\u200buart_port\u200b\u4e2d\u200b\u66f4\u65b0\u200b\u7edf\u8ba1\u200b\u4fe1\u606f\u200b, \u200b\u6bd4\u5982\u200bsport-&gt;port.icount.rx++;\n\n    // \u200b\u628a\u200b\u6570\u636e\u200b\u5b58\u5165\u200btty_port\u200b\u91cc\u200b\u7684\u200btty_buffer\n    tty_insert_flip_char(port, rx, flg)\n\n    // \u200b\u901a\u77e5\u200b\u884c\u200b\u89c4\u7a0b\u200b\u6765\u200b\u5904\u7406\u200b\n    tty_flip_buffer_push(port);\n        tty_schedule_flip(port);\n            queue_work(system_unbound_wq, &amp;buf-&gt;work); // \u200b\u4f7f\u7528\u200b\u5de5\u4f5c\u200b\u961f\u5217\u200b\u6765\u200b\u5904\u7406\u200b\n                // \u200b\u5bf9\u5e94\u200bflush_to_ldisc\u200b\u51fd\u6570\u200b\n</code></pre>"},{"location":"09_UART/10_1/#432-stm32mp157","title":"4.3.2 STM32MP157","text":"<p>\u200b\u6587\u4ef6\u200b\uff1a<code>drivers\\tty\\serial\\stm32-usart.c</code></p> <p>\u200b\u51fd\u6570\u200b\uff1a<code>stm32_usart_threaded_interrupt</code></p> <pre><code>stm32_usart_threaded_interrupt\n    stm32_usart_receive_chars(port, true);\n        // \u200b\u901a\u8fc7\u200bDMA\u200b\u65b9\u5f0f\u200b\u5f97\u5230\u200b\u6570\u636e\u200b\n        stm32_usart_receive_chars_dma(port);\n            stm32_usart_push_buffer_dma(port, dma_size);\n                // \u200b\u628a\u200b\u6570\u636e\u200b\u5b58\u5165\u200btty_port\u200b\u91cc\u200b\u7684\u200btty_buffer\n                dma_count = tty_insert_flip_string(ttyport, dma_start, dma_size);\n                // \u200b\u66f4\u65b0\u200b\u7edf\u8ba1\u200b\u4fe1\u606f\u200b\n                port-&gt;icount.rx += dma_count;\n\n        // \u200b\u901a\u77e5\u200b\u884c\u200b\u89c4\u7a0b\u200b\u6765\u200b\u5904\u7406\u200b\n        tty_flip_buffer_push(tport);\n            tty_schedule_flip(port);\n                queue_work(system_unbound_wq, &amp;buf-&gt;work); // \u200b\u4f7f\u7528\u200b\u5de5\u4f5c\u200b\u961f\u5217\u200b\u6765\u200b\u5904\u7406\u200b\n                    // \u200b\u5bf9\u5e94\u200bflush_to_ldisc\u200b\u51fd\u6570\u200b\n</code></pre>"},{"location":"09_UART/11_1/","title":"11_UART\u200b\u9a71\u52a8\u200b\u60c5\u666f\u200b\u5206\u6790\u200b_write","text":""},{"location":"09_UART/11_1/#uart_write","title":"UART\u200b\u9a71\u52a8\u200b\u60c5\u666f\u200b\u5206\u6790\u200b_write","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b</p> <ul> <li>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b\uff1a</li> </ul> <pre><code>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\uff1a\ndrivers/tty/serial/imx.c\ndrivers/tty/serial/stm32-usart.c\n\n\u200b\u4e32\u53e3\u200b\u6838\u5fc3\u5c42\u200b\uff1a\ndrivers/tty/serial/serial_core.c\n\nTTY\u200b\u5c42\u200b:\ndrivers/tty/tty_io.c\n</code></pre>"},{"location":"09_UART/11_1/#1","title":"1. \u200b\u60c5\u666f\u200b\u5206\u6790\u200b\u5927\u7eb2","text":"<ul> <li>\u200b\u6ce8\u518c\u200b\u8fc7\u7a0b\u200b\u5206\u6790\u200b</li> <li>open\u200b\u8fc7\u7a0b\u200b\u5206\u6790\u200b</li> <li>read\u200b\u8fc7\u7a0b\u200b\u5206\u6790\u200b</li> <li>write\u200b\u8fc7\u7a0b\u200b\u5206\u6790\u200b</li> </ul>"},{"location":"09_UART/11_1/#2","title":"2. \u200b\u6e90\u7801\u200b\u6846\u67b6\u200b\u56de\u987e","text":""},{"location":"09_UART/11_1/#3-write","title":"3. write\u200b\u8fc7\u7a0b\u200b\u5206\u6790","text":"<p>\u200b\u6d41\u7a0b\u200b\u4e3a\u200b\uff1a</p> <ul> <li> <p>APP\u200b\u5199\u200b</p> </li> <li> <p>\u200b\u4f7f\u7528\u200b\u884c\u200b\u89c4\u7a0b\u200b\u6765\u200b\u5199\u200b</p> </li> <li> <p>\u200b\u6570\u636e\u200b\u6700\u7ec8\u200b\u5b58\u5165\u200buart_state-&gt;xmit\u200b\u7684\u200bbuffer\u200b\u91cc\u200b</p> </li> <li> <p>\u200b\u786c\u4ef6\u200b\u53d1\u9001\u200b\uff1a\u200b\u600e\u4e48\u200b\u53d1\u9001\u6570\u636e\u200b\uff1f</p> </li> <li> <p>\u200b\u4f7f\u7528\u200b\u786c\u4ef6\u200b\u9a71\u52a8\u200b\u4e2d\u200buart_ops-&gt;start_tx\u200b\u5f00\u59cb\u200b\u53d1\u9001\u200b</p> </li> <li> <p>\u200b\u5177\u4f53\u200b\u7684\u200b\u53d1\u9001\u200b\u65b9\u6cd5\u200b\u6709\u200b2\u200b\u79cd\u200b\uff1a\u200b\u901a\u8fc7\u200bDMA\uff0c\u200b\u6216\u200b\u901a\u8fc7\u200b\u4e2d\u65ad\u200b</p> </li> <li> <p>\u200b\u4e2d\u65ad\u200b\u65b9\u5f0f\u200b</p> </li> <li> <p>\u200b\u65b9\u6cd5\u200b1\uff1a\u200b\u76f4\u63a5\u200b\u4f7f\u80fd\u200b tx empty\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u4e00\u200b\u5f00\u59cb\u200btx buffer\u200b\u4e3a\u7a7a\u200b\uff0c\u200b\u5728\u200b\u4e2d\u65ad\u200b\u91cc\u200b\u586b\u5165\u200b\u6570\u636e\u200b</p> </li> <li>\u200b\u65b9\u6cd5\u200b2\uff1a\u200b\u5199\u200b\u90e8\u5206\u200b\u6570\u636e\u200b\u5230\u200btx fifo\uff0c\u200b\u4f7f\u80fd\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5269\u4e0b\u200b\u7684\u200b\u6570\u636e\u200b\u518d\u200b\u4e2d\u65ad\u200b\u91cc\u200b\u7ee7\u7eed\u200b\u53d1\u9001\u200b</li> </ul>"},{"location":"09_UART/11_1/#31-tty_write","title":"3.1 tty_write","text":"<p>\u200b\u6587\u4ef6\u200b\uff1a<code>drivers\\tty\\tty_io.c</code></p> <p></p>"},{"location":"09_UART/11_1/#32-ldisk-write","title":"3.2 ldisk write","text":"<p>\u200b\u6587\u4ef6\u200b\uff1a<code>drivers\\tty\\n_tty.c</code></p> <p>\u200b\u51fd\u6570\u200b\uff1a<code>n_tty_write</code> </p> <p></p>"},{"location":"09_UART/11_1/#33-uart_write","title":"3.3 uart_write","text":"<p>\u200b\u6587\u4ef6\u200b\uff1a<code>drivers\\tty\\serial\\serial_core.c</code></p> <p>\u200b\u51fd\u6570\u200b\uff1a<code>uart_write</code> </p> <p></p>"},{"location":"09_UART/11_1/#33","title":"3.3 \u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u53d1\u9001","text":""},{"location":"09_UART/11_1/#331-imx6ull","title":"3.3.1 IMX6ULL","text":"<p>\u200b\u6587\u4ef6\u200b\uff1a<code>drivers\\tty\\serial\\imx.c</code></p> <p>\u200b\u51fd\u6570\u200b\uff1a<code>imx_start_tx</code>\u200b\u548c\u200b<code>imx_txint</code></p> <p></p> <p>\u200b\u4e00\u200b\u5f00\u59cb\u200b\u65f6\u200b\uff0c\u200b\u53d1\u9001\u200bbuffer\u200b\u80af\u5b9a\u200b\u4e3a\u7a7a\u200b\uff0c\u200b\u4f1a\u200b\u7acb\u523b\u200b\u4ea7\u751f\u200b\u4e2d\u65ad\u200b\uff1a</p> <p></p>"},{"location":"09_UART/11_1/#332-stm32mp157","title":"3.3.2 STM32MP157","text":"<p>\u200b\u6587\u4ef6\u200b\uff1a<code>drivers\\tty\\serial\\stm32-usart.c</code></p> <p>\u200b\u51fd\u6570\u200b\uff1a<code>stm32_usart_threaded_interrupt</code></p> <p>STM32MP157\u200b\u53d1\u9001\u200b\u4e32\u53e3\u200b\u6570\u636e\u200b\u65f6\u200b\uff0c\u200b\u6709\u200b\u4e24\u79cd\u200b\u65b9\u6cd5\u200b\uff1aDMA\u3001\u200b\u4e2d\u65ad\u200b\u3002</p> <p>\u200b\u6211\u4eec\u200b\u6765\u200b\u5206\u6790\u200b\u7b2c\u4e8c\u79cd\u200b\u65b9\u5f0f\u200b\uff1a\u200b\u901a\u8fc7\u200b\u4e2d\u65ad\u200b\u6765\u200b\u53d1\u9001\u6570\u636e\u200b\u3002</p> <ul> <li>UART\u200b\u6709\u200bTx FIFO\uff0c\u200b\u53ef\u4ee5\u200b\u5f80\u91cc\u9762\u200b\u5199\u5165\u200b\u82e5\u5e72\u4e2a\u200b\u6570\u636e\u200b\uff0c\u200b\u7136\u540e\u200b\u4f7f\u80fd\u200b\u4e2d\u65ad\u200b</li> <li>\u200b\u5269\u4e0b\u200b\u7684\u200b\u6570\u636e\u200b\u901a\u8fc7\u200b\u4e2d\u65ad\u200b\u51fd\u6570\u200b\u7ee7\u7eed\u200b\u53d1\u9001\u200b\uff1a</li> </ul> <p></p>"},{"location":"09_UART/12_1/","title":"12_UART\u200b\u9a71\u52a8\u200b\u8c03\u8bd5\u200b\u65b9\u6cd5","text":""},{"location":"09_UART/12_1/#uart","title":"UART\u200b\u9a71\u52a8\u200b\u8c03\u8bd5\u200b\u65b9\u6cd5","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b</p> <ul> <li>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b\uff1a</li> </ul> <pre><code>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\uff1a\ndrivers/tty/serial/imx.c\ndrivers/tty/serial/stm32-usart.c\n\n\u200b\u4e32\u53e3\u200b\u6838\u5fc3\u5c42\u200b\uff1a\ndrivers/tty/serial/serial_core.c\n\nTTY\u200b\u5c42\u200b:\ndrivers/tty/tty_io.c\n</code></pre>"},{"location":"09_UART/12_1/#1-uart","title":"1. \u200b\u600e\u4e48\u200b\u5f97\u5230\u200bUART\u200b\u786c\u4ef6\u200b\u4e0a\u200b\u6536\u53d1\u200b\u7684\u200b\u6570\u636e","text":""},{"location":"09_UART/12_1/#11","title":"1.1 \u200b\u63a5\u6536\u200b\u5230\u200b\u7684\u200b\u539f\u59cb\u6570\u636e","text":"<p>\u200b\u53ef\u4ee5\u200b\u5728\u200b\u63a5\u6536\u200b\u4e2d\u65ad\u200b\u51fd\u6570\u200b\u91cc\u200b\u628a\u200b\u5b83\u200b\u6253\u5370\u200b\u51fa\u6765\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u6570\u636e\u200b\u4e5f\u200b\u4f1a\u200b\u5b58\u5165\u200bUART\u200b\u5bf9\u5e94\u200b\u7684\u200btty_port\u200b\u7684\u200bbuffer\u200b\u91cc\u200b\uff1a</p> <p></p>"},{"location":"09_UART/12_1/#12","title":"1.2 \u200b\u53d1\u9001\u200b\u51fa\u53bb\u200b\u7684\u200b\u6570\u636e","text":"<p>\u200b\u6240\u6709\u200b\u8981\u200b\u53d1\u9001\u200b\u51fa\u53bb\u200b\u7684\u200b\u4e32\u53e3\u200b\u6570\u636e\u200b\uff0c\u200b\u90fd\u200b\u4f1a\u200b\u901a\u8fc7\u200buart_write\u200b\u51fd\u6570\u200b\u53d1\u9001\u200b\uff0c\u200b\u6240\u6709\u200b\u53ef\u4ee5\u200b\u5728\u200buart_write\u200b\u4e2d\u200b\u628a\u200b\u5b83\u4eec\u200b\u6253\u5370\u200b\u51fa\u6765\u200b\uff1a</p> <p></p>"},{"location":"09_UART/12_1/#2-proc","title":"2. proc\u200b\u6587\u4ef6","text":""},{"location":"09_UART/12_1/#21-procinterrupts","title":"2.1 /proc/interrupts","text":"<p>\u200b\u67e5\u770b\u200b\u4e2d\u65ad\u200b\u6b21\u6570\u200b\u3002</p>"},{"location":"09_UART/12_1/#22-procttydrivers","title":"2.2 /proc/tty/drivers","text":""},{"location":"09_UART/12_1/#23-procttydriver","title":"2.3 /proc/tty/driver(\u200b\u975e\u5e38\u200b\u6709\u7528\u200b)","text":""},{"location":"09_UART/12_1/#24-procttyldiscs","title":"2.4 /proc/tty/ldiscs","text":""},{"location":"09_UART/12_1/#3-sys","title":"3. sys\u200b\u6587\u4ef6","text":"<p>\u200b\u5728\u200b<code>drivers\\tty\\serial\\serial_core.c</code>\u200b\u4e2d\u200b\uff0c\u200b\u6709\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <p></p> <p>\u200b\u8fd9\u5199\u200b\u4ee3\u7801\u200b\u4f1a\u200b\u5728\u200b/sys\u200b\u76ee\u5f55\u200b\u4e2d\u200b\u521b\u5efa\u200b\u4e32\u53e3\u200b\u7684\u200b\u5bf9\u5e94\u200b\u6587\u4ef6\u200b\uff0c\u200b\u67e5\u770b\u200b\u8fd9\u4e9b\u200b\u6587\u4ef6\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u4e32\u53e3\u200b\u7684\u200b\u5f88\u591a\u200b\u53c2\u6570\u200b\u3002</p> <p>\u200b\u600e\u4e48\u200b\u627e\u5230\u200b\u8fd9\u4e9b\u200b\u6587\u4ef6\u200b\uff1f\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>cd /sys\nfind -name uartclk  // \u200b\u5c31\u200b\u53ef\u4ee5\u200b\u627e\u5230\u200b\u8fd9\u4e9b\u200b\u6587\u4ef6\u200b\u6240\u5728\u200b\u76ee\u5f55\u200b\n</code></pre>"},{"location":"09_UART/13_1/","title":"13_\u200b\u7f16\u5199\u200b\u865a\u62df\u200bUART\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b_\u200b\u6846\u67b6","text":""},{"location":"09_UART/13_1/#uart_","title":"\u7f16\u5199\u200b\u865a\u62df\u200bUART\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b_\u200b\u6846\u67b6","text":"<ul> <li>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b</li> </ul> <pre><code>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\uff1a\ndrivers/tty/serial/imx.c\ndrivers/tty/serial/stm32-usart.c\n\n\u200b\u4e32\u53e3\u200b\u6838\u5fc3\u5c42\u200b\uff1a\ndrivers/tty/serial/serial_core.c\n\nTTY\u200b\u5c42\u200b:\ndrivers/tty/tty_io.c\n</code></pre> <ul> <li>\u200b\u672c\u200b\u8282\u200b\u8bfe\u7a0b\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b</li> </ul> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\source\\09_UART\n  04_virtual_uart_driver\ndoc_and_source_for_drivers\\STM32MP157\\source\\A7\\09_UART\n  04_virtual_uart_driver\n</code></pre>"},{"location":"09_UART/13_1/#1","title":"1. \u200b\u6846\u67b6\u200b\u56de\u987e","text":""},{"location":"09_UART/13_1/#2-uart","title":"2. \u200b\u7f16\u5199\u200bUART\u200b\u9a71\u52a8\u200b\u8981\u200b\u505a\u200b\u7684\u200b\u4e8b","text":"<ul> <li>\u200b\u6ce8\u518c\u200b\u4e00\u4e2a\u200buart_driver\uff1a\u200b\u5b83\u200b\u91cc\u9762\u200b\u6709\u200b\u540d\u5b57\u200b\u3001\u200b\u4e3b\u6b21\u200b\u8bbe\u5907\u200b\u53f7\u200b\u7b49\u200b</li> <li>\u200b\u5bf9\u4e8e\u200b\u6bcf\u200b\u4e00\u4e2a\u200bport\uff0c\u200b\u8c03\u7528\u200buart_add_one_port\uff0c\u200b\u91cc\u9762\u200b\u7684\u200b\u6838\u5fc3\u200b\u662f\u200buart_ops\uff0c\u200b\u63d0\u4f9b\u200b\u4e86\u200b\u786c\u4ef6\u200b\u64cd\u4f5c\u200b\u51fd\u6570\u200b</li> <li>uart_add_one_port\u200b\u7531\u200bplatform_driver\u200b\u7684\u200bprobe\u200b\u51fd\u6570\u8c03\u7528\u200b</li> <li>\u200b\u6240\u4ee5\u200b\uff1a<ul> <li>\u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811\u200b\u8282\u70b9\u200b</li> <li>\u200b\u6ce8\u518c\u200bplatform_driver</li> </ul> </li> </ul>"},{"location":"09_UART/13_1/#3-uart","title":"3. \u200b\u865a\u62df\u200b\u7684\u200bUART","text":"<p>\u200b\u4e3a\u4e86\u200b\u505a\u200b\u5b9e\u9a8c\u200b\uff0c\u200b\u6211\u4eec\u200b\u8fd8\u8981\u200b\u521b\u5efa\u200b\u4e00\u4e2a\u200b\u865a\u62df\u200b\u6587\u4ef6\u200b\uff1a/proc/virt_uart_buf</p> <ul> <li>\u200b\u8981\u53d1\u200b\u6570\u636e\u200b\u7ed9\u200b\u865a\u62df\u200b\u4e32\u53e3\u200b\u65f6\u200b\uff0c\u200b\u6267\u884c\u200b\uff1aecho \"xxx\" &gt; /proc/virt_uart_buf</li> <li>\u200b\u8981\u200b\u8bfb\u53d6\u200b\u865a\u62df\u200b\u4e32\u53e3\u200b\u7684\u200b\u6570\u636e\u200b\u65f6\u200b\uff0c\u200b\u6267\u884c\u200b\uff1acat /proc/virt_uart_buf</li> </ul>"},{"location":"09_UART/13_1/#4","title":"4. \u200b\u7f16\u7a0b","text":""},{"location":"09_UART/13_1/#41","title":"4.1 \u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"09_UART/13_1/#42-uart_driver","title":"4.2 \u200b\u7f16\u5199\u200buart_driver","text":""},{"location":"09_UART/13_1/#43-platform_driver","title":"4.3 \u200b\u7f16\u5199\u200bplatform_driver","text":""},{"location":"09_UART/13_1/#44-uart_ops","title":"4.4 \u200b\u5b9e\u73b0\u200buart_ops","text":""},{"location":"09_UART/13_1/#45-procvirt_uart_buf","title":"4.5 \u200b\u5b9e\u73b0\u200b/proc/virt_uart_buf","text":""},{"location":"09_UART/14_1/","title":"14_\u200b\u7f16\u5199\u200b\u865a\u62df\u200bUART\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b_\u200b\u5b9e\u73b0\u200buart_ops","text":""},{"location":"09_UART/14_1/#uart_uart_ops","title":"\u7f16\u5199\u200b\u865a\u62df\u200bUART\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b_\u200b\u5b9e\u73b0\u200buart_ops","text":"<ul> <li>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b</li> </ul> <pre><code>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\uff1a\ndrivers/tty/serial/imx.c\ndrivers/tty/serial/stm32-usart.c\n\n\u200b\u4e32\u53e3\u200b\u6838\u5fc3\u5c42\u200b\uff1a\ndrivers/tty/serial/serial_core.c\n\nTTY\u200b\u5c42\u200b:\ndrivers/tty/tty_io.c\n</code></pre> <ul> <li>\u200b\u672c\u200b\u8282\u200b\u8bfe\u7a0b\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b</li> </ul> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\source\\09_UART\n  05_virtual_uart_driver_uart_ops\ndoc_and_source_for_drivers\\STM32MP157\\source\\A7\\09_UART\n  05_virtual_uart_driver_uart_ops\n</code></pre>"},{"location":"09_UART/14_1/#1-uart","title":"1. \u200b\u865a\u62df\u200bUART\u200b\u7684\u200b\u9a71\u52a8\u200b\u7ec4\u6210","text":""},{"location":"09_UART/14_1/#2-uart","title":"2. \u200b\u865a\u62df\u200bUART\u200b\u7684\u200b\u6570\u636e\u200b\u6d41\u7a0b","text":"<p>\u200b\u4e3a\u4e86\u200b\u505a\u200b\u5b9e\u9a8c\u200b\uff0c\u200b\u6211\u4eec\u200b\u8fd8\u8981\u200b\u521b\u5efa\u200b\u4e00\u4e2a\u200b\u865a\u62df\u200b\u6587\u4ef6\u200b\uff1a/proc/virt_uart_buf</p> <ul> <li>\u200b\u8981\u53d1\u200b\u6570\u636e\u200b\u7ed9\u200b\u865a\u62df\u200b\u4e32\u53e3\u200b\u65f6\u200b\uff0c\u200b\u6267\u884c\u200b\uff1aecho \"xxx\" &gt; /proc/virt_uart_buf</li> <li>\u200b\u8981\u200b\u8bfb\u53d6\u200b\u865a\u62df\u200b\u4e32\u53e3\u200b\u7684\u200b\u6570\u636e\u200b\u65f6\u200b\uff0c\u200b\u6267\u884c\u200b\uff1acat /proc/virt_uart_buf</li> </ul>"},{"location":"09_UART/14_1/#3-uart_ops","title":"3. \u200b\u7f16\u5199\u200buart_ops","text":""},{"location":"09_UART/15_1/","title":"15_\u200b\u7f16\u5199\u200b\u865a\u62df\u200bUART\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b_\u200b\u5b9e\u73b0\u200b\u6570\u636e\u4f20\u8f93","text":""},{"location":"09_UART/15_1/#uart_","title":"\u7f16\u5199\u200b\u865a\u62df\u200bUART\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b_\u200b\u5b9e\u73b0\u200b\u6570\u636e\u4f20\u8f93","text":"<ul> <li>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b</li> </ul> <pre><code>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\uff1a\ndrivers/tty/serial/imx.c\ndrivers/tty/serial/stm32-usart.c\n\n\u200b\u4e32\u53e3\u200b\u6838\u5fc3\u5c42\u200b\uff1a\ndrivers/tty/serial/serial_core.c\n\nTTY\u200b\u5c42\u200b:\ndrivers/tty/tty_io.c\n</code></pre> <ul> <li>\u200b\u672c\u200b\u8282\u200b\u8bfe\u7a0b\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b</li> </ul> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\source\\09_UART\n  06_virtual_uart_driver_txrx\ndoc_and_source_for_drivers\\STM32MP157\\source\\A7\\09_UART\n  06_virtual_uart_driver_txrx\n</code></pre>"},{"location":"09_UART/15_1/#1-uart","title":"1. \u200b\u865a\u62df\u200bUART\u200b\u7684\u200b\u9a71\u52a8\u200b\u7ec4\u6210","text":""},{"location":"09_UART/15_1/#2-uart","title":"2. \u200b\u865a\u62df\u200bUART\u200b\u7684\u200b\u6570\u636e\u200b\u6d41\u7a0b","text":"<p>\u200b\u4e3a\u4e86\u200b\u505a\u200b\u5b9e\u9a8c\u200b\uff0c\u200b\u6211\u4eec\u200b\u8fd8\u8981\u200b\u521b\u5efa\u200b\u4e00\u4e2a\u200b\u865a\u62df\u200b\u6587\u4ef6\u200b\uff1a/proc/virt_uart_buf</p> <ul> <li>\u200b\u8981\u53d1\u200b\u6570\u636e\u200b\u7ed9\u200b\u865a\u62df\u200b\u4e32\u53e3\u200b\u65f6\u200b\uff0c\u200b\u6267\u884c\u200b\uff1aecho \"xxx\" &gt; /proc/virt_uart_buf</li> <li>\u200b\u8981\u200b\u8bfb\u53d6\u200b\u865a\u62df\u200b\u4e32\u53e3\u200b\u7684\u200b\u6570\u636e\u200b\u65f6\u200b\uff0c\u200b\u6267\u884c\u200b\uff1acat /proc/virt_uart_buf</li> </ul>"},{"location":"09_UART/15_1/#3-proc","title":"3. \u200b\u5b9e\u73b0\u200b/proc\u200b\u6587\u4ef6","text":"<p>\u200b\u53c2\u8003\u200b<code>/proc/cmdline</code>\uff0c\u200b\u600e\u4e48\u200b\u627e\u5230\u200b\u5b83\u200b\u5bf9\u5e94\u200b\u7684\u200b\u9a71\u52a8\u200b\uff1f\u200b\u5728\u200bLinux\u200b\u5185\u6838\u200b\u6e90\u7801\u200b\u4e0b\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u641c\u7d22\u200b\uff1a</p> <pre><code>grep \"cmdline\" * -nr | grep proc\n</code></pre> <p>\u200b\u5f97\u5230\u200b\uff1a</p> <pre><code>fs/proc/cmdline.c:26:   proc_create(\"cmdline\", 0, NULL, &amp;cmdline_proc_fops);\n</code></pre>"},{"location":"09_UART/15_1/#4","title":"4. \u200b\u89e6\u53d1\u200b\u4e2d\u65ad","text":"<p>\u200b\u4f7f\u7528\u200b\u5982\u4e0b\u200b\u51fd\u6570\u200b\uff1a</p> <pre><code>int irq_set_irqchip_state(unsigned int irq, enum irqchip_irq_state which,\n              bool val);\n</code></pre> <p>\u200b\u600e\u4e48\u200b\u627e\u5230\u200b\u5b83\u200b\u7684\u200b\uff1f\u200b\u5728\u200b\u4e2d\u65ad\u200b\u5b50\u7cfb\u7edf\u200b\u4e2d\u200b\uff0c\u200b\u6211\u4eec\u200b\u77e5\u9053\u200b\u5f80\u200bGIC\u200b\u5bc4\u5b58\u5668\u200bGICD_ISPENDRn\u200b\u5199\u5165\u200b\u67d0\u200b\u4e00\u4f4d\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\u3002\u200b\u5185\u6838\u200b\u4ee3\u7801\u200b\u4e2d\u200b\u600e\u4e48\u200b\u8bbf\u95ee\u200b\u8fd9\u4e9b\u200b\u5bc4\u5b58\u5668\u200b\uff1f \u200b\u5728\u200b<code>drivers\\irqchip\\irq-gic.c</code>\u200b\u4e2d\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200birq_chip\u200b\u4e2d\u200b\u7684\u200b\"irq_set_irqchip_state\"\u200b\u88ab\u200b\u7528\u6765\u200b\u8bbe\u7f6e\u200b\u4e2d\u65ad\u200b\u72b6\u6001\u200b\uff1a</p> <pre><code>static struct irq_chip gic_chip = {\n    .irq_mask       = gic_mask_irq,\n    .irq_unmask     = gic_unmask_irq,\n    .irq_eoi        = gic_eoi_irq,\n    .irq_set_type       = gic_set_type,\n    .irq_get_irqchip_state  = gic_irq_get_irqchip_state,\n    .irq_set_irqchip_state  = gic_irq_set_irqchip_state, /* 2. \u200b\u7ee7\u7eed\u200b\u641c\u200b\"irq_set_irqchip_state\" */\n    .flags          = IRQCHIP_SET_TYPE_MASKED |\n                  IRQCHIP_SKIP_SET_WAKE |\n                  IRQCHIP_MASK_ON_SUSPEND,\n};\n\nstatic int gic_irq_set_irqchip_state(struct irq_data *d,\n                     enum irqchip_irq_state which, bool val)\n{\n    u32 reg;\n\n    switch (which) {\n    case IRQCHIP_STATE_PENDING:\n        reg = val ? GIC_DIST_PENDING_SET : GIC_DIST_PENDING_CLEAR; /* 1. \u200b\u627e\u5230\u200b\u5bc4\u5b58\u5668\u200b */\n        break;\n\n    case IRQCHIP_STATE_ACTIVE:\n        reg = val ? GIC_DIST_ACTIVE_SET : GIC_DIST_ACTIVE_CLEAR;\n        break;\n\n    case IRQCHIP_STATE_MASKED:\n        reg = val ? GIC_DIST_ENABLE_CLEAR : GIC_DIST_ENABLE_SET;\n        break;\n\n    default:\n        return -EINVAL;\n    }\n\n    gic_poke_irq(d, reg);\n    return 0;\n}\n</code></pre> <p>\u200b\u7ee7\u7eed\u200b\u641c\u200b\"irq_set_irqchip_state\"\uff0c\u200b\u5728\u200b<code>drivers\\irqchip\\irq-gic.c</code>\u200b\u4e2d\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200b\uff1a</p> <pre><code>int irq_set_irqchip_state(unsigned int irq, enum irqchip_irq_state which,\n              bool val)\n{\n    ......\n}\n\nEXPORT_SYMBOL_GPL(irq_set_irqchip_state);\n</code></pre> <p>\u200b\u4ee5\u540e\u200b\u5c31\u200b\u53ef\u200b\u4e0e\u200b\u4f7f\u7528\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\u89e6\u53d1\u200b\u67d0\u4e2a\u200b\u4e2d\u65ad\u200b\uff1a</p> <pre><code>irq_set_irqchip_state(irq, IRQCHIP_STATE_PENDING, 1);\n</code></pre>"},{"location":"09_UART/16_1/","title":"16_\u200b\u7f16\u5199\u200b\u865a\u62df\u200bUART\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b_\u200b\u8c03\u8bd5","text":""},{"location":"09_UART/16_1/#uart_","title":"\u7f16\u5199\u200b\u865a\u62df\u200bUART\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b_\u200b\u8c03\u8bd5","text":"<ul> <li>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b</li> </ul> <pre><code>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\uff1a\ndrivers/tty/serial/imx.c\ndrivers/tty/serial/stm32-usart.c\n\n\u200b\u4e32\u53e3\u200b\u6838\u5fc3\u5c42\u200b\uff1a\ndrivers/tty/serial/serial_core.c\n\nTTY\u200b\u5c42\u200b:\ndrivers/tty/tty_io.c\n</code></pre> <ul> <li>\u200b\u672c\u200b\u8282\u200b\u8bfe\u7a0b\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b</li> </ul> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\source\\09_UART\n  07_virtual_uart_driver_ok\ndoc_and_source_for_drivers\\STM32MP157\\source\\A7\\09_UART\n  07_virtual_uart_driver_ok\n</code></pre>"},{"location":"09_UART/16_1/#1","title":"1. \u200b\u5b9e\u9a8c\u200b\u6d41\u7a0b","text":""},{"location":"09_UART/16_1/#2","title":"2. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":""},{"location":"09_UART/16_1/#21","title":"2.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":""},{"location":"09_UART/16_1/#1-stm32mp157","title":"1. STM32MP157","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"09_UART/16_1/#2-imx6ull","title":"2. IMX6ULL","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre>"},{"location":"09_UART/16_1/#22","title":"2.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"09_UART/16_1/#1-stm32mp157_1","title":"1. STM32MP157","text":"<ul> <li> <p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dts</code>\uff0c\u200b\u6dfb\u52a0\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>/ {\n    virtual_uart: virtual_uart_100ask {\n        compatible = \"100ask,virtual_uart\";\n\n        interrupt-parent = &lt;&amp;intc&gt;;\n        interrupts = &lt;GIC_SPI 99 IRQ_TYPE_LEVEL_HIGH&gt;;\n\n    };\n};\n</code></pre> </li> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bSTM32MP157\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v2.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v2.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <ul> <li>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.2.100)</li> </ul> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.2.100:/home/book/nfs_rootfs /mnt\n</code></pre> <ul> <li>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.2.137</li> </ul> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.2.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> </ul> <pre><code>[root@100ask:~]# mount  /dev/mmcblk2p2  /boot\n[root@100ask:~]# cp /mnt/stm32mp157c-100ask-512d-lcd-v1.dtb /boot\n[root@100ask:~]# sync\n</code></pre> <ul> <li>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</li> </ul>"},{"location":"09_UART/16_1/#2-imx6ull_1","title":"2. IMX6ULL","text":"<ul> <li> <p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code>\uff0c\u200b\u6dfb\u52a0\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>/ {\n    virtual_uart: virtual_uart_100ask {\n        compatible = \"100ask,virtual_uart\";\n\n        interrupt-parent = &lt;&amp;intc&gt;;\n        interrupts = &lt;GIC_SPI 99 IRQ_TYPE_LEVEL_HIGH&gt;;\n\n    };\n\n};\n</code></pre> </li> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bIMX6ULL\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/100ask_imx6ull-14x14.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200bNAT(\u200b\u5047\u8bbe\u200bwindowsIP\u200b\u4e3a\u200b192.168.2.100)</p> <pre><code>[root@100ask:~]# mount -t nfs -o nolock,vers=3,port=2049,mountport=9999 \n192.168.2.100:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>vmware\u200b\u4f7f\u7528\u200b\u6865\u63a5\u200b\uff0c\u200b\u6216\u8005\u200b\u4e0d\u200b\u4f7f\u7528\u200bvmware\u200b\u800c\u662f\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u670d\u52a1\u5668\u200b\uff1a\u200b\u5047\u8bbe\u200bUbuntu IP\u200b\u4e3a\u200b192.168.2.137</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.2.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/100ask_imx6ull-14x14.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"09_UART/16_1/#23","title":"2.3 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u5b89\u88c5\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\uff1a</p> </li> <li> <p>\u200b\u5728\u200bUbuntu\u200b\u4e0a\u200b</p> </li> <li> <p>\u200b\u4fee\u6539\u200b<code>07_virtual_uart_driver_ok</code>\u200b\u4e2d\u200b\u7684\u200bMakefile\uff0c\u200b\u6307\u5b9a\u200b\u5185\u6838\u200b\u8def\u5f84\u200b<code>KERN_DIR</code>\uff0c\u200b\u5728\u200b\u6267\u884c\u200b<code>make</code>\u200b\u547d\u4ee4\u200b\u5373\u53ef\u200b\u3002</p> </li> <li> <p>\u200b\u5b89\u88c5\u200b\uff1a</p> </li> <li> <p>\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b</p> </li> <li> <p>\u200b\u6302\u8f7d\u200bNFS\uff0c\u200b\u590d\u5236\u200b\u6587\u4ef6\u200b\uff0cinsmod\uff0c\u200b\u7c7b\u4f3c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b\uff1a</p> <pre><code>mount -t nfs -o nolock,vers=3 192.168.2.137:/home/book/nfs_rootfs /mnt\n// \u200b\u5bf9\u4e8e\u200bIMX6ULL\uff0c\u200b\u60f3\u200b\u770b\u5230\u200b\u9a71\u52a8\u200b\u6253\u5370\u4fe1\u606f\u200b\uff0c\u200b\u9700\u8981\u200b\u5148\u200b\u6267\u884c\u200b\necho \"7 4 1 7\" &gt; /proc/sys/kernel/printk\n\ninsmod -f /mnt/virtual_uart.ko\n</code></pre> </li> <li> <p>\u200b\u89c2\u5bdf\u200b\u5185\u6838\u200b\u6253\u5370\u200b\u7684\u200b\u4fe1\u606f\u200b</p> </li> </ul>"},{"location":"09_UART/16_1/#3","title":"3. \u200b\u8c03\u8bd5","text":"<p>\u200b\u6839\u636e\u200b\u6846\u67b6\u200b\u3001\u200b\u6570\u636e\u200b\u6d41\u7a0b\u200b\u6765\u200b\u8c03\u8bd5\u200b\uff1a</p> <p></p>"},{"location":"09_UART/17_1/","title":"17_printk\u200b\u6267\u884c\u200b\u8fc7\u7a0b","text":""},{"location":"09_UART/17_1/#printk","title":"printk\u200b\u6267\u884c\u200b\u8fc7\u7a0b","text":"<ul> <li> <p>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b</p> </li> <li> <p>Linux 4.9.88</p> <pre><code>kernel/printk.c\ninclude/linux/kernel.h\nkernel/printk/internal.h\n</code></pre> </li> <li> <p>Linux 5.4</p> <pre><code>kernel/printk.c\ninclude/linux/kernel.h\nkernel/printk/printk_safe.c\n</code></pre> </li> </ul>"},{"location":"09_UART/17_1/#1-printk","title":"1.  printk\u200b\u7684\u200b\u4f7f\u7528","text":""},{"location":"09_UART/17_1/#11-printk","title":"1.1  printk\u200b\u4f7f\u7528\u200b\u793a\u4f8b","text":"<p>\u200b\u8c03\u8bd5\u200b\u5185\u6838\u200b\u3001\u200b\u9a71\u52a8\u200b\u7684\u200b\u6700\u200b\u7b80\u5355\u200b\u65b9\u6cd5\u200b\uff0c\u200b\u662f\u200b\u4f7f\u7528\u200bprintk\u200b\u51fd\u6570\u200b\u6253\u5370\u4fe1\u606f\u200b\u3002</p> <p>printk\u200b\u51fd\u6570\u200b\u4e0e\u200b\u7528\u6237\u200b\u7a7a\u95f4\u200b\u7684\u200bprintf\u200b\u51fd\u6570\u200b\u683c\u5f0f\u200b\u5b8c\u5168\u76f8\u540c\u200b\uff0c\u200b\u5b83\u200b\u6240\u200b\u6253\u5370\u200b\u7684\u200b\u5b57\u7b26\u4e32\u200b\u5934\u90e8\u200b\u53ef\u4ee5\u200b\u52a0\u5165\u200b\u201c\\001n\u201d\u200b\u6837\u5f0f\u200b\u7684\u200b\u5b57\u7b26\u200b\u3002</p> <p>\u200b\u5176\u4e2d\u200bn\u200b\u4e3a\u200b0\uff5e7\uff0c\u200b\u8868\u793a\u200b\u8fd9\u200b\u6761\u200b\u4fe1\u606f\u200b\u7684\u200b\u8bb0\u5f55\u200b\u7ea7\u522b\u200b\uff0cn\u200b\u6570\u503c\u200b\u8d8a\u5c0f\u200b\u7ea7\u522b\u200b\u8d8a\u9ad8\u200b\u3002</p> <p>\u200b\u6ce8\u610f\u200b\uff1alinux 2.x\u200b\u5185\u6838\u200b\u91cc\u200b\uff0c\u200b\u6253\u5370\u200b\u7ea7\u522b\u200b\u662f\u200b\u7528\u200b\"\"\u200b\u6765\u200b\u8868\u793a\u200b\u3002</p> <p>\u200b\u5728\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e2d\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u8fd9\u6837\u200b\u4f7f\u7528\u200bprintk\uff1a</p> <pre><code>printk(\"This is an example\\n\");\nprintk(\"\\0014This is an example\\n\");\nprintk(\"\\0014\"\"This is an example\\n\");\nprintk(KERN_WARNING\"This is an example\\n\");\n</code></pre> <p>\u200b\u5728\u200b\u4e0a\u8ff0\u200b\u4f8b\u5b50\u200b\u4e2d\u200b\uff1a</p> <ul> <li> <p>\u200b\u7b2c\u4e00\u6761\u200b\u8bed\u53e5\u200b\u6ca1\u6709\u200b\u660e\u786e\u200b\u8868\u660e\u200b\u6253\u5370\u200b\u7ea7\u522b\u200b\uff0c\u200b\u5b83\u200b\u88ab\u200b\u5904\u7406\u200b\u524d\u200b\u5185\u6838\u200b\u4f1a\u200b\u5728\u200b\u524d\u9762\u200b\u6dfb\u52a0\u200b\u9ed8\u8ba4\u200b\u7684\u200b\u6253\u5370\u200b\u7ea7\u522b\u200b\uff1a\"&lt;4&gt;\"</p> </li> <li> <p>KERN_WARNING\u200b\u662f\u200b\u4e00\u4e2a\u200b\u5b8f\u200b\uff0c\u200b\u5b83\u200b\u4e5f\u200b\u8868\u793a\u200b\u6253\u5370\u200b\u7ea7\u522b\u200b\uff1a</p> </li> </ul> <pre><code>#define KERN_SOH    \"\\001\"      /* ASCII Start Of Header */\n#define KERN_WARNING    KERN_SOH \"4\"    /* warning conditions */\n</code></pre> <p>\u200b\u73b0\u5728\u200b\u6211\u4eec\u200b\u77e5\u9053\u200b\u4e86\u200b\uff0c\u200b\u5185\u6838\u200b\u7684\u200b\u6bcf\u6761\u200b\u6253\u5370\u4fe1\u606f\u200b\u90fd\u200b\u6709\u200b\u81ea\u5df1\u200b\u7684\u200b\u7ea7\u522b\u200b\uff0c\u200b\u5f53\u200b\u81ea\u5df1\u200b\u7684\u200b\u7ea7\u522b\u200b\u5728\u200b\u6570\u503c\u200b\u4e0a\u200b\u5c0f\u4e8e\u200b\u67d0\u4e2a\u200b\u9608\u503c\u200b\u65f6\u200b\uff0c\u200b\u5185\u6838\u200b\u624d\u200b\u4f1a\u200b\u6253\u5370\u200b\u8be5\u200b\u4fe1\u606f\u200b\u3002</p>"},{"location":"09_UART/17_1/#12-printk","title":"1.2 printk\u200b\u51fd\u6570\u200b\u7684\u200b\u8bb0\u5f55\u200b\u7ea7\u522b","text":"<p>\u200b\u5728\u200b\u5185\u6838\u200b\u4ee3\u7801\u200b<code>include/linux/kernel.h</code>\u200b\u4e2d\u200b\uff0c\u200b\u4e0b\u9762\u200b\u51e0\u4e2a\u200b\u5b8f\u200b\u786e\u5b9a\u200b\u4e86\u200bprintk\u200b\u51fd\u6570\u200b\u600e\u4e48\u200b\u5904\u7406\u200b\u6253\u5370\u200b\u7ea7\u522b\u200b\uff1a</p> <pre><code>#define console_loglevel (console_printk[0])\n#define default_message_loglevel (console_printk[1])\n#define minimum_console_loglevel (console_printk[2])\n#define default_console_loglevel (console_printk[3])\n</code></pre> <p>\u200b\u4e3e\u4f8b\u8bf4\u660e\u200b\u8fd9\u200b\u51e0\u4e2a\u200b\u5b8f\u200b\u7684\u200b\u542b\u4e49\u200b\uff1a</p> <p>\u2460 \u200b\u5bf9\u4e8e\u200bprintk(\u201c\u2026\u2026\u201d)\uff0c\u200b\u53ea\u6709\u200bn\u200b\u5c0f\u4e8e\u200bconsole_loglevel\u200b\u65f6\u200b\uff0c\u200b\u8fd9\u4e2a\u200b\u4fe1\u606f\u200b\u624d\u200b\u4f1a\u200b\u88ab\u200b\u6253\u5370\u200b\u3002</p> <p>\u2461 \u200b\u5047\u8bbe\u200bdefault_message_loglevel\u200b\u7684\u200b\u503c\u200b\u7b49\u4e8e\u200b4\uff0c\u200b\u5982\u679c\u200bprintk\u200b\u7684\u200b\u53c2\u6570\u200b\u5f00\u5934\u200b\u6ca1\u6709\u200b\u201c\u201d\u200b\u6837\u5f0f\u200b\u7684\u200b\u5b57\u7b26\u200b\uff0c\u200b\u5219\u200b\u5728\u200bprintk\u200b\u51fd\u6570\u200b\u4e2d\u200b\u8fdb\u4e00\u6b65\u200b\u5904\u7406\u200b\u524d\u4f1a\u200b\u81ea\u52a8\u200b\u52a0\u4e0a\u200b\u201c&lt;4&gt;\u201d\uff1b</p> <p>\u2462 minimum_console_logleve\u200b\u662f\u200b\u4e00\u4e2a\u200b\u9884\u8bbe\u503c\u200b\uff0c\u200b\u5e73\u65f6\u200b\u4e0d\u8d77\u4f5c\u7528\u200b\u3002\u200b\u901a\u8fc7\u200b\u5176\u4ed6\u200b\u5de5\u5177\u200b\u6765\u200b\u8bbe\u7f6e\u200bconsole_loglevel\u200b\u7684\u200b\u503c\u65f6\u200b\uff0c\u200b\u8fd9\u4e2a\u200b\u503c\u200b\u4e0d\u80fd\u200b\u5c0f\u4e8e\u200bminimum_console_logleve\u3002</p> <p>\u2463 default_console_loglevel\u200b\u4e5f\u200b\u662f\u200b\u4e00\u4e2a\u200b\u9884\u8bbe\u503c\u200b\uff0c\u200b\u5e73\u65f6\u200b\u4e0d\u8d77\u4f5c\u7528\u200b\u3002\u200b\u5b83\u200b\u8868\u793a\u200b\u8bbe\u7f6e\u200bconsole_loglevel\u200b\u65f6\u200b\u7684\u200b\u9ed8\u8ba4\u503c\u200b\uff0c\u200b\u901a\u8fc7\u200b\u5176\u4ed6\u200b\u5de5\u5177\u200b\u6765\u200b\u8bbe\u7f6e\u200bconsole_loglevel\u200b\u7684\u200b\u503c\u65f6\u200b\uff0c\u200b\u7528\u5230\u200b\u8fd9\u4e2a\u200b\u503c\u200b\u3002</p> <p>\u200b\u4e0a\u9762\u200b\u4ee3\u7801\u200b\u4e2d\u200b\uff0cconsole_printk\u200b\u662f\u200b\u4e00\u4e2a\u200b\u6570\u7ec4\u200b\uff0c\u200b\u5b83\u200b\u5728\u200bkernel/printk.c\u200b\u4e2d\u200b\u5b9a\u4e49\u200b\uff1a <pre><code>/* \u200b\u6570\u7ec4\u200b\u91cc\u200b\u7684\u200b\u5b8f\u200b\u5728\u200binclude/linux/printk.h\u200b\u4e2d\u200b\u5b9a\u4e49\u200b\n */\nint console_printk[4] = {\n    CONSOLE_LOGLEVEL_DEFAULT,   /* console_loglevel */\n    MESSAGE_LOGLEVEL_DEFAULT,   /* default_message_loglevel */\n    CONSOLE_LOGLEVEL_MIN,       /* minimum_console_loglevel */\n    CONSOLE_LOGLEVEL_DEFAULT,   /* default_console_loglevel */\n};\n\n/* Linux 4.9.88 include/linux/printk.h */\n#define CONSOLE_LOGLEVEL_DEFAULT 7 /* anything MORE serious than KERN_DEBUG */\n#define MESSAGE_LOGLEVEL_DEFAULT CONFIG_MESSAGE_LOGLEVEL_DEFAULT\n#define CONSOLE_LOGLEVEL_MIN     1 /* Minimum loglevel we let people use */\n\n/* Linux 5.4 include/linux/printk.h */\n#define CONSOLE_LOGLEVEL_DEFAULT CONFIG_CONSOLE_LOGLEVEL_DEFAULT\n#define MESSAGE_LOGLEVEL_DEFAULT CONFIG_MESSAGE_LOGLEVEL_DEFAULT\n#define CONSOLE_LOGLEVEL_MIN     1 /* Minimum loglevel we let people use */\n</code></pre></p>"},{"location":"09_UART/17_1/#13-printk","title":"1.3 \u200b\u5728\u200b\u7528\u6237\u200b\u7a7a\u95f4\u200b\u4fee\u6539\u200bprintk\u200b\u51fd\u6570\u200b\u7684\u200b\u8bb0\u5f55\u200b\u7ea7\u522b","text":"<p>\u200b\u6302\u63a5\u200bproc\u200b\u6587\u4ef6\u7cfb\u7edf\u200b\u540e\u200b\uff0c\u200b\u8bfb\u53d6\u200b/proc/sys/kernel/printk\u200b\u6587\u4ef6\u200b\u53ef\u4ee5\u200b\u5f97\u77e5\u200bconsole_loglevel\u3001default_message_loglevel\u3001minimum_console_loglevel\u200b\u548c\u200bdefault_console_loglevel\u200b\u8fd9\u200b4\u200b\u4e2a\u503c\u200b\u3002</p> <p>\u200b\u6bd4\u5982\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u7ed3\u679c\u200b\u201c7 4 1 7\u201d\u200b\u8868\u793a\u200b\u8fd9\u200b4\u200b\u4e2a\u503c\u200b\uff1a</p> <p></p> <p>\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u76f4\u63a5\u200b\u4fee\u6539\u200b/proc/sys/kernel/printk\u200b\u6587\u4ef6\u200b\u6765\u200b\u6539\u53d8\u200b\u8fd9\u200b4\u200b\u4e2a\u503c\u200b\uff0c\u200b\u6bd4\u5982\u200b\uff1a <pre><code># echo \"1 4 1 7\" &gt; /proc/sys/kernel/printk\n</code></pre> \u200b\u8fd9\u200b\u4f7f\u5f97\u200bconsole_loglevel\u200b\u88ab\u200b\u6539\u4e3a\u200b1\uff0c\u200b\u4e8e\u662f\u200b\u6240\u6709\u200b\u7684\u200bprintk\u200b\u4fe1\u606f\u200b\u90fd\u200b\u4e0d\u4f1a\u200b\u88ab\u200b\u6253\u5370\u200b\u3002</p> <p></p>"},{"location":"09_UART/17_1/#14-printk","title":"1.4 printk\u200b\u51fd\u6570\u200b\u8bb0\u5f55\u200b\u7ea7\u522b\u200b\u7684\u200b\u540d\u79f0\u200b\u53ca\u200b\u4f7f\u7528","text":"<p>\u200b\u5728\u200b\u5185\u6838\u200b\u4ee3\u7801\u200binclude/linux/kernel.h\u200b\u4e2d\u200b\uff0c\u200b\u6709\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff0c\u200b\u5b83\u4eec\u200b\u8868\u793a\u200b0\uff5e7\u200b\u8fd9\u200b8\u200b\u4e2a\u200b\u8bb0\u5f55\u200b\u7ea7\u522b\u200b\u7684\u200b\u540d\u79f0\u200b\uff1a <pre><code>#define KERN_SOH    \"\\001\"      /* ASCII Start Of Header */\n#define KERN_SOH_ASCII  '\\001'\n\n#define KERN_EMERG  KERN_SOH \"0\"    /* system is unusable */\n#define KERN_ALERT  KERN_SOH \"1\"    /* action must be taken immediately */\n#define KERN_CRIT   KERN_SOH \"2\"    /* critical conditions */\n#define KERN_ERR    KERN_SOH \"3\"    /* error conditions */\n#define KERN_WARNING    KERN_SOH \"4\"    /* warning conditions */\n#define KERN_NOTICE KERN_SOH \"5\"    /* normal but significant condition */\n#define KERN_INFO   KERN_SOH \"6\"    /* informational */\n#define KERN_DEBUG  KERN_SOH \"7\"    /* debug-level messages */\n</code></pre></p> <p>\u200b\u5728\u200b\u4f7f\u7528\u200bprintk\u200b\u51fd\u6570\u200b\u65f6\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u8fd9\u6837\u200b\u4f7f\u7528\u200b\u8bb0\u5f55\u200b\u7ea7\u522b\u200b\uff1b <pre><code>printk(KERN_WARNING\u201dthere is a warning here!\\n\u201d)\n</code></pre></p>"},{"location":"09_UART/17_1/#2-printk","title":"2.  printk\u200b\u6267\u884c\u200b\u8fc7\u7a0b","text":""},{"location":"09_UART/17_1/#21","title":"2.1  \u200b\u51fd\u6570\u8c03\u7528\u200b\u8fc7\u7a0b","text":"<p>\u200b\u5728\u200b\u5d4c\u5165\u5f0f\u200bLinux\u200b\u5f00\u53d1\u200b\u4e2d\u200b\uff0cprintk\u200b\u4fe1\u606f\u200b\u5e38\u5e38\u200b\u4ece\u200b\u4e32\u53e3\u200b\u8f93\u51fa\u200b\uff0c\u200b\u8fd9\u65f6\u200b\u4e32\u53e3\u200b\u88ab\u200b\u79f0\u4e3a\u200b\u4e32\u53e3\u200b\u63a7\u5236\u53f0\u200b\u3002\u200b\u4ece\u200b\u5185\u6838\u200bkernel/printk.c\u200b\u7684\u200bprintk\u200b\u51fd\u6570\u200b\u5f00\u59cb\u200b\uff0c\u200b\u5f80\u200b\u4e0b\u200b\u67e5\u770b\u200b\u5b83\u200b\u7684\u200b\u8c03\u7528\u200b\u5173\u7cfb\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200bprintk\u200b\u51fd\u6570\u200b\u662f\u200b\u5982\u4f55\u200b\u4e0e\u200b\u5177\u4f53\u200b\u8bbe\u5907\u200b\u7684\u200b\u8f93\u51fa\u200b\u51fd\u6570\u200b\u6302\u94a9\u200b\u7684\u200b\u3002</p> <p>printk\u200b\u51fd\u6570\u8c03\u7528\u200b\u7684\u200b\u5b50\u51fd\u6570\u200b\u7684\u200b\u4e3b\u8981\u200b\u8109\u843d\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>printk\n    // linux 4.9: kernel/printk/internal.h\n    // linux 5.4: kernel/printk/printk_safe.c\n    vprintk_func \n        vprintk_default(fmt, args);\n            vprintk_emit\n                vprintk_store // \u200b\u628a\u200b\u8981\u200b\u6253\u5370\u200b\u7684\u200b\u4fe1\u606f\u200b\u4fdd\u5b58\u200b\u5728\u200blog_buf\u200b\u4e2d\u200b\n                    log_output\n\n                preempt_disable();\n                if (console_trylock_spinning())\n                    console_unlock();\n                preempt_enable();\n\nconsole_unlock\n    for (;;) {\n\n        msg = log_from_idx(console_idx);\n        if (suppress_message_printing(msg-&gt;level)) {\n            /* \u200b\u5982\u679c\u200b\u6d88\u606f\u200b\u7684\u200b\u7ea7\u522b\u200b\u6570\u503c\u200b\u5927\u4e8e\u200bconsole_loglevel, \u200b\u5219\u200b\u4e0d\u200b\u6253\u5370\u200b\u6b64\u200b\u4fe1\u606f\u200b */\n        }\n\n        printk_safe_enter_irqsave(flags);\n        call_console_drivers(ext_text, ext_len, text, len);\n        printk_safe_exit_irqrestore(flags);\n    }\n</code></pre> <p>call_console_drivers\u200b\u51fd\u6570\u8c03\u7528\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6253\u5370\u4fe1\u606f\u200b\uff0c\u200b\u6b64\u200b\u51fd\u6570\u200b\u5728\u200b<code>kernel\\printk\\printk.c</code>\u200b\u4e2d\u200b\uff0c\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"09_UART/17_1/#22","title":"2.2 \u200b\u5185\u6838\u200b\u6253\u5370\u4fe1\u606f\u200b\u4fdd\u5b58\u200b\u5728\u200b\u54ea","text":"<p>\u200b\u6211\u4eec\u200b\u6267\u884c\u200b<code>dmesg</code>\u200b\u547d\u4ee4\u200b\u53ef\u4ee5\u200b\u6253\u5370\u200b\u4ee5\u524d\u200b\u7684\u200b\u5185\u6838\u200b\u4fe1\u606f\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8fd9\u4e9b\u200b\u4fe1\u606f\u200b\u5fc5\u5b9a\u200b\u662f\u200b\u4fdd\u5b58\u200b\u5728\u200b\u5185\u6838\u200bbuffer\u200b\u4e2d\u200b\u3002</p> <p>\u200b\u5728\u200b<code>kernel\\printk\\printk.c</code>\u200b\u4e2d\u200b\uff0c\u200b\u5b9a\u4e49\u200b\u6709\u200b\u4e00\u4e2a\u200b\u5168\u5c40\u200bbuffer\uff1a</p> <p></p> <p>\u200b\u6267\u884c\u200b<code>dmesg</code>\u200b\u547d\u4ee4\u200b\u65f6\u200b\uff0c\u200b\u5b83\u200b\u5c31\u662f\u200b\u8bbf\u95ee\u200b\u865a\u62df\u200b\u6587\u4ef6\u200b<code>/proc/kmsg</code>\uff0c\u200b\u628a\u200blog_buf\u200b\u4e2d\u200b\u7684\u200b\u4fe1\u606f\u200b\u6253\u5370\u200b\u51fa\u6765\u200b\u3002</p>"},{"location":"09_UART/17_1/#23-printk","title":"2.3 printk\u200b\u4fe1\u606f\u200b\u4ece\u200b\u54ea\u4e9b\u200b\u8bbe\u5907\u200b\u6253\u5370\u200b\u51fa\u6765\u200b\uff1f","text":"<p>\u200b\u5728\u200b\u5185\u6838\u200b\u7684\u200b\u542f\u52a8\u200b\u4fe1\u606f\u200b\u4e2d\u200b\uff0c\u200b\u6709\u200b\u7c7b\u4f3c\u200b\u8fd9\u6837\u200b\u7684\u200b\u547d\u4ee4\u884c\u200b\u53c2\u6570\u200b\uff1a</p> <pre><code>/* IMX6ULL */\n[root@100ask:~]# cat /proc/cmdline\nconsole=ttymxc0,115200 root=/dev/mmcblk1p2 rootwait rw\n\n/* STM32MP157 */\n[root@100ask:~]# cat /proc/cmdline\nroot=PARTUUID=491f6117-415d-4f53-88c9-6e0de54deac6 rootwait rw console=ttySTM0,115200\n</code></pre> <p>\u200b\u5728\u200b\u547d\u4ee4\u884c\u200b\u53c2\u6570\u200b\u4e2d\u200b\uff0c\"console=ttymxc0\"\u3001\"console=ttySTM0\"\u200b\u5c31\u662f\u200b\u7528\u6765\u200b\u9009\u62e9\u200bprintk\u200b\u8bbe\u5907\u200b\u7684\u200b\u3002</p> <p>\u200b\u53ef\u4ee5\u200b\u6307\u5b9a\u200b\u591a\u4e2a\u200b\"console=\"\u200b\u53c2\u6570\u200b\uff0c\u200b\u8868\u793a\u200b\u4ece\u200b\u591a\u4e2a\u200b\u8bbe\u5907\u200b\u6253\u5370\u4fe1\u606f\u200b\u3002</p> <p>\u200b\u547d\u4ee4\u884c\u200b\u4fe1\u606f\u200b\u6765\u81ea\u200b\u54ea\u91cc\u200b\uff1f</p> <ul> <li>\u200b\u8bbe\u5907\u200b\u6811\u200b</li> </ul> <pre><code>/ {\n  chosen {\n                bootargs = \"console=ttymxc1,115200\";\n        };\n};\n</code></pre> <ul> <li>UBOOT\u200b\u6839\u636e\u200b\u73af\u5883\u53c2\u6570\u200b\u4fee\u6539\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1aIMX6ULL</li> </ul> <pre><code>/* \u200b\u8fdb\u5165\u200bIMX6ULL\u200b\u7684\u200bUBOOT */\n=&gt; print mmcargs\nmmcargs=setenv bootargs console=${console},${baudrate} root=${mmcroot}\n=&gt; print console\nconsole=ttymxc0\n=&gt; print baudrate\nbaudrate=115200\n</code></pre> <ul> <li>UBOOT\u200b\u4ece\u200b\u542f\u52a8\u200b\u6587\u4ef6\u200b\u4fee\u6539\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1aSTM32MP157</li> </ul> <pre><code>[root@100ask:~]# mount /dev/mmcblk2p2 /boot\n[root@100ask:~]# cd /boot\n[root@100ask:/boot]# cat mmc0_extlinux/stm32mp157c-100ask-512d-v1_extlinux.conf\n# Generic Distro Configuration file generated by OpenEmbedded\nmenu title Select the boot mode\nMENU BACKGROUND /splash.bmp\nTIMEOUT 20\nDEFAULT 100ask-lcd\nLABEL 100ask-core\n        KERNEL /uImage\n        FDT /stm32mp157c-100ask-512d-v1.dtb\n        INITRD /uInitrd\n        APPEND root=/dev/mmcblk1p5  rootwait rw console=ttySTM0,115200\nLABEL 100ask-hdmi\n        KERNEL /uImage\n        FDT /stm32mp157c-100ask-512d-hdmi-v1.dtb\n        INITRD /uInitrd\n        APPEND root=/dev/mmcblk1p5  rootwait rw console=ttySTM0,115200\nLABEL 100ask-lcd\n        KERNEL /uImage\n        FDT /stm32mp157c-100ask-512d-lcd-v1.dtb\n        INITRD /uInitrd\n        APPEND root=/dev/mmcblk1p5  rootwait rw console=ttySTM0,115200\n</code></pre>"},{"location":"09_UART/18_1/","title":"18_console\u200b\u9a71\u52a8\u200b\u6ce8\u518c\u200b\u8fc7\u7a0b","text":""},{"location":"09_UART/18_1/#console","title":"console\u200b\u9a71\u52a8\u200b\u6ce8\u518c\u200b\u8fc7\u7a0b","text":"<ul> <li> <p>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b</p> </li> <li> <p>Linux 4.9.88</p> <pre><code>kernel/printk.c\ninclude/linux/kernel.h\nkernel/printk/internal.h\ndrivers/tty/serial/imx.c\n</code></pre> </li> <li> <p>Linux 5.4</p> <pre><code>kernel/printk.c\ninclude/linux/kernel.h\nkernel/printk/printk_safe.c\ndrivers/tty/serial/stm32-usart.\n</code></pre> </li> </ul>"},{"location":"09_UART/18_1/#1-printk","title":"1.  \u200b\u56de\u987e\u200bprintk\u200b\u7684\u200b\u4f7f\u7528","text":""},{"location":"09_UART/18_1/#2-console","title":"2. console\u200b\u7ed3\u6784\u200b\u4f53\u200b\u5206\u6790","text":"<p><code>include\\linux\\console.h</code>:</p> <pre><code>struct console {\n    char    name[16];  // name\u200b\u4e3a\u200b\"ttyXXX\"\uff0c\u200b\u5728\u200bcmdline\u200b\u4e2d\u200b\u7528\u200b\"console=ttyXXX0\"\u200b\u6765\u200b\u5339\u914d\u200b\n\n    // \u200b\u8f93\u51fa\u200b\u51fd\u6570\u200b\n    void    (*write)(struct console *, const char *, unsigned);\n\n    int     (*read)(struct console *, char *, unsigned);\n\n    // APP\u200b\u8bbf\u95ee\u200b/dev/console\u200b\u65f6\u200b\u901a\u8fc7\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u6765\u200b\u786e\u5b9a\u200b\u662f\u200b\u54ea\u4e2a\u200b(index)\u200b\u8bbe\u5907\u200b\n    // \u200b\u4e3e\u4f8b\u200b:\n    // a. cmdline\u200b\u4e2d\u200b\"console=ttymxc1\"\n    // b. \u200b\u5219\u200b\u6ce8\u518c\u200b\u5bf9\u5e94\u200b\u7684\u200bconsole\u200b\u9a71\u52a8\u200b\u65f6\u200b\uff1aconsole-&gt;index = 1\n    // c. APP\u200b\u8bbf\u95ee\u200b/dev/console\u200b\u65f6\u200b\u8c03\u7528\u200b\"console-&gt;device\"\u200b\u6765\u200b\u8fd4\u56de\u200b\u8fd9\u4e2a\u200bindex\n    struct  tty_driver *(*device)(struct console *co, int *index);\n\n    void    (*unblank)(void);\n\n    // \u200b\u8bbe\u7f6e\u200b\u51fd\u6570\u200b, \u200b\u53ef\u8bbe\u200b\u4e3a\u200bNULL\n    int     (*setup)(struct console *, char *);\n\n    // \u200b\u5339\u914d\u200b\u51fd\u6570\u200b, \u200b\u53ef\u8bbe\u200b\u4e3a\u200bNULL\n    int     (*match)(struct console *, char *name, int idx, char *options); \n\n    short   flags;\n\n    // \u200b\u54ea\u4e2a\u200b\u8bbe\u5907\u200b\u7528\u4f5c\u200bconsole: \n    // a. \u200b\u53ef\u4ee5\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b-1, \u200b\u8868\u793a\u200b\u7531\u200bcmdline\u200b\u786e\u5b9a\u200b\n    // b. \u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u76f4\u63a5\u200b\u6307\u5b9a\u200b\n    short   index;\n\n    // \u200b\u5e38\u7528\u200b: CON_PRINTBUFFER\n    int     cflag;\n    void    *data;\n    struct   console *next;\n};\n</code></pre>"},{"location":"09_UART/18_1/#3-console","title":"3. console\u200b\u9a71\u52a8\u200b\u6ce8\u518c\u200b\u8fc7\u7a0b","text":""},{"location":"09_UART/18_1/#31","title":"3.1 \u200b\u5904\u7406\u200b\u547d\u4ee4\u884c\u200b\u53c2\u6570","text":"<p>\u200b\u5728\u200b<code>kernel\\printk\\printk.c</code>\u200b\u4e2d\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>__setup(\"console=\", console_setup);\n</code></pre> <p>\u200b\u8fd9\u662f\u200b\u7528\u6765\u200b\u5904\u7406\u200bu-boot\u200b\u901a\u8fc7\u200b\u8bbe\u5907\u200b\u6811\u200b\u4f20\u7ed9\u200b\u5185\u6838\u200b\u7684\u200bcmdline\u200b\u53c2\u6570\u200b\uff0c\u200b\u6bd4\u5982\u200bcmdline\u200b\u4e2d\u6709\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>console=ttymxc0,115200  console=ttyVIRT0\n</code></pre> <p>\u200b\u5bf9\u4e8e\u200b\u8fd9\u200b\u4e24\u4e2a\u200b\"console=xxx\"\u200b\u5c31\u200b\u4f1a\u200b\u8c03\u7528\u200bconsole_setup\u200b\u51fd\u6570\u200b\u4e24\u6b21\u200b\uff0c\u200b\u6784\u9020\u200b\u5f97\u5230\u200b2\u200b\u4e2a\u200b\u6570\u7ec4\u200b\u9879\u200b\uff1a</p> <pre><code>struct console_cmdline\n{\n    char    name[16];           /* Name of the driver       */\n    int index;              /* Minor dev. to use        */\n    char    *options;           /* Options for the driver   */\n#ifdef CONFIG_A11Y_BRAILLE_CONSOLE\n    char    *brl_options;           /* Options for braille driver */\n#endif\n};\n\nstatic struct console_cmdline console_cmdline[MAX_CMDLINECONSOLES];\n</code></pre> <p>\u200b\u5728\u200bcmdline\u200b\u4e2d\u200b\uff0c\u200b\u6700\u540e\u200b\u7684\u200b\"console=xxx\"\u200b\u5c31\u662f\u200b\"selected_console\"(\u200b\u88ab\u200b\u9009\u4e2d\u200b\u7684\u200bconsole\uff0c\u200b\u5bf9\u5e94\u200b/dev/console)\uff1a</p> <p></p>"},{"location":"09_UART/18_1/#32-register_console","title":"3.2 register_console","text":"<p>console\u200b\u5206\u4e3a\u200b\u4e24\u7c7b\u200b\uff0c\u200b\u5b83\u4eec\u200b\u901a\u8fc7\u200bconsole\u200b\u7ed3\u6784\u200b\u4f53\u200b\u7684\u200bflags\u200b\u6765\u200b\u5206\u8fa8\u200b(flags\u200b\u4e2d\u200b\u542b\u6709\u200bCON_BOOT)\uff1a</p> <ul> <li>bootconsoles\uff1a\u200b\u7528\u6765\u200b\u6253\u5370\u200b\u5f88\u65e9\u200b\u7684\u200b\u4fe1\u606f\u200b</li> <li>real consoles\uff1a\u200b\u771f\u6b63\u200b\u7684\u200bconsole</li> </ul> <p>\u200b\u53ef\u4ee5\u200b\u6ce8\u518c\u200b\u5f88\u591a\u200b\u7684\u200bbootconsoles\uff0c\u200b\u4f46\u662f\u200b\u4e00\u65e6\u200b\u6ce8\u518c\u200b<code>real consoles</code>\u200b\u65f6\u200b\uff0c\u200b\u6240\u6709\u200b\u7684\u200bbootconsoles\u200b\u90fd\u200b\u4f1a\u200b\u88ab\u200b\u6ce8\u9500\u200b\uff0c\u200b\u5e76\u4e14\u200b\u4ee5\u540e\u200b\u518d\u200b\u6ce8\u518c\u200bbootconsoles\u200b\u90fd\u200b\u4e0d\u4f1a\u200b\u6210\u529f\u200b\u3002</p> <p>\u200b\u88ab\u200b\u6ce8\u518c\u200b\u7684\u200bconsole\u200b\u4f1a\u200b\u653e\u5728\u200bconsole_drivers\u200b\u94fe\u8868\u200b\u4e2d\u200b\uff0c\u200b\u8c01\u200b\u653e\u5728\u200b\u94fe\u8868\u200b\u5934\u90e8\u200b\uff1f</p> <ul> <li>\u200b\u5982\u679c\u200b\u53ea\u6709\u200b\u4e00\u4e2a\u200b<code>real consoles</code>\uff0c\u200b\u5b83\u200b\u81ea\u7136\u200b\u662f\u200b\u653e\u5728\u200b\u94fe\u8868\u200b\u5934\u90e8\u200b</li> <li>\u200b\u5982\u679c\u200b\u6709\u200b\u591a\u4e2a\u200b<code>real consoles</code>\uff0c\"selected_console\"(\u200b\u88ab\u200b\u9009\u4e2d\u200b\u7684\u200bconsole)\u200b\u88ab\u200b\u653e\u5728\u200b\u94fe\u8868\u200b\u5934\u90e8\u200b</li> </ul> <p>\u200b\u653e\u5728\u200b\u94fe\u8868\u200b\u5934\u6709\u200b\u4ec0\u4e48\u200b\u597d\u5904\u200b\uff1fAPP\u200b\u6253\u5f00\u200b\"/dev/console\"\u200b\u65f6\u200b\uff0c\u200b\u5c31\u200b\u5bf9\u5e94\u200b\u5b83\u200b\u3002</p> <pre><code>uart_add_one_port\n    uart_configure_port\n        register_console(port-&gt;cons);\n</code></pre>"},{"location":"09_UART/18_1/#33-devconsole","title":"3.3 /dev/console","text":"<p>\u200b\u5728\u200b<code>drivers\\tty\\tty_io.c</code>\u200b\u4e2d\u200b\uff0c\u200b\u4ee3\u7801\u200b\u8c03\u7528\u200b\u8fc7\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>tty_open\n    tty = tty_open_by_driver(device, inode, filp);\n        driver = tty_lookup_driver(device, filp, &amp;index);\n            case MKDEV(TTYAUX_MAJOR, 1): {\n                struct tty_driver *console_driver = console_device(index);\n\n\n/* \u200b\u4ece\u200bconsole_drivers\u200b\u94fe\u8868\u200b\u5934\u200b\u5f00\u59cb\u200b\u5bfb\u627e\u200b\n * \u200b\u5982\u679c\u200bconsole-&gt;device\u200b\u6210\u529f\u200b\uff0c\u200b\u5c31\u200b\u8fd4\u56de\u200b\u5b83\u200b\u5bf9\u5e94\u200b\u7684\u200btty_driver\n * \u200b\u8fd9\u200b\u5c31\u662f\u200b/dev/console\u200b\u5bf9\u5e94\u200b\u7684\u200btty_driver\n */ \nstruct tty_driver *console_device(int *index)\n{\n    struct console *c;\n    struct tty_driver *driver = NULL;\n\n    console_lock();\n    for_each_console(c) {\n        if (!c-&gt;device)\n            continue;\n        driver = c-&gt;device(c, index);\n        if (driver)\n            break;\n    }\n    console_unlock();\n    return driver;\n}\n</code></pre>"},{"location":"09_UART/19_1/","title":"19_\u200b\u7f16\u5199\u200bconsole\u200b\u9a71\u52a8","text":""},{"location":"09_UART/19_1/#console","title":"\u7f16\u5199\u200bconsole\u200b\u9a71\u52a8","text":"<ul> <li> <p>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b</p> </li> <li> <p>Linux 4.9.88</p> <pre><code>kernel/printk.c\ninclude/linux/kernel.h\nkernel/printk/internal.h\ndrivers/tty/serial/imx.c\n</code></pre> </li> <li> <p>Linux 5.4</p> <pre><code>kernel/printk.c\ninclude/linux/kernel.h\nkernel/printk/printk_safe.c\ndrivers/tty/serial/stm32-usart.\n</code></pre> </li> <li> <p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u914d\u5957\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff0c\u200b\u76ee\u5f55\u200b\u5982\u4e0b\u200b</p> </li> </ul> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\source\\09_UART\\\n  08_virtual_uart_driver_console\n\ndoc_and_source_for_drivers\\STM32MP157\\source\\A7\\09_UART\\\n  08_virtual_uart_driver_console\n</code></pre>"},{"location":"09_UART/19_1/#1-printk","title":"1.  \u200b\u56de\u987e\u200bprintk\u200b\u7684\u200b\u4f7f\u7528","text":""},{"location":"09_UART/19_1/#2-console","title":"2. console\u200b\u7ed3\u6784\u200b\u4f53\u200b\u5206\u6790","text":"<p><code>include\\linux\\console.h</code>:</p> <pre><code>struct console {\n    char    name[16];  // name\u200b\u4e3a\u200b\"ttyXXX\"\uff0c\u200b\u5728\u200bcmdline\u200b\u4e2d\u200b\u7528\u200b\"console=ttyXXX0\"\u200b\u6765\u200b\u5339\u914d\u200b\n\n    // \u200b\u8f93\u51fa\u200b\u51fd\u6570\u200b\n    void    (*write)(struct console *, const char *, unsigned);\n\n    int     (*read)(struct console *, char *, unsigned);\n\n    // APP\u200b\u8bbf\u95ee\u200b/dev/console\u200b\u65f6\u200b\u901a\u8fc7\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u6765\u200b\u786e\u5b9a\u200b\u662f\u200b\u54ea\u4e2a\u200b(index)\u200b\u8bbe\u5907\u200b\n    // \u200b\u4e3e\u4f8b\u200b:\n    // a. cmdline\u200b\u4e2d\u200b\"console=ttymxc1\"\n    // b. \u200b\u5219\u200b\u6ce8\u518c\u200b\u5bf9\u5e94\u200b\u7684\u200bconsole\u200b\u9a71\u52a8\u200b\u65f6\u200b\uff1aconsole-&gt;index = 1\n    // c. APP\u200b\u8bbf\u95ee\u200b/dev/console\u200b\u65f6\u200b\u8c03\u7528\u200b\"console-&gt;device\"\u200b\u6765\u200b\u8fd4\u56de\u200b\u8fd9\u4e2a\u200bindex\n    struct  tty_driver *(*device)(struct console *co, int *index);\n\n    void    (*unblank)(void);\n\n    // \u200b\u8bbe\u7f6e\u200b\u51fd\u6570\u200b, \u200b\u53ef\u8bbe\u200b\u4e3a\u200bNULL\n    int     (*setup)(struct console *, char *);\n\n    // \u200b\u5339\u914d\u200b\u51fd\u6570\u200b, \u200b\u53ef\u8bbe\u200b\u4e3a\u200bNULL\n    int     (*match)(struct console *, char *name, int idx, char *options); \n\n    short   flags;\n\n    // \u200b\u54ea\u4e2a\u200b\u8bbe\u5907\u200b\u7528\u4f5c\u200bconsole: \n    // a. \u200b\u53ef\u4ee5\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b-1, \u200b\u8868\u793a\u200b\u7531\u200bcmdline=ttyVIRT0\u200b\u786e\u5b9a\u200b\n    // b. \u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u76f4\u63a5\u200b\u6307\u5b9a\u200b\n    short   index;\n\n    // \u200b\u5e38\u7528\u200b: CON_PRINTBUFFER\n    int     cflag;\n    void    *data;\n    struct   console *next;\n};\n</code></pre>"},{"location":"09_UART/19_1/#3-console","title":"3. \u200b\u7f16\u5199\u200bconsole\u200b\u9a71\u52a8","text":"<pre><code>/*\n * Interrupts are disabled on entering\n */\nstatic void virt_uart_console_write(struct console *co, const char *s, unsigned int count)\n{\n    int i;\n    for (i = 0; i &lt; count; i++)\n        if (txbuf_put(s[i]) != 0)\n            return;\n}\n\nstatic struct console virt_uart_console = {\n    .name       = \"ttyVIRT\",\n    .write      = virt_uart_console_write,\n    .device     = uart_console_device,\n    .flags      = CON_PRINTBUFFER,\n    .index      = -1,\n};\n\nstatic struct uart_driver virt_uart_drv = {\n    .owner          = THIS_MODULE,\n    .driver_name    = \"VIRT_UART\",\n    .dev_name       = \"ttyVIRT\",\n    .major          = 0,\n    .minor          = 0,\n    .nr             = 1,\n    .cons           = virt_uart_console,\n};\n</code></pre>"},{"location":"09_UART/19_1/#4","title":"4. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":""},{"location":"09_UART/19_1/#41","title":"4.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":""},{"location":"09_UART/19_1/#1-stm32mp157","title":"1. STM32MP157","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"09_UART/19_1/#2-imx6ull","title":"2. IMX6ULL","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/gcc-linaro-6.2.1-2016.11-x86_64_arm-linux-gnueabihf/bin\n</code></pre>"},{"location":"09_UART/19_1/#42","title":"4.2 \u200b\u7f16\u8bd1\u200b\u9a71\u52a8","text":""},{"location":"09_UART/19_1/#43-cmdline","title":"4.3 \u200b\u4fee\u6539\u200bcmdline","text":""},{"location":"09_UART/19_1/#1-imx6ull","title":"1. IMX6ULL","text":"<pre><code>\u200b\u5728\u200buboot\u200b\u6267\u884c\u200b:\nsetenv mmcargs setenv bootargs console=${console},${baudrate} root=${mmcroot} console=ttyVIRT0\nboot\n\n\u200b\u542f\u52a8\u200blinux\u200b\u540e\u200b\u786e\u8ba4\u200b:\ncat /proc/cmdline\n\n\u200b\u5b89\u88c5\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b:\necho \"7 4 1 7\" &gt; /proc/sys/kernel/printk\ninsmod virtual_uart.ko\ncat /proc/consoles  /* \u200b\u786e\u8ba4\u200b\u6709\u6ca1\u6709\u200bttyVIRT0 */\n\ncat /proc/virt_uart_buf  /* \u200b\u67e5\u770b\u200b\u4fe1\u606f\u200b */\n\necho hello &gt; /dev/console\ncat /proc/virt_uart_buf  /* \u200b\u67e5\u770b\u200b\u4fe1\u606f\u200b */\n</code></pre>"},{"location":"09_UART/19_1/#2-stm32mp157","title":"2. STM32MP157","text":"<pre><code>mount /dev/mmcblk2p2 /boot\n\n\u200b\u4fee\u6539\u200b/boot/mmc0_extlinux/\u200b\u548c\u200b/boot/mmc1_extlinux\u200b\u4e0b\u200b\u7684\u200b\u914d\u7f6e\u6587\u4ef6\u200b\uff0c\n\u200b\u914d\u7f6e\u6587\u4ef6\u200b\u91cc\u200b\u7684\u200b\"APPEND\"\u200b\u8868\u793a\u200bcmdline\u200b\u4fe1\u606f\u200b,\n\u200b\u5728\u200b\"APPEND\"\u200b\u884c\u672b\u200b\" console=ttyVIRT0\",\n\u200b\u5728\u200b\u4e09\u4e2a\u200b\"APPEND\"\u200b\u8bed\u53e5\u200b\u4e2d\u200b\u90fd\u200b\u6dfb\u52a0\u200b\n\n\n\u200b\u542f\u52a8\u200blinux\u200b\u540e\u200b\u786e\u8ba4\u200b:\ncat /proc/cmdline\n\n\u200b\u5b89\u88c5\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b:\ninsmod virtual_uart.ko\ncat /proc/consoles  /* \u200b\u786e\u8ba4\u200b\u6709\u6ca1\u6709\u200bttyVIRT0 */\n\ncat /proc/virt_uart_buf  /* \u200b\u67e5\u770b\u200b\u4fe1\u606f\u200b */\n\necho hello &gt; /dev/console\ncat /proc/virt_uart_buf  /* \u200b\u67e5\u770b\u200b\u4fe1\u606f\u200b */\n</code></pre>"},{"location":"09_UART/20_1/","title":"20_early_printk\u200b\u548c\u200bearlycon","text":""},{"location":"09_UART/20_1/#early_printkearlycon","title":"early_printk\u200b\u548c\u200bearlycon","text":"<ul> <li> <p>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b</p> </li> <li> <p>Linux 4.9.88</p> <pre><code>arch\\arm\\kernel\\early_printk.c\ndrivers\\tty\\serial\\earlycon.c\n</code></pre> </li> <li> <p>Linux 5.4</p> <pre><code>arch\\arm\\kernel\\early_printk.c\ndrivers\\tty\\serial\\earlycon.c\n</code></pre> </li> </ul>"},{"location":"09_UART/20_1/#1-printk","title":"1.  \u200b\u56de\u987e\u200bprintk\u200b\u7684\u200b\u4f7f\u7528","text":""},{"location":"09_UART/20_1/#2","title":"2. \u200b\u5185\u6838\u200b\u4fe1\u606f\u200b\u7684\u200b\u65e9\u671f\u200b\u6253\u5370","text":"<p>\u200b\u5728\u200b\u4e0a\u8282\u200b\u89c6\u9891\u200b\u91cc\u200b\u6211\u4eec\u200b\u5b9e\u73b0\u200b\u4e86\u200bconsole\u200b\u9a71\u52a8\u200b\uff0c\u200b\u5b83\u200b\u5c5e\u4e8e\u200buart_driver\u200b\u7684\u200b\u4e00\u90e8\u5206\u200b\u3002</p> <p>\u200b\u6ce8\u518c\u200b\u4e86\u200buart_driver\u3001\u200b\u5e76\u200b\u8c03\u7528\u200buart_add_one_port\u200b\u540e\u200b\uff0c\u200b\u5b83\u200b\u91cc\u9762\u200b\u624d\u200b\u6ce8\u518c\u200bconsole\uff0c\u200b\u5728\u200b\u8fd9\u200b\u4e4b\u540e\u200b\u624d\u80fd\u200b\u4f7f\u7528\u200bprintk\u3002</p> <p>\u200b\u5982\u679c\u200b\u60f3\u200b\u66f4\u200b\u65e9\u200b\u5730\u200b\u4f7f\u7528\u200bprintk\u200b\u51fd\u6570\u200b\uff0c\u200b\u6bd4\u5982\u200b\u5728\u200b\u5b89\u88c5\u200bUART\u200b\u9a71\u52a8\u200b\u4e4b\u524d\u200b\u5c31\u200b\u4f7f\u7528\u200bprintk\uff0c\u200b\u8fd9\u65f6\u200b\u5c31\u200b\u9700\u8981\u200b\u81ea\u5df1\u200b\u53bb\u200b\u6ce8\u518c\u200bconsole\u3002</p> <p>\u200b\u66f4\u200b\u65e9\u200b\u5730\u200b\u3001\u200b\u5355\u72ec\u200b\u5730\u200b\u6ce8\u518c\u200bconsole\uff0c\u200b\u6709\u200b\u4e24\u79cd\u200b\u65b9\u6cd5\u200b\uff1a</p> <ul> <li>early_printk\uff1a\u200b\u81ea\u5df1\u200b\u5b9e\u73b0\u200bwrite\u200b\u51fd\u6570\u200b\uff0c\u200b\u4e0d\u200b\u6d89\u53ca\u200b\u8bbe\u5907\u200b\u6811\u200b\uff0c\u200b\u7b80\u5355\u660e\u4e86\u200b</li> <li>earlycon\uff1a\u200b\u901a\u8fc7\u200b\u8bbe\u5907\u200b\u6811\u200b\u4f20\u5165\u200b\u786c\u4ef6\u200b\u4fe1\u606f\u200b\uff0c\u200b\u8ddf\u200b\u5185\u6838\u200b\u4e2d\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5339\u914d\u200b</li> </ul> <p>earlycon\u200b\u662f\u200b\u65b0\u200b\u7684\u200b\u3001\u200b\u63a8\u8350\u200b\u7684\u200b\u65b9\u6cd5\u200b\uff0c\u200b\u5728\u200b\u5185\u6838\u200b\u5df2\u7ecf\u200b\u6709\u200b\u9a71\u52a8\u200b\u7684\u200b\u524d\u63d0\u200b\u4e0b\u200b\uff0c\u200b\u901a\u8fc7\u200b\u8bbe\u5907\u200b\u6811\u200b\u6216\u200bcmdline\u200b\u6307\u5b9a\u200b\u5bc4\u5b58\u5668\u200b\u5730\u5740\u200b\u5373\u53ef\u200b\u3002</p>"},{"location":"09_UART/20_1/#3-early_printk","title":"3. early_printk","text":"<p>\u200b\u6e90\u7801\u200b\u4e3a\u200b\uff1a<code>arch\\arm\\kernel\\early_printk.c</code>\uff0c\u200b\u8981\u200b\u4f7f\u7528\u200b\u5b83\u200b\uff0c\u200b\u5fc5\u987b\u200b\u5b9e\u73b0\u200b\u8fd9\u200b\u51e0\u70b9\u200b\uff1a</p> <ul> <li>\u200b\u914d\u7f6e\u200b\u5185\u6838\u200b\uff0c\u200b\u9009\u62e9\u200b\uff1aCONFIG_EARLY_PRINTK</li> <li>\u200b\u5185\u6838\u200b\u4e2d\u200b\u5b9e\u73b0\u200b\uff1aprintch\u200b\u51fd\u6570\u200b</li> <li>cmdline\u200b\u4e2d\u200b\u6dfb\u52a0\u200b\uff1aearlyprintk</li> </ul> <p></p>"},{"location":"09_UART/20_1/#4-earlycon","title":"4. earlycon","text":""},{"location":"09_UART/20_1/#41-2","title":"4.1 \u200b\u63d0\u4f9b\u200b\u786c\u4ef6\u200b\u4fe1\u606f\u200b\u7684\u200b2\u200b\u79cd\u200b\u65b9\u6cd5","text":"<p>earlycon\u200b\u5c31\u662f\u200bearly console\u200b\u7684\u200b\u610f\u601d\u200b\uff0c\u200b\u5b9e\u73b0\u200b\u7684\u200b\u529f\u80fd\u200b\u8ddf\u200bearlyprintk\u200b\u662f\u200b\u4e00\u6837\u200b\u7684\u200b\uff0c\u200b\u53ea\u662f\u200b\u66f4\u200b\u7075\u6d3b\u200b\u3002</p> <p>\u200b\u6211\u4eec\u200b\u77e5\u9053\u200b\uff0c\u200b\u5bf9\u4e8e\u200bconsole\uff0c\u200b\u6700\u200b\u4e3b\u8981\u200b\u7684\u200b\u662f\u200b\u91cc\u9762\u200b\u7684\u200bwrite\u200b\u51fd\u6570\u200b\uff1a\u200b\u5b83\u200b\u4e0d\u200b\u4f7f\u7528\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u76f8\u5bf9\u200b\u7b80\u5355\u200b\u3002</p> <p>\u200b\u6240\u4ee5\u200b\u5f88\u591a\u200b\u4e32\u53e3\u200bconsole\u200b\u7684\u200bwrite\u200b\u51fd\u6570\u200b\uff0c\u200b\u53ea\u8981\u200b\u786e\u5b9a\u200b\u5bc4\u5b58\u5668\u200b\u7684\u200b\u5730\u5740\u200b\u5c31\u200b\u5f88\u200b\u5bb9\u6613\u200b\u5b9e\u73b0\u200b\u4e86\u200b\u3002</p> <p>\u200b\u5047\u8bbe\u200b\u82af\u7247\u200b\u7684\u200b\u4e32\u53e3\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u5df2\u7ecf\u200b\u5728\u200b\u5185\u6838\u200b\u91cc\u200b\u5b9e\u73b0\u200b\u4e86\u200b\uff0c\u200b\u6211\u4eec\u200b\u9700\u8981\u200b\u6839\u636e\u200b\u677f\u5b50\u200b\u7684\u200b\u914d\u7f6e\u200b\u7ed9\u200b\u5b83\u200b\u63d0\u4f9b\u200b\u5bc4\u5b58\u5668\u200b\u5730\u5740\u200b\u3002</p> <p>\u200b\u600e\u4e48\u200b\u63d0\u4f9b\u200b\uff1f</p> <ul> <li>\u200b\u8bbe\u5907\u200b\u6811\u200b</li> <li>cmdline\u200b\u53c2\u6570\u200b</li> </ul> <p></p>"},{"location":"09_UART/20_1/#42-write","title":"4.2 \u200b\u8bbe\u7f6e\u200bwrite\u200b\u51fd\u6570","text":"<p>\u200b\u5728\u200bLinux\u200b\u5185\u6838\u200b\u4e2d\u200b\uff0c\u200b\u5df2\u7ecf\u200b\u6709\u200b\u5b8c\u5584\u200b\u7684\u200bearlycon\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u5b83\u4eec\u200b\u4f7f\u7528\u200bOF_EARLYCON_DECLARE\u200b\u5b8f\u6765\u200b\u5b9a\u4e49\u200b\uff1a</p> <p></p> <p>\u200b\u95ee\u9898\u200b\u5728\u4e8e\u200b\uff0c\u200b\u4f7f\u7528\u200b\u54ea\u200b\u4e00\u4e2a\u200b\uff1f</p> <ul> <li> <p>\u200b\u5982\u679c\u200bcmdline\u200b\u4e2d\u200b\u53ea\u6709\u200b\"earlycon\"\uff0c\u200b\u4e0d\u5e26\u200b\u66f4\u200b\u591a\u200b\u53c2\u6570\u200b\uff1a\u200b\u5bf9\u5e94\u200b<code>early_init_dt_scan_chosen_stdout</code>\u200b\u51fd\u6570\u200b</p> </li> <li> <p>\u200b\u4f7f\u7528\u200b\"/chosen\"\u200b\u4e0b\u200b\u7684\u200b\"stdout-path\"\u200b\u627e\u5230\u200b\u8282\u70b9\u200b</p> </li> <li> <p>\u200b\u6216\u200b\u4f7f\u7528\u200b\"/chosen\"\u200b\u4e0b\u200b\u7684\u200b\"linux,stdout-path\"\u200b\u627e\u5230\u200b\u8282\u70b9\u200b</p> </li> <li> <p>\u200b\u8282\u70b9\u200b\u91cc\u200b\u6709\u200b\"compatible\"\u200b\u548c\u200b\"reg\"\u200b\u5c5e\u6027\u200b</p> <ul> <li>\u200b\u6839\u636e\u200b\"compatible\"\u200b\u627e\u5230\u200b<code>OF_EARLYCON_DECLARE</code>\uff0c\u200b\u91cc\u9762\u200b\u6709\u200bsetup\u200b\u51fd\u6570\u200b\uff0c\u200b\u5b83\u4f1a\u200b\u63d0\u4f9b\u200bwrite\u200b\u51fd\u6570\u200b</li> <li>write\u200b\u51fd\u6570\u200b\u5199\u200b\u4ec0\u4e48\u200b\u5bc4\u5b58\u5668\u200b\uff1f\u200b\u5728\u200b\"reg\"\u200b\u5c5e\u6027\u200b\u91cc\u200b\u786e\u5b9a\u200b</li> </ul> </li> <li> <p>\u200b\u5982\u679c\u200bcmdline\u200b\u4e2d\u200b\"earlycon=xxx\"\uff0c\u200b\u5e26\u6709\u200b\u66f4\u200b\u591a\u200b\u53c2\u6570\u200b\uff1a\u200b\u5bf9\u5e94\u200b<code>setup_earlycon</code>\u200b\u51fd\u6570\u200b</p> </li> <li> <p>earlycon=xxx\u200b\u683c\u5f0f\u200b\u4e3a\u200b\uff1a</p> <p><code>shell   &lt;name&gt;,io|mmio|mmio32|mmio32be,&lt;addr&gt;,&lt;options&gt; &lt;name&gt;,0x&lt;addr&gt;,&lt;options&gt; &lt;name&gt;,&lt;options&gt; &lt;name&gt;</code></p> </li> <li> <p>\u200b\u6839\u636e\u200b\"name\"\u200b\u627e\u5230\u200b<code>OF_EARLYCON_DECLARE</code>\uff0c\u200b\u91cc\u9762\u200b\u6709\u200bsetup\u200b\u51fd\u6570\u200b\uff0c\u200b\u5b83\u4f1a\u200b\u63d0\u4f9b\u200bwrite\u200b\u51fd\u6570\u200b</p> </li> <li> <p>write\u200b\u51fd\u6570\u200b\u5199\u200b\u4ec0\u4e48\u200b\u5bc4\u5b58\u5668\u200b\uff1f\u200b\u5728\u200b\"addr\"\u200b\u53c2\u6570\u200b\u91cc\u200b\u786e\u5b9a\u200b</p> </li> </ul>"},{"location":"09_UART/20_1/#43-register_console","title":"4.3 register_console","text":"<p>\u200b    </p> <p>\u200b    </p>"},{"location":"09_UART/21_1/","title":"21_RS485\u200b\u7b80\u5355\u200b\u8bb2\u89e3","text":""},{"location":"09_UART/21_1/#rs485","title":"RS485\u200b\u7b80\u5355\u200b\u8bb2\u89e3","text":"<ul> <li> <p>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b</p> </li> <li> <p>Linux 4.9.88</p> <pre><code>Documentation\\serial\\serial-rs485.txt\n</code></pre> </li> <li> <p>Linux 5.4</p> <pre><code>Documentation\\driver-api\\serial\\serial-rs485.rst\n</code></pre> </li> </ul>"},{"location":"09_UART/21_1/#1-rs485","title":"1.  RS485\u200b\u7ebf\u8def\u56fe","text":"<p>RS485\u200b\u4f7f\u7528\u200bA\u3001B\u200b\u4e24\u6761\u200b\u5dee\u5206\u200b\u7ebf\u200b\u4f20\u8f93\u6570\u636e\u200b\uff1a</p> <ul> <li>\u200b\u8981\u200b\u53d1\u9001\u6570\u636e\u200b\u65f6\u200b</li> <li>\u200b\u628a\u200bSP3485\u200b\u7684\u200bDE(Driver output Enable)\u200b\u5f15\u811a\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b\u9ad8\u200b</li> <li>\u200b\u901a\u8fc7\u200bTxD\u200b\u5f15\u811a\u200b\u53d1\u9001\u200b<code>1</code>\u200b\u7ed9\u200bSP3485\uff0cSP3485\u200b\u4f1a\u200b\u9a71\u52a8\u200bA\u3001B\u200b\u5f15\u811a\u200b\u7535\u538b\u200b\u5dee\u4e3a\u200b<code>+2~+6V</code></li> <li>\u200b\u901a\u8fc7\u200bTxD\u200b\u5f15\u811a\u200b\u53d1\u9001\u200b<code>0</code>\u200b\u7ed9\u200bSP3485\uff0cSP3485\u200b\u4f1a\u200b\u9a71\u52a8\u200bA\u3001B\u200b\u5f15\u811a\u200b\u7535\u538b\u200b\u5dee\u4e3a\u200b<code>-6~-2V</code></li> <li>SP3485\u200b\u81ea\u52a8\u200b\u628a\u200bTxD\u200b\u4fe1\u53f7\u200b\u8f6c\u6362\u200b\u4e3a\u200bAB\u200b\u5dee\u5206\u200b\u4fe1\u53f7\u200b</li> <li>\u200b\u5bf9\u4e8e\u200b\u8f6f\u4ef6\u200b\u6765\u8bf4\u200b\uff0c\u200b\u901a\u8fc7\u200bRS485\u200b\u53d1\u9001\u6570\u636e\u200b\u65f6\u200b\uff0c\u200b\u8ddf\u200b\u4e00\u822c\u200b\u7684\u200b\u4e32\u53e3\u200b\u6ca1\u200b\u533a\u522b\u200b\uff0c\u200b\u53ea\u662f\u200b\u591a\u200b\u4e86\u200bDE\u200b\u5f15\u811a\u200b\u7684\u200b\u8bbe\u7f6e\u200b</li> <li>\u200b\u8981\u200b\u8bfb\u53d6\u6570\u636e\u200b\u65f6\u200b</li> <li>\u200b\u628a\u200bSP3485\u200b\u7684\u200bnRE(Receiver Output Enable)\u200b\u5f15\u811a\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b\u4f4e\u200b</li> <li>SP3485\u200b\u4f1a\u200b\u6839\u636e\u200bAB\u200b\u5f15\u811a\u200b\u7684\u200b\u7535\u538b\u200b\u5dee\u200b\u9a71\u52a8\u200bRO\u200b\u4e3a\u200b1\u200b\u6216\u200b0</li> <li>RO\u200b\u7684\u200b\u6570\u636e\u200b\u4f20\u5165\u200bUART\u200b\u7684\u200bRxD\u200b\u5f15\u811a\u200b</li> <li>\u200b\u5bf9\u4e8e\u200b\u8f6f\u4ef6\u200b\u6765\u8bf4\u200b\uff0c\u200b\u901a\u8fc7\u200bRS485\u200b\u8bfb\u53d6\u6570\u636e\u200b\u65f6\u200b\uff0c\u200b\u8ddf\u200b\u4e00\u822c\u200b\u7684\u200b\u4e32\u53e3\u200b\u6ca1\u200b\u533a\u522b\u200b\uff0c\u200b\u53ea\u662f\u200b\u591a\u200b\u4e86\u200bnRE\u200b\u5f15\u811a\u200b\u7684\u200b\u8bbe\u7f6e\u200b</li> <li>nRE\u200b\u548c\u200bDE\u200b\u4f7f\u7528\u200b\u540c\u4e00\u4e2a\u200b\u5f15\u811a\u200b\u65f6\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u7b80\u5316\u200b\u6210\u200b\u8fd9\u6837\u200b\uff1a</li> <li>\u200b\u53d1\u9001\u200b\uff1a\u200b\u8bbe\u7f6e\u200bDE\u200b\u4e3a\u200b\u9ad8\u200b\uff0c\u200b\u53d1\u9001\u200b\uff0c\u200b\u8bbe\u7f6e\u200bDE\u200b\u4e3a\u200b\u4f4e\u200b</li> <li>\u200b\u63a5\u6536\u200b\uff1a\u200b\u65e0\u9700\u200b\u7279\u6b8a\u200b\u8bbe\u7f6e\u200b</li> </ul> <p></p>"},{"location":"09_UART/21_1/#2-rs485","title":"2. RS485\u200b\u5e94\u7528\u200b\u7f16\u7a0b","text":""},{"location":"09_UART/21_1/#21","title":"2.1 \u200b\u6807\u51c6\u200b\u7528\u6cd5","text":"<p>\u200b\u5728\u200bLinux\u200b\u7684\u200b\u4e32\u53e3\u200b\u9a71\u52a8\u200b\u4e2d\u200b\uff0c\u200b\u5b83\u200b\u5df2\u7ecf\u200b\u652f\u6301\u200bRS485\uff0c\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200bRTS\u200b\u5f15\u811a\u200b\u63a7\u5236\u200bRS485\u200b\u82af\u7247\u200b\u7684\u200bDE\u200b\u5f15\u811a\u200b\uff0c\u200b\u5206\u200b\u4e24\u79cd\u200b\u60c5\u51b5\u200b</p> <ul> <li>\u200b\u6709\u4e9b\u200bUART\u200b\u9a71\u52a8\u200b\uff1a\u200b\u4f7f\u7528\u200bUART\u200b\u7684\u200bRTS\u200b\u5f15\u811a\u200b</li> <li>\u200b\u6709\u4e9b\u200bUART\u200b\u9a71\u52a8\u200b\uff1a\u200b\u4f7f\u7528\u200bGPIO\u200b\u4f5c\u4e3a\u200bRTS\u200b\u5f15\u811a\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200b\u8bbe\u5907\u200b\u6811\u200b\u6307\u5b9a\u200b\u8fd9\u4e2a\u200bGPIO</li> </ul> <p></p> <p>\u200b\u5728\u200b\u4f7f\u7528\u200bRS485\u200b\u53d1\u9001\u6570\u636e\u200b\u524d\u200b\uff0c\u200b\u628a\u200bRTS\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b\u9ad8\u7535\u5e73\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u3002</p> <p>\u200b\u901a\u8fc7\u200b<code>serial_rs485</code>\u200b\u7ed3\u6784\u200b\u4f53\u200b\u63a7\u5236\u200bRTS\uff0c\u200b\u793a\u4f8b\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>#include &lt;linux/serial.h&gt;\n\n/* \u200b\u7528\u5230\u200b\u8fd9\u200b2\u200b\u4e2a\u200bioctl: TIOCGRS485, TIOCSRS485 */\n#include &lt;sys/ioctl.h&gt;\n\nstruct serial_rs485 rs485conf;\n\n/* \u200b\u6253\u5f00\u200b\u4e32\u53e3\u200b\u8bbe\u5907\u200b */\nint fd = open (\"/dev/mydevice\", O_RDWR);\nif (fd &lt; 0) {\n    /* \u200b\u5931\u8d25\u200b\u5219\u200b\u8fd4\u56de\u200b */\n    return -1;\n}\n\n/* \u200b\u8bfb\u53d6\u200brs485conf */\nif (ioctl (fd, TIOCGRS485, &amp;rs485conf) &lt; 0) {\n    /* \u200b\u5904\u7406\u9519\u8bef\u200b */\n}\n\n/* \u200b\u4f7f\u80fd\u200bRS485\u200b\u6a21\u5f0f\u200b */\nrs485conf.flags |= SER_RS485_ENABLED;\n\n/* \u200b\u5f53\u200b\u53d1\u9001\u6570\u636e\u200b\u65f6\u200b, RTS\u200b\u4e3a\u200b1 */\nrs485conf.flags |= SER_RS485_RTS_ON_SEND;\n\n/* \u200b\u6216\u8005\u200b: \u200b\u5f53\u200b\u53d1\u9001\u6570\u636e\u200b\u65f6\u200b, RTS\u200b\u4e3a\u200b0 */\nrs485conf.flags &amp;= ~(SER_RS485_RTS_ON_SEND);\n\n/* \u200b\u5f53\u200b\u53d1\u9001\u200b\u5b8c\u200b\u6570\u636e\u200b\u540e\u200b, RTS\u200b\u4e3a\u200b1 */\nrs485conf.flags |= SER_RS485_RTS_AFTER_SEND;\n\n/* \u200b\u6216\u8005\u200b: \u200b\u5f53\u200b\u53d1\u9001\u200b\u5b8c\u200b\u6570\u636e\u200b\u540e\u200b, RTS\u200b\u4e3a\u200b0 */\nrs485conf.flags &amp;= ~(SER_RS485_RTS_AFTER_SEND);\n\n/* \u200b\u8fd8\u200b\u53ef\u4ee5\u200b\u8bbe\u7f6e\u200b: \n * \u200b\u53d1\u9001\u6570\u636e\u200b\u4e4b\u524d\u200b\u5148\u200b\u8bbe\u7f6e\u200bRTS\u200b\u4fe1\u53f7\u200b, \u200b\u7b49\u5f85\u200b\u4e00\u4f1a\u200b\u518d\u200b\u53d1\u9001\u6570\u636e\u200b\n * \u200b\u7b49\u200b\u591a\u4e45\u200b? delay_rts_before_send(\u200b\u5355\u4f4d\u200bms)\n */\nrs485conf.delay_rts_before_send = ...;\n\n/* \u200b\u8fd8\u200b\u53ef\u4ee5\u200b\u8bbe\u7f6e\u200b: \n * \u200b\u53d1\u9001\u6570\u636e\u200b\u4e4b\u540e\u200b, \u200b\u7b49\u5f85\u200b\u4e00\u4f1a\u200b\u518d\u200b\u6e05\u9664\u200bRTS\u200b\u4fe1\u53f7\u200b\n * \u200b\u7b49\u200b\u591a\u4e45\u200b? delay_rts_after_send(\u200b\u5355\u4f4d\u200bms)\n */\nrs485conf.delay_rts_after_send = ...;\n\n/* \u200b\u5982\u679c\u200b\u60f3\u200b\u5728\u200b\u53d1\u9001\u200bRS485\u200b\u6570\u636e\u200b\u7684\u200b\u540c\u65f6\u200b\u4e5f\u200b\u63a5\u6536\u6570\u636e\u200b, \u200b\u8fd8\u200b\u53ef\u4ee5\u200b\u8fd9\u6837\u200b\u8bbe\u7f6e\u200b */\nrs485conf.flags |= SER_RS485_RX_DURING_TX;\n\nif (ioctl (fd, TIOCSRS485, &amp;rs485conf) &lt; 0) {\n    /* \u200b\u5904\u7406\u9519\u8bef\u200b */\n}\n\n/* \u200b\u4f7f\u7528\u200bread()\u200b\u548c\u200bwrite()\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u8bfb\u200b\u3001\u200b\u5199\u200b\u6570\u636e\u200b\u4e86\u200b */\n\n/* \u200b\u5173\u95ed\u200b\u8bbe\u5907\u200b */\nif (close (fd) &lt; 0) {\n    /* \u200b\u5904\u7406\u9519\u8bef\u200b */\n}\n</code></pre>"},{"location":"09_UART/21_1/#22","title":"2.2 \u200b\u81ea\u5df1\u200b\u63a7\u5236\u200b\u5f15\u811a","text":"<p>\u200b\u53d1\u9001\u200b\u4e4b\u524d\u200b\uff0c\u200b\u81ea\u5df1\u200b\u8bbe\u7f6e\u200bGPIO\u200b\u63a7\u5236\u200bDE\u200b\u5f15\u811a\u200b\u3002</p>"},{"location":"09_UART/21_1/#3","title":"3. \u200b\u9a71\u52a8\u200b\u901f\u89c8","text":""},{"location":"09_UART/21_1/#31-imx6ull","title":"3.1 IMX6ULL","text":"<p>\u200b\u6e90\u7801\u200b\u4e3a\u200b\uff1a<code>Linux-4.9.88\\drivers\\tty\\serial\\imx.c</code>\uff1a</p> <p></p>"},{"location":"09_UART/21_1/#32-stm32mp157","title":"3.2 STM32MP157","text":"<p>\u200b\u6e90\u7801\u200b\u4e3a\u200b\uff1a<code>Linux-5.4\\drivers\\tty\\serial\\stm32-usart.c</code>\u3002</p> <p>STM32MP157\u200b\u7684\u200bUART\u200b\u529f\u80fd\u5f3a\u5927\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u914d\u7f6e\u200b\u5b83\u200b\uff1a</p> <ul> <li>\u200b\u53d1\u9001\u6570\u636e\u200b\u65f6\u200b\u81ea\u52a8\u200b\u8bbe\u7f6e\u200bRTS\u200b\u4fe1\u53f7\u200b</li> <li>\u200b\u8bbe\u7f6e\u200b\u65f6\u95f4\u200b\u503c\u200b\uff1aRTS\u200b\u4f7f\u80fd\u200b\u540e\u200b\u8fc7\u200b\u591a\u4e45\u200b\u53d1\u9001\u6570\u636e\u200b\uff0c\u200b\u53d1\u9001\u200b\u5b8c\u200b\u6570\u636e\u200b\u540e\u8fc7\u200b\u591a\u4e45\u200b\u53d6\u6d88\u200bRTS</li> <li>\u200b\u914d\u7f6e\u200b\u597d\u540e\u200b\uff0c\u200b\u5728\u200b\u53d1\u9001\u200bRS485\u200b\u6570\u636e\u200b\u65f6\u200b\u5c31\u200b\u4e0d\u200b\u9700\u8981\u200b\u663e\u793a\u200b\u5730\u200b\u63a7\u5236\u200bRTS\u200b\u4e86\u200b</li> </ul> <p></p>"},{"location":"09_UART/21_1/#33-gpiors485","title":"3.3 \u200b\u4f7f\u7528\u200bGPIO\u200b\u7684\u200bRS485\u200b\u9a71\u52a8","text":"<p>\u200b\u8fd9\u91cc\u200b\u53ea\u662f\u200b\u4e3e\u4e2a\u200b\u4f8b\u5b50\u200b\u3002</p> <p>\u200b\u6e90\u7801\u200b\u4e3a\u200b\uff1a<code>Linux-4.9.88\\drivers\\tty\\serial\\omap-serial.c</code>\u3002</p>"},{"location":"09_UART/21_1/#1-rtsgpio","title":"1. \u200b\u4ece\u200b\u8bbe\u5907\u200b\u6811\u200b\u83b7\u5f97\u200b\u7528\u4f5c\u200bRTS\u200b\u7684\u200bGPIO","text":""},{"location":"09_UART/21_1/#2-gpio","title":"2. \u200b\u53d1\u9001\u6570\u636e\u200b\u524d\u200b\u8bbe\u7f6e\u200bGPIO","text":""},{"location":"10_PCI_PCIe/01_1/","title":"01_\u200b\u4ece\u200b\u8f6f\u4ef6\u5f00\u53d1\u200b\u89d2\u5ea6\u200b\u770b\u5f85\u200bPCI\u200b\u548c\u200bPCIe","text":""},{"location":"10_PCI_PCIe/01_1/#pcipcie","title":"\u4ece\u200b\u8f6f\u4ef6\u5f00\u53d1\u200b\u89d2\u5ea6\u200b\u770b\u5f85\u200bPCI\u200b\u548c\u200bPCIe","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u300aPCI Express Technology\u300b\uff0cMike Jackson, Ravi Budruk; MindShare, Inc.</li> <li>\u300aPCIe\u200b\u626b\u76f2\u200b\u7cfb\u5217\u200b\u535a\u6587\u200b\u300b\uff0c\u200b\u4f5c\u8005\u200bFelix\uff0c\u200b\u8fd9\u200b\u662f\u200b\u5bf9\u200b\u300aPCI Express Technology\u300b\u200b\u7684\u200b\u7406\u89e3\u200b\u4e0e\u200b\u7ffb\u8bd1\u200b</li> <li>\u300aPCI EXPRESS\u200b\u4f53\u7cfb\u7ed3\u6784\u200b\u5bfc\u8bfb\u200b (\u200b\u738b\u9f50\u200b)\u300b</li> <li>\u300aPCI Express_ Base Specification Revision 4.0 Version 0.3 ( PDFDrive )\u300b</li> <li>\u300aNCB-PCI_Express_Base_5.0r1.0-2019-05-22\u300b</li> </ul>"},{"location":"10_PCI_PCIe/01_1/#1","title":"1. \u200b\u6700\u200b\u5bb9\u6613\u200b\u8bbf\u95ee\u200b\u7684\u200b\u8bbe\u5907\u200b\u662f\u200b\u4ec0\u4e48","text":"<p>\u200b\u662f\u200b\u5185\u5b58\u200b\uff01</p> <p>\u200b\u8981\u200b\u8bfb\u5199\u200b\u5185\u5b58\u200b\uff0c\u200b\u77e5\u9053\u200b\u5b83\u200b\u7684\u200b\u5730\u5740\u200b\u5c31\u200b\u53ef\u4ee5\u200b\uff1a</p> <pre><code>volatile unsigned int *p = \u200b\u67d0\u4e2a\u200b\u5730\u5740\u200b;\nunsigned int val;\n*p = val;  /* \u200b\u5199\u200b */\nval = *p;  /* \u200b\u8bfb\u200b */\n</code></pre> <p>\u200b\u53ea\u6709\u200b\u5185\u5b58\u200b\u80fd\u200b\u8fd9\u6837\u200b\u7b80\u5355\u200b\u3001\u200b\u65b9\u4fbf\u200b\u5730\u200b\u4f7f\u7528\u200b\u5417\u200b\uff1f</p> <p>\u200b\u4e0d\u662f\u200b\u7684\u200b\uff0c\u200b\u6240\u6709\u200b\u7684\u200b\"ram-like\"\u200b\u63a5\u53e3\u200b\u8bbe\u5907\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u8fd9\u6837\u200b\u64cd\u4f5c\u200b\u3002</p> <p>\u200b\u4ec0\u4e48\u200b\u53eb\u200b\"ram-like\"\u200b\u63a5\u53e3\u200b\uff1f</p> <ul> <li>\u200b\u8981\u200b\u53d1\u51fa\u200b\u5730\u5740\u200b\uff1a\u200b\u6709\u200b\u5730\u5740\u200b\u7ebf\u200b</li> <li>\u200b\u8981\u200b\u8bfb\u5199\u200b\u6570\u636e\u200b\uff1a\u200b\u6709\u200b\u6570\u636e\u7ebf\u200b</li> <li>\u200b\u600e\u4e48\u200b\u5206\u8fa8\u200b\u662f\u200b\u8bfb\u200b\u8fd8\u662f\u200b\u5199\u200b\uff1a\u200b\u6709\u200b\u8bfb\u5199\u200b\u4fe1\u53f7\u200b</li> <li>\u200b\u4f17\u591a\u200b\"ram-like\"\u200b\u8bbe\u5907\u200b\u5171\u4eab\u200b\u4e0a\u9762\u200b\u7684\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u600e\u4e48\u200b\u624d\u80fd\u200b\u4e92\u4e0d\u200b\u5f71\u54cd\u200b\uff1f\u200b\u6bcf\u4e2a\u200b\u8bbe\u5907\u200b\u90fd\u200b\u6709\u200b\u81ea\u5df1\u200b\u7684\u200b\u7247\u9009\u200b\u4fe1\u53f7\u200b</li> </ul> <p>\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b\uff1a</p> <p></p> <ul> <li>CPU\u200b\u53d1\u51fa\u200baddr\uff0c\u200b\u5230\u8fbe\u200b\u5185\u5b58\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u4e5f\u200b\u51fa\u73b0\u200b\u5728\u200bRAM\u3001Flash\u3001GPIO\u200b\u7b49\u200b\u8bbe\u5907\u200b\u4e0a\u200b</li> <li>\u200b\u4f7f\u80fd\u200b\u8bbe\u5907\u200b\uff1a</li> <li>\u200b\u5982\u679c\u200baddr\u200b\u5c5e\u4e8e\u200bRAM\u200b\u7684\u200b\u5730\u5740\u200b\u8303\u56f4\u200b\uff0ccs0\u200b\u5c31\u200b\u88ab\u200b\u4f7f\u200b\u80fd\u200b</li> <li>\u200b\u5982\u679c\u200baddr\u200b\u5c5e\u4e8e\u200bFlash\u200b\u7684\u200b\u5730\u5740\u200b\u8303\u56f4\u200b\uff0ccs1\u200b\u5c31\u200b\u88ab\u200b\u4f7f\u200b\u80fd\u200b</li> <li>\u200b\u5982\u679c\u200baddr\u200b\u5c5e\u4e8e\u200bGPIO\u200b\u7684\u200b\u5730\u5740\u200b\u8303\u56f4\u200b\uff0ccs2\u200b\u5c31\u200b\u88ab\u200b\u4f7f\u200b\u80fd\u200b</li> <li>\u200b\u6ca1\u6709\u200b\u88ab\u200b\u4f7f\u200b\u80fd\u200b\u7684\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5c31\u200b\u76f8\u5f53\u4e8e\u200b\u6ca1\u200b\u63a5\u4e0a\u53bb\u200b\u4e00\u6837\u200b\uff0c\u200b\u4e0d\u4f1a\u200b\u5f71\u54cd\u200b\u5176\u4ed6\u200b\u8bbe\u5907\u200b</li> <li>\u200b\u8bfb\u5199\u200b\u6570\u636e\u200b</li> </ul> <p>\u200b\u5173\u952e\u5728\u4e8e\u200b\uff1a\u200b\u5185\u5b58\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u5b83\u4f1a\u200b\u6839\u636e\u200b\u5730\u5740\u200b\u8303\u56f4\u200b\u53d1\u51fa\u200b\u5bf9\u5e94\u200b\u7684\u200b\u7247\u9009\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u9009\u4e2d\u200b\u5bf9\u5e94\u200b\u7684\u200b\u8bbe\u5907\u200b\u3002</p>"},{"location":"10_PCI_PCIe/01_1/#2","title":"2. \u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u7684\u200b\u6982\u5ff5","text":"<p>\u200b\u4ee5\u200b\u4eba\u7c7b\u200b\u4e3a\u4f8b\u200b\uff1a</p> <ul> <li>\u200b\u7237\u7237\u200b\u751f\u200b\u4e86\u200b4\u200b\u4e2a\u200b\u5c0f\u5b69\u200b\uff0c\u200b\u6392\u884c\u200b1234</li> <li>\u200b\u8001\u5927\u200b\u53c8\u751f\u200b\u4e86\u200b4\u200b\u4e2a\u200b\u5c0f\u5b69\u200b\uff0c\u200b\u6392\u884c\u200b1234</li> <li>\u200b\u8fd9\u200b2\u200b\u4e2a\u200b\"1234\"\u200b\u8f88\u5206\u200b\u4e0d\u200b\u4e00\u6837\u200b\uff0c\u200b\u7a7a\u95f4\u200b\u4e0d\u200b\u4e00\u6837\u200b</li> </ul> <p></p> <p>\u200b\u5d4c\u5165\u5f0f\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\u7684\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\uff1a</p> <ul> <li>CPU\u200b\u53d1\u51fa\u200baddr\uff0c\u200b\u53ef\u4ee5\u200b\u7528\u6765\u200b\u65b9\u4f4d\u200bEMMC\u200b\u63a7\u5236\u5668\u200b</li> <li>\u200b\u4f46\u662f\u200bCPU\u200b\u53d1\u51fa\u200b\u7684\u200baddr\uff0c\u200b\u4e0d\u80fd\u200b\u76f4\u63a5\u200b\u5230\u8fbe\u200bEMMC Flash</li> <li>\u200b\u60f3\u200b\u8bbf\u95ee\u200bEMMC Flash</li> <li>\u200b\u5fc5\u987b\u200b\u7528\u8fc7\u200bEMMC\u200b\u63a7\u5236\u5668\u200b</li> <li>\u200b\u7f16\u5199\u200bEMMC\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b</li> <li>\u200b\u5982\u679c\u200bCPU\u200b\u53d1\u51fa\u200b\u7684\u200baddr\uff0c\u200b\u53ef\u4ee5\u200b\u76f4\u63a5\u200b\u5230\u8fbe\u200bEMMC Flash\uff0c\u200b\u90a3\u200b\u5c31\u200b\u7b80\u5355\u200b\u4e86\u200b</li> </ul> <p></p>"},{"location":"10_PCI_PCIe/01_1/#3-pcipcie","title":"3. \u200b\u7406\u89e3\u200bPCI\u200b\u548c\u200bPCIE\u200b\u7684\u200b\u5173\u952e","text":""},{"location":"10_PCI_PCIe/01_1/#31","title":"3.1 \u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u8f6c\u6362","text":""},{"location":"10_PCI_PCIe/01_1/#32-pci","title":"3.2 PCI\u200b\u63a5\u53e3\u200b\u901f\u89c8","text":"<p>\u200b\u53c2\u8003\u200b\u6587\u4ef6\u200b\uff1a<code>01_pci\u200b\u63a5\u53e3\u200b\u5f15\u811a\u200b\u7535\u8def\u200b\u793a\u4f8b\u200b.pdf</code></p> <p></p>"},{"location":"10_PCI_PCIe/01_1/#33-pcie","title":"3.3 PCIe\u200b\u63a5\u53e3\u200b\u901f\u89c8","text":"<p>\u200b\u53c2\u8003\u200b\u6587\u4ef6\u200b\uff1a<code>01_pcie\u200b\u63a5\u53e3\u200b\u5f15\u811a\u200b\u7535\u8def\u200b\u793a\u4f8b\u200b_AX99100.pdf</code></p> <p></p>"},{"location":"10_PCI_PCIe/01_1/#4-pcipcie","title":"4. \u200b\u8bbf\u95ee\u200bPCI/PCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\u6d41\u7a0b","text":""},{"location":"10_PCI_PCIe/01_1/#41-pcipcie","title":"4.1 PCI/PCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u4fe1\u606f","text":"<p>PCI/PCIe\u200b\u8bbe\u5907\u200b\u4e0a\u200b\u6709\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b(\u200b\u914d\u7f6e\u200b\u5bc4\u5b58\u5668\u200b)\uff0c\u200b\u7528\u6765\u200b\u8868\u660e\u200b\u81ea\u5df1\u200b\"\u200b\u9700\u8981\u200b\u591a\u5927\u200b\u7684\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\"\u3002</p> <p>\u200b\u6ce8\u610f\u200b\uff0c\u200b\u8fd9\u662f\u200bPCI/PCIe\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u3002</p>"},{"location":"10_PCI_PCIe/01_1/#42","title":"4.2 \u200b\u4e3b\u673a\u200b\u8bfb\u53d6\u200b\u8bbe\u5907\u200b\u914d\u7f6e\u200b\u4fe1\u606f\u200b\u3001\u200b\u5206\u914d\u200b\u7a7a\u95f4","text":"<p>\u200b\u4e3b\u673a\u200b\u4e0a\u200b\u7684\u200b\u7a0b\u5e8f\u200b\u8bbf\u95ee\u200bPCI/PCIe\u200b\u8bbe\u5907\u200b\uff0c\u200b\u8bfb\u51fa\u200b\u914d\u7f6e\u200b\u4fe1\u606f\u200b\u3002</p> <p>\u200b\u5206\u914d\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\uff1a\u200b\u6ce8\u610f\u200b\uff0c\u200b\u5206\u914d\u200b\u7684\u200b\u662f\u200bPCI/PCIe\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u3002</p> <p>\u200b\u628a\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u9996\u200b\u5730\u5740\u200b\u5199\u5165\u200b\u8bbe\u5907\u200b\u3002</p>"},{"location":"10_PCI_PCIe/01_1/#43-cpupcipcie","title":"4.3 CPU\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u548c\u200bPCI/PCIe\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u600e\u4e48\u200b\u8f6c\u6362\u200b\uff1f","text":"<p>\u200b\u5047\u8bbe\u200bCPU\u200b\u53d1\u51fa\u200b\u7684\u200baddr_cpu\uff0c\u200b\u662f\u200b\u7528\u6765\u200b\u65b9\u4f4d\u200bPCI\u200b\u8bbe\u5907\u200b\u7684\u200b\uff0c\u200b\u8f6c\u6362\u200b\u5173\u7cfb\u200b\u4e3a\u200b\uff1a</p> <pre><code>addr_pci  = addr_cpu + offset\n</code></pre> <p>\u200b\u5728\u200bPCI/PCIe\u200b\u63a7\u5236\u5668\u200b\u4e2d\u200b\uff0c\u200b\u6709\u200b\u67d0\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u6709\u6765\u200b\u4fdd\u5b58\u200boffset\u200b\u503c\u200b\u3002</p>"},{"location":"10_PCI_PCIe/01_1/#43","title":"4.3 \u200b\u4e3b\u673a\u200b\u50cf\u200b\u8bfb\u5199\u200b\u5185\u5b58\u200b\u4e00\u6837\u200b\u8bbf\u95ee\u200b\u8bbe\u5907","text":"<p>\u200b\u793a\u4f8b\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>volatile unsigned int *p = addr_cpu;\nunsigned int val;\n*p = val;  /* \u200b\u5199\u200b, \u200b\u786c\u4ef6\u200b\u4f1a\u200b\u628a\u200baddr_cpu\u200b\u8f6c\u6362\u200b\u4e3a\u200baddr_pci\u200b\u53bb\u200b\u5199\u200bPCI/PCIe\u200b\u8bbe\u5907\u200b */\nval = *p;  /* \u200b\u8bfb\u200b, \u200b\u786c\u4ef6\u200b\u4f1a\u200b\u628a\u200baddr_cpu\u200b\u8f6c\u6362\u200b\u4e3a\u200baddr_pci\u200b\u53bb\u200b\u8bfb\u200bPCI/PCIe\u200b\u8bbe\u5907\u200b */\n</code></pre>"},{"location":"10_PCI_PCIe/02_1/","title":"02_PCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u8bbf\u95ee\u200b\u65b9\u6cd5\u200b_\u200b\u975e\u6865\u200b\u8bbe\u5907\u200b(type0)","text":""},{"location":"10_PCI_PCIe/02_1/#pci_type0","title":"PCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u8bbf\u95ee\u200b\u65b9\u6cd5\u200b_\u200b\u975e\u6865\u200b\u8bbe\u5907\u200b(type0)","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1aGIT\u200b\u4ed3\u5e93\u200b</p> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\doc_pic\\10_PCI_PCIe\\\n    01_pci\u200b\u63a5\u53e3\u200b\u5f15\u811a\u200b\u7535\u8def\u200b\u793a\u4f8b\u200b.pdf\n\n    \u200b\u534f\u8bae\u200b\\PCI\\\n        PCI_SPEV_V3_0.pdf\n        pci-pci_bridge.pdf\n\n    \u200b\u82af\u7247\u200b\u624b\u518c\u200b\\PCI-UART\\MCS9865.pdf\n</code></pre>"},{"location":"10_PCI_PCIe/02_1/#1","title":"1. \u200b\u786c\u4ef6\u200b\u7ed3\u6784","text":"<p>PCI\u200b\u7cfb\u7edf\u200b\u6846\u56fe\u200b\uff1a</p> <p></p> <p>\u200b\u600e\u4e48\u200b\u8bbf\u95ee\u200b\u5230\u200b\u67d0\u4e2a\u200bPCI\u200b\u8bbe\u5907\u200b\uff1f</p> <p>\u200b\u9700\u8981\u200b\u7406\u89e3\u200bPCI\u200b\u672c\u5730\u200b\u603b\u7ebf\u200b\u4fe1\u53f7\u200b\u3002</p>"},{"location":"10_PCI_PCIe/02_1/#2-pci","title":"2. PCI\u200b\u672c\u5730\u200b\u603b\u7ebf\u200b\u7684\u200b\u4fe1\u53f7","text":"<p>\u200b\u4e3b\u8981\u200b\u5206\u4e3a\u200b6\u200b\u7c7b\u200b\uff1a</p> \u200b\u7c7b\u522b\u200b \u200b\u4fe1\u53f7\u200b \u200b\u63cf\u8ff0\u200b \u200b\u7cfb\u7edf\u200b\u5f15\u811a\u200b CLK\uff1a\u200b\u7ed9\u200bPCI\u200b\u8bbe\u5907\u200b\u63d0\u4f9b\u200b\u65f6\u949f\u200bRST#\uff1a\u200b\u7528\u4e8e\u200b\u590d\u4f4d\u200bPCI\u200b\u8bbe\u5907\u200b \u200b\u5730\u5740\u200b/\u200b\u6570\u636e\u200b\u5f15\u811a\u200b AD[31:00]\uff1a\u200b\u5730\u5740\u200b\u3001\u200b\u6570\u636e\u200b\u590d\u7528\u200bC/BE[3:0]\uff1a\u200b\u547d\u4ee4\u200b\u6216\u8005\u200b\u5b57\u8282\u200b\u4f7f\u80fd\u200bPAR\uff1a\u200b\u6821\u9a8c\u200b\u5f15\u811a\u200b \u200b\u63a5\u53e3\u200b\u63a7\u5236\u200b FRAME#\uff1aPCI\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u6b64\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u8868\u793a\u200b\u4e00\u4e2a\u200b\u4f20\u8f93\u200b\u5f00\u59cb\u200b\u4e86\u200b\u3001\u200b\u8fdb\u884c\u200b\u4e2d\u200bIRDY#\uff1aInitiator ready, \u200b\u4f20\u8f93\u200b\u53d1\u8d77\u8005\u200b\u5c31\u7eea\u200b\uff0c\u200b\u4e00\u822c\u200b\u7531\u200bPCI\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u6b64\u200b\u4fe1\u53f7\u200bTRDY#\uff1aTarget ready\uff0c\u200b\u76ee\u6807\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\uff0c\u200b\u8868\u793a\u200b\u5b83\u200b\u5c31\u7eea\u200b\u4e86\u200bSTOP#\uff1a\u200b\u76ee\u6807\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\uff0c\u200b\u8868\u793a\u200b\u5b83\u200b\u60f3\u200b\u505c\u6b62\u200b\u5f53\u524d\u200b\u4f20\u8f93\u200bLOCK#\uff1a\u200b\u9501\u5b9a\u200b\u603b\u7ebf\u200b\uff0c\u200b\u72ec\u5360\u200b\u603b\u7ebf\u200b\uff0c\u200b\u6709\u200bPCI\u200b\u6865\u200b\u9a71\u52a8\u200b\u6b64\u200b\u4fe1\u53f7\u200bIDSEL\uff1aInitialization Device Select\uff0c\u200b\u914d\u7f6e\u200b\u8bbe\u5907\u200b\u65f6\u200b\uff0c\u200b\u7528\u6765\u200b\u9009\u4e2d\u200b\u67d0\u4e2a\u200bPCI\u200b\u8bbe\u5907\u200bDEVSEL#\uff1aDevice Select\uff0cPCI\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u6b64\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u8868\u793a\u200b\u8bf4\u200b\uff1a\u200b\u6211\u200b\u5c31\u662f\u200b\u4f60\u200b\u60f3\u200b\u8bbf\u95ee\u200b\u7684\u200b\u8bbe\u5907\u200b \u200b\u4ef2\u88c1\u200b\u5f15\u811a\u200b REQ#\uff1a\u200b\u7533\u8bf7\u200b\u4f7f\u7528\u200bPCI\u200b\u603b\u7ebf\u200bGNT#\uff1a\u200b\u6388\u4e88\u200b\uff0c\u200b\u8868\u793a\u200b\u4f60\u200b\u7533\u8bf7\u200b\u7684\u200bPCI\u200b\u603b\u7ebf\u200b\u6210\u529f\u200b\u4e86\u200b\uff0c\u200b\u7ed9\u200b\u4f60\u200b\u4f7f\u7528\u200b \u200b\u9519\u8bef\u200b\u901a\u77e5\u200b\u5f15\u811a\u200b PERR#\uff1a\u200b\u5947\u5076\u6821\u9a8c\u200b\u9519\u8bef\u200bSERR#\uff1a\u200b\u7cfb\u7edf\u200b\u9519\u8bef\u200b \u200b\u4e2d\u65ad\u200b\u5f15\u811a\u200b(\u200b\u53ef\u200b\u9009\u200b) INTA#\u3001INTB#\u3001INTC#\u3001INTD# <p>\u200b\u793a\u4f8b\u200b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/02_1/#3-pci","title":"3. \u200b\u8bbf\u95ee\u200bPCI\u200b\u8bbe\u5907","text":""},{"location":"10_PCI_PCIe/02_1/#31-pci","title":"3.1 \u200b\u600e\u4e48\u200b\u8bbf\u95ee\u200bPCI\u200b\u8bbe\u5907","text":"<p>\u200b\u4ee5\u4eba\u6765\u200b\u6bd4\u55bb\u200b\uff1a</p> <ul> <li>\u200b\u7237\u7237\u200b\u60f3\u200b\u4f7f\u5524\u200b\u5b59\u5b50\u200b\u2461</li> <li>\u200b\u7237\u7237\u200b\u53d1\u200b\u6307\u4ee4\u200b\u7ed9\u200b\u4ed6\u200b\u7684\u200b\u513f\u5b50\u200b\u2460</li> <li>\u200b\u513f\u5b50\u200b\u2460\u200b\u53d1\u200b\u6307\u4ee4\u200b\u7ed9\u200b\u5b59\u5b50\u200b\u2461</li> </ul> <p></p> <p>\u200b\u5bf9\u4e8e\u200b\u5d4c\u5165\u5f0f\u200b\u8bbe\u5907\u200b\uff0c\u200b\u7237\u7237\u200b\u662f\u200bCPU\uff0c\u200b\u7236\u8f88\u200b\u662f\u200bPCI\u200b\u6865\u200b\uff0c\u200b\u5b59\u5b50\u200b\u662f\u200bPCI\u200b\u8bbe\u5907\u200b\uff0c\u200b\u8fc7\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>CPU\u200b\u53d1\u51fa\u200b\u5730\u5740\u200baddr_cpu</li> <li>PCI\u200b\u6865\u200b\u628a\u200baddr_cpu\u200b\u8f6c\u6362\u200b\u4e3a\u200baddr_pci</li> <li>PCI\u200b\u603b\u7ebf\u200b\u4e0a\u200b\u6240\u6709\u200b\u8bbe\u5907\u200b\u90fd\u200b\u68c0\u6d4b\u200baddr_pci\u200b\u5730\u5740\u200b\uff0c\u200b\u53d1\u73b0\u200b\u5b83\u200b\u5c5e\u4e8e\u200b\u67d0\u4e2a\u200b\u8bbe\u5907\u200b\u7684\u200b\u5730\u5740\u200b\uff0c\u200b\u8be5\u200b\u8bbe\u5907\u200b\u5c31\u200b\u8d1f\u8d23\u200b\u5b8c\u6210\u200b\u6b64\u200b\u4f20\u8f93\u200b</li> </ul> <p>\u200b\u95ee\u9898\u200b1\uff1aPCI\u200b\u8bbe\u5907\u200b\u600e\u4e48\u200b\u786e\u5b9a\u200b\u81ea\u5df1\u200b\u7684\u200b\u5730\u5740\u200b\u8303\u56f4\u200b\uff1f</p> <p>\u200b\u56de\u7b54\u200b1\uff1a\u200b\u9700\u8981\u200b\u914d\u7f6e\u200b\uff0c\u200b\u8f6f\u4ef6\u200b\u901a\u8fc7\u200bPCI\u200b\u6865\u200b\u67e5\u8be2\u200bPCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u5730\u5740\u200b\u9700\u6c42\u200b\uff0c\u200b\u5206\u914d\u200b\u4e00\u5757\u200baddr_pci\u200b\u7a7a\u95f4\u200b\u7ed9\u200b\u5b83\u200b</p> <p>\u200b\u95ee\u9898\u200b2\uff1aPCI\u200b\u672c\u5730\u200b\u7684\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u6709\u200b\u54ea\u4e9b\u200b</p> <p>\u200b\u56de\u7b54\u200b2\uff1a\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u3001\u200b\u5185\u5b58\u7a7a\u95f4\u200b\u3001IO\u200b\u7a7a\u95f4\u200b</p> <p>\u200b\u95ee\u9898\u200b3\uff1a\u200b\u600e\u4e48\u200b\u7406\u89e3\u200b\u8fd9\u4e9b\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\uff1f\u200b\u770b\u200b\u89c6\u9891\u200b\u3002</p>"},{"location":"10_PCI_PCIe/02_1/#31-pci_1","title":"3.1 PCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u5730\u5740\u200b\u7a7a\u95f4","text":"<ul> <li> <p>\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\uff1aPCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u5bc4\u5b58\u5668\u200b</p> </li> <li> <p>\u200b\u6211\u200b\u662f\u200b\u4ec0\u4e48\u200b\u8bbe\u5907\u200b</p> </li> <li>\u200b\u6211\u200b\u9700\u8981\u200b\u591a\u5927\u200b\u7684\u200b\u5185\u5b58\u7a7a\u95f4\u200b</li> <li> <p>\u200b\u6211\u200b\u9700\u8981\u200b\u591a\u5927\u200b\u7684\u200bIO\u200b\u7a7a\u95f4\u200b</p> </li> <li> <p>\u200b\u5185\u5b58\u7a7a\u95f4\u200b\u6216\u200bIO\u200b\u7a7a\u95f4\u200b\uff1aPCI\u200b\u672c\u5730\u200b\u603b\u7ebf\u200b\u4e0a\u200b\u6709\u200bAD\u200b\u603b\u7ebf\u200b\uff0c\u200b\u5b83\u200b\u662f\u200b\u5730\u5740\u200b\u3001\u200b\u6570\u636e\u200b\u590d\u7528\u200b\u7684\u200b\u603b\u7ebf\u200b</p> </li> <li> <p>\u200b\u4f20\u8f93\u200b\u5730\u5740\u200b\u65f6\u200b\uff1a\u200b\u8fd9\u4e9b\u200b\u5730\u5740\u200b\u53ef\u4ee5\u200b\u662f\u200b\u5185\u5b58\u5730\u5740\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u662f\u200bIO\u200b\u5730\u5740\u200b</p> </li> <li> <p>\u200b\u600e\u4e48\u200b\u5206\u8fa8\u200b\u662f\u200b\u54ea\u7c7b\u200b\u5730\u5740\u200b\uff1f\u200b\u901a\u8fc7\u200bC/BE[3:0]\u200b\u8fd9\u200b4\u200b\u4e2a\u200b\u5f15\u811a\u200b\u6765\u200b\u5206\u8fa8\u200b</p> </li> <li> <p>\u200b\u5185\u5b58\u7a7a\u95f4\u200b\u3001IO\u200b\u7a7a\u95f4\u200b\u6709\u200b\u4ec0\u4e48\u200b\u5dee\u522b\u200b</p> <ul> <li> <p>\u200b\u57fa\u672c\u200b\u6ca1\u4ec0\u4e48\u200b\u5dee\u522b\u200b</p> </li> <li> <p>\u200b\u5927\u90e8\u5206\u200b\u9002\u7528\u200b\u5185\u5b58\u7a7a\u95f4\u200b</p> </li> <li> <p>IO\u200b\u7a7a\u95f4\u200b\u5e94\u8be5\u200b\u662f\u200bx86\u200b\u5e73\u53f0\u200b\u7684\u200b\u9057\u7559\u200b</p> </li> </ul> </li> </ul>"},{"location":"10_PCI_PCIe/02_1/#32-pci","title":"3.2 \u200b\u8bbf\u95ee\u200bPCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u6b65\u9aa4","text":"<ul> <li> <p>\u200b\u8bbf\u95ee\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b</p> </li> <li> <p>\u200b\u8bbf\u95ee\u200b\u5185\u5b58\u7a7a\u95f4\u200b/IO\u200b\u7a7a\u95f4\u200b</p> </li> </ul>"},{"location":"10_PCI_PCIe/02_1/#33-pci-agent","title":"3.3 \u200b\u793a\u4f8b\u200b\uff1a\u200b\u914d\u7f6e\u200bPCI Agent\u200b\u8bbe\u5907","text":"<p>PCI\u200b\u8bbe\u5907\u200b\u53ef\u4ee5\u200b\u7b80\u5355\u200b\u5730\u200b\u5206\u4e3a\u200bPCI Bridge\u200b\u548c\u200bPCI Agent\uff1a</p> <ul> <li>PCI Bridge\uff1a\u200b\u6865\u200b\uff0c\u200b\u7528\u6765\u200b\u6269\u5c55\u200bPCI\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5fc5\u5b9a\u200b\u6709\u200b\u4e00\u4e2a\u200bRoot Bridge\uff0c\u200b\u4e0b\u9762\u200b\u8fd8\u200b\u53ef\u4ee5\u200b\u6709\u200b\u5176\u4ed6\u200bBridge\u3002</li> <li>PCI Agent\uff1a\u200b\u771f\u6b63\u200b\u7684\u200bPCI\u200b\u8bbe\u5907\u200b(\u200b\u6bd4\u5982\u200b\u7f51\u5361\u200b)\uff0c\u200b\u662f\u200bPCI\u200b\u6811\u200b\u7684\u200b\u6700\u672b\u7aef\u200b</li> </ul> <p>\u200b\u600e\u4e48\u200b\u914d\u7f6e\u200bPCI Agent\u200b\u8bbe\u5907\u200b\uff1f</p> <ul> <li> <p>\u200b\u9009\u4e2d\u200b\uff1a\u200b\u901a\u8fc7\u200bIDSEL\u200b\u6765\u200b\u9009\u4e2d\u200b\u67d0\u4e2a\u200b\u8bbe\u5907\u200b</p> </li> <li> <p>\u200b\u600e\u4e48\u200b\u8bbf\u95ee\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\uff1a\u200b\u53d1\u8d77\u200b\u4e00\u4e2a\u200btype 0\u200b\u7684\u200b\u914d\u7f6e\u200b\u547d\u4ee4\u200b</p> </li> <li> <p>PCI\u200b\u8bbe\u5907\u200b\u6700\u591a\u200b\u6709\u200b8\u200b\u4e2a\u200b\u529f\u80fd\u200b\uff0c\u200b\u6bcf\u4e2a\u200b\u529f\u80fd\u200b\u90fd\u200b\u6709\u200b\u81ea\u5df1\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b(\u200b\u914d\u7f6e\u200b\u5bc4\u5b58\u5668\u200b)</p> </li> <li> <p>\u200b\u4f60\u200b\u8981\u200b\u8bbf\u95ee\u200b\u54ea\u4e2a\u200b\u529f\u80fd\u200b\uff1f\u200b\u54ea\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\uff1f\u200b\u53d1\u8d77\u200b     </p> </li> <li> <p>CPU\u200b\u8bfb\u53d6\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u7684\u200bBAR\uff0c\u200b\u5f97\u77e5\u200b\uff1a\u200b\u8fd9\u4e2a\u200bPCI\u200b\u8bbe\u5907\u200b\u60f3\u200b\u7533\u8bf7\u200b\u591a\u5927\u200b\u7a7a\u95f4\u200b</p> </li> <li> <p>CPU\u200b\u5206\u914d\u200bPCI\u200b\u5730\u5740\u200b\uff0c\u200b\u5199\u200b\u5230\u200bPCI\u200b\u8bbe\u5907\u200b\u7684\u200bBAR\u200b\u91cc\u200b</p> </li> </ul>"},{"location":"10_PCI_PCIe/03_1/","title":"03_PCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u8bbf\u95ee\u200b\u65b9\u6cd5\u200b_\u200b\u6865\u200b\u8bbe\u5907\u200b(type1)","text":""},{"location":"10_PCI_PCIe/03_1/#pci_type1","title":"PCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u8bbf\u95ee\u200b\u65b9\u6cd5\u200b_\u200b\u6865\u200b\u8bbe\u5907\u200b(type1)","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>GIT\u200b\u4ed3\u5e93\u200b</li> </ul> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\doc_pic\\10_PCI_PCIe\\\n    01_pci\u200b\u63a5\u53e3\u200b\u5f15\u811a\u200b\u7535\u8def\u200b\u793a\u4f8b\u200b.pdf\n\n    \u200b\u534f\u8bae\u200b\\PCI\\\n        PCI_SPEV_V3_0.pdf\n        pci-pci_bridge.pdf\n\n    \u200b\u82af\u7247\u200b\u624b\u518c\u200b\\PCI-UART\\MCS9865.pdf\n</code></pre> <ul> <li>\u300aPCI EXPRESS\u200b\u4f53\u7cfb\u7ed3\u6784\u200b\u5bfc\u8bfb\u200b (\u200b\u738b\u5947\u200b)\u300b</li> </ul>"},{"location":"10_PCI_PCIe/03_1/#1","title":"1. \u200b\u786c\u4ef6\u200b\u7ed3\u6784","text":"<p>PCI\u200b\u7cfb\u7edf\u200b\u6846\u56fe\u200b\uff1a</p> <p></p> <p>\u200b\u600e\u4e48\u200b\u8bbf\u95ee\u200b\u5230\u200b\u67d0\u4e2a\u200bPCI\u200b\u8bbe\u5907\u200b\uff1f</p> <p>\u200b\u9700\u8981\u200b\u7406\u89e3\u200bPCI\u200b\u672c\u5730\u200b\u603b\u7ebf\u200b\u4fe1\u53f7\u200b\u3002</p>"},{"location":"10_PCI_PCIe/03_1/#2-pci","title":"2. PCI\u200b\u8bbe\u5907\u200b\u7c7b\u522b\u200b\u53ca\u200b\u914d\u7f6e\u200b\u65b9\u6cd5","text":"<p>PCI\u200b\u8bbe\u5907\u200b\u53ef\u4ee5\u200b\u7b80\u5355\u200b\u5730\u200b\u5206\u4e3a\u200bPCI Agent\u3001PCI Bridge\u3001Cardbus Bridge\uff1a</p> <ul> <li>PCI Agent\uff1a\u200b\u771f\u6b63\u200b\u7684\u200bPCI\u200b\u8bbe\u5907\u200b(\u200b\u6bd4\u5982\u200b\u7f51\u5361\u200b)\uff0c\u200b\u662f\u200bPCI\u200b\u6811\u200b\u7684\u200b\u6700\u672b\u7aef\u200b</li> <li>PCI Bridge\uff1a\u200b\u6865\u200b\uff0c\u200b\u7528\u6765\u200b\u6269\u5c55\u200bPCI\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5fc5\u5b9a\u200b\u6709\u200b\u4e00\u4e2a\u200bRoot Bridge\uff0c\u200b\u4e0b\u9762\u200b\u8fd8\u200b\u53ef\u4ee5\u200b\u6709\u200b\u5176\u4ed6\u200bBridge\u3002</li> <li>Cardbus Bridge\uff1a\u200b\u7528\u200b\u5f97\u200b\u4e0d\u200b\u591a\u200b\uff0c\u200b\u4e0d\u200b\u4ecb\u7ecd\u200b</li> </ul> <p>\u200b\u600e\u4e48\u200b\u5224\u8bfb\u200b\u8bbe\u5907\u200b\u7684\u200b\u7c7b\u522b\u200b\uff1f\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u91cc\u200b\u6709\u200b<code>Header Type</code>\uff0c\u200b\u5b83\u200b\u7684\u200b\u53d6\u503c\u200b\u6709\u200b\uff1a</p> <ul> <li>00h\uff1aPCI Agent</li> <li>01h\uff1aPCI Bridge</li> <li>02h\uff1aCardbus Bridge</li> </ul> <p></p>"},{"location":"10_PCI_PCIe/03_1/#22","title":"2.2 \u200b\u914d\u7f6e\u200b\u8bbe\u5907\u200b\u65f6\u200b\u600e\u4e48\u200b\u9009\u4e2d\u200b\u5b83","text":"<ul> <li> <p>\u200b\u8ddf\u200bRoot Bridge\u200b\u76f4\u63a5\u200b\u76f8\u8fde\u200b\u7684\u200bPCI Agent\u3001PCI Bridge\uff0c\u200b\u4f7f\u7528\u200b<code>Configuration Command type 0</code> </p> </li> <li> <p>\u200b\u6865\u200b\u4e4b\u540e\u200b\u7684\u200b\u8bbe\u5907\u200b\uff0cRoot Brdige\u200b\u4f7f\u7528\u200b<code>Configuration Command type 1</code> </p> </li> <li> <p>\u200b\u6865\u200b\uff1a\u200b\u63a5\u6536\u200b\u5230\u200b<code>Configuration Command type 1</code>\u200b\u540e\u200b\uff0c\u200b\u6709\u200b2\u200b\u4e2a\u200b\u9009\u62e9\u200b</p> </li> <li>\u200b\u5bf9\u4e8e\u200b\u8ddf\u200b\u5b83\u200b\u76f4\u200b\u8fde\u200b\u7684\u200bPCI Agent<ul> <li>\u200b\u628a\u200b<code>Configuration Command type 1</code>\u200b\u8f6c\u6362\u200b\u4e3a\u200b<code>Configuration Command type 1</code></li> <li>\u200b\u4f7f\u7528\u200bIDSEL\u200b\u9009\u62e9\u200b\u8bbe\u5907\u200b</li> </ul> </li> <li>\u200b\u5982\u679c\u200b\u8fd8\u200b\u9700\u8981\u200b\u901a\u8fc7\u200b\u4e0b\u200b\u4e00\u7ea7\u200b\u7684\u200b\u6865\u200b\u624d\u80fd\u200b\u8bbf\u95ee\u200b\u6b64\u200b\u8bbe\u5907\u200b<ul> <li>\u200b\u8f6c\u53d1\u200b<code>Configuration Command type 1</code></li> </ul> </li> </ul>"},{"location":"10_PCI_PCIe/03_1/#3","title":"3. \u200b\u914d\u7f6e\u200b\u793a\u4f8b","text":""},{"location":"10_PCI_PCIe/03_1/#31-pci-agent","title":"3.1 \u200b\u793a\u4f8b\u200b\uff1a\u200b\u914d\u7f6e\u200bPCI Agent\u200b\u8bbe\u5907","text":"<ul> <li> <p>\u200b\u9009\u4e2d\u200b\uff1a\u200b\u901a\u8fc7\u200bIDSEL\u200b\u6765\u200b\u9009\u4e2d\u200b\u67d0\u4e2a\u200b\u8bbe\u5907\u200b</p> </li> <li> <p>\u200b\u600e\u4e48\u200b\u8bbf\u95ee\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\uff1a\u200b\u53d1\u8d77\u200b\u4e00\u4e2a\u200btype 0\u200b\u7684\u200b\u914d\u7f6e\u200b\u547d\u4ee4\u200b</p> </li> <li> <p>PCI\u200b\u8bbe\u5907\u200b\u6700\u591a\u200b\u6709\u200b8\u200b\u4e2a\u200b\u529f\u80fd\u200b\uff0c\u200b\u6bcf\u4e2a\u200b\u529f\u80fd\u200b\u90fd\u200b\u6709\u200b\u81ea\u5df1\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b(\u200b\u914d\u7f6e\u200b\u5bc4\u5b58\u5668\u200b)</p> </li> <li> <p>\u200b\u4f60\u200b\u8981\u200b\u8bbf\u95ee\u200b\u54ea\u4e2a\u200b\u529f\u80fd\u200b\uff1f\u200b\u54ea\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\uff1f\u200b\u53d1\u8d77\u200b     </p> </li> <li> <p>CPU\u200b\u8bfb\u53d6\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u7684\u200bBAR\uff0c\u200b\u5f97\u77e5\u200b\uff1a\u200b\u8fd9\u4e2a\u200bPCI\u200b\u8bbe\u5907\u200b\u60f3\u200b\u7533\u8bf7\u200b\u591a\u5927\u200b\u7a7a\u95f4\u200b</p> </li> <li> <p>CPU\u200b\u5206\u914d\u200bPCI\u200b\u5730\u5740\u200b\uff0c\u200b\u5199\u200b\u5230\u200bPCI\u200b\u8bbe\u5907\u200b\u7684\u200bBAR\u200b\u91cc\u200b</p> </li> </ul> <p>PCI Agent\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/03_1/#32-pci","title":"3.2 \u200b\u793a\u4f8b\u200b\uff1a\u200b\u914d\u7f6e\u200bPCI\u200b\u6865","text":"<ul> <li>\u200b\u8ddf\u200b\u4e00\u822c\u200b\u7684\u200bPCI\u200b\u8bbe\u5907\u200b\u4e00\u6837\u200b\uff0c\u200b\u901a\u8fc7\u200bIDSEL\u200b\u6765\u200b\u9009\u4e2d\u200b\u5b83\u200b</li> <li>\u200b\u901a\u8fc7\u200btype 0\u200b\u914d\u7f6e\u200b\u547d\u4ee4\u200b\u8bfb\u53d6\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\uff0c\u200b\u53d1\u73b0\u200b\u5b83\u200b\u662f\u200bPCI\u200b\u6865\u200b\u8bbe\u5907\u200b\uff0c\u200b\u628a\u200b\u5206\u914d\u200b\u7684\u200b\u603b\u7ebf\u200b\u53f7\u200b\u5199\u7ed9\u200b\u5b83\u200b</li> </ul> <p>PCI\u200b\u6865\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/03_1/#33-pci","title":"3.3 \u200b\u793a\u4f8b\u200b\uff1a\u200b\u914d\u7f6e\u200bPCI\u200b\u6865\u200b\u540e\u9762\u200b\u7684\u200b\u8bbe\u5907","text":"<ul> <li> <p>\u200b\u53d1\u8d77\u200b\u4e00\u4e2a\u200btype 1\u200b\u7684\u200b\u914d\u7f6e\u200b\u547d\u4ee4\u200b   </p> </li> <li> <p>\u200b\u901a\u8fc7\u200bBus Number\u200b\u8bbf\u95ee\u200b\u5230\u200bPCI\u200b\u6865\u200b</p> </li> <li>PCI\u200b\u6865\u200b\u6839\u636e\u200bDevice Number\u200b\u53bb\u200b\u9a71\u52a8\u200bIDSEL\uff0c\u200b\u9009\u4e2d\u200b\u4e0b\u200b\u4e00\u7ea7\u200b\u7684\u200bPCI\u200b\u8bbe\u5907\u200b</li> <li>\u200b\u901a\u8fc7\u200bFunction Number\u3001Register Number\u200b\u8bbf\u95ee\u200bPCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b</li> </ul>"},{"location":"10_PCI_PCIe/03_1/#4-pci","title":"4. \u200b\u8bbf\u95ee\u200bPCI\u200b\u8bbe\u5907","text":"<ul> <li>CPU\u200b\u53d1\u51fa\u200baddr_cpu\uff0c\u200b\u88ab\u200bPCI Host\u200b\u6865\u200b\u8f6c\u6362\u200b\u4e3a\u200baddr_pci</li> <li>\u200b\u67d0\u4e2a\u200bPCI\u200b\u8bbe\u5907\u200b\u53d1\u73b0\u200b\u8fd9\u4e2a\u200baddr_pci\u200b\u662f\u200b\u81ea\u5df1\u200b\u7684\u200b\uff0c\u200b\u5c31\u200b\u9a71\u52a8\u200bDEVSEL#\uff0c\u200b\u8868\u793a\u200b\u8bf4\u200b\uff1a\u200b\u662f\u200b\u6211\u200b\u662f\u200b\u6211\u200b</li> <li>PCI\u200b\u8bbe\u5907\u200b\u53c2\u4e0e\u200b\u4f20\u8f93\u200b\uff1a\u200b\u63a5\u6536\u6570\u636e\u200b\u3001\u200b\u8fd4\u56de\u200b\u6570\u636e\u200b</li> </ul>"},{"location":"10_PCI_PCIe/04_1/","title":"04_\u200b\u4ece\u200b\u8f6f\u4ef6\u200b\u89d2\u5ea6\u770b\u200bPCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\u786c\u4ef6\u200b\u7ed3\u6784","text":""},{"location":"10_PCI_PCIe/04_1/#pcie","title":"\u4ece\u200b\u8f6f\u4ef6\u200b\u89d2\u5ea6\u770b\u200bPCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\u786c\u4ef6\u200b\u7ed3\u6784","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u300aPCI Express Technology\u300b\uff0cMike Jackson, Ravi Budruk; MindShare, Inc.</li> <li>\u300aPCIe\u200b\u626b\u76f2\u200b\u7cfb\u5217\u200b\u535a\u6587\u200b\u300b\uff0c\u200b\u4f5c\u8005\u200bFelix\uff0c\u200b\u8fd9\u200b\u662f\u200b\u5bf9\u200b\u300aPCI Express Technology\u300b\u200b\u7684\u200b\u7406\u89e3\u200b\u4e0e\u200b\u7ffb\u8bd1\u200b</li> <li>\u300aPCI EXPRESS\u200b\u4f53\u7cfb\u7ed3\u6784\u200b\u5bfc\u8bfb\u200b (\u200b\u738b\u9f50\u200b)\u300b</li> <li>\u300aPCI Express_ Base Specification Revision 4.0 Version 0.3 ( PDFDrive )\u300b</li> <li>\u300aNCB-PCI_Express_Base_5.0r1.0-2019-05-22\u300b</li> </ul>"},{"location":"10_PCI_PCIe/04_1/#1-pcie","title":"1. PCIe\u200b\u63a5\u53e3\u200b\u5f15\u811a","text":"<p>\u200b\u53c2\u8003\u200b\u6587\u4ef6\u200b\uff1a01_pcie\u200b\u63a5\u53e3\u200b\u5f15\u811a\u200b\u7535\u8def\u200b\u793a\u4f8b\u200b_AX99100.pdf</p> <p></p> <p>PCI\u200b\u63a5\u53e3\u200b\u7684\u200b\u5f15\u811a\u200b\u65f6\u200b\u5e76\u884c\u200b\u7684\u200b\uff0cPCEe\u200b\u7684\u200b\u662f\u200b\u4e32\u884c\u200b\u7684\u200b\uff0c\u200b\u6bcf\u4e2a\u200b\u65b9\u5411\u200b\u7684\u200b\u6570\u636e\u200b\u4f7f\u7528\u200b2\u200b\u6761\u200b\u5dee\u5206\u200b\u4fe1\u53f7\u7ebf\u200b\u6765\u200b\u4f20\u8f93\u200b\uff0c\u200b\u53d1\u9001\u200b/\u200b\u63a5\u6536\u200b\u4e24\u4e2a\u200b\u65b9\u5411\u200b\u5c31\u200b\u9700\u8981\u200b4\u200b\u6761\u7ebf\u200b\uff0c\u200b\u8fd9\u200b\u88ab\u200b\u79f0\u4e3a\u200b1\u200b\u4e2a\u200bLane\uff1a</p> <p></p> <p>PCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\u63a5\u53e3\u200b\u4e0a\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u6709\u200b\u591a\u4e2a\u200bLane\uff1a</p> <ul> <li>\u200b\u4e24\u4e2a\u200bPCIe\u200b\u8bbe\u5907\u200b\u4e4b\u95f4\u200b\u6709\u200b\u4e00\u4e2a\u200bLink</li> <li>\u200b\u4e00\u4e2a\u200bLink\u200b\u4e2d\u6709\u200b1\u200b\u5bf9\u200b\u6216\u200b\u591a\u200b\u5bf9\u200b\"\u200b\u53d1\u9001\u200b/\u200b\u63a5\u6536\u200b\"\u200b\u5f15\u811a\u200b\uff0c\u200b\u6bcf\u200b\u5bf9\u200b\"\u200b\u53d1\u9001\u200b/\u200b\u63a5\u6536\u200b\"\u200b\u5f15\u811a\u200b\u88ab\u200b\u79f0\u4e3a\u200b\"Lane\"</li> <li>\u200b\u4e00\u4e2a\u200bLane\uff1a\u200b\u6709\u200b\u53d1\u9001\u200b\u3001\u200b\u63a5\u6536\u200b\u4e24\u4e2a\u200b\u65b9\u5411\u200b\uff0c\u200b\u6bcf\u4e2a\u200b\u65b9\u5411\u200b\u7528\u200b2\u200b\u6761\u200b\u5dee\u5206\u200b\u4fe1\u53f7\u7ebf\u200b\uff0c\u200b\u6240\u4ee5\u200b1\u200b\u4e2a\u200bLane\u200b\u6709\u200b4\u200b\u6761\u7ebf\u200b</li> <li>\u200b\u4e00\u4e2a\u200bLink\u200b\u6700\u200b\u591a\u200b\u53ef\u4ee5\u200b\u6709\u200b32 Lane</li> </ul> <p></p>"},{"location":"10_PCI_PCIe/04_1/#2","title":"2. \u200b\u4ece\u200b\u8f6f\u4ef6\u200b\u89d2\u5ea6\u200b\u7406\u89e3\u200b\u786c\u4ef6\u200b\u63a5\u53e3","text":""},{"location":"10_PCI_PCIe/04_1/#21-pcipcie","title":"2.1 PCI/PCIe\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u8f6c\u6362","text":""},{"location":"10_PCI_PCIe/04_1/#22-pcie","title":"2.2 PCIe\u200b\u4e0a\u200b\u600e\u4e48\u200b\u4f20\u8f93\u200b\u5730\u5740\u200b\u3001\u200b\u6570\u636e","text":"<p>\u200b\u65e2\u7136\u200bPCIe\u200b\u662f\u200b\u4e32\u884c\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u90a3\u200b\u53ea\u80fd\u200b\u5728\u200b\"\u200b\u5305\u200b\"\u200b\u91cc\u200b\u4f20\u8f93\u200b\u5730\u5740\u200b\u3001\u200b\u6570\u636e\u200b\u4e86\u200b\u3002</p> <ul> <li>\u200b\u9700\u8981\u200b\u5b9a\u4e49\u200b\u5305\u200b\u7684\u200b\u683c\u5f0f\u200b\uff1a\u200b\u7c7b\u578b\u200b(Mem R/W) + \u200b\u5730\u5740\u200b + \u200b\u6570\u636e\u200b</li> <li>\u200b\u5305\u200b\u600e\u4e48\u200b\u4f20\u9012\u200b\u7ed9\u200b\u5bf9\u65b9\u200b\u3001\u200b\u600e\u4e48\u200b\u786e\u4fdd\u200b\u4e0d\u200b\u51fa\u9519\u200b\uff1f\u200b\u6709\u200b\u91cd\u4f20\u200b\u673a\u5236\u200b\u3001\u200b\u6709\u200b\u68c0\u9a8c\u7801\u200b</li> <li>\u200b\u5305\u200b\u600e\u4e48\u200b\u901a\u8fc7\u200b\u5dee\u5206\u200b\u7ebf\u200b\u4f20\u9001\u200b\u51fa\u53bb\u200b\uff1f</li> </ul> <p>PCIe\u200b\u603b\u7ebf\u200b\u7684\u200b\u5c42\u6b21\u7ed3\u6784\u200b\u548c\u200b\u6570\u636e\u5305\u200b\uff1a</p> <ul> <li>\u200b\u4e8b\u52a1\u200b\u5c42\u200b(Tansaction Layer)\uff1a\u200b\u4f20\u8f93\u200b\u7684\u200b\u662f\u200bTransaction Layer Packet(TLP)   </li> <li>\u200b\u6570\u636e\u200b\u94fe\u8def\u5c42\u200b(Data Link Layer)\uff1a\u200b\u4f20\u8f93\u200b\u7684\u200b\u662f\u200bData Link Layer Packet(DLLP)</li> <li>\u200b\u5728\u200bTLP\u200b\u52a0\u4e0a\u200b\u524d\u7f00\u200b\u3001\u200b\u540e\u7f00\u200b\uff0c\u200b\u5f97\u5230\u200bDLLP     </li> <li> <p>\u200b\u5f53\u7136\u200b\u8fd8\u6709\u200b\u6570\u636e\u200b\u94fe\u8def\u5c42\u200b\u81ea\u5df1\u200b\u7684\u200b\u6570\u636e\u5305\u200b</p> </li> <li> <p>\u200b\u7269\u7406\u5c42\u200b(Physical Layer)\uff1a\u200b\u4f20\u8f93\u200b\u7684\u200b\u662f\u200bPhysical Packet</p> </li> <li>\u200b\u5728\u200bDLLP\u200b\u52a0\u4e0a\u200b\u524d\u7f00\u200b\u3001\u200b\u540e\u7f00\u200b\uff0c\u200b\u5f97\u5230\u200b\u7684\u200b\u662f\u200bPhysical Packet     </li> <li>\u200b\u5f53\u7136\u200b\u8fd8\u6709\u200b\u7269\u7406\u5c42\u200b\u81ea\u5df1\u200b\u7684\u200b\u6570\u636e\u5305\u200b</li> </ul> <p></p>"},{"location":"10_PCI_PCIe/04_1/#3-pcie","title":"3. PCIe\u200b\u7cfb\u7edf\u200b\u7684\u200b\u786c\u4ef6\u200b\u6846\u56fe","text":"<p>\u200b\u5728\u200bPCI\u200b\u7cfb\u7edf\u200b\u91cc\u200b\uff0c\u200b\u591a\u4e2a\u200bPCI\u200b\u8bbe\u5907\u200b\u90fd\u200b\u94fe\u63a5\u200b\u5230\u200b\u76f8\u540c\u200b\u603b\u7ebf\u200b\u4e0a\u200b\u3002</p> <p>\u200b\u5728\u200bPCIe\u200b\u7cfb\u7edf\u200b\u91cc\u200b\uff0c\u200b\u662f\u200b\u70b9\u5bf9\u70b9\u200b\u4f20\u8f93\u200b\u7684\u200b\uff1a</p> <ul> <li>\u200b\u4e00\u6761\u200bPCIe\u200b\u603b\u7ebf\u200b\u53ea\u80fd\u200b\u63a5\u200b\u4e00\u4e2a\u200bPCIe\u200b\u8bbe\u5907\u200b</li> <li>\u200b\u8981\u63a5\u200b\u591a\u4e2a\u200bPCIe\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5fc5\u987b\u200b\u4f7f\u7528\u200bSwitch\u200b\u8fdb\u884c\u200b\u6269\u5c55\u200b</li> </ul> <p></p>"},{"location":"10_PCI_PCIe/05_1/","title":"05_PCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u8fc7\u7a0b","text":""},{"location":"10_PCI_PCIe/05_1/#pcie","title":"PCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u8fc7\u7a0b","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u300aPCI Express Technology 3.0\u300b\uff0cMike Jackson, Ravi Budruk; MindShare, Inc.</li> <li>\u300aPCIe\u200b\u626b\u76f2\u200b\u7cfb\u5217\u200b\u535a\u6587\u200b\u300b\uff0c\u200b\u4f5c\u8005\u200bFelix\uff0c\u200b\u8fd9\u200b\u662f\u200b\u5bf9\u200b\u300aPCI Express Technology\u300b\u200b\u7684\u200b\u7406\u89e3\u200b\u4e0e\u200b\u7ffb\u8bd1\u200b</li> <li>\u300aPCI EXPRESS\u200b\u4f53\u7cfb\u7ed3\u6784\u200b\u5bfc\u8bfb\u200b (\u200b\u738b\u9f50\u200b)\u300b</li> <li>\u300aPCI Express_ Base Specification Revision 4.0 Version 0.3 ( PDFDrive )\u300b</li> <li>\u300aNCB-PCI_Express_Base_5.0r1.0-2019-05-22\u300b</li> </ul>"},{"location":"10_PCI_PCIe/05_1/#1-pcie","title":"1. PCIe\u200b\u7cfb\u7edf\u200b\u786c\u4ef6\u200b\u7ed3\u6784","text":"<p>\u200b\u4e0b\u56fe\u200b\u6765\u81ea\u200b\u300aPCI Express_ Base Specification Revision 4.0 Version 0.3 ( PDFDrive )\u300b\uff0cP78\u3002</p> <p></p>"},{"location":"10_PCI_PCIe/05_1/#2-pcie","title":"2. PCIe\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u5c42\u6b21","text":"<p>\u200b\u4e0b\u56fe\u200b\u6765\u81ea\u200b\u300aPCI Express Technology 3.0\u300b\u3002</p> <p></p> <p>\u200b\u5728\u200b\u8f6f\u4ef6\u200b\u7684\u200b\u89d2\u5ea6\u200b\uff0c\u200b\u6211\u4eec\u200b\u5148\u200b\u5173\u6ce8\u200b\u4e8b\u52a1\u200b\u5c42\u200b(Transaction Layer)\uff0c\u200b\u5728\u200b\u4e8b\u52a1\u200b\u5c42\u200b\u4f20\u8f93\u200bTLP(Transaction Layer Packet\uff0c\u200b\u4e8b\u52a1\u200b\u5c42\u5305\u200b)\u3002</p> <p>\u200b\u6211\u4eec\u200b\u8981\u200b\u5173\u6ce8\u200bTLP\u200b\u4e2d\u200b\u600e\u4e48\u200b\u8868\u793a\u200b\u8fd9\u4e9b\u200b\u5185\u5bb9\u200b\uff1a</p> <ul> <li>\u200b\u8981\u200b\u505a\u200b\u4ec0\u4e48\u200b\uff1f\u200b\u5185\u5b58\u200b\u8bfb\u200b\u3001\u200b\u5185\u5b58\u200b\u5199\u200b\u3001IO\u200b\u8bfb\u200b\u3001IO\u200b\u5199\u200b\u3001\u200b\u914d\u7f6e\u200b\u8bfb\u200b\u3001\u200b\u914d\u7f6e\u200b\u5199\u200b\uff1f</li> <li>\u200b\u5185\u5b58\u200b\u8bfb\u5199\u200b/IO\u200b\u8bfb\u5199\u200b\uff1a\u200b\u54ea\u4e2a\u200b\u5730\u5740\u200b\uff1f</li> <li>\u200b\u914d\u7f6e\u200b\u8bfb\u5199\u200b\uff1a\u200b\u54ea\u4e2a\u200b\"Bus/Device/Function/Register\"\uff1f</li> <li>\u200b\u6570\u636e\u200b\uff1f</li> </ul>"},{"location":"10_PCI_PCIe/05_1/#3-tlp","title":"3. \u200b\u4e8b\u52a1\u200b\u5c42\u200bTLP\u200b\u683c\u5f0f","text":""},{"location":"10_PCI_PCIe/05_1/#31-postednon-posted","title":"3.1 Posted\u200b\u548c\u200bNon-Posted","text":"<p>Post\u200b\u7684\u200b\u610f\u601d\u200b\u662f\u200b\"\u200b\u90ae\u5bc4\u200b\"\u3001\"\u200b\u6295\u9012\u200b\"\u3002</p> <p>PCIe\u200b\u6709\u200b\u4e24\u7c7b\u200b\u4e8b\u52a1\u200b\uff1a</p> <ul> <li>Posted\uff1a\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u8bbf\u95ee\u200b\u76ee\u6807\u200b\u8bbe\u5907\u200b\u65f6\u200b\uff0c\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u53d1\u51fa\u4fe1\u53f7\u200b\u540e\u200b\u5c31\u200b\u4e0d\u518d\u200b\u7406\u4f1a\u200b\u540e\u7eed\u200b\u8fc7\u7a0b\u200b\uff0c\u200b\u4e5f\u200b\u5c31\u662f\u200b\"\u200b\u53d1\u5c04\u200b\u540e\u200b\u4e0d\u7ba1\u200b\"\u3002\u200b\u4f7f\u7528\u200b\u8fd9\u79cd\u200b\u65b9\u5f0f\u200b\uff0c\u200b\u5728\u200b\u6570\u636e\u200b\u672a\u200b\u5230\u8fbe\u200b\u76ee\u6807\u200b\u8bbe\u5907\u200b\u524d\u200b\uff0c\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u7ed3\u675f\u200b\u5f53\u524d\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u6548\u7387\u200b\u66f4\u9ad8\u200b\u3002\u200b\u9002\u7528\u200b\u4e8e\u200b\"\u200b\u5185\u5b58\u200b\u5199\u200b\"\u200b\u7b49\u200b\u573a\u5408\u200b\u3002</li> <li>Non-Posted\uff1a\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u8bbf\u95ee\u200b\u76ee\u6807\u200b\u8bbe\u5907\u200b\u65f6\u200b\uff0c\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u53d1\u51fa\u4fe1\u53f7\u200b\u540e\u200b\u5fc5\u987b\u200b\u7b49\u5f85\u200b\u540e\u7eed\u200b\u7ed3\u679c\u200b\u3002\u200b\u6bd4\u5982\u200b\"\u200b\u5185\u5b58\u200b\u8bfb\u200b\"\uff0c\u200b\u5fc5\u987b\u200b\u5f97\u5230\u200b\u8fd4\u56de\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u624d\u80fd\u200b\u7ed3\u675f\u200b\u5f53\u524d\u200b\u64cd\u4f5c\u200b\u3002</li> </ul> <p>\u200b\u5728\u200bPCIe\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\uff1a</p> <ul> <li>Posted\uff1a\u200b\u5185\u5b58\u200b\u5199\u200b</li> <li>Non-Posted\uff1a\u200b\u5185\u5b58\u200b\u8bfb\u200b\u3001IO\u200b\u8bfb\u200b\u3001IO\u200b\u5199\u200b\u3001\u200b\u914d\u7f6e\u200b\u8bfb\u200b\u3001\u200b\u914d\u7f6e\u200b\u5199\u200b</li> <li>\u200b\u5bf9\u4e8e\u200bNon-Posted\uff0c\u200b\u4f7f\u7528\u200bSplit\u200b\u4f20\u9001\u200b\u65b9\u5f0f\u200b</li> <li>Split\u200b\u542b\u6709\u200b\uff1a\u200b\u5206\u79bb\u200b</li> <li>\u200b\u88ab\u200b\u62c6\u200b\u5206\u4e3a\u200b\u4e24\u200b\u90e8\u5206\u200b\uff0c\u200b\u53d1\u51fa\u8bf7\u6c42\u200b\u62a5\u6587\u200b\u3001\u200b\u5f97\u5230\u200b\u5b8c\u6210\u200b\u62a5\u6587\u200b</li> </ul>"},{"location":"10_PCI_PCIe/05_1/#32-tlp","title":"3.2 TLP\u200b\u901a\u7528\u200b\u683c\u5f0f","text":"<p>\u200b\u4e0b\u56fe\u200b\u6765\u81ea\u200b\u300aPCI Express_ Base Specification Revision 4.0 Version 0.3 ( PDFDrive )\u300b\u3002</p> <p></p> <p></p> <ul> <li>\u200b\u7c7b\u578b\u200b\uff1a\u200b\u4f60\u200b\u662f\u200b\u8bfb\u200b\u5185\u5b58\u200b\u8fd8\u662f\u200b\u5199\u200b\u5185\u5b58\u200b\uff1f\u200b\u8bfb\u200bIO\u200b\u8fd8\u662f\u200b\u5199\u200bIO\uff1f\u200b\u8bfb\u200b\u914d\u7f6e\u200b\u8fd8\u662f\u200b\u5199\u200b\u914d\u7f6e\u200b\uff1f</li> <li>\u200b\u5728\u200bHeader\u200b\u91cc\u9762\u200b\u6709\u200b\u5b9a\u4e49\u200b</li> <li>\u200b\u5730\u5740\u200b\uff1a\u200b\u5bf9\u4e8e\u200b\u5185\u5b58\u200b\u8bfb\u5199\u200b\u3001IO\u200b\u8bfb\u5199\u200b\uff0c\u200b\u5730\u5740\u200b\u4fdd\u5b58\u200b\u5728\u200bHeader\u200b\u91cc\u200b</li> <li>Bus/Dev/Function/Regiser\uff1a\u200b\u5bf9\u4e8e\u200b\u914d\u7f6e\u200b\u8bfb\u5199\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u4fe1\u606f\u200b\u4fdd\u5b58\u200b\u5728\u200bHeader\u200b\u91cc\u200b</li> <li>\u200b\u6570\u636e\u200b\uff1a\u200b\u5bf9\u4e8e\u200b\u5185\u5b58\u200b\u8bfb\u200b\u3001IO\u200b\u8bfb\u200b\u3001\u200b\u914d\u7f6e\u200b\u8bfb\u200b\uff0c\u200b\u5148\u200b\u53d1\u51fa\u8bf7\u6c42\u200b\uff0c\u200b\u518d\u200b\u5f97\u5230\u200b\u6570\u636e\u200b</li> <li>\u200b\u5206\u4e3a\u200b2\u200b\u4e2a\u200b\u9636\u6bb5\u200b\uff1a\u200b\u8bfb\u200b\u8bf7\u6c42\u200b\u62a5\u6587\u200b\u3001\u200b\u5b8c\u6210\u200b\u62a5\u6587\u200b</li> <li>\u200b\u8bfb\u200b\u8bf7\u6c42\u200b\u62a5\u6587\u200b\uff1a\u200b\u4e0d\u200b\u542b\u200b\u6570\u636e\u200b</li> <li>\u200b\u5b8c\u6210\u200b\u62a5\u6587\u200b\uff1a\u200b\u542b\u200b\u6570\u636e\u200b</li> </ul>"},{"location":"10_PCI_PCIe/05_1/#33-tlp","title":"3.3 TLP\u200b\u5934\u90e8","text":""},{"location":"10_PCI_PCIe/05_1/#4-rc","title":"4. \u200b\u914d\u7f6e\u200b\u4e0e\u200bRC\u200b\u76f4\u8fde\u200b\u7684\u200b\u8bbe\u5907","text":""},{"location":"10_PCI_PCIe/05_1/#41","title":"4.1 \u200b\u600e\u4e48\u200b\u8bbf\u95ee\u200b\u76f4\u8fde\u200b\u7684\u200b\u8bbe\u5907","text":"<p>\u200b\u600e\u4e48\u200b\u8bbf\u95ee\u200b\u4e0b\u56fe\u200b\u7ea2\u5708\u200b\u4e2d\u200b\u7684\u200b\u8bbe\u5907\u200b\uff1a</p> <p></p> <p>RC\u200b\u672c\u8eab\u200b\u5c31\u662f\u200b\u4e00\u4e2a\u200b\u6865\u200b\uff0c\u200b\u8981\u200b\u53bb\u200b\u8bbf\u95ee\u200b\u8ddf\u6865\u200b\u76f4\u63a5\u200b\u76f8\u8fde\u200b\u7684\u200b\u8bbe\u5907\u200b\uff0c\u200b\u7528\u200bCfgRd0\u200b\u7c7b\u578b\u200b\u7684\u200bTLP\uff1a</p> <ul> <li>Fmt\u200b\u548c\u200bType\u200b\u53d6\u503c\u200b\u4e3a\u200b0b00, 0b00100\uff0c\u200b\u8868\u793a\u200b\uff1aConfiguration Read Type 0</li> <li>TLP\u200b\u4e2d\u200b\u8bbe\u7f6e\u200b\u6709\u200b\"Bus/Device/Funciton/Register\"</li> <li>\u200b\u63d0\u95ee\u200b\uff1a\u200b\u4e0a\u200b\u56fe\u7ea2\u5708\u200b\u4e2d\u200b\u662f\u200b\u8bbe\u5907\u200b\uff0c\u200b\u600e\u4e48\u200b\u77e5\u9053\u200b\u5b83\u200b\u81ea\u5df1\u200b\u7684\u200bBus\u200b\u53f7\u200b\u662f\u200b0\uff0cDevice\u200b\u5206\u522b\u200b\u662f\u200b0\u30011\u30012\uff1f</li> <li>\u200b\u7ea2\u5708\u200b\u4e2d\u200b\u7684\u200b\u8bbe\u5907\u200b\u90fd\u200b\u662f\u200b\u5728\u200bRC\u200b\u5185\u90e8\u200b\uff0c\u200b\u5b83\u4eec\u200b\u7684\u200bDevice\u200b\u53f7\u200b\u662f\u200b\u786c\u4ef6\u200b\u91cc\u200b\u5199\u200b\u6b7b\u200b\u7684\u200b(hard-coded)</li> <li>\u200b\u5f53\u200b\u8fd9\u4e9b\u200b\u8bbe\u5907\u200b\u76d1\u6d4b\u200b\u5230\u200bBus0\u200b\u4e0a\u200b\u7684\u200bTLP\u200b\u662f\u200bCfgRd0\u200b\u540e\u200b\uff0c\u200b\u5ffd\u7565\u200bTLP\u200b\u4e2d\u200b\u7684\u200bBus\uff0c\u200b\u6bd4\u200b\u5bf9\u200bTLP\u200b\u4e2d\u200b\u7684\u200bDevice</li> <li>\u200b\u5982\u679c\u200bDevice\u200b\u543b\u5408\u200b\uff0c\u200b\u5c31\u200b\u56de\u5e94\u200bTLP</li> </ul> <p></p>"},{"location":"10_PCI_PCIe/05_1/#42-eendpoint","title":"4.2 \u200b\u914d\u7f6e\u200bEendPoint","text":""},{"location":"10_PCI_PCIe/05_1/#5","title":"5. \u200b\u914d\u7f6e\u200b\u793a\u4f8b","text":"<p>\u200b\u672c\u200b\u8282\u200b\u5185\u5bb9\u200b\u53c2\u8003\u200b\u300aPCI Express Technology 3.0\u300b\u3002</p>"},{"location":"10_PCI_PCIe/05_1/#51","title":"5.1 \u200b\u5fc5\u5907\u200b\u77e5\u8bc6","text":""},{"location":"10_PCI_PCIe/05_1/#511-pcie","title":"5.1.1 PCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u5bc4\u5b58\u5668","text":"<p>PCI/PCIe\u200b\u8bbe\u5907\u200b\u3001\u200b\u6865\u200b\uff0c\u200b\u5b83\u4eec\u200b\u7684\u200b\u914d\u7f6e\u200b\u5bc4\u5b58\u5668\u200b\u524d\u9762\u200b\u82e5\u5e72\u200b\u5b57\u8282\u200b\u683c\u5f0f\u200b\u662f\u200b\u4e00\u6837\u200b\u7684\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u4ece\u200b\u91cc\u9762\u200b\u7684\u200b\"Header Type\"\u200b\u5206\u8fa8\u200b\uff1a</p> <ul> <li>\u200b\u5b83\u200b\u662f\u200b\u666e\u901a\u200b\u8bbe\u5907\u200b\uff0c\u200b\u8fd8\u662f\u200b\u6865\u200b</li> <li>\u200b\u5b83\u200b\u662f\u200b\u5355\u529f\u80fd\u200b\u8bbe\u5907\u200b\uff0c\u200b\u8fd8\u662f\u200b\u591a\u529f\u80fd\u200b\u8bbe\u5907\u200b\uff1a\u200b\u6240\u8c13\u200b\u529f\u80fd\u200b\uff0c\u200b\u5c31\u662f\u200bFunction\uff0c\u200b\u4e00\u4e2a\u200b\u7269\u7406\u200b\u8bbe\u5907\u200b\u53ef\u4ee5\u200b\u6709\u200b\u591a\u4e2a\u200b\u529f\u80fd\u200b\uff0c\u200b\u4e5f\u200b\u5c31\u200b\u6709\u200b\u591a\u4e2a\u200b\u903b\u8f91\u8bbe\u5907\u200b</li> </ul> <p></p> <p>\u200b\u4e00\u822c\u200b\u7684\u200bPCI/PCIe\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u914d\u7f6e\u200b\u5bc4\u5b58\u5668\u200b\u683c\u5f0f\u200b\u5982\u4e0a\u200b\u4e0a\u200b\u56fe\u200b\u7684\u200b\"Type 0 Header\"\uff0c\u200b\u5728\u200bPCIe\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\u8fd9\u7c7b\u200b\u8bbe\u5907\u200b\u88ab\u200b\u79f0\u4e3a\u200bEndpoint\u3002</p> <p>PCI/PCIe\u200b\u6865\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u914d\u7f6e\u200b\u5bc4\u5b58\u5668\u200b\u683c\u5f0f\u200b\u5982\u4e0a\u200b\u4e0a\u200b\u56fe\u200b\u7684\u200b\"Type 1 Header\"\uff0c</p> <p>\u200b\u5bf9\u4e8e\u200bPCI/PCIe\u200b\u6865\u200b\uff0c\u200b\u91cc\u9762\u200b\u7684\u200b\u7531\u200b\u4e09\u9879\u200b\u91cd\u8981\u200b\u7684\u200b\u603b\u7ebf\u200b\u53f7\u200b\uff1a</p> <ul> <li>Pirmary Bus Number\uff1a\u200b\u4e0a\u6e38\u200b\u603b\u7ebf\u200b\u53f7\u200b</li> <li>Secondary Bus Number\uff1a\u200b\u81ea\u5df1\u200b\u7684\u200b\u603b\u7ebf\u200b\u53f7\u200b</li> <li>Subordinate Bus Number\uff1a\u200b\u4e0b\u6e38\u200b\u603b\u7ebf\u200b\u53f7\u200b\u7684\u200b\u6700\u5927\u200b\u6570\u503c\u200b</li> </ul> <p>\u200b\u8fd9\u4e9b\u200b\u603b\u7ebf\u200b\u53f7\u200b\u793a\u4f8b\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/05_1/#512-type-0-configuration-request","title":"5.1.2 Type 0 Configuration Request","text":"<p>\u200b\u5982\u679c\u200b\u8981\u200b\u914d\u7f6e\u200b\u7684\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5c31\u200b\u5728\u200b\u5f53\u524d\u200b\u603b\u7ebf\u200b\u4e0a\u200b\uff0c\u200b\u5373\u200b\u76ee\u6807\u200b\u8bbe\u5907\u200b\u7684\u200bBus\u200b\u53f7\u200b\u7b49\u4e8e\u200b\u5f53\u524d\u200b\u6865\u200b\u7684\u200bSecondary Bus Number\uff0c</p> <p>\u200b\u90a3\u4e48\u200b\u5728\u200b\u5f53\u524d\u200b\u603b\u7ebf\u200b(\u200b\u5373\u200bSecondary Bus Number)\u200b\u4e0a\u200b\u4f20\u8f93\u200b\u7684\u200b\u5c31\u662f\u200b\"Type 0 Configuration Request\"\uff1a</p> <ul> <li>TLP\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b</li> <li>\u200b\u4e0d\u4f1a\u200b\u7a7f\u8fc7\u200b\u6865\u200b</li> </ul> <p></p>"},{"location":"10_PCI_PCIe/05_1/#513-type-1-configuration-request","title":"5.1.3 Type 1 Configuration Request","text":"<p>\u200b\u5982\u679c\u200b\u8981\u200b\u914d\u7f6e\u200b\u7684\u200b\u8bbe\u5907\u200b\uff0c\u200b\u4e0d\u200b\u5728\u200b\u5f53\u524d\u200b\u603b\u7ebf\u200b\u4e0a\u200b\uff0c\u200b\u4f46\u662f\u200b\u5728\u200b\u5b83\u200b\u4e0b\u9762\u200b\u7684\u200b\u603b\u7ebf\u200b\u4e0a\u200b\uff0c\u200b\u5373\u200b\uff1a</p> <ul> <li>\u200b\u76ee\u6807\u200b\u8bbe\u5907\u200b\u7684\u200bBus\u200b\u53f7\u200b\u5927\u4e8e\u200b\u5f53\u524d\u200b\u6865\u200b\u7684\u200bSecondary Bus Number\uff0c</li> <li>\u200b\u76ee\u6807\u200b\u8bbe\u5907\u200b\u7684\u200bBus\u200b\u53f7\u200b\u5c0f\u4e8e\u200b\u6216\u200b\u7b49\u4e8e\u200b\u5f53\u524d\u200b\u6865\u200b\u7684\u200bSubordinate Bus Number\uff0c</li> </ul> <p>\u200b\u90a3\u4e48\u200b\u5728\u200b\u5f53\u524d\u200b\u603b\u7ebf\u200b(\u200b\u5373\u200bSecondary Bus Number)\u200b\u4e0a\u200b\u4f20\u8f93\u200b\u7684\u200b\u5c31\u662f\u200b\"Type 1 Configuration Request\"\uff1a</p> <ul> <li>TLP\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b</li> <li>\u200b\u4f1a\u200b\u7a7f\u8fc7\u200b\u6865\u200b</li> <li>\u200b\u5230\u8fbe\u200b\u8bbe\u5907\u200b\u65f6\u200b\uff0c\u200b\u8ddf\u200b\u8bbe\u5907\u200b\u76f4\u63a5\u200b\u8fde\u63a5\u200b\u7684\u200b\u6865\u4f1a\u200b\u628a\u200b\u5b83\u200b\u8f6c\u6362\u200b\u4e3a\u200b\"Type 0 Configuration Request\"</li> </ul> <p></p>"},{"location":"10_PCI_PCIe/05_1/#52","title":"5.2 \u200b\u914d\u7f6e\u200b\u8fc7\u7a0b\u200b\u793a\u4f8b","text":""},{"location":"10_PCI_PCIe/05_1/#521","title":"5.2.1 \u200b\u786c\u4ef6\u200b\u62d3\u6251\u200b\u7ed3\u6784","text":"<p>\u200b\u4ee5\u4e0b\u200b\u56fe\u4e2d\u200b\u7684\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u8fc7\u7a0b\u200b\u4e3a\u4f8b\u200b\uff0c\u200b\u7ed9\u200b\u5927\u5bb6\u200b\u505a\u200b\u793a\u8303\u200b\u3002</p> <p></p>"},{"location":"10_PCI_PCIe/05_1/#522","title":"5.2.2 \u200b\u914d\u7f6e\u200b\u8fc7\u7a0b\u200b\u6f14\u793a","text":"<p>\u200b\u4e0b\u6587\u200b\u4e2d\u200bBDF\u200b\u8868\u793a\u200bBus,Device,Function\uff0c\u200b\u7528\u200b\u8fd9\u200b\u4e09\u4e2a\u200b\u6570\u503c\u200b\u6765\u200b\u8868\u793a\u200b\u8bbe\u5907\u200b\u3002</p> <ol> <li>\u200b\u8f6f\u4ef6\u200b\u8bbe\u7f6e\u200bHost/PCI Bridge\u200b\u7684\u200bSecondary Bus Number\u200b\u4e3a\u200b0\uff0cSubordinate Bus Number\u200b\u4e3a\u200b255(\u200b\u5148\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b\u6700\u5927\u200b\uff0c\u200b\u540e\u9762\u200b\u518d\u200b\u6539\u200b)\u3002</li> <li>\u200b\u4ece\u200bBus 0\u200b\u5f00\u59cb\u200b\u626b\u63cf\u200b\uff1a\u200b\u5148\u200b\u5c1d\u8bd5\u200b\u8bfb\u200b\u5230\u200bBDF(0,0,0)\u200b\u8bbe\u5907\u200b\u7684\u200bVendor ID\uff0c\u200b\u5982\u679c\u200b\u4e0d\u200b\u6210\u529f\u200b\u8868\u793a\u200b\u6ca1\u6709\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5c31\u200b\u5c1d\u8bd5\u200b\u4e0b\u200b\u4e00\u4e2a\u200b\u8bbe\u5907\u200bBDF(0,1,0)\u3002\u200b\u4e00\u4e2a\u200b\u6865\u4e0b\u200b\u6700\u200b\u591a\u200b\u53ef\u4ee5\u200b\u76f4\u63a5\u200b\u8fde\u63a5\u200b32\u200b\u4e2a\u200b\u8bbe\u5907\u200b\uff0c\u200b\u6240\u4ee5\u200b\u4f1a\u200b\u5c1d\u8bd5\u200b32\u200b\u6b21\u200b\uff1aDevice\u200b\u53f7\u200b\u4ece\u200b0\u200b\u5230\u200b31\u3002\u200b\u6ce8\u610f\u200b\uff1a\u200b\u5728\u200bHost/PCI Bridge\u200b\u4e2d\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u8bbe\u5907\u200b\u7684\u200bDevice\u200b\u53f7\u200b\u662f\u200b\u786c\u4ef6\u200b\u5199\u200b\u6b7b\u200b\u7684\u200b\u3002</li> <li>\u200b\u6b65\u9aa4\u200b2\u200b\u8bfb\u53d6\u200bBDF(0,0,0)\u200b\u8bbe\u5907\u200b(\u200b\u5373\u4f7f\u200b\u56fe\u4e2d\u200b\u7684\u200bA)\u200b\u65f6\u200b\uff0c\u200b\u53d1\u73b0\u200b\u5b83\u200b\u7684\u200bHeader Type\u200b\u662f\u200b01h\uff0c\u200b\u8868\u793a\u200b\u5b83\u200b\u662f\u200b\u4e00\u4e2a\u200b\u6865\u200b\u3001\u200b\u5355\u529f\u80fd\u200b\u8bbe\u5907\u200b</li> <li>\u200b\u53d1\u73b0\u200b\u4e86\u200b\u8bbe\u5907\u200bA\u200b\u662f\u200b\u4e00\u4e2a\u200b\u6865\u200b\uff0c\u200b\u914d\u7f6e\u200b\u5b83\u200b\uff1a</li> <li>Primary Bus Number Register = 0\uff1a\u200b\u5b83\u200b\u7684\u200b\u4e0a\u6e38\u200b\u603b\u7ebf\u200b\u662f\u200bBus 0</li> <li>Secondary Bus Number Register = 1\uff1a\u200b\u4ece\u200b\u5b83\u200b\u53d1\u51fa\u200b\u7684\u200b\u603b\u7ebf\u200b\u662f\u200bBus 1</li> <li>Subordinate Bus Number Register = 255\uff1a\u200b\u5148\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b\u6700\u5927\u200b\uff0c\u200b\u540e\u9762\u200b\u518d\u200b\u6539\u200b</li> <li>\u200b\u56e0\u4e3a\u200b\u53d1\u73b0\u200b\u4e86\u200b\u6865\u200bA\uff0c\u200b\u6267\u884c\u200b\"\u200b\u6df1\u5ea6\u200b\u4f18\u5148\u200b\"\u200b\u7684\u200b\u914d\u7f6e\u200b\u8fc7\u7a0b\u200b\uff1a\u200b\u5148\u200b\u53bb\u200b\u679a\u4e3e\u200bA\u200b\u4e0b\u9762\u200b\u7684\u200b\u8bbe\u5907\u200b\uff0c\u200b\u518d\u200b\u56de\u6765\u200b\u679a\u4e3e\u200b\u8ddf\u200bA\u200b\u540c\u7ea7\u200b\u7684\u200bB</li> <li>\u200b\u8f6f\u4ef6\u200b\u8bfb\u53d6\u200bBDF(1,0,0)\u200b\u8bbe\u5907\u200b(\u200b\u5c31\u662f\u200b\u8bbe\u5907\u200bC)\u200b\u7684\u200bVendor ID\uff0c\u200b\u6210\u529f\u200b\u5f97\u5230\u200bVendor ID\uff0c\u200b\u8868\u793a\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u5b58\u5728\u200b\u3002</li> <li>\u200b\u5b83\u200b\u7684\u200bHeader Type\u200b\u662f\u200b01h\uff0c\u200b\u8868\u793a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u6865\u200b\u3001\u200b\u5355\u529f\u80fd\u200b\u8bbe\u5907\u200b\u3002</li> <li>\u200b\u914d\u7f6e\u200b\u6865\u200bC\uff1a</li> <li>Primary Bus Number Register = 1\uff1a\u200b\u5b83\u200b\u7684\u200b\u4e0a\u6e38\u200b\u603b\u7ebf\u200b\u662f\u200bBus 1</li> <li>Secondary Bus Number Register = 2\uff1a\u200b\u4ece\u200b\u5b83\u200b\u53d1\u51fa\u200b\u7684\u200b\u603b\u7ebf\u200b\u662f\u200bBus 2</li> <li>Subordinate Bus Number Register = 255\uff1a\u200b\u5148\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b\u6700\u5927\u200b\uff0c\u200b\u540e\u9762\u200b\u518d\u200b\u6539\u200b</li> <li>\u200b\u7ee7\u7eed\u200b\u4ece\u6865\u200bC\u200b\u6267\u884c\u200b\"\u200b\u6df1\u5ea6\u200b\u4f18\u5148\u200b\"\u200b\u7684\u200b\u914d\u7f6e\u200b\u8fc7\u7a0b\u200b\uff0c\u200b\u679a\u4e3e\u200bBus 2\u200b\u4e0b\u200b\u7684\u200b\u8bbe\u5907\u200b\uff0c\u200b\u4ece\u200bBDF(2,0,0)\u200b\u5f00\u59cb\u200b</li> <li>\u200b\u8bfb\u53d6\u200bBDF(2,0,0)\u200b\u8bbe\u5907\u200b(\u200b\u5c31\u662f\u200b\u8bbe\u5907\u200bD)\u200b\u7684\u200bVendor ID\uff0c\u200b\u6210\u529f\u200b\u5f97\u5230\u200bVendor ID\uff0c\u200b\u8868\u793a\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u5b58\u5728\u200b\u3002</li> <li>\u200b\u5b83\u200b\u7684\u200bHeader Type\u200b\u662f\u200b01h\uff0c\u200b\u8868\u793a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u6865\u200b\u3001\u200b\u5355\u529f\u80fd\u200b\u8bbe\u5907\u200b\u3002</li> <li>\u200b\u914d\u7f6e\u200b\u6865\u200bD\uff1a<ul> <li>Primary Bus Number Register = 2\uff1a\u200b\u5b83\u200b\u7684\u200b\u4e0a\u6e38\u200b\u603b\u7ebf\u200b\u662f\u200bBus 2</li> <li>Secondary Bus Number Register = 3\uff1a\u200b\u4ece\u200b\u5b83\u200b\u53d1\u51fa\u200b\u7684\u200b\u603b\u7ebf\u200b\u662f\u200bBus 3</li> <li>Subordinate Bus Number Register = 255\uff1a\u200b\u5148\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b\u6700\u5927\u200b\uff0c\u200b\u540e\u9762\u200b\u518d\u200b\u6539\u200b</li> </ul> </li> <li>\u200b\u7ee7\u7eed\u200b\u4ece\u6865\u200bD\u200b\u6267\u884c\u200b\"\u200b\u6df1\u5ea6\u200b\u4f18\u5148\u200b\"\u200b\u7684\u200b\u914d\u7f6e\u200b\u8fc7\u7a0b\u200b\uff0c\u200b\u679a\u4e3e\u200bBus 2\u200b\u4e0b\u200b\u7684\u200b\u8bbe\u5907\u200b\uff0c\u200b\u4ece\u200bBDF(3,0,0)\u200b\u5f00\u59cb\u200b</li> <li>\u200b\u8bfb\u53d6\u200bBDF(3,0,0)\u200b\u8bbe\u5907\u200b\u7684\u200bVendor ID\uff0c\u200b\u6210\u529f\u200b\u5f97\u5230\u200bVendor ID\uff0c\u200b\u8868\u793a\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u5b58\u5728\u200b\u3002</li> <li>\u200b\u5b83\u200b\u7684\u200bHeader Type\u200b\u662f\u200b80h\uff0c\u200b\u8868\u793a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200bEndpoing\u3001\u200b\u591a\u529f\u80fd\u200b\u8bbe\u5907\u200b\u3002</li> <li>\u200b\u8f6f\u4ef6\u200b\u679a\u4e3e\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u7684\u200b\u6240\u6709\u200b8\u200b\u4e2a\u200b\u529f\u80fd\u200b\uff0c\u200b\u53d1\u73b0\u200b\u5b83\u200b\u6709\u200bFunction0\u30011</li> <li>\u200b\u8f6f\u4ef6\u200b\u7ee7\u7eed\u200b\u679a\u4e3e\u200bBus 3\u200b\u4e0a\u200b\u5176\u4ed6\u200b\u8bbe\u5907\u200b(Device\u200b\u53f7\u200b1~31)\uff0c\u200b\u6ca1\u200b\u53d1\u73b0\u200b\u66f4\u200b\u591a\u200b\u8bbe\u5907\u200b</li> <li>\u200b\u73b0\u5728\u200b\u5df2\u7ecf\u200b\u626b\u63cf\u200b\u5b8c\u6865\u200bD\u200b\u5373\u200bBus 3\u200b\u4e0b\u200b\u7684\u200b\u6240\u6709\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5b83\u200b\u4e0b\u9762\u200b\u6ca1\u6709\u200b\u6865\u200b\uff0c\u200b\u6240\u4ee5\u200b\u6865\u200bD\u200b\u7684\u200bSubordinate Bus Number\u200b\u7b49\u4e8e\u200b3\u3002\u200b\u626b\u63cf\u200b\u5b8c\u200bBus 3\u200b\u540e\u200b\uff0c\u200b\u56de\u9000\u200b\u5230\u200b\u4e0a\u200b\u4e00\u7ea7\u200bBus 2\uff0c\u200b\u7ee7\u7eed\u200b\u626b\u63cf\u200b\u5176\u4ed6\u200b\u8bbe\u5907\u200b\uff0c\u200b\u4ece\u200bBDF(2,1,0)\u200b\u5f00\u59cb\u200b\uff0c\u200b\u5c31\u662f\u200b\u5f00\u59cb\u200b\u626b\u63cf\u200b\u8bbe\u5907\u200bE\u3002</li> <li>\u200b\u8bfb\u53d6\u200bBDF(2,1,0)\u200b\u8bbe\u5907\u200b(\u200b\u5c31\u662f\u200b\u8bbe\u5907\u200bE)\u200b\u7684\u200bVendor ID\uff0c\u200b\u6210\u529f\u200b\u5f97\u5230\u200bVendor ID\uff0c\u200b\u8868\u793a\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u5b58\u5728\u200b\u3002</li> <li>\u200b\u5b83\u200b\u7684\u200bHeader Type\u200b\u662f\u200b01h\uff0c\u200b\u8868\u793a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u6865\u200b\u3001\u200b\u5355\u529f\u80fd\u200b\u8bbe\u5907\u200b\u3002</li> <li>\u200b\u914d\u7f6e\u200b\u6865\u200bE\uff1a<ul> <li>Primary Bus Number Register = 2\uff1a\u200b\u5b83\u200b\u7684\u200b\u4e0a\u6e38\u200b\u603b\u7ebf\u200b\u662f\u200bBus 2</li> <li>Secondary Bus Number Register = 4\uff1a\u200b\u4ece\u200b\u5b83\u200b\u53d1\u51fa\u200b\u7684\u200b\u603b\u7ebf\u200b\u662f\u200bBus 4</li> <li>Subordinate Bus Number Register = 255\uff1a\u200b\u5148\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b\u6700\u5927\u200b\uff0c\u200b\u540e\u9762\u200b\u518d\u200b\u6539\u200b</li> </ul> </li> <li>\u200b\u7ee7\u7eed\u200b\u4ece\u6865\u200bD\u200b\u6267\u884c\u200b\"\u200b\u6df1\u5ea6\u200b\u4f18\u5148\u200b\"\u200b\u7684\u200b\u914d\u7f6e\u200b\u8fc7\u7a0b\u200b\uff0c\u200b\u679a\u4e3e\u200bBus 4\u200b\u4e0b\u200b\u7684\u200b\u8bbe\u5907\u200b\uff0c\u200b\u4ece\u200bBDF(4,0,0)\u200b\u5f00\u59cb\u200b</li> <li>\u200b\u8bfb\u53d6\u200bBDF(4,0,0)\u200b\u8bbe\u5907\u200b\u7684\u200bVendor ID\uff0c\u200b\u6210\u529f\u200b\u5f97\u5230\u200bVendor ID\uff0c\u200b\u8868\u793a\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u5b58\u5728\u200b\u3002</li> <li>\u200b\u5b83\u200b\u7684\u200bHeader Type\u200b\u662f\u200b00h\uff0c\u200b\u8868\u793a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200bEndpoing\u3001\u200b\u5355\u529f\u80fd\u200b\u8bbe\u5907\u200b\u3002</li> <li>\u200b\u8f6f\u4ef6\u200b\u7ee7\u7eed\u200b\u679a\u4e3e\u200bBus 4\u200b\u4e0a\u200b\u5176\u4ed6\u200b\u8bbe\u5907\u200b(Device\u200b\u53f7\u200b1~31)\uff0c\u200b\u6ca1\u200b\u53d1\u73b0\u200b\u66f4\u200b\u591a\u200b\u8bbe\u5907\u200b</li> <li>\u200b\u5df2\u7ecf\u200b\u679a\u4e3e\u200b\u5b8c\u200b\u8bbe\u5907\u200bE\u200b\u5373\u200bBus 4\u200b\u4e0b\u200b\u7684\u200b\u6240\u6709\u200b\u8bbe\u5907\u200b\u4e86\u200b\uff0c\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200bE\u200b\u7684\u200bSubordinate Bus Number\u200b\u4e3a\u200b4\u3002\u200b\u7136\u540e\u200b\u7ee7\u7eed\u200b\u626b\u63cf\u200b\u8bbe\u5907\u200bE\u200b\u7684\u200b\u540c\u7ea7\u200b\u8bbe\u5907\u200b\uff1aBus=2\uff0cDevice\u200b\u4ece\u200b2\u200b\u5230\u200b31\uff0c\u200b\u53d1\u73b0\u200bBus 2\u200b\u4e0a\u200b\u6ca1\u6709\u200b\u8fd9\u4e9b\u200b\u8bbe\u5907\u200b\u3002</li> <li>\u200b\u8f6f\u4ef6\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200bC\u200b\u5373\u200bBus 2\u200b\u7684\u200b\u6865\u200b\uff0c\u200b\u628a\u200b\u5b83\u200b\u7684\u200bSubordinate Bus Number\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b4\u3002\u200b\u7136\u540e\u200b\u7ee7\u7eed\u200b\u626b\u63cf\u200b\u8bbe\u5907\u200bC\u200b\u7684\u200b\u540c\u7ea7\u200b\u8bbe\u5907\u200b\uff1aBus=1\uff0cDevice\u200b\u4ece\u200b1\u200b\u5230\u200b31\uff0c\u200b\u53d1\u73b0\u200bBus 1\u200b\u4e0a\u200b\u6ca1\u6709\u200b\u8fd9\u4e9b\u200b\u8bbe\u5907\u200b\u3002</li> <li>\u200b\u8f6f\u4ef6\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200bA\u200b\u5373\u200bBus 1\u200b\u7684\u200b\u6865\u200b\uff0c\u200b\u628a\u200b\u5b83\u200b\u7684\u200bSubordinate Bus Number\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b4\u3002\u200b\u7136\u540e\u200b\u7ee7\u7eed\u200b\u626b\u63cf\u200b\u8bbe\u5907\u200bA\u200b\u7684\u200b\u540c\u7ea7\u200b\u8bbe\u5907\u200b\uff1aBus=0\uff0cDevice\u200b\u4ece\u200b1\u200b\u5230\u200b31\uff0c\u200b\u53d1\u73b0\u200bBus 0\u200b\u4e0a\u200b\u7684\u200b\u8bbe\u5907\u200bB\u3002</li> <li>\u200b\u914d\u7f6e\u200b\u6865\u200bB\uff1a<ul> <li>Primary Bus Number Register = 0\uff1a\u200b\u5b83\u200b\u7684\u200b\u4e0a\u6e38\u200b\u603b\u7ebf\u200b\u662f\u200bBus 0</li> <li>Secondary Bus Number Register = 5\uff1a\u200b\u4ece\u200b\u5b83\u200b\u53d1\u51fa\u200b\u7684\u200b\u603b\u7ebf\u200b\u662f\u200bBus 5</li> <li>Subordinate Bus Number Register = 255\uff1a\u200b\u5148\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b\u6700\u5927\u200b\uff0c\u200b\u540e\u9762\u200b\u518d\u200b\u6539\u200b</li> </ul> </li> <li>\u200b\u518d\u200b\u4ece\u200b\u6865\u200bB\u200b\u5f00\u59cb\u200b\uff0c\u200b\u6267\u884c\u200b\"\u200b\u6df1\u5ea6\u200b\u4f18\u5148\u200b\"\u200b\u7684\u200b\u914d\u7f6e\u200b\u8fc7\u7a0b\u200b\u3002</li> </ol>"},{"location":"10_PCI_PCIe/06_1/","title":"06_PCIe\u200b\u8def\u7531\u200b\u65b9\u5f0f","text":""},{"location":"10_PCI_PCIe/06_1/#pcie","title":"PCIe\u200b\u8def\u7531\u200b\u65b9\u5f0f","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u300aPCI Express Technology 3.0\u300b\uff0cMike Jackson, Ravi Budruk; MindShare, Inc.</li> <li>\u300aPCIe\u200b\u626b\u76f2\u200b\u7cfb\u5217\u200b\u535a\u6587\u200b\u300b\uff0c\u200b\u4f5c\u8005\u200bFelix\uff0c\u200b\u8fd9\u200b\u662f\u200b\u5bf9\u200b\u300aPCI Express Technology\u300b\u200b\u7684\u200b\u7406\u89e3\u200b\u4e0e\u200b\u7ffb\u8bd1\u200b</li> <li>\u300aPCI EXPRESS\u200b\u4f53\u7cfb\u7ed3\u6784\u200b\u5bfc\u8bfb\u200b (\u200b\u738b\u9f50\u200b)\u300b</li> <li>\u300aPCI Express_ Base Specification Revision 4.0 Version 0.3 ( PDFDrive )\u300b</li> <li>\u300aNCB-PCI_Express_Base_5.0r1.0-2019-05-22\u300b</li> </ul>"},{"location":"10_PCI_PCIe/06_1/#1","title":"1. \u200b\u4e09\u79cd\u200b\u8def\u7531\u200b\u65b9\u5f0f","text":"<p>\u200b\u6570\u636e\u4f20\u8f93\u200b\u65f6\u200b\uff0c\u200b\u6700\u5148\u200b\u8981\u200b\u786e\u5b9a\u200b\u7684\u200b\u662f\u200b\uff1a\u200b\u600e\u4e48\u200b\u627e\u5230\u200b\u5bf9\u65b9\u200b\uff1f</p> <p>\u200b\u6240\u8c13\u200b\"\u200b\u8def\u7531\u200b\"\uff0c\u200b\u5c31\u662f\u200b\u600e\u4e48\u200b\u627e\u5230\u200b\u5bf9\u65b9\u200b\uff0cPCIe\u200b\u534f\u8bae\u200b\u4e2d\u6709\u200b\u4e09\u79cd\u200b\u8def\u7531\u200b\u65b9\u5f0f\u200b\uff1a</p> <ul> <li>\u200b\u57fa\u4e8e\u200bID\u200b\u7684\u200b\u8def\u7531\u200b</li> <li>\u200b\u57fa\u4e8e\u200b\u5730\u5740\u200b\u7684\u200b\u8def\u7531\u200b</li> <li>\u200b\u9690\u5f0f\u200b\u8def\u7531\u200b</li> </ul> <p>TLP\u200b\u4e2d\u200b\u600e\u4e48\u200b\u8868\u793a\u200b\u81ea\u5df1\u200b\u4f7f\u7528\u200b\u54ea\u200b\u79cd\u200b\u8def\u7531\u200b\uff1fTLP\u200b\u5934\u90e8\u200b\u5c31\u200b\u8868\u660e\u200b\u4e86\u200b\uff1a</p> <p></p> <p>\u200b\u8bbf\u95ee\u200bPCIe\u200b\u8bbe\u5907\u200b\u65f6\u200b\uff0c\u200b\u8981\u200b\u5148\u200b\u914d\u7f6e\u200b\uff0c\u200b\u624d\u80fd\u200b\u8bfb\u5199\u200b\u6570\u636e\u200b\uff1a</p> <ul> <li>\u200b\u914d\u7f6e\u200b\u8bfb\u200b\u3001\u200b\u914d\u7f6e\u200b\u5199\u200b\uff1a\u200b\u4f7f\u7528\u200b**\u200b\u57fa\u4e8e\u200bID\u200b\u7684\u200b\u8def\u7531\u200b**\uff0c\u200b\u5c31\u662f\u200b\u4f7f\u7528\u200b\u6765\u200b\u5bfb\u627e\u200b\u5bf9\u65b9\u200b\u3002\u200b\u914d\u7f6e\u200b\u6210\u529f\u200b\u540e\u200b\uff0c\u200b\u6bcf\u4e2a\u200bPCIe\u200b\u8bbe\u5907\u200b\u90fd\u200b\u6709\u200b\u81ea\u5df1\u200b\u7684\u200bPCIe\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u4e86\u200b\u3002</li> <li>\u200b\u5185\u5b58\u200b\u8bfb\u200b\u3001\u200b\u5185\u5b58\u200b\u5199\u200b\u6216\u8005\u200bIO\u200b\u8bfb\u200b\u3001IO\u200b\u5199\u200b\uff1a</li> <li>\u200b\u53d1\u51fa\u200b\u62a5\u6587\u200b\u7ed9\u200b\u5bf9\u65b9\u200b\uff1a\u200b\u4f7f\u7528\u200b**\u200b\u57fa\u4e8e\u200b\u5730\u5740\u200b\u7684\u200b\u8def\u7531\u200b**</li> <li>\u200b\u5bf9\u65b9\u200b\u8fd4\u56de\u200b\u6570\u636e\u200b\u6216\u8005\u200b\u8fd4\u56de\u200b\u72b6\u6001\u200b\u65f6\u200b\uff1a\u200b\u4f7f\u7528\u200b**\u200b\u57fa\u4e8e\u200bID\u200b\u7684\u200b\u8def\u7531\u200b**</li> <li>\u200b\u5404\u7c7b\u200b\u6d88\u606f\u200b\uff0c\u200b\u6bd4\u5982\u200b\u4e2d\u65ad\u200b\u3001\u200b\u5e7f\u64ad\u200b\u7b49\u200b\uff1a\u200b\u4f7f\u7528\u200b**\u200b\u9690\u5f0f\u200b\u8def\u7531\u200b**</li> </ul>"},{"location":"10_PCI_PCIe/06_1/#2-id","title":"2. \u200b\u57fa\u4e8e\u200bID\u200b\u7684\u200b\u8def\u7531","text":"<p>\u200b\u4e0b\u56fe\u200b\u6765\u81ea\u200b\u300aPCI Express_ Base Specification Revision 4.0 Version 0.3 ( PDFDrive ).pdf\u300b\uff1a</p> <p></p> <p>TLP\u200b\u4e2d\u200b\u542b\u6709\u200b\uff0c\u200b\u8fd9\u200b\u5c31\u662f\u200bID\u3002</p> <p>\u200b\u5bf9\u200bPCIe\u200b\u8bbe\u5907\u200b\u8fdb\u884c\u200b\u914d\u7f6e\u200b\u8bfb\u200b\u3001\u200b\u914d\u7f6e\u200b\u5199\u200b\u7684\u200b\u65f6\u5019\u200b\uff0c\u200b\u4f7f\u7528\u200b\u7684\u200b\u5c31\u662f\u200b**\u200b\u57fa\u4e8e\u200bID\u200b\u7684\u200b\u8def\u7531\u200b**\uff0c\u200b\u8fd9\u200b\u5728\u200b\u4e0a\u8282\u200b\u89c6\u9891\u200b\u5df2\u7ecf\u200b\u4ecb\u7ecd\u200b\u4e86\u200b\u3002</p> <p>\u200b\u914d\u7f6e\u200b\u6210\u529f\u200b\u540e\u200b\uff0c\u200b\u6bcf\u4e2a\u200bPCIe\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5305\u62ec\u200b\u865a\u62df\u200b\u7684\u200bPCIe\u200b\u6865\u200b\uff0c\u200b\u90fd\u200b\u5206\u914d\u200b\u5230\u200b\u4e86\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\uff1a</p> <ul> <li>PCIe\u200b\u8bbe\u5907\u200b(Endpoint)\uff1a\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u662f\u200b\u81ea\u5df1\u200b\u7684\u200b\uff0c\u200b\u522b\u7684\u200b\u8bbe\u5907\u200b\u8bbf\u95ee\u200b\u8fd9\u4e2a\u200b\u5730\u5740\u200b\u8303\u56f4\u200b\u65f6\u200b\uff0c\u200b\u5c31\u662f\u200b\u60f3\u200b\u8bbf\u95ee\u200b\u5b83\u200b</li> <li>PCIe\u200b\u6865\u200b\uff1a\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u662f\u200b\u4e0b\u9762\u200b\u7684\u200bPCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\uff0c\u200b\u522b\u7684\u200b\u8bbe\u5907\u200b\u8bbf\u95ee\u200b\u8fd9\u4e2a\u200b\u5730\u5740\u200b\u8303\u56f4\u200b\u65f6\u200b\uff0c\u200b\u5c31\u662f\u200b\u60f3\u200b\u8bbf\u95ee\u200b\u5b83\u200b\u4e0b\u9762\u200b\u7684\u200b\u8bbe\u5907\u200b</li> </ul>"},{"location":"10_PCI_PCIe/06_1/#21-pcieendpoint","title":"2.1 PCIe\u200b\u8bbe\u5907\u200b(Endpoint)\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4","text":"<p>Endpoint\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u91cc\u200b\u6709\u200b\"Base Address Regiseters\"\uff1a</p> <ul> <li>\u200b\u4e00\u200b\u5f00\u59cb\u200b\uff1a\u200b\u8fd9\u4e9b\u200b\u5bc4\u5b58\u5668\u200b\u7528\u6765\u200b\u58f0\u660e\u200b\uff1a\u200b\u9700\u8981\u200b\u591a\u5927\u200b\u7684\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u3001\u200b\u662f\u200b\u5185\u5b58\u7a7a\u95f4\u200b\u8fd8\u662f\u200bIO\u200b\u7a7a\u95f4\u200b</li> <li>\u200b\u88ab\u200b\u914d\u7f6e\u200b\u540e\u200b\uff1a\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u4e3a\u200b\u5b83\u200b\u5206\u914d\u200b\u51fa\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\uff0c\u200b\u628a\u200b\u9996\u200b\u5730\u5740\u200b\u5199\u5165\u200b\u8fd9\u4e9b\u200b\u5bc4\u5b58\u5668\u200b</li> </ul> <p>\u200b\u4e0b\u56fe\u200b\u6765\u81ea\u200b\u300aPCI Express_ Base Specification Revision 4.0 Version 0.3 ( PDFDrive ).pdf\u300b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/06_1/#22-pcie","title":"2.2 PCIe\u200b\u6865\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4","text":"<p>PCIe\u200b\u6865\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u91cc\u200b\u6709\u200b\"Primary Bus Number\u3001Secondary Bus Number\u3001Subordinate Bus Number\"\uff1a</p> <ul> <li>\u200b\u914d\u7f6e\u200bPCIe\u200b\u6865\u200b\u7684\u200b\u65f6\u5019\u200b\uff0c\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u4f1a\u200b\u586b\u5145\u200b\u8fd9\u4e9b\u200b\u4fe1\u606f\u200b</li> <li>\u200b\u5bf9\u4e8e\u200bID\u200b\u8def\u7531\u200b\uff0c\u200b\u5c06\u200b\u6839\u636e\u200b\u8fd9\u4e9b\u200b\u4fe1\u606f\u200b\u8f6c\u53d1\u200b\u62a5\u6587\u200b</li> </ul> <p>PCIe\u200b\u6865\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u91cc\u200b\u6709\u200b\"Memory Base\u3001Prefetchable Memory Base\u3001I/O Base\"\uff1a</p> <ul> <li>\u200b\u8868\u793a\u200b\u8be5\u6865\u200b\u4e0b\u6e38\u200b\u6240\u6709\u200b\u8bbe\u5907\u200b\u4f7f\u7528\u200b\u7684\u200b\u4e09\u7ec4\u200b\u7a7a\u95f4\u200b\u8303\u56f4\u200b</li> <li>\u200b\u5b58\u50a8\u5668\u200b\u7a7a\u95f4\u200b</li> <li>\u200b\u53ef\u200b\u9884\u53d6\u200b\u7684\u200b\u5b58\u50a8\u5668\u200b\u7a7a\u95f4\u200b</li> <li>I/O\u200b\u7a7a\u95f4\u200b</li> <li>\u200b\u5bf9\u4e8e\u200b\u5730\u5740\u200b\u8def\u7531\u200b\uff0c\u200b\u5c06\u200b\u6839\u636e\u200b\u8fd9\u4e9b\u200b\u4fe1\u606f\u200b\u8f6c\u53d1\u200b\u62a5\u6587\u200b</li> </ul> <p>\u200b\u4e0b\u56fe\u200b\u6765\u81ea\u200b\u300aPCI Express_ Base Specification Revision 4.0 Version 0.3 ( PDFDrive ).pdf\u300b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/06_1/#23","title":"2.3 \u200b\u793a\u4f8b","text":"<p>\u200b\u770b\u200b\u89c6\u9891\u200b\u3002</p> <p>\u200b\u914d\u7f6e\u200b\u65f6\u200b\u4f7f\u7528\u200bID\u200b\u8def\u7531\u200b\uff1b\u200b\u8fd4\u56de\u200b\u62a5\u6587\u200b\u65f6\u200b\u4e5f\u200b\u4f7f\u7528\u200bID\u200b\u8def\u7531\u200b\u3002</p>"},{"location":"10_PCI_PCIe/06_1/#3","title":"3. \u200b\u57fa\u4e8e\u200b\u5730\u5740\u200b\u7684\u200b\u8def\u7531","text":"<p>PCIe\u200b\u8bbe\u5907\u200b(EndPoint)\u200b\u88ab\u200b\u914d\u7f6e\u200b\u540e\u200b\uff0c\u200b\u5b83\u200b\u8bb0\u5f55\u200b\u6709\u200b\u5206\u914d\u200b\u7ed9\u200b\u5b83\u200b\u7684\u200b\u57fa\u200b\u5730\u5740\u200b\u3002</p> <p>PCIe\u200b\u6865\u200b\u4e5f\u200b\u8bb0\u5f55\u200b\u6709\u200b\u4e0b\u6e38\u200bPCI\u200b\u5b50\u6811\u200b\u7684\u200b\u57fa\u200b\u5730\u5740\u200b\u3002</p> <ul> <li>PCIe\u200b\u6865\u200b\u76d1\u6d4b\u200b\u603b\u7ebf\u200b\u4e0a\u200b\u7684\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u6839\u636e\u200bTLP\u200b\u91cc\u200b\u7684\u200b\u5730\u5740\u200b\u51b3\u5b9a\u200b\u662f\u5426\u200b\u8f6c\u53d1\u200b\u5230\u200b\u81ea\u5df1\u200b\u4e0b\u9762\u200b\u7684\u200b\u603b\u7ebf\u200b\u4e0a\u200b</li> <li>PCIe\u200b\u8bbe\u5907\u200b\u76d1\u6d4b\u200b\u603b\u7ebf\u200b\u4e0a\u200b\u7684\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u6839\u636e\u200bTLP\u200b\u91cc\u200b\u7684\u200b\u5730\u5740\u200b\u51b3\u5b9a\u200b\u662f\u5426\u200b\u8bbf\u95ee\u200b\u81ea\u5df1\u200b</li> <li>PCIe\u200b\u8bbe\u5907\u200b\u53d1\u51fa\u200b\u56de\u5e94\u200b\u7684\u200b\u62a5\u6587\u200b\u65f6\u200b\uff0c\u200b\u4f7f\u7528\u200b**\u200b\u57fa\u4e8e\u200bID\u200b\u7684\u200b\u8def\u7531\u200b**</li> </ul>"},{"location":"10_PCI_PCIe/06_1/#31-io","title":"3.1 \u200b\u5185\u5b58\u200b\u8bfb\u5199\u200b/IO\u200b\u8bfb\u5199","text":"<p>\u200b\u4e0b\u56fe\u200b\u6765\u81ea\u200b\u300aPCI Express_ Base Specification Revision 4.0 Version 0.3 ( PDFDrive ).pdf\u300b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/06_1/#32","title":"3.2 \u200b\u5b8c\u6210\u200b\u62a5\u6587","text":"<p>\u200b\u4e0a\u200b\u56fe\u200b\u91cc\u9762\u200b\u7684\u200bRequester ID\u3001TAG\uff0c\u200b\u88ab\u200b\u79f0\u4e3a\u200b\"Transaction ID\"\u3002 \u200b\u4e0b\u56fe\u200b\u6765\u81ea\u200b\u300aPCI EXPRESS\u200b\u4f53\u7cfb\u7ed3\u6784\u200b\u5bfc\u8bfb\u200b (\u200b\u738b\u9f50\u200b)\u300b\uff1a</p> <p></p> <p>\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u8981\u200b\u7ed9\u200bEndPoint\u200b\u7684\u200b\u5185\u5b58\u200b\u5199\u200b\u6570\u636e\u200b\uff0c\u200b\u5b83\u200b\u53d1\u51fa\u200b\"\u200b\u5185\u5b58\u200b\u5199\u200b\u62a5\u6587\u200b\"\uff0c\u200b\u4e0d\u200b\u9700\u8981\u200b\u5bf9\u65b9\u200b\u56de\u5e94\u200b\u3002</p> <p>\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u8981\u8bfb\u200bEndPoint\u200b\u7684\u200b\u5185\u5b58\u200b\u6570\u636e\u200b\uff0c\u200b\u5b83\u200b\u53d1\u51fa\u200b\"\u200b\u5185\u5b58\u200b\u8bfb\u62a5\u200b\u6587\u200b\"\uff0c\u200b\u9700\u8981\u200b\u5bf9\u65b9\u200b\u56de\u5e94\u200b\u3002</p> <p>\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u8981\u200b\u7ed9\u200bEndPoint\u200b\u7684\u200bIO\u200b\u5199\u200b\u6570\u636e\u200b\uff0c\u200b\u5b83\u200b\u53d1\u51fa\u200b\"IO\u200b\u5199\u200b\u62a5\u6587\u200b\"\uff0c\u200b\u9700\u8981\u200b\u5bf9\u65b9\u200b\u56de\u5e94\u200b\u3002</p> <p>\u200b\u4e3b\u200b\u8bbe\u5907\u200b\u8981\u8bfb\u200bEndPoint\u200b\u7684\u200bIO\u200b\u6570\u636e\u200b\uff0c\u200b\u5b83\u200b\u53d1\u51fa\u200b\"IO\u200b\u8bfb\u62a5\u200b\u6587\u200b\"\uff0c\u200b\u9700\u8981\u200b\u5bf9\u65b9\u200b\u56de\u5e94\u200b\u3002</p> <ul> <li>PCIe\u200b\u8bbe\u5907\u200b\u8981\u200b\u56de\u5e94\u200b\u65f6\u200b\uff0c\u200b\u56de\u5e94\u200b\u8c01\u200b\uff1f\u200b\u7ed9\u200b\"Requester ID\"\uff0c\u200b\u4f7f\u7528\u200b**\u200b\u57fa\u4e8e\u200bID\u200b\u7684\u200b\u8def\u7531\u200b**</li> <li>\u200b\u53d1\u8d77\u200bPCIe\u200b\u4f20\u8f93\u200b\u7684\u200b\u8bbe\u5907\u200b(\u200b\u4e3b\u200b\u8bbe\u5907\u200b)\uff0c\u200b\u5bf9\u200b\u6bcf\u6b21\u200b\u4f20\u8f93\u200b\u90fd\u200b\u5206\u914d\u200b\u4e00\u4e2a\u200b\u72ec\u4e00\u200b\u7684\u200bTag\uff0c\u200b\u5e76\u4e14\u200b\u5728\u200b\u786c\u4ef6\u200b\u5185\u90e8\u200b\u4fdd\u5b58\u200b\u5f53\u524d\u200bTLP</li> <li>\u200b\u63a5\u6536\u200b\u5230\u200b\u56de\u5e94\u200b\u62a5\u6587\u200b\u540e\u200b\uff0c\u200b\u624d\u200b\u4f1a\u200b\u6839\u636e\u200bTag\u200b\u6e05\u9664\u200b\u6389\u200b\u5185\u5b58\u200b\u4e2d\u200b\u4fdd\u5b58\u200b\u6570\u636e\u200b</li> <li>\u200b\u5982\u679c\u200b\u6ca1\u200b\u63a5\u6536\u200b\u5230\u200b\u56de\u5e94\u200b\uff0c\u200b\u6216\u8005\u200b\u5931\u8d25\u200b\u4e86\u200b\uff1a\u200b\u4f1a\u200b\u628a\u200b\u786c\u4ef6\u200b\u4e2d\u200b\u4fdd\u5b58\u200b\u7684\u200bTLP\u200b\u91cd\u65b0\u200b\u53d1\u9001\u200b\u51fa\u53bb\u200b</li> </ul> <p>\u200b\u56de\u5e94\u200b\u7684\u200b\u5b8c\u6210\u200b\u62a5\u6587\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u542b\u6709\u200b\u6570\u636e\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u4e0d\u200b\u542b\u200b\u6570\u636e\u200b\uff0c\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/06_1/#33","title":"3.3 \u200b\u793a\u4f8b","text":"<p>\u200b\u770b\u200b\u89c6\u9891\u200b\uff0c\u200b\u8bb2\u89e3\u200b\u4e0b\u56fe\u200b\uff0c\u200b\u6765\u81ea\u200b\u300aPCI EXPRESS\u200b\u4f53\u7cfb\u7ed3\u6784\u200b\u5bfc\u8bfb\u200b (\u200b\u738b\u9f50\u200b)\u300b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/06_1/#4","title":"4. \u200b\u9690\u5f0f\u200b\u8def\u7531","text":"<p>\u200b\u6d88\u606f\u62a5\u200b\u6587\u200b\u7684\u200b\u5934\u90e8\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u6d88\u606f\u62a5\u200b\u6587\u4e2d\u200b\u5934\u90e8\u200b\u7684\u200bType\u200b\u5b57\u6bb5\u200b\u91cc\u200b\u4f4e\u200b3\u200b\u4f4d\u200b\u8868\u793a\u200b\u9690\u5f0f\u200b\u8def\u7531\u200b\u65b9\u5f0f\u200b\uff1a</p> <ul> <li>000\uff1a\u200b\u8def\u7531\u200b\u5230\u200bRC</li> <li>001\uff1a\u200b\u4f7f\u7528\u200b\u5730\u5740\u200b\u8def\u7531\u200b(\u200b\u4f7f\u7528\u200b\u5730\u5740\u200b\u8def\u7531\u200b\u7684\u200b\u6d88\u606f\u200b\u4e0d\u200b\u5e38\u89c1\u200b)</li> <li>010\uff1a\u200b\u4f7f\u7528\u200bID\u200b\u8def\u7531\u200b</li> <li>011\uff1a\u200b\u6765\u81ea\u200bRC\u200b\u7684\u200b\u5e7f\u64ad\u200b\u62a5\u6587\u200b\uff0c\u200b\u5e95\u4e0b\u200b\u7684\u200bPCIe\u200b\u6865\u4f1a\u200b\u5411\u200b\u4e0b\u6e38\u200b\u8f6c\u53d1\u200b\u6b64\u200b\u6d88\u606f\u200b</li> <li>100\uff1a\u200b\u672c\u5730\u200b\u6d88\u606f\u200b\uff0c\u200b\u6d88\u606f\u200b\u5230\u8fbe\u200b\u76ee\u7684\u200b\u8bbe\u5907\u200b\u540e\u200b\u7ed3\u675f\u200b\uff0c\u200b\u4e0d\u4f1a\u200b\u518d\u6b21\u200b\u8f6c\u53d1\u200b</li> <li>101\uff1a\u200b\u8def\u7531\u200b\u5230\u200bRC\uff0c\u200b\u4ec5\u200b\u7528\u4e8e\u200b\u7535\u6e90\u200b\u7ba1\u7406\u200b</li> </ul> <p></p>"},{"location":"10_PCI_PCIe/07_1/","title":"07_PCI\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":""},{"location":"10_PCI_PCIe/07_1/#pci","title":"PCI\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u300aPCI Express Technology 3.0\u300b\uff0cMike Jackson, Ravi Budruk; MindShare, Inc.</li> <li>\u300aPCIe\u200b\u626b\u76f2\u200b\u7cfb\u5217\u200b\u535a\u6587\u200b\u300b\uff0c\u200b\u4f5c\u8005\u200bFelix\uff0c\u200b\u8fd9\u200b\u662f\u200b\u5bf9\u200b\u300aPCI Express Technology\u300b\u200b\u7684\u200b\u7406\u89e3\u200b\u4e0e\u200b\u7ffb\u8bd1\u200b</li> <li>\u300aPCI EXPRESS\u200b\u4f53\u7cfb\u7ed3\u6784\u200b\u5bfc\u8bfb\u200b (\u200b\u738b\u9f50\u200b)\u300b</li> <li>\u300aPCI Express_ Base Specification Revision 4.0 Version 0.3 ( PDFDrive )\u300b</li> <li>\u300aNCB-PCI_Express_Base_5.0r1.0-2019-05-22\u300b</li> <li>SOC\u200b\u4e2d\u200bAXI\u200b\u603b\u7ebf\u200b\u662f\u200b\u5982\u4f55\u200b\u8fde\u63a5\u200b\u7684\u200b</li> <li>AXI\u200b\u603b\u7ebf\u200b\u6574\u7406\u200b\u603b\u7ed3\u200b</li> <li>PCIe\u200b\u4e2d\u200bMSI\u200b\u548c\u200bMSI-X\u200b\u4e2d\u65ad\u200b\u673a\u5236\u200b</li> </ul> <p>\u200b\u5f00\u53d1\u677f\u200b\u8d44\u6599\u200b\uff1a</p> <ul> <li>https://wiki.t-firefly.com/zh_CN/ROC-RK3399-PC-PLUS/</li> </ul>"},{"location":"10_PCI_PCIe/07_1/#1-pci","title":"1. PCI\u200b\u9a71\u52a8\u200b\u6846\u67b6","text":""},{"location":"10_PCI_PCIe/07_1/#2-rk3399","title":"2. RK3399\u200b\u9a71\u52a8","text":"<p>\u200b\u600e\u4e48\u200b\u627e\u5230\u200b\u9a71\u52a8\u200b\uff1f</p> <ul> <li> <p>\u200b\u5728\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6839\u636e\u200b\u82af\u7247\u200b\u540d\u5b57\u200b\u627e\u5230\u200b\u6587\u4ef6\u200b\uff1a<code>drivers\\pci\\host\\pcie-rockchip.c</code></p> </li> <li> <p>\u200b\u770b\u5230\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>static const struct of_device_id rockchip_pcie_of_match[] = {\n    { .compatible = \"rockchip,rk3399-pcie\", },\n    {}\n};\n</code></pre> </li> <li> <p>\u200b\u5728\u200b\u5185\u6838\u200b<code>arch/arm64/boot/dts</code>\u200b\u4e0b\u200b\u641c\u200b\uff1a<code>grep \"rockchip,rk3399-pcie\" * -nr</code></p> </li> <li> <p>\u200b\u627e\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm64/boot/dts/rk3399.dtsi</code>\uff0c\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>        pcie0: pcie@f8000000 {\n                compatible = \"rockchip,rk3399-pcie\";\n                #address-cells = &lt;3&gt;;\n                #size-cells = &lt;2&gt;;\n                bus-range = &lt;0x0 0x1f&gt;;\n                ...... /* \u200b\u7701\u7565\u200b */\n                phys = &lt;&amp;pcie_phy&gt;;\n                phy-names = \"pcie-phy\";\n                ranges = &lt;0x83000000 0x0 0xfa000000 0x0 0xfa000000 0x0 0x1e00000\n                          0x81000000 0x0 0xfbe00000 0x0 0xfbe00000 0x0 0x100000&gt;;\n                reg = &lt;0x0 0xf8000000 0x0 0x2000000&gt;,\n                      &lt;0x0 0xfd000000 0x0 0x1000000&gt;;\n                ...... /* \u200b\u7701\u7565\u200b */\n          };\n</code></pre> </li> </ul>"},{"location":"10_PCI_PCIe/08_1/","title":"08_RK3399_PCIe\u200b\u82af\u7247\u200b\u624b\u518c\u200b\u89e3\u8bfb","text":""},{"location":"10_PCI_PCIe/08_1/#rk3399_pcie","title":"RK3399_PCIe\u200b\u82af\u7247\u200b\u624b\u518c\u200b\u89e3\u8bfb","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u300aPCI Express Technology 3.0\u300b\uff0cMike Jackson, Ravi Budruk; MindShare, Inc.</li> <li>\u300aPCIe\u200b\u626b\u76f2\u200b\u7cfb\u5217\u200b\u535a\u6587\u200b\u300b\uff0c\u200b\u4f5c\u8005\u200bFelix\uff0c\u200b\u8fd9\u200b\u662f\u200b\u5bf9\u200b\u300aPCI Express Technology\u300b\u200b\u7684\u200b\u7406\u89e3\u200b\u4e0e\u200b\u7ffb\u8bd1\u200b</li> <li>\u300aPCI EXPRESS\u200b\u4f53\u7cfb\u7ed3\u6784\u200b\u5bfc\u8bfb\u200b (\u200b\u738b\u9f50\u200b)\u300b</li> <li>\u300aPCI Express_ Base Specification Revision 4.0 Version 0.3 ( PDFDrive )\u300b</li> <li>\u300aNCB-PCI_Express_Base_5.0r1.0-2019-05-22\u300b</li> <li>SOC\u200b\u4e2d\u200bAXI\u200b\u603b\u7ebf\u200b\u662f\u200b\u5982\u4f55\u200b\u8fde\u63a5\u200b\u7684\u200b</li> <li>AXI\u200b\u603b\u7ebf\u200b\u6574\u7406\u200b\u603b\u7ed3\u200b</li> <li>PCIe\u200b\u4e2d\u200bMSI\u200b\u548c\u200bMSI-X\u200b\u4e2d\u65ad\u200b\u673a\u5236\u200b</li> </ul> <p>\u200b\u5f00\u53d1\u677f\u200b\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u200b\u82af\u7247\u200b\u624b\u518c\u200b\uff1aRockchip RK3399TRM V1.3 Part2.pdf \u300aChapter 17 PCIe Controller\u300b</li> </ul> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\doc_pic\\\n  10_PCI_PCIe\\\u200b\u82af\u7247\u200b\u624b\u518c\u200b\\RK3399\n      Rockchip RK3399TRM V1.3 Part2.pdf\n</code></pre> <ul> <li>https://wiki.t-firefly.com/zh_CN/ROC-RK3399-PC-PLUS/</li> </ul> <p>AXI\u200b\u76f8\u5173\u200b\uff1a</p> <ul> <li>ug1037-vivado-axi-reference-guide.pdf</li> </ul> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\doc_pic\\10_PCI_PCIe\\\u200b\u534f\u8bae\u200b\\AXI\n  ug1037-vivado-axi-reference-guide.pdf\n</code></pre> <ul> <li> <p>AXI\u200b\u603b\u7ebf\u200b\u4f60\u200b\u9700\u8981\u200b\u77e5\u9053\u200b\u7684\u200b\u4e8b\u513f\u200b</p> </li> <li> <p>AXI\u200b\u603b\u7ebf\u200b\u6574\u7406\u200b\u603b\u7ed3\u200b</p> </li> <li> <p>AMBA\u3001AHB\u3001APB\u3001AXI\u200b\u603b\u7ebf\u200b\u4ecb\u7ecd\u200b\u53ca\u200b\u5bf9\u6bd4\u200b </p> </li> </ul>"},{"location":"10_PCI_PCIe/08_1/#1-axi","title":"1. AXI\u200b\u603b\u7ebf","text":""},{"location":"10_PCI_PCIe/08_1/#11","title":"1.1 \u200b\u8fde\u63a5\u200b\u65b9\u5f0f","text":"<p>\u200b\u6211\u4eec\u200b\u4e00\u76f4\u200b\u4f7f\u7528\u200b\u8fd9\u4e2a\u200b\u56fe\u6765\u200b\u7b80\u5316\u200bCPU\u200b\u4e0e\u200b\u5916\u8bbe\u200b\u4e4b\u95f4\u200b\u7684\u200b\u8fde\u63a5\u200b\uff1a</p> <p></p> <p>\u200b\u5b9e\u9645\u200b\u82af\u7247\u200b\u4e2d\u200b\uff0cCPU\u200b\u4e0e\u200b\u5916\u8bbe\u200b\u4e4b\u95f4\u200b\u7684\u200b\u8fde\u63a5\u200b\u66f4\u52a0\u200b\u590d\u6742\u200b\uff0c\u200b\u9ad8\u901f\u200b\u8bbe\u5907\u200b\u4e4b\u95f4\u200b\u901a\u8fc7\u200bAXI\u200b\u603b\u7ebf\u200b\u8fde\u63a5\u200b\u3002AXI\u200b\u603b\u7ebf\u200b\u603b\u200b\u4f20\u8f93\u6570\u636e\u200b\u7684\u200b\u53cc\u65b9\u200b\u5206\u4e3a\u200bMaster\u200b\u548c\u200bSlave\uff0cMaster\u200b\u53d1\u8d77\u200b\u4f20\u8f93\u200b\uff0cSlave\u200b\u56de\u5e94\u200b\u4f20\u8f93\u200b\u3002Master\u200b\u548c\u200bSlave\u200b\u662f\u200b\u591a\u200b\u5bf9\u200b\u591a\u200b\u7684\u200b\u5173\u7cfb\u200b\uff0c\u200b\u5b83\u4eec\u200b\u4e4b\u95f4\u200b\u8bfb\u200b\u3001\u200b\u5199\u200b\u53ef\u4ee5\u200b\u540c\u65f6\u200b\u8fdb\u884c\u200b\u7684\u200b\uff0c\u200b\u5185\u90e8\u200b\u7ed3\u6784\u56fe\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/08_1/#12","title":"1.2 \u200b\u4e94\u4e2a\u200b\u901a\u9053","text":"<p>\u200b\u5728\u200bAXI\u200b\u603b\u7ebf\u200b\u4e2d\u200b\uff0c\u200b\u8bfb\u5199\u200b\u53ef\u4ee5\u200b\u540c\u65f6\u200b\u8fdb\u884c\u200b\uff0c\u200b\u6709\u200b5\u200b\u4e2a\u200b\u901a\u9053\u200b\uff1a</p> <ul> <li>\u200b\u8bfb\u200b\uff1a</li> <li>\u200b\u8bfb\u200b\u5730\u5740\u200b\u901a\u9053\u200b\uff1a\u200b\u4f20\u8f93\u200b\u8bfb\u200b\u64cd\u4f5c\u200b\u7684\u200b\u5730\u5740\u200b</li> <li>\u200b\u8bfb\u200b\u6570\u636e\u901a\u9053\u200b\uff1a\u200b\u4f20\u8f93\u200b\u8bfb\u5230\u200b\u7684\u200b\u6570\u636e\u200b</li> <li>\u200b\u5199\u200b\uff1a</li> <li>\u200b\u5199\u200b\u5730\u5740\u200b\u901a\u9053\u200b\uff1a\u200b\u4f20\u8f93\u200b\u5199\u200b\u64cd\u4f5c\u200b\u7684\u200b\u5730\u5740\u200b</li> <li>\u200b\u5199\u200b\u6570\u636e\u901a\u9053\u200b\uff1a\u200b\u4f20\u8f93\u200b\u8981\u200b\u5199\u200b\u7684\u200b\u6570\u636e\u200b</li> <li>\u200b\u5199\u200b\u54cd\u5e94\u200b\u901a\u9053\u200b\uff1a\u200b\u4f20\u8f93\u200b\u5199\u200b\u64cd\u4f5c\u200b\u7684\u200b\u7ed3\u679c\u200b</li> </ul> <p></p> <p></p> \u200b\u901a\u9053\u200b\u540d\u79f0\u200b \u200b\u901a\u9053\u200b\u529f\u80fd\u200b \u200b\u6570\u636e\u6d41\u200b\u5411\u200b read address \u200b\u8bfb\u200b\u5730\u5740\u200b\u901a\u9053\u200b \u200b\u4e3b\u673a\u200b-&gt;\u200b\u4ece\u673a\u200b read data \u200b\u8bfb\u200b\u6570\u636e\u901a\u9053\u200b\uff08\u200b\u5305\u62ec\u200b\u6570\u636e\u901a\u9053\u200b\u548c\u200b\u8bfb\u200b\u54cd\u5e94\u200b\u901a\u9053\u200b\uff09 \u200b\u4ece\u673a\u200b-&gt;\u200b\u4e3b\u673a\u200b write address \u200b\u5199\u200b\u5730\u5740\u200b\u901a\u9053\u200b \u200b\u4e3b\u673a\u200b-&gt;\u200b\u4ece\u673a\u200b write data \u200b\u5199\u200b\u6570\u636e\u901a\u9053\u200b \u200b\u4e3b\u673a\u200b-&gt;\u200b\u4ece\u673a\u200b write response \u200b\u5199\u200b\u54cd\u5e94\u200b\u901a\u9053\u200b \u200b\u4ece\u673a\u200b-&gt;\u200b\u4e3b\u673a"},{"location":"10_PCI_PCIe/08_1/#13","title":"1.3 \u200b\u4fe1\u53f7\u7ebf","text":"<p>\u200b\u6211\u4eec\u200b\u53ea\u200b\u5217\u51fa\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u5173\u5fc3\u200b\u7684\u200b\u4fe1\u53f7\u7ebf\u200b\uff1a</p> \u200b\u4fe1\u53f7\u200b AXI4 AXI4-Lite AWADDR \u200b\u5199\u200b\u5730\u5740\u200b\u901a\u9053\u200b\uff1a\u200b\u5730\u5740\u200b\u7ebf\u200b\uff0c\u200b\u6700\u591a\u200b\u53ef\u8fbe\u200b64\u200b\u4f4d\u200b \u200b\u5199\u200b\u5730\u5740\u200b\u901a\u9053\u200b\uff1a\u200b\u5730\u5740\u200b\u7ebf\u200b\uff0c\u200b\u6700\u591a\u200b\u53ef\u8fbe\u200b64\u200b\u4f4d\u200b WDATA \u200b\u5199\u200b\u6570\u636e\u901a\u9053\u200b\uff1a\u200b\u6570\u636e\u7ebf\u200b\uff0c32~1024\u200b\u4f4d\u200b \u200b\u5199\u200b\u6570\u636e\u901a\u9053\u200b\uff1a\u200b\u6570\u636e\u7ebf\u200b\uff0c32\u200b\u4f4d\u200b ARADDR \u200b\u8bfb\u200b\u5730\u5740\u200b\u901a\u9053\u200b\uff1a\u200b\u5730\u5740\u200b\u7ebf\u200b\uff0c\u200b\u6700\u591a\u200b\u53ef\u8fbe\u200b64\u200b\u4f4d\u200b \u200b\u8bfb\u200b\u5730\u5740\u200b\u901a\u9053\u200b\uff1a\u200b\u5730\u5740\u200b\u7ebf\u200b\uff0c\u200b\u6700\u591a\u200b\u53ef\u8fbe\u200b64\u200b\u4f4d\u200b RDATA \u200b\u8bfb\u200b\u6570\u636e\u901a\u9053\u200b\uff1a\u200b\u6570\u636e\u7ebf\u200b\uff0c32~1024\u200b\u4f4d\u200b \u200b\u5199\u200b\u6570\u636e\u901a\u9053\u200b\uff1a\u200b\u6570\u636e\u7ebf\u200b\uff0c32\u200b\u4f4d"},{"location":"10_PCI_PCIe/08_1/#14-pcie","title":"1.4 PCIe\u200b\u63a7\u5236\u5668","text":"<p>RK3399\u200b\u7684\u200bPCIe\u200b\u63a7\u5236\u5668\u200b\u5c31\u662f\u200b\u6302\u200b\u5728\u200bAXI\u200b\u603b\u7ebf\u200b\u4e0a\u200b\uff0c\u200b\u5728\u200b\u82af\u7247\u200b\u624b\u518c\u200b\u4e2d\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200b\uff1a</p> <ul> <li>AWADDR\uff1aAXI\u200b\u603b\u7ebf\u200b\u7684\u200b\u5199\u200b\u5730\u5740\u200b\u901a\u9053\u200b\u5730\u5740\u200b\u7ebf\u200b\uff0c\u200b\u7b80\u5355\u200b\u7406\u89e3\u200b\u5c31\u662f\u200bCPU\u200b\u8981\u200b\u5199\u200bPCIe\u200b\u63a7\u5236\u5668\u200b\u65f6\u200b\u53d1\u51fa\u200b\u7684\u200b\u5730\u5740\u200b\u7ebf\u200b</li> <li>ARADDR \uff1aAXI\u200b\u603b\u7ebf\u200b\u7684\u200b\u8bfb\u200b\u5730\u5740\u200b\u901a\u9053\u200b\u5730\u5740\u200b\u7ebf\u200b\uff0c\u200b\u7b80\u5355\u200b\u7406\u89e3\u200b\u5c31\u662f\u200bCPU\u200b\u8981\u8bfb\u200bPCIe\u200b\u63a7\u5236\u5668\u200b\u65f6\u200b\u53d1\u51fa\u200b\u7684\u200b\u5730\u5740\u200b\u7ebf\u200b</li> </ul> <p></p>"},{"location":"10_PCI_PCIe/08_1/#2","title":"2. \u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u548c\u200b\u5bc4\u5b58\u5668\u200b\u4ecb\u7ecd","text":""},{"location":"10_PCI_PCIe/08_1/#21","title":"2.1 \u200b\u60f3\u200b\u8fbe\u5230\u200b\u7684\u200b\u76ee\u7684","text":"<p>\u200b\u4f7f\u7528\u200bPCIe\u200b\u65f6\u200b\uff0c\u200b\u6211\u4eec\u200b\u7f16\u7a0b\u200b\u65f6\u60f3\u200b\u8fbe\u5230\u200b\u8fd9\u4e2a\u200b\u76ee\u7684\u200b\uff1a</p> <ul> <li> <p>CPU\u200b\u8bfb\u5199\u200b\u67d0\u4e2a\u200b\u5730\u5740\u200b\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u8bfb\u5199\u200b\u67d0\u4e2a\u200bPCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\uff1a   </p> </li> <li> <p>CPU\u200b\u8bfb\u5199\u200b\u67d0\u4e2a\u200b\u5730\u5740\u200b\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u8bfb\u5199\u200b\u67d0\u4e2a\u200bPCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\u5185\u5b58\u200b\u3001\u200b\u5bc4\u5b58\u5668\u200b\uff1a   </p> </li> </ul> <p>\u200b\u7b80\u5355\u200b\u5730\u8bf4\u200b\uff0c\u200b\u5c31\u662f\u200b\u628a\u200bCPU\u200b\u53d1\u51fa\u200b\u7684\u200baddr\uff0c\u200b\u8f6c\u6362\u200b\u4e3a\u200b\u53f3\u8fb9\u200b\u7684\u200bTLP\u200b\u5934\u90e8\u200b\uff1aPCI\u200b\u5730\u5740\u200b\u3001\u200b\u5934\u90e8\u200b\u7684\u200b\u5176\u4ed6\u200b\u4fe1\u606f\u200b\u3002</p> <p>\u200b\u8fd9\u200b\u6d89\u53ca\u200b\u4e24\u200b\u90e8\u5206\u200b\uff1a</p> <ul> <li>\u200b\u600e\u4e48\u200b\u628a\u200bCPU\u200b\u5730\u5740\u200b\u8f6c\u6362\u200b\u4e3a\u200bPCI\u200b\u5730\u5740\u200b</li> <li>\u200b\u600e\u4e48\u200b\u63d0\u4f9b\u200bTLP\u200b\u5934\u90e8\u200b\u4fe1\u606f\u200b\u4e2d\u200b\u7684\u200b\u5176\u4ed6\u200b\u90e8\u5206\u200b</li> </ul>"},{"location":"10_PCI_PCIe/08_1/#22","title":"2.2 \u200b\u5730\u5740\u200b\u7a7a\u95f4","text":"<p>RK3399\u200b\u8bbf\u95ee\u200bPCIe\u200b\u63a7\u5236\u5668\u200b\u65f6\u200b\uff0cCPU\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u53ef\u4ee5\u200b\u5206\u4e3a\u200b\uff1a</p> <ul> <li>Client Register Set\uff1a\u200b\u5730\u5740\u200b\u8303\u56f4\u200b 0xFD000000~0xFD7FFFFF\uff0c\u200b\u6bd4\u5982\u200b\u9009\u62e9\u200bPCIe\u200b\u534f\u8bae\u200b\u7684\u200b\u7248\u672c\u200b(Gen1/Gen2)\u3001\u200b\u7535\u6e90\u200b\u63a7\u5236\u200b\u7b49\u200b</li> <li>Core Register Set  \uff1a\u200b\u5730\u5740\u200b\u8303\u56f4\u200b 0xFD800000~0xFDFFFFFF\uff0c\u200b\u6240\u8c13\u200b\u6838\u5fc3\u200b\u5bc4\u5b58\u5668\u200b\u5c31\u662f\u200b\u7528\u6765\u200b\u8fdb\u884c\u200b\u8bbe\u7f6e\u200b\u5730\u5740\u6620\u5c04\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u7b49\u200b</li> <li>Region 0\uff1a0xF8000000~0xF9FFFFFF , 32MB\uff0c\u200b\u7528\u4e8e\u200b\u8bbf\u95ee\u200b\u5916\u63a5\u200b\u7684\u200bPCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b</li> <li>Region 1\uff1a0xFA000000~0xFA0FFFFF\uff0c1MB\uff0c\u200b\u7528\u4e8e\u200b\u5730\u5740\u200b\u8f6c\u6362\u200b</li> <li>Region 2\uff1a0xFA100000~0xFA1FFFFF\uff0c1MB\uff0c\u200b\u7528\u4e8e\u200b\u5730\u5740\u200b\u8f6c\u6362\u200b</li> <li>\u2026\u2026</li> <li>Region 32\uff1a0xFBF00000~0xFBFFFFFF\uff0c1MB\uff0c\u200b\u7528\u4e8e\u200b\u5730\u5740\u200b\u8f6c\u6362\u200b</li> </ul> <p>\u200b\u5176\u4e2d\u200bRegion 0\u200b\u5927\u5c0f\u200b\u4e3a\u200b32MB\uff0cRegion1~31\u200b\u5927\u5c0f\u200b\u5206\u522b\u200b\u4e3a\u200b1MB\u3002</p> <p>CPU\u200b\u8bbf\u95ee\u200bRegion 0\u200b\u7684\u200b\u5730\u5740\u200b\u65f6\u200b\uff0c\u200b\u5c06\u4f1a\u200b\u5bfc\u81f4\u200bPCIe\u200b\u63a7\u5236\u5668\u200b\u53d1\u51fa\u200b\u8bfb\u5199\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u7684\u200bTLP\u3002</p> <p>CPU\u200b\u8bbf\u95ee\u200bRegion 1~32\u200b\u7684\u200b\u5730\u5740\u200b\u65f6\u200b\uff0c\u200b\u5c06\u4f1a\u200b\u5bfc\u81f4\u200bPCIe\u200b\u63a7\u5236\u5668\u200b\u53d1\u51fa\u200b\u8bfb\u5199\u200b\u5185\u5b58\u200b\u3001IO\u200b\u7a7a\u95f4\u200b\u7684\u200bTLP\u3002</p>"},{"location":"10_PCI_PCIe/08_1/#23","title":"2.3 \u200b\u5bc4\u5b58\u5668\u200b\u4ecb\u7ecd","text":"<p>CPU\u200b\u8bbf\u95ee\u200b\u4e00\u4e2a\u200b\u5730\u5740\u200b\uff0c\u200b\u5bfc\u81f4\u200bPCIe\u200b\u63a7\u5236\u5668\u200b\u53d1\u51fa\u200bTLP\u3002TLP\u200b\u91cc\u200b\u542b\u6709\u200bPCIe\u200b\u5730\u5740\u200b\u3001\u200b\u5176\u4ed6\u200b\u4fe1\u606f\u200b\u3002</p> <p>\u200b\u8fd9\u4e9b\u200b\u5bc4\u5b58\u5668\u200b\u5fc5\u5b9a\u200b\u6d89\u53ca\u200b\u8fd9\u200b2\u200b\u90e8\u5206\u200b\uff1a</p> <ul> <li>\u200b\u5730\u5740\u200b\u8f6c\u6362\u200b\uff1a\u200b\u628a\u200bCPU\u200b\u5730\u5740\u200b\u8f6c\u6362\u200b\u4e3a\u200bPCIe\u200b\u5730\u5740\u200b</li> <li>\u200b\u63d0\u4f9b\u200bTLP\u200b\u7684\u200b\u5176\u4ed6\u200b\u4fe1\u606f\u200b</li> </ul> <p>Region0\u3001Region1~32\uff0c\u200b\u6bcf\u4e2a\u200bRegion\u200b\u90fd\u200b\u6709\u200b\u7c7b\u4f3c\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u3002</p> <p>\u200b\u4e00\u4e2a\u200bRegion\uff0c\u200b\u53ef\u4ee5\u200b\u7528\u4e8e\u200b\u8bfb\u5199\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u7528\u4e8e\u200b\u8bfb\u5199\u200b\u5185\u5b58\u7a7a\u95f4\u200b\u3001\u200b\u53ef\u4ee5\u200b\u7528\u4e8e\u200b\u8bfb\u5199\u200bIO\u200b\u7a7a\u95f4\u200b\uff0c\u200b\u8fd8\u200b\u53ef\u4ee5\u200b\u7528\u4e8e\u200b\u8bfb\u5199\u200b\u6d88\u606f\u200b\u3002</p> <p>\u200b\u8fd9\u200b\u7531\u200bRegion\u200b\u5bf9\u5e94\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u51b3\u5b9a\u200b\u3002</p> <p>\u200b\u6bcf\u4e2a\u200bRegion\u200b\u90fd\u200b\u6709\u200b\u4e00\u6837\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u4ee5\u200bRegion 0\u200b\u4e3a\u4f8b\u200b\uff0c\u200b\u6709\u200b6\u200b\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\uff1a</p> <p></p> <p>CPU\u200b\u8bbf\u95ee\u200b\u67d0\u4e2a\u200bRegion\u200b\u65f6\u200b\uff0c\u200b\u5b83\u200b\u662f\u200b\u60f3\u200b\u5e72\u561b\u200b\uff1f</p> <ul> <li>\u200b\u8bfb\u5199\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u3001\u200b\u53d1\u51fa\u200b\u5bf9\u5e94\u200bTLP\uff1f</li> <li>\u200b\u8bfb\u5199\u200b\u5185\u5b58\u7a7a\u95f4\u200b\u3001\u200b\u53d1\u51fa\u200b\u5bf9\u5e94\u200bTLP\uff1f</li> <li>\u200b\u8bfb\u5199\u200bIO\u200b\u7a7a\u95f4\u200b\u3001\u200b\u53d1\u51fa\u200b\u5bf9\u5e94\u200bTLP\uff1f</li> <li>\u200b\u8bfb\u5199\u200b\u6d88\u606f\u200b\u3001\u200b\u53d1\u51fa\u200b\u5bf9\u5e94\u200bTLP\uff1f</li> </ul> <p>\u200b\u5230\u5e95\u200b\u662f\u200b\u53d1\u51fa\u200b\u54ea\u200b\u79cd\u200bTLP\uff0c\u200b\u7531\u200bRegion\u200b\u5bf9\u5e94\u200b\u7684\u200bob_desc0\u200b\u5bc4\u5b58\u5668\u200b\u51b3\u5b9a\u200b\uff1a</p> ob_desc0[3:0] \u200b\u4f5c\u7528\u200b 1010 \u200b\u53d1\u51fa\u200b\u7684\u200bTLP\u200b\u7528\u4e8e\u200b\u8bbf\u95ee\u200bType 0\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b 1011 \u200b\u53d1\u51fa\u200b\u7684\u200bTLP\u200b\u7528\u4e8e\u200b\u8bbf\u95ee\u200bType 1\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b 0010 \u200b\u53d1\u51fa\u200b\u7684\u200bTLP\u200b\u7528\u4e8e\u200b\u8bfb\u5199\u200b\u5185\u5b58\u7a7a\u95f4\u200b 0110 \u200b\u53d1\u51fa\u200b\u7684\u200bTLP\u200b\u7528\u4e8e\u200b\u8bfb\u5199\u200bIO\u200b\u7a7a\u95f4\u200b 1100 \u200b\u53d1\u51fa\u200b\u7684\u200bTLP\u200b\u662f\u200b\"Normal Message\" 1101 \u200b\u53d1\u51fa\u200b\u7684\u200bTLP\u200b\u662f\u200b\"Vendor-Defined Message\" <p>CPU\u200b\u8bbf\u95ee\u200b\u67d0\u4e2a\u200bRegion\u200b\u65f6\u200b\uff0c\u200b\u6700\u7ec8\u200b\u90fd\u200b\u662f\u200b\u8981\u200b\u53d1\u51fa\u200bTLP\uff0cTLP\u200b\u7684\u200b\u5185\u5bb9\u200b\u600e\u4e48\u200b\u786e\u5b9a\u200b\uff1f</p> <ul> <li> <p>\u200b\u5730\u5740\u200b\u4fe1\u606f\u200b\uff1aob_addr0/1\u200b\u628a\u200bCPU\u200b\u5730\u5740\u200b\u8f6c\u6362\u200b\u4e3a\u200bPCIe\u200b\u5730\u5740\u200b\uff0c\u200b\u63d0\u4f9b\u200bTLP\u200b\u91cc\u9762\u200b\u7684\u200b\u5730\u5740\u200b\u4fe1\u606f\u200b</p> </li> <li> <p>\u200b\u5176\u4ed6\u200b\u4fe1\u606f\u200b\uff1aob_desc0/\u00bd/3\u200b\u63d0\u4f9b\u200bTLP\u200b\u7684\u200b\u5176\u4ed6\u200b\u4fe1\u606f\u200b</p> </li> </ul>"},{"location":"10_PCI_PCIe/08_1/#231","title":"2.3.1 \u200b\u7528\u4e8e\u200b\u914d\u7f6e\u200b\u7a7a\u95f4","text":"<p>Region0\u200b\u4e00\u822c\u200b\u7528\u4e8e\u200b\u8bfb\u5199\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\uff0c\u200b\u5b83\u200b\u5bf9\u5e94\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/08_1/#232-io","title":"2.3.2 \u200b\u7528\u4e8e\u200b\u5185\u5b58\u200b\u548c\u200bIO","text":""},{"location":"10_PCI_PCIe/08_1/#3","title":"3. \u200b\u8bbf\u95ee\u200b\u793a\u4f8b","text":""},{"location":"10_PCI_PCIe/08_1/#31","title":"3.1 \u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u8bfb\u5199\u200b\u793a\u4f8b","text":"<p>\u200b\u8981\u200b\u8bfb\u5199\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\uff0c\u200b\u9996\u5148\u200b\u8981\u200b\u5b9a\u4f4d\u200b\uff1aBus/Dev/Function/Reg\uff1a</p> <p></p> <p>\u200b\u600e\u4e48\u200b\u53d1\u51fa\u200b\u8fd9\u4e9b\u200b\"Bus/Dev/Function/Register\"\u200b\u4fe1\u606f\u200b\uff1f\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b\uff1a</p> <p></p> <p>\u200b\u5f53\u200bRegion 0\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200bob_desc0[3:0]\u200b\u88ab\u200b\u914d\u7f6e\u200b\u4e3a\u200b\u8bfb\u5199\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u65f6\u200b\uff0c CPU\u200b\u53d1\u51fa\u200bRegion 0\u200b\u7684\u200b\u5730\u5740\u200b\uff0c\u200b\u5730\u5740\u200b\u91cc\u9762\u200b\u9690\u542b\u200b\u6709\u200b\u8fd9\u4e9b\u200b\u4fe1\u606f\u200b\uff1a</p> <ul> <li>Bus\uff1acpu_addr[27:20]</li> <li>Dev\uff1acpu_addr[19:15]</li> <li>Fun\uff1acpu_addr[14:12]</li> <li>Reg\uff1acpu_addr[11:0]</li> </ul> <p>\u200b\u4f7f\u7528\u200b\u8fc7\u7a0b\u200b\u6b65\u9aa4\u200b\u5982\u4e0b\u200b\u3002</p>"},{"location":"10_PCI_PCIe/08_1/#311-region-0","title":"3.1.1 \u200b\u914d\u7f6e\u200bRegion 0\u200b\u7528\u4e8e\u200b\u8bfb\u5199\u200b\u914d\u7f6e\u200b\u7a7a\u95f4","text":""},{"location":"10_PCI_PCIe/08_1/#312-region-0","title":"3.1.2 \u200b\u914d\u7f6e\u200bRegion 0\u200b\u5730\u5740\u200b\u8f6c\u6362","text":"<p>\u200b\u6bd4\u5982\u200b\u6211\u4eec\u200b\u53ef\u4ee5\u200b\u8bbe\u7f6e\u200bbit[5:0]\u200b\u4e3a\u200b27\uff0c\u200b\u610f\u5473\u7740\u200bcpu_addr[27:0]\u200b\u8fd9\u200b28\u200b\u6761\u200b\u5730\u5740\u200b\u7ebf\u200b\u90fd\u200b\u4f1a\u200b\u4f20\u5165\u200bTLP\u3002</p> <p></p>"},{"location":"10_PCI_PCIe/08_1/#313-cpuregion-0","title":"3.1.3 CPU\u200b\u8bfb\u5199\u200bRegion 0\u200b\u7684\u200b\u5730\u5740","text":"<p>Region 0\u200b\u7684\u200b\u5730\u5740\u200b\u8303\u56f4\u200b\u662f\u200b\uff1a0xF8000000~0xF9FFFFFF\u3002</p> <p>CPU\u200b\u60f3\u200b\u8bbf\u95ee\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\uff1aBus=bus,Dev=dev,Fun=fun,Reg=reg\uff0c\u200b\u90a3\u4e48\u200bCPU\u200b\u8bfb\u5199\u200b\u8fd9\u4e2a\u200b\u5730\u5740\u200b\u5373\u53ef\u200b\uff1a</p> <pre><code>0xF8000000 + (bus&lt;&lt;20) | (dev&lt;&lt;15) | (fun&lt;&lt;12) | (reg)\n</code></pre>"},{"location":"10_PCI_PCIe/08_1/#32-memio","title":"3.2 MEM/IO\u200b\u8bfb\u5199\u200b\u793a\u4f8b","text":""},{"location":"10_PCI_PCIe/08_1/#321-region-1","title":"3.2.1 \u200b\u914d\u7f6e\u200bRegion 1\u200b\u7528\u4e8e\u200b\u5185\u5b58\u200b\u8bfb\u5199","text":""},{"location":"10_PCI_PCIe/08_1/#322-region-1","title":"3.2.2 \u200b\u914d\u7f6e\u200bRegion 1\u200b\u5730\u5740\u200b\u8f6c\u6362","text":"<p>addr0\u3001addr1\u200b\u5bc4\u5b58\u5668\u200b\u91cc\u200b\u4fdd\u5b58\u200b\u7684\u200b\u662f\u200bPCIe\u200b\u5730\u5740\u200b\uff0c\u200b\u4e5f\u200b\u5c31\u662f\u200bCPU\u200b\u53d1\u51fa\u200b\u8fd9\u4e2a\u200bRegion\u200b\u7684\u200bCPU\u200b\u5730\u5740\u200b\u540e\u200b\uff0c\u200b\u5c06\u4f1a\u200b\u8f6c\u6362\u200b\u4e3a\u200b\u67d0\u4e2a\u200bPCI\u200b\u5730\u5740\u200b\u3002</p> <p>\u200b\u600e\u4e48\u200b\u8f6c\u6362\u200b\uff1f\u200b\u7531\u200baddr0\u3001addr1\u200b\u51b3\u5b9a\u200b\u3002</p> <p>Region 1\u200b\u7684\u200bCPU\u200b\u5730\u5740\u200b\u8303\u56f4\u200b\u662f\u200b\uff1a0xFA000000~0xFA0FFFFF\uff0c\u200b\u662f\u200b1M\u200b\u7a7a\u95f4\u200b\u3002</p> <p>\u200b\u6211\u4eec\u200b\u4e00\u822c\u200b\u4f1a\u200b\u8ba9\u200bPCI\u200b\u5730\u5740\u200b\u7b49\u4e8e\u200bCPU\u200b\u5730\u5740\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8fd9\u6837\u200b\u8bbe\u7f6e\u200b\uff1a</p> <ul> <li>addr0\uff1a</li> <li>[5:0]\u200b\u7b49\u4e8e\u200b19\uff0c\u200b\u8868\u793a\u200bCPU_ADDR[19:0]\u200b\u5171\u200b20\u200b\u4f4d\u200b\u5730\u5740\u200b\u4f20\u5165\u200bTLP</li> <li>[31:8]\u200b\u7b49\u4e8e\u200b0xFA0000</li> <li>addr1\uff1a\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b0</li> </ul> <p>\u200b\u5982\u200b\u4e0a\u200b\u8bbe\u7f6e\u200b\u540e\u200b\uff0cCPU\u200b\u8bfb\u5199\u200b\u5730\u5740\u200b\u65f6\u200b0xFA0?????\uff0c\u200b\u5c31\u200b\u4f1a\u200b\u8f6c\u6362\u200b\u4e3a\u200bPCI\u200b\u5730\u5740\u200b\uff1a0xFA0?????\uff0c\u200b\u8f6c\u6362\u200b\u8fc7\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>pci_addr = cpu_addr[19:0] | (addr0[31:20] &lt;&lt; 20) | (addr1&lt;&lt;32)\n         = 0x????? + (0xFA0 &lt;&lt; 20) | (0 &lt;&lt; 32)\n         = 0xFA0?????\n</code></pre>"},{"location":"10_PCI_PCIe/09_1/","title":"09_RK3399_PCIe_Host\u200b\u9a71\u52a8\u200b\u5206\u6790\u200b_\u200b\u5730\u5740\u6620\u5c04","text":""},{"location":"10_PCI_PCIe/09_1/#rk3399_pcie_host_","title":"RK3399_PCIe_Host\u200b\u9a71\u52a8\u200b\u5206\u6790\u200b_\u200b\u5730\u5740\u6620\u5c04","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u300aPCI Express Technology 3.0\u300b\uff0cMike Jackson, Ravi Budruk; MindShare, Inc.</li> <li>\u300aPCIe\u200b\u626b\u76f2\u200b\u7cfb\u5217\u200b\u535a\u6587\u200b\u300b\uff0c\u200b\u4f5c\u8005\u200bFelix\uff0c\u200b\u8fd9\u200b\u662f\u200b\u5bf9\u200b\u300aPCI Express Technology\u300b\u200b\u7684\u200b\u7406\u89e3\u200b\u4e0e\u200b\u7ffb\u8bd1\u200b</li> <li>\u300aPCI EXPRESS\u200b\u4f53\u7cfb\u7ed3\u6784\u200b\u5bfc\u8bfb\u200b (\u200b\u738b\u9f50\u200b)\u300b</li> <li>\u300aPCI Express_ Base Specification Revision 4.0 Version 0.3 ( PDFDrive )\u300b</li> <li>\u300aNCB-PCI_Express_Base_5.0r1.0-2019-05-22\u300b</li> <li>SOC\u200b\u4e2d\u200bAXI\u200b\u603b\u7ebf\u200b\u662f\u200b\u5982\u4f55\u200b\u8fde\u63a5\u200b\u7684\u200b</li> <li>AXI\u200b\u603b\u7ebf\u200b\u6574\u7406\u200b\u603b\u7ed3\u200b</li> <li>PCIe\u200b\u4e2d\u200bMSI\u200b\u548c\u200bMSI-X\u200b\u4e2d\u65ad\u200b\u673a\u5236\u200b</li> </ul> <p>\u200b\u5f00\u53d1\u677f\u200b\u8d44\u6599\u200b\uff1a</p> <ul> <li>https://wiki.t-firefly.com/zh_CN/ROC-RK3399-PC-PLUS/</li> </ul> <p>\u200b\u672c\u200b\u8bfe\u7a0b\u200b\u5206\u6790\u200b\u7684\u200b\u6587\u4ef6\u200b\uff1a</p> <ul> <li><code>linux-4.4_rk3399\\drivers\\pci\\host\\pcie-rockchip.c</code></li> </ul>"},{"location":"10_PCI_PCIe/09_1/#1-pci","title":"1. PCI\u200b\u9a71\u52a8\u200b\u6846\u67b6","text":""},{"location":"10_PCI_PCIe/09_1/#2-host","title":"2. Host\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u901f\u89c8","text":"<p>\u200b\u600e\u4e48\u200b\u627e\u5230\u200b\u9a71\u52a8\u200b\uff1f</p> <ul> <li> <p>\u200b\u5728\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6839\u636e\u200b\u82af\u7247\u200b\u540d\u5b57\u200b\u627e\u5230\u200b\u6587\u4ef6\u200b\uff1a<code>drivers\\pci\\host\\pcie-rockchip.c</code></p> </li> <li> <p>\u200b\u770b\u5230\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>static const struct of_device_id rockchip_pcie_of_match[] = {\n    { .compatible = \"rockchip,rk3399-pcie\", },\n    {}\n};\n</code></pre> </li> <li> <p>\u200b\u5728\u200b\u5185\u6838\u200b<code>arch/arm64/boot/dts</code>\u200b\u4e0b\u200b\u641c\u200b\uff1a<code>grep \"rockchip,rk3399-pcie\" * -nr</code></p> </li> <li> <p>\u200b\u627e\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm64/boot/dts/rk3399.dtsi</code>\uff0c\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>        pcie0: pcie@f8000000 {\n                compatible = \"rockchip,rk3399-pcie\";\n                #address-cells = &lt;3&gt;;\n                #size-cells = &lt;2&gt;;\n                aspm-no-l0s;\n                clocks = &lt;&amp;cru ACLK_PCIE&gt;, &lt;&amp;cru ACLK_PERF_PCIE&gt;,\n                         &lt;&amp;cru PCLK_PCIE&gt;, &lt;&amp;cru SCLK_PCIE_PM&gt;;\n                clock-names = \"aclk\", \"aclk-perf\",\n                              \"hclk\", \"pm\";\n                bus-range = &lt;0x0 0x1f&gt;;\n                max-link-speed = &lt;1&gt;;\n                linux,pci-domain = &lt;0&gt;;\n                msi-map = &lt;0x0 &amp;its 0x0 0x1000&gt;;\n                interrupts = &lt;GIC_SPI 49 IRQ_TYPE_LEVEL_HIGH 0&gt;,\n                             &lt;GIC_SPI 50 IRQ_TYPE_LEVEL_HIGH 0&gt;,\n                             &lt;GIC_SPI 51 IRQ_TYPE_LEVEL_HIGH 0&gt;;\n                interrupt-names = \"sys\", \"legacy\", \"client\";\n                #interrupt-cells = &lt;1&gt;;\n                interrupt-map-mask = &lt;0 0 0 7&gt;;\n                interrupt-map = &lt;0 0 0 1 &amp;pcie0_intc 0&gt;,\n                                &lt;0 0 0 2 &amp;pcie0_intc 1&gt;,\n                                &lt;0 0 0 3 &amp;pcie0_intc 2&gt;,\n                                &lt;0 0 0 4 &amp;pcie0_intc 3&gt;;\n                phys = &lt;&amp;pcie_phy&gt;;\n                phy-names = \"pcie-phy\";\n                ranges = &lt;0x83000000 0x0 0xfa000000 0x0 0xfa000000 0x0 0x1e00000\n                          0x81000000 0x0 0xfbe00000 0x0 0xfbe00000 0x0 0x100000&gt;;\n                reg = &lt;0x0 0xf8000000 0x0 0x2000000&gt;,\n                      &lt;0x0 0xfd000000 0x0 0x1000000&gt;;\n                reg-names = \"axi-base\", \"apb-base\";\n                resets = &lt;&amp;cru SRST_PCIE_CORE&gt;, &lt;&amp;cru SRST_PCIE_MGMT&gt;,\n                         &lt;&amp;cru SRST_PCIE_MGMT_STICKY&gt;, &lt;&amp;cru SRST_PCIE_PIPE&gt;,\n                         &lt;&amp;cru SRST_PCIE_PM&gt;, &lt;&amp;cru SRST_P_PCIE&gt;,\n                         &lt;&amp;cru SRST_A_PCIE&gt;;\n                reset-names = \"core\", \"mgmt\", \"mgmt-sticky\", \"pipe\",\n                              \"pm\", \"pclk\", \"aclk\";\n                status = \"disabled\";\n                pcie0_intc: interrupt-controller {\n                        interrupt-controller;\n                        #address-cells = &lt;0&gt;;\n                        #interrupt-cells = &lt;1&gt;;\n                };\n        };\n</code></pre> </li> </ul> <p>\u200b\u6240\u8c13\u200b<code>Host</code>\uff0c\u200b\u5c31\u662f\u200bPCIe\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u9a71\u52a8\u200b\u505a\u200b\u4ec0\u4e48\u200b\uff1f</p> <ul> <li>\u200b\u89e3\u6790\u200b\u8bbe\u5907\u200b\u6811\u200b\uff0c\u200b\u6839\u636e\u200b\u8bbe\u5907\u200b\u6811\u200b\u786e\u5b9a\u200b\uff1a\u200b\u5bc4\u5b58\u5668\u200b\u5730\u5740\u200b\u3001CPU\u200b\u7a7a\u95f4\u200b\u5730\u5740\u200b\u3001PCI\u200b\u7a7a\u95f4\u200b\u5730\u5740\u200b\u3001\u200b\u4e2d\u65ad\u200b\u4fe1\u606f\u200b</li> <li>\u200b\u8bb0\u5f55\u200b\u8d44\u6e90\u200b\uff1aCPU\u200b\u7a7a\u95f4\u200b\u5730\u5740\u200b\u3001PCI\u200b\u7a7a\u95f4\u200b\u5730\u5740\u200b</li> <li>\u200b\u521d\u59cb\u5316\u200bPCIe\u200b\u63a7\u5236\u5668\u200b\u672c\u8eab\u200b\uff0c\u200b\u5efa\u7acb\u200bCPU\u200b\u5730\u5740\u200b\u548c\u200bPCI\u200b\u5730\u5740\u200b\u7684\u200b\u6620\u5c04\u200b</li> <li>\u200b\u626b\u63cf\u200b\u8bc6\u522b\u200b\u5f53\u524d\u200bPCIe\u200b\u63a7\u5236\u5668\u200b\u4e0b\u9762\u200b\u7684\u200bPCIe\u200b\u8bbe\u5907\u200b</li> </ul> <p>\u200b\u9a71\u52a8\u200b\u6587\u4ef6\u200b<code>drivers\\pci\\host\\pcie-rockchip.c</code>\u200b\u4e2d\u200b\u6ce8\u518c\u200b\u4e86\u200b\u4e00\u4e2a\u200bplatform_driver\uff0c\u200b\u4ece\u200b\u5b83\u200b\u7684\u200bprobe\u200b\u51fd\u6570\u200b\u5f00\u59cb\u200b\u5206\u6790\u200b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/09_1/#3","title":"3. \u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\u89e3\u6790","text":"<p>RK3399\u200b\u8bbf\u95ee\u200bPCIe\u200b\u63a7\u5236\u5668\u200b\u65f6\u200b\uff0cCPU\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u53ef\u4ee5\u200b\u5206\u4e3a\u200b\uff1a</p> <ul> <li>Client Register Set\uff1a\u200b\u5730\u5740\u200b\u8303\u56f4\u200b 0xFD000000~0xFD7FFFFF\uff0c\u200b\u6bd4\u5982\u200b\u9009\u62e9\u200bPCIe\u200b\u534f\u8bae\u200b\u7684\u200b\u7248\u672c\u200b(Gen1/Gen2)\u3001\u200b\u7535\u6e90\u200b\u63a7\u5236\u200b\u7b49\u200b</li> <li>Core Register Set  \uff1a\u200b\u5730\u5740\u200b\u8303\u56f4\u200b 0xFD800000~0xFDFFFFFF\uff0c\u200b\u6240\u8c13\u200b\u6838\u5fc3\u200b\u5bc4\u5b58\u5668\u200b\u5c31\u662f\u200b\u7528\u6765\u200b\u8fdb\u884c\u200b\u8bbe\u7f6e\u200b\u5730\u5740\u6620\u5c04\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u7b49\u200b</li> <li>Region 0\uff1a0xF8000000~0xF9FFFFFF , 32MB\uff0c\u200b\u7528\u4e8e\u200b\u8bbf\u95ee\u200b\u5916\u63a5\u200b\u7684\u200bPCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b</li> <li>Region 1\uff1a0xFA000000~0xFA0FFFFF\uff0c1MB\uff0c\u200b\u7528\u4e8e\u200b\u5730\u5740\u200b\u8f6c\u6362\u200b</li> <li>Region 2\uff1a0xFA100000~0xFA1FFFFF\uff0c1MB\uff0c\u200b\u7528\u4e8e\u200b\u5730\u5740\u200b\u8f6c\u6362\u200b</li> <li>\u2026\u2026</li> <li>Region 32\uff1a0xFBF00000~0xFBFFFFFF\uff0c1MB\uff0c\u200b\u7528\u4e8e\u200b\u5730\u5740\u200b\u8f6c\u6362\u200b</li> </ul> <p>\u200b\u5176\u4e2d\u200bRegion 0\u200b\u5927\u5c0f\u200b\u4e3a\u200b32MB\uff0cRegion1~31\u200b\u5927\u5c0f\u200b\u5206\u522b\u200b\u4e3a\u200b1MB\u3002</p> <p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u90fd\u200b\u6709\u200b\u4f53\u73b0\u200b(\u200b\u4e0b\u5217\u200b\u4ee3\u7801\u200b\u4e2d\u200b\uff0c\u200b\u5176\u4ed6\u200b\u4fe1\u606f\u200b\u7701\u7565\u200b\u4e86\u200b)\uff1a</p> <ul> <li>reg\u200b\u5c5e\u6027\u200b\u91cc\u200b\u7684\u200b0xf8000000\uff1aRegion 0\u200b\u7684\u200b\u5730\u5740\u200b</li> <li>reg\u200b\u5c5e\u6027\u200b\u91cc\u200b\u7684\u200b0xfd000000\uff1aPCIe\u200b\u63a7\u5236\u5668\u200b\u5185\u90e8\u200b\u5bc4\u5b58\u5668\u200b\u7684\u200b\u5730\u5740\u200b</li> <li>Client Register Set\uff1a\u200b\u5730\u5740\u200b\u8303\u56f4\u200b 0xFD000000~0xFD7FFFFF</li> <li>Core Register Set  \uff1a\u200b\u5730\u5740\u200b\u8303\u56f4\u200b 0xFD800000~0xFDFFFFFF</li> <li>ranges\u200b\u5c5e\u6027\u200b\u91cc\u200b</li> <li>\u200b\u7b2c\u200b1\u200b\u4e2a\u200b0xfa000000\uff1aRegion1~30\u200b\u7684\u200bCPU\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u9996\u200b\u5730\u5740\u200b\uff0c\u200b\u7528\u4e8e\u200b\u5185\u5b58\u200b\u8bfb\u5199\u200b</li> <li>\u200b\u7b2c\u200b2\u200b\u4e2a\u200b0xfa000000\uff1aRegion1~30\u200b\u7684\u200bPCI\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u9996\u200b\u5730\u5740\u200b\uff0c\u200b\u7528\u4e8e\u200b\u5185\u5b58\u200b\u8bfb\u5199\u200b</li> <li>\u200b\u7b2c\u200b1\u200b\u4e2a\u200b0xfbe00000\uff1aRegion31\u200b\u7684\u200bCPU\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u9996\u200b\u5730\u5740\u200b\uff0c\u200b\u7528\u4e8e\u200bIO\u200b\u8bfb\u5199\u200b</li> <li>\u200b\u7b2c\u200b2\u200b\u4e2a\u200b0xfbe00000\uff1aRegion31\u200b\u7684\u200bPCI\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u9996\u200b\u5730\u5740\u200b\uff0c\u200b\u7528\u4e8e\u200bIO\u200b\u8bfb\u5199\u200b</li> <li>Region32\u200b\u5462\u200b\uff1f\u200b\u5728\u200b.c\u200b\u6587\u4ef6\u200b\u91cc\u200b\u7528\u4f5c\u200b\"\u200b\u6d88\u606f\u200bTLP\"</li> </ul> <pre><code>        pcie0: pcie@f8000000 {\n                compatible = \"rockchip,rk3399-pcie\";\n                #address-cells = &lt;3&gt;;\n                #size-cells = &lt;2&gt;;\n                ranges = &lt;0x83000000 0x0 0xfa000000 0x0 0xfa000000 0x0 0x1e00000\n                          0x81000000 0x0 0xfbe00000 0x0 0xfbe00000 0x0 0x100000&gt;;\n                reg = &lt;0x0 0xf8000000 0x0 0x2000000&gt;,\n                      &lt;0x0 0xfd000000 0x0 0x1000000&gt;;\n                reg-names = \"axi-base\", \"apb-base\";\n        };\n</code></pre>"},{"location":"10_PCI_PCIe/09_1/#4","title":"4. \u200b\u8bbe\u5907\u200b\u6811\u200b\u76f8\u5173\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5206\u6790","text":"<p>\u200b\u4ee3\u7801\u200b\u5165\u53e3\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/09_1/#41-region0","title":"4.1 Region0\u200b\u548c\u200b\u5bc4\u5b58\u5668\u200b\u5730\u5740","text":"<p>0xF8000000\u200b\u5c31\u662f\u200bRK3399\u200b\u7684\u200bRegion0\u200b\u5730\u5740\u200b\uff0c\u200b\u7528\u4e8e\u200b ECAM\uff1aPCIe ECAM\u200b\u4ecb\u7ecd\u200b\u3002</p> <p>\u200b\u5373\u200b\uff1a\u200b\u53ea\u200b\u5199\u200b\u8bfb\u5199\u200b0xF8000000\u200b\u8fd9\u200b\u6bb5\u200b\u7a7a\u95f4\u200b\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u53ea\u200b\u5199\u200b\u8bfb\u5199\u200bPCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u3002</p> <p>0xFD000000\u200b\u5373\u4f7f\u200bRK3399 PCIe\u200b\u63a7\u5236\u5668\u200b\u672c\u8eab\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u57fa\u200b\u5730\u5740\u200b\u3002</p> <p>Region0\u200b\u7528\u200b\u4e0e\u200b\u8bfb\u5199\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\uff0c\u200b\u5b83\u200b\u5bf9\u5e94\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u8981\u200b\u8bbe\u7f6e\u200b\u7528\u4e8e\u200b\u4ea7\u751f\u200b\u5bf9\u5e94\u200b\u7684\u200bTLP\uff0c\u200b\u51fd\u6570\u8c03\u7528\u200b\u5173\u7cfb\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>rockchip_pcie_probe\n    err = rockchip_pcie_init_port(rockchip);\n</code></pre> <p></p>"},{"location":"10_PCI_PCIe/09_1/#42-cpupci","title":"4.2 \u200b\u786e\u5b9a\u200bCPU/PCI\u200b\u5730\u5740\u200b\u7a7a\u95f4","text":"<p>\u200b\u5728\u200bPCIe\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6709\u200b\u4e00\u4e2a\u200b\u5c5e\u6027\u200b<code>ranges</code>\uff0c\u200b\u5b83\u200b\u91cc\u9762\u200b\u542b\u6709\u200b\u591a\u4e2a\u200brange\uff0c\u200b\u6bcf\u4e2a\u200brange\u200b\u63cf\u8ff0\u200b\u4e86\u200b\uff1a</p> <ul> <li>flags\uff1a\u200b\u662f\u200b\u5185\u5b58\u200b\u8fd8\u662f\u200bIO</li> <li>PCIe\u200b\u5730\u5740\u200b</li> <li>CPU\u200b\u5730\u5740\u200b</li> <li>\u200b\u957f\u5ea6\u200b</li> </ul> <p>\u200b\u5148\u200b\u63d0\u524d\u200b\u8bf4\u200b\u4e00\u4e0b\u200b\u600e\u4e48\u200b\u89e3\u6790\u200b\u8fd9\u4e9b\u200brange\uff0c\u200b\u51fd\u6570\u200b\u4e3a\u200b<code>for_each_of_pci_range</code>\uff0c\u200b\u89e3\u6790\u200b\u8fc7\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u4ece\u200bprobe\u200b\u51fd\u6570\u200b\u5f00\u59cb\u200b\u5206\u6790\u200b\uff0c\u200b\u5b8c\u6574\u200b\u7684\u200b\u4ee3\u7801\u200b\u6d41\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>rockchip_pcie_probe\n    resource_size_t io_base;\n    LIST_HEAD(res); // \u200b\u8d44\u6e90\u200b\u94fe\u8868\u200b\n\n    // \u200b\u89e3\u6790\u200b\u8bbe\u5907\u200b\u6811\u200b\u83b7\u5f97\u200bPCI host bridge\u200b\u7684\u200b\u8d44\u6e90\u200b(CPU\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u3001PCI\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u3001\u200b\u5927\u5c0f\u200b)\n    err = of_pci_get_host_bridge_resources(dev-&gt;of_node, 0, 0xff, &amp;res, &amp;io_base);\n        // \u200b\u89e3\u6790\u200b bus-range\n        // \u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b:  bus-range = &lt;0x0 0x1f&gt;;\n        // \u200b\u89e3\u6790\u200b\u5f97\u5230\u200b: bus_range-&gt;start= 0 , \n        //          bus_range-&gt;end = 0x1f, \n        //          bus_range-&gt;flags = IORESOURCE_BUS;\n        // \u200b\u653e\u5165\u200b\u524d\u9762\u200b\u7684\u200b\u94fe\u8868\u200b\"LIST_HEAD(res)\"\n        err = of_pci_parse_bus_range(dev, bus_range);  \n            pci_add_resource(resources, bus_range);\n\n        // \u200b\u89e3\u6790\u200b ranges\n        // \u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b: \n        //        ranges = &lt;0x83000000 0x0 0xfa000000 0x0 0xfa000000 0x0 0x1e00000\n        //                  0x81000000 0x0 0xfbe00000 0x0 0xfbe00000 0x0 0x100000&gt;;\n        of_pci_range_parser_init\n            parser-&gt;range = of_get_property(node, \"ranges\", &amp;rlen);\n        for_each_of_pci_range(&amp;parser, &amp;range) {// \u200b\u89e3\u6790\u200brange            \n            // \u200b\u628a\u200brange\u200b\u8f6c\u6362\u200b\u4e3a\u200bresource\n            // \u200b\u7b2c\u200b0\u200b\u4e2a\u200brange\n            //      range-&gt;pci_space = 0x83000000,\n            //      range-&gt;flags     = IORESOURCE_MEM,\n            //      range-&gt;pci_addr  = 0xfa000000,\n            //      range-&gt;cpu_addr  = 0xfa000000,\n            //      range-&gt;size      = 0x1e00000,\n            // \u200b\u8f6c\u6362\u200b\u5f97\u5230\u200b\u7b2c\u200b0\u200b\u4e2a\u200bres\uff1a\n            //      res-&gt;flags = range-&gt;flags = IORESOURCE_MEM;\n            //      res-&gt;start = range-&gt;cpu_addr = 0xfa000000;\n            //      res-&gt;end = res-&gt;start + range-&gt;size - 1 = (0xfa000000+0x1e00000-1);\n            // ---------------------------------------------------------------\n            // \u200b\u7b2c\u200b1\u200b\u4e2a\u200brange\n            //      range-&gt;pci_space = 0x81000000,\n            //      range-&gt;flags     = IORESOURCE_IO,\n            //      range-&gt;pci_addr  = 0xfbe00000,\n            //      range-&gt;cpu_addr  = 0xfbe00000,\n            //      range-&gt;size      = 0x100000,\n            // \u200b\u8f6c\u6362\u200b\u5f97\u5230\u200b\u7b2c\u200b1\u200b\u4e2a\u200bres\uff1a\n            //      res-&gt;flags = range-&gt;flags = IORESOURCE_MEM;\n            //      res-&gt;start = range-&gt;cpu_addr = 0xfbe00000;\n            //      res-&gt;end = res-&gt;start + range-&gt;size - 1 = (0xfbe00000+0x100000-1);\n            err = of_pci_range_to_resource(&amp;range, dev, res); \n\n            // \u200b\u5728\u200b\u94fe\u8868\u200b\u4e2d\u200b\u589e\u52a0\u200bresource\n            // \u200b\u7b2c\u200b0\u200b\u4e2a\u200bresource\uff1a\n            //      \u200b\u6ce8\u610f\u200b\u7b2c\u200b3\u200b\u4e2a\u200b\u53c2\u6570\u200b: offset = cpu_addr - pci_addr = 0xfa000000 - 0xfa000000 = 0\n            // \u200b\u7b2c\u200b1\u200b\u4e2a\u200bresouce\n            //      \u200b\u6ce8\u610f\u200b\u7b2c\u200b3\u200b\u4e2a\u200b\u53c2\u6570\u200b: offset = cpu_addr - pci_addr = 0xfbe00000 - 0xfbe00000 = 0\n            pci_add_resource_offset(resources, res, res-&gt;start - range.pci_addr);\n\n        }\n\n    /* Get the I/O and memory ranges from DT */\n    resource_list_for_each_entry(win, &amp;res) {\n        rockchip-&gt;io_bus_addr = io-&gt;start - win-&gt;offset;   // 0xfbe00000, cpu addr\n        rockchip-&gt;mem_bus_addr = mem-&gt;start - win-&gt;offset; // 0xfba00000, cpu addr\n        rockchip-&gt;root_bus_nr = win-&gt;res-&gt;start; // 0\n    }\n\n    bus = pci_scan_root_bus(&amp;pdev-&gt;dev, 0, &amp;rockchip_pcie_ops, rockchip, &amp;res);\n\n    pci_bus_add_devices(bus);\n</code></pre>"},{"location":"10_PCI_PCIe/09_1/#43-cpupci","title":"4.3 \u200b\u5efa\u7acb\u200bCPU/PCI\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u7684\u200b\u6620\u5c04","text":"<p>\u200b\u8c03\u7528\u200b\u5173\u7cfb\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>rockchip_pcie_probe\n    err = rockchip_cfg_atu(rockchip);\n                /* MEM\u200b\u6620\u5c04\u200b: Region1~30 */ \n                for (reg_no = 0; reg_no &lt; (rockchip-&gt;mem_size &gt;&gt; 20); reg_no++) {\n                    err = rockchip_pcie_prog_ob_atu(rockchip, reg_no + 1,\n                                    AXI_WRAPPER_MEM_WRITE,\n                                    20 - 1,\n                                    rockchip-&gt;mem_bus_addr +\n                                    (reg_no &lt;&lt; 20),\n                                    0);\n                    if (err) {\n                        dev_err(dev, \"program RC mem outbound ATU failed\\n\");\n                        return err;\n                    }\n                }\n\n                /* IO\u200b\u6620\u5c04\u200b: Region31 */\n                offset = rockchip-&gt;mem_size &gt;&gt; 20;\n                for (reg_no = 0; reg_no &lt; (rockchip-&gt;io_size &gt;&gt; 20); reg_no++) {\n                    err = rockchip_pcie_prog_ob_atu(rockchip,\n                                    reg_no + 1 + offset,\n                                    AXI_WRAPPER_IO_WRITE,\n                                    20 - 1,\n                                    rockchip-&gt;io_bus_addr +\n                                    (reg_no &lt;&lt; 20),\n                                    0);\n                    if (err) {\n                        dev_err(dev, \"program RC io outbound ATU failed\\n\");\n                        return err;\n                    }\n                }\n\n                /* \u200b\u7528\u4e8e\u200b\u6d88\u606f\u200b\u4f20\u8f93\u200b: Region32 */\n                rockchip_pcie_prog_ob_atu(rockchip, reg_no + 1 + offset,\n                              AXI_WRAPPER_NOR_MSG,\n                              20 - 1, 0, 0);\n\n                rockchip-&gt;msg_bus_addr = rockchip-&gt;mem_bus_addr +\n                                ((reg_no + offset) &lt;&lt; 20);\n</code></pre> <p>MEM\u200b\u7a7a\u95f4\u200b\u6620\u5c04\u200b\uff1a</p> <pre><code>    // rockchip-&gt;mem_bus_addr = 0xfa000000\n    // rockchip-&gt;mem_size     = 0x1e00000\n    // \u200b\u8bbe\u7f6e\u200bRegion1\u30012\u3001\u2026\u202630\u200b\u7684\u200b\u6620\u5c04\u200b\u5173\u7cfb\u200b\n    for (reg_no = 0; reg_no &lt; (rockchip-&gt;mem_size &gt;&gt; 20); reg_no++) {\n        err = rockchip_pcie_prog_ob_atu(rockchip, reg_no + 1,\n                        AXI_WRAPPER_MEM_WRITE,\n                        20 - 1,\n                        rockchip-&gt;mem_bus_addr +\n                        (reg_no &lt;&lt; 20),\n                        0);\n</code></pre> <p>IO\u200b\u7a7a\u95f4\u200b\u6620\u5c04\u200b\uff1a</p> <pre><code>    // rockchip-&gt;io_bus_addr = 0xfbe00000\n    // rockchip-&gt;io_size     = 0x100000\n    // \u200b\u8bbe\u7f6e\u200bRegion31\u200b\u7684\u200b\u6620\u5c04\u200b\u5173\u7cfb\u200b\n    offset = rockchip-&gt;mem_size &gt;&gt; 20;\n    for (reg_no = 0; reg_no &lt; (rockchip-&gt;io_size &gt;&gt; 20); reg_no++) {\n        err = rockchip_pcie_prog_ob_atu(rockchip,\n                        reg_no + 1 + offset,\n                        AXI_WRAPPER_IO_WRITE,\n                        20 - 1,\n                        rockchip-&gt;io_bus_addr +\n                        (reg_no &lt;&lt; 20),\n                        0);\n        if (err) {\n            dev_err(dev, \"program RC io outbound ATU failed\\n\");\n            return err;\n        }\n    }\n</code></pre> <p>Message\u200b\u7a7a\u95f4\u200b\u6620\u5c04\u200b\uff1a</p> <pre><code>    /* Region32\uff1aassign message regions */\n    rockchip_pcie_prog_ob_atu(rockchip, reg_no + 1 + offset,\n                  AXI_WRAPPER_NOR_MSG,\n                  20 - 1, 0, 0);\n\n    rockchip-&gt;msg_bus_addr = rockchip-&gt;mem_bus_addr +\n                    ((reg_no + offset) &lt;&lt; 20);\n</code></pre> <p>\u200b\u4efb\u4f55\u200b\u4e00\u4e2a\u200bRegion\uff0c\u200b\u90fd\u200b\u6709\u200b\u5bf9\u5e94\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\uff1a</p> <p></p> <p>\u200b\u6240\u8c13\u200b\u5efa\u7acb\u200bCPU\u200b\u548c\u200bPCI\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u7684\u200b\u6620\u5c04\u200b\uff0c\u200b\u5c31\u662f\u200b\u8bbe\u7f6e\u200bRegion\u200b\u5bf9\u5e94\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u4f7f\u7528\u200b\u51fd\u6570\u200b<code>rockchip_pcie_prog_ob_atu</code>\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/10_1/","title":"10_RK3399_PCIe_Host\u200b\u9a71\u52a8\u200b\u5206\u6790\u200b_\u200b\u8bbe\u5907\u200b\u679a\u4e3e","text":""},{"location":"10_PCI_PCIe/10_1/#rk3399_pcie_host_","title":"RK3399_PCIe_Host\u200b\u9a71\u52a8\u200b\u5206\u6790\u200b_\u200b\u8bbe\u5907\u200b\u679a\u4e3e","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u300aPCI Express Technology 3.0\u300b\uff0cMike Jackson, Ravi Budruk; MindShare, Inc.</li> <li>\u300aPCIe\u200b\u626b\u76f2\u200b\u7cfb\u5217\u200b\u535a\u6587\u200b\u300b\uff0c\u200b\u4f5c\u8005\u200bFelix\uff0c\u200b\u8fd9\u200b\u662f\u200b\u5bf9\u200b\u300aPCI Express Technology\u300b\u200b\u7684\u200b\u7406\u89e3\u200b\u4e0e\u200b\u7ffb\u8bd1\u200b</li> <li>\u300aPCI EXPRESS\u200b\u4f53\u7cfb\u7ed3\u6784\u200b\u5bfc\u8bfb\u200b (\u200b\u738b\u9f50\u200b)\u300b</li> <li>\u300aPCI Express_ Base Specification Revision 4.0 Version 0.3 ( PDFDrive )\u300b</li> <li>\u300aNCB-PCI_Express_Base_5.0r1.0-2019-05-22\u300b</li> <li>SOC\u200b\u4e2d\u200bAXI\u200b\u603b\u7ebf\u200b\u662f\u200b\u5982\u4f55\u200b\u8fde\u63a5\u200b\u7684\u200b</li> <li>AXI\u200b\u603b\u7ebf\u200b\u6574\u7406\u200b\u603b\u7ed3\u200b</li> <li>PCIe\u200b\u4e2d\u200bMSI\u200b\u548c\u200bMSI-X\u200b\u4e2d\u65ad\u200b\u673a\u5236\u200b</li> </ul> <p>\u200b\u5f00\u53d1\u677f\u200b\u8d44\u6599\u200b\uff1a</p> <ul> <li>https://wiki.t-firefly.com/zh_CN/ROC-RK3399-PC-PLUS/</li> </ul> <p>\u200b\u672c\u200b\u8bfe\u7a0b\u200b\u5206\u6790\u200b\u7684\u200b\u6587\u4ef6\u200b\uff1a</p> <ul> <li><code>linux-4.4_rk3399\\drivers\\pci\\host\\pcie-rockchip.c</code></li> </ul>"},{"location":"10_PCI_PCIe/10_1/#1-pcie","title":"1. PCIe\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u8d44\u6e90","text":"<p>\u200b\u4e0a\u200b\u8282\u200b\u89c6\u9891\u200b\u6211\u4eec\u200b\u5206\u6790\u200b\u4e86\u200bPCIe\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b<code>pcie-rockchip.c</code>\uff0c\u200b\u5b83\u200b\u89e3\u6790\u200b\u4e86\u200b\u8bbe\u5907\u200b\u6811\u200b\uff0c\u200b\u5f97\u5230\u200b\u4e86\u200b\u5982\u4e0b\u200b\u8d44\u6e90\u200b\uff1a</p> <ul> <li>\u200b\u603b\u7ebf\u200b\u8d44\u6e90\u200b\uff1a\u200b\u5c31\u662f\u200b\u603b\u7ebf\u200b\u53f7\u200b\uff0c\u200b\u4ece\u200b0\u200b\u5230\u200b0x1f</li> <li>\u200b\u5185\u5b58\u200b\u8d44\u6e90\u200b\uff1aCPU\u200b\u5730\u5740\u200b\u57fa\u200b\u5730\u5740\u200b\u4e3a\u200b0xfa000000\uff0cPCI\u200b\u5730\u5740\u200b\u57fa\u200b\u5730\u5740\u200b\u4e3a\u200b0xfa000000\uff0c\u200b\u5927\u5c0f\u200b\u4e3a\u200b0x1e00000</li> <li>IO\u200b\u8d44\u6e90\u200b\uff1aCPU\u200b\u5730\u5740\u200b\u57fa\u200b\u5730\u5740\u200b\u4e3a\u200b0xfbe00000\uff0cPCI\u200b\u5730\u5740\u200b\u57fa\u200b\u5730\u5740\u200b\u4e3a\u200b0xfbe00000\uff0c\u200b\u5927\u5c0f\u200b\u4e3a\u200b0x100000</li> </ul> <p>\u200b\u8fd9\u200b3\u200b\u7c7b\u200b\u8d44\u6e90\u200b\u8bb0\u5f55\u200b\u5728\u200b\u94fe\u8868\u200b\u4e2d\u200b\uff1a</p> <p></p> <p>\u200b\u89e3\u6790\u200b\u8bbe\u5907\u200b\u6811\u65f6\u200b\uff0c\u200b\u628a\u200b\u8d44\u6e90\u200b\u8bb0\u5f55\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u94fe\u8868\u200b\u91cc\u200b\uff1a</p> <p></p> <p>res\u200b\u94fe\u8868\u200b\u4e2d\u200b\u8bb0\u5f55\u200b\u7684\u200b\u8d44\u6e90\u200b\u6700\u7ec8\u200b\u4f1a\u200b\u653e\u5230\u200bpci_bus-&gt;bridge-&gt;windows\u200b\u94fe\u8868\u200b\u91cc\u200b\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\u8bb0\u5f55\u200b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/10_1/#2","title":"2. \u200b\u8bbe\u5907\u200b\u914d\u7f6e\u200b\u7a7a\u95f4","text":"<p>\u200b\u672c\u200b\u8282\u200b\u5185\u5bb9\u200b\u53c2\u8003\u200b\uff1a<code>PCI_SPEV_V3_0.pdf</code></p> <p>\u200b\u4f7f\u7528\u200bPCI/PCIe\u200b\u7684\u200b\u76ee\u7684\u200b\uff0c\u200b\u5c31\u662f\u200b\u4e3a\u4e86\u200b\u7b80\u5355\u200b\u5730\u200b\u8bbf\u95ee\u200b\u5b83\u200b\uff1a\u200b\u50cf\u200b\u8bfb\u5199\u200b\u5185\u5b58\u200b\u4e00\u6837\u200b\u8bfb\u5199\u200bPCI/PCIe\u200b\u8bbe\u5907\u200b\u3002</p> <p>\u200b\u63d0\u95ee\u200b\uff1a</p> <ul> <li>\u200b\u4f7f\u7528\u200b\u54ea\u4e9b\u200b\u5730\u5740\u200b\u8bfb\u5199\u200b\u8bbe\u5907\u200b\uff1f</li> <li>\u200b\u8fd9\u4e9b\u200b\u5730\u5740\u200b\u7684\u200b\u8303\u56f4\u200b\u6709\u200b\u591a\u200b\u5927\u200b\uff1f</li> <li>\u200b\u662f\u200b\u50cf\u200b\u5185\u5b58\u200b\u4e00\u6837\u200b\u8bbf\u95ee\u200b\u5b83\u200b\uff0c\u200b\u8fd8\u662f\u200b\u50cf\u200bIO\u200b\u4e00\u6837\u200b\u8bbf\u95ee\u200b\u5b83\u200b\uff1f</li> </ul> <p>\u200b\u6bcf\u4e2a\u200bPCI/PCIe\u200b\u8bbe\u5907\u200b\u90fd\u200b\u6709\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\uff0c\u200b\u5c31\u662f\u200b\u4e00\u7cfb\u5217\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u5bf9\u4e8e\u200b\u666e\u901a\u200b\u7684\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\u3002</p> <p>\u200b\u91cc\u9762\u200b\u6709\u200b\uff1a</p> <ul> <li>\u200b\u8bbe\u5907\u200bID</li> <li>\u200b\u5382\u5bb6\u200bID</li> <li>Class Code\uff1a\u200b\u54ea\u7c7b\u200b\u8bbe\u5907\u200b\uff1f\u200b\u5b58\u50a8\u8bbe\u5907\u200b\uff1f\u200b\u663e\u793a\u200b\u8bbe\u5907\u200b\uff1f\u200b\u7b49\u5f85\u200b</li> <li>6\u200b\u4e2a\u200bBase Address Register\uff1a</li> </ul> <p></p>"},{"location":"10_PCI_PCIe/10_1/#21","title":"2.1 \u200b\u8bbe\u5907\u200b\u4fe1\u606f","text":"<ul> <li>Vendor ID\uff1a\u200b\u5382\u5bb6\u200bID\uff0cPCI SIG\u200b\u7ec4\u7ec7\u200b\u7ed9\u200b\u6bcf\u4e2a\u200b\u5382\u5bb6\u200b\u90fd\u200b\u5206\u914d\u200b\u4e86\u200b\u4e00\u4e2a\u200b\u72ec\u4e00\u200b\u7684\u200bID</li> <li>Device ID\uff1a\u200b\u5382\u5bb6\u200b\u7ed9\u200b\u81ea\u5df1\u200b\u7684\u200b\u67d0\u7c7b\u200b\u4ea7\u54c1\u200b\u5206\u914d\u200b\u4e00\u4e2a\u200bDevice ID</li> <li>Revision ID\uff1a\u200b\u5382\u5bb6\u200b\u81ea\u5b9a\u4e49\u200b\u7684\u200b\u7248\u672c\u53f7\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u8ba4\u4e3a\u200b\u662f\u200bDevice ID\u200b\u7684\u200b\u5ef6\u4f38\u200b</li> <li>Header Type\uff1a</li> <li>b[7]: 1-\u200b\u5b83\u200b\u662f\u200b\u4e00\u4e2a\u200b\u591a\u529f\u80fd\u200b\u8bbe\u5907\u200b(\"multi-function\")\uff0c0-\u200b\u5b83\u200b\u662f\u200b\u5355\u529f\u80fd\u200b\u8bbe\u5907\u200b(\"single-function\")</li> <li> <p>b[6:0]: 00h-\u200b\u666e\u901a\u200b\u8bbe\u5907\u200b, 01h-\u200b\u6865\u200b\u8bbe\u5907\u200b\uff0c\u200b\u8fd9\u4e2a\u200b\u53d6\u503c\u200b\u4e5f\u200b\u51b3\u5b9a\u200b\u4e86\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u4e2d\u200b\u504f\u79fb\u200b\u5730\u5740\u200b10h\u200b\u5f00\u59cb\u200b\u5904\u200b\u7684\u200b\u542b\u4e49\u200b     </p> </li> <li> <p>Class Code\uff1a\u200b\u8fd9\u662f\u200b\u53ea\u8bfb\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u5b83\u200b\u542b\u6709\u200b3\u200b\u4e2a\u200b\u5b57\u8282\u200b\uff0c\u200b\u7528\u6765\u200b\u8868\u660e\u200b\u8bbe\u5907\u200b\u7684\u200b\u529f\u80fd\u200b\uff0c\u200b\u5b83\u200b\u5206\u4e3a\u200b3\u200b\u90e8\u5206\u200b</p> </li> <li>\u200b\u6700\u9ad8\u200b\u5b57\u8282\u200b\uff1a\u200b\u8868\u793a\u200b\"base class\"\uff0c\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u5b83\u200b\u5c5e\u4e8e\u200b\u5185\u5b58\u5361\u200b\u3001\u200b\u663e\u5361\u200b\u7b49\u5f85\u200b</li> <li>\u200b\u4e2d\u95f4\u200b\u5b57\u8282\u200b\uff1a\u200b\u8868\u793a\u200b\"sub-class\"\uff0c\u200b\u518d\u200b\u7ec6\u5206\u200b\u4e00\u4e0b\u200b\u7c7b\u522b\u200b</li> <li>\u200b\u6700\u4f4e\u200b\u5b57\u8282\u200b\uff1a\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u5bc4\u5b58\u5668\u200b\u7ea7\u522b\u200b\u7684\u200b\u7f16\u7a0b\u200b\u63a5\u53e3\u200b\"Interface\"</li> <li>\u200b\u793a\u4f8b\u200b\u5982\u4e0b\u200b\uff1aBase Class\u200b\u4e3a\u200b01h\u200b\u65f6\u200b\uff0c\u200b\u8868\u793a\u200b\u5b83\u200b\u662f\u200b\u4e00\u4e2a\u200b\u5b58\u50a8\u8bbe\u5907\u200b\uff0c\u200b\u4f46\u662f\u200b\u8fd8\u200b\u53ef\u4ee5\u200b\u7ee7\u7eed\u200b\u4f7f\u7528\u200bsub-class\u3001Interface\u200b\u7ec6\u5206\u200b     </li> </ul>"},{"location":"10_PCI_PCIe/10_1/#22-base-address","title":"2.2 \u200b\u57fa\u200b\u5730\u5740\u200b(Base Address)","text":"<p>\u200b\u666e\u901a\u200b\u7684\u200bPCI/PCIe\u200b\u8bbe\u5907\u200b\u6709\u200b6\u200b\u4e2a\u57fa\u200b\u5730\u5740\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u7b80\u79f0\u200b\u4e3a\u200bBAR\uff1a</p> <p></p> <p>BAR\u200b\u7528\u4e8e\u200b\uff1a</p> <ul> <li>\u200b\u58f0\u660e\u200b\u9700\u8981\u200b\u4ec0\u4e48\u200b\u7c7b\u578b\u200b\u7684\u200b\u7a7a\u95f4\u200b\uff1a\u200b\u5185\u5b58\u200b\u3001IO\u300132\u200b\u4f4d\u200b\u5730\u5740\u200b\u300164\u200b\u4f4d\u200b\u5730\u5740\u200b\uff1f</li> <li>\u200b\u58f0\u660e\u200b\u9700\u8981\u200b\u7684\u200b\u7a7a\u95f4\u200b\u6709\u200b\u591a\u200b\u5927\u200b</li> <li>\u200b\u4fdd\u5b58\u200b\u4e3b\u63a7\u200b\u5206\u914d\u200b\u7ed9\u200b\u5b83\u200b\u7684\u200bPCI\u200b\u7a7a\u95f4\u200b\u57fa\u200b\u5730\u5740\u200b</li> </ul> <p>\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u53ef\u4ee5\u200b\u5206\u4e3a\u200b\u4e24\u7c7b\u200b\uff1a\u200b\u5185\u5b58\u200b(Memory)\u3001IO\uff1a</p> <ul> <li>\u200b\u5bf9\u4e8e\u200b\u5185\u5b58\u200b\uff0c\u200b\u5199\u5165\u200b\u4ec0\u4e48\u200b\u503c\u200b\u8bfb\u51fa\u200b\u5c31\u662f\u200b\u4ec0\u4e48\u200b\u503c\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u63d0\u524d\u200b\u8bfb\u53d6\u200b</li> <li>\u200b\u5bf9\u4e8e\u200bIO\uff0c\u200b\u5b83\u200b\u53cd\u5e94\u200b\u7684\u200b\u662f\u200b\u786c\u4ef6\u200b\u5f53\u524d\u200b\u7684\u200b\u72b6\u6001\u200b\uff0c\u200b\u6bcf\u4e2a\u200b\u65f6\u523b\u200b\u8bfb\u5230\u200b\u7684\u200b\u503c\u200b\u4e0d\u200b\u4e00\u5b9a\u200b\u76f8\u540c\u200b</li> </ul> <p>BAR\u200b\u7684\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u7528\u4e8e\u200b\u5185\u5b58\u7a7a\u95f4\u200b</li> </ul> <p></p> <ul> <li>\u200b\u7528\u4e8e\u200bIO\u200b\u7a7a\u95f4\u200b\uff1a</li> </ul> <p></p> <p>BAR\u200b\u600e\u4e48\u200b\u8868\u793a\u200b\u5b83\u200b\u60f3\u200b\u7533\u8bf7\u200b\u591a\u5927\u200b\u7684\u200b\u7a7a\u95f4\u200b\uff1f\u200b\u4ee5\u200b32\u200b\u4f4d\u200b\u5730\u5740\u200b\u4e3a\u4f8b\u200b\uff1a</p> <ul> <li>\u200b\u8f6f\u4ef6\u200b\u5f80\u200bBAR\u200b\u5199\u5165\u200b0xFFFFFFFF</li> <li>\u200b\u8f6f\u4ef6\u200b\u8bfb\u200bBAR</li> <li>\u200b\u8bfb\u51fa\u200b\u7684\u200b\u6570\u503c\u200b\u5047\u8bbe\u200b\u4e3a\u200b0xFFF0,000?\uff0c\u200b\u5ffd\u7565\u200b\u6700\u4f4e\u200b\u7684\u200b4\u200b\u4f4d\u200b\uff0c\u200b\u5c31\u200b\u5f97\u5230\u200b\uff1a0xFFF0,0000</li> <li>\u200b\u8fd9\u200b\u8868\u793a\u200bBAR\u200b\u4e2d\u200b\u53ef\u4ee5\u200b\u5199\u5165\u200b\u7684\u200b\"Base Address\"\u200b\u53ea\u6709\u200b\u6700\u9ad8\u200b\u7684\u200b12\u200b\u4f4d\u200b</li> <li>\u200b\u4e5f\u200b\u5c31\u200b\u8868\u793a\u200b\u4e86\u200b\u6700\u4f4e\u200b\u7684\u200b20\u200b\u4f4d\u662f\u200b\u53ef\u4ee5\u200b\u53d8\u5316\u200b\u7684\u200b\u8303\u56f4\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8fd9\u4e2a\u200b\u7a7a\u95f4\u200b\u5927\u5c0f\u200b\u4e3a\u200b2^20=1M Byte</li> </ul> <p>\u200b\u5982\u679c\u200bBAR\u200b\u8868\u793a\u200b\u5b83\u200b\u4f7f\u7528\u200b32\u200b\u4f4d\u200b\u7684\u200b\u5730\u5740\u200b\uff0c\u200b\u90a3\u4e48\u200bBAR0~BAR5\u200b\u53ef\u4ee5\u200b\u5206\u522b\u200b\u8868\u793a\u200b6\u200b\u4e2a\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u3002</p> <p>\u200b\u5982\u679c\u200bBAR\u200b\u8868\u793a\u200b\u5b83\u200b\u4f7f\u7528\u200b64\u200b\u4f4d\u200b\u7684\u200b\u5730\u5740\u200b\uff0c\u200b\u90a3\u4e48\u200bBAR0\u200b\u548c\u200bBAR1\u3001BAR2\u200b\u548c\u200bBAR3\u3001BAR4\u200b\u548c\u200bBAR5\u200b\u5206\u522b\u200b\u8868\u793a\u200b3\u200b\u4e2a\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\uff1a</p> <ul> <li>\u200b\u4f4e\u200b\u5e8f\u53f7\u200b\u7684\u200bBAR\u200b\u8868\u793a\u200b64\u200b\u4f4d\u200b\u5730\u5740\u200b\u7684\u200b\u4f4e\u200b32\u200b\u4f4d\u200b</li> <li>\u200b\u9ad8\u200b\u5e8f\u53f7\u200b\u7684\u200b\u5730\u5740\u200b\u8868\u793a\u200b64\u200b\u4f4d\u200b\u5730\u5740\u200b\u7684\u200b\u9ad8\u200b32\u200b\u4f4d\u200b\u3002</li> </ul>"},{"location":"10_PCI_PCIe/10_1/#3","title":"3. \u200b\u626b\u63cf\u200b\u8bbe\u5907\u200b\u7684\u200b\u8fc7\u7a0b","text":""},{"location":"10_PCI_PCIe/10_1/#31-pci_dev","title":"3.1 \u200b\u6838\u5fc3\u200b: \u200b\u6784\u9020\u200bpci_dev","text":"<p>\u200b\u626b\u63cf\u200bPCIe\u200b\u603b\u7ebf\u200b\uff0c\u200b\u5bf9\u200b\u6bcf\u200b\u4e00\u4e2a\u200bPCIe\u200b\u6865\u200b\u3001PCIe\u200b\u8bbe\u5907\u200b\uff0c\u200b\u90fd\u200b\u6784\u9020\u200b\u51fa\u200b\u5bf9\u5e94\u200b\u7684\u200bpci_dev\uff1a</p> <ul> <li>\u200b\u586b\u5145\u200bpci_dev\u200b\u7684\u200b\u5404\u9879\u200b\u6210\u5458\u200b\uff0c\u200b\u6bd4\u5982\u200bVID\u3001PID\u3001Class\u200b\u7b49\u200b</li> <li>\u200b\u5206\u914d\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u3001\u200b\u5199\u5165\u200bPCIe\u200b\u8bbe\u5907\u200b</li> </ul> <p>pci_dev\u200b\u7ed3\u6784\u200b\u4f53\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u5bf9\u5e94\u200bpci_dev\u200b\u7ed3\u6784\u200b\u4f53\u91cc\u200b\u7684\u200b\u8bbe\u5907\u200b\u4fe1\u606f\u200b\uff1a\u200b\u8bfb\u53d6\u200bPCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u5373\u53ef\u200b\u83b7\u5f97\u200b\u3002</p> <p>\u200b\u5bf9\u5e94\u200bpci_dev\u200b\u7ed3\u6784\u200b\u4f53\u91cc\u200b\u7684\u200b\u8d44\u6e90\u200b\uff0c\u200b\u672c\u200b\u8282\u200b\u8bfe\u7a0b\u200b\u5148\u200b\u4e0d\u200b\u5206\u6790\u200birq\u3002\u200b\u5bf9\u4e8e\u200bresource\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u6bcf\u4e2a\u200b\u6210\u5458\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200bBAR\u3002</p> <p>resource\u200b\u7ed3\u6784\u200b\u4f53\u200b\u5982\u4e0b\u200b\uff0c\u200b\u8981\u200b\u6ce8\u610f\u200b\u7684\u200b\u662f\u200b\uff1a\u200b\u91cc\u9762\u200b\u8bb0\u5f55\u200b\u7684\u200bstart\u3001end\u200b\u7b49\u200b\uff0c\u200b\u662f\u200b\u57fa\u4e8e\u200bCPU\u200b\u89d2\u5ea6\u200b\u770b\u5f85\u200b\u7684\u200b\u3002\u200b\u4e5f\u5c31\u662f\u8bf4\u200b\uff0c\u200b\u5982\u679c\u200b\u8bb0\u5f55\u200b\u7684\u200b\u662f\u200b\u5185\u5b58\u5730\u5740\u200b\u3001IO\u200b\u5730\u5740\u200b\uff0c\u200b\u90a3\u4e48\u200b\u662f\u200bCPU\u200b\u5730\u5740\u200b\uff0c\u200b\u4e0d\u662f\u200bPCI\u200b\u5730\u5740\u200b\u3002\u200b\u5e76\u4e14\u200b\u8fd9\u4e9b\u200b\u5730\u5740\u200b\u662f\u200b\u7269\u7406\u5730\u5740\u200b\uff0c\u200b\u8981\u200b\u5728\u200b\u8f6f\u4ef6\u200b\u4e2d\u200b\u4f7f\u7528\u200b\u5b83\u4eec\u200b\u8981\u200b\u5148\u200b\u6267\u884c\u200bioremap\u3002</p> <p></p>"},{"location":"10_PCI_PCIe/10_1/#32","title":"3.2 \u200b\u4ee3\u7801\u200b\u5206\u6790","text":"<p>\u200b\u6211\u4eec\u200b\u8981\u200b\u627e\u5230\u200b\u8fd9\u200b4\u200b\u4e2a\u200b\u6838\u5fc3\u200b\u4ee3\u7801\u200b\uff1a</p> <ul> <li>\u200b\u5206\u914d\u200bpci_dev</li> <li>\u200b\u8bfb\u53d6\u200bPCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\uff0c\u200b\u586b\u5145\u200bpci_dev\u200b\u4e2d\u200b\u7684\u200b\u8bbe\u5907\u200b\u4fe1\u606f\u200b</li> <li>\u200b\u6839\u636e\u200bPCIe\u200b\u8bbe\u5907\u200b\u7684\u200bBAR\uff0c\u200b\u5f97\u77e5\u200b\u5b83\u200b\u60f3\u200b\u7533\u8bf7\u200b\u4ec0\u4e48\u200b\u7c7b\u578b\u200b\u7684\u200b\u5730\u5740\u200b\u3001\u200b\u591a\u5927\u200b\uff1f</li> <li>\u200b\u5206\u914d\u200b\u5730\u5740\u200b\uff0c\u200b\u5199\u5165\u200bBAR</li> </ul> <p>\u200b\u5173\u952e\u200b\u4ee3\u7801\u200b\u5206\u4e3a\u200b\u4e24\u200b\u90e8\u5206\u200b\uff1a</p> <ul> <li>\u200b\u8bfb\u200b\u4fe1\u606f\u200b\u3001\u200b\u5f97\u77e5\u200bPCIe\u200b\u8bbe\u5907\u200b\u60f3\u200b\u7533\u8bf7\u200b\u591a\u5927\u200b\u7684\u200b\u7a7a\u95f4\u200b</li> </ul> <pre><code>rockchip_pcie_probe\n    bus = pci_scan_root_bus(&amp;pdev-&gt;dev, 0, &amp;rockchip_pcie_ops, rockchip, &amp;res);\n      pci_scan_root_bus_msi\n            pci_scan_child_bus\n              pci_scan_slot\n                  dev = pci_scan_single_device(bus, devfn);\n                      dev = pci_scan_device(bus, devfn);\n                          struct pci_dev *dev;\n                          dev = pci_alloc_dev(bus);\n                          pci_setup_device\n                                pci_read_bases(dev, 6, PCI_ROM_ADDRESS);  \n                        pci_device_add(dev, bus);\n</code></pre> <ul> <li>\u200b\u5206\u914d\u200b\u7a7a\u95f4\u200b</li> </ul> <pre><code>rockchip_pcie_probe\n    pci_bus_size_bridges(bus);\n    pci_bus_assign_resources(bus);\n        __pci_bus_assign_resources\n            pbus_assign_resources_sorted\n                /* pci_dev-&gt;resource[]\u200b\u91cc\u200b\u8bb0\u5f55\u200b\u6709\u200b\u60f3\u200b\u7533\u8bf7\u200b\u7684\u200b\u8d44\u6e90\u200b\u7684\u200b\u5927\u5c0f\u200b, \n                 * \u200b\u628a\u200b\u8fd9\u4e9b\u200b\u8d44\u6e90\u200b\u6309\u200b\u5bf9\u9f50\u200b\u7684\u200b\u8981\u6c42\u200b\u6392\u5e8f\u200b\n                 * \u200b\u6bd4\u5982\u200b\u8d44\u6e90\u200bA\u200b\u8981\u6c42\u200b1K\u200b\u5730\u5740\u200b\u5bf9\u9f50\u200b\uff0c\u200b\u8d44\u6e90\u200bB\u200b\u8981\u6c42\u200b32\u200b\u5730\u5740\u200b\u5bf9\u9f50\u200b\n                 * \u200b\u90a3\u4e48\u200b\u8d44\u6e90\u200bA\u200b\u6392\u200b\u5728\u200b\u8d44\u6e90\u200bB\u200b\u524d\u9762\u200b, \u200b\u4f18\u5148\u200b\u5206\u914d\u8d44\u6e90\u200bA\n                 */\n                list_for_each_entry(dev, &amp;bus-&gt;devices, bus_list)\n                    __dev_sort_resources(dev, &amp;head);\n                // \u200b\u5206\u914d\u8d44\u6e90\u200b\n                __assign_resources_sorted\n                    assign_requested_resources_sorted(head, &amp;local_fail_head);\n</code></pre>"},{"location":"10_PCI_PCIe/10_1/#321-pci_dev","title":"3.2.1 \u200b\u5206\u914d\u200bpci_dev\u200b\u7ed3\u6784","text":""},{"location":"10_PCI_PCIe/10_1/#322","title":"3.2.2 \u200b\u8bfb\u53d6\u200b\u8bbe\u5907\u200b\u4fe1\u606f","text":"<p>\u200b\u5728\u200b<code>pci_scan_device</code>\u200b\u51fd\u6570\u200b\u4e2d\u200b\uff0c\u200b\u4f1a\u5148\u200b\u5c1d\u8bd5\u200b\u8bfb\u53d6\u200bVID\u3001PID\uff0c\u200b\u6210\u529f\u200b\u7684\u8bdd\u200b\u624d\u200b\u4f1a\u200b\u7ee7\u7eed\u200b\u8c03\u7528\u200b<code>pci_setup_device</code>\uff1a</p> <p></p> <p>\u200b\u5728\u200b<code>pci_setup_device</code>\u200b\u5185\u90e8\u200b\uff0c\u200b\u4f1a\u200b\u7ee7\u7eed\u200b\u8bfb\u53d6\u200b\u5176\u4ed6\u200b\u4fe1\u606f\u200b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/10_1/#323-bar","title":"3.2.3 \u200b\u8bfb\u200bBAR","text":"<p><code>pci_read_bases</code>\u200b\u51fd\u6570\u200b\u4ee3\u7801\u200b\u5206\u6790\u200b\uff1a</p> <p></p> <p><code>pci_read_bases</code>\u200b\u51fd\u6570\u200b\u53c8\u200b\u4f1a\u200b\u8c03\u7528\u200b<code>__pci_read_base</code>\uff0c<code>__pci_read_base</code>\u200b\u53ea\u662f\u200b\u8bfb\u200bBAR\uff0c\u200b\u7b97\u51fa\u200b\u60f3\u200b\u7533\u8bf7\u200b\u7684\u200b\u7a7a\u95f4\u200b\u7684\u200b\u5927\u5c0f\u200b\uff1a</p> <ul> <li>\u200b\u8bfb\u200bBAR\uff0c\u200b\u4fdd\u7559\u200b\u539f\u503c\u200b</li> <li>\u200b\u5199\u200b0xFFFFFFFF\u200b\u5230\u200bBAR</li> <li>\u200b\u5728\u8bfb\u200b\u51fa\u6765\u200b\uff0c\u200b\u89e3\u6790\u200b\u51fa\u6240\u200b\u9700\u8981\u200b\u7684\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\u5927\u5c0f\u200b\uff0c\u200b\u8bb0\u5f55\u200b\u5728\u200bpci_dev-&gt;resource[ ]\u200b\u91cc\u200b</li> <li>pci_dev-&gt;resource[ ].start = 0;</li> <li>pci_dev-&gt;resource[ ].end = size - 1;</li> </ul> <p>\u200b\u628a\u200b\u524d\u9762\u200b\u8bb2\u8fc7\u200b\u7684\u200b\u8d34\u51fa\u6765\u200b\uff0c\u200b\u6709\u52a9\u4e8e\u200b\u7406\u89e3\u200b\u4ee3\u7801\u200b\uff1a</p> <p>BAR\u200b\u600e\u4e48\u200b\u8868\u793a\u200b\u5b83\u200b\u60f3\u200b\u7533\u8bf7\u200b\u591a\u5927\u200b\u7684\u200b\u7a7a\u95f4\u200b\uff1f\u200b\u4ee5\u200b32\u200b\u4f4d\u200b\u5730\u5740\u200b\u4e3a\u4f8b\u200b\uff1a</p> <ul> <li>\u200b\u8f6f\u4ef6\u200b\u5f80\u200bBAR\u200b\u5199\u5165\u200b0xFFFFFFFF</li> <li>\u200b\u8f6f\u4ef6\u200b\u8bfb\u200bBAR</li> <li>\u200b\u8bfb\u51fa\u200b\u7684\u200b\u6570\u503c\u200b\u5047\u8bbe\u200b\u4e3a\u200b0xFFF0,000?\uff0c\u200b\u5ffd\u7565\u200b\u6700\u4f4e\u200b\u7684\u200b4\u200b\u4f4d\u200b\uff0c\u200b\u5c31\u200b\u5f97\u5230\u200b\uff1a0xFFF0,0000</li> <li>\u200b\u8fd9\u200b\u8868\u793a\u200bBAR\u200b\u4e2d\u200b\u53ef\u4ee5\u200b\u5199\u5165\u200b\u7684\u200b\"Base Address\"\u200b\u53ea\u6709\u200b\u6700\u9ad8\u200b\u7684\u200b12\u200b\u4f4d\u200b</li> <li>\u200b\u4e5f\u200b\u5c31\u200b\u8868\u793a\u200b\u4e86\u200b\u6700\u4f4e\u200b\u7684\u200b20\u200b\u4f4d\u662f\u200b\u53ef\u4ee5\u200b\u53d8\u5316\u200b\u7684\u200b\u8303\u56f4\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8fd9\u4e2a\u200b\u7a7a\u95f4\u200b\u5927\u5c0f\u200b\u4e3a\u200b2^20=1M Byte</li> </ul> <p>\u200b\u4ee5\u4e0b\u200b\u662f\u200b<code>__pci_read_bases</code>\u200b\u51fd\u6570\u200b\u7684\u200b\u4ee3\u7801\u200b\u5206\u6790\u200b\u3002</p> <ul> <li>\u200b\u5f97\u5230\u200b\u5927\u5c0f\u200b(\u200b\u539f\u59cb\u6570\u636e\u200b\uff0c\u200b\u9700\u8981\u200b\u8fdb\u4e00\u6b65\u200b\u89e3\u6790\u200b)\uff1a\u200b\u6bd4\u5982\u200b\u4e0b\u5217\u200b\u4ee3\u7801\u200b\u4e2d\u200bsz\u200b\u88ab\u200b\u8d4b\u503c\u200b\u4e3a\u200b0xFFF0,000?\uff0c\u200b\u9700\u8981\u200b\u8fdb\u4e00\u6b65\u200b\u89e3\u6790\u200b</li> </ul> <p></p>"},{"location":"10_PCI_PCIe/10_1/#324","title":"3.2.4 \u200b\u5206\u914d\u200b\u5730\u5740\u200b\u7a7a\u95f4","text":"<p>\u200b\u8fd9\u90e8\u5206\u200b\u4ee3\u7801\u200b\u7684\u200b\u51fd\u6570\u8c03\u7528\u200b\u975e\u5e38\u200b\u6df1\u200b\uff0c\u200b\u6211\u4eec\u200b\u6293\u4f4f\u200b2\u200b\u4e2a\u200b\u95ee\u9898\u200b\u5373\u53ef\u200b\uff1a</p> <ul> <li>\u200b\u4ece\u200b\u54ea\u91cc\u200b\u5206\u914d\u200b\u5f97\u5230\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\uff1f</li> <li>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u660e\u200b\u4e86\u200bCPU\u200b\u5730\u5740\u200b\u3001PCI\u200b\u5730\u5740\u200b\u7684\u200b\u5bf9\u5e94\u200b\u5173\u7cfb\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u4f5c\u4e3a\u200b\"\u200b\u8d44\u6e90\u200b\"\u200b\u8bb0\u5f55\u200b\u5728\u200bpci_bus\u200b\u91cc\u200b</li> <li>\u200b\u8bfb\u200bBAR\u200b\u65f6\u200b\uff0c\u200b\u5728\u200bpci_dev-&gt;resource[]\u200b\u91cc\u200b\u8bb0\u5f55\u200b\u4e86\u200b\u5b83\u200b\u60f3\u200b\u7533\u8bf7\u200b\u7a7a\u95f4\u200b\u7684\u200b\u5927\u5c0f\u200b</li> <li>\u200b\u5206\u914d\u200b\u5f97\u5230\u200b\u7684\u200b\u57fa\u200b\u5730\u5740\u200b\uff0c\u200b\u8981\u200b\u5199\u5165\u200bBAR</li> </ul> <p>\u200b\u4ee3\u7801\u200b\u8c03\u7528\u200b\u5173\u7cfb\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u628a\u200b\u8981\u200b\u7533\u8bf7\u200b\u7684\u200b\u8d44\u6e90\u200b, \u200b\u6309\u7167\u200b\u5bf9\u9f50\u200b\u8981\u6c42\u200b\u6392\u5e8f\u200b\uff0c\u200b\u7136\u540e\u200b\u8c03\u7528\u200bassign_requested_resources_sorted\uff0c\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b\uff1a</li> </ul> <pre><code>/* \u200b\u628a\u200b\u8981\u200b\u7533\u8bf7\u200b\u7684\u200b\u8d44\u6e90\u200b, \u200b\u6309\u7167\u200b\u5bf9\u9f50\u200b\u8981\u6c42\u200b\u6392\u5e8f\u200b\n * \u200b\u7136\u540e\u200b\u8c03\u7528\u200bassign_requested_resources_sorted\n */\n\nrockchip_pcie_probe\n  pci_bus_size_bridges(bus);\n  pci_bus_assign_resources(bus);\n      __pci_bus_assign_resources\n            pbus_assign_resources_sorted\n              /* pci_dev-&gt;resource[]\u200b\u91cc\u200b\u8bb0\u5f55\u200b\u6709\u200b\u60f3\u200b\u7533\u8bf7\u200b\u7684\u200b\u8d44\u6e90\u200b\u7684\u200b\u5927\u5c0f\u200b, \n               * \u200b\u628a\u200b\u8fd9\u4e9b\u200b\u8d44\u6e90\u200b\u6309\u200b\u5bf9\u9f50\u200b\u7684\u200b\u8981\u6c42\u200b\u6392\u5e8f\u200b\n               * \u200b\u6bd4\u5982\u200b\u8d44\u6e90\u200bA\u200b\u8981\u6c42\u200b1K\u200b\u5730\u5740\u200b\u5bf9\u9f50\u200b\uff0c\u200b\u8d44\u6e90\u200bB\u200b\u8981\u6c42\u200b32\u200b\u5730\u5740\u200b\u5bf9\u9f50\u200b\n               * \u200b\u90a3\u4e48\u200b\u8d44\u6e90\u200bA\u200b\u6392\u200b\u5728\u200b\u8d44\u6e90\u200bB\u200b\u524d\u9762\u200b, \u200b\u4f18\u5148\u200b\u5206\u914d\u8d44\u6e90\u200bA\n               */\n                list_for_each_entry(dev, &amp;bus-&gt;devices, bus_list)\n                    __dev_sort_resources(dev, &amp;head);\n              // \u200b\u5206\u914d\u8d44\u6e90\u200b\n              __assign_resources_sorted\n                    assign_requested_resources_sorted(head, &amp;local_fail_head);\n</code></pre> <ul> <li> <p><code>assign_requested_resources_sorted</code>\u200b\u51fd\u6570\u200b\u505a\u200b\u4e24\u4ef6\u4e8b\u200b</p> </li> <li> <p>\u200b\u5206\u914d\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b</p> </li> <li> <p>\u200b\u628a\u200b\u8fd9\u5757\u200b\u7a7a\u95f4\u200b\u5bf9\u5e94\u200b\u7684\u200bPCI\u200b\u5730\u5740\u200b\u5199\u5165\u200bPCIe\u200b\u8bbe\u5907\u200b\u7684\u200bBAR</p> </li> <li> <p>\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>assign_requested_resources_sorted(head, &amp;local_fail_head);\n    pci_assign_resource\n        ret = _pci_assign_resource(dev, resno, size, align);\n            // \u200b\u5206\u914d\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\n            __pci_assign_resource\n                pci_bus_alloc_resource\n                    pci_bus_alloc_from_region\n                        /* Ok, try it out.. */\n                        ret = allocate_resource(r, res, size, ...);\n                            err = find_resource(root, new, size,...);\n                                __find_resource\n\n                                    // \u200b\u4ece\u200b\u8d44\u6e90\u200b\u94fe\u8868\u200b\u4e2d\u200b\u5206\u914d\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b\n                                    // \u200b\u8bbe\u7f6e\u200bpci_dev-&gt;resource[]\n                                    new-&gt;start = alloc.start;\n                                    new-&gt;end = alloc.end;\n            // \u200b\u628a\u200b\u5bf9\u5e94\u200b\u7684\u200bPCI\u200b\u5730\u5740\u200b\u5199\u5165\u200bBAR\n            pci_update_resource(dev, resno);\n                pci_std_update_resource\n                    /* \u200b\u628a\u200bCPU\u200b\u5730\u5740\u200b\u8f6c\u6362\u200b\u4e3a\u200bPCI\u200b\u5730\u5740\u200b: PCI\u200b\u5730\u5740\u200b = CPU\u200b\u5730\u5740\u200b - offset \n                     * \u200b\u5199\u5165\u200bBAR\n                     */\n                    pcibios_resource_to_bus(dev-&gt;bus, &amp;region, res);\n                    new = region.start;\n                    reg = PCI_BASE_ADDRESS_0 + 4 * resno;\n                    pci_write_config_dword(dev, reg, new);\n</code></pre> </li> </ul>"},{"location":"10_PCI_PCIe/11_1/","title":"11_INTx_MSI_MSIX\u200b\u4e09\u79cd\u200b\u4e2d\u65ad\u200b\u673a\u5236\u200b\u5206\u6790","text":""},{"location":"10_PCI_PCIe/11_1/#intx_msi_msix","title":"INTx_MSI_MSIX\u200b\u4e09\u79cd\u200b\u4e2d\u65ad\u200b\u673a\u5236\u200b\u5206\u6790","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>\u300aPCI_SPEV_V3_0.pdf\u300b6.8\u200b\u8282\u200b</p> </li> <li> <p>PCIe\u200b\u4e2d\u200bMSI\u200b\u548c\u200bMSI-X\u200b\u4e2d\u65ad\u200b\u673a\u5236\u200b</p> </li> <li> <p>PCIe\u200b\u5b66\u4e60\u200b\u7b14\u8bb0\u200b\u4e4b\u200bMSI/MSI-x\u200b\u4e2d\u65ad\u200b\u53ca\u200b\u4ee3\u7801\u200b\u5206\u6790\u200b</p> </li> <li> <p>msix\u200b\u4e2d\u65ad\u200b\u5206\u6790\u200b</p> </li> <li> <p>MSI\u200b\u4e2d\u65ad\u200b\u4e0e\u200bLinux\u200b\u5b9e\u73b0\u200b</p> </li> <li> <p>ARM GICv3\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b</p> </li> </ul> <p>\u200b\u5f00\u53d1\u677f\u200b\u8d44\u6599\u200b\uff1a</p> <ul> <li>https://wiki.t-firefly.com/zh_CN/ROC-RK3399-PC-PLUS/</li> </ul> <p>\u200b\u672c\u200b\u8bfe\u7a0b\u200b\u5206\u6790\u200b\u7684\u200b\u6587\u4ef6\u200b\uff1a</p> <ul> <li><code>linux-4.4_rk3399\\drivers\\pci\\host\\pcie-rockchip.c</code></li> </ul>"},{"location":"10_PCI_PCIe/11_1/#1-pciintx","title":"1. PCI\u200b\u8bbe\u5907\u200b\u7684\u200bINTx\u200b\u4e2d\u65ad\u200b\u673a\u5236","text":"<p>\u200b\u4f20\u7edf\u200bPCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u5f15\u811a\u200b\u4e2d\u6709\u200b4\u200b\u6761\u7ebf\u200b\uff1aINTA#\u3001INTB#\u3001INTC#\u3001INTD#\uff0c\"#\"\u200b\u8868\u793a\u200b\u4f4e\u7535\u5e73\u200b\u6709\u6548\u200b\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b\uff1a</p> <p></p> <p>PCI\u200b\u8bbe\u5907\u200b\u5c31\u200b\u50cf\u200b\u666e\u901a\u200b\u7684\u200b\u8bbe\u5907\u200b\u4e00\u6837\u200b\uff0c\u200b\u901a\u8fc7\u200b\u7269\u7406\u200b\u5f15\u811a\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u4fe1\u53f7\u200b\uff1a</p> <p></p> <p>\u200b\u5728\u200bPCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\uff0c\u200b\u5b83\u200b\u58f0\u660e\u200b\uff1a\u200b\u901a\u8fc7\u200bINTA#\u3001INTB#\u3001INTC#\u200b\u8fd8\u662f\u200bINTD#\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u3002</p> <p></p> <p>\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u6709\u200b2\u200b\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\uff1aInterrupt Pin\u3001Interrupt Line\uff0c\u200b\u4f5c\u7528\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>Interrupt Pin\uff1a\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u672c\u200b\u8bbe\u5907\u200b\u901a\u8fc7\u200b\u54ea\u6761\u200b\u5f15\u811a\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u53d6\u503c\u200b\u5982\u4e0b\u200b</li> </ul> Interrupt Pin\u200b\u53d6\u503c\u200b \u200b\u542b\u4e49\u200b 0 \u200b\u4e0d\u200b\u9700\u8981\u200b\u4e2d\u65ad\u200b\u5f15\u811a\u200b 1 \u200b\u901a\u8fc7\u200bINTA#\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b 2 \u200b\u901a\u8fc7\u200bINTB#\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b 3 \u200b\u901a\u8fc7\u200bINTC#\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b 4 \u200b\u901a\u8fc7\u200bINTD#\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b 5~0xff \u200b\u4fdd\u7559\u200b <ul> <li>Interrupt Line\uff1a\u200b\u7ed9\u200b\u8f6f\u4ef6\u200b\u4f7f\u7528\u200b\u7684\u200b\uff0cPCI\u200b\u8bbe\u5907\u200b\u672c\u8eab\u200b\u4e0d\u200b\u4f7f\u7528\u200b\u8be5\u200b\u5bc4\u5b58\u5668\u200b\u3002\u200b\u8f6f\u4ef6\u200b\u53ef\u4ee5\u200b\u5199\u5165\u200b\u4e2d\u65ad\u200b\u76f8\u5173\u200b\u7684\u200b\u4fe1\u606f\u200b\uff0c\u200b\u6bd4\u5982\u200b\u5728\u200bLinux\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u628a\u200b\u5206\u914d\u200b\u7684\u200bvirq(\u200b\u865a\u62df\u200b\u4e2d\u65ad\u200b\u53f7\u200b)\u200b\u5199\u5165\u200b\u6b64\u200b\u5bc4\u5b58\u5668\u200b\u3002\u200b\u8f6f\u4ef6\u200b\u5b8c\u5168\u200b\u53ef\u4ee5\u200b\u81ea\u5df1\u200b\u8bb0\u5f55\u200b\u4e2d\u65ad\u200b\u4fe1\u606f\u200b\uff0c\u200b\u6ca1\u200b\u5fc5\u8981\u200b\u4f9d\u8d56\u200b\u8fd9\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\u3002</li> </ul> <p>INTx\u200b\u4e2d\u65ad\u200b\u662f\u200b\u7535\u5e73\u200b\u89e6\u53d1\u200b\uff0c\u200b\u5904\u7406\u8fc7\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>PCI\u200b\u8bbe\u5907\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u8ba9\u200bINTx\u200b\u5f15\u811a\u200b\u53d8\u200b\u4f4e\u200b</li> <li>\u200b\u8f6f\u4ef6\u200b\u5904\u7406\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u6e05\u9664\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u5199\u200bPCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u67d0\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u5bfc\u81f4\u200bPCI\u200b\u8bbe\u5907\u200b\u53d6\u6d88\u200b\u4e2d\u65ad\u200b</li> <li>PCI\u200b\u8bbe\u5907\u200b\u53d6\u6d88\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u8ba9\u200bINTx\u200b\u5f15\u811a\u200b\u53d8\u9ad8\u200b</li> </ul>"},{"location":"10_PCI_PCIe/11_1/#2-pcieintx","title":"2. PCIe\u200b\u8bbe\u5907\u200b\u7684\u200bINTx\u200b\u4e2d\u65ad\u200b\u673a\u5236","text":"<p>PCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u4e5f\u200b\u540c\u6837\u200b\u6709\u200b\u8fd9\u200b2\u200b\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\uff1aInterrupt Pin\u3001Interrupt Line\uff0c\u200b\u5b83\u4eec\u200b\u7684\u200b\u4f5c\u7528\u200b\u8ddf\u200bPCI\u200b\u8bbe\u5907\u200b\u5b8c\u5168\u200b\u4e00\u6837\u200b\u3002</p> <p>PCI\u200b\u603b\u7ebf\u200b\u4e0a\u200b\u6709\u200bINTA#~INTD#\u200b\u8fd9\u4e9b\u200b\u771f\u5b9e\u200b\u5b58\u5728\u200b\u7684\u200b\u5f15\u811a\u200b\uff0c\u200b\u4f46\u662f\u200bPCIE\u200b\u603b\u7ebf\u200b\u4e0a\u200b\u5e76\u200b\u6ca1\u6709\u200b\u8fd9\u4e9b\u200b\u5f15\u811a\u200b\uff0cPCIe\u200b\u8bbe\u5907\u200b\u600e\u4e48\u200b\u517c\u5bb9\u200bINTx\u200b\u4e2d\u65ad\u200b\u673a\u5236\u200b\uff1f</p> <p>PCIe\u200b\u8bbe\u5907\u200b\u901a\u8fc7\u200b\"INTx\u200b\u6a21\u62df\u200b\"(PCI Compatible INTx Emulation)\u200b\u6765\u200b\u5b9e\u73b0\u200b\u4f20\u7edf\u200b\u7684\u200bINTx\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5f53\u200b\u8bbe\u5907\u200b\u9700\u8981\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u5b83\u4f1a\u200b\u53d1\u51fa\u200b\u7279\u6b8a\u200b\u7684\u200bTLP\u200b\u5305\u200b\uff1a</p> <p></p> <p>TLP\u200b\u5934\u90e8\u200b\u4e2d\u200b\uff0cMessage Code\u200b\u88ab\u200b\u7528\u6765\u200b\u533a\u5206\u200b\u53d1\u51fa\u200b\u7684\u200b\u662f\u200b\u54ea\u7c7b\u200bTLP\u200b\u5305\u200b\uff0c\u200b\u4e3a\u4f8b\u200b\"INTx\u200b\u6a21\u62df\u200b\"\uff0c\u200b\u6709\u200b\u4e24\u7c7b\u200bTLP\u200b\u5305\u200b\uff1a</p> <ul> <li>Assert_INTx   </li> <li>Deassert_INTx   </li> </ul> <p>\u200b\u8ddf\u200b\u4f20\u7edf\u200bPCI\u200b\u8bbe\u5907\u200b\u7c7b\u4f3c\u200b\uff0c\u200b\u8fd9\u4e2a\u200b\"INTx\u200b\u6a21\u62df\u200b\"\u200b\u7684\u200b\u5904\u7406\u8fc7\u7a0b\u200b\u4e5f\u200b\u662f\u200b\u4e00\u6837\u200b\u7684\u200b\uff1a</p> <ul> <li>PCIe\u200b\u8bbe\u5907\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u53d1\u51fa\u200bAssert_INTx\u200b\u7684\u200bTLP\u200b\u5305\u200b</li> <li>\u200b\u8f6f\u4ef6\u200b\u5904\u7406\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u6e05\u9664\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u5199\u200bPCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\u67d0\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u5bfc\u81f4\u200bPCIe\u200b\u8bbe\u5907\u200b\u53d6\u6d88\u200b\u4e2d\u65ad\u200b</li> <li>PCIe\u200b\u8bbe\u5907\u200b\u53d6\u6d88\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u53d1\u51fa\u200bDeassert_INTx\u200b\u7684\u200bTLP\u200b\u5305\u200b</li> </ul> <p>\u200b\u786c\u4ef6\u200b\u6846\u56fe\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u5bf9\u4e8e\u200b\u8f6f\u4ef6\u200b\u5f00\u53d1\u4eba\u5458\u200b\u6765\u8bf4\u200b\uff0c\u200b\u4ed6\u200b\u611f\u89c9\u200b\u4e0d\u5230\u200b\u53d8\u5316\u200b\uff1a</p> <ul> <li>PCI\u200b\u8bbe\u5907\u200b\u901a\u8fc7\u200b\u771f\u5b9e\u200b\u7684\u200b\u5f15\u811a\u200b\u4f20\u8f93\u200b\u4e2d\u65ad\u200b</li> <li>PCIe\u200b\u8bbe\u5907\u200b\u901a\u8fc7\u200bTLP\u200b\u5b9e\u73b0\u200b\u865a\u62df\u200b\u7684\u200b\u5f15\u811a\u200b\u4f20\u8f93\u200b\u4e2d\u65ad\u200b</li> </ul> <p>PCIe\u200b\u63a7\u5236\u5668\u200b\u5185\u90e8\u200b\u63a5\u6536\u200b\u5230\u200bINTx\u200b\u7684\u200bTLP\u200b\u5305\u540e\u200b\uff0c\u200b\u5c31\u200b\u4f1a\u200b\u5411\u200bGIC\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u6700\u7ec8\u200b\u5bfc\u81f4\u200bCPU\u200b\u63a5\u6536\u200b\u5230\u200b\u4e2d\u65ad\u200b\u4fe1\u53f7\u200b\u3002</p> <p>\u200b\u5bf9\u5e94\u200b\u7684\u200b\u4e2d\u65ad\u200b\u7a0b\u5e8f\u6267\u884c\u200b\u65f6\u200b\uff0c\u200b\u4f1a\u200b\u8bfb\u53d6\u200bPCIe\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u5206\u8fa8\u200b\u53d1\u751f\u200b\u7684\u200b\u662f\u200bINTA#~INTD#\u200b\u8fd9\u200b4\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\u7684\u200b\u54ea\u200b\u4e00\u4e2a\u200b\u3002</p>"},{"location":"10_PCI_PCIe/11_1/#3-msi","title":"3. MSI\u200b\u4e2d\u65ad\u200b\u673a\u5236","text":"<p>\u200b\u5728\u200bPCI\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\uff0c\u200b\u4f7f\u7528\u200b\u771f\u5b9e\u200b\u7684\u200b\u5f15\u811a\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u5df2\u7ecf\u200b\u5e26\u6765\u200b\u4e86\u200b\u4e0d\u200b\u65b9\u4fbf\u200b\uff1a</p> <ul> <li>\u200b\u7535\u8def\u677f\u200b\u4e0a\u200b\u9700\u8981\u200b\u5e03\u7ebf\u200b</li> <li>\u200b\u53ea\u6709\u200b4\u200b\u6761\u200b\u5f15\u811a\u200b\uff0c\u200b\u591a\u4e2a\u200bPCI\u200b\u8bbe\u5907\u200b\u5171\u4eab\u200b\u8fd9\u4e9b\u200b\u5f15\u811a\u200b\uff0c\u200b\u4e2d\u65ad\u200b\u5904\u7406\u200b\u6548\u7387\u200b\u4f4e\u200b\u3002</li> </ul> <p>\u200b\u5728\u200bPCI\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\uff0c\u200b\u5c31\u200b\u5df2\u7ecf\u200b\u5f15\u5165\u200b\u4e86\u200b\u65b0\u200b\u7684\u200b\u4e2d\u65ad\u200b\u673a\u5236\u200b\uff1aMSI\uff0cMessage Signaled Interrupts\u3002</p> <p>\u200b\u5728\u200b\u521d\u59cb\u200bPCI\u200b\u8bbe\u5907\u200b\u65f6\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u544a\u8bc9\u200b\u5b83\u200b\u4e00\u4e2a\u200b\u5730\u5740\u200b(\u200b\u4e3b\u63a7\u200b\u82af\u7247\u200b\u7684\u200b\u5730\u5740\u200b)\u3001\u200b\u4e00\u4e2a\u200b\u6570\u636e\u200b\uff1a</p> <ul> <li>PCI\u200b\u8bbe\u5907\u200b\u60f3\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u5f80\u200b\u8fd9\u4e2a\u200b\u5730\u5740\u200b\u5199\u5165\u200b\u8fd9\u4e2a\u200b\u6570\u636e\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b</li> <li>\u200b\u8f6f\u4ef6\u200b\u8bfb\u200b\u5230\u200b\u8fd9\u4e2a\u200b\u6570\u636e\u200b\uff0c\u200b\u5c31\u200b\u77e5\u9053\u200b\u662f\u200b\u54ea\u4e2a\u200b\u8bbe\u5907\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u4e86\u200b</li> </ul> <p>\u200b\u6d41\u7a0b\u200b\u53ca\u200b\u786c\u4ef6\u200b\u6846\u56fe\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u5199\u200b\u54ea\u4e2a\u200b\u5730\u5740\u200b\u53ef\u4ee5\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\uff1f\u200b\u53ef\u80fd\u200b\u662f\u200bPCI/PCIe\u200b\u63a7\u5236\u5668\u200b\u91cc\u9762\u200b\u7684\u200b\u67d0\u4e2a\u200b\u5730\u5740\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u80fd\u200b\u662f\u200bGIC\u200b\u7684\u200b\u67d0\u4e2a\u200b\u5730\u5740\u200b</li> <li>\u200b\u521d\u59cb\u5316\u200bPCI/PCIe\u200b\u8bbe\u5907\u200b\u65f6\u200b\uff0c\u200b\u628a\u200b\u8be5\u200b\u5730\u5740\u200b(cpu_addr)\u200b\u8f6c\u6362\u200b\u4e3a\u200bpci_addr\uff0c\u200b\u544a\u77e5\u200bPCI/PCIe\u200b\u8bbe\u5907\u200b(\u200b\u5199\u5165\u200b\u5b83\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b)</li> <li>PCI/PCIe\u200b\u8bbe\u5907\u200b\u8981\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u4f1a\u200b\u53d1\u8d77\u200b\u4e00\u4e2a\u200b\"\u200b\u5199\u200b\u5185\u5b58\u200b\u4f20\u8f93\u200b\"\uff1a\u200b\u5f80\u200bpci_addr\u200b\u5199\u5165\u200b\u6570\u636e\u200bvalue</li> <li>\u200b\u8fd9\u200b\u5bfc\u81f4\u200bcpu_addr\u200b\u88ab\u200b\u5199\u5165\u200b\u6570\u636e\u200bvalue\uff0c\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b</li> </ul> <p></p> <p>\u200b\u4e0a\u56fe\u200b\u4e2d\u200b\u7684\u200b\"pci_addr/value\"\u200b\u4fdd\u5b58\u200b\u5728\u200b\u54ea\u91cc\u200b\uff1f\u200b\u4fdd\u5b58\u200b\u5728\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u7684\u200bcapability\u200b\u91cc\u200b\u3002</p>"},{"location":"10_PCI_PCIe/11_1/#31-capability","title":"3.1 capability","text":"<p>capability\u200b\u7684\u200b\u610f\u601d\u200b\u662f\u200b\"\u200b\u80fd\u529b\u200b\"\uff0cPCI/PCIe\u200b\u8bbe\u5907\u200b\u53ef\u4ee5\u200b\u63d0\u4f9b\u200b\u5404\u79cd\u200b\u80fd\u529b\u200b\uff0c\u200b\u6240\u4ee5\u200b\u5728\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u91cc\u200b\u6709\u200b\u5bc4\u5b58\u5668\u200b\u6765\u200b\u63cf\u8ff0\u200b\u8fd9\u4e9b\u200bcapability\uff1a</p> <ul> <li>\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u91cc\u200b\u6709\u200b\u7b2c\u200b1\u200b\u4e2a\u200bcapability\u200b\u7684\u200b\u4f4d\u7f6e\u200b\uff1aCapabilities Pointer</li> <li>\u200b\u5b83\u200b\u6307\u5411\u200b\u7b2c\u200b1\u200b\u4e2a\u200bcapability\u200b\u7684\u200b\u591a\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u5bc4\u5b58\u5668\u200b\u4e5f\u200b\u662f\u200b\u5728\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u91cc\u200b</li> <li>\u200b\u7b2c\u200b1\u200b\u4e2a\u200bcapability\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u91cc\u200b\uff0c\u200b\u4e5f\u200b\u4f1a\u200b\u6307\u793a\u200b\u7b2c\u200b2\u200b\u4e2a\u200bcapability\u200b\u5728\u200b\u54ea\u91cc\u200b</li> </ul> <p></p> <p>Capability\u200b\u793a\u4f8b\u200b\u56fe\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b0x34\u200b\u4f4d\u7f6e\u200b\uff0c\u200b\u5b58\u653e\u200b\u7684\u200b\u662f\u200b\u7b2c\u200b1\u200b\u4e2a\u200bcapability\u200b\u7684\u200b\u4f4d\u7f6e\u200b\uff1a\u200b\u5047\u8bbe\u200b\u662f\u200b A4H</li> <li>\u200b\u5728\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b0xA4\u200b\u4f4d\u7f6e\u200b\uff0c\u200b\u627e\u5230\u200b\u7b2c\u200b1\u200b\u4e2a\u200bcapability\uff0ccapability\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u6709\u200b\u5982\u4e0b\u200b\u7ea6\u5b9a\u200b</li> <li>\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u5b57\u8282\u200b\u8868\u793a\u200bID\uff0c\u200b\u6bcf\u200b\u7c7b\u200bcapability\u200b\u90fd\u200b\u6709\u200b\u81ea\u5df1\u200b\u7684\u200bID</li> <li>\u200b\u7b2c\u200b2\u200b\u4e2a\u200b\u5b57\u8282\u200b\u8868\u793a\u200b\u4e0b\u200b\u4e00\u4e2a\u200bcapability\u200b\u7684\u200b\u4f4d\u7f6e\u200b\uff0c\u200b\u5982\u679c\u200b\u7b49\u4e8e\u200b0\u200b\u8868\u793a\u200b\u8fd9\u662f\u200b\u6700\u540e\u200b\u4e00\u4e2a\u200bcapability</li> <li>\u200b\u5176\u4ed6\u200b\u5bc4\u5b58\u5668\u200b\u7531\u200bcapability\u200b\u51b3\u5b9a\u200b\uff0c\u200b\u6240\u200b\u5360\u636e\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u6570\u91cf\u200b\u7531\u200bcapability\u200b\u51b3\u5b9a\u200b</li> <li>\u200b\u7b2c\u200b1\u200b\u4e2a\u200bcapability\u200b\u91cc\u9762\u200b\uff0c\u200b\u5b83\u200b\u8868\u793a\u200b\u4e0b\u200b\u4e00\u4e2a\u200bcapability\u200b\u5728\u200b5CH</li> <li>\u200b\u5728\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b0x5C\u200b\u4f4d\u7f6e\u200b\uff0c\u200b\u627e\u5230\u200b\u7b2c\u200b2\u200b\u4e2a\u200bcapability</li> <li>\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u5b57\u8282\u200b\u8868\u793a\u200bID\uff0c\u200b\u7b2c\u200b2\u200b\u4e2a\u200b\u5b57\u8282\u200b\u8868\u793a\u200b\u4e0b\u200b\u4e00\u4e2a\u200bcapability\u200b\u7684\u200b\u4f4d\u7f6e\u200b(\u200b\u56fe\u91cc\u200b\u662f\u200bE0H)</li> <li>\u200b\u5176\u4ed6\u200b\u5b57\u8282\u200b\u7531\u200bcapability\u200b\u672c\u8eab\u200b\u51b3\u5b9a\u200b</li> <li>\u200b\u5728\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b0xE0\u200b\u4f4d\u7f6e\u200b\uff0c\u200b\u627e\u5230\u200b\u7b2c\u200b3\u200b\u4e2a\u200bcapability</li> <li>\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u5b57\u8282\u200b\u8868\u793a\u200bID</li> <li>\u200b\u7b2c\u200b2\u200b\u4e2a\u200b\u5b57\u8282\u200b\u8868\u793a\u200b\u4e0b\u200b\u4e00\u4e2a\u200bcapability\u200b\u7684\u200b\u4f4d\u7f6e\u200b\uff0c\u200b\u8fd9\u91cc\u200b\u662f\u200b00H\u200b\u8868\u793a\u200b\u6ca1\u6709\u200b\u66f4\u200b\u591a\u200b\u7684\u200bcapability\u200b\u4e86\u200b</li> <li>\u200b\u5176\u4ed6\u200b\u5b57\u8282\u200b\u7531\u200bcapability\u200b\u672c\u8eab\u200b\u51b3\u5b9a\u200b</li> </ul> <p></p>"},{"location":"10_PCI_PCIe/11_1/#32-msi-capability","title":"3.2 MSI capability","text":"<p>\u200b\u4e00\u4e2a\u200bPCI\u200b\u8bbe\u5907\u200b\u662f\u5426\u200b\u652f\u6301\u200bMSI\uff0c\u200b\u9700\u8981\u200b\u8bfb\u53d6\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u7684\u200bcapability\u200b\u6765\u200b\u5224\u65ad\u200b: \u200b\u6709\u200bMSI capability\u200b\u7684\u8bdd\u200b\u5c31\u200b\u652f\u6301\u200bMSI\u200b\u673a\u5236\u200b\u3002</p> <p>\u200b\u5728\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u4e2d\u200b\uff0cMSI capability\u200b\u7528\u6765\u200b\u4fdd\u5b58\u200b\uff1apci_addr\u3001data\u3002\u200b\u8868\u793a\u200b\uff1aPCI\u200b\u8bbe\u5907\u200b\u5f80\u200b\u8fd9\u4e2a\u200bpci_addr\u200b\u5199\u5165\u200bdata\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\u3002</p> <p>\u200b\u6709\u200b\u5982\u4e0b\u200b\u95ee\u9898\u200b\u8981\u200b\u786e\u8ba4\u200b\uff1a</p> <ul> <li>pci_addr\u200b\u662f\u200b32\u200b\u4f4d\u200b\u3001\u200b\u8fd8\u662f\u200b64\u200b\u4f4d\u200b\uff1f</li> <li>\u200b\u80fd\u200b\u89e6\u53d1\u200b\u51e0\u4e2a\u200b\u4e2d\u65ad\u200b\uff1f\u200b\u901a\u8fc7\u200b\u5730\u5740\u200b\u6765\u200b\u5206\u8fa8\u200b\uff0c\u200b\u8fd8\u662f\u200b\u901a\u8fc7\u200b\u6570\u636e\u200b\u6765\u200b\u5206\u8fa8\u200b\uff1f</li> <li>\u200b\u8fd9\u4e9b\u200b\u4e2d\u65ad\u200b\u80fd\u5426\u200b\u5c4f\u853d\u200b\uff1f</li> <li>\u200b\u80fd\u5426\u200b\u8bfb\u51fa\u200b\u4e2d\u65ad\u200b\u72b6\u6001\u200b\uff1f</li> <li>\u200b\u8fd9\u4e2a\u200b\u4e9b\u200b\u95ee\u9898\u200b\uff0c\u200b\u90fd\u200b\u7531\u200bcapability\u200b\u91cc\u9762\u200b\u7684\u200b\"Message Control\"\u200b\u51b3\u5b9a\u200b\u3002</li> </ul> <p>MSI capability\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/11_1/#33","title":"3.3 \u200b\u683c\u5f0f\u200b\u89e3\u6790","text":"<p>MSI Capability\u200b\u683c\u5f0f\u200b\u7684\u200b\u542b\u4e49\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li> <p>Capability ID\uff1a\u200b\u5bf9\u4e8e\u200bMSI capability\uff0c\u200b\u5b83\u200b\u7684\u200bID\u200b\u4e3a\u200b05H</p> </li> <li> <p>Next Pointer\uff1a\u200b\u4e0b\u200b\u4e00\u4e2a\u200bcapability\u200b\u7684\u200b\u4f4d\u7f6e\u200b\uff0c00H\u200b\u8868\u793a\u200b\u8fd9\u662f\u200b\u6700\u540e\u200b\u4e00\u4e2a\u200bcapability</p> </li> <li> <p>Message Control</p> </li> </ul> \u200b\u4f4d\u200b \u200b\u57df\u200b \u200b\u63cf\u8ff0\u200b 8 Per-vector masking capable \u200b\u662f\u5426\u200b\u652f\u6301\u200b\u5c4f\u853d\u200b\u5355\u4e2a\u200b\u4e2d\u65ad\u200b(vector)\uff1a1: \u200b\u652f\u6301\u200b0: \u200b\u4e0d\u200b\u652f\u6301\u200b\u8fd9\u662f\u200b\u53ea\u8bfb\u200b\u4f4d\u200b\u3002 7 64 bit address capable \u200b\u662f\u5426\u200b\u652f\u6301\u200b64\u200b\u4f4d\u200b\u5730\u5740\u200b\uff1a1: \u200b\u652f\u6301\u200b0: \u200b\u4e0d\u200b\u652f\u6301\u200b\u8fd9\u662f\u200b\u53ea\u8bfb\u200b\u4f4d\u200b\u3002 6:4 Multiple Message Enable \u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u53ef\u4ee5\u200b\u652f\u6301\u200b\u591a\u5c11\u200b\u4e2a\u200bMSI\u200b\u4e2d\u65ad\u200b\uff1fPCI\u200b\u8bbe\u5907\u200b\u53ef\u4ee5\u200b\u8868\u660e\u200b\u81ea\u5df1\u200b\u60f3\u200b\u53d1\u51fa\u200b\u591a\u5c11\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u4f46\u662f\u200b\u5230\u5e95\u200b\u80fd\u200b\u53d1\u51fa\u200b\u51e0\u4e2a\u200b\u4e2d\u65ad\u200b\uff1f\u200b\u7531\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u51b3\u5b9a\u200b\uff0c\u200b\u5b83\u4f1a\u200b\u5199\u200b\u8fd9\u4e9b\u200b\u4f4d\u200b\uff0c\u200b\u8868\u793a\u200b\u80fd\u200b\u652f\u6301\u200b\u591a\u5c11\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\uff1a000: \u200b\u7cfb\u7edf\u200b\u5206\u914d\u200b\u4e86\u200b1\u200b\u4e2a\u200b\u4e2d\u65ad\u200b001: \u200b\u7cfb\u7edf\u200b\u5206\u914d\u200b\u4e86\u200b2\u200b\u4e2a\u200b\u4e2d\u65ad\u200b010: \u200b\u7cfb\u7edf\u200b\u5206\u914d\u200b\u4e86\u200b4\u200b\u4e2a\u200b\u4e2d\u65ad\u200b011: \u200b\u7cfb\u7edf\u200b\u5206\u914d\u200b\u4e86\u200b8\u200b\u4e2a\u200b\u4e2d\u65ad\u200b100: \u200b\u7cfb\u7edf\u200b\u5206\u914d\u200b\u4e86\u200b16\u200b\u4e2a\u200b\u4e2d\u65ad\u200b101: \u200b\u7cfb\u7edf\u200b\u5206\u914d\u200b\u4e86\u200b32\u200b\u4e2a\u200b\u4e2d\u65ad\u200b110: \u200b\u4fdd\u7559\u503c\u200b111: \u200b\u4fdd\u7559\u503c\u200b\u8fd9\u4e9b\u200b\u4f4d\u662f\u200b\u53ef\u8bfb\u200b\u53ef\u200b\u5199\u200b\u7684\u200b\u3002 3:1 Multiple Message Capable PCI\u200b\u8bbe\u5907\u200b\u53ef\u4ee5\u200b\u8868\u660e\u200b\u81ea\u5df1\u200b\u60f3\u200b\u53d1\u51fa\u200b\u591a\u5c11\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\uff1a000: \u200b\u8bbe\u5907\u200b\u7533\u8bf7\u200b1\u200b\u4e2a\u200b\u4e2d\u65ad\u200b001: \u200b\u8bbe\u5907\u200b\u7533\u8bf7\u200b2\u200b\u4e2a\u200b\u4e2d\u65ad\u200b010: \u200b\u8bbe\u5907\u200b\u7533\u8bf7\u200b4\u200b\u4e2a\u200b\u4e2d\u65ad\u200b011: \u200b\u8bbe\u5907\u200b\u7533\u8bf7\u200b8\u200b\u4e2a\u200b\u4e2d\u65ad\u200b100: \u200b\u8bbe\u5907\u200b\u7533\u8bf7\u200b16\u200b\u4e2a\u200b\u4e2d\u65ad\u200b101: \u200b\u8bbe\u5907\u200b\u7533\u8bf7\u200b32\u200b\u4e2a\u200b\u4e2d\u65ad\u200b110: \u200b\u4fdd\u7559\u503c\u200b111: \u200b\u4fdd\u7559\u503c\u200b\u8fd9\u4e9b\u200b\u4f4d\u662f\u200b\u53ea\u8bfb\u200b\u7684\u200b\u3002 0 MSI Enable \u200b\u4f7f\u80fd\u200bMSI\uff1a1: \u200b\u4f7f\u80fd\u200b0: \u200b\u7981\u6b62\u200b <ul> <li> <p>Message Address/Message Uper Address\uff1a\u200b\u5730\u5740\u200b</p> </li> <li> <p>32\u200b\u4f4d\u200b\u5730\u5740\u200b\u4fdd\u5b58\u200b\u5728\u200bMessage Address\u200b\u4e2d\u200b</p> </li> <li>64\u200b\u4f4d\u200b\u5730\u5740\u200b\uff1a\u200b\u4f4e\u200b32\u200b\u4f4d\u200b\u5730\u5740\u200b\u4fdd\u5b58\u200b\u5728\u200bMessage Address\u200b\u4e2d\u200b\uff0c\u200b\u9ad8\u200b32\u200b\u4f4d\u200b\u5730\u5740\u200b\u4fdd\u5b58\u200b\u5728\u200bMessage Uper Address\u200b\u4e2d\u200b</li> <li>\u200b\u8fd9\u4e9b\u200b\u5730\u5740\u200b\u662f\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u521d\u59cb\u5316\u200bPCI\u200b\u8bbe\u5907\u200b\u65f6\u200b\u5206\u914d\u200b\u7684\u200b\uff0c\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u628a\u200b\u5206\u914d\u200b\u7684\u200b\u5730\u5740\u200b\u5199\u5165\u200b\u8fd9\u4e9b\u200b\u5bc4\u5b58\u5668\u200b</li> <li> <p>\u200b\u8fd9\u4e9b\u200b\u5730\u5740\u200b\u5c5e\u4e8e\u200bPCI\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b</p> </li> <li> <p>Message Data\uff1a\u200b\u6570\u636e\u200b</p> </li> <li> <p>\u200b\u8fd9\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\u53ea\u6709\u200b15\u200b\u4f4d\u200b\uff0cPCI\u200b\u8bbe\u5907\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u65f6\u200b\u6570\u636e\u200b\u662f\u200b32\u200b\u4f4d\u200b\u7684\u200b\uff0c\u200b\u5176\u4e2d\u200b\u9ad8\u200b16\u200b\u4f4d\u200b\u6570\u636e\u200b\u4e3a\u200b0</p> </li> <li>\u200b\u8fd9\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\u7684\u200b\u6570\u503c\u200b\u662f\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u521d\u59cb\u5316\u200b\u8bbe\u5907\u200b\u65f6\u200b\u5199\u5165\u200b\u7684\u200b</li> <li> <p>\u200b\u5f53\u200bPCI\u200b\u8bbe\u5907\u200b\u60f3\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u662f\u200b\u4f1a\u200b\u53d1\u8d77\u200b\u4e00\u6b21\u200b\u5199\u200b\u4f20\u8f93\u200b\uff1a</p> <ul> <li>\u200b\u5f80\u200bMessage Address\u200b\u5bc4\u5b58\u5668\u200b\u8868\u793a\u200b\u7684\u200b\u5730\u5740\u200b\uff0c\u200b\u5199\u5165\u200bMessage Data\u200b\u5bc4\u5b58\u5668\u200b\u7684\u200b\u6570\u636e\u200b</li> <li>\u200b\u5982\u679c\u200b\u53ef\u4ee5\u200b\u53d1\u51fa\u200b\u591a\u4e2a\u200b\u4e2d\u65ad\u200b\u7684\u8bdd\u200b\uff0c\u200b\u53d1\u51fa\u200b\u7684\u200b\u6570\u636e\u200b\u4e2d\u200b\u4f4e\u4f4d\u200b\u53ef\u4ee5\u200b\u6539\u53d8\u200b</li> <li>\u200b\u6bd4\u5982\u200b\"Multiple Message Enable\"\u200b\u88ab\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b\"010\"\u200b\u8868\u793a\u200b\u53ef\u4ee5\u200b\u53d1\u51fa\u200b4\u200b\u4e2a\u200b\u4e2d\u65ad\u200b</li> <li>\u200b\u90a3\u4e48\u200bPCI\u200b\u8bbe\u5907\u200b\u53d1\u51fa\u200b\u7684\u200b\u6570\u636e\u200b\u4e2d\u200bbit1,0\u200b\u53ef\u4ee5\u200b\u4fee\u6539\u200b</li> </ul> </li> <li> <p>Mask Bits/Pending Bits: \u200b\u5c4f\u853d\u200b\u4f4d\u200b/\u200b\u6302\u200b\u8d77\u4f4d\u200b\uff0c\u200b\u8fd9\u662f\u200b\u53ef\u9009\u200b\u7684\u200b\u529f\u80fd\u200b\uff0cPCI\u200b\u8bbe\u5907\u200b\u4e0d\u200b\u4e00\u5b9a\u200b\u5b9e\u73b0\u200b\u5b83\u200b</p> </li> <li>Mask Bits\uff1a\u200b\u6bcf\u200b\u4e00\u4f4d\u200b\u7528\u6765\u200b\u5c4f\u853d\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u88ab\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b1\u200b\u8868\u793a\u200b\u7981\u6b62\u200b\u5bf9\u5e94\u200b\u7684\u200b\u4e2d\u65ad\u200b</li> <li>Pending Bits\uff1a\u200b\u6bcf\u200b\u4e00\u4f4d\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\u7684\u200b\u72b6\u6001\u200b\uff0c\u200b\u8fd9\u662f\u200b\u8f6f\u4ef6\u200b\u53ea\u8bfb\u200b\u4f4d\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u503c\u200b\u4e3a\u200b1\u200b\u8868\u793a\u200b\u5bf9\u5e94\u200b\u4e2d\u65ad\u200b\u53d1\u751f\u200b\u4e86\u200b\uff0c\u200b\u5f85\u5904\u7406\u200b</li> </ul>"},{"location":"10_PCI_PCIe/11_1/#4-msi-x","title":"4. MSI-X\u200b\u4e2d\u65ad\u200b\u673a\u5236","text":"<p>MSI\u200b\u673a\u5236\u200b\u6709\u200b\u51e0\u4e2a\u200b\u7f3a\u70b9\u200b\uff1a</p> <ul> <li>\u200b\u6bcf\u4e2a\u200b\u8bbe\u5907\u200b\u7684\u200b\u4e2d\u65ad\u200b\u6570\u200b\u6700\u5927\u200b\u662f\u200b32\uff0c\u200b\u592a\u5c11\u200b\u4e86\u200b</li> <li>\u200b\u9700\u8981\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u5206\u914d\u200b\u8fde\u7eed\u200b\u7684\u200b\u4e2d\u65ad\u200b\u53f7\u200b\uff0c\u200b\u5f88\u200b\u53ef\u80fd\u200b\u5931\u8d25\u200b\uff0c\u200b\u4e5f\u5c31\u662f\u8bf4\u200b\u8bbe\u5907\u200b\u60f3\u200b\u53d1\u51fa\u200bN\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u4f46\u662f\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u5206\u914d\u200b\u7ed9\u200b\u5b83\u200b\u7684\u200b\u4e2d\u65ad\u200b\u5c11\u4e8e\u200bN\u200b\u4e2a\u200b</li> <li>\u200b\u901a\u8fc7\u200bMSI\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u5730\u5740\u200b\u662f\u200b\u56fa\u5b9a\u200b\u7684\u200b</li> </ul> <p>\u200b\u4e8e\u662f\u200b\u5f15\u5165\u200b\u4e86\u200bMSI-X\u200b\u673a\u5236\u200b\uff1aEnhanced MSI interrupt support\uff0c\u200b\u5b83\u200b\u89e3\u51b3\u200b\u4e86\u200bMSI\u200b\u7684\u200b\u7f3a\u70b9\u200b\uff1a</p> <ul> <li>\u200b\u53ef\u4ee5\u200b\u652f\u6301\u200b\u591a\u5927\u200b2048\u200b\u4e2a\u200b\u4e2d\u65ad\u200b</li> <li>\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u53ef\u4ee5\u200b\u5355\u72ec\u200b\u8bbe\u7f6e\u200b\u6bcf\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u4e0d\u200b\u9700\u8981\u200b\u5206\u914d\u200b\u8fde\u7eed\u200b\u7684\u200b\u4e2d\u65ad\u200b\u53f7\u200b</li> <li>\u200b\u6bcf\u4e2a\u200b\u4e2d\u65ad\u200b\u53ef\u4ee5\u200b\u5355\u72ec\u200b\u8bbe\u7f6e\u200b\uff1aPCI\u200b\u8bbe\u5907\u200b\u4f7f\u7528\u200b\u7684\u200b\"\u200b\u5730\u5740\u200b/\u200b\u6570\u636e\u200b\"\u200b\u53ef\u4ee5\u200b\u5355\u72ec\u200b\u8bbe\u7f6e\u200b</li> </ul> <p>\u200b\u5047\u8bbe\u200bMSI-X\u200b\u53ef\u4ee5\u200b\u652f\u6301\u200b\u5f88\u591a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u6bcf\u4e2a\u200b\u4e2d\u65ad\u200b\u7684\u200b\"\u200b\u5730\u5740\u200b/\u200b\u6570\u636e\u200b\"\u200b\u90fd\u200b\u4e0d\u200b\u4e00\u6837\u200b\u3002\u200b\u63d0\u95ee\u200b\uff1a\u200b\u5728\u200b\u54ea\u91cc\u200b\u63cf\u8ff0\u200b\u8fd9\u4e9b\u200b\u4fe1\u606f\u200b\uff1f</p> <ul> <li>\"\u200b\u5730\u5740\u200b/\u200b\u6570\u636e\u200b\"\uff1a</li> <li>\u200b\u4e0d\u200b\u653e\u5728\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\uff0c\u200b\u7a7a\u95f4\u200b\u4e0d\u591f\u200b</li> <li>\u200b\u653e\u5728\u200bPCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u5185\u5b58\u7a7a\u95f4\u200b\uff1a\u200b\u54ea\u4e2a\u200b\u5185\u5b58\u7a7a\u95f4\u200b\uff1f\u200b\u54ea\u4e2a\u200bBAR\uff1f\u200b\u5185\u5b58\u7a7a\u95f4\u200b\u54ea\u4e2a\u200b\u4f4d\u7f6e\u200b(\u200b\u504f\u79fb\u200b\u5730\u5740\u200b)\uff1f</li> <li>\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u53ef\u4ee5\u200b\u8bfb\u5199\u200b\u8fd9\u4e9b\u200b\u5185\u5b58\u7a7a\u95f4\u200b</li> <li>\u200b\u4e2d\u65ad\u200b\u7684\u200b\u63a7\u5236\u200b\u4fe1\u606f\u200b</li> <li>\u200b\u4f7f\u80fd\u200b/\u200b\u7981\u6b62\u200b\uff1f</li> <li>\u200b\u5730\u5740\u200b\u662f\u200b32\u200b\u4f4d\u200b\u8fd8\u662f\u200b64\u200b\u4f4d\u200b\uff1f</li> <li>\u200b\u8fd9\u4e9b\u200b\u63a7\u5236\u200b\u4fe1\u606f\u200b\u4e5f\u200b\u662f\u200b\u4fdd\u5b58\u200b\u5728\u200bPCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u5185\u5b58\u7a7a\u95f4\u200b</li> <li>\u200b\u4e2d\u65ad\u200b\u7684\u200b\u72b6\u6001\u200b\u4fe1\u606f\u200b(\u200b\u6302\u200b\u8d77\u200b\uff1f)</li> <li>\u200b\u8fd9\u4e9b\u200b\u4fe1\u606f\u200b\u4e5f\u200b\u662f\u200b\u4fdd\u5b58\u200b\u5728\u200bPCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u5185\u5b58\u7a7a\u95f4\u200b</li> </ul>"},{"location":"10_PCI_PCIe/11_1/#41-msi-x-capability","title":"4.1 MSI-X capability","text":"<p>\u200b\u4e00\u4e2a\u200bPCI\u200b\u8bbe\u5907\u200b\u662f\u5426\u200b\u652f\u6301\u200bMSI-X\uff0c\u200b\u9700\u8981\u200b\u8bfb\u53d6\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u7684\u200bcapability\u200b\u6765\u200b\u5224\u65ad\u200b: \u200b\u6709\u200bMSI-X capability\u200b\u7684\u8bdd\u200b\u5c31\u200b\u652f\u6301\u200bMSI-X\u200b\u673a\u5236\u200b\u3002</p> <p>MSI-X capability\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/11_1/#42-msi-x-capability","title":"4.2 MSI-X capability\u200b\u683c\u5f0f\u200b\u89e3\u6790","text":"<p>\u200b\u683c\u5f0f\u200b\u89e3\u6790\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li> <p>Capability ID\uff1a\u200b\u5bf9\u4e8e\u200bMSI-X capability\uff0c\u200b\u5b83\u200b\u7684\u200bID\u200b\u4e3a\u200b11H</p> </li> <li> <p>Next Pointer\uff1a\u200b\u4e0b\u200b\u4e00\u4e2a\u200bcapability\u200b\u7684\u200b\u4f4d\u7f6e\u200b\uff0c00H\u200b\u8868\u793a\u200b\u8fd9\u662f\u200b\u6700\u540e\u200b\u4e00\u4e2a\u200bcapability</p> </li> <li> <p>Message Control</p> </li> </ul> \u200b\u4f4d\u200b \u200b\u540d\u200b \u200b\u63cf\u8ff0\u200b 15 MSI-X Enable \u200b\u662f\u5426\u200b\u4f7f\u80fd\u200bMSI-X\uff1a1: \u200b\u4f7f\u80fd\u200b0: \u200b\u7981\u6b62\u200b\u6ce8\u610f\u200b: MSI-X\u200b\u548c\u200bMSI\u200b\u4e0d\u80fd\u200b\u540c\u65f6\u200b\u4f7f\u80fd\u200b\u3002 14 Function Mask \u200b\u76f8\u5f53\u4e8e\u200bMSI-X\u200b\u4e2d\u65ad\u200b\u603b\u5f00\u5173\u200b\uff1a1: \u200b\u6240\u6709\u200b\u4e2d\u65ad\u200b\u7981\u6b62\u200b0: \u200b\u6709\u200b\u5404\u4e2a\u200b\u4e2d\u65ad\u200b\u7684\u200bMask\u200b\u4f4d\u200b\u51b3\u5b9a\u200b\u662f\u5426\u200b\u4f7f\u80fd\u200b\u5bf9\u5e94\u200b\u4e2d\u65ad\u200b 13 \u200b\u4fdd\u7559\u200b 10:0 Table Size \u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u8bfb\u53d6\u200b\u8fd9\u4e9b\u200b\u4f4d\u200b\uff0c\u200b\u7b97\u200b\u51fa\u200bMSI-X Table\u200b\u7684\u200b\u5927\u5c0f\u200b\uff0c\u200b\u4e5f\u200b\u5c31\u662f\u200b\u652f\u6301\u200b\u591a\u5c11\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\u8bfb\u51fa\u200b\u503c\u4e3a\u200b\"N-1\"\uff0c\u200b\u8868\u793a\u200b\u652f\u6301\u200bN\u200b\u4e2a\u200b\u4e2d\u65ad\u200b <ul> <li>Table Offset/Table BIR \uff1aBIR\u200b\u610f\u601d\u200b\u4e3a\u200b\"BAR Indicator register\"\uff0c\u200b\u8868\u793a\u200b\u4f7f\u7528\u200b\u54ea\u4e2a\u200bBAR\u3002</li> </ul> \u200b\u4f4d\u200b \u200b\u57df\u200b \u200b\u63cf\u8ff0\u200b 31:3 Table Offset MSI-X Table\u200b\u4fdd\u5b58\u200b\u5728\u200bPCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u5185\u5b58\u7a7a\u95f4\u200b\u91cc\u200b\uff0c\u200b\u5728\u200b\u54ea\u4e2a\u200b\u5185\u5b58\u7a7a\u95f4\u200b\uff1f\u200b\u6709\u200b\u4e0b\u9762\u200b\u7684\u200b\"Table BIR\"\u200b\u8868\u793a\u200b\u3002\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u5185\u5b58\u7a7a\u95f4\u200b\u7684\u200b\u54ea\u4e2a\u200b\u4f4d\u7f6e\u200b\uff1f\u200b\u7531\u200b\u5f53\u524d\u200b\u8fd9\u200b\u51e0\u4f4d\u200b\u8868\u793a\u200b\u3002 2:0 Table BIR \u200b\u4f7f\u7528\u200b\u54ea\u4e2a\u200b\u5185\u5b58\u7a7a\u95f4\u200b\u6765\u200b\u4fdd\u5b58\u200bMSI-X Table\uff1f\u200b\u4e5f\u200b\u5c31\u662f\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u4f7f\u7528\u200b\u54ea\u4e2a\u200bBAR\u200b\u6765\u200b\u8bbf\u95ee\u200bMSI-X Table\uff1f\u200b\u53d6\u503c\u200b\u4e3a\u200b0<sub>5\uff0c\u200b\u8868\u793a\u200bBAR0</sub>BAR5 <ul> <li>PBA Offset/PBA BIR\uff1aPBA\u200b\u610f\u601d\u200b\u4e3a\u200b\"Pending Bit Array\"\uff0c\u200b\u7528\u6765\u200b\u8868\u793a\u200bMSI-X\u200b\u4e2d\u65ad\u200b\u7684\u200b\u6302\u200b\u8d77\u200b\u72b6\u6001\u200b\u3002   | \u200b\u4f4d\u200b   | \u200b\u57df\u200b         | \u200b\u63cf\u8ff0\u200b                                                         |   | ---- | ---------- | ------------------------------------------------------------ |   | 31:3 | PBA Offset | PBA\u200b\u4fdd\u5b58\u200b\u5728\u200bPCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u5185\u5b58\u7a7a\u95f4\u200b\u91cc\u200b\uff0c\u200b\u5728\u200b\u54ea\u4e2a\u200b\u5185\u5b58\u7a7a\u95f4\u200b\uff1f\u200b\u6709\u200b\u4e0b\u9762\u200b\u7684\u200b\"PBA BIR\"\u200b\u8868\u793a\u200b\u3002\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u5185\u5b58\u7a7a\u95f4\u200b\u7684\u200b\u54ea\u4e2a\u200b\u4f4d\u7f6e\u200b\uff1f\u200b\u7531\u200b\u5f53\u524d\u200b\u8fd9\u200b\u51e0\u4f4d\u200b\u8868\u793a\u200b\u3002 |   | 2:0  | PBA BIR    | \u200b\u4f7f\u7528\u200b\u54ea\u4e2a\u200b\u5185\u5b58\u7a7a\u95f4\u200b\u6765\u200b\u4fdd\u5b58\u200bPBA\uff1f\u200b\u4e5f\u200b\u5c31\u662f\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u4f7f\u7528\u200b\u54ea\u4e2a\u200bBAR\u200b\u6765\u200b\u8bbf\u95ee\u200bPBA\uff1f\u200b\u53d6\u503c\u200b\u4e3a\u200b0<sub>5\uff0c\u200b\u8868\u793a\u200bBAR0</sub>BAR5 |</li> </ul>"},{"location":"10_PCI_PCIe/11_1/#43-msi-x-table","title":"4.3 MSI-X Table","text":"<p>PCI\u200b\u8bbe\u5907\u200b\u53ef\u4ee5\u200b\u5f80\u200b\u67d0\u4e2a\u200b\u5730\u5740\u200b\u5199\u5165\u200b\u67d0\u4e2a\u200b\u6570\u636e\u200b\uff0c\u200b\u4ece\u800c\u200b\u89e6\u53d1\u200bMSI-X\u200b\u4e2d\u65ad\u200b\u3002</p> <p>\u200b\u8fd9\u4e9b\u200b\"\u200b\u5730\u5740\u200b/\u200b\u6570\u636e\u200b\"\u200b\u4fe1\u606f\u200b\uff0c\u200b\u662f\u200b\u7531\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u5206\u914d\u200b\u7684\u200b\uff0c\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u8981\u200b\u628a\u200b\"\u200b\u5730\u5740\u200b/\u200b\u6570\u636e\u200b\"\u200b\u53d1\u7ed9\u200bPCI\u200b\u8bbe\u5907\u200b\u3002</p> <p>PCI\u200b\u8bbe\u5907\u200b\u5728\u200b\u54ea\u91cc\u200b\u4fdd\u5b58\u200b\u8fd9\u4e9b\u200b\u4fe1\u606f\u200b\uff1f</p> <ul> <li>\u200b\u5728\u200bPCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u5185\u5b58\u7a7a\u95f4\u200b</li> <li>\u200b\u5728\u200b\u54ea\u4e2a\u200b\u5185\u5b58\u7a7a\u95f4\u200b\uff1f\u200b\u7531\u200bMSI-X capability\u200b\u7684\u200b\"Table BIR\"\u200b\u51b3\u5b9a\u200b</li> <li>\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u5185\u5b58\u7a7a\u95f4\u200b\u7684\u200b\u54ea\u4e2a\u200b\u4f4d\u7f6e\u200b\uff1f\u200b\u7531\u200bMSI-X capability\u200b\u7684\u200b\"Table Offset\"\u200b\u51b3\u5b9a\u200b</li> </ul> <p>MSI-X Table\u200b\u683c\u5f0f\u200b\u5982\u4f55\u200b\uff1f\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b\uff1a</p> <p></p> <p>\u200b\u4e0a\u56fe\u200b\u4e2d\u200b\uff0cMsg Data\u3001Msg Addr Msg Upper Addr\u200b\u542b\u4e49\u200b\u4e0e\u200bMSI\u200b\u673a\u5236\u200b\u76f8\u540c\u200b\uff1aPCI\u200b\u8bbe\u5907\u200b\u8981\u200b\u53d1\u51fa\u200bMSI-X\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u5f80\u200b\u8fd9\u4e2a\u200b\u5730\u5740\u200b\u5199\u5165\u200b\u8fd9\u4e2a\u200b\u6570\u636e\u200b\u3002\u200b\u5982\u679c\u200b\u4f7f\u7528\u200b32\u200b\u4f4d\u200b\u5730\u5740\u200b\u7684\u8bdd\u200b\uff0c\u200b\u5199\u200b\u54ea\u4e2a\u200b\u5730\u5740\u200b\u7531\u200bMsg Addr\u200b\u5bc4\u5b58\u5668\u200b\u51b3\u5b9a\u200b\uff1b\u200b\u5982\u679c\u200b\u4f7f\u7528\u200b64\u200b\u4f4d\u200b\u5730\u5740\u200b\u7684\u8bdd\u200b\uff0c\u200b\u5199\u200b\u54ea\u4e2a\u200b\u5730\u5740\u200b\u7531\u200bMsg Addr\u200b\u548c\u200bMsg Upper Addr\u200b\u8fd9\u200b\u4e24\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\u51b3\u5b9a\u200b\u3002</p> <p>Vector Control\u200b\u5bc4\u5b58\u5668\u200b\u4e2d\u200b\uff0c\u200b\u53ea\u6709\u200bBit0\u200b\u6709\u200b\u4f5c\u7528\u200b\uff0c\u200b\u8868\u793a\u200b\"Mask Bit\"\u3002\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u5199\u5165\u200b1\u200b\u8868\u793a\u200b\u7981\u6b62\u200b\u5bf9\u5e94\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5199\u5165\u200b0\u200b\u8868\u793a\u200b\u4f7f\u80fd\u200b\u5bf9\u5e94\u200b\u4e2d\u65ad\u200b\u3002</p>"},{"location":"10_PCI_PCIe/11_1/#44-pba","title":"4.4 PBA","text":"<p>PBA\u200b\u610f\u601d\u200b\u4e3a\u200b\"Pending Bit Array\"\uff0c\u200b\u7528\u6765\u200b\u8868\u793a\u200bMSI-X\u200b\u4e2d\u65ad\u200b\u7684\u200b\u6302\u200b\u8d77\u200b\u72b6\u6001\u200b\u3002\u200b\u5b83\u200b\u7684\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> <p>\u200b\u8fd9\u4e9b\u200b\"\u200b\u6302\u200b\u8d77\u200b\"\u200b\u4fe1\u606f\u200b\uff0c\u200b\u662f\u200b\u7531\u200bPCI\u200b\u8bbe\u5907\u200b\u8bbe\u7f6e\u200b\uff0c\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u53ea\u80fd\u200b\u8bfb\u53d6\u200b\u8fd9\u4e9b\u200b\u4fe1\u606f\u200b\u3002</p> <p>PCI\u200b\u8bbe\u5907\u200b\u5728\u200b\u54ea\u91cc\u200b\u4fdd\u5b58\u200b\u8fd9\u4e9b\u200b\u4fe1\u606f\u200b\uff1f</p> <ul> <li>\u200b\u5728\u200bPCI\u200b\u8bbe\u5907\u200b\u7684\u200b\u5185\u5b58\u7a7a\u95f4\u200b</li> <li>\u200b\u5728\u200b\u54ea\u4e2a\u200b\u5185\u5b58\u7a7a\u95f4\u200b\uff1f\u200b\u7531\u200bMSI-X capability\u200b\u7684\u200b\"PBA BIR\"\u200b\u51b3\u5b9a\u200b</li> <li>\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u5185\u5b58\u7a7a\u95f4\u200b\u7684\u200b\u54ea\u4e2a\u200b\u4f4d\u7f6e\u200b\uff1f\u200b\u7531\u200bMSI-X capability\u200b\u7684\u200b\"PBA Offset\"\u200b\u51b3\u5b9a\u200b</li> </ul> <p>PBA\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a\u200b\u6bcf\u200b\u4e00\u4f4d\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u503c\u4e3a\u200b1\u200b\u8868\u793a\u200b\u4e2d\u65ad\u200b\u53d1\u751f\u200b\u4e86\u200b\u3001\u200b\u7b49\u5f85\u200b\u5904\u7406\u200b\u3002</p> <p></p>"},{"location":"10_PCI_PCIe/11_1/#5-msimsi-x","title":"5. MSI/MSI-X\u200b\u64cd\u4f5c\u200b\u6d41\u7a0b","text":""},{"location":"10_PCI_PCIe/11_1/#51","title":"5.1 \u200b\u626b\u63cf\u200b\u8bbe\u5907","text":"<p>\u200b\u626b\u63cf\u200b\u8bbe\u5907\u200b\uff0c\u200b\u8bfb\u53d6\u200bcapability\uff0c\u200b\u786e\u5b9a\u200b\u662f\u5426\u200b\u542b\u6709\u200bMSI capability\u3001\u200b\u662f\u5426\u200b\u542b\u6709\u200bMSI-X capability\u3002</p>"},{"location":"10_PCI_PCIe/11_1/#52","title":"5.2 \u200b\u914d\u7f6e\u200b\u8bbe\u5907","text":"<p>\u200b\u4e00\u4e2a\u200b\u8bbe\u5907\u200b\uff0c\u200b\u53ef\u80fd\u200b\u90fd\u200b\u652f\u6301\u200bINTx\u3001MSI\u3001MSI-X\uff0c\u200b\u8fd9\u200b3\u200b\u4e2d\u200b\u65b9\u5f0f\u200b\u53ea\u80fd\u200b\u9009\u62e9\u200b\u4e00\u79cd\u200b\u3002</p>"},{"location":"10_PCI_PCIe/11_1/#521-msi","title":"5.2.1 MSI\u200b\u914d\u7f6e","text":"<p>\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u8bfb\u53d6\u200bMSI capability\uff0c\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u60f3\u200b\u7533\u8bf7\u200b\u591a\u5c11\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\u3002</p> <p>\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u786e\u5b9a\u200b\u80fd\u200b\u5206\u914d\u200b\u591a\u5c11\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\u7ed9\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5e76\u200b\u628a\u200b\"\u200b\u5730\u5740\u200b/\u200b\u6570\u636e\u200b\"\u200b\u5199\u5165\u200bMSI capability\u3002</p> <p>\u200b\u5982\u679c\u200bMSI capability\u200b\u652f\u6301\u200b\u4e2d\u65ad\u200b\u4f7f\u80fd\u200b\u7684\u8bdd\u200b\uff0c\u200b\u8fd8\u200b\u9700\u8981\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u8bbe\u7f6e\u200bMSI capability\u200b\u6765\u200b\u4f7f\u200b\u80fd\u200b\u4e2d\u65ad\u200b\u3002</p> <p>\u200b\u6ce8\u610f\u200b\uff1a\u200b\u5982\u679c\u200b\u652f\u6301\u200b\u591a\u4e2a\u200bMSI\u200b\u4e2d\u65ad\u200b\uff0cPCI\u200b\u8bbe\u5907\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u5199\u200b\u7684\u200b\u662f\u200b\u540c\u4e00\u4e2a\u200b\u5730\u5740\u200b\uff0c\u200b\u4f46\u662f\u200b\u6570\u636e\u200b\u7684\u200b\u4f4e\u4f4d\u200b\u53ef\u4ee5\u200b\u53d1\u751f\u53d8\u5316\u200b\u3002</p> <p>\u200b\u6bd4\u5982\u200b\u652f\u6301\u200b4\u200b\u4e2a\u200bMSI\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u901a\u8fc7\u200b\u6570\u636e\u200b\u7684\u200bbit1\u3001bit0\u200b\u6765\u200b\u8868\u793a\u200b\u662f\u200b\u54ea\u4e2a\u200b\u4e2d\u65ad\u200b\u3002</p>"},{"location":"10_PCI_PCIe/11_1/#522-msi-x","title":"5.2.2 MSI-X\u200b\u914d\u7f6e","text":"<p>MSI-X\u200b\u673a\u5236\u200b\u4e2d\u200b\uff0c\u200b\u4e2d\u65ad\u200b\u76f8\u5173\u200b\u7684\u200b\u66f4\u200b\u591a\u200b\u4fe1\u606f\u200b\u4fdd\u5b58\u200b\u5728\u200b\u8bbe\u5907\u200b\u7684\u200b\u5185\u5b58\u7a7a\u95f4\u200b\u3002\u200b\u6240\u4ee5\u200b\u8981\u200b\u4f7f\u7528\u200bMSI-X\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u8981\u200b\u5148\u200b\u914d\u7f6e\u200b\u8bbe\u5907\u200b\u3001\u200b\u5206\u914d\u5185\u5b58\u200b\u7a7a\u95f4\u200b\u3002</p> <p>\u200b\u7136\u540e\u200b\uff0c\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u8bfb\u53d6\u200bMSI-X capability\uff0c\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u9700\u8981\u200b\u591a\u5c11\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\u3002</p> <p>\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u786e\u5b9a\u200b\u80fd\u200b\u5206\u914d\u200b\u591a\u5c11\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\u7ed9\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5e76\u200b\u628a\u200b\u591a\u4e2a\u200b\"\u200b\u5730\u5740\u200b/\u200b\u6570\u636e\u200b\"\u200b\u5199\u5165\u200bMSI-X Table\u3002</p> <p>\u200b\u6ce8\u610f\u200b\uff1aPCI\u200b\u8bbe\u5907\u200b\u8981\u200b\u53d1\u51fa\u200bMSI-X\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u5b83\u4f1a\u200b\u5f80\u200b\"\u200b\u5730\u5740\u200b\"\u200b\u5199\u5165\u200b\"\u200b\u6570\u636e\u200b\"\uff0c\u200b\u8fd9\u4e9b\u200b\"\u200b\u5730\u5740\u200b/\u200b\u6570\u636e\u200b\"\u200b\u4e00\u65e6\u200b\u914d\u7f6e\u200b\u540e\u200b\u662f\u200b\u4e0d\u4f1a\u200b\u53d8\u5316\u200b\u7684\u200b\u3002MSI\u200b\u673a\u5236\u200b\u4e2d\u200b\uff0c\u200b\u6570\u636e\u200b\u53ef\u4ee5\u200b\u53d8\u5316\u200b\uff0cMSI-X\u200b\u673a\u5236\u200b\u4e2d\u200b\u6570\u636e\u200b\u4e0d\u200b\u53ef\u4ee5\u200b\u53d8\u5316\u200b\u3002</p> <p>\u200b\u4f7f\u80fd\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u8bbe\u7f6e\u200b\u603b\u5f00\u5173\u200b\u3001MSI-X Table\u200b\u4e2d\u200b\u67d0\u4e2a\u200b\u4e2d\u65ad\u200b\u7684\u200b\u5f00\u5173\u200b\u3002</p> <p>\u200b\u6ce8\u610f\u200b\uff1aMSI-X Table\u200b\u4e2d\u200b\uff0c\u200b\u6bcf\u4e00\u9879\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u4fdd\u5b58\u200b\u4e00\u4e2a\u200b\"\u200b\u5730\u5740\u200b/\u200b\u6570\u636e\u200b\"\uff0cTable\u200b\u4e2d\u200b\"\u200b\u5730\u5740\u200b/\u200b\u6570\u636e\u200b\"\u200b\u53ef\u4ee5\u200b\u76f8\u540c\u200b\uff0c\u200b\u4e5f\u5c31\u662f\u8bf4\u200b\uff1aPCI\u200b\u8bbe\u5907\u200b\u53d1\u51fa\u200b\u7684\u200b\u4e2d\u65ad\u200b\u53ef\u4ee5\u200b\u662f\u200b\u540c\u4e00\u4e2a\u200b\u3002</p>"},{"location":"10_PCI_PCIe/11_1/#53","title":"5.3 \u200b\u8bbe\u5907\u200b\u53d1\u51fa\u200b\u4e2d\u65ad","text":"<p>PCI\u200b\u8bbe\u5907\u200b\u53d1\u51fa\u200bMSI\u200b\u4e2d\u65ad\u200b\u3001MSI-X\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u53d1\u8d77\u200b\"\u200b\u6570\u636e\u200b\u5199\u200b\"\u200b\u4f20\u8f93\u200b\uff0c\u200b\u5c31\u662f\u200b\u5f80\u200b\u6307\u5b9a\u200b\u5730\u5740\u200b\u5199\u5165\u200b\u6307\u5b9a\u200b\u6570\u636e\u200b\u3002</p> <p>PCI\u200b\u63a7\u5236\u5668\u63a5\u6536\u200b\u5230\u200b\u6570\u636e\u200b\u540e\u200b\uff0c\u200b\u5c31\u200b\u4f1a\u200b\u89e6\u53d1\u200bCPU\u200b\u4e2d\u65ad\u200b\u3002</p>"},{"location":"10_PCI_PCIe/11_1/#54","title":"5.4 \u200b\u4e2d\u65ad\u200b\u51fd\u6570","text":"<p>\u200b\u7cfb\u7edf\u8f6f\u4ef6\u200b\u6267\u884c\u200b\u4e2d\u65ad\u200b\u5904\u7406\u51fd\u6570\u200b\u3002</p>"},{"location":"10_PCI_PCIe/12_1/","title":"12_INTx\u200b\u4e2d\u65ad\u200b\u673a\u5236\u200b\u6e90\u7801\u200b\u5206\u6790","text":""},{"location":"10_PCI_PCIe/12_1/#intx","title":"INTx\u200b\u4e2d\u65ad\u200b\u673a\u5236\u200b\u6e90\u7801\u200b\u5206\u6790","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u300aPCI_SPEV_V3_0.pdf\u300b6.8\u200b\u8282\u200b</li> <li>\u300adevicetree-specification-v0.2.pdf\u300b</li> </ul> <p>\u200b\u5f00\u53d1\u677f\u200b\u8d44\u6599\u200b\uff1a</p> <ul> <li>https://wiki.t-firefly.com/zh_CN/ROC-RK3399-PC-PLUS/</li> </ul> <p>\u200b\u672c\u200b\u8bfe\u7a0b\u200b\u5206\u6790\u200b\u7684\u200b\u6587\u4ef6\u200b\uff1a</p> <ul> <li><code>linux-4.4_rk3399\\drivers\\pci\\host\\pcie-rockchip.c</code></li> </ul>"},{"location":"10_PCI_PCIe/12_1/#1","title":"1. \u200b\u914d\u7f6e\u200b\u7a7a\u95f4","text":"<p>\u200b\u65e0\u8bba\u662f\u200bPCI\u200b\u8bbe\u5907\u200b\u8fd8\u662f\u200bPCIe\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5b83\u4eec\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u5728\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u91cc\u200b\u58f0\u660e\u200b\uff1a\u200b\u901a\u8fc7\u200bINTA#\u3001INTB#\u3001INTC#\u200b\u8fd8\u662f\u200bINTD#\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u3002</p> <p></p> <p>\u200b\u914d\u7f6e\u200b\u7a7a\u95f4\u200b\u6709\u200b2\u200b\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\uff1aInterrupt Pin\u3001Interrupt Line\uff0c\u200b\u4f5c\u7528\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>Interrupt Pin\uff1a\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u672c\u200b\u8bbe\u5907\u200b\u901a\u8fc7\u200b\u54ea\u6761\u200b\u5f15\u811a\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u53d6\u503c\u200b\u5982\u4e0b\u200b</li> </ul> Interrupt Pin\u200b\u53d6\u503c\u200b \u200b\u542b\u4e49\u200b 0 \u200b\u4e0d\u200b\u9700\u8981\u200b\u4e2d\u65ad\u200b\u5f15\u811a\u200b 1 \u200b\u901a\u8fc7\u200bINTA#\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b 2 \u200b\u901a\u8fc7\u200bINTB#\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b 3 \u200b\u901a\u8fc7\u200bINTC#\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b 4 \u200b\u901a\u8fc7\u200bINTD#\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b 5~0xff \u200b\u4fdd\u7559\u200b <ul> <li>Interrupt Line\uff1a\u200b\u7ed9\u200b\u8f6f\u4ef6\u200b\u4f7f\u7528\u200b\u7684\u200b\uff0cPCI\u200b\u8bbe\u5907\u200b\u672c\u8eab\u200b\u4e0d\u200b\u4f7f\u7528\u200b\u8be5\u200b\u5bc4\u5b58\u5668\u200b\u3002\u200b\u8f6f\u4ef6\u200b\u53ef\u4ee5\u200b\u5199\u5165\u200b\u4e2d\u65ad\u200b\u76f8\u5173\u200b\u7684\u200b\u4fe1\u606f\u200b\uff0c\u200b\u6bd4\u5982\u200b\u5728\u200bLinux\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u628a\u200b\u5206\u914d\u200b\u7684\u200bvirq(\u200b\u865a\u62df\u200b\u4e2d\u65ad\u200b\u53f7\u200b)\u200b\u5199\u5165\u200b\u6b64\u200b\u5bc4\u5b58\u5668\u200b\u3002\u200b\u8f6f\u4ef6\u200b\u5b8c\u5168\u200b\u53ef\u4ee5\u200b\u81ea\u5df1\u200b\u8bb0\u5f55\u200b\u4e2d\u65ad\u200b\u4fe1\u606f\u200b\uff0c\u200b\u6ca1\u200b\u5fc5\u8981\u200b\u4f9d\u8d56\u200b\u8fd9\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\u3002</li> </ul>"},{"location":"10_PCI_PCIe/12_1/#2","title":"2. \u200b\u626b\u63cf\u200b\u8bbe\u5907\u200b\u65f6\u200b\u5206\u914d\u200b\u4e2d\u65ad\u200b\u53f7","text":"<p>PCIe\u200b\u8bbe\u5907\u200b\u5728\u200b\u786c\u4ef6\u200b\u4fe1\u606f\u200b\u91cc\u200b\u8868\u660e\u200b\u81ea\u5df1\u200b\u53ef\u4ee5\u200b\u53d1\u51fa\u200b\u54ea\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u6bd4\u5982\u200bINTA\u3001INTB\u3001INTC\u200b\u6216\u200bINTD\uff0c\u200b\u8fd9\u4e2a\u200b\u4e2d\u65ad\u200b\u8981\u200b\u8f6c\u6362\u200b\u4e3a\u200b\u4e2d\u65ad\u200b\u53f7\u200b\uff0c\u200b\u6211\u4eec\u200b\u7f16\u5199\u200b\u7684\u200b\u8f6f\u4ef6\u200b\u624d\u200b\u53ef\u4ee5\u200b\u4e3a\u200b\u5b83\u200b\u6ce8\u518c\u200b\u4e2d\u65ad\u200b\u5904\u7406\u51fd\u6570\u200b\u3002</p> <p>\u200b\u600e\u4e48\u200b\u5f97\u5230\u200b\u4e2d\u65ad\u200b\u53f7\u200b\uff1f\u200b\u4e0b\u9762\u200b\u53ea\u200b\u5217\u51fa\u200b\u8c03\u7528\u200b\u8fc7\u7a0b\u200b\uff0c\u200b\u540e\u9762\u200b\u518d\u200b\u5206\u6790\u200b\uff1a</p> <pre><code>rockchip_pcie_probe\n    bus = pci_scan_root_bus(&amp;pdev-&gt;dev, 0, &amp;rockchip_pcie_ops, rockchip, &amp;res);\n        pci_scan_root_bus_msi\n            pci_scan_child_bus\n                pci_scan_slot\n                    dev = pci_scan_single_device(bus, devfn);\n                        dev = pci_scan_device(bus, devfn);\n                            struct pci_dev *dev;\n                            dev = pci_alloc_dev(bus);\n                            pci_setup_device\n                                pci_read_bases(dev, 6, PCI_ROM_ADDRESS);    \n                        pci_device_add(dev, bus);\n                            pcibios_add_device(struct pci_dev *dev)\n                                dev-&gt;irq = of_irq_parse_and_map_pci(dev, 0, 0);\n</code></pre> <p>\u200b\u89e3\u6790\u200b\u51fa\u200b\u4e2d\u65ad\u200b\u4fe1\u606f\u200b\u540e\u200b\uff0c\u200b\u5206\u914d\u200b\u7684\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u653e\u5728\u200bpci_dev\u200b\u7684\u200birq\u200b\u91cc\u9762\u200b\uff1a</p> <pre><code>pci_scan_single_device\n    pci_device_add\n        pcibios_add_device(struct pci_dev *dev)\n            dev-&gt;irq = of_irq_parse_and_map_pci(dev, 0, 0);\n</code></pre>"},{"location":"10_PCI_PCIe/12_1/#3-intx","title":"3. \u200b\u4f7f\u7528\u200bINTx\u200b\u4e2d\u65ad","text":"<p>\u200b\u6bcf\u4e2a\u200bPCIe\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5728\u200bLinux\u200b\u5185\u6838\u200b\u91cc\u200b\u90fd\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200bpci_dev\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff1a</p> <p></p> <p>\u200b\u53ef\u4ee5\u200b\u4e3a\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u6ce8\u518c\u200b\u4e2d\u65ad\u200b\uff1a</p> <pre><code>request_irq(pci_dev-&gt;irq, ....);\n</code></pre>"},{"location":"10_PCI_PCIe/12_1/#4-pcie","title":"4. PCIe\u200b\u4e2d\u65ad\u200b\u6811","text":"<p>\u200b\u8981\u200b\u5206\u6790\u200bPCIe\u200b\u8bbe\u5907\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u7684\u200b\u5206\u914d\u200b\u8fc7\u7a0b\u200b\uff0c\u200b\u9700\u8981\u200b\u4ece\u200bRK3399\u200b\u7684\u200b\u82af\u7247\u200b\u8d44\u6599\u200b\u5f00\u59cb\u200b\u5b66\u4e60\u200b\u3002</p> <p>\u200b\u5c42\u7ea7\u200b\u7ed3\u6784\u200b\u4e3a\u200b\uff1aPCIe\u200b\u8bbe\u5907\u200b =&gt; PCIe\u200b\u63a7\u5236\u5668\u200b =&gt; GIC =&gt;CPU</p> <p></p> <p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\uff1a</p> <pre><code>       gic: interrupt-controller@fee00000 {\n                compatible = \"arm,gic-v3\";\n                #interrupt-cells = &lt;4&gt;;\n                #address-cells = &lt;2&gt;;\n                #size-cells = &lt;2&gt;;\n                ranges;\n                interrupt-controller;\n                /* \u200b\u7701\u7565\u200b */\n        };\n\n       pcie0: pcie@f8000000 {\n                compatible = \"rockchip,rk3399-pcie\";\n                #address-cells = &lt;3&gt;;\n                #size-cells = &lt;2&gt;;\n                aspm-no-l0s;\n                clocks = &lt;&amp;cru ACLK_PCIE&gt;, &lt;&amp;cru ACLK_PERF_PCIE&gt;,\n                         &lt;&amp;cru PCLK_PCIE&gt;, &lt;&amp;cru SCLK_PCIE_PM&gt;;\n                clock-names = \"aclk\", \"aclk-perf\",\n                              \"hclk\", \"pm\";\n                bus-range = &lt;0x0 0x1f&gt;;\n                max-link-speed = &lt;1&gt;;\n                linux,pci-domain = &lt;0&gt;;\n                msi-map = &lt;0x0 &amp;its 0x0 0x1000&gt;;\n                interrupts = &lt;GIC_SPI 49 IRQ_TYPE_LEVEL_HIGH 0&gt;,\n                             &lt;GIC_SPI 50 IRQ_TYPE_LEVEL_HIGH 0&gt;,\n                             &lt;GIC_SPI 51 IRQ_TYPE_LEVEL_HIGH 0&gt;;\n                interrupt-names = \"sys\", \"legacy\", \"client\";\n                #interrupt-cells = &lt;1&gt;;\n                interrupt-map-mask = &lt;0 0 0 7&gt;;\n                interrupt-map = &lt;0 0 0 1 &amp;pcie0_intc 0&gt;,\n                                &lt;0 0 0 2 &amp;pcie0_intc 1&gt;,\n                                &lt;0 0 0 3 &amp;pcie0_intc 2&gt;,\n                                &lt;0 0 0 4 &amp;pcie0_intc 3&gt;;\n    };\n</code></pre> <p>\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u7684\u200b\u8fc7\u7a0b\u200b\uff1a</p> <ul> <li>\u200b\u4efb\u4f55\u200b\u4e00\u4e2a\u200bPCIe\u200b\u8bbe\u5907\u200b\u5411\u200bPCIe\u200b\u63a7\u5236\u5668\u200b\u53d1\u51fa\u200b\"Assert INTx\"(x=A/B/C/D)\u200b\u8fd9\u200b\u7c7b\u200bTLP\u200b\u5305\u200b</li> <li>PCIe\u200b\u63a7\u5236\u5668\u200b\u5c31\u200b\u4f1a\u200b\u5411\u200bGIC\u200b\u53d1\u51fa\u200b\u7b2c\u200b50\u200b\u53f7\u200bSPI\u200b\u4e2d\u65ad\u200b</li> <li>GIC\u200b\u518d\u200b\u7ed9\u200bCPU\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u3002</li> </ul> <p>\u200b\u4e2d\u65ad\u200b\u7684\u200b\u5904\u7406\u8fc7\u7a0b\u200b\u662f\u200b\u53cd\u8fc7\u6765\u200b\u7684\u200b\uff1a</p> <ul> <li>CPU\u200b\u63a5\u6536\u200b\u5230\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u8df3\u8f6c\u200b\u5230\u200b\u5f02\u5e38\u200b\u5411\u91cf\u200b\u8868\u5904\u7406\u200b\u4ee3\u7801\u200b\uff0c\u200b\u4f1a\u200b\u8c03\u7528\u200bGIC\u200b\u9a71\u52a8\u200b</li> <li>GIC\uff1a\u200b\u8bfb\u53d6\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u5f97\u77e5\u200b\u53d1\u751f\u200b\u7684\u200b\u662f\u200bSPI 50\u200b\u53f7\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u8fd9\u4e2a\u200b\u4e2d\u65ad\u200b\u51fd\u6570\u200b\u7531\u200bPCIe\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u63d0\u4f9b\u200b</li> <li>PCIe\u200b\u63a7\u5236\u5668\u200b\uff1a\u200b\u8bfb\u53d6\u200bPCIe\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u5206\u8fa8\u200b\u662f\u200bINTA\u200b\u8fd8\u662f\u200bINTB\u3001INTC\u3001INTD\uff0c\u200b\u8c03\u7528\u200b\u5bf9\u5e94\u200b\u51fd\u6570\u200b\uff0c\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u7531\u200bPCIe\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u63d0\u4f9b\u200b</li> <li>PCI\u200b\u8bbe\u5907\u200b\uff1a\u200b\u63d0\u4f9b\u200b\u8bbe\u5907\u200b\u76f8\u5173\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</li> </ul>"},{"location":"10_PCI_PCIe/12_1/#5-pcie-intx","title":"5. PCIe INTx\u200b\u4e2d\u65ad\u200b\u6620\u5c04\u200b\u8fc7\u7a0b","text":"<p>\u200b\u6587\u4ef6\u200b\uff1a<code>drivers\\pci\\host\\pcie-rockchip.c</code></p>"},{"location":"10_PCI_PCIe/12_1/#51-pcie","title":"5.1 PCIe\u200b\u63a7\u5236\u5668\u200b\u652f\u6301\u200b\u7684\u200b\u4e2d\u65ad","text":"<p>\u200b\u5bf9\u4e8e\u200bRK3399\uff0cPCIe\u200b\u63a7\u5236\u5668\u200b\u53ef\u4ee5\u200b\u5411\u200bGIC\u200b\u53d1\u51fa\u200b3\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\uff1asys\u3001legacy\u3001client\uff1a</p> <ul> <li>sys\uff1a\u200b\u4e0b\u56fe\u200b\u4e2d\u200bEvent ID\u200b\u4e3a\u200b81\uff0c\u200b\u5c31\u662f\u200bSPI 49\u200b\u53f7\u200b\u4e2d\u65ad\u200b(81=32+49)\uff0c\u200b\u7528\u6765\u200b\u5904\u7406\u200b\u4e00\u4e9b\u200b\u7cfb\u7edf\u6027\u200b\u7684\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u6bd4\u5982\u200b\u7535\u6e90\u200b\u72b6\u6001\u200b\u3001\u200b\u70ed\u62d4\u200b\u63d2\u200b</li> <li>legacy\uff1a\u200b\u7528\u6765\u200b\u5904\u7406\u200bPCIe\u200b\u8bbe\u5907\u200b\u53d1\u6765\u200b\u7684\u200bINTA/INTB/INTC/INTD\u200b\u4e2d\u65ad\u200b</li> <li>client\uff1a\u200b\u8ddf\u200b\u5916\u63a5\u200b\u7684\u200bPCIe\u200b\u8bbe\u5907\u200b\u901a\u4fe1\u200b\u65f6\u200b\uff0c\u200b\u53ef\u80fd\u200b\u4f1a\u200b\u53d1\u9001\u200b\u4f20\u8f93\u200b\u9519\u8bef\u200b\uff0c\u200b\u7528\u200b\u8fd9\u4e2a\u200b\u4e2d\u65ad\u200b\u6765\u200b\u5904\u7406\u200b</li> </ul> <p></p> <p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\uff0c\u200b\u8fd9\u200b3\u200b\u7c7b\u200b\u4e2d\u65ad\u200b\u5982\u4e0b\u200b\u5b9a\u4e49\u200b\uff1a</p> <pre><code>       pcie0: pcie@f8000000 {\n                /* \u200b\u7701\u7565\u200b */\n                interrupts = &lt;GIC_SPI 49 IRQ_TYPE_LEVEL_HIGH 0&gt;,\n                             &lt;GIC_SPI 50 IRQ_TYPE_LEVEL_HIGH 0&gt;,\n                             &lt;GIC_SPI 51 IRQ_TYPE_LEVEL_HIGH 0&gt;;\n                interrupt-names = \"sys\", \"legacy\", \"client\";\n</code></pre>"},{"location":"10_PCI_PCIe/12_1/#52-pcie","title":"5.2 PCIe\u200b\u63a7\u5236\u5668\u200b\u6ce8\u518c\u200b\u4e2d\u65ad","text":"<p>\u200b\u4e3a\u4ec0\u4e48\u200blegacy\u200b\u4e2d\u65ad\u200b\u7684\u200b\u51fd\u6570\u200b\uff0c\u200b\u4e0d\u662f\u200b\u4f7f\u7528\u200b<code>devm_request_irq</code>\u200b\u800c\u662f\u200b\u4f7f\u7528\u200b<code>irq_set_chained_handler_and_data</code>?</p> <p>\u200b\u56e0\u4e3a\u200b\u53d1\u751f\u200blegacy\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0crockchip_pcie_legacy_int_handler\u200b\u51fd\u6570\u200b\u8981\u200b\u8fdb\u4e00\u6b65\u200b\u5206\u8fa8\u200b\u53d1\u751f\u200b\u7684\u200b\u662f\u200bINTA\u200b\u8fd8\u662f\u200bINTB\u3001INTC\u3001INTD\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u7136\u540e\u200b\u5904\u7406\u200b\u3002</p>"},{"location":"10_PCI_PCIe/12_1/#53-pcie","title":"5.3 PCIe\u200b\u8bbe\u5907\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u7684\u200b\u5206\u914d","text":""},{"location":"10_PCI_PCIe/12_1/#531-irq-domain","title":"5.3.1 IRQ domain","text":"<p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\uff0cPCIe\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u8282\u70b9\u200b\u91cc\u200b\u6709\u200b\u4e00\u4e2a\u200b\u66f4\u4e0b\u200b\u4e00\u7ea7\u200b\u7684\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u865a\u62df\u200b\u7684\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\uff1a</p> <pre><code>          pcie0: pcie@f8000000 {\n                #address-cells = &lt;3&gt;;\n                #interrupt-cells = &lt;1&gt;;\n\n                interrupt-map-mask = &lt;0 0 0 7&gt;;\n                interrupt-map = &lt;0 0 0 1 &amp;pcie0_intc 0&gt;,\n                                &lt;0 0 0 2 &amp;pcie0_intc 1&gt;,\n                                &lt;0 0 0 3 &amp;pcie0_intc 2&gt;,\n                                &lt;0 0 0 4 &amp;pcie0_intc 3&gt;;\n\n                pcie0_intc: interrupt-controller {\n                        interrupt-controller;\n                        #address-cells = &lt;0&gt;;\n                        #interrupt-cells = &lt;1&gt;;\n                };                    \n          };\n</code></pre> <p>\u200b\u5728\u200b\u4ee3\u7801\u200b\u91cc\u200b\uff0c\u200b\u5bf9\u4e8e\u200b<code>pcie0_intc</code>\u200b\u4f1a\u200b\u521b\u5efa\u200b\u51fa\u200b\u4e00\u4e2a\u200bIRQ domain\uff1a</p> <p></p> <p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u200b\u7684\u200b<code>interrupt-map</code>\u200b\u91cc\u9762\u200b\u5c31\u7528\u5230\u200b\u4e86\u200b\u8fd9\u4e2a\u200b\u5b50\u200b\u8282\u70b9\u200b\uff0c\u200b\u4e5f\u200b\u5c31\u662f\u200b\u7528\u5230\u200b\u4e86\u200b\u5bf9\u5e94\u200b\u7684\u200bIRQ domain\uff1a</p> <pre><code>                interrupt-map-mask = &lt;0 0 0 7&gt;;\n                interrupt-map = &lt;0 0 0 1 &amp;pcie0_intc 0&gt;,\n                                &lt;0 0 0 2 &amp;pcie0_intc 1&gt;,\n                                &lt;0 0 0 3 &amp;pcie0_intc 2&gt;,\n                                &lt;0 0 0 4 &amp;pcie0_intc 3&gt;;\n</code></pre>"},{"location":"10_PCI_PCIe/12_1/#532-pcie","title":"5.3.2 \u200b\u5f97\u5230\u200bPCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\u4e2d\u65ad\u200b\u53f7","text":"<p>\u200b\u4ece\u200bPCIe\u200b\u8bbe\u5907\u200b\u5f97\u5230\u200b\u7684\u200b\u786c\u4ef6\u200b\u4e2d\u65ad\u200b\u4fe1\u606f\u200b\uff0c\u200b\u5c06\u4f1a\u200b\u6620\u5c04\u200b\u5f97\u5230\u200bpcie0_intc\uff0c\u200b\u4ece\u200b\u5b83\u200b\u91cc\u9762\u200b\u5f97\u5230\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u3002</p> <p>\u200b\u8fd9\u4f1a\u200b\u6d89\u53ca\u200b<code>interrupt-map-mask</code>\u3001<code>interrupt-map</code>\uff0c\u200b\u6bd4\u8f83\u590d\u6742\u200b\uff0c\u200b\u5728\u200b\u89c6\u9891\u200b\u91cc\u200b\u8bb2\u89e3\u200b\u3002</p> <pre><code>pci_scan_single_device\n    pci_device_add\n        pcibios_add_device(struct pci_dev *dev)\n            dev-&gt;irq = of_irq_parse_and_map_pci(dev, 0, 0);\n\nof_irq_parse_and_map_pci\n    ret = of_irq_parse_pci(dev, &amp;oirq);\n                rc = pci_read_config_byte(pdev, PCI_INTERRUPT_PIN, &amp;pin);\n\n                out_irq-&gt;np = ppnode;\n                out_irq-&gt;args_count = 1;\n                out_irq-&gt;args[0] = pin;\n                laddr[0] = cpu_to_be32((pdev-&gt;bus-&gt;number &lt;&lt; 16) | (pdev-&gt;devfn &lt;&lt; 8));\n                laddr[1] = laddr[2] = cpu_to_be32(0);\n                rc = of_irq_parse_raw(laddr, out_irq);              \n\n    return irq_create_of_mapping(&amp;oirq);\n</code></pre>"},{"location":"10_PCI_PCIe/13_1/","title":"13_GICv3_LPI\u200b\u673a\u5236","text":""},{"location":"10_PCI_PCIe/13_1/#gicv3_lpi","title":"GICv3_LPI\u200b\u673a\u5236","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a\u200b\u8fd9\u200b\u51e0\u4e2a\u200bPDF\u200b\u6587\u6863\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u7684\u200b<code>IMX6ULL\\doc_pic\\08_Interrupt</code>\u200b\u91cc\u200b</p> <ul> <li>\u300aARM\u00ae Generic Interrupt Controller Architecture Specification Architecture version 2.0(IHI0048B_b_gic_architecture_specification_v2).pdf\u300b</li> <li>\u300aIHI0069G_gic_architecture_specification.pdf\u300b\u200b\u7b2c\u200b5\u200b\u7ae0\u200b</li> <li>\u300aGICv3_Software_Overview_Official_Release_B.pdf\u300b</li> <li>ARM GIC\uff08\u200b\u516d\u200b\uff09gicv3\u200b\u67b6\u6784\u200b-LPI</li> </ul>"},{"location":"10_PCI_PCIe/13_1/#1-gicv2","title":"1. GICv2","text":"<p>\u200b\u6846\u56fe\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p></p> <p>GIC V2\u200b\u6709\u200b3\u200b\u79cd\u200b\u4e2d\u65ad\u200b\uff1a</p> <p>\u2460 \u200b\u8f6f\u4ef6\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\uff08SGI\uff0cSoftware Generated Interrupt\uff09     \u200b\u8fd9\u200b\u662f\u200b\u7531\u200b\u8f6f\u4ef6\u200b\u901a\u8fc7\u200b\u5199\u5165\u200b\u4e13\u7528\u200b\u4ef2\u88c1\u200b\u5355\u5143\u200b\u7684\u200b\u5bc4\u5b58\u5668\u200b\u5373\u200b\u8f6f\u4ef6\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\u5bc4\u5b58\u5668\u200b\uff08ICDSGIR\uff09\u200b\u663e\u5f0f\u200b\u751f\u6210\u200b\u7684\u200b\u3002\u200b\u5b83\u200b\u6700\u200b\u5e38\u7528\u200b\u4e8e\u200bCPU\u200b\u6838\u200b\u95f4\u901a\u4fe1\u200b\u3002SGI\u200b\u65e2\u200b\u53ef\u4ee5\u200b\u53d1\u7ed9\u200b\u6240\u6709\u200b\u7684\u200b\u6838\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u53d1\u9001\u7ed9\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\u9009\u5b9a\u200b\u7684\u200b\u4e00\u7ec4\u200b\u6838\u5fc3\u200b\u3002\u200b\u4e2d\u65ad\u200b\u53f7\u200b0-15\u200b\u4fdd\u7559\u200b\u7528\u4e8e\u200bSGI\u200b\u7684\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u3002\u200b\u7528\u4e8e\u200b\u901a\u4fe1\u200b\u7684\u200b\u786e\u5207\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u7531\u200b\u8f6f\u4ef6\u200b\u51b3\u5b9a\u200b\u3002 </p> <p>\u2461 \u200b\u79c1\u6709\u200b\u5916\u8bbe\u200b\u4e2d\u65ad\u200b\uff08PPI\uff0cPrivate Peripheral Interrupt\uff09     \u200b\u8fd9\u200b\u662f\u200b\u7531\u200b\u5355\u4e2a\u200bCPU\u200b\u6838\u200b\u79c1\u6709\u200b\u7684\u200b\u5916\u8bbe\u200b\u751f\u6210\u200b\u7684\u200b\u3002PPI\u200b\u7684\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u4e3a\u200b16-31\u3002\u200b\u5b83\u4eec\u200b\u6807\u8bc6\u200bCPU\u200b\u6838\u200b\u79c1\u6709\u200b\u7684\u200b\u4e2d\u65ad\u200b\u6e90\u200b\uff0c\u200b\u5e76\u4e14\u200b\u72ec\u7acb\u200b\u4e8e\u200b\u53e6\u200b\u4e00\u4e2a\u200b\u5185\u6838\u200b\u4e0a\u200b\u7684\u200b\u76f8\u540c\u200b\u4e2d\u65ad\u200b\u6e90\u200b\uff0c\u200b\u6bd4\u5982\u200b\uff0c\u200b\u6bcf\u4e2a\u200b\u6838\u200b\u7684\u200b\u8ba1\u65f6\u5668\u200b\u3002</p> <p>\u2462 \u200b\u5171\u4eab\u200b\u5916\u8bbe\u200b\u4e2d\u65ad\u200b\uff08SPI\uff0cShared Peripheral Interrupt\uff09     \u200b\u8fd9\u200b\u662f\u200b\u7531\u200b\u5916\u8bbe\u200b\u751f\u6210\u200b\u7684\u200b\uff0c\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u53ef\u4ee5\u200b\u5c06\u200b\u5176\u200b\u8def\u7531\u200b\u5230\u200b\u591a\u4e2a\u200b\u6838\u200b\u3002\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u4e3a\u200b32-1020\u3002SPI\u200b\u7528\u4e8e\u200b\u4ece\u200b\u6574\u4e2a\u200b\u7cfb\u7edf\u200b\u53ef\u200b\u8bbf\u95ee\u200b\u7684\u200b\u5404\u79cd\u200b\u5916\u56f4\u8bbe\u5907\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\u4fe1\u53f7\u200b\u3002</p> <p>\u200b\u5728\u200bGICv2\u200b\u91cc\u200b\uff0c\u200b\u8bbe\u5907\u200b\u5411\u200b\u4e2d\u65ad\u200b\u63a7\u5236\u5668\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5fc5\u987b\u200b\u4f7f\u7528\u200b\u7269\u7406\u200b\u4e0a\u200b\u7684\u200b\u7ebf\u8def\u200b\uff1a</p> <p></p> <p>\u200b\u5728\u200b\u590d\u6742\u200b\u7cfb\u7edf\u200b\u4e2d\u6709\u200b\u6210\u767e\u4e0a\u5343\u200b\u7684\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u5c31\u200b\u9700\u8981\u200b\u6210\u767e\u4e0a\u5343\u200b\u7684\u200b\u4e2d\u65ad\u200b\u4fe1\u53f7\u7ebf\u200b\uff0c\u200b\u8fd9\u592a\u200b\u590d\u6742\u200b\u4e86\u200b\u3002</p> <p>\u200b\u4e8e\u662f\u200b\u5728\u200bGICv3\u200b\u4e2d\u200b\u5f15\u5165\u200bMSI(\"message-based interrupts\")\uff0c\u200b\u8bbe\u5907\u200b\u5f80\u200b\u67d0\u4e2a\u200b\u5730\u5740\u200b\u5199\u5165\u200b\u6570\u503c\u200b\uff0c\u200b\u5373\u53ef\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\u3002</p>"},{"location":"10_PCI_PCIe/13_1/#2-gicv3","title":"2. GICv3","text":""},{"location":"10_PCI_PCIe/13_1/#21-msi","title":"2.1 MSI","text":"<p>\u200b\u5728\u200bGICv3\u200b\u91cc\u200b\uff0c\u200b\u6dfb\u52a0\u200b\u4e86\u200bMSI(\"message-based interrupts\")\uff0c\u200b\u8bbe\u5907\u200b\u5f80\u200b\u67d0\u4e2a\u200b\u5730\u5740\u200b\u5199\u5165\u200b\u6570\u503c\u200b\uff0c\u200b\u5373\u53ef\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\uff1a</p> <p></p> <p>\u200b\u4f7f\u7528\u200b\u6d88\u606f\u200b\u6765\u200b\u53d1\u9001\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u597d\u5904\u200b\u662f\u200b\u53ef\u4ee5\u200b\u7701\u7565\u200b\u786c\u4ef6\u200b\u7ebf\u8def\u200b\u3002\u200b\u5728\u200b\u5927\u578b\u200b\u7cfb\u7edf\u200b\u4e2d\u6709\u200b\u6210\u767e\u4e0a\u5343\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u4f7f\u7528\u200bMSI\u200b\u53ef\u4ee5\u200b\u7701\u4e0b\u200b\u5f88\u591a\u200b\u7ebf\u8def\u200b\u3002</p>"},{"location":"10_PCI_PCIe/13_1/#22-gicv3","title":"2.2 GICv3\u200b\u5185\u90e8\u7ed3\u6784","text":"<p>GIC V3\u200b\u91cc\u200b\u65b0\u200b\u589e\u52a0\u200b\u4e86\u200b\u4e00\u7c7b\u200b\u4e2d\u65ad\u200b\uff1aLPI(Locality-specific Peripheral Interrupts)</p> <p>\u200b\u6846\u56fe\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u5bf9\u4e8e\u200b\u539f\u6765\u200b\u7684\u200bSPI\uff0c\u200b\u5b83\u200b\u4e5f\u200b\u662f\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200bMSI\u200b\u7684\u200b\u65b9\u5f0f\u200b\u4f20\u9012\u200b\u7684\u200b\uff0c\u200b\u8fd9\u4e2a\u200b\u529f\u80fd\u200b\u662f\u200b\u53ef\u9009\u200b\u7684\u200b\u3002\u200b\u5982\u679c\u200bGICv3\u200b\u652f\u6301\u200bMSI\u200b\u65b9\u5f0f\u200b\u7684\u200bSPI\uff0c\u200b\u8981\u200b\u4ea7\u751f\u200b/\u200b\u6e05\u9664\u200b\u4e2d\u65ad\u200b\u65f6\u200b\uff0c\u200b\u64cd\u4f5c\u200b\u5982\u4e0b\u200bGIC\u200b\u5bc4\u5b58\u5668\u200b\uff1a</p> <ul> <li>\u200b\u4ea7\u751f\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u5199\u200b\u5bc4\u5b58\u5668\u200bGICD_SETSPI_NSR \u200b\u6216\u200b GICD_SETSPI_SR  </li> <li>\u200b\u6e05\u9664\u200b\u4e2d\u65ad\u200b\uff1a\u200b\u5199\u200b\u5bc4\u5b58\u5668\u200bGICD_CLRSPI_NSR \u200b\u6216\u200b GICD_CLRSPI_SR  </li> </ul> <p>\u200b\u5bf9\u4e8e\u200bLPI\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u6709\u200b\u4e24\u79cd\u200b\u89e6\u53d1\u200b\u65b9\u5f0f\u200b\uff1a</p> <ul> <li>\u200b\u5199\u200b\u5bc4\u5b58\u5668\u200bGITS_TRANSLATER</li> <li>\u200b\u8bbe\u5907\u200b\u628a\u200b\u6570\u636e\u200b\u5199\u5165\u200bGITS_TRANSLATER\u200b\u5bc4\u5b58\u5668\u200b\uff0c\u200b\u5199\u5165\u200b\u7684\u200b\u503c\u200b\u88ab\u200b\u79f0\u4e3a\u200bEventID</li> <li>\u200b\u5199\u200b\u5bc4\u5b58\u5668\u200bGICR_SETLPIR</li> </ul>"},{"location":"10_PCI_PCIe/13_1/#23","title":"2.3 \u200b\u4e2d\u65ad\u200b\u53f7","text":"<p>0~1023\u200b\u8ddf\u200bGICv2\u200b\u4fdd\u5b58\u200b\u4e00\u81f4\u200b\u3002</p> INTID \u200b\u4e2d\u65ad\u200b\u7c7b\u578b\u200b \u200b\u63cf\u8ff0\u200b 0~15 SGI 16~31 PPI 32~1019 SPI \u200b\u8bbe\u5907\u200b\u53d1\u51fa\u200b\u7684\u200b\u4e2d\u65ad\u200b 1020~1023 SPI \u200b\u7528\u4e8e\u200b\u7279\u6b8a\u200b\u76ee\u7684\u200b 1024~1055 - \u200b\u4fdd\u7559\u200b 1056~1119 PPI \u200b\u6269\u5c55\u200b\u7684\u200bPPI\uff0cGICv3.1\u200b\u624d\u200b\u652f\u6301\u200b 1120~4095 - \u200b\u4fdd\u7559\u200b 4096~5119 SPI \u200b\u6269\u5c55\u200b\u7684\u200bSPI\uff0cGICv3.1\u200b\u624d\u200b\u652f\u6301\u200b 5120~8191 - \u200b\u4fdd\u7559\u200b 8192~\u200b\u82af\u7247\u200b\u5b9e\u73b0\u200b LPI"},{"location":"10_PCI_PCIe/13_1/#3-lpi","title":"3. LPI\u200b\u7684\u200b\u89e6\u53d1\u200b\u65b9\u5f0f","text":"<p>LPI\u200b\u6709\u200b\u4e24\u79cd\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\u7684\u200b\u65b9\u5f0f\u200b\uff1a</p> <ul> <li>\u200b\u628a\u200bINTID\u200b\u76f4\u63a5\u200b\u5199\u5165\u200bGICR_SETLPIR\u200b\u5bc4\u5b58\u5668\u200b</li> <li>\u200b\u4f7f\u7528\u200bITS\u200b\u628a\u200bEventID \u200b\u8f6c\u6362\u200b\u4e3a\u200bLPI INTID\uff0c\u200b\u4f1a\u200b\u7528\u5230\u200b\"GITS_TRANSLATER\"\u200b\u5bc4\u5b58\u5668\u200b</li> </ul> <p>\u200b\u8fd9\u200b\u4e24\u79cd\u200b\u65b9\u6cd5\u200b\u53ea\u80fd\u200b\u652f\u6301\u200b\u4e00\u79cd\u200b\u3002</p>"},{"location":"10_PCI_PCIe/13_1/#31-gicr_setlpir","title":"3.1 \u200b\u4f7f\u7528\u200bGICR_SETLPIR","text":"<p>\u200b\u8fd9\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u628a\u200bLPI\u200b\u7684\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u5199\u5165\u200b\u8fd9\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\u5373\u53ef\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\u3002</p>"},{"location":"10_PCI_PCIe/13_1/#32-its","title":"3.2 \u200b\u4f7f\u7528\u200bITS","text":"<p>ITS\u200b\u7684\u200b\u610f\u601d\u200b\u662f\u200b\uff1aInterrupt Translation Service\uff0c\u200b\u4e2d\u65ad\u200b\u8f6c\u6362\u200b\u670d\u52a1\u200b\u3002</p> <p></p> <p>\u200b\u80fd\u200b\u4ea7\u751f\u200bMSI\u200b\u4e2d\u65ad\u200b\u7684\u200b\u8bbe\u5907\u200b\uff0c\u200b\u90fd\u200b\u6709\u200b\u4e00\u4e2a\u200bDeviceDI(\u200b\u8bbe\u5907\u200bID)\uff0c\u200b\u5b83\u200b\u4ea7\u751f\u200b\u7684\u200b\u6bcf\u200b\u4e00\u4e2a\u200bMSI\u200b\u4e2d\u65ad\u200b\u90fd\u200b\u6709\u200b\u4e00\u4e2a\u200bEventID(\u200b\u4e8b\u4ef6\u200bID)\u3002\"DeviceID+EventID\"\u200b\u7ec4\u5408\u200b\u88ab\u200b\u4f20\u5165\u200bITS\uff0cIDS\u200b\u4f1a\u200b\u628a\u200b\u5b83\u4eec\u200b\u8f6c\u6362\u200b\u4e3a\u200bINTID\u3002</p> <p>\u200b\u8fc7\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u5916\u8bbe\u200b\u53d1\u751f\u200b\u4e2d\u65ad\u200b\u6d88\u606f\u200b(Interrupt Message)\u200b\u5230\u200bITS</li> <li>\u200b\u5916\u8bbe\u200b\u53ea\u8981\u200b\u5199\u200bGITS_TRANSLATER\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u53d1\u9001\u200b\u6d88\u606f\u200b\uff0c\u200b\u8fd9\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a     </li> <li>\u200b\u6d88\u606f\u200b\u91cc\u200b\u5305\u542b\u200b\u6709\u200b\uff1aDeviceID(\u200b\u54ea\u200b\u4e00\u4e2a\u200b\u8bbe\u5907\u200b)\u3001EventID(\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u7684\u200b\u54ea\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b)</li> <li>ITS\u200b\u4f7f\u7528\u200bDeviceID\u200b\u5728\u200bDevice Table\u200b\u4e2d\u200b\u627e\u5230\u200b\u4e00\u9879\u200b</li> <li>\u200b\u53ea\u6709\u200b\u4e00\u4e2a\u200bDevice Table</li> <li>\u200b\u6bcf\u200b\u4e00\u4e2a\u200b\u80fd\u200b\u53d1\u751f\u200bMSI\u200b\u4e2d\u65ad\u200b\u7684\u200b\u8bbe\u5907\u200b\u5728\u200b\u91cc\u9762\u200b\u90fd\u200b\u6709\u200b\u4e00\u9879\u200b\uff0c\u200b\u5b83\u200b\u6307\u5411\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u7684\u200bInterrupt Translation Table(\u200b\u4e2d\u65ad\u200b\u8f6c\u6362\u200b\u8868\u200b\uff0c\u200b\u7b80\u79f0\u200bITT)</li> <li>\u200b\u6bcf\u200b\u4e00\u4e2a\u200b\u80fd\u200b\u53d1\u751f\u200bMSI\u200b\u4e2d\u65ad\u200b\u7684\u200b\u8bbe\u5907\u200b\uff0c\u200b\u90fd\u200b\u6709\u200b\u4e00\u4e2a\u200bITT</li> <li>ITS\u200b\u4f7f\u7528\u200bEventID\u200b\u5728\u200bITT\u200b\u4e2d\u200b\u627e\u5230\u200b\u4e00\u9879\u200b\uff0c\u200b\u4ece\u4e2d\u200b\u8fd4\u56de\u200bINTID\u200b\u548c\u200bCollection ID</li> <li>ITS\u200b\u4f7f\u7528\u200bCollection ID\u200b\u5728\u200bCollection Table\u200b\u4e2d\u200b\u627e\u5230\u200b\u4e00\u9879\u200b\uff0c\u200b\u4ece\u4e2d\u200b\u8fd4\u56de\u200b\"Target Redistributor\"\uff0c\u200b\u5373\u200b\uff1a\u200b\u4e2d\u65ad\u200b\u53d1\u7ed9\u200b\u54ea\u4e2a\u200bCPU</li> <li>ITS\u200b\u628a\u200bINTID\u200b\u53d1\u7ed9\u200bRedistributor</li> </ul> <p></p> <p></p> <p>\u200b\u4e0a\u56fe\u200b\u4e2d\u200bDevice Table\u3001Interrupt Translation Table\u3001Collection Table\u200b\u90fd\u200b\u662f\u200b\u5728\u200b\u5185\u5b58\u200b\u91cc\u200b\uff0c\u200b\u4f46\u662f\u200b\u6211\u4eec\u200b\u4e0d\u80fd\u200b\u76f4\u63a5\u200b\u53bb\u200b\u8bbe\u7f6e\u200b\u5185\u5b58\u200b\u3002\u200b\u800c\u662f\u200b\u901a\u8fc7\u200b\u53d1\u9001\u200bITS\u200b\u547d\u4ee4\u200b\u6765\u200b\u8bbe\u7f6e\u200b\u8fd9\u4e9b\u200b\u8868\u683c\u200b\u3002</p> <p>\u200b\u6211\u4eec\u200b\u4e0d\u200b\u7814\u7a76\u200bITS\u200b\u7684\u200b\u5185\u90e8\u200b\u7ec6\u8282\u200b\uff0c\u200b\u6682\u4e14\u200b\u4e86\u89e3\u200b\u8fd9\u4e9b\u200b\u5185\u5bb9\u200b\u5373\u53ef\u200b\u3002</p>"},{"location":"10_PCI_PCIe/14_1/","title":"14_MSI_MSI-X\u200b\u4e2d\u65ad\u200b\u4e4b\u200b\u4f53\u9a8c\u200b\u4e0e\u200b\u4f7f\u7528","text":""},{"location":"10_PCI_PCIe/14_1/#msi_msi-x","title":"MSI_MSI-X\u200b\u4e2d\u65ad\u200b\u4e4b\u200b\u4f53\u9a8c\u200b\u4e0e\u200b\u4f7f\u7528","text":"<p>\u200b\u5f00\u53d1\u677f\u200b\u8d44\u6599\u200b\uff1a</p> <ul> <li>https://wiki.t-firefly.com/zh_CN/ROC-RK3399-PC-PLUS/</li> </ul> <p>\u200b\u53c2\u8003\u200b\u5185\u6838\u200b\u6587\u4ef6\u200b\uff1a</p> <ul> <li><code>Documentation\\PCI\\MSI-HOWTO.txt</code></li> <li><code>drivers\\pci\\host\\pcie-rockchip.c</code></li> <li><code>drivers\\nvme\\host\\pci.c</code></li> <li><code>drivers\\irqchip\\irq-gic-v3.c</code></li> <li><code>drivers\\irqchip\\irq-gic-v3-its.c</code></li> <li><code>drivers\\irqchip\\irq-gic-v3-its-pci-msi.c</code></li> </ul>"},{"location":"10_PCI_PCIe/14_1/#1-msimsi-x","title":"1. \u200b\u600e\u4e48\u200b\u53d1\u51fa\u200bMSI/MSI-X\u200b\u4e2d\u65ad","text":"<p>PCIe\u200b\u8bbe\u5907\u200b\u5411\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5b83\u200b\u53d1\u51fa\u200bTLP\u200b\u5305\u200b\uff0c\u200b\u5f80\u200b\u67d0\u4e2a\u200b\u5730\u5740\u200b\u5199\u5165\u200b\u67d0\u4e2a\u200b\u6570\u636e\u200b\u5373\u53ef\u200b\uff1a</p> <ul> <li>\u200b\u5f80\u200b\u54ea\u4e2a\u200b\u5730\u5740\u200b\uff1fGICv3 ITS\u200b\u7684\u200bGITS_TRANSLATER\u200b\u5bc4\u5b58\u5668\u200b\uff0cTLP\u200b\u5305\u200b\u91cc\u200b\u4f7f\u7528\u200b\u7684\u200b\u662f\u200bPCI\u200b\u5730\u5740\u200b</li> <li>\u200b\u5199\u200b\u4ec0\u4e48\u200b\u6570\u636e\u200b\uff1f0\u30011\u30012\u3001\u2026\u2026\uff0c\u200b\u8981\u200b\u53d1\u51fa\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\u65f6\u5199\u200b0\uff0c\u200b\u8981\u200b\u53d1\u51fa\u200b\u7b2c\u200b2\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\u65f6\u5199\u200b1\uff0c\u2026\u2026</li> </ul> <p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200brk3399.dtsi\u200b\u4e2d\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200bITS\u200b\u7684\u200b\u57fa\u200b\u5730\u5740\u200b\u662f\u200b0xfee20000\uff1a</p> <pre><code>its: interrupt-controller@fee20000 {\n                        compatible = \"arm,gic-v3-its\";\n                        msi-controller;\n                        reg = &lt;0x0 0xfee20000 0x0 0x20000&gt;;\n                };\n</code></pre> <p>\u200b\u5728\u200b<code>IHI0069G_gic_architecture_specification.pdf</code>\u200b\u4e2d\u6709\u200bITS\u200b\u5bc4\u5b58\u5668\u200b\u7684\u200b\u504f\u79fb\u200b\u5730\u5740\u200b\uff1a</p> <p></p> <p>GITS_TRANSLATER\u200b\u5bc4\u5b58\u5668\u200b\u7684\u200bCPU\u200b\u5730\u5740\u200b\u662f\u200b\uff1a0xfee20000 + 0x010000 + 0x0040 = 0xfee30040\u3002</p> <p>\u200b\u5bf9\u5e94\u200b\u7684\u200bPCI\u200b\u5730\u5740\u200b\u4e5f\u200b\u662f\u200b0xfee30040(\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u91cc\u200b\u4e3a\u4f8b\u200b\u65b9\u4fbf\u200b\uff0c\u200b\u6545\u610f\u200b\u4f7f\u5f97\u200bCPU\u200b\u5730\u5740\u200b\u8ddf\u200bPCI\u200b\u5730\u5740\u200b\u76f8\u540c\u200b\uff0c\u200b\u8fd9\u200b2\u200b\u4e2a\u200b\u5730\u5740\u200b\u5c5e\u4e8e\u200b\u4e0d\u540c\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b)\uff0c</p> <p>\u200b\u6240\u4ee5\u200b\u4e0b\u56fe\u200b\u4e2d\u200bPCI\u200b\u5730\u5740\u200b\u90fd\u200b\u662f\u200b0xfee30040\u3002</p> <p></p>"},{"location":"10_PCI_PCIe/14_1/#11-rk3399","title":"1.1 \u200b\u5728\u200bRK3399\u200b\u4e0a\u200b\u4f53\u9a8c","text":"<p>\u200b\u6211\u4eec\u200b\u4f7f\u7528\u200bRK3399\u200b\u5f00\u53d1\u677f\u200b\uff0c\u200b\u63d2\u4e0a\u200b\u4e86\u200b**NVMe** SSD\u200b\u56fa\u6001\u200b\u786c\u76d8\u200b\u3002</p> <p></p>"},{"location":"10_PCI_PCIe/14_1/#111","title":"1.1.1 \u200b\u5b89\u88c5\u200b\u5de5\u5177","text":"<p>\u200b\u8bf7\u200b\u7ed9\u200bRK3399\u200b\u5237\u5165\u200bUbuntu\u200b\u6620\u50cf\u200b\u6587\u4ef6\u200b\uff0c\u200b\u7136\u540e\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>udhcpc  # \u200b\u83b7\u53d6\u200bIP\napt update  # \u200b\u66f4\u65b0\u200b\u6e90\u200b\napt install pciutils  # \u200b\u5b89\u88c5\u200blspci\u200b\u5de5\u5177\u200b\napt install devmem2   # \u200b\u5b89\u88c5\u200bdevmem2\u200b\u5de5\u5177\u200b\n</code></pre>"},{"location":"10_PCI_PCIe/14_1/#112-msi-x","title":"1.1.2 \u200b\u67e5\u770b\u200b\u8bbe\u5907\u200bMSI-X\u200b\u4fe1\u606f","text":"<p>\u200b\u6267\u884c\u200b<code>lspci -vvv</code>\uff0c\u200b\u5f97\u5230\u200b\u5982\u4e0b\u200b\u4fe1\u606f\u200b\uff1a</p> <pre><code>01:00.0 Non-Volatile memory controller: Silicon Motion, Inc. Device 2263 (rev 03) (prog-if 02 [NVM Express])\n        Subsystem: Silicon Motion, Inc. Device 2263\n        Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx+\n        Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-\n        Latency: 0\n        Interrupt: pin A routed to IRQ 231\n        Region 0: Memory at fa000000 (64-bit, non-prefetchable) [size=16K]\n        Capabilities: [40] Power Management version 3\n                Flags: PMEClk- DSI- D1- D2- AuxCurrent=0mA PME(D0-,D1-,D2-,D3hot-,D3cold-)\n                Status: D0 NoSoftRst+ PME-Enable- DSel=0 DScale=0 PME-\n        Capabilities: [50] MSI: Enable- Count=1/8 Maskable+ 64bit+\n                Address: 0000000000000000  Data: 0000\n                Masking: 00000000  Pending: 00000000\n        Capabilities: [70] Express (v2) Endpoint, MSI 00\n                DevCap: MaxPayload 128 bytes, PhantFunc 0, Latency L0s unlimited, L1 unlimited\n                        ExtTag- AttnBtn- AttnInd- PwrInd- RBE+ FLReset+ SlotPowerLimit 0.000W\n                DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported-\n                        RlxdOrd+ ExtTag- PhantFunc- AuxPwr- NoSnoop- FLReset-\n                        MaxPayload 128 bytes, MaxReadReq 512 bytes\n                DevSta: CorrErr- UncorrErr- FatalErr- UnsuppReq- AuxPwr+ TransPend-\n                LnkCap: Port #0, Speed 8GT/s, Width x4, ASPM L1, Exit Latency L0s &lt;1us, L1 &lt;8us\n                        ClockPM+ Surprise- LLActRep- BwNot- ASPMOptComp+\n                LnkCtl: ASPM Disabled; RCB 64 bytes Disabled- CommClk-\n                        ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt-\n                LnkSta: Speed 2.5GT/s, Width x4, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt-\n                DevCap2: Completion Timeout: Range ABCD, TimeoutDis+, LTR+, OBFF Not Supported\n                DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis-, LTR-, OBFF Disabled\n                LnkCtl2: Target Link Speed: 8GT/s, EnterCompliance- SpeedDis-\n                         Transmit Margin: Normal Operating Range, EnterModifiedCompliance- ComplianceSOS-\n                         Compliance De-emphasis: -6dB\n                LnkSta2: Current De-emphasis Level: -3.5dB, EqualizationComplete-, EqualizationPhase1-\n                         EqualizationPhase2-, EqualizationPhase3-, LinkEqualizationRequest-\n        Capabilities: [b0] MSI-X: Enable+ Count=16 Masked-\n                Vector table: BAR=0 offset=00002000\n                PBA: BAR=0 offset=00002100\n        Capabilities: [100 v2] Advanced Error Reporting\n                UESta:  DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol-\n                UEMsk:  DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol-\n                UESvrt: DLP+ SDES+ TLP- FCP+ CmpltTO- CmpltAbrt- UnxCmplt- RxOF+ MalfTLP+ ECRC- UnsupReq- ACSViol-\n                CESta:  RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr-\n                CEMsk:  RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+\n                AERCap: First Error Pointer: 00, GenCap+ CGenEn- ChkCap+ ChkEn-\n        Capabilities: [158 v1] #19\n        Capabilities: [178 v1] Latency Tolerance Reporting\n                Max snoop latency: 0ns\n                Max no snoop latency: 0ns\n        Capabilities: [180 v1] L1 PM Substates\n                L1SubCap: PCI-PM_L1.2+ PCI-PM_L1.1+ ASPM_L1.2+ ASPM_L1.1+ L1_PM_Substates+\n                          PortCommonModeRestoreTime=10us PortTPowerOnTime=10us\n                L1SubCtl1: PCI-PM_L1.2- PCI-PM_L1.1- ASPM_L1.2- ASPM_L1.1-\n                           T_CommonMode=0us LTR1.2_Threshold=0ns\n                L1SubCtl2: T_PwrOn=10us\n        Kernel driver in use: nvme\n</code></pre> <p>\u200b\u4ece\u200b\u4e0a\u8ff0\u200b\u4fe1\u606f\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200b\uff1a</p> <pre><code>        Region 0: Memory at fa000000 (64-bit, non-prefetchable) [size=16K]\n        Capabilities: [b0] MSI-X: Enable+ Count=16 Masked-\n                Vector table: BAR=0 offset=00002000\n                PBA: BAR=0 offset=00002100\n</code></pre> <p>\u200b\u8fd9\u200b\u8868\u793a\u200b\uff1a</p> <ul> <li>MSI-X: Enable+\uff1a\u200b\u4f7f\u7528\u200bMSI-X\u200b\u529f\u80fd\u200b</li> <li>Vector table: BAR=0 offset=00002000\uff1aMSI\u200b\u7684\u200b\u5411\u91cf\u200b\u5728\u200bBAR 0\u200b\u504f\u79fb\u200b\u5730\u5740\u200b0x00002000\u200b\u5904\u200b</li> <li>Region 0: Memory at fa000000\uff1a</li> <li>BAR 0\u200b\u7684\u200bPCI\u200b\u5730\u5740\u200b\u662f\u200b0xfa000000\uff0c</li> <li>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u91cc\u200b\u4e3a\u4e86\u200b\u65b9\u4fbf\u200b\u4ee4\u200bCPU\u200b\u5730\u5740\u200b\u7b49\u4e8e\u200bPCI\u200b\u5730\u5740\u200b\uff0c\u200b\u6240\u4ee5\u200bBAR\u200b\u7684\u200bCPU\u200b\u5730\u5740\u200b\u4e5f\u200b\u662f\u200b0xfa000000\u3002</li> </ul> <p>\u200b\u6211\u4eec\u200b\u53ef\u4ee5\u200b\u53bb\u200b\u8bfb\u53d6\u200b <code>0xfa000000 + 0x00002000</code>\u200b\u5f00\u59cb\u200b\u7684\u200b\u5411\u91cf\u200b\u8868\u200b\uff0c\u200b\u9a8c\u8bc1\u200b\u91cc\u200b\uff1a</p> <ul> <li>msg addr\u200b\u4e3a\u200b0xfee30040</li> <li>msg data\u200b\u4e3a\u200b0\u30011\u3001\u2026\u2026</li> </ul> <p></p>"},{"location":"10_PCI_PCIe/14_1/#113-msi-x","title":"1.1.3 \u200b\u9a8c\u8bc1\u200bMSI-X\u200b\u4fe1\u606f","text":""},{"location":"10_PCI_PCIe/14_1/#2-msimsi-x","title":"2. \u200b\u600e\u4e48\u200b\u4f7f\u7528\u200bMSI/MSI-X","text":"<p>\u200b\u53c2\u8003\u200b\u5185\u6838\u200b\u6587\u6863\u200b\uff1a<code>Documentation\\PCI\\MSI-HOWTO.txt</code>\u3001<code>drivers\\nvme\\host\\pci.c</code></p> <p>\u200b\u4e3b\u8981\u200b\u51fd\u6570\u200b\u662f\u200b\u8fd9\u200b2\u200b\u4e2a\u200b:</p> <pre><code>int pci_enable_msix_range(struct pci_dev *dev, struct msix_entry *entries,\n              int minvec, int maxvec);\nint pci_enable_msi_range(struct pci_dev *dev, int minvec, int maxvec);\n</code></pre> <p>\u200b\u793a\u4f8b\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>    // \u200b\u5206\u914d\u200b msix_entry \u200b\u6570\u7ec4\u200b\uff0c\u200b\u6bcf\u4e00\u200b\u6570\u7ec4\u200b\u9879\u200b\u7528\u6765\u200b\u4fdd\u5b58\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\u7684\u200b\u4fe1\u606f\u200b\n    dev-&gt;entry = kzalloc_node(num_possible_cpus() * sizeof(*dev-&gt;entry),\n                            GFP_KERNEL, node);\n\n    // \u200b\u5148\u200b\u5c1d\u8bd5\u200b\u4f7f\u7528\u200bMSI-X\n    vecs = pci_enable_msix_range(pdev, dev-&gt;entry, 1, nr_io_queues);\n    if (vecs &lt; 0) {\n        // \u200b\u518d\u200b\u5c1d\u8bd5\u200b\u4f7f\u7528\u200bMSI\n        vecs = pci_enable_msi_range(pdev, 1, min(nr_io_queues, 32));\n        if (vecs &lt; 0) {\n            vecs = 1;\n        } else {\n            for (i = 0; i &lt; vecs; i++)\n                dev-&gt;entry[i].vector = i + pdev-&gt;irq;\n        }\n    }\n\n    // request_irq: \u200b\u4e2d\u65ad\u200b\u53f7\u200b\u90fd\u200b\u4fdd\u5b58\u200b\u5728\u200bdev-&gt;entry[i].vector\u200b\u91cc\u200b\n    for (i = 0; i &lt; vecs; i++)\n        request_irq(dev-&gt;entry[i].vector, ...);\n</code></pre> <p>\u200b\u6ce8\u610f\u200b\uff0c\u200b\u5728\u200b<code>pci_enable_msix_range</code>\u200b\u6216\u8005\u200b<code>pci_enable_msi_range</code>\u200b\u51fd\u6570\u200b\u4e2d\u200b\uff1a</p> <ul> <li>minvec\u200b\u4ece\u200b1\u200b\u5f00\u59cb\u200b</li> <li>\u200b\u5bf9\u4e8e\u200bpci_enable_msix_range\uff0c\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u4fdd\u5b58\u200b\u5728\u200bentries[i].vector\u200b\u91cc\u200b</li> <li>\u200b\u5bf9\u4e8e\u200bpci_enable_msi_range\uff0c\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u4fdd\u5b58\u200b\u5728\u200bpdev-&gt;irq\u200b\u91cc\u200b</li> </ul>"},{"location":"10_PCI_PCIe/14_1/#3-msimsi-x","title":"3. MSI/MSI-X\u200b\u4e2d\u65ad\u200b\u6e90\u7801\u200b\u5206\u6790","text":""},{"location":"10_PCI_PCIe/14_1/#31-irq-domain","title":"3.1 IRQ Domain\u200b\u521b\u5efa\u200b\u6d41\u7a0b","text":"<p>\u200b\u4ece\u200bPCI\u200b\u8bbe\u5907\u200b\u89e6\u53d1\u200b\uff0c\u200b\u6d89\u53ca\u200b\u4e09\u4e2a\u200bIRQ Domain\uff1a</p> <ul> <li><code>drivers\\irqchip\\irq-gic-v3-its-pci-msi.c</code></li> <li><code>drivers\\irqchip\\irq-gic-v3-its.c</code></li> <li><code>drivers\\irqchip\\irq-gic-v3.c</code></li> </ul>"},{"location":"10_PCI_PCIe/14_1/#311-gic","title":"3.1.1 GIC","text":"<p>\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a</p> <pre><code>        gic: interrupt-controller@fee00000 {\n                compatible = \"arm,gic-v3\";\n                #interrupt-cells = &lt;4&gt;;\n                #address-cells = &lt;2&gt;;\n                #size-cells = &lt;2&gt;;\n                ranges;\n                interrupt-controller;\n\n                reg = &lt;0x0 0xfee00000 0 0x10000&gt;, /* GICD */\n                      &lt;0x0 0xfef00000 0 0xc0000&gt;, /* GICR */\n                      &lt;0x0 0xfff00000 0 0x10000&gt;, /* GICC */\n                      &lt;0x0 0xfff10000 0 0x10000&gt;, /* GICH */\n                      &lt;0x0 0xfff20000 0 0x10000&gt;; /* GICV */\n                interrupts = &lt;GIC_PPI 9 IRQ_TYPE_LEVEL_HIGH 0&gt;;\n                its: interrupt-controller@fee20000 {\n                        compatible = \"arm,gic-v3-its\";\n                        msi-controller;\n                        reg = &lt;0x0 0xfee20000 0x0 0x20000&gt;;\n                };\n</code></pre> <p>\u200b\u9a71\u52a8\u200b\u4ee3\u7801\u200b\uff1a<code>drivers\\irqchip\\irq-gic-v3.c</code></p> <p></p>"},{"location":"10_PCI_PCIe/14_1/#312-its","title":"3.1.2 ITS","text":"<p>\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a</p> <pre><code>its: interrupt-controller@fee20000 {\n                        compatible = \"arm,gic-v3-its\";\n                        msi-controller;\n                        reg = &lt;0x0 0xfee20000 0x0 0x20000&gt;;\n                };\n</code></pre> <p>\u200b\u9a71\u52a8\u200b\u4ee3\u7801\u200b\uff1a<code>drivers\\irqchip\\irq-gic-v3-its.c</code></p> <p></p>"},{"location":"10_PCI_PCIe/14_1/#313-pci-msi","title":"3.1.3 PCI MSI","text":"<p>\u200b\u5bf9\u5e94\u200b\u7684\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u8ddf\u200bITS\u200b\u9a71\u52a8\u200b\u4f7f\u7528\u200b\u7684\u200b\u4e00\u6837\u200b\u7684\u200b\uff1a</p> <pre><code>its: interrupt-controller@fee20000 {\n                        compatible = \"arm,gic-v3-its\";\n                        msi-controller;\n                        reg = &lt;0x0 0xfee20000 0x0 0x20000&gt;;\n                };\n</code></pre> <p>\u200b\u9a71\u52a8\u200b\u4ee3\u7801\u200b\uff1a<code>drivers\\irqchip\\irq-gic-v3-its-pci-msi.c</code>\uff0c\u200b\u5b83\u200b\u53ea\u662f\u200b\u5728\u200bITS\u200b\u4e0b\u9762\u200b\u518d\u200b\u589e\u52a0\u200b\u4e86\u200b\u4e00\u4e2a\u200b\u5904\u7406\u200b\u5c42\u200b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/14_1/#314-pcie","title":"3.1.4 PCIe\u200b\u63a7\u5236\u5668","text":"<p>\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a</p> <pre><code>        pcie0: pcie@f8000000 {\n                compatible = \"rockchip,rk3399-pcie\";\n                #address-cells = &lt;3&gt;;\n                #size-cells = &lt;2&gt;;\n                aspm-no-l0s;\n                clocks = &lt;&amp;cru ACLK_PCIE&gt;, &lt;&amp;cru ACLK_PERF_PCIE&gt;,\n                         &lt;&amp;cru PCLK_PCIE&gt;, &lt;&amp;cru SCLK_PCIE_PM&gt;;\n                clock-names = \"aclk\", \"aclk-perf\",\n                              \"hclk\", \"pm\";\n                bus-range = &lt;0x0 0x1f&gt;;\n                max-link-speed = &lt;1&gt;;\n                linux,pci-domain = &lt;0&gt;;\n                msi-map = &lt;0x0 &amp;its 0x0 0x1000&gt;;\n</code></pre> <p>\u200b\u91cc\u9762\u200b\u7684\u200b<code>msi-map = &lt;0x0 &amp;its 0x0 0x1000&gt;;</code>\u200b\u662f\u200b\u7528\u6765\u200b\u628a\u200bPCIe\u200b\u8bbe\u5907\u200b\u6620\u5c04\u200b\u5230\u200bMSI\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u683c\u5f0f\u200b\u4e3a\u200b\uff1a</p> <pre><code>msi-map = &lt;rid-base &amp;msi-controller msi-base length&gt;;\n</code></pre> <ul> <li>rid-base\uff1a\u200b\u7b2c\u200b1\u200b\u4e2a\u200bRequest ID\uff0c\u200b\u5c31\u662f\u200b\u4f7f\u7528\u200b\u7ec4\u6210\u200b\u7684\u200b\u4e00\u4e2a\u200b\u6570\u5b57\u200b</li> <li>msi-controller\uff1a\u200b\u8fd9\u4e2a\u200bPCIe\u200b\u8bbe\u5907\u200b\u6620\u5c04\u200b\u5230\u200b\u54ea\u4e2a\u200bMSI\u200b\u63a7\u5236\u5668\u200b\uff1f</li> <li>msi-base\uff1a\u200b\u7b2c\u200b1\u200b\u4e2a\u200bPCIe\u200b\u8bbe\u5907\u200b\u6620\u5c04\u200b\u5230\u200bMSI\u200b\u63a7\u5236\u5668\u200b\u54ea\u4e2a\u200b\u4e2d\u65ad\u200b\uff1f</li> <li>length\uff1a\u200b\u80fd\u200b\u6620\u5c04\u200b\u591a\u5c11\u200b\u4e2a\u200b\u8bbe\u5907\u200b</li> </ul>"},{"location":"10_PCI_PCIe/14_1/#32","title":"3.2 \u200b\u5206\u914d\u200b\u4e2d\u65ad","text":"<p>\u200b\u4ee3\u7801\u200b\uff1a<code>drivers\\nvme\\host\\pci.c</code></p> <pre><code>nvme_probe &gt; nvme_probe_work &gt; nvme_setup_io_queues \n        pci_enable_msix_range\n            pci_enable_msix(dev, entries, nvec);\n                msix_capability_init(dev, entries, nvec);\n\n        pci_enable_msi_range\n                msi_capability_init(dev, nvec);\n\nmsix_capability_init/msi_capability_init\n    pci_msi_setup_msi_irqs\n        pci_msi_domain_alloc_irqs\n            msi_domain_alloc_irqs\n                ret = ops-&gt;msi_prepare(domain, dev, nvec, &amp;arg); // its_pci_msi_prepare\n                    its_pci_msi_prepare // irq-gic-v3-its-pci-msi.c\n                        // rid = (bus &lt;&lt; 8) | (dev &lt;&lt; 4) | function\n                        info-&gt;scratchpad[0].ul = pci_msi_domain_get_msi_rid(domain, pdev);  \n                        return msi_info-&gt;ops-&gt;msi_prepare(...) // \u200b\u4e0a\u200b\u4e00\u5c42\u200birq-gic-v3-its.c\n                                its_msi_prepare\n                                    dev_id = info-&gt;scratchpad[0].ul;  // rid\n                                    its_dev = its_create_device(its, dev_id, nvec);\n                                                // \u200b\u4ece\u200bITS\u200b\u5168\u5c40\u200b\u7684\u200b\u4f4d\u200b\u56fe\u91cc\u200b\u627e\u5230\u200b\u7a7a\u95f2\u200b\u4f4d\u200b chunk\n                                                // \u200b\u4e00\u4e2a\u200bchunk\u200b\u8868\u793a\u200b32\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\n                                                // its\u200b\u7684\u200bhwirq = (chunk &lt;&lt; 5) + 8192\n                                                // \u200b\u8fd9\u200b\u4e5f\u200b\u662f\u200bGIC\u200b\u7684\u200bhwirq\n                                                lpi_map = its_lpi_alloc_chunks(nvecs, &amp;lpi_base, &amp;nr_lpis);\n                                                        // \u200b\u7b49\u4e8e\u200b(chunk &lt;&lt; 5) + 8192 \n                                                        dev-&gt;event_map.lpi_base = lpi_base;\n\n                __irq_domain_alloc_irqs\n                    irq_domain_alloc_irqs_recursive\n                        ret = domain-&gt;ops-&gt;alloc(domain, irq_base, nr_irqs, arg);\n                                its_irq_domain_alloc\n                                    err = its_alloc_device_irq(its_dev, &amp;hwirq);\n                                                *hwirq = dev-&gt;event_map.lpi_base + idx;\n                                    irq_domain_set_hwirq_and_chip\n                                        irq_data-&gt;hwirq = hwirq;\n                                        irq_data-&gt;chip = chip ? chip : &amp;no_irq_chip;\n                irq_domain_activate_irq(irq_data);\n                    domain-&gt;ops-&gt;activate(domain, irq_data);\n                        msi_domain_activate\n                            irq_chip_compose_msi_msg(irq_data, &amp;msg)    \n                                   // \u200b\u6784\u9020\u200bmsg\uff0c\u200b\u91cc\u9762\u200b\u542b\u6709\u200bMSI\u200b\u6216\u200bmsi-x\u200b\u7684\u200baddr/val\n                                   its_irq_compose_msi_msg\n                                        addr = its-&gt;phys_base + GITS_TRANSLATER;\n                                        msg-&gt;address_lo     = addr &amp; ((1UL &lt;&lt; 32) - 1);\n                                        msg-&gt;address_hi     = addr &gt;&gt; 32;\n                                        // its_get_event_id:\n                                        // d-&gt;hwirq - its_dev-&gt;event_map.lpi_base;\n                                        msg-&gt;data       = its_get_event_id(d);                   \n                            // \u200b\u8bbe\u7f6e\u200bmsi-x\u200b\u7684\u200bentry\u200b\u5730\u5740\u200b  \n                            irq_chip_write_msi_msg(irq_data, &amp;msg);\n                            data-&gt;chip-&gt;irq_write_msi_msg(data, msg);\n                            pci_msi_domain_write_msg\n                                __pci_write_msi_msg(desc, msg);\n\n__pci_write_msi_msg(desc, msg);\n    // \u200b\u5bf9\u4e8e\u200bMSI-X\n    writel(msg-&gt;address_lo, base + PCI_MSIX_ENTRY_LOWER_ADDR);\n    writel(msg-&gt;address_hi, base + PCI_MSIX_ENTRY_UPPER_ADDR);\n    writel(msg-&gt;data, base + PCI_MSIX_ENTRY_DATA);\n\n    // \u200b\u5bf9\u4e8e\u200bMSI\n    pci_write_config_word(dev, pos + PCI_MSI_FLAGS, msgctl);\n    pci_write_config_dword(dev, pos + PCI_MSI_ADDRESS_LO,\n                       msg-&gt;address_lo);\n\n\n// \u200b\u4e3a\u200bPCI\u200b\u8bbe\u5907\u200b\u786e\u5b9a\u200bhwirq\nits_domain_ops.alloc\nits_irq_domain_alloc\n    its_alloc_device_irq\n        *hwirq = dev-&gt;event_map.lpi_base + idx;\n</code></pre>"},{"location":"10_PCI_PCIe/14_2/","title":"14 2","text":""},{"location":"10_PCI_PCIe/14_2/#msi_msi-x","title":"MSI_MSI-X\u200b\u4e2d\u65ad\u200b\u4e4b\u200b\u6e90\u7801\u200b\u5206\u6790","text":"<p>\u200b\u5f00\u53d1\u677f\u200b\u8d44\u6599\u200b\uff1a</p> <ul> <li>https://wiki.t-firefly.com/zh_CN/ROC-RK3399-PC-PLUS/</li> </ul> <p>\u200b\u53c2\u8003\u200b\u5185\u6838\u200b\u6587\u4ef6\u200b\uff1a</p> <ul> <li><code>Documentation\\PCI\\MSI-HOWTO.txt</code></li> <li><code>drivers\\pci\\host\\pcie-rockchip.c</code></li> <li><code>drivers\\nvme\\host\\pci.c</code></li> <li><code>drivers\\irqchip\\irq-gic-v3.c</code></li> <li><code>drivers\\irqchip\\irq-gic-v3-its.c</code></li> <li><code>drivers\\irqchip\\irq-gic-v3-its-pci-msi.c</code></li> </ul>"},{"location":"10_PCI_PCIe/14_2/#1-msimsi-x","title":"1. \u200b\u600e\u4e48\u200b\u53d1\u51fa\u200bMSI/MSI-X\u200b\u4e2d\u65ad","text":"<p>PCIe\u200b\u8bbe\u5907\u200b\u5411\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5b83\u200b\u53d1\u51fa\u200bTLP\u200b\u5305\u200b\uff0c\u200b\u5f80\u200b\u67d0\u4e2a\u200b\u5730\u5740\u200b\u5199\u5165\u200b\u67d0\u4e2a\u200b\u6570\u636e\u200b\u5373\u53ef\u200b\uff1a</p> <ul> <li>\u200b\u5f80\u200b\u54ea\u4e2a\u200b\u5730\u5740\u200b\uff1fGICv3 ITS\u200b\u7684\u200bGITS_TRANSLATER\u200b\u5bc4\u5b58\u5668\u200b\uff0cTLP\u200b\u5305\u200b\u91cc\u200b\u4f7f\u7528\u200b\u7684\u200b\u662f\u200bPCI\u200b\u5730\u5740\u200b</li> <li>\u200b\u5199\u200b\u4ec0\u4e48\u200b\u6570\u636e\u200b\uff1f0\u30011\u30012\u3001\u2026\u2026\uff0c\u200b\u8981\u200b\u53d1\u51fa\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\u65f6\u5199\u200b0\uff0c\u200b\u8981\u200b\u53d1\u51fa\u200b\u7b2c\u200b2\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\u65f6\u5199\u200b1\uff0c\u2026\u2026</li> </ul> <p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200brk3399.dtsi\u200b\u4e2d\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200bITS\u200b\u7684\u200b\u57fa\u200b\u5730\u5740\u200b\u662f\u200b0xfee20000\uff1a</p> <pre><code>its: interrupt-controller@fee20000 {\n                        compatible = \"arm,gic-v3-its\";\n                        msi-controller;\n                        reg = &lt;0x0 0xfee20000 0x0 0x20000&gt;;\n                };\n</code></pre> <p>\u200b\u5728\u200b<code>IHI0069G_gic_architecture_specification.pdf</code>\u200b\u4e2d\u6709\u200bITS\u200b\u5bc4\u5b58\u5668\u200b\u7684\u200b\u504f\u79fb\u200b\u5730\u5740\u200b\uff1a</p> <p></p> <p>GITS_TRANSLATER\u200b\u5bc4\u5b58\u5668\u200b\u7684\u200bCPU\u200b\u5730\u5740\u200b\u662f\u200b\uff1a0xfee20000 + 0x010000 + 0x0040 = 0xfee30040\u3002</p> <p>\u200b\u5bf9\u5e94\u200b\u7684\u200bPCI\u200b\u5730\u5740\u200b\u4e5f\u200b\u662f\u200b0xfee30040(\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u91cc\u200b\u4e3a\u4f8b\u200b\u65b9\u4fbf\u200b\uff0c\u200b\u6545\u610f\u200b\u4f7f\u5f97\u200bCPU\u200b\u5730\u5740\u200b\u8ddf\u200bPCI\u200b\u5730\u5740\u200b\u76f8\u540c\u200b\uff0c\u200b\u8fd9\u200b2\u200b\u4e2a\u200b\u5730\u5740\u200b\u5c5e\u4e8e\u200b\u4e0d\u540c\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b)\uff0c</p> <p>\u200b\u6240\u4ee5\u200b\u4e0b\u56fe\u200b\u4e2d\u200bPCI\u200b\u5730\u5740\u200b\u90fd\u200b\u662f\u200b0xfee30040\u3002</p> <p></p>"},{"location":"10_PCI_PCIe/14_2/#11-rk3399","title":"1.1 \u200b\u5728\u200bRK3399\u200b\u4e0a\u200b\u4f53\u9a8c","text":"<p>\u200b\u6211\u4eec\u200b\u4f7f\u7528\u200bRK3399\u200b\u5f00\u53d1\u677f\u200b\uff0c\u200b\u63d2\u4e0a\u200b\u4e86\u200b**NVMe** SSD\u200b\u56fa\u6001\u200b\u786c\u76d8\u200b\u3002</p> <p></p>"},{"location":"10_PCI_PCIe/14_2/#111","title":"1.1.1 \u200b\u5b89\u88c5\u200b\u5de5\u5177","text":"<p>\u200b\u8bf7\u200b\u7ed9\u200bRK3399\u200b\u5237\u5165\u200bUbuntu\u200b\u6620\u50cf\u200b\u6587\u4ef6\u200b\uff0c\u200b\u7136\u540e\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>udhcpc  # \u200b\u83b7\u53d6\u200bIP\napt update  # \u200b\u66f4\u65b0\u200b\u6e90\u200b\napt install pciutils  # \u200b\u5b89\u88c5\u200blspci\u200b\u5de5\u5177\u200b\napt install devmem2   # \u200b\u5b89\u88c5\u200bdevmem2\u200b\u5de5\u5177\u200b\n</code></pre>"},{"location":"10_PCI_PCIe/14_2/#112-msi-x","title":"1.1.2 \u200b\u67e5\u770b\u200b\u8bbe\u5907\u200bMSI-X\u200b\u4fe1\u606f","text":"<p>\u200b\u6267\u884c\u200b<code>lspci -vvv</code>\uff0c\u200b\u5f97\u5230\u200b\u5982\u4e0b\u200b\u4fe1\u606f\u200b\uff1a</p> <pre><code>01:00.0 Non-Volatile memory controller: Silicon Motion, Inc. Device 2263 (rev 03) (prog-if 02 [NVM Express])\n        Subsystem: Silicon Motion, Inc. Device 2263\n        Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx+\n        Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-\n        Latency: 0\n        Interrupt: pin A routed to IRQ 231\n        Region 0: Memory at fa000000 (64-bit, non-prefetchable) [size=16K]\n        Capabilities: [40] Power Management version 3\n                Flags: PMEClk- DSI- D1- D2- AuxCurrent=0mA PME(D0-,D1-,D2-,D3hot-,D3cold-)\n                Status: D0 NoSoftRst+ PME-Enable- DSel=0 DScale=0 PME-\n        Capabilities: [50] MSI: Enable- Count=1/8 Maskable+ 64bit+\n                Address: 0000000000000000  Data: 0000\n                Masking: 00000000  Pending: 00000000\n        Capabilities: [70] Express (v2) Endpoint, MSI 00\n                DevCap: MaxPayload 128 bytes, PhantFunc 0, Latency L0s unlimited, L1 unlimited\n                        ExtTag- AttnBtn- AttnInd- PwrInd- RBE+ FLReset+ SlotPowerLimit 0.000W\n                DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported-\n                        RlxdOrd+ ExtTag- PhantFunc- AuxPwr- NoSnoop- FLReset-\n                        MaxPayload 128 bytes, MaxReadReq 512 bytes\n                DevSta: CorrErr- UncorrErr- FatalErr- UnsuppReq- AuxPwr+ TransPend-\n                LnkCap: Port #0, Speed 8GT/s, Width x4, ASPM L1, Exit Latency L0s &lt;1us, L1 &lt;8us\n                        ClockPM+ Surprise- LLActRep- BwNot- ASPMOptComp+\n                LnkCtl: ASPM Disabled; RCB 64 bytes Disabled- CommClk-\n                        ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt-\n                LnkSta: Speed 2.5GT/s, Width x4, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt-\n                DevCap2: Completion Timeout: Range ABCD, TimeoutDis+, LTR+, OBFF Not Supported\n                DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis-, LTR-, OBFF Disabled\n                LnkCtl2: Target Link Speed: 8GT/s, EnterCompliance- SpeedDis-\n                         Transmit Margin: Normal Operating Range, EnterModifiedCompliance- ComplianceSOS-\n                         Compliance De-emphasis: -6dB\n                LnkSta2: Current De-emphasis Level: -3.5dB, EqualizationComplete-, EqualizationPhase1-\n                         EqualizationPhase2-, EqualizationPhase3-, LinkEqualizationRequest-\n        Capabilities: [b0] MSI-X: Enable+ Count=16 Masked-\n                Vector table: BAR=0 offset=00002000\n                PBA: BAR=0 offset=00002100\n        Capabilities: [100 v2] Advanced Error Reporting\n                UESta:  DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol-\n                UEMsk:  DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol-\n                UESvrt: DLP+ SDES+ TLP- FCP+ CmpltTO- CmpltAbrt- UnxCmplt- RxOF+ MalfTLP+ ECRC- UnsupReq- ACSViol-\n                CESta:  RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr-\n                CEMsk:  RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+\n                AERCap: First Error Pointer: 00, GenCap+ CGenEn- ChkCap+ ChkEn-\n        Capabilities: [158 v1] #19\n        Capabilities: [178 v1] Latency Tolerance Reporting\n                Max snoop latency: 0ns\n                Max no snoop latency: 0ns\n        Capabilities: [180 v1] L1 PM Substates\n                L1SubCap: PCI-PM_L1.2+ PCI-PM_L1.1+ ASPM_L1.2+ ASPM_L1.1+ L1_PM_Substates+\n                          PortCommonModeRestoreTime=10us PortTPowerOnTime=10us\n                L1SubCtl1: PCI-PM_L1.2- PCI-PM_L1.1- ASPM_L1.2- ASPM_L1.1-\n                           T_CommonMode=0us LTR1.2_Threshold=0ns\n                L1SubCtl2: T_PwrOn=10us\n        Kernel driver in use: nvme\n</code></pre> <p>\u200b\u4ece\u200b\u4e0a\u8ff0\u200b\u4fe1\u606f\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200b\uff1a</p> <pre><code>        Region 0: Memory at fa000000 (64-bit, non-prefetchable) [size=16K]\n        Capabilities: [b0] MSI-X: Enable+ Count=16 Masked-\n                Vector table: BAR=0 offset=00002000\n                PBA: BAR=0 offset=00002100\n</code></pre> <p>\u200b\u8fd9\u200b\u8868\u793a\u200b\uff1a</p> <ul> <li>MSI-X: Enable+\uff1a\u200b\u4f7f\u7528\u200bMSI-X\u200b\u529f\u80fd\u200b</li> <li>Vector table: BAR=0 offset=00002000\uff1aMSI\u200b\u7684\u200b\u5411\u91cf\u200b\u5728\u200bBAR 0\u200b\u504f\u79fb\u200b\u5730\u5740\u200b0x00002000\u200b\u5904\u200b</li> <li>Region 0: Memory at fa000000\uff1a</li> <li>BAR 0\u200b\u7684\u200bPCI\u200b\u5730\u5740\u200b\u662f\u200b0xfa000000\uff0c</li> <li>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u91cc\u200b\u4e3a\u4e86\u200b\u65b9\u4fbf\u200b\u4ee4\u200bCPU\u200b\u5730\u5740\u200b\u7b49\u4e8e\u200bPCI\u200b\u5730\u5740\u200b\uff0c\u200b\u6240\u4ee5\u200bBAR\u200b\u7684\u200bCPU\u200b\u5730\u5740\u200b\u4e5f\u200b\u662f\u200b0xfa000000\u3002</li> </ul> <p>\u200b\u6211\u4eec\u200b\u53ef\u4ee5\u200b\u53bb\u200b\u8bfb\u53d6\u200b <code>0xfa000000 + 0x00002000</code>\u200b\u5f00\u59cb\u200b\u7684\u200b\u5411\u91cf\u200b\u8868\u200b\uff0c\u200b\u9a8c\u8bc1\u200b\u91cc\u200b\uff1a</p> <ul> <li>msg addr\u200b\u4e3a\u200b0xfee30040</li> <li>msg data\u200b\u4e3a\u200b0\u30011\u3001\u2026\u2026</li> </ul> <p></p>"},{"location":"10_PCI_PCIe/14_2/#113-msi-x","title":"1.1.3 \u200b\u9a8c\u8bc1\u200bMSI-X\u200b\u4fe1\u606f","text":""},{"location":"10_PCI_PCIe/14_2/#2-msimsi-x","title":"2. \u200b\u600e\u4e48\u200b\u4f7f\u7528\u200bMSI/MSI-X","text":"<p>\u200b\u53c2\u8003\u200b\u5185\u6838\u200b\u6587\u6863\u200b\uff1a<code>Documentation\\PCI\\MSI-HOWTO.txt</code>\u3001<code>drivers\\nvme\\host\\pci.c</code></p> <p>\u200b\u4e3b\u8981\u200b\u51fd\u6570\u200b\u662f\u200b\u8fd9\u200b2\u200b\u4e2a\u200b:</p> <pre><code>int pci_enable_msix_range(struct pci_dev *dev, struct msix_entry *entries,\n              int minvec, int maxvec);\nint pci_enable_msi_range(struct pci_dev *dev, int minvec, int maxvec);\n</code></pre> <p>\u200b\u793a\u4f8b\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>    // \u200b\u5206\u914d\u200b msix_entry \u200b\u6570\u7ec4\u200b\uff0c\u200b\u6bcf\u4e00\u200b\u6570\u7ec4\u200b\u9879\u200b\u7528\u6765\u200b\u4fdd\u5b58\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\u7684\u200b\u4fe1\u606f\u200b\n    dev-&gt;entry = kzalloc_node(num_possible_cpus() * sizeof(*dev-&gt;entry),\n                            GFP_KERNEL, node);\n\n    // \u200b\u5148\u200b\u5c1d\u8bd5\u200b\u4f7f\u7528\u200bMSI-X\n    vecs = pci_enable_msix_range(pdev, dev-&gt;entry, 1, nr_io_queues);\n    if (vecs &lt; 0) {\n        // \u200b\u518d\u200b\u5c1d\u8bd5\u200b\u4f7f\u7528\u200bMSI\n        vecs = pci_enable_msi_range(pdev, 1, min(nr_io_queues, 32));\n        if (vecs &lt; 0) {\n            vecs = 1;\n        } else {\n            for (i = 0; i &lt; vecs; i++)\n                dev-&gt;entry[i].vector = i + pdev-&gt;irq;\n        }\n    }\n\n    // request_irq: \u200b\u4e2d\u65ad\u200b\u53f7\u200b\u90fd\u200b\u4fdd\u5b58\u200b\u5728\u200bdev-&gt;entry[i].vector\u200b\u91cc\u200b\n    for (i = 0; i &lt; vecs; i++)\n        request_irq(dev-&gt;entry[i].vector, ...);\n</code></pre> <p>\u200b\u6ce8\u610f\u200b\uff0c\u200b\u5728\u200b<code>pci_enable_msix_range</code>\u200b\u6216\u8005\u200b<code>pci_enable_msi_range</code>\u200b\u51fd\u6570\u200b\u4e2d\u200b\uff1a</p> <ul> <li>minvec\u200b\u4ece\u200b1\u200b\u5f00\u59cb\u200b</li> <li>\u200b\u5bf9\u4e8e\u200bpci_enable_msix_range\uff0c\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u4fdd\u5b58\u200b\u5728\u200bentries[i].vector\u200b\u91cc\u200b</li> <li>\u200b\u5bf9\u4e8e\u200bpci_enable_msi_range\uff0c\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u4fdd\u5b58\u200b\u5728\u200bpdev-&gt;irq\u200b\u91cc\u200b</li> </ul>"},{"location":"10_PCI_PCIe/14_2/#3-msimsi-x","title":"3. MSI/MSI-X\u200b\u4e2d\u65ad\u200b\u6e90\u7801\u200b\u5206\u6790","text":""},{"location":"10_PCI_PCIe/14_2/#31-irq-domain","title":"3.1 IRQ Domain\u200b\u521b\u5efa\u200b\u6d41\u7a0b","text":"<p>\u200b\u4ece\u200bPCI\u200b\u8bbe\u5907\u200b\u89e6\u53d1\u200b\uff0c\u200b\u6d89\u53ca\u200b\u4e09\u4e2a\u200bIRQ Domain\uff1a</p> <ul> <li><code>drivers\\irqchip\\irq-gic-v3-its-pci-msi.c</code></li> <li><code>drivers\\irqchip\\irq-gic-v3-its.c</code></li> <li><code>drivers\\irqchip\\irq-gic-v3.c</code></li> </ul>"},{"location":"10_PCI_PCIe/14_2/#311-gic","title":"3.1.1 GIC","text":"<p>\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a</p> <pre><code>        gic: interrupt-controller@fee00000 {\n                compatible = \"arm,gic-v3\";\n                #interrupt-cells = &lt;4&gt;;\n                #address-cells = &lt;2&gt;;\n                #size-cells = &lt;2&gt;;\n                ranges;\n                interrupt-controller;\n\n                reg = &lt;0x0 0xfee00000 0 0x10000&gt;, /* GICD */\n                      &lt;0x0 0xfef00000 0 0xc0000&gt;, /* GICR */\n                      &lt;0x0 0xfff00000 0 0x10000&gt;, /* GICC */\n                      &lt;0x0 0xfff10000 0 0x10000&gt;, /* GICH */\n                      &lt;0x0 0xfff20000 0 0x10000&gt;; /* GICV */\n                interrupts = &lt;GIC_PPI 9 IRQ_TYPE_LEVEL_HIGH 0&gt;;\n                its: interrupt-controller@fee20000 {\n                        compatible = \"arm,gic-v3-its\";\n                        msi-controller;\n                        reg = &lt;0x0 0xfee20000 0x0 0x20000&gt;;\n                };\n</code></pre> <p>\u200b\u9a71\u52a8\u200b\u4ee3\u7801\u200b\uff1a<code>drivers\\irqchip\\irq-gic-v3.c</code></p> <p></p>"},{"location":"10_PCI_PCIe/14_2/#312-its","title":"3.1.2 ITS","text":"<p>\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a</p> <pre><code>its: interrupt-controller@fee20000 {\n                        compatible = \"arm,gic-v3-its\";\n                        msi-controller;\n                        reg = &lt;0x0 0xfee20000 0x0 0x20000&gt;;\n                };\n</code></pre> <p>\u200b\u9a71\u52a8\u200b\u4ee3\u7801\u200b\uff1a<code>drivers\\irqchip\\irq-gic-v3-its.c</code></p> <p></p>"},{"location":"10_PCI_PCIe/14_2/#313-pci-msi","title":"3.1.3 PCI MSI","text":"<p>\u200b\u5bf9\u5e94\u200b\u7684\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u8ddf\u200bITS\u200b\u9a71\u52a8\u200b\u4f7f\u7528\u200b\u7684\u200b\u4e00\u6837\u200b\u7684\u200b\uff1a</p> <pre><code>its: interrupt-controller@fee20000 {\n                        compatible = \"arm,gic-v3-its\";\n                        msi-controller;\n                        reg = &lt;0x0 0xfee20000 0x0 0x20000&gt;;\n                };\n</code></pre> <p>\u200b\u9a71\u52a8\u200b\u4ee3\u7801\u200b\uff1a<code>drivers\\irqchip\\irq-gic-v3-its-pci-msi.c</code>\uff0c\u200b\u5b83\u200b\u53ea\u662f\u200b\u5728\u200bITS\u200b\u4e0b\u9762\u200b\u518d\u200b\u589e\u52a0\u200b\u4e86\u200b\u4e00\u4e2a\u200b\u5904\u7406\u200b\u5c42\u200b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/14_2/#314-pcie","title":"3.1.4 PCIe\u200b\u63a7\u5236\u5668","text":"<p>\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a</p> <pre><code>        pcie0: pcie@f8000000 {\n                compatible = \"rockchip,rk3399-pcie\";\n                #address-cells = &lt;3&gt;;\n                #size-cells = &lt;2&gt;;\n                aspm-no-l0s;\n                clocks = &lt;&amp;cru ACLK_PCIE&gt;, &lt;&amp;cru ACLK_PERF_PCIE&gt;,\n                         &lt;&amp;cru PCLK_PCIE&gt;, &lt;&amp;cru SCLK_PCIE_PM&gt;;\n                clock-names = \"aclk\", \"aclk-perf\",\n                              \"hclk\", \"pm\";\n                bus-range = &lt;0x0 0x1f&gt;;\n                max-link-speed = &lt;1&gt;;\n                linux,pci-domain = &lt;0&gt;;\n                msi-map = &lt;0x0 &amp;its 0x0 0x1000&gt;;\n</code></pre> <p>\u200b\u91cc\u9762\u200b\u7684\u200b<code>msi-map = &lt;0x0 &amp;its 0x0 0x1000&gt;;</code>\u200b\u662f\u200b\u7528\u6765\u200b\u628a\u200bPCIe\u200b\u8bbe\u5907\u200b\u6620\u5c04\u200b\u5230\u200bMSI\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u683c\u5f0f\u200b\u4e3a\u200b\uff1a</p> <pre><code>msi-map = &lt;rid-base &amp;msi-controller msi-base length&gt;;\n</code></pre> <ul> <li>rid-base\uff1a\u200b\u7b2c\u200b1\u200b\u4e2a\u200bRequest ID\uff0c\u200b\u5c31\u662f\u200b\u4f7f\u7528\u200b\u7ec4\u6210\u200b\u7684\u200b\u4e00\u4e2a\u200b\u6570\u5b57\u200b</li> <li>msi-controller\uff1a\u200b\u8fd9\u4e2a\u200bPCIe\u200b\u8bbe\u5907\u200b\u6620\u5c04\u200b\u5230\u200b\u54ea\u4e2a\u200bMSI\u200b\u63a7\u5236\u5668\u200b\uff1f</li> <li>msi-base\uff1a\u200b\u7b2c\u200b1\u200b\u4e2a\u200bPCIe\u200b\u8bbe\u5907\u200b\u6620\u5c04\u200b\u5230\u200bMSI\u200b\u63a7\u5236\u5668\u200b\u54ea\u4e2a\u200b\u4e2d\u65ad\u200b\uff1f</li> <li>length\uff1a\u200b\u80fd\u200b\u6620\u5c04\u200b\u591a\u5c11\u200b\u4e2a\u200b\u8bbe\u5907\u200b</li> </ul>"},{"location":"10_PCI_PCIe/14_2/#32","title":"3.2 \u200b\u5206\u914d\u200b\u4e2d\u65ad","text":"<p>\u200b\u4ee3\u7801\u200b\uff1a<code>drivers\\nvme\\host\\pci.c</code></p> <pre><code>nvme_probe &gt; nvme_probe_work &gt; nvme_setup_io_queues \n        pci_enable_msix_range\n            pci_enable_msix(dev, entries, nvec);\n                msix_capability_init(dev, entries, nvec);\n\n        pci_enable_msi_range\n                msi_capability_init(dev, nvec);\n\nmsix_capability_init/msi_capability_init\n    pci_msi_setup_msi_irqs\n        pci_msi_domain_alloc_irqs\n            msi_domain_alloc_irqs\n                ret = ops-&gt;msi_prepare(domain, dev, nvec, &amp;arg); // its_pci_msi_prepare\n                    its_pci_msi_prepare // irq-gic-v3-its-pci-msi.c\n                        // rid = (bus &lt;&lt; 8) | (dev &lt;&lt; 4) | function\n                        info-&gt;scratchpad[0].ul = pci_msi_domain_get_msi_rid(domain, pdev);  \n                        return msi_info-&gt;ops-&gt;msi_prepare(...) // \u200b\u4e0a\u200b\u4e00\u5c42\u200birq-gic-v3-its.c\n                                its_msi_prepare\n                                    dev_id = info-&gt;scratchpad[0].ul;  // rid\n                                    its_dev = its_create_device(its, dev_id, nvec);\n                                                // \u200b\u4ece\u200bITS\u200b\u5168\u5c40\u200b\u7684\u200b\u4f4d\u200b\u56fe\u91cc\u200b\u627e\u5230\u200b\u7a7a\u95f2\u200b\u4f4d\u200b chunk\n                                                // \u200b\u4e00\u4e2a\u200bchunk\u200b\u8868\u793a\u200b32\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\n                                                // its\u200b\u7684\u200bhwirq = (chunk &lt;&lt; 5) + 8192\n                                                // \u200b\u8fd9\u200b\u4e5f\u200b\u662f\u200bGIC\u200b\u7684\u200bhwirq\n                                                lpi_map = its_lpi_alloc_chunks(nvecs, &amp;lpi_base, &amp;nr_lpis);\n                                                        // \u200b\u7b49\u4e8e\u200b(chunk &lt;&lt; 5) + 8192 \n                                                        dev-&gt;event_map.lpi_base = lpi_base;\n\n                __irq_domain_alloc_irqs\n                    irq_domain_alloc_irqs_recursive\n                        ret = domain-&gt;ops-&gt;alloc(domain, irq_base, nr_irqs, arg);\n                                its_irq_domain_alloc\n                                    err = its_alloc_device_irq(its_dev, &amp;hwirq);\n                                                *hwirq = dev-&gt;event_map.lpi_base + idx;\n                                    irq_domain_set_hwirq_and_chip\n                                        irq_data-&gt;hwirq = hwirq;\n                                        irq_data-&gt;chip = chip ? chip : &amp;no_irq_chip;\n                irq_domain_activate_irq(irq_data);\n                    domain-&gt;ops-&gt;activate(domain, irq_data);\n                        msi_domain_activate\n                            irq_chip_compose_msi_msg(irq_data, &amp;msg)    \n                                   // \u200b\u6784\u9020\u200bmsg\uff0c\u200b\u91cc\u9762\u200b\u542b\u6709\u200bMSI\u200b\u6216\u200bmsi-x\u200b\u7684\u200baddr/val\n                                   its_irq_compose_msi_msg\n                                        addr = its-&gt;phys_base + GITS_TRANSLATER;\n                                        msg-&gt;address_lo     = addr &amp; ((1UL &lt;&lt; 32) - 1);\n                                        msg-&gt;address_hi     = addr &gt;&gt; 32;\n                                        // its_get_event_id:\n                                        // d-&gt;hwirq - its_dev-&gt;event_map.lpi_base;\n                                        msg-&gt;data       = its_get_event_id(d);                   \n                            // \u200b\u8bbe\u7f6e\u200bmsi-x\u200b\u7684\u200bentry\u200b\u5730\u5740\u200b  \n                            irq_chip_write_msi_msg(irq_data, &amp;msg);\n                            data-&gt;chip-&gt;irq_write_msi_msg(data, msg);\n                            pci_msi_domain_write_msg\n                                __pci_write_msi_msg(desc, msg);\n\n__pci_write_msi_msg(desc, msg);\n    // \u200b\u5bf9\u4e8e\u200bMSI-X\n    writel(msg-&gt;address_lo, base + PCI_MSIX_ENTRY_LOWER_ADDR);\n    writel(msg-&gt;address_hi, base + PCI_MSIX_ENTRY_UPPER_ADDR);\n    writel(msg-&gt;data, base + PCI_MSIX_ENTRY_DATA);\n\n    // \u200b\u5bf9\u4e8e\u200bMSI\n    pci_write_config_word(dev, pos + PCI_MSI_FLAGS, msgctl);\n    pci_write_config_dword(dev, pos + PCI_MSI_ADDRESS_LO,\n                       msg-&gt;address_lo);\n\n\n// \u200b\u4e3a\u200bPCI\u200b\u8bbe\u5907\u200b\u786e\u5b9a\u200bhwirq\nits_domain_ops.alloc\nits_irq_domain_alloc\n    its_alloc_device_irq\n        *hwirq = dev-&gt;event_map.lpi_base + idx;\n</code></pre>"},{"location":"10_PCI_PCIe/15_1/","title":"15_MSI_MSI-X\u200b\u4e2d\u65ad\u200b\u4e4b\u200b\u6e90\u7801\u200b\u5206\u6790","text":""},{"location":"10_PCI_PCIe/15_1/#msi_msi-x","title":"MSI_MSI-X\u200b\u4e2d\u65ad\u200b\u4e4b\u200b\u6e90\u7801\u200b\u5206\u6790","text":"<p>\u200b\u5f00\u53d1\u677f\u200b\u8d44\u6599\u200b\uff1a</p> <ul> <li>https://wiki.t-firefly.com/zh_CN/ROC-RK3399-PC-PLUS/</li> </ul> <p>\u200b\u53c2\u8003\u200b\u5185\u6838\u200b\u6587\u4ef6\u200b\uff1a</p> <ul> <li><code>Documentation\\PCI\\MSI-HOWTO.txt</code></li> <li><code>drivers\\pci\\host\\pcie-rockchip.c</code></li> <li><code>drivers\\nvme\\host\\pci.c</code></li> <li><code>drivers\\irqchip\\irq-gic-v3.c</code></li> <li><code>drivers\\irqchip\\irq-gic-v3-its.c</code></li> <li><code>drivers\\irqchip\\irq-gic-v3-its-pci-msi.c</code></li> </ul>"},{"location":"10_PCI_PCIe/15_1/#1-msimsi-x","title":"1. \u200b\u600e\u4e48\u200b\u53d1\u51fa\u200bMSI/MSI-X\u200b\u4e2d\u65ad","text":"<p>PCIe\u200b\u8bbe\u5907\u200b\u5411\u200b\u53d1\u51fa\u200b\u4e2d\u65ad\u200b\uff0c\u200b\u5b83\u200b\u53d1\u51fa\u200bTLP\u200b\u5305\u200b\uff0c\u200b\u5f80\u200b\u67d0\u4e2a\u200b\u5730\u5740\u200b\u5199\u5165\u200b\u67d0\u4e2a\u200b\u6570\u636e\u200b\u5373\u53ef\u200b\uff1a</p> <ul> <li>\u200b\u5f80\u200b\u54ea\u4e2a\u200b\u5730\u5740\u200b\uff1fGICv3 ITS\u200b\u7684\u200bGITS_TRANSLATER\u200b\u5bc4\u5b58\u5668\u200b\uff0cTLP\u200b\u5305\u200b\u91cc\u200b\u4f7f\u7528\u200b\u7684\u200b\u662f\u200bPCI\u200b\u5730\u5740\u200b</li> <li>\u200b\u5199\u200b\u4ec0\u4e48\u200b\u6570\u636e\u200b\uff1f0\u30011\u30012\u3001\u2026\u2026\uff0c\u200b\u8981\u200b\u53d1\u51fa\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\u65f6\u5199\u200b0\uff0c\u200b\u8981\u200b\u53d1\u51fa\u200b\u7b2c\u200b2\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\u65f6\u5199\u200b1\uff0c\u2026\u2026</li> </ul> <p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200brk3399.dtsi\u200b\u4e2d\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200bITS\u200b\u7684\u200b\u57fa\u200b\u5730\u5740\u200b\u662f\u200b0xfee20000\uff1a</p> <pre><code>its: interrupt-controller@fee20000 {\n                        compatible = \"arm,gic-v3-its\";\n                        msi-controller;\n                        reg = &lt;0x0 0xfee20000 0x0 0x20000&gt;;\n                };\n</code></pre> <p>\u200b\u5728\u200b<code>IHI0069G_gic_architecture_specification.pdf</code>\u200b\u4e2d\u6709\u200bITS\u200b\u5bc4\u5b58\u5668\u200b\u7684\u200b\u504f\u79fb\u200b\u5730\u5740\u200b\uff1a</p> <p></p> <p>GITS_TRANSLATER\u200b\u5bc4\u5b58\u5668\u200b\u7684\u200bCPU\u200b\u5730\u5740\u200b\u662f\u200b\uff1a0xfee20000 + 0x010000 + 0x0040 = 0xfee30040\u3002</p> <p>\u200b\u5bf9\u5e94\u200b\u7684\u200bPCI\u200b\u5730\u5740\u200b\u4e5f\u200b\u662f\u200b0xfee30040(\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u91cc\u200b\u4e3a\u4f8b\u200b\u65b9\u4fbf\u200b\uff0c\u200b\u6545\u610f\u200b\u4f7f\u5f97\u200bCPU\u200b\u5730\u5740\u200b\u8ddf\u200bPCI\u200b\u5730\u5740\u200b\u76f8\u540c\u200b\uff0c\u200b\u8fd9\u200b2\u200b\u4e2a\u200b\u5730\u5740\u200b\u5c5e\u4e8e\u200b\u4e0d\u540c\u200b\u5730\u5740\u200b\u7a7a\u95f4\u200b)\uff0c</p> <p>\u200b\u6240\u4ee5\u200b\u4e0b\u56fe\u200b\u4e2d\u200bPCI\u200b\u5730\u5740\u200b\u90fd\u200b\u662f\u200b0xfee30040\u3002</p> <p></p>"},{"location":"10_PCI_PCIe/15_1/#11-rk3399","title":"1.1 \u200b\u5728\u200bRK3399\u200b\u4e0a\u200b\u4f53\u9a8c","text":"<p>\u200b\u6211\u4eec\u200b\u4f7f\u7528\u200bRK3399\u200b\u5f00\u53d1\u677f\u200b\uff0c\u200b\u63d2\u4e0a\u200b\u4e86\u200b**NVMe** SSD\u200b\u56fa\u6001\u200b\u786c\u76d8\u200b\u3002</p> <p></p>"},{"location":"10_PCI_PCIe/15_1/#111","title":"1.1.1 \u200b\u5b89\u88c5\u200b\u5de5\u5177","text":"<p>\u200b\u8bf7\u200b\u7ed9\u200bRK3399\u200b\u5237\u5165\u200bUbuntu\u200b\u6620\u50cf\u200b\u6587\u4ef6\u200b\uff0c\u200b\u7136\u540e\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>udhcpc  # \u200b\u83b7\u53d6\u200bIP\napt update  # \u200b\u66f4\u65b0\u200b\u6e90\u200b\napt install pciutils  # \u200b\u5b89\u88c5\u200blspci\u200b\u5de5\u5177\u200b\napt install devmem2   # \u200b\u5b89\u88c5\u200bdevmem2\u200b\u5de5\u5177\u200b\n</code></pre>"},{"location":"10_PCI_PCIe/15_1/#112-msi-x","title":"1.1.2 \u200b\u67e5\u770b\u200b\u8bbe\u5907\u200bMSI-X\u200b\u4fe1\u606f","text":"<p>\u200b\u6267\u884c\u200b<code>lspci -vvv</code>\uff0c\u200b\u5f97\u5230\u200b\u5982\u4e0b\u200b\u4fe1\u606f\u200b\uff1a</p> <pre><code>01:00.0 Non-Volatile memory controller: Silicon Motion, Inc. Device 2263 (rev 03) (prog-if 02 [NVM Express])\n        Subsystem: Silicon Motion, Inc. Device 2263\n        Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx+\n        Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-\n        Latency: 0\n        Interrupt: pin A routed to IRQ 231\n        Region 0: Memory at fa000000 (64-bit, non-prefetchable) [size=16K]\n        Capabilities: [40] Power Management version 3\n                Flags: PMEClk- DSI- D1- D2- AuxCurrent=0mA PME(D0-,D1-,D2-,D3hot-,D3cold-)\n                Status: D0 NoSoftRst+ PME-Enable- DSel=0 DScale=0 PME-\n        Capabilities: [50] MSI: Enable- Count=1/8 Maskable+ 64bit+\n                Address: 0000000000000000  Data: 0000\n                Masking: 00000000  Pending: 00000000\n        Capabilities: [70] Express (v2) Endpoint, MSI 00\n                DevCap: MaxPayload 128 bytes, PhantFunc 0, Latency L0s unlimited, L1 unlimited\n                        ExtTag- AttnBtn- AttnInd- PwrInd- RBE+ FLReset+ SlotPowerLimit 0.000W\n                DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported-\n                        RlxdOrd+ ExtTag- PhantFunc- AuxPwr- NoSnoop- FLReset-\n                        MaxPayload 128 bytes, MaxReadReq 512 bytes\n                DevSta: CorrErr- UncorrErr- FatalErr- UnsuppReq- AuxPwr+ TransPend-\n                LnkCap: Port #0, Speed 8GT/s, Width x4, ASPM L1, Exit Latency L0s &lt;1us, L1 &lt;8us\n                        ClockPM+ Surprise- LLActRep- BwNot- ASPMOptComp+\n                LnkCtl: ASPM Disabled; RCB 64 bytes Disabled- CommClk-\n                        ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt-\n                LnkSta: Speed 2.5GT/s, Width x4, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt-\n                DevCap2: Completion Timeout: Range ABCD, TimeoutDis+, LTR+, OBFF Not Supported\n                DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis-, LTR-, OBFF Disabled\n                LnkCtl2: Target Link Speed: 8GT/s, EnterCompliance- SpeedDis-\n                         Transmit Margin: Normal Operating Range, EnterModifiedCompliance- ComplianceSOS-\n                         Compliance De-emphasis: -6dB\n                LnkSta2: Current De-emphasis Level: -3.5dB, EqualizationComplete-, EqualizationPhase1-\n                         EqualizationPhase2-, EqualizationPhase3-, LinkEqualizationRequest-\n        Capabilities: [b0] MSI-X: Enable+ Count=16 Masked-\n                Vector table: BAR=0 offset=00002000\n                PBA: BAR=0 offset=00002100\n        Capabilities: [100 v2] Advanced Error Reporting\n                UESta:  DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol-\n                UEMsk:  DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol-\n                UESvrt: DLP+ SDES+ TLP- FCP+ CmpltTO- CmpltAbrt- UnxCmplt- RxOF+ MalfTLP+ ECRC- UnsupReq- ACSViol-\n                CESta:  RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr-\n                CEMsk:  RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+\n                AERCap: First Error Pointer: 00, GenCap+ CGenEn- ChkCap+ ChkEn-\n        Capabilities: [158 v1] #19\n        Capabilities: [178 v1] Latency Tolerance Reporting\n                Max snoop latency: 0ns\n                Max no snoop latency: 0ns\n        Capabilities: [180 v1] L1 PM Substates\n                L1SubCap: PCI-PM_L1.2+ PCI-PM_L1.1+ ASPM_L1.2+ ASPM_L1.1+ L1_PM_Substates+\n                          PortCommonModeRestoreTime=10us PortTPowerOnTime=10us\n                L1SubCtl1: PCI-PM_L1.2- PCI-PM_L1.1- ASPM_L1.2- ASPM_L1.1-\n                           T_CommonMode=0us LTR1.2_Threshold=0ns\n                L1SubCtl2: T_PwrOn=10us\n        Kernel driver in use: nvme\n</code></pre> <p>\u200b\u4ece\u200b\u4e0a\u8ff0\u200b\u4fe1\u606f\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200b\uff1a</p> <pre><code>        Region 0: Memory at fa000000 (64-bit, non-prefetchable) [size=16K]\n        Capabilities: [b0] MSI-X: Enable+ Count=16 Masked-\n                Vector table: BAR=0 offset=00002000\n                PBA: BAR=0 offset=00002100\n</code></pre> <p>\u200b\u8fd9\u200b\u8868\u793a\u200b\uff1a</p> <ul> <li>MSI-X: Enable+\uff1a\u200b\u4f7f\u7528\u200bMSI-X\u200b\u529f\u80fd\u200b</li> <li>Vector table: BAR=0 offset=00002000\uff1aMSI\u200b\u7684\u200b\u5411\u91cf\u200b\u5728\u200bBAR 0\u200b\u504f\u79fb\u200b\u5730\u5740\u200b0x00002000\u200b\u5904\u200b</li> <li>Region 0: Memory at fa000000\uff1a</li> <li>BAR 0\u200b\u7684\u200bPCI\u200b\u5730\u5740\u200b\u662f\u200b0xfa000000\uff0c</li> <li>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u91cc\u200b\u4e3a\u4e86\u200b\u65b9\u4fbf\u200b\u4ee4\u200bCPU\u200b\u5730\u5740\u200b\u7b49\u4e8e\u200bPCI\u200b\u5730\u5740\u200b\uff0c\u200b\u6240\u4ee5\u200bBAR\u200b\u7684\u200bCPU\u200b\u5730\u5740\u200b\u4e5f\u200b\u662f\u200b0xfa000000\u3002</li> </ul> <p>\u200b\u6211\u4eec\u200b\u53ef\u4ee5\u200b\u53bb\u200b\u8bfb\u53d6\u200b <code>0xfa000000 + 0x00002000</code>\u200b\u5f00\u59cb\u200b\u7684\u200b\u5411\u91cf\u200b\u8868\u200b\uff0c\u200b\u9a8c\u8bc1\u200b\u91cc\u200b\uff1a</p> <ul> <li>msg addr\u200b\u4e3a\u200b0xfee30040</li> <li>msg data\u200b\u4e3a\u200b0\u30011\u3001\u2026\u2026</li> </ul> <p></p>"},{"location":"10_PCI_PCIe/15_1/#113-msi-x","title":"1.1.3 \u200b\u9a8c\u8bc1\u200bMSI-X\u200b\u4fe1\u606f","text":""},{"location":"10_PCI_PCIe/15_1/#2-msimsi-x","title":"2. \u200b\u600e\u4e48\u200b\u4f7f\u7528\u200bMSI/MSI-X","text":"<p>\u200b\u53c2\u8003\u200b\u5185\u6838\u200b\u6587\u6863\u200b\uff1a<code>Documentation\\PCI\\MSI-HOWTO.txt</code>\u3001<code>drivers\\nvme\\host\\pci.c</code></p> <p>\u200b\u4e3b\u8981\u200b\u51fd\u6570\u200b\u662f\u200b\u8fd9\u200b2\u200b\u4e2a\u200b:</p> <pre><code>int pci_enable_msix_range(struct pci_dev *dev, struct msix_entry *entries,\n              int minvec, int maxvec);\nint pci_enable_msi_range(struct pci_dev *dev, int minvec, int maxvec);\n</code></pre> <p>\u200b\u793a\u4f8b\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>    // \u200b\u5206\u914d\u200b msix_entry \u200b\u6570\u7ec4\u200b\uff0c\u200b\u6bcf\u4e00\u200b\u6570\u7ec4\u200b\u9879\u200b\u7528\u6765\u200b\u4fdd\u5b58\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\u7684\u200b\u4fe1\u606f\u200b\n    dev-&gt;entry = kzalloc_node(num_possible_cpus() * sizeof(*dev-&gt;entry),\n                            GFP_KERNEL, node);\n\n    // \u200b\u5148\u200b\u5c1d\u8bd5\u200b\u4f7f\u7528\u200bMSI-X\n    vecs = pci_enable_msix_range(pdev, dev-&gt;entry, 1, nr_io_queues);\n    if (vecs &lt; 0) {\n        // \u200b\u518d\u200b\u5c1d\u8bd5\u200b\u4f7f\u7528\u200bMSI\n        vecs = pci_enable_msi_range(pdev, 1, min(nr_io_queues, 32));\n        if (vecs &lt; 0) {\n            vecs = 1;\n        } else {\n            for (i = 0; i &lt; vecs; i++)\n                dev-&gt;entry[i].vector = i + pdev-&gt;irq;\n        }\n    }\n\n    // request_irq: \u200b\u4e2d\u65ad\u200b\u53f7\u200b\u90fd\u200b\u4fdd\u5b58\u200b\u5728\u200bdev-&gt;entry[i].vector\u200b\u91cc\u200b\n    for (i = 0; i &lt; vecs; i++)\n        request_irq(dev-&gt;entry[i].vector, ...);\n</code></pre> <p>\u200b\u6ce8\u610f\u200b\uff0c\u200b\u5728\u200b<code>pci_enable_msix_range</code>\u200b\u6216\u8005\u200b<code>pci_enable_msi_range</code>\u200b\u51fd\u6570\u200b\u4e2d\u200b\uff1a</p> <ul> <li>minvec\u200b\u4ece\u200b1\u200b\u5f00\u59cb\u200b</li> <li>\u200b\u5bf9\u4e8e\u200bpci_enable_msix_range\uff0c\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u4fdd\u5b58\u200b\u5728\u200bentries[i].vector\u200b\u91cc\u200b</li> <li>\u200b\u5bf9\u4e8e\u200bpci_enable_msi_range\uff0c\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\u53f7\u200b\u4fdd\u5b58\u200b\u5728\u200bpdev-&gt;irq\u200b\u91cc\u200b</li> </ul>"},{"location":"10_PCI_PCIe/15_1/#3-msimsi-x","title":"3. MSI/MSI-X\u200b\u4e2d\u65ad\u200b\u6e90\u7801\u200b\u5206\u6790","text":""},{"location":"10_PCI_PCIe/15_1/#31-irq-domain","title":"3.1 IRQ Domain\u200b\u521b\u5efa\u200b\u6d41\u7a0b","text":"<p>\u200b\u4ece\u200bPCI\u200b\u8bbe\u5907\u200b\u89e6\u53d1\u200b\uff0c\u200b\u6d89\u53ca\u200b\u4e09\u4e2a\u200bIRQ Domain\uff1a</p> <ul> <li><code>drivers\\irqchip\\irq-gic-v3-its-pci-msi.c</code></li> <li><code>drivers\\irqchip\\irq-gic-v3-its.c</code></li> <li><code>drivers\\irqchip\\irq-gic-v3.c</code></li> </ul>"},{"location":"10_PCI_PCIe/15_1/#311-gic","title":"3.1.1 GIC","text":"<p>\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a</p> <pre><code>        gic: interrupt-controller@fee00000 {\n                compatible = \"arm,gic-v3\";\n                #interrupt-cells = &lt;4&gt;;\n                #address-cells = &lt;2&gt;;\n                #size-cells = &lt;2&gt;;\n                ranges;\n                interrupt-controller;\n\n                reg = &lt;0x0 0xfee00000 0 0x10000&gt;, /* GICD */\n                      &lt;0x0 0xfef00000 0 0xc0000&gt;, /* GICR */\n                      &lt;0x0 0xfff00000 0 0x10000&gt;, /* GICC */\n                      &lt;0x0 0xfff10000 0 0x10000&gt;, /* GICH */\n                      &lt;0x0 0xfff20000 0 0x10000&gt;; /* GICV */\n                interrupts = &lt;GIC_PPI 9 IRQ_TYPE_LEVEL_HIGH 0&gt;;\n                its: interrupt-controller@fee20000 {\n                        compatible = \"arm,gic-v3-its\";\n                        msi-controller;\n                        reg = &lt;0x0 0xfee20000 0x0 0x20000&gt;;\n                };\n</code></pre> <p>\u200b\u9a71\u52a8\u200b\u4ee3\u7801\u200b\uff1a<code>drivers\\irqchip\\irq-gic-v3.c</code></p> <p></p>"},{"location":"10_PCI_PCIe/15_1/#312-its","title":"3.1.2 ITS","text":"<p>\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a</p> <pre><code>its: interrupt-controller@fee20000 {\n                        compatible = \"arm,gic-v3-its\";\n                        msi-controller;\n                        reg = &lt;0x0 0xfee20000 0x0 0x20000&gt;;\n                };\n</code></pre> <p>\u200b\u9a71\u52a8\u200b\u4ee3\u7801\u200b\uff1a<code>drivers\\irqchip\\irq-gic-v3-its.c</code></p> <p></p>"},{"location":"10_PCI_PCIe/15_1/#313-pci-msi","title":"3.1.3 PCI MSI","text":"<p>\u200b\u5bf9\u5e94\u200b\u7684\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u8ddf\u200bITS\u200b\u9a71\u52a8\u200b\u4f7f\u7528\u200b\u7684\u200b\u4e00\u6837\u200b\u7684\u200b\uff1a</p> <pre><code>its: interrupt-controller@fee20000 {\n                        compatible = \"arm,gic-v3-its\";\n                        msi-controller;\n                        reg = &lt;0x0 0xfee20000 0x0 0x20000&gt;;\n                };\n</code></pre> <p>\u200b\u9a71\u52a8\u200b\u4ee3\u7801\u200b\uff1a<code>drivers\\irqchip\\irq-gic-v3-its-pci-msi.c</code>\uff0c\u200b\u5b83\u200b\u53ea\u662f\u200b\u5728\u200bITS\u200b\u4e0b\u9762\u200b\u518d\u200b\u589e\u52a0\u200b\u4e86\u200b\u4e00\u4e2a\u200b\u5904\u7406\u200b\u5c42\u200b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/15_1/#314-pcie","title":"3.1.4 PCIe\u200b\u63a7\u5236\u5668","text":"<p>\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a</p> <pre><code>        pcie0: pcie@f8000000 {\n                compatible = \"rockchip,rk3399-pcie\";\n                #address-cells = &lt;3&gt;;\n                #size-cells = &lt;2&gt;;\n                aspm-no-l0s;\n                clocks = &lt;&amp;cru ACLK_PCIE&gt;, &lt;&amp;cru ACLK_PERF_PCIE&gt;,\n                         &lt;&amp;cru PCLK_PCIE&gt;, &lt;&amp;cru SCLK_PCIE_PM&gt;;\n                clock-names = \"aclk\", \"aclk-perf\",\n                              \"hclk\", \"pm\";\n                bus-range = &lt;0x0 0x1f&gt;;\n                max-link-speed = &lt;1&gt;;\n                linux,pci-domain = &lt;0&gt;;\n                msi-map = &lt;0x0 &amp;its 0x0 0x1000&gt;;\n</code></pre> <p>\u200b\u91cc\u9762\u200b\u7684\u200b<code>msi-map = &lt;0x0 &amp;its 0x0 0x1000&gt;;</code>\u200b\u662f\u200b\u7528\u6765\u200b\u628a\u200bPCIe\u200b\u8bbe\u5907\u200b\u6620\u5c04\u200b\u5230\u200bMSI\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u683c\u5f0f\u200b\u4e3a\u200b\uff1a</p> <pre><code>msi-map = &lt;rid-base &amp;msi-controller msi-base length&gt;;\n</code></pre> <ul> <li>rid-base\uff1a\u200b\u7b2c\u200b1\u200b\u4e2a\u200bRequest ID\uff0c\u200b\u5c31\u662f\u200b\u4f7f\u7528\u200b\u7ec4\u6210\u200b\u7684\u200b\u4e00\u4e2a\u200b\u6570\u5b57\u200b</li> <li>msi-controller\uff1a\u200b\u8fd9\u4e2a\u200bPCIe\u200b\u8bbe\u5907\u200b\u6620\u5c04\u200b\u5230\u200b\u54ea\u4e2a\u200bMSI\u200b\u63a7\u5236\u5668\u200b\uff1f</li> <li>msi-base\uff1a\u200b\u7b2c\u200b1\u200b\u4e2a\u200bPCIe\u200b\u8bbe\u5907\u200b\u6620\u5c04\u200b\u5230\u200bMSI\u200b\u63a7\u5236\u5668\u200b\u54ea\u4e2a\u200b\u4e2d\u65ad\u200b\uff1f</li> <li>length\uff1a\u200b\u80fd\u200b\u6620\u5c04\u200b\u591a\u5c11\u200b\u4e2a\u200b\u8bbe\u5907\u200b</li> </ul>"},{"location":"10_PCI_PCIe/15_1/#32","title":"3.2 \u200b\u5206\u914d\u200b\u4e2d\u65ad","text":"<p>\u200b\u4ee3\u7801\u200b\uff1a<code>drivers\\nvme\\host\\pci.c</code></p> <pre><code>nvme_probe &gt; nvme_probe_work &gt; nvme_setup_io_queues \n        pci_enable_msix_range\n            pci_enable_msix(dev, entries, nvec);\n                msix_capability_init(dev, entries, nvec);\n\n        pci_enable_msi_range\n                msi_capability_init(dev, nvec);\n\nmsix_capability_init/msi_capability_init\n    pci_msi_setup_msi_irqs\n        pci_msi_domain_alloc_irqs\n            msi_domain_alloc_irqs\n                ret = ops-&gt;msi_prepare(domain, dev, nvec, &amp;arg); // its_pci_msi_prepare\n                    its_pci_msi_prepare // irq-gic-v3-its-pci-msi.c\n                        // rid = (bus &lt;&lt; 8) | (dev &lt;&lt; 4) | function\n                        info-&gt;scratchpad[0].ul = pci_msi_domain_get_msi_rid(domain, pdev);  \n                        return msi_info-&gt;ops-&gt;msi_prepare(...) // \u200b\u4e0a\u200b\u4e00\u5c42\u200birq-gic-v3-its.c\n                                its_msi_prepare\n                                    dev_id = info-&gt;scratchpad[0].ul;  // rid\n                                    its_dev = its_create_device(its, dev_id, nvec);\n                                                // \u200b\u4ece\u200bITS\u200b\u5168\u5c40\u200b\u7684\u200b\u4f4d\u200b\u56fe\u91cc\u200b\u627e\u5230\u200b\u7a7a\u95f2\u200b\u4f4d\u200b chunk\n                                                // \u200b\u4e00\u4e2a\u200bchunk\u200b\u8868\u793a\u200b32\u200b\u4e2a\u200b\u4e2d\u65ad\u200b\n                                                // its\u200b\u7684\u200bhwirq = (chunk &lt;&lt; 5) + 8192\n                                                // \u200b\u8fd9\u200b\u4e5f\u200b\u662f\u200bGIC\u200b\u7684\u200bhwirq\n                                                lpi_map = its_lpi_alloc_chunks(nvecs, &amp;lpi_base, &amp;nr_lpis);\n                                                        // \u200b\u7b49\u4e8e\u200b(chunk &lt;&lt; 5) + 8192 \n                                                        dev-&gt;event_map.lpi_base = lpi_base;\n\n                __irq_domain_alloc_irqs\n                    irq_domain_alloc_irqs_recursive\n                        ret = domain-&gt;ops-&gt;alloc(domain, irq_base, nr_irqs, arg);\n                                its_irq_domain_alloc\n                                    err = its_alloc_device_irq(its_dev, &amp;hwirq);\n                                                *hwirq = dev-&gt;event_map.lpi_base + idx;\n                                    irq_domain_set_hwirq_and_chip\n                                        irq_data-&gt;hwirq = hwirq;\n                                        irq_data-&gt;chip = chip ? chip : &amp;no_irq_chip;\n                irq_domain_activate_irq(irq_data);\n                    domain-&gt;ops-&gt;activate(domain, irq_data);\n                        msi_domain_activate\n                            irq_chip_compose_msi_msg(irq_data, &amp;msg)    \n                                   // \u200b\u6784\u9020\u200bmsg\uff0c\u200b\u91cc\u9762\u200b\u542b\u6709\u200bMSI\u200b\u6216\u200bmsi-x\u200b\u7684\u200baddr/val\n                                   its_irq_compose_msi_msg\n                                        addr = its-&gt;phys_base + GITS_TRANSLATER;\n                                        msg-&gt;address_lo     = addr &amp; ((1UL &lt;&lt; 32) - 1);\n                                        msg-&gt;address_hi     = addr &gt;&gt; 32;\n                                        // its_get_event_id:\n                                        // d-&gt;hwirq - its_dev-&gt;event_map.lpi_base;\n                                        msg-&gt;data       = its_get_event_id(d);                   \n                            // \u200b\u8bbe\u7f6e\u200bmsi-x\u200b\u7684\u200bentry\u200b\u5730\u5740\u200b  \n                            irq_chip_write_msi_msg(irq_data, &amp;msg);\n                            data-&gt;chip-&gt;irq_write_msi_msg(data, msg);\n                            pci_msi_domain_write_msg\n                                __pci_write_msi_msg(desc, msg);\n\n__pci_write_msi_msg(desc, msg);\n    // \u200b\u5bf9\u4e8e\u200bMSI-X\n    writel(msg-&gt;address_lo, base + PCI_MSIX_ENTRY_LOWER_ADDR);\n    writel(msg-&gt;address_hi, base + PCI_MSIX_ENTRY_UPPER_ADDR);\n    writel(msg-&gt;data, base + PCI_MSIX_ENTRY_DATA);\n\n    // \u200b\u5bf9\u4e8e\u200bMSI\n    pci_write_config_word(dev, pos + PCI_MSI_FLAGS, msgctl);\n    pci_write_config_dword(dev, pos + PCI_MSI_ADDRESS_LO,\n                       msg-&gt;address_lo);\n\n\n// \u200b\u4e3a\u200bPCI\u200b\u8bbe\u5907\u200b\u786e\u5b9a\u200bhwirq\nits_domain_ops.alloc\nits_irq_domain_alloc\n    its_alloc_device_irq\n        *hwirq = dev-&gt;event_map.lpi_base + idx;\n</code></pre>"},{"location":"10_PCI_PCIe/16_1/","title":"16_\u200b\u600e\u4e48\u200b\u7f16\u5199\u200bPCIe\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f","text":""},{"location":"10_PCI_PCIe/16_1/#pcie","title":"\u600e\u4e48\u200b\u7f16\u5199\u200bPCIe\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>\u200b\u53c2\u8003\u200b\u5185\u6838\u200b\u6587\u4ef6\u200b\uff1a</p> <ul> <li><code>Documentation\\PCI\\MSI-HOWTO.txt</code></li> <li><code>drivers\\nvme\\host\\pci.c</code></li> </ul>"},{"location":"10_PCI_PCIe/16_1/#1-pci","title":"1. PCI\u200b\u603b\u7ebf\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u6a21\u578b","text":"<p>PCI\u200b\u603b\u7ebf\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u6a21\u578b\u200b\uff1a</p> <ul> <li>\u200b\u53f3\u8fb9\u200b\u662f\u200bpci_dev\uff0c\u200b\u7531\u200bPCIe\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u626b\u63cf\u200bPCIe\u200b\u603b\u7ebf\u200b\uff0c\u200b\u8bc6\u522b\u200b\u51fa\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5e76\u200b\u6784\u9020\u200b\u3001\u200b\u6ce8\u518c\u200bpci_dev</li> <li>pci_dev\u200b\u7ed3\u6784\u200b\u4f53\u200b\u542b\u6709\u200b\u4e30\u5bcc\u200b\u7684\u200b\u4fe1\u606f\u200b\uff0c\u200b\u6bd4\u5982\u200bvid\u3001pid\u3001class\u3001\u200b\u5df2\u7ecf\u200b\u5206\u914d\u200b\u5f97\u5230\u200b\u7684\u200bmem/io\u200b\u8d44\u6e90\u200b\u3001INTx\u200b\u4e2d\u65ad\u200b\u8d44\u6e90\u200b</li> <li>\u200b\u5de6\u8fb9\u200b\u662f\u200bPCIe\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200bpci_driver\uff0c\u200b\u9700\u8981\u200b\u6211\u4eec\u200b\u7f16\u5199\u200b\u3001\u200b\u6ce8\u518c\u200b</li> <li>\u200b\u4f7f\u7528\u200b\u51fd\u6570\u200bpci_register_driver\u200b\u6765\u200b\u6ce8\u518c\u200b</li> <li>pci_driver\u200b\u7ed3\u6784\u200b\u4f53\u91cc\u200b\u542b\u6709\u200bid_table\uff0c\u200b\u8868\u793a\u200b\u5b83\u200b\u80fd\u200b\u652f\u6301\u200b\u54ea\u4e9b\u200b\u8bbe\u5907\u200b</li> <li>pci_driver\u200b\u7ed3\u6784\u200b\u4f53\u91cc\u200b\u542b\u6709\u200bprobe\u200b\u51fd\u6570\u200b\uff0c\u200b\u8868\u793a\u200b\u53d1\u73b0\u200b\u80fd\u200b\u5339\u914d\u200b\u7684\u200bpci_dev\u200b\u540e\u200b\uff0c\u200b\u8fd9\u4e2a\u200bprobe\u200b\u51fd\u6570\u200b\u5c06\u200b\u88ab\u200b\u8c03\u7528\u200b</li> </ul> <p>\u200b\u600e\u4e48\u200b\u5224\u65ad\u200bpci_driver\u200b\u548c\u200bpci_dev\u200b\u662f\u5426\u200b\u5339\u914d\u200b\uff1f\u200b\u4f7f\u7528\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b\u51fd\u6570\u200b\uff1a</p> <p></p> <p><code>pci_bus_match</code>\u200b\u6838\u5fc3\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>pci_bus_match\n    found_id = pci_match_device(pci_drv, pci_dev);\n            found_id = pci_match_id(drv-&gt;id_table, dev);\n                pci_match_one_device(ids, dev)\n</code></pre> <p></p> <p>\u200b\u793a\u4f8b\u200b\uff0c\u200b\u4e0b\u56fe\u200b\u8868\u793a\u200b\u652f\u6301\u200b\u8fd9\u6837\u200b\u7684\u200bpci_dev\uff1a</p> <ul> <li>pci_dev\u200b\u7684\u200bclass &amp; 0xffffff == PCI_CLASS_STORAGE_EXPRESS</li> <li>pci_dev\u200b\u7684\u200bVID\u200b\u4e3a\u200bPCI_VENDOR_ID_APPLE\u3001DID\u200b\u4e3a\u200b0x2001</li> </ul> <p></p>"},{"location":"10_PCI_PCIe/16_1/#2-pcie","title":"2. \u200b\u83b7\u5f97\u200bPCIe\u200b\u8bbe\u5907\u200b\u7684\u200b\u8d44\u6e90","text":"<p>PCIe\u200b\u63a7\u5236\u5668\u200b\u626b\u63cf\u200b\u51fa\u200bPCIe\u200b\u8bbe\u5907\u200b\u540e\u200b\uff0c\u200b\u4f1a\u4e3a\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u5206\u914d\u8d44\u6e90\u200b\u3001\u200b\u5e76\u200b\u8bb0\u5f55\u200b\u5728\u200b\u5bf9\u5e94\u200b\u7684\u200bpci_dev\u200b\u91cc\u200b\uff1a</p> <ul> <li>struct resource resource[DEVICE_COUNT_RESOURCE]\uff1a\u200b\u542b\u6709\u200bmem/io\u200b\u8d44\u6e90\u200b</li> <li>irq\uff1a\u200b\u542b\u6709\u200bINTx\u200b\u4e2d\u65ad\u200b\u53f7\u200b</li> </ul>"},{"location":"10_PCI_PCIe/16_1/#21-io","title":"2.1 \u200b\u83b7\u5f97\u200b\u5185\u5b58\u200b/IO\u200b\u7a7a\u95f4","text":"<p>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b\uff1a<code>kernel\\drivers\\scsi\\3w-9xxx.c</code></p> <p></p> <p>\u200b\u5224\u65ad\u200b\u8d44\u6e90\u7c7b\u578b\u200b\uff0c\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b\uff1a</p> <p></p>"},{"location":"10_PCI_PCIe/16_1/#22","title":"2.2 \u200b\u83b7\u5f97\u200b\u4e2d\u65ad\u200b\u53f7","text":""},{"location":"10_PCI_PCIe/16_1/#221-intx","title":"2.2.1 \u200b\u83b7\u5f97\u200bINTx\u200b\u4e2d\u65ad\u200b\u53f7","text":"<p>\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200bpci_dev-&gt;irq\u3002</p>"},{"location":"10_PCI_PCIe/16_1/#222-msi-xmsi","title":"2.2.2 \u200b\u83b7\u5f97\u200bMSI-X/MSI\u200b\u4e2d\u65ad\u200b\u53f7","text":"<p>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b\uff1a<code>drivers\\nvme\\host\\pci.c</code></p> <p></p>"},{"location":"10_PCI_PCIe/16_1/#3","title":"3. \u200b\u4f7f\u80fd\u200b\u8bbe\u5907","text":"<p>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b\uff1a<code>drivers\\nvme\\host\\pci.c</code></p> <p></p>"},{"location":"11_SPI/01_1/","title":"SPI\u200b\u89c6\u9891\u200b\u6982\u8ff0","text":""},{"location":"11_SPI/01_1/#1-spi","title":"1. SPI\u200b\u786c\u4ef6\u200b\u6846\u67b6","text":""},{"location":"11_SPI/01_1/#2-spi","title":"2. SPI\u200b\u89c6\u9891\u200b\u6d89\u53ca\u200b\u7684\u200b\u5185\u5bb9","text":"<ul> <li>SPI\u200b\u534f\u8bae\u200b</li> <li>SPI\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6\u200b</li> <li>SPI\u200b\u603b\u7ebf\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u6a21\u578b\u200b</li> <li>SPI\u200b\u8bbe\u5907\u200b\u6811\u200b\u5904\u7406\u8fc7\u7a0b\u200b</li> <li>\u200b\u7b80\u5355\u200b\u7684\u200bSPI\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b</li> <li>SPI ADC</li> <li>SPI OLED</li> <li> <p>\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200bspi dev\u200b\u9a71\u52a8\u200b</p> </li> <li> <p>\u200b\u590d\u6742\u200b\u7684\u200bSPI\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b</p> </li> <li>SPI+FrameBuffer</li> <li>SPI\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b</li> <li>\u200b\u4f7f\u7528\u200bGPIO\u200b\u5b9e\u73b0\u200b</li> <li> <p>\u200b\u5177\u4f53\u200b\u82af\u7247\u200b\u7684\u200bSPI\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b\u5206\u6790\u200b</p> </li> <li> <p>SPI\u200b\u8c03\u8bd5\u200b\u5de5\u5177\u200b</p> </li> <li>spi-tools</li> <li>\u200b\u9ad8\u6027\u80fd\u200b\uff1aQSPI</li> <li>\u200b\u4e3b\u63a7\u200b\u82af\u7247\u200b\u7528\u4f5c\u200bSPI\u200b\u4ece\u200b\u8bbe\u5907\u200b</li> </ul> <p>\u200b\u5f55\u5236\u200b\u89c6\u9891\u200b\u65f6\u200b\u7559\u610f\u200b\u8fd9\u4e9b\u200b\u77e5\u8bc6\u70b9\u200b\uff1a</p> <ul> <li>SPI3\u200b\u7ebf\u200b\u548c\u200bSPI4\u200b\u7ebf\u200b</li> <li>bits_per_word\u200b\u8bbe\u7f6e\u200b8\u200b\u548c\u200b16\u200b\u4f1a\u200b\u5f71\u54cd\u200b\u5230\u200b\u5565\u200b</li> <li>\u200b\u786c\u4ef6\u200b\u7247\u9009\u200b\u548c\u200b\u8f6f\u4ef6\u200b\u7247\u9009\u200b\u5728\u200b\u9a71\u52a8\u200b\u548b\u200b\u7528\u200b</li> </ul>"},{"location":"11_SPI/02_1/","title":"SPI\u200b\u534f\u8bae\u200b\u4ecb\u7ecd","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u300aSPI Block Guide V04.01.pdf\u300b</li> <li>\u300aS3C2440A_UserManual_Rev13.pdf\u300b</li> </ul>"},{"location":"11_SPI/02_1/#1-spi","title":"1. SPI\u200b\u786c\u4ef6\u200b\u77e5\u8bc6","text":""},{"location":"11_SPI/02_1/#11","title":"1.1 \u200b\u786c\u4ef6\u200b\u8fde\u7ebf","text":"<p> \u200b\u5f15\u811a\u200b\u542b\u4e49\u200b\u5982\u4e0b\u200b\uff1a</p> \u200b\u5f15\u811a\u200b \u200b\u542b\u4e49\u200b DO(MOSI) Master Output, Slave Input\uff0cSPI\u200b\u4e3b\u63a7\u200b\u7528\u6765\u200b\u53d1\u51fa\u200b\u6570\u636e\u200b\uff0cSPI\u200b\u4ece\u200b\u8bbe\u5907\u200b\u7528\u6765\u200b\u63a5\u6536\u6570\u636e\u200b DI(MISO) Master Input, Slave Output\uff0cSPI\u200b\u4e3b\u63a7\u200b\u7528\u6765\u200b\u53d1\u51fa\u200b\u6570\u636e\u200b\uff0cSPI\u200b\u4ece\u200b\u8bbe\u5907\u200b\u7528\u6765\u200b\u63a5\u6536\u6570\u636e\u200b SCK Serial Clock\uff0c\u200b\u65f6\u949f\u200b CS Chip Select\uff0c\u200b\u82af\u7247\u200b\u9009\u62e9\u200b\u5f15\u811a"},{"location":"11_SPI/02_1/#12-spi","title":"1.2 SPI\u200b\u63a7\u5236\u5668\u200b\u5185\u90e8\u7ed3\u6784","text":"<p>\u200b\u8fd9\u4e2a\u200b\u56fe\u200b\u7b49\u200b\u6211\u4eec\u200b\u770b\u200b\u5b8c\u200b\u540e\u9762\u200b\u7684\u200bSPI\u200b\u534f\u8bae\u200b\uff0c\u200b\u518d\u200b\u56de\u8fc7\u5934\u6765\u200b\u8bb2\u89e3\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/02_1/#2-spi","title":"2. SPI\u200b\u534f\u8bae","text":""},{"location":"11_SPI/02_1/#21","title":"2.1 \u200b\u4f20\u8f93\u200b\u793a\u4f8b","text":"<p>\u200b\u5047\u8bbe\u200b\u73b0\u5728\u200b\u4e3b\u63a7\u200b\u82af\u7247\u200b\u8981\u200b\u4f20\u8f93\u200b\u4e00\u4e2a\u200b0x56\u200b\u6570\u636e\u200b\u7ed9\u200bSPI Flash\uff0c\u200b\u65f6\u5e8f\u200b\u5982\u4e0b\u200b\uff1a  \u200b\u9996\u5148\u200bCS0\u200b\u5148\u62c9\u4f4e\u200b\u9009\u4e2d\u200bSPI Flash\uff0c0x56\u200b\u7684\u200b\u4e8c\u8fdb\u5236\u200b\u5c31\u662f\u200b0b0101 0110\uff0c\u200b\u56e0\u6b64\u200b\u5728\u200b\u6bcf\u4e2a\u200bSCK\u200b\u65f6\u949f\u200b\u5468\u671f\u200b\uff0cDO\u200b\u8f93\u51fa\u200b\u5bf9\u5e94\u200b\u7684\u200b\u7535\u5e73\u200b\u3002 SPI Flash\u200b\u4f1a\u200b\u5728\u200b\u6bcf\u4e2a\u200b\u65f6\u949f\u200b\u5468\u671f\u200b\u7684\u200b\u4e0a\u5347\u200b\u6cbf\u200b\u8bfb\u53d6\u200bD0\u200b\u4e0a\u200b\u7684\u200b\u7535\u5e73\u200b\u3002</p>"},{"location":"11_SPI/02_1/#22-spi","title":"2.2 SPI\u200b\u6a21\u5f0f","text":"<p>\u200b\u5728\u200bSPI\u200b\u534f\u8bae\u200b\u4e2d\u200b\uff0c\u200b\u6709\u200b\u4e24\u4e2a\u200b\u503c\u6765\u200b\u786e\u5b9a\u200bSPI\u200b\u7684\u200b\u6a21\u5f0f\u200b\u3002 CPOL:\u200b\u8868\u793a\u200bSPICLK\u200b\u7684\u200b\u521d\u59cb\u200b\u7535\u5e73\u200b\uff0c0\u200b\u4e3a\u200b\u7535\u5e73\u200b\uff0c1\u200b\u4e3a\u200b\u9ad8\u7535\u5e73\u200b CPHA:\u200b\u8868\u793a\u200b\u76f8\u4f4d\u200b\uff0c\u200b\u5373\u200b\u7b2c\u4e00\u4e2a\u200b\u8fd8\u662f\u200b\u7b2c\u4e8c\u4e2a\u200b\u65f6\u949f\u200b\u6cbf\u200b\u91c7\u6837\u200b\u6570\u636e\u200b\uff0c0\u200b\u4e3a\u200b\u7b2c\u4e00\u4e2a\u200b\u65f6\u949f\u200b\u6cbf\u200b\uff0c1\u200b\u4e3a\u200b\u7b2c\u4e8c\u4e2a\u200b\u65f6\u949f\u200b\u6cbf\u200b</p> CPOL CPHA \u200b\u6a21\u5f0f\u200b \u200b\u542b\u4e49\u200b 0 0 0 SPICLK\u200b\u521d\u59cb\u200b\u7535\u5e73\u200b\u4e3a\u200b\u4f4e\u7535\u5e73\u200b\uff0c\u200b\u5728\u200b\u7b2c\u4e00\u4e2a\u200b\u65f6\u949f\u200b\u6cbf\u200b\u91c7\u6837\u200b\u6570\u636e\u200b 0 1 1 SPICLK\u200b\u521d\u59cb\u200b\u7535\u5e73\u200b\u4e3a\u200b\u4f4e\u7535\u5e73\u200b\uff0c\u200b\u5728\u200b\u7b2c\u4e8c\u4e2a\u200b\u65f6\u949f\u200b\u6cbf\u200b\u91c7\u6837\u200b\u6570\u636e\u200b 1 0 2 SPICLK\u200b\u521d\u59cb\u200b\u7535\u5e73\u200b\u4e3a\u200b\u9ad8\u7535\u5e73\u200b\uff0c\u200b\u5728\u200b\u7b2c\u4e00\u4e2a\u200b\u65f6\u949f\u200b\u6cbf\u200b\u91c7\u6837\u200b\u6570\u636e\u200b 1 1 3 SPICLK\u200b\u521d\u59cb\u200b\u7535\u5e73\u200b\u4e3a\u200b\u9ad8\u7535\u5e73\u200b\uff0c\u200b\u5728\u200b\u7b2c\u4e8c\u4e2a\u200b\u65f6\u949f\u200b\u6cbf\u200b\u91c7\u6837\u200b\u6570\u636e\u200b \u200b\u6211\u4eec\u200b\u5e38\u7528\u200b\u7684\u200b\u662f\u200b\u6a21\u5f0f\u200b0\u200b\u548c\u200b\u6a21\u5f0f\u200b3\uff0c\u200b\u56e0\u4e3a\u200b\u5b83\u4eec\u200b\u90fd\u200b\u662f\u200b\u5728\u200b\u4e0a\u5347\u200b\u6cbf\u200b\u91c7\u6837\u200b\u6570\u636e\u200b\uff0c\u200b\u4e0d\u7528\u200b\u53bb\u200b\u5728\u4e4e\u200b\u65f6\u949f\u200b\u7684\u200b\u521d\u59cb\u200b\u7535\u5e73\u200b\u662f\u200b\u4ec0\u4e48\u200b\uff0c\u200b\u53ea\u8981\u200b\u5728\u200b\u4e0a\u5347\u200b\u6cbf\u200b\u91c7\u96c6\u200b\u6570\u636e\u200b\u5c31\u884c\u200b\u3002 <p>\u200b\u6781\u6027\u200b\u9009\u200b\u4ec0\u4e48\u200b\uff1f\u200b\u683c\u5f0f\u200b\u9009\u200b\u4ec0\u4e48\u200b\uff1f\u200b\u901a\u5e38\u200b\u53bb\u200b\u53c2\u8003\u200b\u5916\u63a5\u200b\u7684\u200b\u6a21\u5757\u200b\u7684\u200b\u82af\u7247\u200b\u624b\u518c\u200b\u3002\u200b\u6bd4\u5982\u200b\u5bf9\u4e8e\u200bOLED\uff0c\u200b\u67e5\u770b\u200b\u5b83\u200b\u7684\u200b\u82af\u7247\u200b\u624b\u518c\u200b\u65f6\u5e8f\u200b\u90e8\u5206\u200b\uff1a  SCLK\u200b\u7684\u200b\u521d\u59cb\u200b\u7535\u5e73\u200b\u6211\u4eec\u200b\u5e76\u4e0d\u9700\u8981\u200b\u5173\u5fc3\u200b\uff0c\u200b\u53ea\u8981\u200b\u4fdd\u8bc1\u200b\u5728\u200b\u4e0a\u5347\u200b\u6cbf\u200b\u91c7\u6837\u200b\u6570\u636e\u200b\u5c31\u884c\u200b\u3002</p>"},{"location":"11_SPI/03_1/","title":"SPI\u200b\u603b\u7ebf\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u6a21\u578b","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>\u200b\u5185\u6838\u200b\u5934\u6587\u4ef6\u200b\uff1a<code>include\\linux\\spi\\spi.h</code></p> </li> <li> <p>\u200b\u767e\u95ee\u200b\u7f51\u200b\u9a71\u52a8\u200b\u76f4\u64ad\u200b\u8bfe\u91cc\u200b\u5bf9\u5e94\u200b\u7684\u200b\u6e90\u7801\u200b</p> </li> <li>GIT\u200b\u4ed3\u5e93\u200b\uff1ahttps://e.coding.net/weidongshan/livestream/doc_and_source_for_livestream.git</li> <li> <p>\u200b\u6e90\u7801\u200b\u4f4d\u7f6e\u200b\uff1a     </p> </li> <li> <p>\u200b\u4e0a\u8ff0\u200b\u6e90\u7801\u200b\u4e5f\u200b\u653e\u5230\u200b\u4e86\u200b\u9a71\u52a8\u200b\u5927\u5168\u200b\u7684\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff0c\u200b\u4f4d\u7f6e\u200b\u5982\u4e0b\u200b\uff1a   </p> </li> </ul>"},{"location":"11_SPI/03_1/#1","title":"1. \u200b\u56de\u987e\u200b\u5e73\u53f0\u200b\u603b\u7ebf\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u6a21\u578b","text":"<p>Linux\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5f00\u59cb\u200b\u57fa\u4e8e\u200b\"\u200b\u5e73\u53f0\u200b\u603b\u7ebf\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\"\u200b\u6a21\u578b\u200b\uff0c\u200b\u628a\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5206\u6210\u200b2\u200b\u8fb9\u200b\uff1a</p> <ul> <li> <p>\u200b\u5de6\u8fb9\u200b\u6ce8\u518c\u200b\u4e00\u4e2a\u200bplatform_driver\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u91cc\u9762\u200b\u662f\u200b\u6bd4\u8f83\u200b\u56fa\u5b9a\u200b\u7684\u200b\u3001\u200b\u901a\u7528\u200b\u7684\u200b\u4ee3\u7801\u200b</p> </li> <li> <p>\u200b\u53f3\u8fb9\u200b\u6ce8\u518c\u200b\u4e00\u4e2a\u200bplatform_device\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u91cc\u9762\u200b\u662f\u200b\u786c\u4ef6\u8d44\u6e90\u200b</p> </li> <li> <p>\u200b\u53ef\u4ee5\u200b\u5728\u200bC\u200b\u6587\u4ef6\u200b\u4e2d\u200b\u6ce8\u518c\u200bplatform_device</p> </li> <li>\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u8bbe\u5907\u200b\u6811\u200b\u521b\u5efa\u200b\u4e00\u4e2a\u200b\u8282\u70b9\u200b\uff0c\u200b\u5185\u6838\u200b\u89e3\u6790\u200b\u8bbe\u5907\u200b\u6811\u65f6\u200b\u6ce8\u518c\u200bplatform_device</li> </ul> <p></p>"},{"location":"11_SPI/03_1/#2","title":"2. \u200b\u6570\u636e\u7ed3\u6784","text":"<p>SPI\u200b\u5b50\u7cfb\u7edf\u200b\u4e2d\u200b\u6d89\u53ca\u200b2\u200b\u7c7b\u200b\u786c\u4ef6\u200b\uff1aSPI\u200b\u63a7\u5236\u5668\u200b\u3001SPI\u200b\u8bbe\u5907\u200b\u3002</p> <p></p> <p>SPI\u200b\u63a7\u5236\u5668\u200b\u6709\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u63d0\u4f9b\u200bSPI\u200b\u7684\u200b\u4f20\u8f93\u200b\u80fd\u529b\u200b\u3002</p> <p>SPI\u200b\u8bbe\u5907\u200b\u4e5f\u200b\u6709\u200b\u81ea\u5df1\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u63d0\u4f9b\u200bSPI\u200b\u8bbe\u5907\u200b\u7684\u200b\u8bbf\u95ee\u200b\u80fd\u529b\u200b\uff1a</p> <ul> <li>\u200b\u5b83\u200b\u77e5\u9053\u200b\u600e\u4e48\u200b\u8bbf\u95ee\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5b83\u200b\u77e5\u9053\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u7684\u200b\u6570\u636e\u200b\u542b\u4e49\u200b\u662f\u200b\u4ec0\u4e48\u200b</li> <li>\u200b\u5b83\u4f1a\u200b\u8c03\u7528\u200bSPI\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u51fd\u6570\u200b\u6765\u200b\u6536\u53d1\u200b\u6570\u636e\u200b\u3002</li> </ul>"},{"location":"11_SPI/03_1/#21-spi","title":"2.1 SPI\u200b\u63a7\u5236\u5668\u200b\u6570\u636e\u7ed3\u6784","text":"<p>\u200b\u53c2\u8003\u200b\u5185\u6838\u200b\u6587\u4ef6\u200b\uff1a<code>include\\linux\\spi\\spi.h</code></p> <p>Linux\u200b\u4e2d\u200b\u4f7f\u7528\u200bspi_master\u200b\u7ed3\u6784\u200b\u4f53\u200b\u63cf\u8ff0\u200bSPI\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u91cc\u9762\u200b\u6700\u200b\u91cd\u8981\u200b\u7684\u200b\u6210\u5458\u200b\u5c31\u662f\u200b<code>transfer</code>\u200b\u51fd\u6570\u6307\u9488\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/03_1/#22-spi","title":"2.2 SPI\u200b\u8bbe\u5907\u200b\u6570\u636e\u7ed3\u6784","text":"<p>\u200b\u53c2\u8003\u200b\u5185\u6838\u200b\u6587\u4ef6\u200b\uff1a<code>include\\linux\\spi\\spi.h</code></p> <p>Linux\u200b\u4e2d\u200b\u4f7f\u7528\u200bspi_device\u200b\u7ed3\u6784\u200b\u4f53\u200b\u63cf\u8ff0\u200bSPI\u200b\u8bbe\u5907\u200b\uff0c\u200b\u91cc\u9762\u200b\u8bb0\u5f55\u200b\u6709\u200b\u8bbe\u5907\u200b\u7684\u200b\u7247\u9009\u200b\u5f15\u811a\u200b\u3001\u200b\u9891\u7387\u200b\u3001\u200b\u6302\u200b\u5728\u200b\u54ea\u4e2a\u200bSPI\u200b\u63a7\u5236\u5668\u200b\u4e0b\u9762\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/03_1/#23-spi","title":"2.3 SPI\u200b\u8bbe\u5907\u200b\u9a71\u52a8","text":"<p>\u200b\u53c2\u8003\u200b\u5185\u6838\u200b\u6587\u4ef6\u200b\uff1a<code>include\\linux\\spi\\spi.h</code></p> <p>Linux\u200b\u4e2d\u200b\u4f7f\u7528\u200bspi_driver\u200b\u7ed3\u6784\u200b\u4f53\u200b\u63cf\u8ff0\u200bSPI\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/03_1/#3-spi","title":"3. SPI\u200b\u9a71\u52a8\u200b\u6846\u67b6","text":""},{"location":"11_SPI/03_1/#31-spi","title":"3.1 SPI\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f","text":"<p>SPI\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u53ef\u4ee5\u200b\u57fa\u4e8e\u200b\"\u200b\u5e73\u53f0\u200b\u603b\u7ebf\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\"\u200b\u6a21\u578b\u200b\u6765\u200b\u5b9e\u73b0\u200b\uff1a</p> <ul> <li>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u63cf\u8ff0\u200bSPI\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u786c\u4ef6\u200b\u4fe1\u606f\u200b\uff0c\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u5b50\u200b\u8282\u70b9\u200b\u91cc\u200b\u63cf\u8ff0\u200b\u6302\u200b\u5728\u200b\u4e0b\u9762\u200b\u7684\u200bSPI\u200b\u8bbe\u5907\u200b\u7684\u200b\u4fe1\u606f\u200b</li> <li>\u200b\u5728\u200bplatform_driver\u200b\u4e2d\u200b\u63d0\u4f9b\u200b\u4e00\u4e2a\u200bprobe\u200b\u51fd\u6570\u200b</li> <li>\u200b\u5b83\u4f1a\u200b\u6ce8\u518c\u200b\u4e00\u4e2a\u200bspi_master</li> <li>\u200b\u8fd8\u4f1a\u200b\u89e3\u6790\u200b\u8bbe\u5907\u200b\u6811\u5b50\u200b\u8282\u70b9\u200b\uff0c\u200b\u521b\u5efa\u200bspi_device\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> </ul>"},{"location":"11_SPI/03_1/#32-spi","title":"3.2 SPI\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>\u200b\u8ddf\u200b\"\u200b\u5e73\u53f0\u200b\u603b\u7ebf\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u6a21\u578b\u200b\"\u200b\u7c7b\u4f3c\u200b\uff0cLinux\u200b\u4e2d\u200b\u4e5f\u200b\u6709\u200b\u4e00\u4e2a\u200b\"SPI\u200b\u603b\u7ebf\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u6a21\u578b\u200b\"\uff1a</p> <ul> <li>\u200b\u5de6\u8fb9\u200b\u662f\u200bspi_driver\uff0c\u200b\u4f7f\u7528\u200bC\u200b\u6587\u4ef6\u200b\u5b9e\u73b0\u200b\uff0c\u200b\u91cc\u9762\u200b\u6709\u200bid_table\u200b\u8868\u793a\u200b\u80fd\u200b\u652f\u6301\u200b\u54ea\u4e9b\u200bSPI\u200b\u8bbe\u5907\u200b\uff0c\u200b\u6709\u200bprobe\u200b\u51fd\u6570\u200b</li> <li>\u200b\u53f3\u8fb9\u200b\u662f\u200bspi_device\uff0c\u200b\u7528\u6765\u200b\u63cf\u8ff0\u200bSPI\u200b\u8bbe\u5907\u200b\uff0c\u200b\u6bd4\u5982\u200b\u5b83\u200b\u7684\u200b\u7247\u9009\u200b\u5f15\u811a\u200b\u3001\u200b\u9891\u7387\u200b</li> <li>\u200b\u53ef\u4ee5\u200b\u6765\u81ea\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a\u200b\u6bd4\u5982\u200b\u7531\u200bSPI\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f\u200b\u89e3\u6790\u200b\u8bbe\u5907\u200b\u6811\u540e\u200b\u521b\u5efa\u200b\u3001\u200b\u6ce8\u518c\u200bspi_device</li> <li>\u200b\u53ef\u4ee5\u200b\u6765\u81ea\u200bC\u200b\u6587\u4ef6\u200b\uff1a\u200b\u6bd4\u5982\u200b\u4f7f\u7528\u200b<code>spi_register_board_info</code>\u200b\u521b\u5efa\u200b\u3001\u200b\u6ce8\u518c\u200bspi_device</li> </ul>"},{"location":"11_SPI/04_1/","title":"SPI\u200b\u8bbe\u5907\u200b\u6811\u200b\u5904\u7406\u8fc7\u7a0b","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u200b\u5185\u6838\u200b\u5934\u6587\u4ef6\u200b\uff1a<code>include\\linux\\spi\\spi.h</code></li> <li>\u200b\u5185\u6838\u200b\u6587\u6863\u200b\uff1a<code>Documentation\\devicetree\\bindings\\spi\\spi-bus.txt</code> </li> <li>\u200b\u5185\u6838\u200b\u6e90\u7801\u200b\uff1a<code>drivers\\spi\\spi.c</code></li> </ul>"},{"location":"11_SPI/04_1/#1-spi_device","title":"1. spi_device\u200b\u7ed3\u6784\u200b\u4f53","text":"<pre><code>/**\n * struct spi_device - Master side proxy for an SPI slave device\n * @dev: Driver model representation of the device.\n * @master: SPI controller used with the device.\n * @max_speed_hz: Maximum clock rate to be used with this chip\n *  (on this board); may be changed by the device's driver.\n *  The spi_transfer.speed_hz can override this for each transfer.\n * @chip_select: Chipselect, distinguishing chips handled by @master.\n * @mode: The spi mode defines how data is clocked out and in.\n *  This may be changed by the device's driver.\n *  The \"active low\" default for chipselect mode can be overridden\n *  (by specifying SPI_CS_HIGH) as can the \"MSB first\" default for\n *  each word in a transfer (by specifying SPI_LSB_FIRST).\n * @bits_per_word: Data transfers involve one or more words; word sizes\n *  like eight or 12 bits are common.  In-memory wordsizes are\n *  powers of two bytes (e.g. 20 bit samples use 32 bits).\n *  This may be changed by the device's driver, or left at the\n *  default (0) indicating protocol words are eight bit bytes.\n *  The spi_transfer.bits_per_word can override this for each transfer.\n * @irq: Negative, or the number passed to request_irq() to receive\n *  interrupts from this device.\n * @controller_state: Controller's runtime state\n * @controller_data: Board-specific definitions for controller, such as\n *  FIFO initialization parameters; from board_info.controller_data\n * @modalias: Name of the driver to use with this device, or an alias\n *  for that name.  This appears in the sysfs \"modalias\" attribute\n *  for driver coldplugging, and in uevents used for hotplugging\n * @cs_gpio: gpio number of the chipselect line (optional, -ENOENT when\n *  when not using a GPIO line)\n *\n * @statistics: statistics for the spi_device\n *\n * A @spi_device is used to interchange data between an SPI slave\n * (usually a discrete chip) and CPU memory.\n *\n * In @dev, the platform_data is used to hold information about this\n * device that's meaningful to the device's protocol driver, but not\n * to its controller.  One example might be an identifier for a chip\n * variant with slightly different functionality; another might be\n * information about how this particular board wires the chip's pins.\n */\nstruct spi_device {\n    struct device       dev;\n    struct spi_master   *master;\n    u32         max_speed_hz;\n    u8          chip_select;\n    u8          bits_per_word;\n    u16         mode;\n#define SPI_CPHA    0x01            /* clock phase */\n#define SPI_CPOL    0x02            /* clock polarity */\n#define SPI_MODE_0  (0|0)           /* (original MicroWire) */\n#define SPI_MODE_1  (0|SPI_CPHA)\n#define SPI_MODE_2  (SPI_CPOL|0)\n#define SPI_MODE_3  (SPI_CPOL|SPI_CPHA)\n#define SPI_CS_HIGH 0x04            /* chipselect active high? */\n#define SPI_LSB_FIRST   0x08            /* per-word bits-on-wire */\n#define SPI_3WIRE   0x10            /* SI/SO signals shared */\n#define SPI_LOOP    0x20            /* loopback mode */\n#define SPI_NO_CS   0x40            /* 1 dev/bus, no chipselect */\n#define SPI_READY   0x80            /* slave pulls low to pause */\n#define SPI_TX_DUAL 0x100           /* transmit with 2 wires */\n#define SPI_TX_QUAD 0x200           /* transmit with 4 wires */\n#define SPI_RX_DUAL 0x400           /* receive with 2 wires */\n#define SPI_RX_QUAD 0x800           /* receive with 4 wires */\n    int         irq;\n    void            *controller_state;\n    void            *controller_data;\n    char            modalias[SPI_NAME_SIZE];\n    int         cs_gpio;    /* chip select gpio */\n\n    /* the statistics */\n    struct spi_statistics   statistics;\n\n    /*\n     * likely need more hooks for more protocol options affecting how\n     * the controller talks to each chip, like:\n     *  - memory packing (12 bit samples into low bits, others zeroed)\n     *  - priority\n     *  - drop chipselect after each word\n     *  - chipselect delays\n     *  - ...\n     */\n};\n</code></pre> <p>\u200b\u5404\u4e2a\u200b\u6210\u5458\u200b\u542b\u4e49\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>max_speed_hz\uff1a\u200b\u8be5\u200b\u8bbe\u5907\u200b\u80fd\u200b\u652f\u6301\u200b\u7684\u200bSPI\u200b\u65f6\u949f\u200b\u6700\u5927\u503c\u200b</li> <li>chip_select\uff1a\u200b\u662f\u200b\u8fd9\u4e2a\u200bspi_master\u200b\u4e0b\u200b\u7684\u200b\u7b2c\u51e0\u4e2a\u200b\u8bbe\u5907\u200b</li> <li>\u200b\u5728\u200bspi_master\u200b\u4e2d\u6709\u200b\u4e00\u4e2a\u200bcs_gpios\u200b\u6570\u7ec4\u200b\uff0c\u200b\u91cc\u9762\u200b\u5b58\u653e\u200b\u6709\u200b\u4e0b\u9762\u200b\u5404\u4e2a\u200bspi\u200b\u8bbe\u5907\u200b\u7684\u200b\u7247\u9009\u200b\u5f15\u811a\u200b</li> <li>spi_device\u200b\u7684\u200b\u7247\u9009\u200b\u5f15\u811a\u200b\u5c31\u662f\u200b\uff1acs_gpios[spi_device.chip_select]</li> <li>cs_gpio\uff1a\u200b\u8fd9\u662f\u200b\u53ef\u9009\u9879\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u628a\u200bspi_device\u200b\u7684\u200b\u7247\u9009\u200b\u5f15\u811a\u200b\u8bb0\u5f55\u200b\u5728\u200b\u8fd9\u91cc\u200b</li> <li>bits_per_word\uff1a\u200b\u6bcf\u4e2a\u200b\u57fa\u672c\u200b\u7684\u200bSPI\u200b\u4f20\u8f93\u200b\u6d89\u53ca\u200b\u591a\u5c11\u200b\u4f4d\u200b</li> <li>word\uff1a\u200b\u6211\u4eec\u200b\u4f7f\u7528\u200bSPI\u200b\u63a7\u5236\u5668\u200b\u65f6\u200b\uff0c\u200b\u4e00\u822c\u200b\u662f\u200b\u5f80\u200b\u67d0\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\u91cc\u200b\u5199\u5165\u200b\u6570\u636e\u200b\uff0cSPI\u200b\u63a7\u5236\u5668\u200b\u5c31\u200b\u4f1a\u200b\u628a\u200b\u8fd9\u4e9b\u200b\u6570\u636e\u200b\u4e00\u4f4d\u200b\u4e00\u4f4d\u200b\u5730\u200b\u53d1\u9001\u200b\u51fa\u53bb\u200b</li> <li>\u200b\u4e00\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\u662f\u200b32\u200b\u4f4d\u200b\u7684\u200b\uff0c\u200b\u88ab\u200b\u79f0\u4e3a\u200b\u4e00\u4e2a\u200bword(\u200b\u6709\u65f6\u5019\u200b\u4e5f\u200b\u79f0\u4e3a\u200bdouble word)</li> <li>\u200b\u8fd9\u4e2a\u200b\u5bc4\u5b58\u5668\u200b\u91cc\u200b\u591a\u5c11\u200b\u4f4d\u4f1a\u200b\u88ab\u200b\u53d1\u9001\u200b\u51fa\u53bb\u200b\uff1f\u200b\u4f7f\u7528\u200bbits_per_word\u200b\u6765\u200b\u8868\u793a\u200b</li> <li>\u200b\u6269\u5c55\u200b\uff1abits_per_word\u200b\u662f\u200b\u53ef\u4ee5\u200b\u5927\u4e8e\u200b32\u200b\u7684\u200b\uff0c\u200b\u4e5f\u200b\u5c31\u662f\u200b\u6bcf\u6b21\u200bSPI\u200b\u4f20\u8f93\u200b\u53ef\u80fd\u200b\u4f1a\u200b\u53d1\u9001\u200b\u591a\u4e8e\u200b32\u200b\u4f4d\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u8fd9\u200b\u9002\u7528\u200b\u4e8e\u200bDMA\u200b\u7a81\u53d1\u200b\u4f20\u8f93\u200b</li> <li>mode\uff1a\u200b\u542b\u4e49\u200b\u5e7f\u6cdb\u200b\uff0c\u200b\u770b\u770b\u200b\u7ed3\u6784\u200b\u4f53\u91cc\u200b\u90a3\u4e9b\u200b\u5b8f\u200b</li> <li>SPI_CPHA\uff1a\u200b\u5728\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u5468\u671f\u200b\u91c7\u6837\u200b\uff0c\u200b\u5728\u200b\u7b2c\u200b2\u200b\u4e2a\u200b\u5468\u671f\u200b\u91c7\u6837\u200b\uff1f</li> <li>SPI_CPOL\uff1a\u200b\u5e73\u65f6\u200b\u65f6\u949f\u200b\u6781\u6027\u200b<ul> <li>SPI_CPHA\u200b\u548c\u200bSPI_CPOL\u200b\u7ec4\u5408\u200b\u8d77\u6765\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b4\u200b\u79cd\u200b\u6a21\u5f0f\u200b</li> <li>SPI_MODE_0\uff1a\u200b\u5e73\u65f6\u200bSCK\u200b\u4e3a\u200b\u4f4e\u200b(SPI_CPOL\u200b\u4e3a\u200b0)\uff0c\u200b\u5728\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u5468\u671f\u200b\u91c7\u6837\u200b(SPI_CPHA\u200b\u4e3a\u200b0)</li> <li>SPI_MODE_1\uff1a\u200b\u5e73\u65f6\u200bSCK\u200b\u4e3a\u200b\u4f4e\u200b(SPI_CPOL\u200b\u4e3a\u200b0)\uff0c\u200b\u5728\u200b\u7b2c\u200b2\u200b\u4e2a\u200b\u5468\u671f\u200b\u91c7\u6837\u200b(SPI_CPHA\u200b\u4e3a\u200b1)</li> <li>SPI_MODE_2\uff1a\u200b\u5e73\u65f6\u200bSCK\u200b\u4e3a\u200b\u9ad8\u200b(SPI_CPOL\u200b\u4e3a\u200b1)\uff0c\u200b\u5728\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u5468\u671f\u200b\u91c7\u6837\u200b(SPI_CPHA\u200b\u4e3a\u200b0)</li> <li>SPI_MODE_3\uff1a\u200b\u5e73\u65f6\u200bSCK\u200b\u4e3a\u200b\u9ad8\u200b(SPI_CPOL\u200b\u4e3a\u200b1)\uff0c\u200b\u5728\u200b\u7b2c\u200b2\u200b\u4e2a\u200b\u5468\u671f\u200b\u91c7\u6837\u200b(SPI_CPHA\u200b\u4e3a\u200b1)</li> </ul> </li> <li>SPI_CS_HIGH\uff1a\u200b\u4e00\u822c\u6765\u8bf4\u200b\u7247\u9009\u200b\u5f15\u811a\u200b\u65f6\u200b\u4f4e\u7535\u5e73\u200b\u6709\u6548\u200b\uff0cSPI_CS_HIGH\u200b\u8868\u793a\u200b\u9ad8\u7535\u5e73\u200b\u6709\u6548\u200b</li> <li>SPI_LSB_FIRST\uff1a<ul> <li>\u200b\u4e00\u822c\u6765\u8bf4\u200b\u5148\u200b\u4f20\u8f93\u200bMSB(\u200b\u6700\u9ad8\u200b\u4f4d\u200b)\uff0cSPI_LSB_FIRST\u200b\u8868\u793a\u200b\u5148\u4f20\u200bLSB(\u200b\u6700\u4f4e\u200b\u4f4d\u200b)\uff1b</li> <li>\u200b\u5f88\u591a\u200bSPI\u200b\u63a7\u5236\u5668\u200b\u5e76\u200b\u4e0d\u200b\u652f\u6301\u200bSPI_LSB_FIRST</li> </ul> </li> <li>SPI_3WIRE\uff1aSO\u3001SI\u200b\u5171\u7528\u200b\u4e00\u6761\u7ebf\u200b</li> <li>SPI_LOOP\uff1a\u200b\u56de\u73af\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u5c31\u662f\u200bSO\u3001SI\u200b\u8fde\u63a5\u200b\u5728\u200b\u4e00\u8d77\u200b</li> <li>SPI_NO_CS\uff1a\u200b\u53ea\u6709\u200b\u4e00\u4e2a\u200bSPI\u200b\u8bbe\u5907\u200b\uff0c\u200b\u6ca1\u6709\u200b\u7247\u9009\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u4e5f\u200b\u4e0d\u200b\u9700\u8981\u200b\u7247\u9009\u200b\u4fe1\u53f7\u200b</li> <li>SPI_READY\uff1aSPI\u200b\u4ece\u200b\u8bbe\u5907\u200b\u53ef\u4ee5\u200b\u62c9\u4f4e\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u8868\u793a\u200b\u6682\u505c\u200b\u3001\u200b\u8868\u793a\u200b\u672a\u200b\u5c31\u7eea\u200b</li> <li>SPI_TX_DUAL\uff1a\u200b\u53d1\u9001\u6570\u636e\u200b\u65f6\u6709\u200b2\u200b\u6761\u200b\u4fe1\u53f7\u7ebf\u200b</li> <li>SPI_TX_QUAD\uff1a\u200b\u53d1\u9001\u6570\u636e\u200b\u65f6\u6709\u200b4\u200b\u6761\u200b\u4fe1\u53f7\u7ebf\u200b</li> <li>SPI_RX_DUAL\uff1a\u200b\u63a5\u6536\u6570\u636e\u200b\u65f6\u6709\u200b2\u200b\u6761\u200b\u4fe1\u53f7\u7ebf\u200b</li> <li>SPI_RX_QUAD\uff1a\u200b\u63a5\u6536\u6570\u636e\u200b\u65f6\u6709\u200b4\u200b\u6761\u200b\u4fe1\u53f7\u7ebf\u200b</li> </ul>"},{"location":"11_SPI/04_1/#2-spi","title":"2. SPI\u200b\u8bbe\u5907\u200b\u6811\u200b\u683c\u5f0f","text":"<p>\u200b\u5bf9\u4e8e\u200bSPI Master\uff0c\u200b\u5c31\u662f\u200bSPI\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u5b83\u200b\u4e0b\u9762\u200b\u53ef\u4ee5\u200b\u8fde\u63a5\u200b\u591a\u4e2a\u200bSPI\u200b\u8bbe\u5907\u200b\u3002</p> <p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\uff0c\u200b\u4f7f\u7528\u200b\u4e00\u4e2a\u200b\u8282\u70b9\u200b\u6765\u200b\u8868\u793a\u200bSPI Master\uff0c\u200b\u4f7f\u7528\u200b\u5b50\u200b\u8282\u70b9\u200b\u6765\u200b\u8868\u793a\u200b\u6302\u200b\u5728\u200b\u4e0b\u9762\u200b\u7684\u200bSPI\u200b\u8bbe\u5907\u200b\u3002</p>"},{"location":"11_SPI/04_1/#21-spi-master","title":"2.1 SPI Master","text":"<p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\uff0c\u200b\u5bf9\u4e8e\u200bSPI Master\uff0c\u200b\u5fc5\u987b\u200b\u7684\u200b\u5c5e\u6027\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>compatible\uff1a\u200b\u6839\u636e\u200b\u5b83\u200b\u627e\u5230\u200bSPI Master\u200b\u9a71\u52a8\u200b</li> </ul> <p>\u200b\u53ef\u9009\u200b\u7684\u200b\u5c5e\u6027\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>cs-gpios\uff1aSPI Master\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u591a\u4e2a\u200bGPIO\u200b\u5f53\u505a\u200b\u7247\u9009\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u5c5e\u6027\u200b\u5217\u51fa\u200b\u90a3\u4e9b\u200bGPIO</li> <li>num-cs\uff1a\u200b\u7247\u9009\u200b\u5f15\u811a\u200b\u603b\u6570\u200b</li> </ul> <p>\u200b\u5176\u4ed6\u200b\u5c5e\u6027\u200b\u90fd\u200b\u662f\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u76f8\u5173\u200b\u7684\u200b\uff0c\u200b\u4e0d\u540c\u200b\u7684\u200bSPI Master\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u8981\u6c42\u200b\u7684\u200b\u5c5e\u6027\u200b\u53ef\u80fd\u200b\u4e0d\u200b\u4e00\u6837\u200b\u3002</p>"},{"location":"11_SPI/04_1/#address-cellsspi-masterspicell","title":"address-cells\uff1a\u200b\u8fd9\u4e2a\u200bSPI Master\u200b\u4e0b\u200b\u7684\u200bSPI\u200b\u8bbe\u5907\u200b\uff0c\u200b\u9700\u8981\u200b\u591a\u5c11\u200b\u4e2a\u200bcell\u200b\u6765\u200b\u8868\u8ff0\u200b\u5b83\u200b\u7684\u200b\u7247\u9009\u200b\u5f15\u811a","text":""},{"location":"11_SPI/04_1/#size-cells0","title":"size-cells\uff1a\u200b\u5fc5\u987b\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b0","text":""},{"location":"11_SPI/04_1/#22-spi-device","title":"2.2 SPI Device","text":"<p>\u200b\u5728\u200bSPI Master\u200b\u5bf9\u5e94\u200b\u7684\u200b\u8bbe\u5907\u200b\u6811\u200b\u8282\u70b9\u200b\u4e0b\u200b\uff0c\u200b\u6bcf\u200b\u4e00\u4e2a\u200b\u5b50\u200b\u8282\u70b9\u200b\u90fd\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200bSPI\u200b\u8bbe\u5907\u200b\uff0c\u200b\u8fd9\u4e2a\u200bSPI\u200b\u8bbe\u5907\u200b\u8fde\u63a5\u200b\u5728\u200b\u8be5\u200bSPI Master\u200b\u4e0b\u9762\u200b\u3002</p> <p>\u200b\u8fd9\u4e9b\u200b\u5b50\u200b\u8282\u70b9\u200b\u4e2d\u200b\uff0c\u200b\u5fc5\u9009\u200b\u7684\u200b\u5c5e\u6027\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>compatible\uff1a\u200b\u6839\u636e\u200b\u5b83\u200b\u627e\u5230\u200bSPI Device\u200b\u9a71\u52a8\u200b</li> <li>reg\uff1a\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u5b83\u200b\u4f7f\u7528\u200b\u54ea\u4e2a\u200b\u7247\u9009\u200b\u5f15\u811a\u200b</li> <li>spi-max-frequency\uff1a\u200b\u5fc5\u9009\u200b\uff0c\u200b\u8be5\u200bSPI\u200b\u8bbe\u5907\u200b\u652f\u6301\u200b\u7684\u200b\u6700\u5927\u200bSPI\u200b\u65f6\u949f\u200b</li> </ul> <p>\u200b\u53ef\u9009\u200b\u7684\u200b\u5c5e\u6027\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>spi-cpol\uff1a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u7a7a\u200b\u5c5e\u6027\u200b(\u200b\u6ca1\u6709\u200b\u503c\u200b)\uff0c\u200b\u8868\u793a\u200bCPOL\u200b\u4e3a\u200b1\uff0c\u200b\u5373\u200b\u5e73\u65f6\u200bSPI\u200b\u65f6\u949f\u200b\u4e3a\u200b\u4f4e\u7535\u5e73\u200b</li> <li>spi-cpha\uff1a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u7a7a\u200b\u5c5e\u6027\u200b(\u200b\u6ca1\u6709\u200b\u503c\u200b)\uff0c\u200b\u8868\u793a\u200bCPHA\u200b\u4e3a\u200b1)\uff0c\u200b\u5373\u200b\u5728\u200b\u65f6\u949f\u200b\u7684\u200b\u7b2c\u200b2\u200b\u4e2a\u200b\u8fb9\u6cbf\u200b\u91c7\u6837\u200b\u6570\u636e\u200b</li> <li>spi-cs-high\uff1a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u7a7a\u200b\u5c5e\u6027\u200b(\u200b\u6ca1\u6709\u200b\u503c\u200b)\uff0c\u200b\u8868\u793a\u200b\u7247\u9009\u200b\u5f15\u811a\u200b\u9ad8\u7535\u5e73\u200b\u6709\u6548\u200b</li> <li>spi-3wire\uff1a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u7a7a\u200b\u5c5e\u6027\u200b(\u200b\u6ca1\u6709\u200b\u503c\u200b)\uff0c\u200b\u8868\u793a\u200b\u4f7f\u7528\u200bSPI \u200b\u4e09\u7ebf\u200b\u6a21\u5f0f\u200b</li> <li>spi-lsb-first\uff1a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u7a7a\u200b\u5c5e\u6027\u200b(\u200b\u6ca1\u6709\u200b\u503c\u200b)\uff0c\u200b\u8868\u793a\u200b\u4f7f\u7528\u200bSPI\u200b\u4f20\u8f93\u6570\u636e\u200b\u65f6\u5148\u200b\u4f20\u8f93\u200b\u6700\u4f4e\u200b\u4f4d\u200b(LSB)</li> <li>spi-tx-bus-width\uff1a\u200b\u8868\u793a\u200b\u6709\u200b\u51e0\u6761\u200bMOSI\u200b\u5f15\u811a\u200b\uff1b\u200b\u6ca1\u6709\u200b\u8fd9\u4e2a\u200b\u5c5e\u6027\u200b\u65f6\u200b\u9ed8\u8ba4\u200b\u53ea\u6709\u200b1\u200b\u6761\u200bMOSI\u200b\u5f15\u811a\u200b</li> <li>spi-rx-bus-width\uff1a\u200b\u8868\u793a\u200b\u6709\u200b\u51e0\u6761\u200bMISO\u200b\u5f15\u811a\u200b\uff1b\u200b\u6ca1\u6709\u200b\u8fd9\u4e2a\u200b\u5c5e\u6027\u200b\u65f6\u200b\u9ed8\u8ba4\u200b\u53ea\u6709\u200b1\u200b\u6761\u200bMISO\u200b\u5f15\u811a\u200b</li> <li>spi-rx-delay-us\uff1a\u200b\u5355\u4f4d\u200b\u662f\u200b\u6beb\u79d2\u200b\uff0c\u200b\u8868\u793a\u200b\u6bcf\u6b21\u200b\u8bfb\u200b\u4f20\u8f93\u200b\u540e\u8981\u200b\u5ef6\u65f6\u200b\u591a\u4e45\u200b</li> <li>spi-tx-delay-us\uff1a\u200b\u5355\u4f4d\u200b\u662f\u200b\u6beb\u79d2\u200b\uff0c\u200b\u8868\u793a\u200b\u6bcf\u6b21\u200b\u5199\u200b\u4f20\u8f93\u200b\u540e\u8981\u200b\u5ef6\u65f6\u200b\u591a\u4e45\u200b</li> </ul>"},{"location":"11_SPI/04_1/#23","title":"2.3 \u200b\u8bbe\u5907\u200b\u6811\u200b\u793a\u4f8b","text":"<pre><code>    spi@f00 {\n        #address-cells = &lt;1&gt;;\n        #size-cells = &lt;0&gt;;\n        compatible = \"fsl,mpc5200b-spi\",\"fsl,mpc5200-spi\";\n        reg = &lt;0xf00 0x20&gt;;\n        interrupts = &lt;2 13 0 2 14 0&gt;;\n        interrupt-parent = &lt;&amp;mpc5200_pic&gt;;\n\n        ethernet-switch@0 {\n            compatible = \"micrel,ks8995m\";\n            spi-max-frequency = &lt;1000000&gt;;\n            reg = &lt;0&gt;;\n        };\n\n        codec@1 {\n            compatible = \"ti,tlv320aic26\";\n            spi-max-frequency = &lt;100000&gt;;\n            reg = &lt;1&gt;;\n        };\n    };\n</code></pre>"},{"location":"11_SPI/04_1/#3","title":"3. \u200b\u8bbe\u5907\u200b\u6811\u200b\u5b9e\u4f8b","text":"<p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\uff0c\u200b\u4f1a\u200b\u6709\u200b\u4e00\u4e2a\u200b\u8282\u70b9\u200b\u7528\u6765\u200b\u8868\u793a\u200bSPI\u200b\u63a7\u5236\u5668\u200b\u3002</p> <p>\u200b\u5728\u200b\u8fd9\u4e2a\u200bSPI\u200b\u63a7\u5236\u5668\u200b\u4e0b\u9762\u200b\uff0c\u200b\u8fde\u63a5\u200b\u6709\u200b\u54ea\u4e9b\u200bSPI\u200b\u8bbe\u5907\u200b\uff1f\u200b\u4f1a\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u4f7f\u7528\u200b\u5b50\u200b\u8282\u70b9\u200b\u6765\u200b\u63cf\u8ff0\u200bSPI\u200b\u8bbe\u5907\u200b\u3002</p>"},{"location":"11_SPI/04_1/#31-gpiospi","title":"3.1 \u200b\u4f7f\u7528\u200bGPIO\u200b\u6a21\u62df\u200b\u7684\u200bSPI\u200b\u63a7\u5236\u5668","text":""},{"location":"11_SPI/04_1/#32-imx6ull-spi","title":"3.2 IMX6ULL SPI\u200b\u63a7\u5236\u5668","text":"<p>\u200b\u5185\u6838\u200b\u6587\u4ef6\u200b\uff1aarch/arm/boot/dts/imx6ull.dtsi</p> <p></p> <p>\u200b\u5185\u6838\u200b\u6587\u4ef6\u200b\uff1aarch/arm/boot/dts/100ask_imx6ull-14x14.dts</p> <p></p>"},{"location":"11_SPI/04_1/#33-stm32mp157-spi","title":"3.3 STM32MP157 SPI\u200b\u63a7\u5236\u5668","text":"<p>\u200b\u5185\u6838\u200b\u6587\u4ef6\u200b\uff1aarch/arm/boot/dts/stm32mp151.dtsi</p> <p></p> <p>\u200b\u5185\u6838\u200b\u6587\u4ef6\u200b\uff1aarch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dts</p> <p></p>"},{"location":"11_SPI/04_1/#4","title":"4. \u200b\u8bbe\u5907\u200b\u6811\u200b\u5904\u7406\u8fc7\u7a0b","text":"<p>\u200b\u5185\u6838\u200b\u6e90\u7801\u200b\uff1a<code>drivers\\spi\\spi.c</code></p> <p></p>"},{"location":"11_SPI/05_1/","title":"spidev\u200b\u7684\u200b\u4f7f\u7528\u200b(SPI\u200b\u7528\u6237\u200b\u6001\u200bAPI)","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>\u200b\u5185\u6838\u200b\u9a71\u52a8\u200b\uff1a<code>drivers\\spi\\spidev.c</code></p> </li> <li> <p>\u200b\u5185\u6838\u200b\u63d0\u4f9b\u200b\u7684\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b\uff1a<code>tools\\spi\\spidev_fdx.c</code></p> </li> <li> <p>\u200b\u5185\u6838\u200b\u6587\u6863\u200b\uff1a<code>Documentation\\spi\\spidev</code> </p> </li> </ul>"},{"location":"11_SPI/05_1/#1-spidev","title":"1. spidev\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5206\u6790","text":"<p>\u200b\u5185\u6838\u200b\u9a71\u52a8\u200b\uff1a<code>drivers\\spi\\spidev.c</code></p>"},{"location":"11_SPI/05_1/#11","title":"1.1 \u200b\u9a71\u52a8\u200b\u6846\u67b6","text":"<p>\u200b\u8bbe\u5907\u200b\u6811\u200b\u793a\u4f8b\u200b\uff1a</p> <pre><code>spidev0: spidev@0 {\n    compatible = \u201cspidev\u201d;\n    reg = &lt;0&gt;;\n    spi-max-frequency = &lt;50000000&gt;;\n};\n</code></pre> <p>\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u67d0\u4e2a\u200bspi\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u7684\u200bcompatible\u200b\u5c5e\u6027\u200b\u7b49\u4e8e\u200b\u4e0b\u5217\u200b\u503c\u200b\uff0c\u200b\u5c31\u200b\u4f1a\u200b\u8ddf\u200bspidev\u200b\u9a71\u52a8\u200b\u5339\u914d\u200b\uff1a</p> <ul> <li>\"rohm,dh2228fv\"</li> <li>\"lineartechnology,ltc2488\"</li> <li>\"spidev\"</li> </ul> <p>\u200b\u5339\u914d\u200b\u4e4b\u540e\u200b\uff0cspidev.c\u200b\u7684\u200b<code>spidev_probe</code>\u200b\u4f1a\u200b\u88ab\u200b\u8c03\u7528\u200b\uff0c\u200b\u5b83\u4f1a\u200b\uff1a</p> <ul> <li>\u200b\u5206\u914d\u200b\u4e00\u4e2a\u200bspidev_data\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u7528\u6765\u200b\u8bb0\u5f55\u200b\u5bf9\u4e8e\u200b\u7684\u200bspi_device</li> <li>spidev_data\u200b\u4f1a\u200b\u88ab\u200b\u8bb0\u5f55\u200b\u5728\u200b\u4e00\u4e2a\u200b\u94fe\u8868\u200b\u91cc\u200b</li> <li>\u200b\u5206\u914d\u200b\u4e00\u4e2a\u200b\u6b21\u200b\u8bbe\u5907\u200b\u53f7\u200b\uff0c\u200b\u4ee5\u540e\u200b\u53ef\u4ee5\u200b\u6839\u636e\u200b\u8fd9\u4e2a\u200b\u6b21\u200b\u8bbe\u5907\u200b\u53f7\u200b\u5728\u200b\u94fe\u8868\u200b\u91cc\u200b\u627e\u5230\u200bspidev_data</li> <li>device_create\uff1a\u200b\u8fd9\u4f1a\u200b\u751f\u4ea7\u200b\u4e00\u4e2a\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b<code>/dev/spidevB.D</code>\uff0cB\u200b\u8868\u793a\u200b\u603b\u7ebf\u200b\u53f7\u200b\uff0cD\u200b\u8868\u793a\u200b\u5b83\u200b\u662f\u200b\u8fd9\u4e2a\u200bSPI Master\u200b\u4e0b\u200b\u7b2c\u51e0\u4e2a\u200b\u8bbe\u5907\u200b</li> </ul> <p>\u200b\u4ee5\u540e\u200b\uff0c\u200b\u6211\u4eec\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200b<code>/dev/spidevB.D</code>\u200b\u6765\u200b\u8bbf\u95ee\u200bspidev\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u3002</p>"},{"location":"11_SPI/05_1/#12","title":"1.2 \u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5206\u6790","text":"<p>spidev.c\u200b\u901a\u8fc7\u200bfile_operations\u200b\u5411\u200bAPP\u200b\u63d0\u4f9b\u200b\u63a5\u53e3\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/05_1/#121","title":"1.2.1 \u200b\u8bfb\u200b\u51fd\u6570","text":""},{"location":"11_SPI/05_1/#122","title":"1.2.2 \u200b\u5199\u200b\u51fd\u6570","text":""},{"location":"11_SPI/05_1/#123-ioctl","title":"1.2.3 \u200b\u901a\u8fc7\u200bioctl\u200b\u8bfb\u5199\u200b\u53c2\u6570","text":""},{"location":"11_SPI/05_1/#124-ioclt","title":"1.2.4 \u200b\u901a\u8fc7\u200bioclt\u200b\u8bfb\u5199\u200b\u6570\u636e","text":""},{"location":"11_SPI/05_1/#2-spidev","title":"2. spidev\u200b\u5e94\u7528\u7a0b\u5e8f\u200b\u5206\u6790","text":"<p>\u200b\u5185\u6838\u200b\u63d0\u4f9b\u200b\u7684\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b\uff1a<code>tools\\spi\\spidev_fdx.c</code></p>"},{"location":"11_SPI/05_1/#21","title":"2.1 \u200b\u4f7f\u7528\u200b\u65b9\u6cd5","text":"<pre><code>spidev_fdx [-h] [-m N] [-r N] /dev/spidevB.D\n</code></pre> <ul> <li>-h: \u200b\u6253\u5370\u200b\u7528\u6cd5\u200b</li> <li>-m N\uff1a\u200b\u5148\u5199\u200b1\u200b\u4e2a\u200b\u5b57\u8282\u200b0xaa\uff0c\u200b\u518d\u200b\u8bfb\u200bN\u200b\u4e2a\u200b\u5b57\u8282\u200b\uff0c**\u200b\u6ce8\u610f\u200b\uff1a**\u200b\u4e0d\u662f\u200b\u540c\u65f6\u200b\u5199\u200b\u540c\u65f6\u200b\u8bfb\u200b</li> <li>-r N\uff1a\u200b\u8bfb\u200bN\u200b\u4e2a\u200b\u5b57\u8282\u200b</li> </ul>"},{"location":"11_SPI/05_1/#22","title":"2.2 \u200b\u4ee3\u7801\u200b\u5206\u6790","text":""},{"location":"11_SPI/05_1/#221","title":"2.2.1 \u200b\u663e\u793a\u200b\u8bbe\u5907\u200b\u5c5e\u6027","text":""},{"location":"11_SPI/05_1/#222","title":"2.2.2 \u200b\u8bfb\u6570\u636e","text":""},{"location":"11_SPI/05_1/#223","title":"2.2.3 \u200b\u5148\u5199\u200b\u518d\u200b\u8bfb","text":""},{"location":"11_SPI/05_1/#224","title":"2.2.4 \u200b\u540c\u65f6\u200b\u8bfb\u5199","text":""},{"location":"11_SPI/05_1/#3-spidev","title":"3. spidev\u200b\u7684\u200b\u7f3a\u70b9","text":"<p>\u200b\u4f7f\u7528\u200bread\u3001write\u200b\u51fd\u6570\u200b\u65f6\u200b\uff0c\u200b\u53ea\u80fd\u200b\u8bfb\u200b\u3001\u200b\u5199\u200b\uff0c\u200b\u8fd9\u662f\u200b\u534a\u53cc\u5de5\u200b\u65b9\u5f0f\u200b\u3002</p> <p>\u200b\u4f7f\u7528\u200bioctl\u200b\u53ef\u4ee5\u200b\u8fbe\u5230\u200b\u5168\u53cc\u5de5\u200b\u7684\u200b\u8bfb\u5199\u200b\u3002</p> <p>\u200b\u4f46\u662f\u200bspidev\u200b\u6709\u200b2\u200b\u4e2a\u200b\u7f3a\u70b9\u200b\uff1a</p> <ul> <li>\u200b\u4e0d\u200b\u652f\u6301\u200b\u4e2d\u65ad\u200b</li> <li>\u200b\u53ea\u200b\u652f\u6301\u200b\u540c\u6b65\u64cd\u4f5c\u200b\uff0c\u200b\u4e0d\u200b\u652f\u6301\u200b\u5f02\u6b65\u200b\u64cd\u4f5c\u200b\uff1a\u200b\u5c31\u662f\u200bread/write/ioctl\u200b\u8fd9\u4e9b\u200b\u51fd\u6570\u200b\u53ea\u80fd\u200b\u6267\u884c\u200b\u5b8c\u6bd5\u200b\u624d\u200b\u53ef\u200b\u8fd4\u56de\u200b</li> </ul>"},{"location":"11_SPI/06_1/","title":"\u4f7f\u7528\u200bspidev\u200b\u64cd\u4f5c\u200bSPI_DAC\u200b\u6a21\u5757","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>\u200b\u5185\u6838\u200b\u9a71\u52a8\u200b\uff1a<code>drivers\\spi\\spidev.c</code></p> </li> <li> <p>\u200b\u5185\u6838\u200b\u63d0\u4f9b\u200b\u7684\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b\uff1a<code>tools\\spi\\spidev_fdx.c</code></p> </li> <li> <p>\u200b\u5185\u6838\u200b\u6587\u6863\u200b\uff1a<code>Documentation\\spi\\spidev</code> </p> </li> <li> <p>DAC\u200b\u82af\u7247\u200b\u624b\u518c\u200b\uff1a<code>TLC5615.pdf</code></p> </li> </ul>"},{"location":"11_SPI/06_1/#1","title":"1. \u200b\u786c\u4ef6","text":""},{"location":"11_SPI/06_1/#11","title":"1.1 \u200b\u539f\u7406\u56fe","text":"<p>IMX6ULL:</p> <p></p> <p>STM32MP157:</p> <p></p> <p>\u200b\u539f\u7406\u56fe\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/06_1/#12","title":"1.2 \u200b\u8fde\u63a5","text":""},{"location":"11_SPI/06_1/#121-imx6ull","title":"1.2.1 IMX6ULL","text":"<p>DAC\u200b\u6a21\u5757\u200b\u63a5\u5230\u200bIMX6ULL\u200b\u6269\u5c55\u200b\u677f\u200b\u7684\u200bSPI_A\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/06_1/#122-stm32mp157","title":"1.2.2 STM32MP157","text":""},{"location":"11_SPI/06_1/#2-dac","title":"2. DAC\u200b\u64cd\u4f5c\u200b\u539f\u7406","text":""},{"location":"11_SPI/06_1/#21","title":"2.1 \u200b\u5185\u90e8\u200b\u6846\u56fe","text":"<p>\u200b\u64cd\u4f5c\u8fc7\u7a0b\u200b\u4e3a\u200b\uff1a</p> <ul> <li>CS\u200b\u4e3a\u200b\u4f4e\u200b</li> <li>\u200b\u5728\u200bSCLK\u200b\u7684\u200b\u4e0a\u5347\u200b\u6cbf\u200b\uff0c\u200b\u4ece\u200bDIN\u200b\u91c7\u96c6\u200b16\u200b\u4f4d\u200b\u6570\u636e\u200b\uff0c\u200b\u5b58\u5165\u200b\u4e0a\u56fe\u200b\u4e2d\u200b\u7684\u200b<code>16-Bit Shift Register</code></li> <li>\u200b\u5728\u200bCS\u200b\u7684\u200b\u4e0a\u5347\u200b\u6cbf\u200b\uff0c\u200b\u628a\u200b<code>16-Bit Shift Register</code>\u200b\u4e2d\u200b\u7684\u200b10\u200b\u4f4d\u200b\u6570\u636e\u200b\u4f20\u5165\u200b<code>10-Bit DAC Register</code>\uff0c\u200b\u4f5c\u4e3a\u200b\u6a21\u62df\u91cf\u200b\u5728\u200bOUT\u200b\u5f15\u811a\u200b\u8f93\u51fa\u200b</li> </ul> <p>\u200b\u6ce8\u610f\u200b\uff1a</p> <ul> <li>\u200b\u4f20\u8f93\u200b\u7684\u200b16\u200b\u4f4d\u200b\u6570\u636e\u200b\u4e2d\u200b\uff0c\u200b\u9ad8\u200b4\u200b\u4f4d\u662f\u200b\u65e0\u200b\u610f\u4e49\u200b\u7684\u200b</li> <li>\u200b\u4e2d\u95f4\u200b10\u200b\u4f4d\u624d\u200b\u88ab\u200b\u8f6c\u6362\u200b\u4e3a\u200b\u6a21\u62df\u91cf\u200b</li> <li>\u200b\u6700\u4f4e\u200b2\u200b\u4f4d\u200b\u5fc5\u987b\u200b\u662f\u200b0</li> </ul>"},{"location":"11_SPI/06_1/#22","title":"2.2 \u200b\u65f6\u5e8f\u200b\u56fe","text":"<p>\u200b\u4f7f\u7528\u200bSPI\u200b\u4f20\u8f93\u200b\u7684\u200b\u7ec6\u8282\u200b\uff1a</p> <ul> <li>SCLK\u200b\u521d\u59cb\u200b\u7535\u5e73\u200b\u4e3a\u200b\u4f4e\u200b</li> <li>\u200b\u4f7f\u7528\u200b16\u200b\u4e2a\u200bSCLK\u200b\u5468\u671f\u200b\u6765\u200b\u4f20\u8f93\u200b16\u200b\u4f4d\u200b\u6570\u636e\u200b</li> <li>\u200b\u5728\u200bSCLK\u200b\u4e0a\u5347\u200b\u6cbf\u200b\u8bfb\u53d6\u200bDIN\u200b\u7535\u5e73\u200b</li> <li>\u200b\u5728\u200bSCLK\u200b\u4e0a\u5347\u200b\u6cbf\u200b\u53d1\u51fa\u200bDOUT\u200b\u4fe1\u53f7\u200b</li> <li>DOUT\u200b\u6570\u636e\u200b\u6765\u81ea\u200b<code>16-Bit Shift Register</code></li> <li>\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u6570\u636e\u200b\u662f\u200b\u4e0a\u6b21\u200b\u6570\u636e\u200b\u9057\u7559\u4e0b\u200b\u7684\u200bLSB\u200b\u4f4d\u200b</li> <li>\u200b\u5176\u4f59\u200b15\u200b\u4e2a\u200b\u6570\u636e\u200b\u6765\u81ea\u200b<code>16-Bit Shift Register</code>\u200b\u7684\u200b\u9ad8\u200b15\u200b\u4f4d\u200b</li> <li><code>16-Bit Shift Register</code>\u200b\u7684\u200bLSB\u200b\u5728\u200b\u4e0b\u200b\u4e00\u4e2a\u200b\u5468\u671f\u200b\u7684\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u65f6\u949f\u200b\u4f20\u8f93\u200b</li> <li>LSB\u200b\u5fc5\u5b9a\u200b\u662f\u200b0\uff0c\u200b\u6240\u4ee5\u200b\u5f53\u524d\u200b\u7684\u200b\u5468\u671f\u200b\u91cc\u200b\u8bfb\u51fa\u200b<code>16-Bit Shift Register</code>\u200b\u7684\u200b15\u200b\u4f4d\u200b\u6570\u636e\u200b\u4e5f\u200b\u8db3\u591f\u200b\u4e86\u200b</li> </ul>"},{"location":"11_SPI/06_1/#23-dac","title":"2.3 DAC\u200b\u516c\u5f0f","text":"<pre><code>\u200b\u8f93\u51fa\u200b\u7535\u538b\u200b = 2 * VREFIN * n / 1024 = 2 * 2.048 * n / 1024\n\u200b\u5176\u4e2d\u200b: n\u200b\u4e3a\u200b10\u200b\u4f4d\u200b\u6570\u503c\u200b\n</code></pre>"},{"location":"11_SPI/06_1/#3-app","title":"3. \u200b\u7f16\u5199\u200bAPP","text":"<p>\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff0c\u200b\u8fd9\u200b2\u200b\u4e2a\u200b\u4f4d\u7f6e\u200b\u91cc\u200b\u7684\u200b\u6e90\u7801\u200b\u662f\u200b\u4e00\u6837\u200b\u7684\u200b\uff1a</p> <p></p> <p></p>"},{"location":"11_SPI/07_1/","title":"SPI_DAC\u200b\u6a21\u5757\u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>\u200b\u5185\u6838\u200b\u9a71\u52a8\u200b\uff1a<code>drivers\\spi\\spidev.c</code></p> </li> <li> <p>\u200b\u5185\u6838\u200b\u63d0\u4f9b\u200b\u7684\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b\uff1a<code>tools\\spi\\spidev_fdx.c</code></p> </li> <li> <p>\u200b\u5185\u6838\u200b\u6587\u6863\u200b\uff1a<code>Documentation\\spi\\spidev</code> </p> </li> <li> <p>DAC\u200b\u82af\u7247\u200b\u624b\u518c\u200b\uff1a<code>TLC5615.pdf</code></p> </li> </ul>"},{"location":"11_SPI/07_1/#1","title":"1. \u200b\u786c\u4ef6","text":""},{"location":"11_SPI/07_1/#11","title":"1.1 \u200b\u539f\u7406\u56fe","text":"<p>IMX6ULL:</p> <p></p> <p>STM32MP157:</p> <p></p> <p>\u200b\u539f\u7406\u56fe\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/07_1/#12","title":"1.2 \u200b\u8fde\u63a5","text":""},{"location":"11_SPI/07_1/#121-imx6ull","title":"1.2.1 IMX6ULL","text":"<p>DAC\u200b\u6a21\u5757\u200b\u63a5\u5230\u200bIMX6ULL\u200b\u6269\u5c55\u200b\u677f\u200b\u7684\u200bSPI_A\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/07_1/#122-stm32mp157","title":"1.2.2 STM32MP157","text":"<p>DAC\u200b\u6a21\u5757\u200b\u63a5\u5230\u200bSTM32MP157\u200b\u6269\u5c55\u200b\u677f\u200b\u7684\u200bSPI_A\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/07_1/#2","title":"2. \u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811","text":"<p>\u200b\u786e\u8ba4\u200bSPI\u200b\u65f6\u949f\u200b\u6700\u5927\u200b\u9891\u7387\u200b\uff1a</p> <p></p> <pre><code>T = 25 + 25 = 50ns\nF = 20000000 = 20MHz\n</code></pre> <p>\u200b\u8bbe\u5907\u200b\u6811\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>    dac: dac {\n        compatible = \"spidev\";\n        reg = &lt;0&gt;;\n        spi-max-frequency = &lt;20000000&gt;;\n    };\n</code></pre>"},{"location":"11_SPI/07_1/#21-imx6ull","title":"2.1 IMX6ULL","text":"<p>DAC\u200b\u6a21\u5757\u200b\u63a5\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff0c\u200b\u90a3\u4e48\u200b\u8981\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200bspi1\u200b\u7684\u200b\u8282\u70b9\u200b\u4e0b\u200b\u521b\u5efa\u200b\u5b50\u200b\u8282\u70b9\u200b\u3002</p> <p>\u200b\u4ee3\u7801\u200b\u5728\u200b<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code>\u200b\u4e2d\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>&amp;ecspi1 {\n    pinctrl-names = \"default\";\n    pinctrl-0 = &lt;&amp;pinctrl_ecspi1&gt;;\n\n    fsl,spi-num-chipselects = &lt;2&gt;;\n    cs-gpios = &lt;&amp;gpio4 26 GPIO_ACTIVE_LOW&gt;, &lt;&amp;gpio4 24 GPIO_ACTIVE_LOW&gt;;\n    status = \"okay\";\n\n    dac: dac {\n        compatible = \"spidev\";\n        reg = &lt;0&gt;;\n        spi-max-frequency = &lt;20000000&gt;;\n    };\n};\n</code></pre>"},{"location":"11_SPI/07_1/#22-stm32mp157","title":"2.2 STM32MP157","text":"<p>DAC\u200b\u6a21\u5757\u200b\u63a5\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff0c\u200b\u90a3\u4e48\u200b\u8981\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200bspi5\u200b\u7684\u200b\u8282\u70b9\u200b\u4e0b\u200b\u521b\u5efa\u200b\u5b50\u200b\u8282\u70b9\u200b\u3002</p> <p>\u200b\u4ee3\u7801\u200b\u5728\u200b<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dts</code>\u200b\u4e2d\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>&amp;spi5 {\n        pinctrl-names = \"default\", \"sleep\";\n        pinctrl-0 = &lt;&amp;spi5_pins_a&gt;;\n        pinctrl-1 = &lt;&amp;spi5_sleep_pins_a&gt;;\n        status = \"okay\";\n        cs-gpios = &lt;&amp;gpioh 5 GPIO_ACTIVE_LOW&gt;, &lt;&amp;gpioz 4 GPIO_ACTIVE_LOW&gt;;\n        spidev: icm20608@0{\n                compatible = \"invensense,icm20608\";\n                interrupts = &lt;0 IRQ_TYPE_EDGE_FALLING&gt;;\n                interrupt-parent = &lt;&amp;gpioz&gt;;\n                spi-max-frequency = &lt;8000000&gt;;\n                reg = &lt;0&gt;;\n        };\n        dac_test: dac_test@1{\n                compatible = \"spidev\";\n                spi-max-frequency = &lt;20000000&gt;;\n                reg = &lt;1&gt;;\n        };\n};\n</code></pre>"},{"location":"11_SPI/07_1/#3","title":"3. \u200b\u7f16\u8bd1\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"11_SPI/07_1/#31-imx6ull","title":"3.1 IMX6ULL","text":""},{"location":"11_SPI/07_1/#311","title":"3.1.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\n export PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"11_SPI/07_1/#312","title":"3.1.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bIMX6ULL\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/100ask_imx6ull-14x14.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/100ask_imx6ull-14x14.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"11_SPI/07_1/#32-stm32mp157","title":"3.2 STM32MP157","text":""},{"location":"11_SPI/07_1/#321","title":"3.2.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"11_SPI/07_1/#322","title":"3.2.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bSTM32MP157\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u6811\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b\u54ea\u91cc\u200b</p> </li> </ul> <p>\u200b\u7531\u4e8e\u200b\u7248\u672c\u200b\u53d8\u5316\u200b\uff0cSTM32MP157\u200b\u5355\u677f\u200b\u4e0a\u200b\u70e7\u5f55\u200b\u7684\u200b\u7cfb\u7edf\u200b\u53ef\u80fd\u200b\u6709\u200b\u7ec6\u5fae\u5dee\u522b\u200b\u3002   \u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b<code>cat /proc/mounts</code>\u200b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u4e24\u79cd\u200b\u7ed3\u679c\u200b(\u200b\u89c1\u200b\u4e0b\u56fe\u200b)\uff1a</p> <ul> <li> <p>mmcblk2p2\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u5de6\u8fb9\u200b)\uff1a\u200b\u65e0\u9700\u200b\u7279\u6b8a\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u4e0b\u9762\u200b\u628a\u200b\u6587\u4ef6\u200b\u590d\u5236\u5230\u200b/boot\u200b\u76ee\u5f55\u200b\u5373\u53ef\u200b</p> </li> <li> <p>mmcblk2p2\u200b\u6302\u8f7d\u200b\u5728\u200b/mnt\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u53f3\u8fb9\u200b)</p> <ul> <li>\u200b\u5728\u200b\u89c6\u9891\u200b\u91cc\u200b\u3001\u200b\u540e\u9762\u200b\u6587\u6863\u200b\u91cc\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u66f4\u65b0\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u7684\u200b\u6587\u4ef6\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8981\u200b\u5148\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u91cd\u65b0\u200b\u6302\u8f7d\u200b\uff1a</li> <li><code>mount  /dev/mmcblk2p2  /boot</code></li> </ul> <p></p> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> </ul> <pre><code>[root@100ask:~]# cp /mnt/stm32mp157c-100ask-512d-lcd-v1.dtb /boot/\n[root@100ask:~]# sync\n</code></pre> <ul> <li>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</li> </ul>"},{"location":"11_SPI/07_1/#4-spidev","title":"4. \u200b\u7f16\u8bd1\u200bspidev\u200b\u9a71\u52a8","text":"<p>\u200b\u9996\u5148\u200b\u8981\u200b\u786e\u5b9a\u200b\u5185\u6838\u200b\u4e2d\u200b\u5df2\u7ecf\u200b\u542b\u6709\u200bspidev\u3002\u200b\u5728\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200bmake menuconfig\uff0c\u200b\u67e5\u770b\u200b\u662f\u5426\u200b\u6709\u200b\u6539\u200b\u9a71\u52a8\u200b\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\uff1a</p> <pre><code>-&gt; Device Drivers\n  -&gt; SPI support (SPI [=y]) \n    &lt; &gt;   User mode SPI device driver support  \n</code></pre> <p>\u200b\u5982\u679c\u200b<code>User mode SPI device driver support</code>\u200b\u524d\u9762\u200b\u4e0d\u662f\u200b<code>&lt;Y&gt;</code>\u200b\u6216\u200b<code>&lt;M&gt;</code>\uff0c\u200b\u53ef\u4ee5\u200b\u8f93\u5165\u200b<code>M</code>\u200b\u8868\u793a\u200b\u628a\u200b\u5b83\u200b\u7f16\u8bd1\u200b\u4e3a\u200b\u6a21\u5757\u200b\u3002</p> <ul> <li>\u200b\u5982\u679c\u200b\u5df2\u7ecf\u200b\u662f\u200b<code>&lt;Y&gt;</code>\uff0c\u200b\u5219\u200b\u4e0d\u7528\u200b\u518d\u200b\u505a\u200b\u5176\u4ed6\u200b\u4e8b\u60c5\u200b\u3002</li> <li>\u200b\u5982\u679c\u200b\u4f60\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b<code>&lt;M&gt;</code>\uff0c\u200b\u5728\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b<code>make modules</code>\uff0c\u200b\u628a\u200b\u751f\u6210\u200b\u7684\u200b<code>drivers/spi/spidev.ko</code>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\u5907\u7528\u200b</li> </ul>"},{"location":"11_SPI/07_1/#5-app","title":"5. \u200b\u7f16\u8bd1\u200bAPP","text":"<pre><code>arm-buildroot-linux-gnueabihf-gcc  -o  dac_test  dac_test.c\n</code></pre>"},{"location":"11_SPI/07_1/#6","title":"6. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<p>\u200b\u5982\u679c\u200bspidev\u200b\u6ca1\u6709\u200b\u88ab\u200b\u7f16\u8bd1\u200b\u8fdb\u200b\u5185\u6838\u200b\uff0c\u200b\u90a3\u4e48\u200b\u5148\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>insmod spidev.ko\n</code></pre> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\uff1a</p> <pre><code>ls /dev/spidev*\n</code></pre> <p>\u200b\u5047\u8bbe\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u4e3a\u200b<code>/dev/spidev0.0</code>\uff0c\u200b\u6267\u884c\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b\uff1a</p> <pre><code>./dac_test  /dev/spidev0.0  500\n./dac_test  /dev/spidev0.0  600\n./dac_test  /dev/spidev0.0  1000\n</code></pre>"},{"location":"11_SPI/08_1/","title":"SPI_OLED\u200b\u6a21\u5757\u200b\u64cd\u4f5c\u65b9\u6cd5","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>OLEDC\u200b\u82af\u7247\u200b\u624b\u518c\u200b\uff1a<code>SPEC UG-2864TMBEG01 .pdf</code>\u3001<code>SSD1306-Revision 1.1 (Charge Pump).pdf</code></li> </ul>"},{"location":"11_SPI/08_1/#1","title":"1. \u200b\u786c\u4ef6","text":""},{"location":"11_SPI/08_1/#11","title":"1.1 \u200b\u539f\u7406\u56fe","text":"<p>IMX6ULL:</p> <p></p> <p>STM32MP157:</p> <p></p> <p>\u200b\u539f\u7406\u56fe\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/08_1/#12","title":"1.2 \u200b\u8fde\u63a5","text":"<p>\u200b\u65e0\u8bba\u662f\u200b\u4f7f\u7528\u200bIMX6ULL\u200b\u5f00\u53d1\u677f\u200b\u8fd8\u662f\u200bSTM32MP157\u200b\u5f00\u53d1\u677f\u200b\uff0c\u200b\u90fd\u200b\u6709\u200b\u7c7b\u4f3c\u200b\u7684\u200b\u6269\u5c55\u200b\u677f\u200b\u3002\u200b\u628a\u200bOLED\u200b\u6a21\u5757\u200b\u63a5\u5230\u200b\u6269\u5c55\u200b\u677f\u200b\u7684\u200bSPI_A\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/08_1/#2-oled","title":"2. OLED\u200b\u64cd\u4f5c\u200b\u539f\u7406","text":"<p>\u200b\u539f\u7406\u56fe\u200b\u7b80\u5316\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u8981\u200b\u64cd\u4f5c\u200bOLED\uff0c\u200b\u53ea\u200b\u9700\u200b\u4f7f\u7528\u200bSPI\u200b\u63a5\u53e3\u200b\u53d1\u9001\u6570\u636e\u200b\uff0c\u200b\u5e76\u4e0d\u9700\u8981\u200b\u4f7f\u7528\u200bSPI\u200b\u63a5\u53e3\u200b\u8bfb\u53d6\u6570\u636e\u200b\u3002\u200b\u9664\u6b64\u4e4b\u5916\u200b\uff0c\u200b\u8fd8\u200b\u9700\u8981\u200b\u63a7\u5236\u200bD/C\u200b\u5f15\u811a\u200b\uff1a</p> <ul> <li>\u200b\u5f53\u200bDC\u200b\u5f15\u811a\u200b\u662f\u200b\u4f4e\u7535\u5e73\u200b\u65f6\u200b\uff0c\u200b\u662f\u200b\u547d\u4ee4\u200b\uff1a\u200b\u6bd4\u5982\u200b\u590d\u4f4d\u200b\u3001\u200b\u6253\u5f00\u200b\u663e\u793a\u200b\u3001\u200b\u8bbe\u7f6e\u200b\u5730\u5740\u200b</li> <li>\u200b\u5f53\u200bDC\u200b\u5f15\u811a\u200b\u662f\u200b\u9ad8\u7535\u5e73\u200b\u65f6\u200b\uff0c\u200b\u662f\u200b\u6570\u636e\u200b\uff1a\u200b\u5199\u5165\u200b\u8981\u200b\u663e\u793a\u200b\u7684\u200b\u6570\u636e\u200b</li> </ul>"},{"location":"11_SPI/08_1/#21","title":"2.1 \u200b\u663e\u5b58\u200b\u548c\u200b\u50cf\u7d20","text":"<p>OLED\u200b\u4e0a\u200b\u6709\u200b128*64\u200b\u4e2a\u200b\u50cf\u7d20\u200b\uff0c\u200b\u6bcf\u4e2a\u200b\u50cf\u7d20\u200b\u53ea\u6709\u200b2\u200b\u79cd\u200b\u72b6\u6001\u200b\uff1a\u200b\u4eae\u200b\u3001\u200b\u706d\u200b\u3002</p> <p></p> <p>\u200b\u600e\u4e48\u200b\u63a7\u5236\u200b\u5c4f\u5e55\u200b\u4e0a\u200b\u6bcf\u4e2a\u200b\u50cf\u7d20\u200b\u7684\u200b\u72b6\u6001\u200b\uff1fOLED\u200b\u5185\u90e8\u200b\u6709\u200b\u663e\u5b58\u200bGDDRAM(Graphic Display Data RAM)\uff1a</p> <p></p> <p>\u200b\u663e\u5b58\u200b\u4e2d\u200b\uff0c\u200b\u6bcf\u4f4d\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200b\u50cf\u7d20\u200b\uff0c\u200b\u5165\u200b\u4e0b\u56fe\u200b\u6240\u793a\u200b\uff1a</p> <ul> <li>byte0\u200b\u7684\u200b8\u200b\u4f4d\u200b\u6570\u636e\u200b\u5bf9\u5e94\u200b\u5c4f\u5e55\u200b\u4e0a\u200b\u89d2\u200b\u5de6\u4fa7\u200b\u3001\u200b\u7ad6\u5411\u200b\u6392\u5217\u200b\u7684\u200b8\u200b\u4e2a\u200b\u50cf\u7d20\u200b\uff0c\u200b\u5373\u200bCOL0\u200b\u7684\u200b\u50cf\u7d20\u200b\uff0cbit0\u200b\u5bf9\u5e94\u200b\u7b2c\u200b0\u200b\u884c\u200b\uff0cbit1\u200b\u5bf9\u5e94\u200b\u7b2c\u200b1\u200b\u884c\u200b\uff0c\u2026\u2026</li> <li>byte0\u200b\u5bf9\u5e94\u200bCOL1\u200b\u90a3\u5217\u200b\u7b2c\u200b0~\u200b\u7b2c\u200b7\u200b\u884c\u200b\u7684\u200b8\u200b\u4e2a\u200b\u50cf\u7d20\u200b</li> <li>\u2026\u2026</li> <li>byte127\u200b\u5bf9\u5e94\u200bCOL127\u200b\u90a3\u5217\u200b\u7b2c\u200b0~\u200b\u7b2c\u200b7\u200b\u884c\u200b\u7684\u200b8\u200b\u4e2a\u200b\u50cf\u7d20\u200b</li> <li>byte128\u200b\u5bf9\u5e94\u200bCOL0\u200b\u90a3\u5217\u200b\u7b2c\u200b0~\u200b\u7b2c\u200b7\u200b\u884c\u200b\u7684\u200b8\u200b\u4e2a\u200b\u50cf\u7d20\u200b</li> </ul> <p></p>"},{"location":"11_SPI/08_1/#22","title":"2.2 \u200b\u663e\u5b58\u200b\u5bfb\u5740\u200b\u6a21\u5f0f","text":"<p>\u200b\u663e\u5b58\u200b\u88ab\u200b\u5206\u4e3a\u200b8\u200b\u9875\u200b\u3001127\u200b\u5217\u200b\uff0c\u200b\u8981\u200b\u5199\u200b\u67d0\u4e2a\u200b\u5b57\u8282\u200b\u65f6\u200b\uff0c\u200b\u9700\u8981\u200b\u5148\u200b\u6307\u5b9a\u200b\u5730\u5740\u200b\uff0c\u200b\u7136\u540e\u200b\u5199\u5165\u200b1\u200b\u5b57\u8282\u200b\u7684\u200b\u6570\u636e\u200b</p> <ul> <li>\u200b\u54ea\u9875\u200b(Page)\uff1f</li> <li>\u200b\u54ea\u5217\u200b(Col)\uff1f</li> <li>\u200b\u5199\u5165\u200b1\u200b\u5b57\u8282\u200b\u6570\u636e\u200b</li> </ul> <p>OLED\u200b\u6709\u200b\u4e09\u79cd\u200b\u5bfb\u5740\u200b\u6a21\u5f0f\u200b\uff1a</p> <ul> <li> <p>\u200b\u9875\u200b\u5730\u5740\u200b\u6a21\u5f0f\u200b(Page addressing mode)\uff1a\u200b\u6bcf\u200b\u5199\u5165\u200b1\u200b\u4e2a\u200b\u5b57\u8282\u200b\uff0c\u200b\u884c\u200b\u5730\u5740\u200b\u4e0d\u53d8\u200b\uff0c\u200b\u5217\u200b\u5730\u5740\u200b\u589e\u200b1\uff0c\u200b\u5217\u200b\u5730\u5740\u200b\u8fbe\u5230\u200b127\u200b\u540e\u4f1a\u200b\u4ece\u200b0\u200b\u5f00\u59cb\u200b   </p> </li> <li> <p>\u200b\u6c34\u5e73\u200b\u5730\u5740\u200b\u6a21\u5f0f\u200b(Horizontal  addressing mode)\uff1a</p> </li> <li> <p>\u200b\u6bcf\u200b\u5199\u5165\u200b1\u200b\u4e2a\u200b\u5b57\u8282\u200b\uff0c\u200b\u884c\u200b\u5730\u5740\u200b\u4e0d\u53d8\u200b\uff0c\u200b\u5217\u200b\u5730\u5740\u200b\u589e\u200b1</p> </li> <li>\u200b\u5217\u200b\u5730\u5740\u200b\u8fbe\u5230\u200b127\u200b\u540e\u200b\u4ece\u200b0\u200b\u5f00\u59cb\u200b\uff0c\u200b\u884c\u200b\u5730\u5740\u200b\u6307\u5411\u200b\u4e0b\u200b\u4e00\u9875\u200b</li> <li>\u200b\u5217\u200b\u5730\u5740\u200b\u8fbe\u5230\u200b127\u3001\u200b\u884c\u200b\u5730\u5740\u200b\u8fbe\u5230\u200b7\u200b\u65f6\u200b\uff0c\u200b\u5217\u200b\u5730\u5740\u200b\u548c\u884c\u200b\u5730\u5740\u200b\u90fd\u200b\u88ab\u200b\u590d\u4f4d\u200b\u4e3a\u200b0\uff0c\u200b\u6307\u5411\u200b\u5de6\u4e0a\u89d2\u200b</li> </ul> <p></p> <ul> <li> <p>\u200b\u5782\u76f4\u200b\u5730\u5740\u200b\u6a21\u5f0f\u200b(Vertical addressing mode)\uff1a</p> </li> <li> <p>\u200b\u6bcf\u200b\u5199\u5165\u200b1\u200b\u4e2a\u200b\u5b57\u8282\u200b\uff0c\u200b\u884c\u200b\u5730\u5740\u200b\u589e\u200b1\uff0c\u200b\u5217\u200b\u5730\u5740\u200b\u4e0d\u53d8\u200b</p> </li> <li> <p>\u200b\u884c\u200b\u5730\u5740\u200b\u8fbe\u5230\u200b7\u200b\u540e\u200b\u4ece\u200b0\u200b\u5f00\u59cb\u200b\uff0c\u200b\u5217\u200b\u5730\u5740\u200b\u6307\u5411\u200b\u4e0b\u200b\u4e00\u5217\u200b</p> </li> <li> <p>\u200b\u5217\u200b\u5730\u5740\u200b\u8fbe\u5230\u200b127\u3001\u200b\u884c\u200b\u5730\u5740\u200b\u8fbe\u5230\u200b7\u200b\u65f6\u200b\uff0c\u200b\u5217\u200b\u5730\u5740\u200b\u548c\u884c\u200b\u5730\u5740\u200b\u90fd\u200b\u88ab\u200b\u590d\u4f4d\u200b\u4e3a\u200b0\uff0c\u200b\u6307\u5411\u200b\u5de6\u4e0a\u89d2\u200b</p> <p></p> </li> </ul>"},{"location":"11_SPI/08_1/#23","title":"2.3 \u200b\u5177\u4f53\u64cd\u4f5c","text":""},{"location":"11_SPI/08_1/#231","title":"2.3.1 \u200b\u521d\u59cb\u5316","text":"<p>\u200b\u5bf9\u4e8e\u200bOLED\u200b\u7684\u200b\u521d\u59cb\u5316\u200b\uff0c\u200b\u5728\u200b\u53c2\u8003\u624b\u518c\u200b<code>SPEC UG-2864TMBEG01 .pdf</code>\u200b\u4e2d\u200b\u5217\u51fa\u200b\u7684\u200b\u6d41\u7a0b\u56fe\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/08_1/#232","title":"2.3.2 \u200b\u8bbe\u7f6e\u200b\u5730\u5740","text":"<ul> <li>\u200b\u8bbe\u7f6e\u200b\u5730\u5740\u200b\u6a21\u5f0f\u200b</li> <li>\u200b\u8bbe\u7f6e\u200bpage</li> <li>\u200b\u8bbe\u7f6e\u200bcol</li> </ul> <p>\u200b\u5982\u4e0b\u200b\u56fe\u200b\uff1a</p> <ul> <li>\u200b\u8bbe\u7f6e\u200b\u5730\u5740\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u6bd4\u5982\u200b\u8bbe\u7f6e\u200b\u4e3a\u9875\u200b\u5730\u5740\u200b\u6a21\u5f0f\u200b\u65f6\u200b\uff0c\u200b\u5148\u5199\u200b\u547d\u4ee4\u200b0x22\uff0c\u200b\u518d\u200b\u5199\u200b\u547d\u4ee4\u200b0x02\u3002\u200b\u9875\u200b\u5730\u5740\u200b\u6a21\u5f0f\u200b\u662f\u200b\u9ed8\u8ba4\u200b\u7684\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u4e0d\u200b\u8bbe\u7f6e\u200b\u3002   </li> <li> <p>\u200b\u8bbe\u7f6e\u200b\u9875\u200b\u5730\u5740\u200b\uff1a\u200b\u6709\u200b0~7\u200b\u9875\u200b\uff0c\u200b\u60f3\u200b\u8bbe\u7f6e\u200b\u54ea\u200b\u4e00\u9875\u200b(n)\u200b\u5c31\u200b\u53d1\u51fa\u200b\u547d\u4ee4\u200b\uff1a0xB0 | n   </p> </li> <li> <p>\u200b\u8bbe\u7f6e\u200b\u5217\u200b\u5730\u5740\u200b\uff1a\u200b\u5217\u200b\u5730\u5740\u200b\u8303\u56f4\u200b\u662f\u200b0~127\uff0c\u200b\u9700\u8981\u200b\u4f7f\u7528\u200b2\u200b\u4e2a\u200b\u547d\u4ee4\u200b\u6765\u200b\u8bbe\u7f6e\u200b\u5217\u200b\u5730\u5740\u200b   </p> </li> </ul>"},{"location":"11_SPI/08_1/#234","title":"2.3.4 \u200b\u5199\u5165\u200b\u6570\u636e","text":"<p>\u200b\u8ba9\u200bDC\u200b\u5f15\u811a\u200b\u4e3a\u200b\u9ad8\u200b\uff0c\u200b\u53d1\u8d77\u200bSPI\u200b\u5199\u200b\u64cd\u4f5c\u200b\u5373\u53ef\u200b\u3002</p>"},{"location":"11_SPI/08_1/#3-oled","title":"3. \u200b\u5728\u200bOLED\u200b\u4e0a\u200b\u663e\u793a\u200b\u6587\u5b57","text":""},{"location":"11_SPI/09_1/","title":"\u4f7f\u7528\u200bspidev\u200b\u64cd\u4f5c\u200bSPI_OLED\u200b\u6a21\u5757","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>\u200b\u5185\u6838\u200b\u9a71\u52a8\u200b\uff1a<code>drivers\\spi\\spidev.c</code></p> </li> <li> <p>\u200b\u5185\u6838\u200b\u63d0\u4f9b\u200b\u7684\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b\uff1a<code>tools\\spi\\spidev_fdx.c</code></p> </li> <li> <p>\u200b\u5185\u6838\u200b\u6587\u6863\u200b\uff1a<code>Documentation\\spi\\spidev</code> </p> </li> <li> <p>OLEDC\u200b\u82af\u7247\u200b\u624b\u518c\u200b\uff1a<code>SPEC UG-2864TMBEG01 .pdf</code>\u3001<code>SSD1306-Revision 1.1 (Charge Pump).pdf</code></p> </li> <li> <p>\u200b\u6240\u200b\u53c2\u8003\u200b\u7684\u200b\u4ee3\u7801\u200b\u5728\u200b\u53e6\u200b\u4e00\u4e2a\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff1a<code>https://e.coding.net/weidongshan/01_all_series_quickstart.git</code> </p> </li> </ul>"},{"location":"11_SPI/09_1/#1","title":"1. \u200b\u8981\u200b\u505a\u200b\u7684\u200b\u4e8b\u60c5","text":""},{"location":"11_SPI/09_1/#2","title":"2. \u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811","text":"<p>\u200b\u65e0\u8bba\u662f\u200b\u4f7f\u7528\u200bIMX6ULL\u200b\u5f00\u53d1\u677f\u200b\u8fd8\u662f\u200bSTM32MP157\u200b\u5f00\u53d1\u677f\u200b\uff0c\u200b\u90fd\u200b\u6709\u200b\u7c7b\u4f3c\u200b\u7684\u200b\u6269\u5c55\u200b\u677f\u200b\u3002\u200b\u628a\u200bOLED\u200b\u6a21\u5757\u200b\u63a5\u5230\u200b\u6269\u5c55\u200b\u677f\u200b\u7684\u200bSPI_A\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/09_1/#211-imx6ull","title":"2.1.1 IMX6ULL","text":"<p>DC\u200b\u5f15\u811a\u200b\u4f7f\u7528\u200bGPIO4_20\uff0c\u200b\u4e0d\u8fc7\u200b\u53ea\u200b\u9700\u8981\u200b\u5728\u200bAPP\u200b\u91cc\u200b\u76f4\u63a5\u200b\u63a7\u5236\u200bDC\u200b\u5f15\u811a\u200b\uff0c\u200b\u65e0\u9700\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u5b9a\u200b\u3002</p> <p>\u200b\u8bbe\u5907\u200b\u6811\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>&amp;ecspi1 {\n    pinctrl-names = \"default\";\n    pinctrl-0 = &lt;&amp;pinctrl_ecspi1&gt;;\n\n    fsl,spi-num-chipselects = &lt;2&gt;;\n    cs-gpios = &lt;&amp;gpio4 26 GPIO_ACTIVE_LOW&gt;, &lt;&amp;gpio4 24 GPIO_ACTIVE_LOW&gt;;\n    status = \"okay\";\n\n    oled: oled {\n        compatible = \"spidev\";\n        reg = &lt;0&gt;;\n        spi-max-frequency = &lt;10000000&gt;;\n    };\n};\n</code></pre>"},{"location":"11_SPI/09_1/#212-stm32mp157","title":"2.1.2 STM32MP157","text":"<p>DC\u200b\u5f15\u811a\u200b\u4f7f\u7528\u200bGPIOA_13\uff0c\u200b\u4e0d\u8fc7\u200b\u53ea\u200b\u9700\u8981\u200b\u5728\u200bAPP\u200b\u91cc\u200b\u76f4\u63a5\u200b\u63a7\u5236\u200bDC\u200b\u5f15\u811a\u200b\uff0c\u200b\u65e0\u9700\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u5b9a\u200b\u3002</p> <p>\u200b\u8bbe\u5907\u200b\u6811\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>&amp;spi5 {\n        pinctrl-names = \"default\", \"sleep\";\n        pinctrl-0 = &lt;&amp;spi5_pins_a&gt;;\n        pinctrl-1 = &lt;&amp;spi5_sleep_pins_a&gt;;\n        status = \"okay\";\n        cs-gpios = &lt;&amp;gpioh 5 GPIO_ACTIVE_LOW&gt;, &lt;&amp;gpioz 4 GPIO_ACTIVE_LOW&gt;;\n        spidev: icm20608@0{\n                compatible = \"invensense,icm20608\";\n                interrupts = &lt;0 IRQ_TYPE_EDGE_FALLING&gt;;\n                interrupt-parent = &lt;&amp;gpioz&gt;;\n                spi-max-frequency = &lt;8000000&gt;;\n                reg = &lt;0&gt;;\n        };\n        oled: oled@1{\n                compatible = \"spidev\";\n                spi-max-frequency = &lt;10000000&gt;;\n                reg = &lt;1&gt;;\n        };\n};\n</code></pre>"},{"location":"11_SPI/09_1/#3-app","title":"3. \u200b\u7f16\u5199\u200bAPP","text":""},{"location":"11_SPI/09_1/#31-dc","title":"3.1 \u200b\u600e\u4e48\u200b\u63a7\u5236\u200bDC\u200b\u5f15\u811a","text":"<p>\u200b\u67e5\u770b\u200b\u539f\u7406\u56fe\u200b\uff0c\u200b\u786e\u8ba4\u200b\u5f15\u811a\u200b\uff0c\u200b\u7136\u540e\u200b\u53c2\u8003\u200b\u5982\u4e0b\u200b\u6587\u6863\u200b\u5373\u53ef\u200b\u4f7f\u7528\u200bAPP\u200b\u64cd\u4f5c\u200bGPIO\uff0c\u200b\u5047\u8bbe\u200b\u5f15\u811a\u200b\u53f7\u7801\u200b\u4e3a\u200b100\uff0cC\u200b\u8bed\u8a00\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>system(\"echo 100  &gt; /sys/class/gpio/export\");\nsystem(\"echo out &gt; /sys/class/gpio/gpio100/direction\");\nsystem(\"echo 1 &gt; /sys/class/gpio/gpio100/value\");\nsystem(\"echo 0 &gt; /sys/class/gpio/gpio100/value\");\nsystem(\"echo 100 &gt; /sys/class/gpio/unexport\");\n</code></pre> <p></p>"},{"location":"11_SPI/09_1/#32-spidevapp","title":"3.2 \u200b\u57fa\u4e8e\u200bspidev\u200b\u7f16\u5199\u200bAPP","text":"<p>\u200b\u6e90\u7801\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/10_1/","title":"OLED\u200b\u6a21\u5757\u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>\u200b\u5185\u6838\u200b\u9a71\u52a8\u200b\uff1a<code>drivers\\spi\\spidev.c</code></p> </li> <li> <p>\u200b\u5185\u6838\u200b\u63d0\u4f9b\u200b\u7684\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b\uff1a<code>tools\\spi\\spidev_fdx.c</code></p> </li> <li> <p>\u200b\u5185\u6838\u200b\u6587\u6863\u200b\uff1a<code>Documentation\\spi\\spidev</code> </p> </li> </ul>"},{"location":"11_SPI/10_1/#1","title":"1. \u200b\u8fde\u63a5","text":""},{"location":"11_SPI/10_1/#11-imx6ull","title":"1.1 IMX6ULL","text":"<p>OLED\u200b\u6a21\u5757\u200b\u63a5\u5230\u200bIMX6ULL\u200b\u6269\u5c55\u200b\u677f\u200b\u7684\u200bSPI_A\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/10_1/#12-stm32mp157","title":"1.2 STM32MP157","text":"<p>OLED\u200b\u6a21\u5757\u200b\u63a5\u5230\u200bSTM32MP157\u200b\u6269\u5c55\u200b\u677f\u200b\u7684\u200bSPI_A\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/10_1/#2","title":"2. \u200b\u7f16\u8bd1\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"11_SPI/10_1/#21-imx6ull","title":"2.1 IMX6ULL","text":""},{"location":"11_SPI/10_1/#211","title":"2.1.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\n export PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"11_SPI/10_1/#212","title":"2.1.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li> <p>\u200b\u4fee\u6539\u200b\u8bbe\u5907\u200b\u6811\u200b<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code></p> <p>```shell &amp;ecspi1 {     pinctrl-names = \"default\";     pinctrl-0 = &lt;&amp;pinctrl_ecspi1&gt;;</p> <p>fsl,spi-num-chipselects = &lt;2&gt;;     cs-gpios = &lt;&amp;gpio4 26 GPIO_ACTIVE_LOW&gt;, &lt;&amp;gpio4 24 GPIO_ACTIVE_LOW&gt;;     status = \"okay\";</p> <pre><code>oled: oled {\n    compatible = \"spidev\";\n    reg = &lt;0&gt;;\n    spi-max-frequency = &lt;10000000&gt;;\n};\n</code></pre> <p>}; ```</p> </li> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bIMX6ULL\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/100ask_imx6ull-14x14.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/100ask_imx6ull-14x14.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"11_SPI/10_1/#22-stm32mp157","title":"2.2 STM32MP157","text":""},{"location":"11_SPI/10_1/#221","title":"2.2.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"11_SPI/10_1/#222","title":"2.2.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li> <p>\u200b\u4fee\u6539\u200b\u8bbe\u5907\u200b\u6811\u200b<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dts</code></p> <p><code>shell &amp;spi5 {         pinctrl-names = \"default\", \"sleep\";         pinctrl-0 = &lt;&amp;spi5_pins_a&gt;;         pinctrl-1 = &lt;&amp;spi5_sleep_pins_a&gt;;     status = \"okay\";         cs-gpios = &lt;&amp;gpioh 5 GPIO_ACTIVE_LOW&gt;, &lt;&amp;gpioz 4 GPIO_ACTIVE_LOW&gt;;         spidev: icm20608@0{                 compatible = \"invensense,icm20608\";                 interrupts = &lt;0 IRQ_TYPE_EDGE_FALLING&gt;;                 interrupt-parent = &lt;&amp;gpioz&gt;;                 spi-max-frequency = &lt;8000000&gt;;                 reg = &lt;0&gt;;         };         oled: oled@1{                 compatible = \"spidev\";                 spi-max-frequency = &lt;10000000&gt;;                 reg = &lt;1&gt;;         }; };</code></p> </li> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bSTM32MP157\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u6811\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b\u54ea\u91cc\u200b</p> </li> </ul> <p>\u200b\u7531\u4e8e\u200b\u7248\u672c\u200b\u53d8\u5316\u200b\uff0cSTM32MP157\u200b\u5355\u677f\u200b\u4e0a\u200b\u70e7\u5f55\u200b\u7684\u200b\u7cfb\u7edf\u200b\u53ef\u80fd\u200b\u6709\u200b\u7ec6\u5fae\u5dee\u522b\u200b\u3002   \u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b<code>cat /proc/mounts</code>\u200b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u4e24\u79cd\u200b\u7ed3\u679c\u200b(\u200b\u89c1\u200b\u4e0b\u56fe\u200b)\uff1a</p> <ul> <li> <p>mmcblk2p2\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u5de6\u8fb9\u200b)\uff1a\u200b\u65e0\u9700\u200b\u7279\u6b8a\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u4e0b\u9762\u200b\u628a\u200b\u6587\u4ef6\u200b\u590d\u5236\u5230\u200b/boot\u200b\u76ee\u5f55\u200b\u5373\u53ef\u200b</p> </li> <li> <p>mmcblk2p2\u200b\u6302\u8f7d\u200b\u5728\u200b/mnt\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u53f3\u8fb9\u200b)</p> <ul> <li>\u200b\u5728\u200b\u89c6\u9891\u200b\u91cc\u200b\u3001\u200b\u540e\u9762\u200b\u6587\u6863\u200b\u91cc\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u66f4\u65b0\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u7684\u200b\u6587\u4ef6\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8981\u200b\u5148\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u91cd\u65b0\u200b\u6302\u8f7d\u200b\uff1a</li> <li><code>mount  /dev/mmcblk2p2  /boot</code></li> </ul> <p></p> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> </ul> <pre><code>[root@100ask:~]# cp /mnt/stm32mp157c-100ask-512d-lcd-v1.dtb /boot/\n[root@100ask:~]# sync\n</code></pre> <ul> <li>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</li> </ul>"},{"location":"11_SPI/10_1/#3-spidev","title":"3. \u200b\u7f16\u8bd1\u200bspidev\u200b\u9a71\u52a8","text":"<p>\u200b\u9996\u5148\u200b\u8981\u200b\u786e\u5b9a\u200b\u5185\u6838\u200b\u4e2d\u200b\u5df2\u7ecf\u200b\u542b\u6709\u200bspidev\u3002\u200b\u5728\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200bmake menuconfig\uff0c\u200b\u67e5\u770b\u200b\u662f\u5426\u200b\u6709\u200b\u6539\u200b\u9a71\u52a8\u200b\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\uff1a</p> <pre><code>-&gt; Device Drivers\n  -&gt; SPI support (SPI [=y]) \n    &lt; &gt;   User mode SPI device driver support  \n</code></pre> <p>\u200b\u5982\u679c\u200b<code>User mode SPI device driver support</code>\u200b\u524d\u9762\u200b\u4e0d\u662f\u200b<code>&lt;Y&gt;</code>\u200b\u6216\u200b<code>&lt;M&gt;</code>\uff0c\u200b\u53ef\u4ee5\u200b\u8f93\u5165\u200b<code>M</code>\u200b\u8868\u793a\u200b\u628a\u200b\u5b83\u200b\u7f16\u8bd1\u200b\u4e3a\u200b\u6a21\u5757\u200b\u3002</p> <ul> <li>\u200b\u5982\u679c\u200b\u5df2\u7ecf\u200b\u662f\u200b<code>&lt;Y&gt;</code>\uff0c\u200b\u5219\u200b\u4e0d\u7528\u200b\u518d\u200b\u505a\u200b\u5176\u4ed6\u200b\u4e8b\u60c5\u200b\u3002</li> <li>\u200b\u5982\u679c\u200b\u4f60\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b<code>&lt;M&gt;</code>\uff0c\u200b\u5728\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b<code>make modules</code>\uff0c\u200b\u628a\u200b\u751f\u6210\u200b\u7684\u200b<code>drivers/spi/spidev.ko</code>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\u5907\u7528\u200b</li> </ul>"},{"location":"11_SPI/10_1/#4-app","title":"4. \u200b\u7f16\u8bd1\u200bAPP","text":"<pre><code>arm-buildroot-linux-gnueabihf-gcc -o spi_oled spi_oled.c\n</code></pre>"},{"location":"11_SPI/10_1/#5","title":"5. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<p>\u200b\u5982\u679c\u200bspidev\u200b\u6ca1\u6709\u200b\u88ab\u200b\u7f16\u8bd1\u200b\u8fdb\u200b\u5185\u6838\u200b\uff0c\u200b\u90a3\u4e48\u200b\u5148\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>insmod spidev.ko\n</code></pre> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\uff1a</p> <pre><code>ls /dev/spidev*\n</code></pre> <p>\u200b\u6267\u884c\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b\uff1a</p> <pre><code>// IMX6ULL\n./spi_oled /dev/spidev0.0 116\n\n// STM32MP157\n// \u200b\u5728\u200buboot\u200b\u91cc\u200bGPIOA13\u200b\u88ab\u200b\u914d\u7f6e\u200b\u4e3a\u200bopen drain\u200b\u4e86\u200b, \u200b\u5148\u200b\u628a\u200b\u5b83\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b\u63a8\u633d\u200b\u8f93\u51fa\u200b\ndevmem 0x50000a28 32 1; devmem 0x50002004 32 0  \n./spi_oled /dev/spidev0.1 13\n</code></pre>"},{"location":"11_SPI/11_1/","title":"\u7f16\u5199\u200bSPI\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>\u200b\u5185\u6838\u200b\u5934\u6587\u4ef6\u200b\uff1a<code>include\\linux\\spi\\spi.h</code></p> </li> <li> <p>\u200b\u5185\u6838\u200b\u6587\u6863\u200b\uff1a<code>Documentation\\spi\\spidev</code> </p> </li> </ul>"},{"location":"11_SPI/11_1/#1-spi","title":"1. SPI\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":""},{"location":"11_SPI/11_1/#2-spi","title":"2. \u200b\u600e\u4e48\u200b\u7f16\u5199\u200bSPI\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f","text":""},{"location":"11_SPI/11_1/#21","title":"2.1 \u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li> <p>\u200b\u67e5\u770b\u200b\u539f\u7406\u56fe\u200b\uff0c\u200b\u786e\u5b9a\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u94fe\u63a5\u200b\u5728\u200b\u54ea\u4e2a\u200bSPI\u200b\u63a7\u5236\u5668\u200b\u4e0b\u200b</p> </li> <li> <p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\uff0c\u200b\u627e\u5230\u200bSPI\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u8282\u70b9\u200b</p> </li> <li> <p>\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u8282\u70b9\u200b\u4e0b\u200b\uff0c\u200b\u521b\u5efa\u200b\u5b50\u200b\u8282\u70b9\u200b\uff0c\u200b\u7528\u6765\u200b\u8868\u793a\u200bSPI\u200b\u8bbe\u5907\u200b</p> </li> <li> <p>\u200b\u793a\u4f8b\u200b\u5982\u4e0b\u200b\uff1a</p> </li> </ul> <pre><code>&amp;ecspi1 {\n    pinctrl-names = \"default\";\n    pinctrl-0 = &lt;&amp;pinctrl_ecspi1&gt;;\n\n    fsl,spi-num-chipselects = &lt;2&gt;;\n    cs-gpios = &lt;&amp;gpio4 26 GPIO_ACTIVE_LOW&gt;, &lt;&amp;gpio4 24 GPIO_ACTIVE_LOW&gt;;\n    status = \"okay\";\n\n    dac: dac {\n        compatible = \"100ask,dac\";\n        reg = &lt;0&gt;;\n        spi-max-frequency = &lt;10000000&gt;;\n    };\n};\n</code></pre>"},{"location":"11_SPI/11_1/#22-spi_driver","title":"2.2 \u200b\u6ce8\u518c\u200bspi_driver","text":"<p>SPI\u200b\u8bbe\u5907\u200b\u7684\u200b\u8bbe\u5907\u200b\u6811\u200b\u8282\u70b9\u200b\uff0c\u200b\u4f1a\u200b\u88ab\u200b\u8f6c\u6362\u200b\u4e3a\u200b\u4e00\u4e2a\u200bspi_device\u200b\u7ed3\u6784\u200b\u4f53\u200b\u3002</p> <p>\u200b\u6211\u4eec\u200b\u9700\u8981\u200b\u7f16\u5199\u200b\u4e00\u4e2a\u200bspi_driver\u200b\u6765\u200b\u652f\u6301\u200b\u5b83\u200b\u3002</p> <p>\u200b\u793a\u4f8b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>static const struct of_device_id dac_of_match[] = {\n    {.compatible = \"100ask,dac\"},\n    {}\n};\n\nstatic struct spi_driver dac_driver = {\n    .driver = {\n        .name   = \"dac\",\n        .of_match_table = dac_of_match,\n    },\n    .probe      = dac_probe,\n    .remove     = dac_remove,\n    //.id_table = dac_spi_ids,\n};\n</code></pre>"},{"location":"11_SPI/11_1/#23-spi","title":"2.3 \u200b\u600e\u4e48\u200b\u53d1\u8d77\u200bSPI\u200b\u4f20\u8f93","text":""},{"location":"11_SPI/11_1/#231","title":"2.3.1 \u200b\u63a5\u53e3\u51fd\u6570","text":"<p>\u200b\u63a5\u53e3\u51fd\u6570\u200b\u90fd\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u5185\u6838\u200b\u6587\u4ef6\u200b\u91cc\u200b\uff1a<code>include\\linux\\spi\\spi.h</code></p> <ul> <li>\u200b\u7b80\u6613\u200b\u51fd\u6570\u200b</li> </ul> <pre><code>/**\n * SPI\u200b\u540c\u6b65\u200b\u5199\u200b\n * @spi: \u200b\u5199\u200b\u54ea\u4e2a\u200b\u8bbe\u5907\u200b\n * @buf: \u200b\u6570\u636e\u200bbuffer\n * @len: \u200b\u957f\u5ea6\u200b\n * \u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u53ef\u4ee5\u200b\u4f11\u7720\u200b\n *\n * \u200b\u8fd4\u56de\u503c\u200b: 0-\u200b\u6210\u529f\u200b, \u200b\u8d1f\u6570\u200b-\u200b\u5931\u8d25\u200b\u7801\u200b\n */\nstatic inline int\nspi_write(struct spi_device *spi, const void *buf, size_t len);\n\n/**\n * SPI\u200b\u540c\u6b65\u200b\u8bfb\u200b\n * @spi: \u200b\u8bfb\u200b\u54ea\u4e2a\u200b\u8bbe\u5907\u200b\n * @buf: \u200b\u6570\u636e\u200bbuffer\n * @len: \u200b\u957f\u5ea6\u200b\n * \u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u53ef\u4ee5\u200b\u4f11\u7720\u200b\n *\n * \u200b\u8fd4\u56de\u503c\u200b: 0-\u200b\u6210\u529f\u200b, \u200b\u8d1f\u6570\u200b-\u200b\u5931\u8d25\u200b\u7801\u200b\n */\nstatic inline int\nspi_read(struct spi_device *spi, void *buf, size_t len);\n\n\n/**\n * spi_write_then_read : \u200b\u5148\u5199\u200b\u518d\u200b\u8bfb\u200b, \u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u540c\u6b65\u200b\u51fd\u6570\u200b\n * @spi: \u200b\u8bfb\u5199\u200b\u54ea\u4e2a\u200b\u8bbe\u5907\u200b\n * @txbuf: \u200b\u53d1\u9001\u200bbuffer\n * @n_tx: \u200b\u53d1\u9001\u200b\u591a\u5c11\u200b\u5b57\u8282\u200b\n * @rxbuf: \u200b\u63a5\u6536\u200bbuffer\n * @n_rx: \u200b\u63a5\u6536\u200b\u591a\u5c11\u200b\u5b57\u8282\u200b\n * \u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u53ef\u4ee5\u200b\u4f11\u7720\u200b\n * \n * \u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u6267\u884c\u200b\u7684\u200b\u662f\u200b\u534a\u53cc\u5de5\u200b\u7684\u200b\u64cd\u4f5c\u200b: \u200b\u5148\u200b\u53d1\u9001\u200btxbuf\u200b\u4e2d\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u5728\u200b\u8bfb\u6570\u636e\u200b\uff0c\u200b\u8bfb\u5230\u200b\u7684\u200b\u6570\u636e\u200b\u5b58\u5165\u200brxbuf\n *\n * \u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u7528\u6765\u200b\u4f20\u8f93\u200b\u5c11\u91cf\u200b\u6570\u636e\u200b(\u200b\u5efa\u8bae\u200b\u4e0d\u8981\u200b\u64cd\u4f5c\u200b32\u200b\u5b57\u8282\u200b), \u200b\u5b83\u200b\u7684\u200b\u6548\u7387\u200b\u4e0d\u9ad8\u200b\n * \u200b\u5982\u679c\u200b\u60f3\u200b\u8fdb\u884c\u200b\u9ad8\u6548\u200b\u7684\u200bSPI\u200b\u4f20\u8f93\u200b\uff0c\u200b\u8bf7\u200b\u4f7f\u7528\u200bspi_{async,sync}(\u200b\u8fd9\u4e9b\u200b\u51fd\u6570\u200b\u4f7f\u7528\u200bDMA buffer)\n *\n * \u200b\u8fd4\u56de\u503c\u200b: 0-\u200b\u6210\u529f\u200b, \u200b\u8d1f\u6570\u200b-\u200b\u5931\u8d25\u200b\u7801\u200b\n */\nextern int spi_write_then_read(struct spi_device *spi,\n      const void *txbuf, unsigned n_tx,\n      void *rxbuf, unsigned n_rx);\n\n/**\n * spi_w8r8 - \u200b\u540c\u6b65\u200b\u51fd\u6570\u200b\uff0c\u200b\u5148\u5199\u200b8\u200b\u4f4d\u200b\u6570\u636e\u200b\uff0c\u200b\u518d\u200b\u8bfb\u200b8\u200b\u4f4d\u200b\u6570\u636e\u200b\n * @spi: \u200b\u8bfb\u5199\u200b\u54ea\u4e2a\u200b\u8bbe\u5907\u200b\n * @cmd: \u200b\u8981\u200b\u5199\u200b\u7684\u200b\u6570\u636e\u200b\n * \u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u53ef\u4ee5\u200b\u4f11\u7720\u200b\n *\n *\n * \u200b\u8fd4\u56de\u503c\u200b: \u200b\u6210\u529f\u200b\u7684\u8bdd\u200b\u8fd4\u56de\u200b\u4e00\u4e2a\u200b8\u200b\u4f4d\u200b\u6570\u636e\u200b(unsigned), \u200b\u8d1f\u6570\u200b\u8868\u793a\u200b\u5931\u8d25\u200b\u7801\u200b\n */\nstatic inline ssize_t spi_w8r8(struct spi_device *spi, u8 cmd);\n\n/**\n * spi_w8r16 - \u200b\u540c\u6b65\u200b\u51fd\u6570\u200b\uff0c\u200b\u5148\u5199\u200b8\u200b\u4f4d\u200b\u6570\u636e\u200b\uff0c\u200b\u518d\u200b\u8bfb\u200b16\u200b\u4f4d\u200b\u6570\u636e\u200b\n * @spi: \u200b\u8bfb\u5199\u200b\u54ea\u4e2a\u200b\u8bbe\u5907\u200b\n * @cmd: \u200b\u8981\u200b\u5199\u200b\u7684\u200b\u6570\u636e\u200b\n * \u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u53ef\u4ee5\u200b\u4f11\u7720\u200b\n *\n * \u200b\u8bfb\u5230\u200b\u7684\u200b16\u200b\u4f4d\u200b\u6570\u636e\u200b: \n *     \u200b\u4f4e\u200b\u5730\u5740\u200b\u5bf9\u5e94\u200b\u8bfb\u5230\u200b\u7684\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u5b57\u8282\u200b(MSB)\uff0c\u200b\u9ad8\u200b\u5730\u5740\u200b\u5bf9\u5e94\u200b\u8bfb\u5230\u200b\u7684\u200b\u7b2c\u200b2\u200b\u4e2a\u200b\u5b57\u8282\u200b(LSB)\n *     \u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200bbig-endian\u200b\u7684\u200b\u6570\u636e\u200b\n *\n * \u200b\u8fd4\u56de\u503c\u200b: \u200b\u6210\u529f\u200b\u7684\u8bdd\u200b\u8fd4\u56de\u200b\u4e00\u4e2a\u200b16\u200b\u4f4d\u200b\u6570\u636e\u200b(unsigned), \u200b\u8d1f\u6570\u200b\u8868\u793a\u200b\u5931\u8d25\u200b\u7801\u200b\n */\nstatic inline ssize_t spi_w8r16(struct spi_device *spi, u8 cmd);\n\n/**\n * spi_w8r16be - \u200b\u540c\u6b65\u200b\u51fd\u6570\u200b\uff0c\u200b\u5148\u5199\u200b8\u200b\u4f4d\u200b\u6570\u636e\u200b\uff0c\u200b\u518d\u200b\u8bfb\u200b16\u200b\u4f4d\u200b\u6570\u636e\u200b\uff0c\n *               \u200b\u8bfb\u5230\u200b\u7684\u200b16\u200b\u4f4d\u200b\u6570\u636e\u200b\u88ab\u200b\u5f53\u505a\u200bbig-endian\uff0c\u200b\u7136\u540e\u200b\u8f6c\u6362\u200b\u4e3a\u200bCPU\u200b\u4f7f\u7528\u200b\u7684\u200b\u5b57\u8282\u200b\u5e8f\u200b\n * @spi: \u200b\u8bfb\u5199\u200b\u54ea\u4e2a\u200b\u8bbe\u5907\u200b\n * @cmd: \u200b\u8981\u200b\u5199\u200b\u7684\u200b\u6570\u636e\u200b\n * \u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u53ef\u4ee5\u200b\u4f11\u7720\u200b\n *\n * \u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u8ddf\u200bspi_w8r16\u200b\u7c7b\u4f3c\u200b\uff0c\u200b\u5dee\u522b\u200b\u5728\u4e8e\u200b\u5b83\u200b\u8bfb\u200b\u5230\u200b16\u200b\u4f4d\u200b\u6570\u636e\u200b\u540e\u200b\uff0c\u200b\u4f1a\u200b\u628a\u200b\u5b83\u200b\u8f6c\u6362\u200b\u4e3a\u200b\"native endianness\"\n *\n * \u200b\u8fd4\u56de\u503c\u200b: \u200b\u6210\u529f\u200b\u7684\u8bdd\u200b\u8fd4\u56de\u200b\u4e00\u4e2a\u200b16\u200b\u4f4d\u200b\u6570\u636e\u200b(unsigned, \u200b\u88ab\u200b\u8f6c\u6362\u200b\u4e3a\u200b\u672c\u5730\u200b\u5b57\u8282\u200b\u5e8f\u200b), \u200b\u8d1f\u6570\u200b\u8868\u793a\u200b\u5931\u8d25\u200b\u7801\u200b\n */\nstatic inline ssize_t spi_w8r16be(struct spi_device *spi, u8 cmd);\n</code></pre> <ul> <li>\u200b\u590d\u6742\u200b\u7684\u200b\u51fd\u6570\u200b</li> </ul> <p>```c   /**    * spi_async - \u200b\u5f02\u6b65\u200bSPI\u200b\u4f20\u8f93\u200b\u51fd\u6570\u200b\uff0c\u200b\u7b80\u5355\u200b\u5730\u8bf4\u200b\u5c31\u662f\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u5373\u523b\u200b\u8fd4\u56de\u200b\uff0c\u200b\u5b83\u200b\u8fd4\u56de\u200b\u540e\u200bSPI\u200b\u4f20\u8f93\u200b\u4e0d\u200b\u4e00\u5b9a\u200b\u5df2\u7ecf\u200b\u5b8c\u6210\u200b    * @spi: \u200b\u8bfb\u5199\u200b\u54ea\u4e2a\u200b\u8bbe\u5907\u200b    * @message: \u200b\u7528\u6765\u200b\u63cf\u8ff0\u200b\u6570\u636e\u4f20\u8f93\u200b\uff0c\u200b\u91cc\u9762\u200b\u542b\u6709\u200b\u5b8c\u6210\u200b\u65f6\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b(completion callback)    * \u200b\u4e0a\u4e0b\u6587\u200b: \u200b\u4efb\u610f\u200b\u4e0a\u4e0b\u6587\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\uff0c\u200b\u4e2d\u65ad\u200b\u4e2d\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b    *    * \u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u4e0d\u4f1a\u200b\u4f11\u7720\u200b\uff0c\u200b\u5b83\u200b\u53ef\u4ee5\u200b\u5728\u200b\u4e2d\u65ad\u200b\u4e0a\u4e0b\u6587\u200b\u4f7f\u7528\u200b(\u200b\u65e0\u6cd5\u200b\u4f11\u7720\u200b\u7684\u200b\u4e0a\u4e0b\u6587\u200b)\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u5728\u200b\u4efb\u52a1\u200b\u4e0a\u4e0b\u6587\u200b\u4f7f\u7528\u200b(\u200b\u53ef\u4ee5\u200b\u4f11\u7720\u200b\u7684\u200b\u4e0a\u4e0b\u6587\u200b)     *    * \u200b\u5b8c\u6210\u200bSPI\u200b\u4f20\u8f93\u200b\u540e\u200b\uff0c\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b\uff0c\u200b\u5b83\u200b\u662f\u200b\u5728\u200b\"\u200b\u65e0\u6cd5\u200b\u4f11\u7720\u200b\u7684\u200b\u4e0a\u4e0b\u6587\u200b\"\u200b\u4e2d\u200b\u88ab\u200b\u8c03\u7528\u200b\u7684\u200b\uff0c\u200b\u6240\u4ee5\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u91cc\u200b\u4e0d\u80fd\u200b\u6709\u200b\u4f11\u7720\u200b\u64cd\u4f5c\u200b\u3002    * \u200b\u5728\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b\u524d\u200bmessage-&gt;statuss\u200b\u662f\u200b\u672a\u5b9a\u4e49\u200b\u7684\u200b\u503c\u200b\uff0c\u200b\u6ca1\u6709\u200b\u610f\u4e49\u200b\u3002    * \u200b\u5f53\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b\u65f6\u200b\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u6839\u636e\u200bmessage-&gt;status\u200b\u5224\u65ad\u200b\u7ed3\u679c\u200b: 0-\u200b\u6210\u529f\u200b,\u200b\u8d1f\u6570\u200b\u8868\u793a\u200b\u5931\u8d25\u200b\u7801\u200b    * \u200b\u5f53\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u6267\u884c\u200b\u5b8c\u540e\u200b\uff0c\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u8981\u200b\u8ba4\u4e3a\u200bmessage\u200b\u7b49\u200b\u7ed3\u6784\u200b\u4f53\u200b\u5df2\u7ecf\u200b\u88ab\u200b\u91ca\u653e\u200b\uff0c\u200b\u4e0d\u80fd\u200b\u518d\u200b\u4f7f\u7528\u200b\u5b83\u4eec\u200b\u3002  *    * \u200b\u5728\u200b\u4f20\u8f93\u200b\u8fc7\u7a0b\u200b\u4e2d\u200b\u4e00\u65e6\u200b\u53d1\u751f\u200b\u9519\u8bef\u200b\uff0c\u200b\u6574\u4e2a\u200bmessage\u200b\u4f20\u8f93\u200b\u90fd\u200b\u4f1a\u200b\u4e2d\u6b62\u200b\uff0c\u200b\u5bf9\u200bspi\u200b\u8bbe\u5907\u200b\u7684\u200b\u7247\u9009\u200b\u88ab\u200b\u53d6\u6d88\u200b\u3002    *    * \u200b\u8fd4\u56de\u503c\u200b: 0-\u200b\u6210\u529f\u200b(\u200b\u53ea\u662f\u200b\u8868\u793a\u200b\u542f\u52a8\u200b\u7684\u200b\u5f02\u6b65\u200b\u4f20\u8f93\u200b\uff0c\u200b\u5e76\u200b\u4e0d\u200b\u8868\u793a\u200b\u5df2\u7ecf\u200b\u4f20\u8f93\u200b\u6210\u529f\u200b), \u200b\u8d1f\u6570\u200b-\u200b\u5931\u8d25\u200b\u7801\u200b    */   extern int spi_async(struct spi_device *spi, struct spi_message *message);</p> <p>/**    * spi_sync - \u200b\u540c\u6b65\u200b\u7684\u200b\u3001\u200b\u963b\u585e\u200b\u7684\u200bSPI\u200b\u4f20\u8f93\u200b\u51fd\u6570\u200b\uff0c\u200b\u7b80\u5355\u200b\u5730\u8bf4\u200b\u5c31\u662f\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u8fd4\u56de\u200b\u65f6\u200b\uff0cSPI\u200b\u4f20\u8f93\u200b\u8981\u4e48\u200b\u6210\u529f\u200b\u8981\u4e48\u200b\u5931\u8d25\u200b    * @spi: \u200b\u8bfb\u5199\u200b\u54ea\u4e2a\u200b\u8bbe\u5907\u200b    * @message: \u200b\u7528\u6765\u200b\u63cf\u8ff0\u200b\u6570\u636e\u4f20\u8f93\u200b\uff0c\u200b\u91cc\u9762\u200b\u542b\u6709\u200b\u5b8c\u6210\u200b\u65f6\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b(completion callback)    * \u200b\u4e0a\u4e0b\u6587\u200b: \u200b\u80fd\u200b\u4f11\u7720\u200b\u7684\u200b\u4e0a\u4e0b\u6587\u200b\u624d\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b    *    * \u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u7684\u200bmessage\u200b\u53c2\u6570\u200b\u4e2d\u200b\uff0c\u200b\u4f7f\u7528\u200b\u7684\u200bbuffer\u200b\u662f\u200bDMA buffer    *    * \u200b\u8fd4\u56de\u503c\u200b: 0-\u200b\u6210\u529f\u200b, \u200b\u8d1f\u6570\u200b-\u200b\u5931\u8d25\u200b\u7801\u200b    */   extern int spi_sync(struct spi_device *spi, struct spi_message *message);</p> <p>/**    * spi_sync_transfer - \u200b\u540c\u6b65\u200b\u7684\u200bSPI\u200b\u4f20\u8f93\u200b\u51fd\u6570\u200b    * @spi: \u200b\u8bfb\u5199\u200b\u54ea\u4e2a\u200b\u8bbe\u5907\u200b    * @xfers: spi_transfers\u200b\u6570\u7ec4\u200b\uff0c\u200b\u7528\u6765\u200b\u63cf\u8ff0\u200b\u4f20\u8f93\u200b    * @num_xfers: \u200b\u6570\u7ec4\u200b\u9879\u200b\u4e2a\u6570\u200b    * \u200b\u4e0a\u4e0b\u6587\u200b: \u200b\u80fd\u200b\u4f11\u7720\u200b\u7684\u200b\u4e0a\u4e0b\u6587\u200b\u624d\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b    *    * \u200b\u8fd4\u56de\u503c\u200b: 0-\u200b\u6210\u529f\u200b, \u200b\u8d1f\u6570\u200b-\u200b\u5931\u8d25\u200b\u7801\u200b    */   static inline int   spi_sync_transfer(struct spi_device *spi, struct spi_transfer *xfers,     unsigned int num_xfers);   ```</p>"},{"location":"11_SPI/11_1/#232","title":"2.3.2 \u200b\u51fd\u6570\u200b\u89e3\u6790","text":"<p>\u200b\u5728\u200bSPI\u200b\u5b50\u7cfb\u7edf\u200b\u4e2d\u200b\uff0c\u200b\u7528\u200bspi_transfer\u200b\u7ed3\u6784\u200b\u4f53\u200b\u63cf\u8ff0\u200b\u4e00\u4e2a\u200b\u4f20\u8f93\u200b\uff0c\u200b\u7528\u200bspi_message\u200b\u7ba1\u7406\u200b\u8fc7\u4e2a\u200b\u4f20\u8f93\u200b\u3002</p> <p>SPI\u200b\u4f20\u8f93\u200b\u65f6\u200b\uff0c\u200b\u53d1\u51fa\u200bN\u200b\u4e2a\u200b\u5b57\u8282\u200b\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u540c\u65f6\u200b\u5f97\u5230\u200bN\u200b\u4e2a\u200b\u5b57\u8282\u200b\u3002</p> <ul> <li>\u200b\u5373\u4f7f\u200b\u53ea\u60f3\u8bfb\u200bN\u200b\u4e2a\u200b\u5b57\u8282\u200b\uff0c\u200b\u4e5f\u200b\u5fc5\u987b\u200b\u53d1\u51fa\u200bN\u200b\u4e2a\u200b\u5b57\u8282\u200b\uff1a\u200b\u53ef\u4ee5\u200b\u53d1\u51fa\u200b0xff</li> <li>\u200b\u5373\u4f7f\u200b\u53ea\u60f3\u200b\u53d1\u51fa\u200bN\u200b\u4e2a\u200b\u5b57\u8282\u200b\uff0c\u200b\u4e5f\u200b\u4f1a\u200b\u8bfb\u200b\u5230\u200bN\u200b\u4e2a\u200b\u5b57\u8282\u200b\uff1a\u200b\u53ef\u4ee5\u200b\u5ffd\u7565\u200b\u8bfb\u5230\u200b\u7684\u200b\u6570\u636e\u200b\u3002</li> </ul> <p>spi_transfer\u200b\u7ed3\u6784\u200b\u4f53\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b\uff1a</p> <ul> <li>tx_buf\uff1a\u200b\u4e0d\u662f\u200bNULL\u200b\u7684\u8bdd\u200b\uff0c\u200b\u8981\u200b\u53d1\u9001\u200b\u7684\u200b\u6570\u636e\u200b\u4fdd\u5b58\u200b\u5728\u200b\u91cc\u9762\u200b</li> <li>rx_buf\uff1a\u200b\u4e0d\u662f\u200bNULL\u200b\u7684\u8bdd\u200b\uff0c\u200b\u8868\u793a\u200b\u8bfb\u5230\u200b\u7684\u200b\u6570\u636e\u200b\u4e0d\u8981\u200b\u4e22\u5f03\u200b\uff0c\u200b\u4fdd\u5b58\u200b\u8fdb\u200brx_buf\u200b\u91cc\u200b</li> </ul> <p></p> <p>\u200b\u53ef\u4ee5\u200b\u6784\u9020\u200b\u591a\u4e2a\u200bspi_transfer\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u628a\u200b\u5b83\u4eec\u200b\u653e\u5165\u200b\u4e00\u4e2a\u200bspi_message\u200b\u91cc\u9762\u200b\u3002</p> <p>spi_message\u200b\u7ed3\u6784\u200b\u4f53\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b\uff1a</p> <p></p> <p>SPI\u200b\u4f20\u8f93\u200b\u793a\u4f8b\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/12_1/","title":"\u7f16\u5199\u200bSPI_DAC\u200b\u6a21\u5757\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>DAC\u200b\u82af\u7247\u200b\u624b\u518c\u200b\uff1a<code>TLC5615.pdf</code></li> </ul>"},{"location":"11_SPI/12_1/#1","title":"1. \u200b\u8981\u200b\u505a\u200b\u4ec0\u4e48\u200b\u4e8b\u60c5","text":"<ul> <li>\u200b\u67e5\u770b\u200b\u539f\u7406\u56fe\u200b\uff0c\u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811\u200b</li> <li>\u200b\u7f16\u5199\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u6ce8\u518c\u200b\u4e00\u4e2a\u200bspidrv</li> <li>\u200b\u7f16\u5199\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b</li> </ul>"},{"location":"11_SPI/12_1/#2","title":"2. \u200b\u786c\u4ef6","text":""},{"location":"11_SPI/12_1/#21","title":"2.1 \u200b\u539f\u7406\u56fe","text":"<p>IMX6ULL:</p> <p></p> <p>STM32MP157:</p> <p></p> <p>\u200b\u539f\u7406\u56fe\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/12_1/#22","title":"2.2 \u200b\u8fde\u63a5","text":""},{"location":"11_SPI/12_1/#221-imx6ull","title":"2.2.1 IMX6ULL","text":"<p>DAC\u200b\u6a21\u5757\u200b\u63a5\u5230\u200bIMX6ULL\u200b\u6269\u5c55\u200b\u677f\u200b\u7684\u200bSPI_A\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/12_1/#222-stm32mp157","title":"2.2.2 STM32MP157","text":""},{"location":"11_SPI/12_1/#3","title":"3. \u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811","text":"<p>\u200b\u786e\u8ba4\u200bSPI\u200b\u65f6\u949f\u200b\u6700\u5927\u200b\u9891\u7387\u200b\uff1a</p> <p></p> <pre><code>T = 25 + 25 = 50ns\nF = 20000000 = 20MHz\n</code></pre> <p>\u200b\u8bbe\u5907\u200b\u6811\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>    dac: dac {\n        compatible = \"100ask,dac\";\n        reg = &lt;0&gt;;\n        spi-max-frequency = &lt;20000000&gt;;\n    };\n</code></pre>"},{"location":"11_SPI/12_1/#31-imx6ull","title":"3.1 IMX6ULL","text":"<p>DAC\u200b\u6a21\u5757\u200b\u63a5\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff0c\u200b\u90a3\u4e48\u200b\u8981\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200bspi1\u200b\u7684\u200b\u8282\u70b9\u200b\u4e0b\u200b\u521b\u5efa\u200b\u5b50\u200b\u8282\u70b9\u200b\u3002</p> <p>\u200b\u4ee3\u7801\u200b\u5728\u200b<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code>\u200b\u4e2d\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>&amp;ecspi1 {\n    pinctrl-names = \"default\";\n    pinctrl-0 = &lt;&amp;pinctrl_ecspi1&gt;;\n\n    fsl,spi-num-chipselects = &lt;2&gt;;\n    cs-gpios = &lt;&amp;gpio4 26 GPIO_ACTIVE_LOW&gt;, &lt;&amp;gpio4 24 GPIO_ACTIVE_LOW&gt;;\n    status = \"okay\";\n\n    dac: dac {\n        compatible = \"100ask,dac\";\n        reg = &lt;0&gt;;\n        spi-max-frequency = &lt;20000000&gt;;\n    };\n};\n</code></pre>"},{"location":"11_SPI/12_1/#32-stm32mp157","title":"3.2 STM32MP157","text":"<p>DAC\u200b\u6a21\u5757\u200b\u63a5\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff0c\u200b\u90a3\u4e48\u200b\u8981\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200bspi5\u200b\u7684\u200b\u8282\u70b9\u200b\u4e0b\u200b\u521b\u5efa\u200b\u5b50\u200b\u8282\u70b9\u200b\u3002</p> <p>\u200b\u4ee3\u7801\u200b\u5728\u200b<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dts</code>\u200b\u4e2d\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>&amp;spi5 {\n        pinctrl-names = \"default\", \"sleep\";\n        pinctrl-0 = &lt;&amp;spi5_pins_a&gt;;\n        pinctrl-1 = &lt;&amp;spi5_sleep_pins_a&gt;;\n        status = \"okay\";\n        cs-gpios = &lt;&amp;gpioh 5 GPIO_ACTIVE_LOW&gt;, &lt;&amp;gpioz 4 GPIO_ACTIVE_LOW&gt;;\n        spidev: icm20608@0{\n                compatible = \"invensense,icm20608\";\n                interrupts = &lt;0 IRQ_TYPE_EDGE_FALLING&gt;;\n                interrupt-parent = &lt;&amp;gpioz&gt;;\n                spi-max-frequency = &lt;8000000&gt;;\n                reg = &lt;0&gt;;\n        };\n        dac_test: dac_test@1{\n                compatible = \"100ask,dac\";\n                spi-max-frequency = &lt;20000000&gt;;\n                reg = &lt;1&gt;;\n        };\n};\n</code></pre>"},{"location":"11_SPI/12_1/#4","title":"4. \u200b\u7f16\u5199\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>\u200b\u4ee5\u524d\u200b\u6211\u4eec\u200b\u57fa\u4e8e\u200bspidev\u200b\u7f16\u5199\u200b\u8fc7\u200bDAC\u200b\u7684\u200b\u5e94\u7528\u7a0b\u5e8f\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u53c2\u8003\u200b\u5b83\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/12_1/#5","title":"5. \u200b\u7f16\u5199\u200b\u6d4b\u8bd5\u7a0b\u5e8f","text":""},{"location":"11_SPI/13_1/","title":"\u7f16\u5199\u200bDAC\u200b\u9a71\u52a8\u200b_\u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<ul> <li>\u200b\u6e90\u7801\u200b</li> </ul>"},{"location":"11_SPI/13_1/#1","title":"1. \u200b\u786c\u4ef6","text":""},{"location":"11_SPI/13_1/#11","title":"1.1 \u200b\u539f\u7406\u56fe","text":"<p>IMX6ULL:</p> <p></p> <p>STM32MP157:</p> <p></p> <p>\u200b\u539f\u7406\u56fe\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/13_1/#12","title":"1.2 \u200b\u8fde\u63a5","text":""},{"location":"11_SPI/13_1/#121-imx6ull","title":"1.2.1 IMX6ULL","text":"<p>DAC\u200b\u6a21\u5757\u200b\u63a5\u5230\u200bIMX6ULL\u200b\u6269\u5c55\u200b\u677f\u200b\u7684\u200bSPI_A\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/13_1/#122-stm32mp157","title":"1.2.2 STM32MP157","text":"<p>DAC\u200b\u6a21\u5757\u200b\u63a5\u5230\u200bSTM32MP157\u200b\u6269\u5c55\u200b\u677f\u200b\u7684\u200bSPI_A\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/13_1/#2","title":"2. \u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811","text":"<p>\u200b\u786e\u8ba4\u200bSPI\u200b\u65f6\u949f\u200b\u6700\u5927\u200b\u9891\u7387\u200b\uff1a</p> <p></p> <pre><code>T = 25 + 25 = 50ns\nF = 20000000 = 20MHz\n</code></pre> <p>\u200b\u8bbe\u5907\u200b\u6811\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>    dac: dac {\n        compatible = \"100ask,dac\";\n        reg = &lt;0&gt;;\n        spi-max-frequency = &lt;20000000&gt;;\n    };\n</code></pre>"},{"location":"11_SPI/13_1/#21-imx6ull","title":"2.1 IMX6ULL","text":"<p>DAC\u200b\u6a21\u5757\u200b\u63a5\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff0c\u200b\u90a3\u4e48\u200b\u8981\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200bspi1\u200b\u7684\u200b\u8282\u70b9\u200b\u4e0b\u200b\u521b\u5efa\u200b\u5b50\u200b\u8282\u70b9\u200b\u3002</p> <p>\u200b\u4ee3\u7801\u200b\u5728\u200b<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code>\u200b\u4e2d\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>&amp;ecspi1 {\n    pinctrl-names = \"default\";\n    pinctrl-0 = &lt;&amp;pinctrl_ecspi1&gt;;\n\n    fsl,spi-num-chipselects = &lt;2&gt;;\n    cs-gpios = &lt;&amp;gpio4 26 GPIO_ACTIVE_LOW&gt;, &lt;&amp;gpio4 24 GPIO_ACTIVE_LOW&gt;;\n    status = \"okay\";\n\n    dac: dac {\n        compatible = \"100ask,dac\";\n        reg = &lt;0&gt;;\n        spi-max-frequency = &lt;20000000&gt;;\n    };\n};\n</code></pre>"},{"location":"11_SPI/13_1/#22-stm32mp157","title":"2.2 STM32MP157","text":"<p>DAC\u200b\u6a21\u5757\u200b\u63a5\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff0c\u200b\u90a3\u4e48\u200b\u8981\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200bspi5\u200b\u7684\u200b\u8282\u70b9\u200b\u4e0b\u200b\u521b\u5efa\u200b\u5b50\u200b\u8282\u70b9\u200b\u3002</p> <p>\u200b\u4ee3\u7801\u200b\u5728\u200b<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dts</code>\u200b\u4e2d\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>&amp;spi5 {\n        pinctrl-names = \"default\", \"sleep\";\n        pinctrl-0 = &lt;&amp;spi5_pins_a&gt;;\n        pinctrl-1 = &lt;&amp;spi5_sleep_pins_a&gt;;\n        status = \"okay\";\n        cs-gpios = &lt;&amp;gpioh 5 GPIO_ACTIVE_LOW&gt;, &lt;&amp;gpioz 4 GPIO_ACTIVE_LOW&gt;;\n        spidev: icm20608@0{\n                compatible = \"invensense,icm20608\";\n                interrupts = &lt;0 IRQ_TYPE_EDGE_FALLING&gt;;\n                interrupt-parent = &lt;&amp;gpioz&gt;;\n                spi-max-frequency = &lt;8000000&gt;;\n                reg = &lt;0&gt;;\n        };\n        dac_test: dac_test@1{\n                compatible = \"100ask,dac\";\n                spi-max-frequency = &lt;20000000&gt;;\n                reg = &lt;1&gt;;\n        };\n};\n</code></pre>"},{"location":"11_SPI/13_1/#3","title":"3. \u200b\u7f16\u8bd1\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"11_SPI/13_1/#31-imx6ull","title":"3.1 IMX6ULL","text":""},{"location":"11_SPI/13_1/#311","title":"3.1.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\n export PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"11_SPI/13_1/#312","title":"3.1.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bIMX6ULL\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/100ask_imx6ull-14x14.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/100ask_imx6ull-14x14.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"11_SPI/13_1/#32-stm32mp157","title":"3.2 STM32MP157","text":""},{"location":"11_SPI/13_1/#321","title":"3.2.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"11_SPI/13_1/#322","title":"3.2.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bSTM32MP157\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u6811\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b\u54ea\u91cc\u200b</p> </li> </ul> <p>\u200b\u7531\u4e8e\u200b\u7248\u672c\u200b\u53d8\u5316\u200b\uff0cSTM32MP157\u200b\u5355\u677f\u200b\u4e0a\u200b\u70e7\u5f55\u200b\u7684\u200b\u7cfb\u7edf\u200b\u53ef\u80fd\u200b\u6709\u200b\u7ec6\u5fae\u5dee\u522b\u200b\u3002   \u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b<code>cat /proc/mounts</code>\u200b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u4e24\u79cd\u200b\u7ed3\u679c\u200b(\u200b\u89c1\u200b\u4e0b\u56fe\u200b)\uff1a</p> <ul> <li> <p>mmcblk2p2\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u5de6\u8fb9\u200b)\uff1a\u200b\u65e0\u9700\u200b\u7279\u6b8a\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u4e0b\u9762\u200b\u628a\u200b\u6587\u4ef6\u200b\u590d\u5236\u5230\u200b/boot\u200b\u76ee\u5f55\u200b\u5373\u53ef\u200b</p> </li> <li> <p>mmcblk2p2\u200b\u6302\u8f7d\u200b\u5728\u200b/mnt\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u53f3\u8fb9\u200b)</p> <ul> <li>\u200b\u5728\u200b\u89c6\u9891\u200b\u91cc\u200b\u3001\u200b\u540e\u9762\u200b\u6587\u6863\u200b\u91cc\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u66f4\u65b0\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u7684\u200b\u6587\u4ef6\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8981\u200b\u5148\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u91cd\u65b0\u200b\u6302\u8f7d\u200b\uff1a</li> <li><code>mount  /dev/mmcblk2p2  /boot</code></li> </ul> <p></p> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> </ul> <pre><code>[root@100ask:~]# cp /mnt/stm32mp157c-100ask-512d-lcd-v1.dtb /boot/\n[root@100ask:~]# sync\n</code></pre> <ul> <li>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</li> </ul>"},{"location":"11_SPI/13_1/#4-dac","title":"4. \u200b\u7f16\u8bd1\u200bDAC\u200b\u9a71\u52a8","text":""},{"location":"11_SPI/13_1/#5-app","title":"5. \u200b\u7f16\u8bd1\u200bAPP","text":"<pre><code>arm-buildroot-linux-gnueabihf-gcc  -o  dac_test  dac_test.c\n</code></pre>"},{"location":"11_SPI/13_1/#6","title":"6. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<p>\u200b\u5982\u679c\u200bspidev\u200b\u6ca1\u6709\u200b\u88ab\u200b\u7f16\u8bd1\u200b\u8fdb\u200b\u5185\u6838\u200b\uff0c\u200b\u90a3\u4e48\u200b\u5148\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>insmod dac_drv.ko\n</code></pre> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\uff1a</p> <pre><code>ls /dev/100ask_dac\n</code></pre> <p>\u200b\u5047\u8bbe\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u4e3a\u200b<code>/dev/100ask_dac</code>\uff0c\u200b\u6267\u884c\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b\uff1a</p> <pre><code>./dac_test  /dev/100ask_dac  500\n./dac_test  /dev/100ask_dac  600\n./dac_test  /dev/100ask_dac  1000\n</code></pre>"},{"location":"11_SPI/14_1/","title":"\u7f16\u5199\u200bSPI_OLED\u200b\u6a21\u5757\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<ul> <li>\u200b\u6e90\u7801\u200b:</li> </ul>"},{"location":"11_SPI/14_1/#1","title":"1. \u200b\u786c\u4ef6","text":""},{"location":"11_SPI/14_1/#11","title":"1.1 \u200b\u539f\u7406\u56fe","text":"<p>IMX6ULL:</p> <p></p> <p>STM32MP157:</p> <p></p> <p>\u200b\u539f\u7406\u56fe\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/14_1/#12","title":"1.2 \u200b\u8fde\u63a5","text":"<p>\u200b\u65e0\u8bba\u662f\u200b\u4f7f\u7528\u200bIMX6ULL\u200b\u5f00\u53d1\u677f\u200b\u8fd8\u662f\u200bSTM32MP157\u200b\u5f00\u53d1\u677f\u200b\uff0c\u200b\u90fd\u200b\u6709\u200b\u7c7b\u4f3c\u200b\u7684\u200b\u6269\u5c55\u200b\u677f\u200b\u3002\u200b\u628a\u200bOLED\u200b\u6a21\u5757\u200b\u63a5\u5230\u200b\u6269\u5c55\u200b\u677f\u200b\u7684\u200bSPI_A\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/14_1/#2","title":"2. \u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"11_SPI/14_1/#211-imx6ull","title":"2.1.1 IMX6ULL","text":"<p>DC\u200b\u5f15\u811a\u200b\u4f7f\u7528\u200bGPIO4_20\uff0c\u200b\u4e5f\u200b\u9700\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u5b9a\u200b\u3002</p> <p>\u200b\u8bbe\u5907\u200b\u6811\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>&amp;ecspi1 {\n    pinctrl-names = \"default\";\n    pinctrl-0 = &lt;&amp;pinctrl_ecspi1&gt;;\n\n    fsl,spi-num-chipselects = &lt;2&gt;;\n    cs-gpios = &lt;&amp;gpio4 26 GPIO_ACTIVE_LOW&gt;, &lt;&amp;gpio4 24 GPIO_ACTIVE_LOW&gt;;\n    status = \"okay\";\n\n    oled: oled {\n        compatible = \"100ask,oled\";\n        reg = &lt;0&gt;;\n        spi-max-frequency = &lt;10000000&gt;;\n        dc-gpios = &lt;&amp;gpio4 20 GPIO_ACTIVE_HIGH&gt;; \n    };\n};\n</code></pre>"},{"location":"11_SPI/14_1/#212-stm32mp157","title":"2.1.2 STM32MP157","text":"<p>DC\u200b\u5f15\u811a\u200b\u4f7f\u7528\u200bGPIOA_13\uff0c\u200b\u4e5f\u200b\u9700\u8981\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u5b9a\u200b\u3002</p> <p>\u200b\u8bbe\u5907\u200b\u6811\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>&amp;spi5 {\n        pinctrl-names = \"default\", \"sleep\";\n        pinctrl-0 = &lt;&amp;spi5_pins_a&gt;;\n        pinctrl-1 = &lt;&amp;spi5_sleep_pins_a&gt;;\n        status = \"okay\";\n        cs-gpios = &lt;&amp;gpioh 5 GPIO_ACTIVE_LOW&gt;, &lt;&amp;gpioz 4 GPIO_ACTIVE_LOW&gt;;\n        spidev: icm20608@0{\n                compatible = \"invensense,icm20608\";\n                interrupts = &lt;0 IRQ_TYPE_EDGE_FALLING&gt;;\n                interrupt-parent = &lt;&amp;gpioz&gt;;\n                spi-max-frequency = &lt;8000000&gt;;\n                reg = &lt;0&gt;;\n        };\n        oled: oled@1{\n                compatible = \"100ask,oled\";\n                spi-max-frequency = &lt;10000000&gt;;\n                reg = &lt;1&gt;;\n                dc-gpios = &lt;&amp;gpioa 13 GPIO_ACTIVE_HIGH&gt;;\n                pinctrl-names = \"default\";\n                pinctrl-0 = &lt;&amp;oled_pins&gt;;\n        };\n};\n</code></pre> <p>arch/arm/boot/dts/stm32mp157-100ask-pinctrl.dtsi:</p> <pre><code>        oled_pins: oled_pins {\n                pins {\n                        pinmux = &lt;STM32_PINMUX('A', 13, GPIO)&gt;;\n                        bias-disable;\n                        drive-push-pull;\n                        slew-rate = &lt;1&gt;;\n                };\n        };\n</code></pre>"},{"location":"11_SPI/14_1/#3","title":"3. \u200b\u7f16\u8bd1\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"11_SPI/14_1/#31-imx6ull","title":"3.1 IMX6ULL","text":""},{"location":"11_SPI/14_1/#311","title":"3.1.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\n export PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"11_SPI/14_1/#312","title":"3.1.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bIMX6ULL\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/100ask_imx6ull-14x14.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/100ask_imx6ull-14x14.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"11_SPI/14_1/#32-stm32mp157","title":"3.2 STM32MP157","text":""},{"location":"11_SPI/14_1/#321","title":"3.2.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"11_SPI/14_1/#322","title":"3.2.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bSTM32MP157\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u6811\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b\u54ea\u91cc\u200b</p> </li> </ul> <p>\u200b\u7531\u4e8e\u200b\u7248\u672c\u200b\u53d8\u5316\u200b\uff0cSTM32MP157\u200b\u5355\u677f\u200b\u4e0a\u200b\u70e7\u5f55\u200b\u7684\u200b\u7cfb\u7edf\u200b\u53ef\u80fd\u200b\u6709\u200b\u7ec6\u5fae\u5dee\u522b\u200b\u3002   \u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b<code>cat /proc/mounts</code>\u200b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u4e24\u79cd\u200b\u7ed3\u679c\u200b(\u200b\u89c1\u200b\u4e0b\u56fe\u200b)\uff1a</p> <ul> <li> <p>mmcblk2p2\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u5de6\u8fb9\u200b)\uff1a\u200b\u65e0\u9700\u200b\u7279\u6b8a\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u4e0b\u9762\u200b\u628a\u200b\u6587\u4ef6\u200b\u590d\u5236\u5230\u200b/boot\u200b\u76ee\u5f55\u200b\u5373\u53ef\u200b</p> </li> <li> <p>mmcblk2p2\u200b\u6302\u8f7d\u200b\u5728\u200b/mnt\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u53f3\u8fb9\u200b)</p> <ul> <li>\u200b\u5728\u200b\u89c6\u9891\u200b\u91cc\u200b\u3001\u200b\u540e\u9762\u200b\u6587\u6863\u200b\u91cc\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u66f4\u65b0\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u7684\u200b\u6587\u4ef6\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8981\u200b\u5148\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u91cd\u65b0\u200b\u6302\u8f7d\u200b\uff1a</li> <li><code>mount  /dev/mmcblk2p2  /boot</code></li> </ul> <p></p> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> </ul> <pre><code>[root@100ask:~]# cp /mnt/stm32mp157c-100ask-512d-lcd-v1.dtb /boot/\n[root@100ask:~]# sync\n</code></pre> <ul> <li>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</li> </ul>"},{"location":"11_SPI/14_1/#4-oled","title":"4. \u200b\u7f16\u8bd1\u200bOLED\u200b\u9a71\u52a8","text":""},{"location":"11_SPI/14_1/#5-app","title":"5. \u200b\u7f16\u8bd1\u200bAPP","text":"<pre><code>arm-buildroot-linux-gnueabihf-gcc  -o  spi_oled  spi_oled.c\n</code></pre>"},{"location":"11_SPI/14_1/#6","title":"6. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<p>\u200b\u5982\u679c\u200bspidev\u200b\u6ca1\u6709\u200b\u88ab\u200b\u7f16\u8bd1\u200b\u8fdb\u200b\u5185\u6838\u200b\uff0c\u200b\u90a3\u4e48\u200b\u5148\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>insmod oled_drv.ko\n</code></pre> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\uff1a</p> <pre><code>ls /dev/100ask_oled\n</code></pre> <p>\u200b\u5047\u8bbe\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u4e3a\u200b<code>/dev/100ask_oled</code>\uff0c\u200b\u6267\u884c\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b\uff1a</p> <pre><code>./spi_oled  /dev/100ask_oled\n</code></pre>"},{"location":"11_SPI/15_1/","title":"\u7f16\u5199\u200bOLED\u200b\u9a71\u52a8\u200b_\u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<ul> <li>\u200b\u6e90\u7801\u200b:</li> </ul>"},{"location":"11_SPI/15_1/#1","title":"1. \u200b\u786c\u4ef6","text":""},{"location":"11_SPI/15_1/#11","title":"1.1 \u200b\u539f\u7406\u56fe","text":"<p>IMX6ULL:</p> <p></p> <p>STM32MP157:</p> <p></p> <p>\u200b\u539f\u7406\u56fe\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/15_1/#12","title":"1.2 \u200b\u8fde\u63a5","text":"<p>\u200b\u65e0\u8bba\u662f\u200b\u4f7f\u7528\u200bIMX6ULL\u200b\u5f00\u53d1\u677f\u200b\u8fd8\u662f\u200bSTM32MP157\u200b\u5f00\u53d1\u677f\u200b\uff0c\u200b\u90fd\u200b\u6709\u200b\u7c7b\u4f3c\u200b\u7684\u200b\u6269\u5c55\u200b\u677f\u200b\u3002\u200b\u628a\u200bOLED\u200b\u6a21\u5757\u200b\u63a5\u5230\u200b\u6269\u5c55\u200b\u677f\u200b\u7684\u200bSPI_A\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/15_1/#2","title":"2. \u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"11_SPI/15_1/#211-imx6ull","title":"2.1.1 IMX6ULL","text":"<p>DC\u200b\u5f15\u811a\u200b\u4f7f\u7528\u200bGPIO4_20\uff0c\u200b\u4e5f\u200b\u9700\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u5b9a\u200b\u3002</p> <p>\u200b\u8bbe\u5907\u200b\u6811\u200b\u5982\u4e0b\u200b\uff1aarch/arm/boot/dts/100ask_imx6ull-14x14.dts</p> <pre><code>&amp;ecspi1 {\n    pinctrl-names = \"default\";\n    pinctrl-0 = &lt;&amp;pinctrl_ecspi1&gt;;\n\n    fsl,spi-num-chipselects = &lt;2&gt;;\n    cs-gpios = &lt;&amp;gpio4 26 GPIO_ACTIVE_LOW&gt;, &lt;&amp;gpio4 24 GPIO_ACTIVE_LOW&gt;;\n    status = \"okay\";\n\n    oled: oled {\n        compatible = \"100ask,oled\";\n        reg = &lt;0&gt;;\n        spi-max-frequency = &lt;10000000&gt;;\n        dc-gpios = &lt;&amp;gpio4 20 GPIO_ACTIVE_HIGH&gt;; \n    };\n};\n</code></pre>"},{"location":"11_SPI/15_1/#212-stm32mp157","title":"2.1.2 STM32MP157","text":"<p>DC\u200b\u5f15\u811a\u200b\u4f7f\u7528\u200bGPIOA_13\uff0c\u200b\u4e5f\u200b\u9700\u8981\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u5b9a\u200b\u3002</p> <p>\u200b\u8bbe\u5907\u200b\u6811\u200b\u5982\u4e0b\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dts</code></p> <pre><code>&amp;spi5 {\n        pinctrl-names = \"default\", \"sleep\";\n        pinctrl-0 = &lt;&amp;spi5_pins_a&gt;;\n        pinctrl-1 = &lt;&amp;spi5_sleep_pins_a&gt;;\n        status = \"okay\";\n        cs-gpios = &lt;&amp;gpioh 5 GPIO_ACTIVE_LOW&gt;, &lt;&amp;gpioz 4 GPIO_ACTIVE_LOW&gt;;\n        spidev: icm20608@0{\n                compatible = \"invensense,icm20608\";\n                interrupts = &lt;0 IRQ_TYPE_EDGE_FALLING&gt;;\n                interrupt-parent = &lt;&amp;gpioz&gt;;\n                spi-max-frequency = &lt;8000000&gt;;\n                reg = &lt;0&gt;;\n        };\n        oled: oled@1{\n                compatible = \"100ask,oled\";\n                spi-max-frequency = &lt;10000000&gt;;\n                reg = &lt;1&gt;;\n                dc-gpios = &lt;&amp;gpioa 13 GPIO_ACTIVE_HIGH&gt;;\n                pinctrl-names = \"default\";\n                pinctrl-0 = &lt;&amp;oled_pins&gt;;\n        };\n};\n</code></pre> <p>arch/arm/boot/dts/stm32mp157-100ask-pinctrl.dtsi:</p> <pre><code>        oled_pins: oled_pins {\n                pins {\n                        pinmux = &lt;STM32_PINMUX('A', 13, GPIO)&gt;;\n                        bias-disable;\n                        drive-push-pull;\n                        slew-rate = &lt;1&gt;;\n                };\n        };\n</code></pre>"},{"location":"11_SPI/15_1/#3","title":"3. \u200b\u7f16\u8bd1\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"11_SPI/15_1/#31-imx6ull","title":"3.1 IMX6ULL","text":""},{"location":"11_SPI/15_1/#311","title":"3.1.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\n export PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"11_SPI/15_1/#312","title":"3.1.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bIMX6ULL\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/100ask_imx6ull-14x14.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/100ask_imx6ull-14x14.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"11_SPI/15_1/#32-stm32mp157","title":"3.2 STM32MP157","text":""},{"location":"11_SPI/15_1/#321","title":"3.2.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"11_SPI/15_1/#322","title":"3.2.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bSTM32MP157\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u6811\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b\u54ea\u91cc\u200b</p> </li> </ul> <p>\u200b\u7531\u4e8e\u200b\u7248\u672c\u200b\u53d8\u5316\u200b\uff0cSTM32MP157\u200b\u5355\u677f\u200b\u4e0a\u200b\u70e7\u5f55\u200b\u7684\u200b\u7cfb\u7edf\u200b\u53ef\u80fd\u200b\u6709\u200b\u7ec6\u5fae\u5dee\u522b\u200b\u3002   \u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b<code>cat /proc/mounts</code>\u200b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u4e24\u79cd\u200b\u7ed3\u679c\u200b(\u200b\u89c1\u200b\u4e0b\u56fe\u200b)\uff1a</p> <ul> <li> <p>mmcblk2p2\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u5de6\u8fb9\u200b)\uff1a\u200b\u65e0\u9700\u200b\u7279\u6b8a\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u4e0b\u9762\u200b\u628a\u200b\u6587\u4ef6\u200b\u590d\u5236\u5230\u200b/boot\u200b\u76ee\u5f55\u200b\u5373\u53ef\u200b</p> </li> <li> <p>mmcblk2p2\u200b\u6302\u8f7d\u200b\u5728\u200b/mnt\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u53f3\u8fb9\u200b)</p> <ul> <li>\u200b\u5728\u200b\u89c6\u9891\u200b\u91cc\u200b\u3001\u200b\u540e\u9762\u200b\u6587\u6863\u200b\u91cc\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u66f4\u65b0\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u7684\u200b\u6587\u4ef6\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8981\u200b\u5148\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u91cd\u65b0\u200b\u6302\u8f7d\u200b\uff1a</li> <li><code>mount  /dev/mmcblk2p2  /boot</code></li> </ul> <p></p> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> </ul> <pre><code>[root@100ask:~]# cp /mnt/stm32mp157c-100ask-512d-lcd-v1.dtb /boot/\n[root@100ask:~]# sync\n</code></pre> <ul> <li>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</li> </ul>"},{"location":"11_SPI/15_1/#4-oled","title":"4. \u200b\u7f16\u8bd1\u200bOLED\u200b\u9a71\u52a8","text":""},{"location":"11_SPI/15_1/#5-app","title":"5. \u200b\u7f16\u8bd1\u200bAPP","text":"<pre><code>arm-buildroot-linux-gnueabihf-gcc  -o  spi_oled  spi_oled.c\n</code></pre>"},{"location":"11_SPI/15_1/#6","title":"6. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<p>\u200b\u5982\u679c\u200bspidev\u200b\u6ca1\u6709\u200b\u88ab\u200b\u7f16\u8bd1\u200b\u8fdb\u200b\u5185\u6838\u200b\uff0c\u200b\u90a3\u4e48\u200b\u5148\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>insmod oled_drv.ko\n</code></pre> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\uff1a</p> <pre><code>ls /dev/100ask_oled\n</code></pre> <p>\u200b\u5047\u8bbe\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u4e3a\u200b<code>/dev/100ask_oled</code>\uff0c\u200b\u6267\u884c\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b\uff1a</p> <pre><code>./spi_oled  /dev/100ask_oled\n</code></pre>"},{"location":"11_SPI/16_1/","title":"\u4f7f\u7528\u200bFramebuffer\u200b\u6539\u9020\u200bOLED\u200b\u9a71\u52a8","text":"<ul> <li>\u200b\u6e90\u7801\u200b:</li> </ul>"},{"location":"11_SPI/16_1/#1","title":"1. \u200b\u601d\u8def","text":"<p>\u200b\u5047\u8bbe\u200bOLED\u200b\u7684\u200b\u6bcf\u4e2a\u200b\u50cf\u7d20\u200b\u4f7f\u7528\u200b1\u200b\u4f4d\u200b\u6570\u636e\u8868\u793a\u200b:</p> <ul> <li>Linux Framebuffer\u200b\u4e2d\u200bbyte0\u200b\u5bf9\u5e94\u200bOLED\u200b\u4e0a\u200b\u7b2c\u200b1\u200b\u884c\u200b\u7684\u200b8\u200b\u4e2a\u200b\u50cf\u7d20\u200b</li> <li>OLED\u200b\u663e\u5b58\u200b\u4e2d\u200bbyte0\u200b\u5bf9\u5e94\u200bOLED\u200b\u4e0a\u200b\u7b2c\u200b1\u200b\u5217\u200b\u7684\u200b8\u200b\u4e2a\u200b\u50cf\u7d20\u200b</li> </ul> <p>\u200b\u4e3a\u4e86\u200b\u517c\u5bb9\u200b\u57fa\u4e8e\u200bFramebuffer\u200b\u7684\u200b\u7a0b\u5e8f\u200b\uff0c\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e2d\u200b\u5206\u914d\u200b\u4e00\u5757\u200bFramebuffer\uff0cAPP\u200b\u76f4\u63a5\u200b\u64cd\u4f5c\u200bFramebuffer\u3002</p> <p>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5468\u671f\u6027\u5730\u200b\u628a\u200bFramebuffer\u200b\u4e2d\u200b\u7684\u200b\u6570\u636e\u200b\u642c\u79fb\u5230\u200bOLED\u200b\u663e\u5b58\u200b\u4e0a\u200b\u3002</p> <p>\u200b\u600e\u4e48\u200b\u642c\u79fb\u200b\uff1f</p> <p>\u200b\u53d1\u7ed9\u200bOLED\u200b\u7ebf\u7a0b\u200b\u7684\u200bbyte0\u30011\u30012\u30013\u30014\u30015\u30016\u30017\u200b\u600e\u4e48\u200b\u6784\u9020\u200b\u51fa\u6765\u200b\uff1f</p> <ul> <li>\u200b\u5b83\u4eec\u200b\u6765\u81ea\u200bFramebuffer\u200b\u7684\u200bbyte0\u300116\u300132\u300148\u300164\u300180\u300196\u3001112</li> <li>OLED\u200b\u7684\u200bbyte0\uff0c\u200b\u7531\u200bFramebuffer\u200b\u7684\u200b\u8fd9\u200b8\u200b\u4e2a\u200b\u5b57\u8282\u200b\u7684\u200bbit0\u200b\u7ec4\u5408\u200b\u5f97\u5230\u200b</li> <li>OLED\u200b\u7684\u200bbyte1\uff0c\u200b\u7531\u200bFramebuffer\u200b\u7684\u200b\u8fd9\u200b8\u200b\u4e2a\u200b\u5b57\u8282\u200b\u7684\u200bbit1\u200b\u7ec4\u5408\u200b\u5f97\u5230\u200b</li> <li>OLED\u200b\u7684\u200bbyte2\uff0c\u200b\u7531\u200bFramebuffer\u200b\u7684\u200b\u8fd9\u200b8\u200b\u4e2a\u200b\u5b57\u8282\u200b\u7684\u200bbit2\u200b\u7ec4\u5408\u200b\u5f97\u5230\u200b</li> <li>OLED\u200b\u7684\u200bbyte3\uff0c\u200b\u7531\u200bFramebuffer\u200b\u7684\u200b\u8fd9\u200b8\u200b\u4e2a\u200b\u5b57\u8282\u200b\u7684\u200bbit3\u200b\u7ec4\u5408\u200b\u5f97\u5230\u200b</li> <li>\u2026\u2026</li> </ul>"},{"location":"11_SPI/16_1/#2","title":"2. \u200b\u7f16\u7a0b","text":""},{"location":"11_SPI/16_1/#21-framebuffer","title":"2.1 Framebuffer\u200b\u7f16\u7a0b","text":"<p>\u200b\u5206\u914d\u200b\u3001\u200b\u8bbe\u7f6e\u200b\u3001\u200b\u6ce8\u518c\u200bfb_info\u200b\u7ed3\u6784\u200b\u4f53\u200b\u3002</p> <ul> <li>\u200b\u5206\u914d\u200bfb_info</li> <li>\u200b\u8bbe\u7f6e\u200bfb_info</li> <li>fb_var</li> <li>fb_fix</li> <li>\u200b\u6ce8\u518c\u200bfb_info</li> <li>\u200b\u786c\u4ef6\u200b\u64cd\u4f5c\u200b</li> </ul>"},{"location":"11_SPI/16_1/#22","title":"2.2 \u200b\u6570\u636e\u200b\u642c\u79fb","text":"<p>\u200b\u521b\u5efa\u200b\u5185\u6838\u200b\u7ebf\u7a0b\u200b\uff0c\u200b\u5468\u671f\u6027\u5730\u200b\u628a\u200bFramebuffer\u200b\u4e2d\u200b\u7684\u200b\u6570\u636e\u200b\u901a\u8fc7\u200bSPI\u200b\u53d1\u9001\u7ed9\u200bOLED\u3002</p> <p>\u200b\u521b\u5efa\u200b\u5185\u6838\u200b\u7ebf\u7a0b\u200b:</p> <ul> <li> <p>\u200b\u53c2\u8003\u200b\u6587\u4ef6\u200b<code>include\\linux\\kthread.h</code></p> </li> <li> <p>\u200b\u53c2\u8003\u200b\u6587\u7ae0\u200b\uff1ahttps://blog.csdn.net/qq_37858386/article/details/115573565</p> </li> <li> <p>kthread_create\uff1a\u200b\u521b\u5efa\u200b\u5185\u6838\u200b\u7ebf\u7a0b\u200b\uff0c\u200b\u7ebf\u7a0b\u200b\u5904\u4e8e\u200b\"\u200b\u505c\u6b62\u200b\u72b6\u6001\u200b\"\uff0c\u200b\u8981\u200b\u8fd0\u884c\u200b\u5b83\u200b\u9700\u8981\u200b\u6267\u884c\u200b<code>wake_up_process</code></p> </li> <li> <p>kthread_run\uff1a\u200b\u521b\u5efa\u200b\u5185\u6838\u200b\u7ebf\u7a0b\u200b\uff0c\u200b\u5e76\u200b\u9a6c\u4e0a\u200b\u8ba9\u200b\u5b83\u200b\u5904\u4e8e\u200b\"\u200b\u8fd0\u884c\u200b\u72b6\u6001\u200b\"</p> </li> <li> <p>kernel_thread</p> </li> </ul>"},{"location":"11_SPI/16_1/#23","title":"2.3 \u200b\u8c03\u8bd5","text":"<p>\u200b\u914d\u7f6e\u200b\u5185\u6838\u200b\uff0c\u200b\u628a\u200b\u4e0b\u5217\u200b\u914d\u7f6e\u200b\u9879\u200b\u53bb\u6389\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/17_1/","title":"OLED_Framebuffer\u200b\u9a71\u52a8\u200b_\u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<ul> <li>\u200b\u6e90\u7801\u200b:</li> </ul> <ul> <li>DMA\u200b\u53c2\u8003\u200b\u6587\u7ae0\u200b\uff1ahttps://www.kernel.org/doc/html/latest/core-api/dma-api-howto.html</li> </ul>"},{"location":"11_SPI/17_1/#1","title":"1. \u200b\u786c\u4ef6","text":""},{"location":"11_SPI/17_1/#11","title":"1.1 \u200b\u539f\u7406\u56fe","text":"<p>IMX6ULL:</p> <p></p> <p>STM32MP157:</p> <p></p> <p>\u200b\u539f\u7406\u56fe\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/17_1/#12","title":"1.2 \u200b\u8fde\u63a5","text":"<p>\u200b\u65e0\u8bba\u662f\u200b\u4f7f\u7528\u200bIMX6ULL\u200b\u5f00\u53d1\u677f\u200b\u8fd8\u662f\u200bSTM32MP157\u200b\u5f00\u53d1\u677f\u200b\uff0c\u200b\u90fd\u200b\u6709\u200b\u7c7b\u4f3c\u200b\u7684\u200b\u6269\u5c55\u200b\u677f\u200b\u3002\u200b\u628a\u200bOLED\u200b\u6a21\u5757\u200b\u63a5\u5230\u200b\u6269\u5c55\u200b\u677f\u200b\u7684\u200bSPI_A\u200b\u63d2\u5ea7\u200b\u4e0a\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/17_1/#2","title":"2. \u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"11_SPI/17_1/#211-imx6ull","title":"2.1.1 IMX6ULL","text":"<p>DC\u200b\u5f15\u811a\u200b\u4f7f\u7528\u200bGPIO4_20\uff0c\u200b\u4e5f\u200b\u9700\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u5b9a\u200b\u3002</p> <p>\u200b\u8bbe\u5907\u200b\u6811\u200b\u5982\u4e0b\u200b\uff1aarch/arm/boot/dts/100ask_imx6ull-14x14.dts</p> <pre><code>&amp;ecspi1 {\n    pinctrl-names = \"default\";\n    pinctrl-0 = &lt;&amp;pinctrl_ecspi1&gt;;\n\n    fsl,spi-num-chipselects = &lt;2&gt;;\n    cs-gpios = &lt;&amp;gpio4 26 GPIO_ACTIVE_LOW&gt;, &lt;&amp;gpio4 24 GPIO_ACTIVE_LOW&gt;;\n    status = \"okay\";\n\n    oled: oled {\n        compatible = \"100ask,oled\";\n        reg = &lt;0&gt;;\n        spi-max-frequency = &lt;10000000&gt;;\n        dc-gpios = &lt;&amp;gpio4 20 GPIO_ACTIVE_HIGH&gt;; \n    };\n};\n</code></pre>"},{"location":"11_SPI/17_1/#212-stm32mp157","title":"2.1.2 STM32MP157","text":"<p>DC\u200b\u5f15\u811a\u200b\u4f7f\u7528\u200bGPIOA_13\uff0c\u200b\u4e5f\u200b\u9700\u8981\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u91cc\u200b\u6307\u5b9a\u200b\u3002</p> <p>\u200b\u8bbe\u5907\u200b\u6811\u200b\u5982\u4e0b\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dts</code></p> <pre><code>&amp;spi5 {\n        pinctrl-names = \"default\", \"sleep\";\n        pinctrl-0 = &lt;&amp;spi5_pins_a&gt;;\n        pinctrl-1 = &lt;&amp;spi5_sleep_pins_a&gt;;\n        status = \"okay\";\n        cs-gpios = &lt;&amp;gpioh 5 GPIO_ACTIVE_LOW&gt;, &lt;&amp;gpioz 4 GPIO_ACTIVE_LOW&gt;;\n        spidev: icm20608@0{\n                compatible = \"invensense,icm20608\";\n                interrupts = &lt;0 IRQ_TYPE_EDGE_FALLING&gt;;\n                interrupt-parent = &lt;&amp;gpioz&gt;;\n                spi-max-frequency = &lt;8000000&gt;;\n                reg = &lt;0&gt;;\n        };\n        oled: oled@1{\n                compatible = \"100ask,oled\";\n                spi-max-frequency = &lt;10000000&gt;;\n                reg = &lt;1&gt;;\n                dc-gpios = &lt;&amp;gpioa 13 GPIO_ACTIVE_HIGH&gt;;\n        };\n};\n</code></pre>"},{"location":"11_SPI/17_1/#3","title":"3. \u200b\u7f16\u8bd1\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"11_SPI/17_1/#31-imx6ull","title":"3.1 IMX6ULL","text":""},{"location":"11_SPI/17_1/#311","title":"3.1.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\n export PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"11_SPI/17_1/#312","title":"3.1.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bIMX6ULL\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/100ask_imx6ull-14x14.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> <pre><code>[root@100ask:~]# cp /mnt/100ask_imx6ull-14x14.dtb /boot\n[root@100ask:~]# sync\n</code></pre> </li> <li> <p>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</p> </li> </ul>"},{"location":"11_SPI/17_1/#32-stm32mp157","title":"3.2 STM32MP157","text":""},{"location":"11_SPI/17_1/#321","title":"3.2.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"11_SPI/17_1/#322","title":"3.2.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bSTM32MP157\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u6811\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b\u54ea\u91cc\u200b</p> </li> </ul> <p>\u200b\u7531\u4e8e\u200b\u7248\u672c\u200b\u53d8\u5316\u200b\uff0cSTM32MP157\u200b\u5355\u677f\u200b\u4e0a\u200b\u70e7\u5f55\u200b\u7684\u200b\u7cfb\u7edf\u200b\u53ef\u80fd\u200b\u6709\u200b\u7ec6\u5fae\u5dee\u522b\u200b\u3002   \u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b<code>cat /proc/mounts</code>\u200b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u4e24\u79cd\u200b\u7ed3\u679c\u200b(\u200b\u89c1\u200b\u4e0b\u56fe\u200b)\uff1a</p> <ul> <li> <p>mmcblk2p2\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u5de6\u8fb9\u200b)\uff1a\u200b\u65e0\u9700\u200b\u7279\u6b8a\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u4e0b\u9762\u200b\u628a\u200b\u6587\u4ef6\u200b\u590d\u5236\u5230\u200b/boot\u200b\u76ee\u5f55\u200b\u5373\u53ef\u200b</p> </li> <li> <p>mmcblk2p2\u200b\u6302\u8f7d\u200b\u5728\u200b/mnt\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u53f3\u8fb9\u200b)</p> <ul> <li>\u200b\u5728\u200b\u89c6\u9891\u200b\u91cc\u200b\u3001\u200b\u540e\u9762\u200b\u6587\u6863\u200b\u91cc\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u66f4\u65b0\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u7684\u200b\u6587\u4ef6\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8981\u200b\u5148\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u91cd\u65b0\u200b\u6302\u8f7d\u200b\uff1a</li> <li><code>mount  /dev/mmcblk2p2  /boot</code></li> </ul> <p></p> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> </ul> <pre><code>[root@100ask:~]# cp /mnt/stm32mp157c-100ask-512d-lcd-v1.dtb /boot/\n[root@100ask:~]# sync\n</code></pre> <ul> <li>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</li> </ul>"},{"location":"11_SPI/17_1/#4-oled","title":"4. \u200b\u7f16\u8bd1\u200bOLED\u200b\u9a71\u52a8","text":"<pre><code>cd 10_oled_framebuffer_ok\nmake\n</code></pre>"},{"location":"11_SPI/17_1/#5-app","title":"5. \u200b\u7f16\u8bd1\u200bAPP","text":"<pre><code>cd  10_oled_framebuffer_ok/03_freetype_show_font_angle\nmake\n</code></pre>"},{"location":"11_SPI/17_1/#6","title":"6. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<pre><code>1. \u200b\u5b89\u88c5\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b, \u200b\u786e\u5b9a\u200b\u65b0\u200b\u51fa\u73b0\u200b\u54ea\u4e2a\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\nls /dev/fb*\ninsmod oled_drv.ko\nls /dev/fb*\n\n2. \u200b\u5728\u200bIMX6ULL\u200b\u4e0a\u200b\u8fd0\u884c\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b\n./freetype_show_font_angle  /dev/fb2 ./simsun.ttc 0 20\n\n2. \u200b\u5728\u200bSTM32MP157\u200b\u4e0a\u200b\u8fd0\u884c\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b\n./freetype_show_font_angle  /dev/fb1 ./simsun.ttc 0 20\n</code></pre>"},{"location":"11_SPI/18_1/","title":"SPI_Master\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":"<ul> <li>\u200b\u53c2\u8003\u200b\u5185\u6838\u200b\u6e90\u7801\u200b: <code>drivers\\spi\\spi.c</code></li> </ul>"},{"location":"11_SPI/18_1/#1-spi","title":"1. SPI\u200b\u4f20\u8f93\u200b\u6982\u8ff0","text":""},{"location":"11_SPI/18_1/#11","title":"1.1 \u200b\u6570\u636e\u7ec4\u7ec7\u200b\u65b9\u5f0f","text":"<p>\u200b\u4f7f\u7528\u200bSPI\u200b\u4f20\u8f93\u200b\u65f6\u200b\uff0c\u200b\u6700\u5c0f\u200b\u7684\u200b\u4f20\u8f93\u200b\u5355\u4f4d\u200b\u662f\u200b\"spi_transfer\"\uff0c</p> <p>\u200b\u5bf9\u4e8e\u200b\u4e00\u4e2a\u200b\u8bbe\u5907\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u53d1\u8d77\u200b\u591a\u4e2a\u200bspi_transfer\uff0c</p> <p>\u200b\u8fd9\u4e9b\u200bspi_transfer\uff0c\u200b\u4f1a\u200b\u653e\u5165\u200b\u4e00\u4e2a\u200bspi_message\u200b\u91cc\u200b\u3002</p> <ul> <li> <p>spi_transfer\uff1a\u200b\u6307\u5b9a\u200btx_buf\u3001rx_buf\u3001len   </p> </li> <li> <p>\u200b\u540c\u4e00\u4e2a\u200bSPI\u200b\u8bbe\u5907\u200b\u7684\u200bspi_transfer\uff0c\u200b\u4f7f\u7528\u200bspi_message\u200b\u6765\u200b\u7ba1\u7406\u200b\uff1a   </p> </li> <li> <p>\u200b\u540c\u4e00\u4e2a\u200bSPI Master\u200b\u4e0b\u200b\u7684\u200bspi_message\uff0c\u200b\u653e\u5728\u200b\u4e00\u4e2a\u200b\u961f\u5217\u200b\u91cc\u200b\uff1a   </p> </li> </ul> <p>\u200b\u6240\u4ee5\u200b\uff0c\u200b\u53cd\u8fc7\u6765\u200b\uff0cSPI\u200b\u4f20\u8f93\u200b\u7684\u200b\u6d41\u7a0b\u200b\u662f\u200b\u8fd9\u6837\u200b\u7684\u200b\uff1a</p> <ul> <li>\u200b\u4ece\u200bspi_master\u200b\u7684\u200b\u961f\u5217\u200b\u91cc\u200b\u53d6\u51fa\u200b\u6bcf\u200b\u4e00\u4e2a\u200bspi_message</li> <li>\u200b\u4ece\u200bspi_message\u200b\u7684\u200b\u961f\u5217\u200b\u91cc\u200b\u53d6\u51fa\u200b\u4e00\u4e2a\u200bspi_transfer<ul> <li>\u200b\u5904\u7406\u200bspi_transfer</li> </ul> </li> </ul>"},{"location":"11_SPI/18_1/#12-spi","title":"1.2 SPI\u200b\u63a7\u5236\u5668\u200b\u6570\u636e\u7ed3\u6784","text":"<p>\u200b\u53c2\u8003\u200b\u5185\u6838\u200b\u6587\u4ef6\u200b\uff1a<code>include\\linux\\spi\\spi.h</code></p> <p>Linux\u200b\u4e2d\u200b\u4f7f\u7528\u200bspi_master\u200b\u7ed3\u6784\u200b\u4f53\u200b\u63cf\u8ff0\u200bSPI\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u6709\u200b\u4e24\u5957\u200b\u4f20\u8f93\u200b\u65b9\u6cd5\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/18_1/#2-spi","title":"2. SPI\u200b\u4f20\u8f93\u200b\u51fd\u6570\u200b\u7684\u200b\u4e24\u79cd\u200b\u65b9\u6cd5","text":""},{"location":"11_SPI/18_1/#21","title":"2.1 \u200b\u8001\u200b\u65b9\u6cd5","text":""},{"location":"11_SPI/18_1/#22","title":"2.2 \u200b\u65b0\u200b\u65b9\u6cd5","text":""},{"location":"11_SPI/19_1/","title":"\u7f16\u5199\u200bSPI_Master\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>\u200b\u672c\u200b\u8282\u200b\u6e90\u7801\u200b\uff1a </p> <p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u200b\u5185\u6838\u200b\u5934\u6587\u4ef6\u200b\uff1a<code>include\\linux\\spi\\spi.h</code></li> <li>\u200b\u5185\u6838\u200b\u6587\u6863\u200b\uff1a<code>Documentation\\devicetree\\bindings\\spi\\spi-bus.txt</code> </li> <li>\u200b\u5185\u6838\u200b\u6e90\u7801\u200b\uff1a<code>drivers\\spi\\spi.c</code>\u3001<code>drivers\\spi\\spi-sh.c</code></li> </ul>"},{"location":"11_SPI/19_1/#1-spi","title":"1. SPI\u200b\u9a71\u52a8\u200b\u6846\u67b6","text":""},{"location":"11_SPI/19_1/#11","title":"1.1 \u200b\u603b\u4f53\u200b\u6846\u67b6","text":""},{"location":"11_SPI/19_1/#12-spi_master","title":"1.2 \u200b\u600e\u4e48\u200b\u7f16\u5199\u200bSPI_Master\u200b\u9a71\u52a8","text":""},{"location":"11_SPI/19_1/#121","title":"1.2.1 \u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811","text":"<p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\uff0c\u200b\u5bf9\u4e8e\u200bSPI Master\uff0c\u200b\u5fc5\u987b\u200b\u7684\u200b\u5c5e\u6027\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>compatible\uff1a\u200b\u6839\u636e\u200b\u5b83\u200b\u627e\u5230\u200bSPI Master\u200b\u9a71\u52a8\u200b</li> </ul> <p>\u200b\u53ef\u9009\u200b\u7684\u200b\u5c5e\u6027\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>cs-gpios\uff1aSPI Master\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u591a\u4e2a\u200bGPIO\u200b\u5f53\u505a\u200b\u7247\u9009\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u5c5e\u6027\u200b\u5217\u51fa\u200b\u90a3\u4e9b\u200bGPIO</li> <li>num-cs\uff1a\u200b\u7247\u9009\u200b\u5f15\u811a\u200b\u603b\u6570\u200b</li> </ul> <p>\u200b\u5176\u4ed6\u200b\u5c5e\u6027\u200b\u90fd\u200b\u662f\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u76f8\u5173\u200b\u7684\u200b\uff0c\u200b\u4e0d\u540c\u200b\u7684\u200bSPI Master\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u8981\u6c42\u200b\u7684\u200b\u5c5e\u6027\u200b\u53ef\u80fd\u200b\u4e0d\u200b\u4e00\u6837\u200b\u3002</p> <p>\u200b\u5728\u200bSPI Master\u200b\u5bf9\u5e94\u200b\u7684\u200b\u8bbe\u5907\u200b\u6811\u200b\u8282\u70b9\u200b\u4e0b\u200b\uff0c\u200b\u6bcf\u200b\u4e00\u4e2a\u200b\u5b50\u200b\u8282\u70b9\u200b\u90fd\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200bSPI\u200b\u8bbe\u5907\u200b\uff0c\u200b\u8fd9\u4e2a\u200bSPI\u200b\u8bbe\u5907\u200b\u8fde\u63a5\u200b\u5728\u200b\u8be5\u200bSPI Master\u200b\u4e0b\u9762\u200b\u3002</p> <p>\u200b\u8fd9\u4e9b\u200b\u5b50\u200b\u8282\u70b9\u200b\u4e2d\u200b\uff0c\u200b\u5fc5\u9009\u200b\u7684\u200b\u5c5e\u6027\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>compatible\uff1a\u200b\u6839\u636e\u200b\u5b83\u200b\u627e\u5230\u200bSPI Device\u200b\u9a71\u52a8\u200b</li> <li>reg\uff1a\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u5b83\u200b\u4f7f\u7528\u200b\u54ea\u4e2a\u200b\u7247\u9009\u200b\u5f15\u811a\u200b</li> <li>spi-max-frequency\uff1a\u200b\u5fc5\u9009\u200b\uff0c\u200b\u8be5\u200bSPI\u200b\u8bbe\u5907\u200b\u652f\u6301\u200b\u7684\u200b\u6700\u5927\u200bSPI\u200b\u65f6\u949f\u200b</li> </ul> <p>\u200b\u53ef\u9009\u200b\u7684\u200b\u5c5e\u6027\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>spi-cpol\uff1a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u7a7a\u200b\u5c5e\u6027\u200b(\u200b\u6ca1\u6709\u200b\u503c\u200b)\uff0c\u200b\u8868\u793a\u200bCPOL\u200b\u4e3a\u200b1\uff0c\u200b\u5373\u200b\u5e73\u65f6\u200bSPI\u200b\u65f6\u949f\u200b\u4e3a\u200b\u4f4e\u7535\u5e73\u200b</li> <li>spi-cpha\uff1a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u7a7a\u200b\u5c5e\u6027\u200b(\u200b\u6ca1\u6709\u200b\u503c\u200b)\uff0c\u200b\u8868\u793a\u200bCPHA\u200b\u4e3a\u200b1)\uff0c\u200b\u5373\u200b\u5728\u200b\u65f6\u949f\u200b\u7684\u200b\u7b2c\u200b2\u200b\u4e2a\u200b\u8fb9\u6cbf\u200b\u91c7\u6837\u200b\u6570\u636e\u200b</li> <li>spi-cs-high\uff1a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u7a7a\u200b\u5c5e\u6027\u200b(\u200b\u6ca1\u6709\u200b\u503c\u200b)\uff0c\u200b\u8868\u793a\u200b\u7247\u9009\u200b\u5f15\u811a\u200b\u9ad8\u7535\u5e73\u200b\u6709\u6548\u200b</li> <li>spi-3wire\uff1a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u7a7a\u200b\u5c5e\u6027\u200b(\u200b\u6ca1\u6709\u200b\u503c\u200b)\uff0c\u200b\u8868\u793a\u200b\u4f7f\u7528\u200bSPI \u200b\u4e09\u7ebf\u200b\u6a21\u5f0f\u200b</li> <li>spi-lsb-first\uff1a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u7a7a\u200b\u5c5e\u6027\u200b(\u200b\u6ca1\u6709\u200b\u503c\u200b)\uff0c\u200b\u8868\u793a\u200b\u4f7f\u7528\u200bSPI\u200b\u4f20\u8f93\u6570\u636e\u200b\u65f6\u5148\u200b\u4f20\u8f93\u200b\u6700\u4f4e\u200b\u4f4d\u200b(LSB)</li> <li>spi-tx-bus-width\uff1a\u200b\u8868\u793a\u200b\u6709\u200b\u51e0\u6761\u200bMOSI\u200b\u5f15\u811a\u200b\uff1b\u200b\u6ca1\u6709\u200b\u8fd9\u4e2a\u200b\u5c5e\u6027\u200b\u65f6\u200b\u9ed8\u8ba4\u200b\u53ea\u6709\u200b1\u200b\u6761\u200bMOSI\u200b\u5f15\u811a\u200b</li> <li>spi-rx-bus-width\uff1a\u200b\u8868\u793a\u200b\u6709\u200b\u51e0\u6761\u200bMISO\u200b\u5f15\u811a\u200b\uff1b\u200b\u6ca1\u6709\u200b\u8fd9\u4e2a\u200b\u5c5e\u6027\u200b\u65f6\u200b\u9ed8\u8ba4\u200b\u53ea\u6709\u200b1\u200b\u6761\u200bMISO\u200b\u5f15\u811a\u200b</li> <li>spi-rx-delay-us\uff1a\u200b\u5355\u4f4d\u200b\u662f\u200b\u6beb\u79d2\u200b\uff0c\u200b\u8868\u793a\u200b\u6bcf\u6b21\u200b\u8bfb\u200b\u4f20\u8f93\u200b\u540e\u8981\u200b\u5ef6\u65f6\u200b\u591a\u4e45\u200b</li> <li>spi-tx-delay-us\uff1a\u200b\u5355\u4f4d\u200b\u662f\u200b\u6beb\u79d2\u200b\uff0c\u200b\u8868\u793a\u200b\u6bcf\u6b21\u200b\u5199\u200b\u4f20\u8f93\u200b\u540e\u8981\u200b\u5ef6\u65f6\u200b\u591a\u4e45\u200b</li> </ul>"},{"location":"11_SPI/19_1/#address-cellsspi-masterspicell","title":"address-cells\uff1a\u200b\u8fd9\u4e2a\u200bSPI Master\u200b\u4e0b\u200b\u7684\u200bSPI\u200b\u8bbe\u5907\u200b\uff0c\u200b\u9700\u8981\u200b\u591a\u5c11\u200b\u4e2a\u200bcell\u200b\u6765\u200b\u8868\u8ff0\u200b\u5b83\u200b\u7684\u200b\u7247\u9009\u200b\u5f15\u811a","text":""},{"location":"11_SPI/19_1/#size-cells0","title":"size-cells\uff1a\u200b\u5fc5\u987b\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b0","text":""},{"location":"11_SPI/19_1/#122","title":"1.2.2 \u200b\u7f16\u5199\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<ul> <li>\u200b\u6838\u5fc3\u200b\u4e3a\u200b\uff1a\u200b\u5206\u914d\u200b/\u200b\u8bbe\u7f6e\u200b/\u200b\u6ce8\u518c\u200bspi_master\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> <li>\u200b\u5bf9\u4e8e\u200b\u8001\u200b\u65b9\u6cd5\u200b\uff0cspi_master\u200b\u7ed3\u6784\u200b\u4f53\u200b\u7684\u200b\u6838\u5fc3\u200b\u662f\u200btransfer\u200b\u51fd\u6570\u200b</li> </ul>"},{"location":"11_SPI/19_1/#2","title":"2. \u200b\u7f16\u5199\u7a0b\u5e8f","text":""},{"location":"11_SPI/19_1/#21","title":"2.1 \u200b\u6570\u636e\u4f20\u8f93\u200b\u6d41\u7a0b","text":""},{"location":"11_SPI/19_1/#22","title":"2.2 \u200b\u5199\u200b\u4ee3\u7801","text":""},{"location":"11_SPI/20_1/","title":"\u4f7f\u7528\u200b\u8001\u200b\u65b9\u6cd5\u200b\u7f16\u5199\u200b\u7684\u200bSPI_Master\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<p>\u200b\u672c\u200b\u8282\u200b\u6e90\u7801\u200b\uff1a </p> <p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u200b\u5185\u6838\u200b\u5934\u6587\u4ef6\u200b\uff1a<code>include\\linux\\spi\\spi.h</code></li> <li>\u200b\u5185\u6838\u200b\u6587\u6863\u200b\uff1a<code>Documentation\\devicetree\\bindings\\spi\\spi-bus.txt</code> </li> <li>\u200b\u5185\u6838\u200b\u6e90\u7801\u200b\uff1a<code>drivers\\spi\\spi.c</code>\u3001<code>drivers\\spi\\spi-sh.c</code></li> </ul>"},{"location":"11_SPI/20_1/#1","title":"1. \u200b\u4fee\u6539\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"11_SPI/20_1/#11-imx6ull","title":"1.1 IMX6ULL","text":"<p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code>\u200b\u4e2d\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>        virtual_spi_master {\n                compatible = \"100ask,virtual_spi_master\";\n                status = \"okay\";\n                cs-gpios = &lt;&amp;gpio4 27 GPIO_ACTIVE_LOW&gt;;\n                num-chipselects = &lt;1&gt;;\n                #address-cells = &lt;1&gt;;\n                #size-cells = &lt;0&gt;;\n\n                virtual_spi_dev: virtual_spi_dev@0 {\n                        compatible = \"spidev\";\n                        reg = &lt;0&gt;;\n                        spi-max-frequency = &lt;100000&gt;;\n                };\n        };\n</code></pre>"},{"location":"11_SPI/20_1/#22-stm32mp157","title":"2.2 STM32MP157","text":"<p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dts</code>\u200b\u4e2d\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>        virtual_spi_master {\n                compatible = \"100ask,virtual_spi_master\";\n                status = \"okay\";\n                cs-gpios = &lt;&amp;gpioh 6 GPIO_ACTIVE_LOW&gt;;\n                num-chipselects = &lt;1&gt;;\n                #address-cells = &lt;1&gt;;\n                #size-cells = &lt;0&gt;;\n\n                virtual_spi_dev: virtual_spi_dev@0 {\n                        compatible = \"spidev\";\n                        reg = &lt;0&gt;;\n                        spi-max-frequency = &lt;100000&gt;;\n                };\n        };\n</code></pre>"},{"location":"11_SPI/20_1/#2","title":"2. \u200b\u7f16\u8bd1\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"11_SPI/20_1/#21-imx6ull","title":"2.1 IMX6ULL","text":""},{"location":"11_SPI/20_1/#211","title":"2.1.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\n export PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"11_SPI/20_1/#212","title":"2.1.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bIMX6ULL\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/100ask_imx6ull-14x14.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> </ul> <pre><code>[root@100ask:~]# cp /mnt/100ask_imx6ull-14x14.dtb /boot\n[root@100ask:~]# sync\n</code></pre> <ul> <li>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</li> </ul>"},{"location":"11_SPI/20_1/#22-stm32mp157_1","title":"2.2 STM32MP157","text":""},{"location":"11_SPI/20_1/#221","title":"2.2.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"11_SPI/20_1/#222","title":"2.2.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bSTM32MP157\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u6811\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b\u54ea\u91cc\u200b</p> </li> </ul> <p>\u200b\u7531\u4e8e\u200b\u7248\u672c\u200b\u53d8\u5316\u200b\uff0cSTM32MP157\u200b\u5355\u677f\u200b\u4e0a\u200b\u70e7\u5f55\u200b\u7684\u200b\u7cfb\u7edf\u200b\u53ef\u80fd\u200b\u6709\u200b\u7ec6\u5fae\u5dee\u522b\u200b\u3002   \u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b<code>cat /proc/mounts</code>\u200b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u4e24\u79cd\u200b\u7ed3\u679c\u200b(\u200b\u89c1\u200b\u4e0b\u56fe\u200b)\uff1a</p> <ul> <li> <p>mmcblk2p2\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u5de6\u8fb9\u200b)\uff1a\u200b\u65e0\u9700\u200b\u7279\u6b8a\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u4e0b\u9762\u200b\u628a\u200b\u6587\u4ef6\u200b\u590d\u5236\u5230\u200b/boot\u200b\u76ee\u5f55\u200b\u5373\u53ef\u200b</p> </li> <li> <p>mmcblk2p2\u200b\u6302\u8f7d\u200b\u5728\u200b/mnt\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u53f3\u8fb9\u200b)</p> <ul> <li>\u200b\u5728\u200b\u89c6\u9891\u200b\u91cc\u200b\u3001\u200b\u540e\u9762\u200b\u6587\u6863\u200b\u91cc\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u66f4\u65b0\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u7684\u200b\u6587\u4ef6\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8981\u200b\u5148\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u91cd\u65b0\u200b\u6302\u8f7d\u200b\uff1a</li> <li><code>mount  /dev/mmcblk2p2  /boot</code></li> </ul> <p></p> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> </ul> <pre><code>[root@100ask:~]# cp /mnt/stm32mp157c-100ask-512d-lcd-v1.dtb /boot/\n[root@100ask:~]# sync\n</code></pre> <ul> <li>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</li> </ul>"},{"location":"11_SPI/20_1/#3-app","title":"3. \u200b\u7f16\u8bd1\u200b\u9a71\u52a8\u200b\u548c\u200bAPP","text":""},{"location":"11_SPI/20_1/#4","title":"4. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<p>\u200b\u5148\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>insmod virtual_spi_master.ko\n</code></pre> <p>\u200b\u5bf9\u4e8e\u200bIMX6ULL\uff0c\u200b\u56e0\u4e3a\u200bspidev\u200b\u6ca1\u6709\u200b\u88ab\u200b\u7f16\u8bd1\u200b\u8fdb\u200b\u5185\u6838\u200b\uff0c\u200b\u90a3\u4e48\u200b\u518d\u200b\u6267\u884c\u200b(\u200b\u5bf9\u4e8e\u200bSTM32MP157\uff0c\u200b\u65e0\u9700\u200b\u6267\u884c\u200b\u8fd9\u4e2a\u200b\u547d\u4ee4\u200b)\uff1a</p> <pre><code>insmod spidev.ko\n</code></pre> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\uff1a</p> <pre><code>ls /dev/spidev*\n</code></pre> <p>\u200b\u5047\u8bbe\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u4e3a\u200b<code>/dev/spidev32765.0</code>\uff0c\u200b\u6267\u884c\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b(\u200b\u5b83\u200b\u5e76\u200b\u4e0d\u4f1a\u200b\u771f\u6b63\u200b\u5730\u200b\u8bfb\u5199\u200b\u6570\u636e\u200b)\uff1a</p> <pre><code>./spi_test  /dev/spidev32765.0  500\n./spi_test  /dev/spidev32765.0  600\n./spi_test  /dev/spidev32765.0  1000\n</code></pre>"},{"location":"11_SPI/21_1/","title":"\u7f16\u5199\u200bSPI_Master\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b_\u200b\u65b0\u200b\u65b9\u6cd5","text":"<p>\u200b\u672c\u200b\u8282\u200b\u6e90\u7801\u200b\uff1a </p> <p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u200b\u5185\u6838\u200b\u5934\u6587\u4ef6\u200b\uff1a<code>include\\linux\\spi\\spi.h</code></li> <li>\u200b\u5185\u6838\u200b\u6587\u6863\u200b\uff1a<code>Documentation\\devicetree\\bindings\\spi\\spi-bus.txt</code> </li> <li>\u200b\u5185\u6838\u200b\u6e90\u7801\u200b\uff1a<code>drivers\\spi\\spi.c</code>\u3001<code>drivers\\spi\\spi-sh.c</code></li> </ul>"},{"location":"11_SPI/21_1/#1-spi","title":"1. SPI\u200b\u9a71\u52a8\u200b\u6846\u67b6","text":""},{"location":"11_SPI/21_1/#11","title":"1.1 \u200b\u603b\u4f53\u200b\u6846\u67b6","text":""},{"location":"11_SPI/21_1/#12-spi_master","title":"1.2 \u200b\u600e\u4e48\u200b\u7f16\u5199\u200bSPI_Master\u200b\u9a71\u52a8","text":""},{"location":"11_SPI/21_1/#121","title":"1.2.1 \u200b\u7f16\u5199\u200b\u8bbe\u5907\u200b\u6811","text":"<p>\u200b\u5728\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\uff0c\u200b\u5bf9\u4e8e\u200bSPI Master\uff0c\u200b\u5fc5\u987b\u200b\u7684\u200b\u5c5e\u6027\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>compatible\uff1a\u200b\u6839\u636e\u200b\u5b83\u200b\u627e\u5230\u200bSPI Master\u200b\u9a71\u52a8\u200b</li> </ul> <p>\u200b\u53ef\u9009\u200b\u7684\u200b\u5c5e\u6027\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>cs-gpios\uff1aSPI Master\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u591a\u4e2a\u200bGPIO\u200b\u5f53\u505a\u200b\u7247\u9009\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u5c5e\u6027\u200b\u5217\u51fa\u200b\u90a3\u4e9b\u200bGPIO</li> <li>num-cs\uff1a\u200b\u7247\u9009\u200b\u5f15\u811a\u200b\u603b\u6570\u200b</li> </ul> <p>\u200b\u5176\u4ed6\u200b\u5c5e\u6027\u200b\u90fd\u200b\u662f\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u76f8\u5173\u200b\u7684\u200b\uff0c\u200b\u4e0d\u540c\u200b\u7684\u200bSPI Master\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u8981\u6c42\u200b\u7684\u200b\u5c5e\u6027\u200b\u53ef\u80fd\u200b\u4e0d\u200b\u4e00\u6837\u200b\u3002</p> <p>\u200b\u5728\u200bSPI Master\u200b\u5bf9\u5e94\u200b\u7684\u200b\u8bbe\u5907\u200b\u6811\u200b\u8282\u70b9\u200b\u4e0b\u200b\uff0c\u200b\u6bcf\u200b\u4e00\u4e2a\u200b\u5b50\u200b\u8282\u70b9\u200b\u90fd\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200bSPI\u200b\u8bbe\u5907\u200b\uff0c\u200b\u8fd9\u4e2a\u200bSPI\u200b\u8bbe\u5907\u200b\u8fde\u63a5\u200b\u5728\u200b\u8be5\u200bSPI Master\u200b\u4e0b\u9762\u200b\u3002</p> <p>\u200b\u8fd9\u4e9b\u200b\u5b50\u200b\u8282\u70b9\u200b\u4e2d\u200b\uff0c\u200b\u5fc5\u9009\u200b\u7684\u200b\u5c5e\u6027\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>compatible\uff1a\u200b\u6839\u636e\u200b\u5b83\u200b\u627e\u5230\u200bSPI Device\u200b\u9a71\u52a8\u200b</li> <li>reg\uff1a\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u5b83\u200b\u4f7f\u7528\u200b\u54ea\u4e2a\u200b\u7247\u9009\u200b\u5f15\u811a\u200b</li> <li>spi-max-frequency\uff1a\u200b\u5fc5\u9009\u200b\uff0c\u200b\u8be5\u200bSPI\u200b\u8bbe\u5907\u200b\u652f\u6301\u200b\u7684\u200b\u6700\u5927\u200bSPI\u200b\u65f6\u949f\u200b</li> </ul> <p>\u200b\u53ef\u9009\u200b\u7684\u200b\u5c5e\u6027\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>spi-cpol\uff1a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u7a7a\u200b\u5c5e\u6027\u200b(\u200b\u6ca1\u6709\u200b\u503c\u200b)\uff0c\u200b\u8868\u793a\u200bCPOL\u200b\u4e3a\u200b1\uff0c\u200b\u5373\u200b\u5e73\u65f6\u200bSPI\u200b\u65f6\u949f\u200b\u4e3a\u200b\u4f4e\u7535\u5e73\u200b</li> <li>spi-cpha\uff1a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u7a7a\u200b\u5c5e\u6027\u200b(\u200b\u6ca1\u6709\u200b\u503c\u200b)\uff0c\u200b\u8868\u793a\u200bCPHA\u200b\u4e3a\u200b1)\uff0c\u200b\u5373\u200b\u5728\u200b\u65f6\u949f\u200b\u7684\u200b\u7b2c\u200b2\u200b\u4e2a\u200b\u8fb9\u6cbf\u200b\u91c7\u6837\u200b\u6570\u636e\u200b</li> <li>spi-cs-high\uff1a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u7a7a\u200b\u5c5e\u6027\u200b(\u200b\u6ca1\u6709\u200b\u503c\u200b)\uff0c\u200b\u8868\u793a\u200b\u7247\u9009\u200b\u5f15\u811a\u200b\u9ad8\u7535\u5e73\u200b\u6709\u6548\u200b</li> <li>spi-3wire\uff1a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u7a7a\u200b\u5c5e\u6027\u200b(\u200b\u6ca1\u6709\u200b\u503c\u200b)\uff0c\u200b\u8868\u793a\u200b\u4f7f\u7528\u200bSPI \u200b\u4e09\u7ebf\u200b\u6a21\u5f0f\u200b</li> <li>spi-lsb-first\uff1a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u7a7a\u200b\u5c5e\u6027\u200b(\u200b\u6ca1\u6709\u200b\u503c\u200b)\uff0c\u200b\u8868\u793a\u200b\u4f7f\u7528\u200bSPI\u200b\u4f20\u8f93\u6570\u636e\u200b\u65f6\u5148\u200b\u4f20\u8f93\u200b\u6700\u4f4e\u200b\u4f4d\u200b(LSB)</li> <li>spi-tx-bus-width\uff1a\u200b\u8868\u793a\u200b\u6709\u200b\u51e0\u6761\u200bMOSI\u200b\u5f15\u811a\u200b\uff1b\u200b\u6ca1\u6709\u200b\u8fd9\u4e2a\u200b\u5c5e\u6027\u200b\u65f6\u200b\u9ed8\u8ba4\u200b\u53ea\u6709\u200b1\u200b\u6761\u200bMOSI\u200b\u5f15\u811a\u200b</li> <li>spi-rx-bus-width\uff1a\u200b\u8868\u793a\u200b\u6709\u200b\u51e0\u6761\u200bMISO\u200b\u5f15\u811a\u200b\uff1b\u200b\u6ca1\u6709\u200b\u8fd9\u4e2a\u200b\u5c5e\u6027\u200b\u65f6\u200b\u9ed8\u8ba4\u200b\u53ea\u6709\u200b1\u200b\u6761\u200bMISO\u200b\u5f15\u811a\u200b</li> <li>spi-rx-delay-us\uff1a\u200b\u5355\u4f4d\u200b\u662f\u200b\u6beb\u79d2\u200b\uff0c\u200b\u8868\u793a\u200b\u6bcf\u6b21\u200b\u8bfb\u200b\u4f20\u8f93\u200b\u540e\u8981\u200b\u5ef6\u65f6\u200b\u591a\u4e45\u200b</li> <li>spi-tx-delay-us\uff1a\u200b\u5355\u4f4d\u200b\u662f\u200b\u6beb\u79d2\u200b\uff0c\u200b\u8868\u793a\u200b\u6bcf\u6b21\u200b\u5199\u200b\u4f20\u8f93\u200b\u540e\u8981\u200b\u5ef6\u65f6\u200b\u591a\u4e45\u200b</li> </ul>"},{"location":"11_SPI/21_1/#address-cellsspi-masterspicell","title":"address-cells\uff1a\u200b\u8fd9\u4e2a\u200bSPI Master\u200b\u4e0b\u200b\u7684\u200bSPI\u200b\u8bbe\u5907\u200b\uff0c\u200b\u9700\u8981\u200b\u591a\u5c11\u200b\u4e2a\u200bcell\u200b\u6765\u200b\u8868\u8ff0\u200b\u5b83\u200b\u7684\u200b\u7247\u9009\u200b\u5f15\u811a","text":""},{"location":"11_SPI/21_1/#size-cells0","title":"size-cells\uff1a\u200b\u5fc5\u987b\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b0","text":""},{"location":"11_SPI/21_1/#122","title":"1.2.2 \u200b\u7f16\u5199\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<ul> <li>\u200b\u6838\u5fc3\u200b\u4e3a\u200b\uff1a\u200b\u5206\u914d\u200b/\u200b\u8bbe\u7f6e\u200b/\u200b\u6ce8\u518c\u200bspi_master\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> <li>\u200b\u5bf9\u4e8e\u200b\u8001\u200b\u65b9\u6cd5\u200b\uff0cspi_master\u200b\u7ed3\u6784\u200b\u4f53\u200b\u7684\u200b\u6838\u5fc3\u200b\u662f\u200btransfer\u200b\u51fd\u6570\u200b</li> </ul>"},{"location":"11_SPI/21_1/#2","title":"2. \u200b\u7f16\u5199\u7a0b\u5e8f","text":""},{"location":"11_SPI/21_1/#21","title":"2.1 \u200b\u6570\u636e\u4f20\u8f93\u200b\u6d41\u7a0b","text":""},{"location":"11_SPI/21_1/#22","title":"2.2 \u200b\u5199\u200b\u4ee3\u7801","text":""},{"location":"11_SPI/22_1/","title":"\u4f7f\u7528\u200b\u65b0\u200b\u65b9\u6cd5\u200b\u7f16\u5199\u200b\u7684\u200bSPI_Master\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<p>\u200b\u672c\u200b\u8282\u200b\u6e90\u7801\u200b\uff1a </p> <p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u200b\u5185\u6838\u200b\u5934\u6587\u4ef6\u200b\uff1a<code>include\\linux\\spi\\spi.h</code></li> <li>\u200b\u5185\u6838\u200b\u6587\u6863\u200b\uff1a<code>Documentation\\devicetree\\bindings\\spi\\spi-bus.txt</code> </li> <li>\u200b\u5185\u6838\u200b\u6e90\u7801\u200b\uff1a<code>drivers\\spi\\spi.c</code>\u3001<code>drivers\\spi\\spi-sh.c</code></li> </ul>"},{"location":"11_SPI/22_1/#1","title":"1. \u200b\u4fee\u6539\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"11_SPI/22_1/#11-imx6ull","title":"1.1 IMX6ULL","text":"<p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dts</code>\u200b\u4e2d\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>        virtual_spi_master {\n                compatible = \"100ask,virtual_spi_master\";\n                status = \"okay\";\n                cs-gpios = &lt;&amp;gpio4 27 GPIO_ACTIVE_LOW&gt;;\n                num-chipselects = &lt;1&gt;;\n                #address-cells = &lt;1&gt;;\n                #size-cells = &lt;0&gt;;\n\n                virtual_spi_dev: virtual_spi_dev@0 {\n                        compatible = \"spidev\";\n                        reg = &lt;0&gt;;\n                        spi-max-frequency = &lt;100000&gt;;\n                };\n        };\n</code></pre>"},{"location":"11_SPI/22_1/#22-stm32mp157","title":"2.2 STM32MP157","text":"<p>\u200b\u4fee\u6539\u200b<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dts</code>\u200b\u4e2d\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>        virtual_spi_master {\n                compatible = \"100ask,virtual_spi_master\";\n                status = \"okay\";\n                cs-gpios = &lt;&amp;gpioh 6 GPIO_ACTIVE_LOW&gt;;\n                num-chipselects = &lt;1&gt;;\n                #address-cells = &lt;1&gt;;\n                #size-cells = &lt;0&gt;;\n\n                virtual_spi_dev: virtual_spi_dev@0 {\n                        compatible = \"spidev\";\n                        reg = &lt;0&gt;;\n                        spi-max-frequency = &lt;100000&gt;;\n                };\n        };\n</code></pre>"},{"location":"11_SPI/22_1/#2","title":"2. \u200b\u7f16\u8bd1\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":""},{"location":"11_SPI/22_1/#21-imx6ull","title":"2.1 IMX6ULL","text":""},{"location":"11_SPI/22_1/#211","title":"2.1.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\n export PATH=$PATH:/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"11_SPI/22_1/#212","title":"2.1.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bIMX6ULL\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/100ask_imx6ull-14x14.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/100ask_imx6ull-14x14.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> </ul> <pre><code>[root@100ask:~]# cp /mnt/100ask_imx6ull-14x14.dtb /boot\n[root@100ask:~]# sync\n</code></pre> <ul> <li>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</li> </ul>"},{"location":"11_SPI/22_1/#22-stm32mp157_1","title":"2.2 STM32MP157","text":""},{"location":"11_SPI/22_1/#221","title":"2.2.1 \u200b\u8bbe\u7f6e\u200b\u5de5\u5177\u200b\u94fe","text":"<pre><code>export ARCH=arm\nexport CROSS_COMPILE=arm-buildroot-linux-gnueabihf-\nexport PATH=$PATH:/home/book/100ask_stm32mp157_pro-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin\n</code></pre>"},{"location":"11_SPI/22_1/#222","title":"2.2.2 \u200b\u7f16\u8bd1\u200b\u3001\u200b\u66ff\u6362\u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li> <p>\u200b\u7f16\u8bd1\u200b\u8bbe\u5907\u200b\u6811\u200b\uff1a     \u200b\u5728\u200bUbuntu\u200b\u7684\u200bSTM32MP157\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b,     \u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u6811\u200b\u6587\u4ef6\u200b\uff1a<code>arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb</code></p> <pre><code>make dtbs\n</code></pre> </li> <li> <p>\u200b\u590d\u5236\u5230\u200bNFS\u200b\u76ee\u5f55\u200b\uff1a</p> <pre><code>$ cp arch/arm/boot/dts/stm32mp157c-100ask-512d-lcd-v1.dtb ~/nfs_rootfs/\n</code></pre> </li> <li> <p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6302\u8f7d\u200bNFS\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</p> <pre><code>[root@100ask:~]#  mount -t nfs -o nolock,vers=3 192.168.1.137:/home/book/nfs_rootfs /mnt\n</code></pre> </li> <li> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u6811\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b\u54ea\u91cc\u200b</p> </li> </ul> <p>\u200b\u7531\u4e8e\u200b\u7248\u672c\u200b\u53d8\u5316\u200b\uff0cSTM32MP157\u200b\u5355\u677f\u200b\u4e0a\u200b\u70e7\u5f55\u200b\u7684\u200b\u7cfb\u7edf\u200b\u53ef\u80fd\u200b\u6709\u200b\u7ec6\u5fae\u5dee\u522b\u200b\u3002   \u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b<code>cat /proc/mounts</code>\u200b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u4e24\u79cd\u200b\u7ed3\u679c\u200b(\u200b\u89c1\u200b\u4e0b\u56fe\u200b)\uff1a</p> <ul> <li> <p>mmcblk2p2\u200b\u5206\u533a\u200b\u6302\u8f7d\u200b\u5728\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u5de6\u8fb9\u200b)\uff1a\u200b\u65e0\u9700\u200b\u7279\u6b8a\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u4e0b\u9762\u200b\u628a\u200b\u6587\u4ef6\u200b\u590d\u5236\u5230\u200b/boot\u200b\u76ee\u5f55\u200b\u5373\u53ef\u200b</p> </li> <li> <p>mmcblk2p2\u200b\u6302\u8f7d\u200b\u5728\u200b/mnt\u200b\u76ee\u5f55\u200b\u4e0b\u200b(\u200b\u4e0b\u56fe\u200b\u53f3\u8fb9\u200b)</p> <ul> <li>\u200b\u5728\u200b\u89c6\u9891\u200b\u91cc\u200b\u3001\u200b\u540e\u9762\u200b\u6587\u6863\u200b\u91cc\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u66f4\u65b0\u200b/boot\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u7684\u200b\u6587\u4ef6\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8981\u200b\u5148\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u91cd\u65b0\u200b\u6302\u8f7d\u200b\uff1a</li> <li><code>mount  /dev/mmcblk2p2  /boot</code></li> </ul> <p></p> </li> <li> <p>\u200b\u66f4\u65b0\u200b\u8bbe\u5907\u200b\u6811\u200b</p> </li> </ul> <pre><code>[root@100ask:~]# cp /mnt/stm32mp157c-100ask-512d-lcd-v1.dtb /boot/\n[root@100ask:~]# sync\n</code></pre> <ul> <li>\u200b\u91cd\u542f\u200b\u5f00\u53d1\u677f\u200b</li> </ul>"},{"location":"11_SPI/22_1/#3-app","title":"3. \u200b\u7f16\u8bd1\u200b\u9a71\u52a8\u200b\u548c\u200bAPP","text":""},{"location":"11_SPI/22_1/#4","title":"4. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<p>\u200b\u5148\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>insmod virtual_spi_master.ko\n</code></pre> <p>\u200b\u5bf9\u4e8e\u200bIMX6ULL\uff0c\u200b\u56e0\u4e3a\u200bspidev\u200b\u6ca1\u6709\u200b\u88ab\u200b\u7f16\u8bd1\u200b\u8fdb\u200b\u5185\u6838\u200b\uff0c\u200b\u90a3\u4e48\u200b\u518d\u200b\u6267\u884c\u200b(\u200b\u5bf9\u4e8e\u200bSTM32MP157\uff0c\u200b\u65e0\u9700\u200b\u6267\u884c\u200b\u8fd9\u4e2a\u200b\u547d\u4ee4\u200b)\uff1a</p> <pre><code>insmod spidev.ko\n</code></pre> <p>\u200b\u786e\u5b9a\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\uff1a</p> <pre><code>ls /dev/spidev*\n</code></pre> <p>\u200b\u5047\u8bbe\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\u4e3a\u200b<code>/dev/spidev32765.0</code>\uff0c\u200b\u6267\u884c\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b(\u200b\u5b83\u200b\u5e76\u200b\u4e0d\u4f1a\u200b\u771f\u6b63\u200b\u5730\u200b\u8bfb\u5199\u200b\u6570\u636e\u200b)\uff1a</p> <pre><code>./spi_test  /dev/spidev32765.0  500\n./spi_test  /dev/spidev32765.0  600\n./spi_test  /dev/spidev32765.0  1000\n</code></pre>"},{"location":"11_SPI/23_1/","title":"SPI_Slave_Mode\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":"<ul> <li>\u200b\u53c2\u8003\u200b\u5185\u6838\u200b\u6e90\u7801\u200b: <code>Linux-5.4\\drivers\\spi\\spi-imx.c</code></li> <li>\u200b\u6ce8\u610f\u200b\uff1aLinux 4.9\u200b\u7684\u200b\u5185\u6838\u200b\u672a\u200b\u652f\u6301\u200bSPI Slave Mode</li> <li>\u200b\u53c2\u8003\u200b\u6587\u6863\u200b\uff1a\u300aLinux_as_an_SPI_Slave_Handouts.pdf\u300b</li> </ul>"},{"location":"11_SPI/23_1/#1-masterslave","title":"1. Master\u200b\u548c\u200bSlave\u200b\u6a21\u5f0f\u200b\u5dee\u522b","text":"<p>\u200b\u4ee5\u200bIMX6ULL\u200b\u4e3a\u4f8b\u200b\uff0cMaster\u200b\u548c\u200bSlave\u200b\u6a21\u5f0f\u200b\u7684\u200b\u5f02\u540c\u200b\u5982\u4e0b\u200b\u56fe\u200b\uff1a</p> <ul> <li> <p>\u200b\u521d\u59cb\u5316\u200b</p> </li> <li> <p>SPI\u200b\u5bc4\u5b58\u5668\u200b\u6709\u6240\u4e0d\u540c\u200b</p> </li> <li> <p>\u200b\u5f15\u811a\u200b\u6709\u6240\u4e0d\u540c\u200b\uff1aMaster\u200b\u6a21\u5f0f\u200b\u4e0b\u200bSS\u3001CLK\u200b\u5f15\u811a\u200b\u662f\u200b\u8f93\u51fa\u200b\u5f15\u811a\u200b\uff0cSlave\u200b\u6a21\u5f0f\u200b\u4e0b\u200b\u8fd9\u4e9b\u200b\u5f15\u811a\u200b\u662f\u200b\u8f93\u5165\u200b\u5f15\u811a\u200b</p> </li> <li> <p>\u200b\u51c6\u5907\u200b\u6570\u636e\u200b\uff1a\u200b\u90fd\u200b\u9700\u8981\u200b\u51c6\u5907\u200b\u597d\u8981\u200b\u53d1\u9001\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u586b\u5145\u200bTXFIFO</p> </li> <li> <p>\u200b\u53d1\u8d77\u200b\u4f20\u8f93\u200b\uff1aMaster\u200b\u6a21\u5f0f\u200b\u4e0b\u8981\u200b\u4e3b\u52a8\u200b\u53d1\u8d77\u200b\u4f20\u8f93\u200b\uff0c\u200b\u7b49\u5f85\u200b\u53d1\u9001\u200b\u5b8c\u6210\u200b(\u200b\u7b49\u5f85\u200b\u4e2d\u65ad\u200b)</p> </li> <li> <p>\u200b\u4f7f\u80fd\u200b\u63a5\u6536\u200b\u4e2d\u65ad\u200b\uff1aSlave\u200b\u6a21\u5f0f\u200b\u4e0b\u200b\u65e0\u6cd5\u200b\u4e3b\u52a8\u200b\u53d1\u8d77\u200b\u4f20\u8f93\u200b\uff0c\u200b\u53ea\u80fd\u200b\u88ab\u52a8\u200b\u5730\u200b\u7b49\u5f85\u200b\uff0c\u200b\u4f7f\u80fd\u200b\u63a5\u6536\u200b\u4e2d\u65ad\u200b\u5373\u53ef\u200b</p> </li> <li> <p>\u200b\u4e2d\u65ad\u200b\u51fd\u6570\u200b\u91cc\u200b\uff1a\u200b\u8bfb\u53d6\u200bRXFIFO\u200b\u5f97\u5230\u200b\u6570\u636e\u200b</p> </li> <li> <p>\u200b\u4f20\u8f93\u200b\u5b8c\u6210\u200b</p> </li> </ul> <p></p>"},{"location":"11_SPI/23_1/#2-spi","title":"2. SPI\u200b\u4f20\u8f93\u200b\u6982\u8ff0","text":""},{"location":"11_SPI/23_1/#21","title":"2.1 \u200b\u6570\u636e\u7ec4\u7ec7\u200b\u65b9\u5f0f","text":"<p>\u200b\u4f7f\u7528\u200bSPI\u200b\u4f20\u8f93\u200b\u65f6\u200b\uff0c\u200b\u6700\u5c0f\u200b\u7684\u200b\u4f20\u8f93\u200b\u5355\u4f4d\u200b\u662f\u200b\"spi_transfer\"\uff0c</p> <p>\u200b\u5bf9\u4e8e\u200b\u4e00\u4e2a\u200b\u8bbe\u5907\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u53d1\u8d77\u200b\u591a\u4e2a\u200bspi_transfer\uff0c</p> <p>\u200b\u8fd9\u4e9b\u200bspi_transfer\uff0c\u200b\u4f1a\u200b\u653e\u5165\u200b\u4e00\u4e2a\u200bspi_message\u200b\u91cc\u200b\u3002</p> <ul> <li> <p>spi_transfer\uff1a\u200b\u6307\u5b9a\u200btx_buf\u3001rx_buf\u3001len   </p> </li> <li> <p>\u200b\u540c\u4e00\u4e2a\u200bSPI\u200b\u8bbe\u5907\u200b\u7684\u200bspi_transfer\uff0c\u200b\u4f7f\u7528\u200bspi_message\u200b\u6765\u200b\u7ba1\u7406\u200b\uff1a   </p> </li> <li> <p>\u200b\u540c\u4e00\u4e2a\u200bSPI Master\u200b\u4e0b\u200b\u7684\u200bspi_message\uff0c\u200b\u653e\u5728\u200b\u4e00\u4e2a\u200b\u961f\u5217\u200b\u91cc\u200b\uff1a   </p> </li> </ul> <p>\u200b\u6240\u4ee5\u200b\uff0c\u200b\u53cd\u8fc7\u6765\u200b\uff0cSPI\u200b\u4f20\u8f93\u200b\u7684\u200b\u6d41\u7a0b\u200b\u662f\u200b\u8fd9\u6837\u200b\u7684\u200b\uff1a</p> <ul> <li>\u200b\u4ece\u200bspi_master\u200b\u7684\u200b\u961f\u5217\u200b\u91cc\u200b\u53d6\u51fa\u200b\u6bcf\u200b\u4e00\u4e2a\u200bspi_message</li> <li>\u200b\u4ece\u200bspi_message\u200b\u7684\u200b\u961f\u5217\u200b\u91cc\u200b\u53d6\u51fa\u200b\u4e00\u4e2a\u200bspi_transfer<ul> <li>\u200b\u5904\u7406\u200bspi_transfer</li> </ul> </li> </ul>"},{"location":"11_SPI/23_1/#22-spi","title":"2.2 SPI\u200b\u63a7\u5236\u5668\u200b\u6570\u636e\u7ed3\u6784","text":"<p>\u200b\u53c2\u8003\u200b\u5185\u6838\u200b\u6587\u4ef6\u200b\uff1a<code>include\\linux\\spi\\spi.h</code></p> <p>Linux\u200b\u4e2d\u200b\u4f7f\u7528\u200bspi_master\u200b\u7ed3\u6784\u200b\u4f53\u200b\u63cf\u8ff0\u200bSPI\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u6709\u200b\u4e24\u5957\u200b\u4f20\u8f93\u200b\u65b9\u6cd5\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/23_1/#3-spi-slave-mode","title":"3. SPI Slave Mode\u200b\u6570\u636e\u4f20\u8f93\u200b\u8fc7\u7a0b","text":""},{"location":"11_SPI/23_1/#4","title":"4. \u200b\u5982\u4f55\u200b\u7f16\u5199\u7a0b\u5e8f","text":""},{"location":"11_SPI/23_1/#41","title":"4.1 \u200b\u8bbe\u5907\u200b\u6811","text":"<ul> <li>SPI\u200b\u63a7\u5236\u5668\u200b\u8bbe\u5907\u200b\u6811\u200b\u8282\u70b9\u200b\u4e2d\u200b\uff0c\u200b\u9700\u8981\u200b\u6dfb\u52a0\u200b\u4e00\u4e2a\u200b\u7a7a\u200b\u5c5e\u6027\u200b\uff1aspi-slave  </li> <li>\u200b\u8981\u200b\u6a21\u62df\u200b\u54ea\u7c7b\u200bslave\u200b\u8bbe\u5907\u200b\uff1f\u200b\u9700\u8981\u200b\u6dfb\u52a0\u200b<code>slave</code>\u200b\u5b50\u200b\u8282\u70b9\u200b\uff0c\u200b\u8fd9\u662f\u200b\u7528\u6765\u200b\u6307\u5b9a\u200b<code>slave protocol</code></li> </ul>"},{"location":"11_SPI/23_1/#42","title":"4.2 \u200b\u5185\u6838\u200b\u76f8\u5173","text":"<ul> <li>\u200b\u65b0\u200b\u914d\u7f6e\u200b\u9879\u200b\uff1aCONFIG_SPI_SLAVE</li> <li>\u200b\u8bbe\u5907\u200b\u6811\u200b\u7684\u200b\u89e3\u6790\u200b\uff1a\u200b\u589e\u52a0\u200b\u5bf9\u200b<code>spi-slave</code>\u3001<code>slave</code>\u200b\u5b50\u200b\u8282\u70b9\u200b\u7684\u200b\u89e3\u6790\u200b</li> <li>sysfs\uff1a\u200b\u65b0\u200b\u589e\u52a0\u200b<code>/sys/devices/.../CTLR/slave</code>\uff0c\u200b\u5bf9\u5e94\u200b<code>SPI Slave handlers</code></li> <li>\u200b\u65b0\u200bAPI</li> <li>spi_alloc_slave( )</li> <li>spi_slave_abort( )</li> <li> <p>spi_controller_is_slave( )</p> </li> <li> <p>\u200b\u786c\u4ef6\u200b\u8bbe\u7f6e\u200b\u4e0d\u200b\u4e00\u6837\u200b</p> </li> <li>master\uff1aSS\u3001SCLK\u200b\u5f15\u811a\u200b\u662f\u200b\u8f93\u51fa\u200b\u5f15\u811a\u200b</li> <li>slave\uff1aSS\u3001SCLK\u200b\u5f15\u811a\u200b\u662f\u200b\u8f93\u5165\u200b\u5f15\u811a\u200b</li> <li>\u200b\u4f20\u8f93\u200b\u65f6\u200b\u7b49\u5f85\u200b\u51fd\u6570\u200b\u4e0d\u200b\u4e00\u6837\u200b</li> <li>master\uff1amaster\u200b\u4e3b\u52a8\u200b\u53d1\u8d77\u200bspi\u200b\u4f20\u8f93\u200b\uff0c\u200b\u5b83\u200b\u53ef\u4ee5\u200b\u6307\u5b9a\u200b\u8d85\u65f6\u200b\u65f6\u95f4\u200b\uff0c\u200b\u4f7f\u7528\u200b\u51fd\u6570\u200b<code>wait_for_completion_timeout()</code>\u200b\u8fdb\u884c\u200b\u7b49\u5f85\u200b</li> <li>slave\uff1aslave\u200b\u53ea\u80fd\u200b\u88ab\u52a8\u200b\u7b49\u5f85\u200b\u4f20\u8f93\u200b\uff0c\u200b\u5b83\u200b\u65e0\u9700\u200b\u6307\u5b9a\u200b\u8d85\u65f6\u200b\u65f6\u95f4\u200b\uff0c\u200b\u4f7f\u7528\u200b\u51fd\u6570\u200b<code>wait_for_completion_interruptible()</code>\u200b\u8fdb\u884c\u200b\u7b49\u5f85\u200b \uff0c\u200b\u4f7f\u7528\u200b<code>.slave_abort()</code>\u200b\u6765\u200b\u53d6\u6d88\u200b\u7b49\u5f85\u200b</li> </ul>"},{"location":"11_SPI/23_1/#43","title":"4.3 \u200b\u7b80\u5355\u200b\u7684\u200b\u793a\u4f8b\u200b\u4ee3\u7801","text":""},{"location":"11_SPI/23_1/#431-masterslave","title":"4.3.1 master\u200b\u548c\u200bslave\u200b\u9a71\u52a8\u200b\u793a\u4f8b","text":""},{"location":"11_SPI/23_1/#432-masterslave","title":"4.3.2 master\u200b\u548c\u200bslave\u200b\u4f7f\u7528\u200b\u793a\u4f8b","text":"<p>\u200b\u5bf9\u4e8e\u200b\u8bbe\u7f6e\u200b\u4e3a\u200bspi master\u200b\u6a21\u5f0f\u200b\u7684\u200bspi\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u4e0b\u9762\u200b\u63a5\u200b\u7684\u200b\u662f\u200b\u4e00\u4e2a\u200b\u4e00\u4e2a\u200bspi slave\u200b\u8bbe\u5907\u200b\uff0c\u200b\u6211\u4eec\u200b\u7f16\u5199\u200b\u5404\u7c7b\u200bspi slave driver\uff0c\u200b\u901a\u8fc7\u200bspi master\u200b\u7684\u200b\u51fd\u6570\u200b\u8bfb\u5199\u200bspi slave \u200b\u8bbe\u5907\u200b\u3002</p> <p>\u200b\u5bf9\u4e8e\u200b\u8bbe\u7f6e\u200b\u4e3a\u200bspi slave\u200b\u6a21\u5f0f\u200b\u7684\u200bspi\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u5b83\u200b\u662f\u200b\u4f5c\u4e3a\u200b\u4e00\u4e2a\u200bspi slave\u200b\u8bbe\u5907\u200b\u88ab\u200b\u5176\u4ed6\u200b\u5355\u677f\u200b\u7684\u200bspi master\u200b\u8bbe\u5907\u200b\u6765\u200b\u8bbf\u95ee\u200b\uff0c\u200b\u5b83\u200b\u5982\u4f55\u200b\u63a5\u6536\u6570\u636e\u200b\u3001\u200b\u5982\u4f55\u200b\u63d0\u4f9b\u6570\u636e\u200b\uff1f\u200b\u6211\u4eec\u200b\u7f16\u5199\u200b\u5bf9\u5e94\u200b\u7684\u200bspi slave handler\u3002</p> <p>\u200b\u5bf9\u4e8e\u200bmaster\u200b\u548c\u200bslave\uff0c\u200b\u6709\u200b\u4e24\u4e2a\u200b\u91cd\u8981\u200b\u6982\u5ff5\u200b\uff1a</p> <ul> <li>SPI Slave Driver\uff1a\u200b\u901a\u8fc7\u200bSPI Master\u200b\u63a7\u5236\u5668\u200b\u8ddf\u200bSPI Slave\u200b\u8bbe\u5907\u200b\u901a\u4fe1\u200b</li> <li>SPI Slave Handler\uff1a\u200b\u901a\u8fc7\u200bSPI Slave\u200b\u63a7\u5236\u5668\u200b\u76d1\u542c\u200b\u8fdc\u200b\u7aef\u7684\u200bSPI Master</li> </ul> <p></p>"},{"location":"11_SPI/24_1/","title":"SPI_Slave_Mode\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6e90\u7801\u200b\u89e3\u8bfb","text":"<ul> <li>\u200b\u53c2\u8003\u200b\u5185\u6838\u200b\u6e90\u7801\u200b: <code>Linux-5.4\\drivers\\spi\\spi-imx.c</code></li> <li>\u200b\u6ce8\u610f\u200b\uff1aLinux 4.9\u200b\u7684\u200b\u5185\u6838\u200b\u672a\u200b\u652f\u6301\u200bSPI Slave Mode</li> <li>\u200b\u53c2\u8003\u200b\u6587\u6863\u200b\uff1a\u300aLinux_as_an_SPI_Slave_Handouts.pdf\u300b</li> </ul>"},{"location":"11_SPI/24_1/#1","title":"1. \u200b\u8bbe\u5907\u200b\u6811","text":"<p>Linux 5.4\u200b\u4e2d\u200bIMX6ULL\u200b\u7684\u200b\u8bbe\u5907\u200b\u6811\u200b\u4ee3\u7801\u200b\u91cc\u200b\uff0c\u200b\u5e76\u672a\u200b\u652f\u6301\u200bslave\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u4e0b\u56fe\u200b\u662f\u200b\u6458\u81ea\u200b\u300aLinux_as_an_SPI_Slave_Handouts.pdf\u300b\uff1a</p> <p></p>"},{"location":"11_SPI/24_1/#2","title":"2. \u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u7a0b\u5e8f","text":"<p>\u200b\u5728\u200bLinux 5.4\u200b\u4e2d\u200b\uff0cSPI\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4ecd\u7136\u200b\u4f7f\u7528\u200b\u539f\u7406\u200b\u7684\u200b\u540d\u5b57\u200b\uff1astruct spi_master\uff0c\u200b\u4f46\u662f\u200b\u5b83\u200b\u5df2\u7ecf\u200b\u662f\u200b\u4e00\u4e2a\u200b\u5b8f\u200b\uff1a</p> <pre><code>#define spi_master          spi_controller\n</code></pre> <p>\u200b\u8fd9\u200b\u610f\u5473\u7740\u200b\u5b83\u200b\u53ef\u4ee5\u200b\u5de5\u4f5c\u200b\u4e8e\u200bmaster\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u5de5\u4f5c\u200b\u4e8e\u200bslave\u200b\u6a21\u5f0f\u200b\u3002</p>"},{"location":"11_SPI/24_1/#21-spi_controller","title":"2.1 \u200b\u5206\u914d\u200b\u4e00\u4e2a\u200bspi_controller","text":""},{"location":"11_SPI/24_1/#22-spi_controller","title":"2.2 \u200b\u8bbe\u7f6e\u200bspi_controller","text":"<p>\u200b\u5de5\u4f5c\u200b\u4e8e\u200bslave\u200b\u6a21\u5f0f\u200b\u65f6\u200b\uff0c\u200b\u8ddf\u200bmaster\u200b\u6a21\u5f0f\u200b\u6700\u5927\u200b\u7684\u200b\u5dee\u522b\u200b\u5c31\u662f\u200b\u5982\u4e0b\u200b\u51fd\u6570\u200b\u4e0d\u200b\u4e00\u6837\u200b\uff1a</p> <ul> <li>bitbang.txrx_bufs\u200b\u51fd\u6570\u200b\u4e0d\u200b\u4e00\u6837\u200b</li> <li>\u200b\u5728\u200bIMX6ULL\u200b\u4e2d\u200b\uff0c\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u4e3a\u200bspi_imx_transfer\uff0c\u200b\u91cc\u9762\u200b\u5bf9\u200bmaster\u3001slave\u200b\u6a21\u5f0f\u200b\u5206\u5f00\u200b\u5904\u7406\u200b</li> <li>master\u200b\u6a21\u5f0f\u200b\uff1a\u200b\u4f7f\u7528\u200b<code>spi_imx_pio_transfer</code>\u200b\u51fd\u6570\u200b</li> <li>slave\u200b\u6a21\u5f0f\u200b\uff1a\u200b\u4f7f\u7528\u200b<code>spi_imx_pio_transfer_slave</code>\u200b\u51fd\u6570\u200b</li> <li>\u200b\u589e\u52a0\u200b\u4e86\u200bbitbang.master-&gt;slave_abort\u200b\u51fd\u6570\u200b</li> </ul> <p></p>"},{"location":"11_SPI/24_1/#221","title":"2.2.1 \u200b\u4f20\u8f93\u200b\u51fd\u6570\u200b\u5bf9\u6bd4","text":""},{"location":"11_SPI/24_1/#23-spi_controller","title":"2.3 \u200b\u6ce8\u518c\u200bspi_controller","text":"<p>\u200b\u65e0\u8bba\u662f\u200bmaster\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u8fd8\u662f\u200bslave\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u6ce8\u518c\u200b\u51fd\u6570\u200b\u65f6\u200b\u4e00\u6837\u200b\u7684\u200b\uff1a</p> <p></p> <p>\u200b\u5728\u200bspi_bitbang_start\u200b\u5185\u90e8\u200b\uff0c\u200b\u4f1a\u200b\u5904\u7406\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\u7684\u200b\u5b50\u200b\u8282\u70b9\u200b\uff0c\u200b\u521b\u5efa\u200b\u5e76\u200b\u6ce8\u518c\u200bspi_device\uff1a</p> <pre><code>spi_bitbang_start\n    spi_register_master\n        spi_register_controller\n            of_register_spi_devices\n</code></pre> <p></p> <p>\u200b\u5bf9\u4e8e\u200bmaster\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u8bbe\u5907\u200b\u6811\u4e2d\u200b\u7684\u200b\u5b50\u200b\u8282\u70b9\u200b\u5bf9\u5e94\u200b\u771f\u5b9e\u200b\u7684\u200bspi\u200b\u8bbe\u5907\u200b\uff1b</p> <p>\u200b\u4f46\u662f\u200b\u5bf9\u4e8e\u200bslave\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u5b50\u200b\u8282\u70b9\u200b\u53ea\u662f\u200b\u7528\u6765\u200b\u9009\u62e9\u200b\u5bf9\u5e94\u200b\u7684\u200bspi slave handler\uff1a\u200b\u5c31\u662f\u200b\u4f7f\u7528\u200b\u54ea\u4e2a\u200b\u9a71\u52a8\u200b\u6765\u200b\u6a21\u62df\u200bspi slave\u200b\u8bbe\u5907\u200b\uff0c\u200b\u6bd4\u5982\u200b\uff1a</p> <p></p>"},{"location":"11_SPI/24_1/#24","title":"2.4 \u200b\u786c\u4ef6\u200b\u64cd\u4f5c","text":""},{"location":"11_SPI/24_1/#241","title":"2.4.1 \u200b\u5f15\u811a\u200b\u914d\u7f6e","text":""},{"location":"11_SPI/24_1/#3","title":"3. \u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f","text":""},{"location":"11_SPI/24_1/#31-master","title":"3.1 Master\u200b\u6a21\u5f0f","text":""},{"location":"11_SPI/24_1/#32-slave","title":"3.2 Slave\u200b\u6a21\u5f0f","text":"<p>\u200b\u53c2\u8003\u200b\u4ee3\u7801\u200b\uff1a<code>Linux-5.4\\drivers\\spi\\spi-slave-time.c</code></p> <p></p>"},{"location":"11_SPI/25_1/","title":"\u4e34\u65f6\u200b\u7b14\u8bb0","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u200b\u5185\u6838\u200b\u5934\u6587\u4ef6\u200b\uff1a<code>include\\linux\\spi\\spi.h</code></li> </ul>"},{"location":"11_SPI/25_1/#1-spi-master","title":"1. SPI Master","text":"<p>\u200b\u6587\u4ef6\u200b\uff1a<code>drivers\\spi\\spi-gpio.c</code></p> <pre><code>    spi_gpio = spi_master_get_devdata(master);\n\n    master = spi_alloc_master(...);\n\n    master-&gt;bits_per_word_mask = SPI_BPW_RANGE_MASK(1, 32);\n    master-&gt;flags = master_flags;\n    master-&gt;bus_num = pdev-&gt;id;\n    master-&gt;num_chipselect = num_devices;\n    master-&gt;setup = spi_gpio_setup;\n    master-&gt;cleanup = spi_gpio_cleanup;\n\n    status = of_get_named_gpio(np, \"cs-gpios\", i);\n    spi_gpio-&gt;cs_gpios[i] = status;\n\n    spi_gpio-&gt;bitbang.master = master;\n    spi_gpio-&gt;bitbang.chipselect = spi_gpio_chipselect;\n\n    if ((master_flags &amp; (SPI_MASTER_NO_TX | SPI_MASTER_NO_RX)) == 0) {\n        spi_gpio-&gt;bitbang.txrx_word[SPI_MODE_0] = spi_gpio_txrx_word_mode0;\n        spi_gpio-&gt;bitbang.txrx_word[SPI_MODE_1] = spi_gpio_txrx_word_mode1;\n        spi_gpio-&gt;bitbang.txrx_word[SPI_MODE_2] = spi_gpio_txrx_word_mode2;\n        spi_gpio-&gt;bitbang.txrx_word[SPI_MODE_3] = spi_gpio_txrx_word_mode3;\n    } else {\n        spi_gpio-&gt;bitbang.txrx_word[SPI_MODE_0] = spi_gpio_spec_txrx_word_mode0;\n        spi_gpio-&gt;bitbang.txrx_word[SPI_MODE_1] = spi_gpio_spec_txrx_word_mode1;\n        spi_gpio-&gt;bitbang.txrx_word[SPI_MODE_2] = spi_gpio_spec_txrx_word_mode2;\n        spi_gpio-&gt;bitbang.txrx_word[SPI_MODE_3] = spi_gpio_spec_txrx_word_mode3;\n    }\n    spi_gpio-&gt;bitbang.setup_transfer = spi_bitbang_setup_transfer;\n    spi_gpio-&gt;bitbang.flags = SPI_CS_HIGH;\n\n    status = spi_bitbang_start(&amp;spi_gpio-&gt;bitbang);\n</code></pre>"},{"location":"11_SPI/25_1/#2-spi_bitbang_start","title":"2. spi_bitbang_start","text":"<pre><code>    if (master-&gt;transfer || master-&gt;transfer_one_message)\n        return -EINVAL;\n\n    master-&gt;prepare_transfer_hardware = spi_bitbang_prepare_hardware;\n    master-&gt;unprepare_transfer_hardware = spi_bitbang_unprepare_hardware;\n    master-&gt;transfer_one = spi_bitbang_transfer_one;\n    master-&gt;set_cs = spi_bitbang_set_cs;\n\n    if (!bitbang-&gt;txrx_bufs) {\n        bitbang-&gt;use_dma = 0;\n        bitbang-&gt;txrx_bufs = spi_bitbang_bufs;\n        if (!master-&gt;setup) {\n            if (!bitbang-&gt;setup_transfer)\n                bitbang-&gt;setup_transfer =\n                     spi_bitbang_setup_transfer;\n            master-&gt;setup = spi_bitbang_setup;\n            master-&gt;cleanup = spi_bitbang_cleanup;\n        }\n    }\n\n    ret = spi_register_master(spi_master_get(master));\n</code></pre>"},{"location":"11_SPI/25_1/#3-spi_register_master","title":"3. spi_register_master","text":"<pre><code>    status = of_spi_register_master(master);\n\n    /* If we're using a queued driver, start the queue */\n    if (master-&gt;transfer)\n        dev_info(dev, \"master is unqueued, this is deprecated\\n\");\n    else {\n        status = spi_master_initialize_queue(master);\n        if (status) {\n            device_del(&amp;master-&gt;dev);\n            goto done;\n        }\n    }\n</code></pre>"},{"location":"11_SPI/25_1/#4-spi_master_initialize_queue","title":"4. spi_master_initialize_queue","text":"<pre><code>static int spi_master_initialize_queue(struct spi_master *master)\n{\n    int ret;\n\n    master-&gt;transfer = spi_queued_transfer;\n    if (!master-&gt;transfer_one_message)\n        master-&gt;transfer_one_message = spi_transfer_one_message;\n\n    /* Initialize and start queue */\n    ret = spi_init_queue(master);\n    if (ret) {\n        dev_err(&amp;master-&gt;dev, \"problem initializing queue\\n\");\n        goto err_init_queue;\n    }\n    master-&gt;queued = true;\n    ret = spi_start_queue(master);\n    if (ret) {\n        dev_err(&amp;master-&gt;dev, \"problem starting queue\\n\");\n        goto err_start_queue;\n    }\n\n    return 0;\n\nerr_start_queue:\n    spi_destroy_queue(master);\nerr_init_queue:\n    return ret;\n}\n</code></pre>"},{"location":"11_SPI/25_1/#5-spi_init_queue","title":"5. spi_init_queue","text":"<pre><code>    kthread_init_worker(&amp;master-&gt;kworker);\n    master-&gt;kworker_task = kthread_run(kthread_worker_fn,\n                       &amp;master-&gt;kworker, \"%s\",\n                       dev_name(&amp;master-&gt;dev));\n\n    kthread_init_work(&amp;master-&gt;pump_messages, spi_pump_messages);\n</code></pre>"},{"location":"11_SPI/25_1/#6-spi_start_queue","title":"6. spi_start_queue","text":"<pre><code>    kthread_queue_work(&amp;master-&gt;kworker, &amp;master-&gt;pump_messages);\n</code></pre>"},{"location":"11_SPI/25_1/#7-spi","title":"7. SPI\u200b\u4f20\u8f93","text":"<pre><code>spi_sync\n    __spi_sync\n        message-&gt;complete = spi_complete;\n\n        if (master-&gt;transfer == spi_queued_transfer) {\n            status = __spi_queued_transfer(spi, message, false);\n                list_add_tail(&amp;msg-&gt;queue, &amp;master-&gt;queue);\n            __spi_pump_messages(master, false);            \n                kthread_queue_work(&amp;master-&gt;kworker,\n                           &amp;master-&gt;pump_messages);\n                    spi_pump_messages\n                        __spi_pump_messages(master, true);\n                            ret = master-&gt;transfer_one_message(master, master-&gt;cur_msg);\n                                spi_transfer_one_message\n                                    spi_set_cs(msg-&gt;spi, true);\n                                    reinit_completion(&amp;master-&gt;xfer_completion);\n                                    ret = master-&gt;transfer_one(master, msg-&gt;spi, xfer);\n                                            spi_bitbang_transfer_one\n                                                status = bitbang-&gt;txrx_bufs(spi, transfer);\n                                                    spi_bitbang_bufs\n                                    ms = wait_for_completion_timeout(&amp;master-&gt;xfer_completion,\n                                                     msecs_to_jiffies(ms));                                                         spi_finalize_current_message(master);\n            wait_for_completion(&amp;done);            \n        } else {\n            status = spi_async_locked(spi, message);\n                __spi_async\n                    return master-&gt;transfer(spi, message);\n        }\n</code></pre>"},{"location":"11_SPI/25_1/#8-spi_bitbang_bufs","title":"8. spi_bitbang_bufs","text":"<pre><code>    return cs-&gt;txrx_bufs(spi, cs-&gt;txrx_word, nsecs, t);\n</code></pre>"},{"location":"11_SPI/25_1/#9-bitbang_txrx_16","title":"9. bitbang_txrx_16","text":"<p>\u200b\u4e0a\u200b\u56fe\u91cc\u200b\u7684\u200btxrx_word\u200b\u6765\u81ea\u200b\u54ea\u91cc\u200b\uff1fspi_master\u200b\u5728\u200b\u4f20\u8f93\u200bspi_transfer\u200b\u4e4b\u524d\u200b\u8981\u200b\u8bbe\u7f6e\u200b\u3002</p> <p>\u200b\u5bf9\u4e8e\u200bSPI GPIO\uff1a</p> <p></p> <p>\u200b\u5bf9\u4e8e\u200bIMX\uff1a</p> <p></p>"},{"location":"12_USB/01_1/","title":"USB\u200b\u89c6\u9891\u200b\u4ecb\u7ecd\u200b\u53ca\u200b\u8d44\u6599\u200b\u4e0b\u8f7d","text":""},{"location":"12_USB/01_1/#1","title":"1. \u200b\u8d44\u6599\u200b\u4e0b\u8f7d","text":"<p>GIT\u200b\u4ed3\u5e93\u200b\uff1a</p> <pre><code>https://e.coding.net/weidongshan/linux/doc_and_source_for_drivers.git\n</code></pre> <p>\u200b\u6ce8\u610f\u200b\uff1a\u200b\u4e0a\u8ff0\u200b\u94fe\u63a5\u200b\u65e0\u6cd5\u200b\u7528\u200b\u6d4f\u89c8\u5668\u200b\u6253\u5f00\u200b\uff0c\u200b\u5fc5\u987b\u200b\u4f7f\u7528\u200bGIT\u200b\u547d\u4ee4\u200b\u6765\u200b\u514b\u9686\u200b\u3002</p> <p>GIT\u200b\u7b80\u660e\u200b\u6559\u7a0b\u200b\uff1ahttp://download.100ask.org/tools/Software/git/how_to_use_git.html</p> <p>\u200b\u4e0b\u8f7d\u200b\u5230\u200bGIT\u200b\u4ed3\u5e93\u200b\u540e\u200b\uff0cUSB\u200b\u8d44\u6599\u200b\u5728\u200b\u91cc\u9762\u200b\uff1a</p> <p></p>"},{"location":"12_USB/01_1/#2-usb","title":"2. USB\u200b\u89c6\u9891\u200b\u6d89\u53ca\u200b\u7684\u200b\u5185\u5bb9","text":"<ul> <li>\u200b\u5fc5\u987b\u200b\u638c\u63e1\u200b\u7684\u200b\u6982\u5ff5\u200b</li> <li>\u200b\u786c\u4ef6\u200b\u6846\u67b6\u200b\u3001\u200b\u8f6f\u4ef6\u200b\u6846\u67b6\u200b</li> <li>USB\u200b\u8bbe\u5907\u200b\u8bc6\u522b\u200b\u8fc7\u7a0b\u200b</li> <li>\u200b\u63cf\u8ff0\u7b26\u200b\u7b49\u200b\u6982\u5ff5\u200b</li> <li>APP\u200b\u5f00\u53d1\u200b</li> <li>libusb\u200b\u63a5\u53e3\u51fd\u6570\u200b</li> <li> <p>\u200b\u7f16\u5199\u200bAPP\u200b\u64cd\u4f5c\u200bUSB\u200b\u8bbe\u5907\u200b</p> </li> <li> <p>USB\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b</p> </li> <li>\u200b\u64cd\u4f5c\u200bUSB\u200b\u8bbe\u5907\u200b\u7684\u200b\u5185\u6838\u200b\u63a5\u53e3\u51fd\u6570\u200b</li> <li>\u200b\u7f16\u5199\u200bUSB\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</li> <li>USB\u200b\u6444\u50cf\u5934\u200b\u7684\u200b\u7f16\u7a0b\u200b</li> <li>USB Audio Class \u200b\u8bb2\u8bb2\u200b\u5c31\u200b\u66f4\u597d\u200b\u4e86\u200b(\u200b\u7559\u200b\u5230\u200bALSA\u200b\u90e8\u5206\u200b\u8bb2\u200b)</li> <li>USB\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b</li> <li>USB\u200b\u8bbe\u5907\u200b\u7684\u200b\u679a\u4e3e\u200b\u8fc7\u7a0b\u200b<ul> <li>usb\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\u7684\u200b\u62d3\u6251\u200b\uff08\u200b\u547d\u540d\u200b\uff09</li> <li>usb \u200b\u679a\u4e3e\u200b(\u200b\u5916\u63a5\u200bhub)\uff0c\u200b\u7ed3\u5408\u200b\u786c\u4ef6\u200b\u7535\u8def\u56fe\u200b\u6765\u200b\u8bf4\u660e\u200b</li> </ul> </li> <li>USB\u200b\u8bbe\u5907\u200b\u7684\u200b\u8bfb\u5199\u200b\u6d41\u7a0b\u200b</li> <li>OTG</li> <li>type c\u200b\u786c\u4ef6\u200b\u63a5\u53e3\u200b\u3001micro usb\u200b\u786c\u4ef6\u200b\u63a5\u53e3\u200b</li> <li>OTG\u200b\u89d2\u8272\u200b\u89e6\u53d1\u200b\u8fc7\u7a0b\u200b</li> <li>OTG\u200b\u786c\u4ef6\u200b\u8c03\u8bd5\u200b\u7ecf\u9a8c\u200b</li> <li>OTG\u200b\u4f7f\u7528\u200b</li> <li>Gadget</li> <li>function\u200b\u548c\u200bcomposite\u200b\u600e\u4e48\u200b\u8054\u7cfb\u200b\u8d77\u6765\u200b\u7684\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u7ed3\u5408\u200bzero.c\u200b\u90a3\u4e2a\u200b\u9a71\u52a8\u200b\u8bb2\u8bb2\u200b</li> <li>Gadget\u200b\u7684\u200b\u51e0\u4e2a\u200b\u4f7f\u7528\u200b\u793a\u4f8b\u200b</li> </ul>"},{"location":"12_USB/02_1/","title":"USB\u200b\u7cfb\u7edf\u200b\u786c\u4ef6\u200b\u6846\u67b6\u200b\u548c\u200b\u8f6f\u4ef6\u200b\u6846\u67b6","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u300a\u200b\u5708\u5708\u200b\u6559\u200b\u4f60\u200b\u73a9\u200bUSB\u300b</li> <li>\u200b\u5b98\u7f51\u200b\uff1ahttps://www.usb.org/documents </li> <li>\u200b\u4ece\u200b\u5b98\u7f51\u200b\u4e0b\u8f7d\u200b\u540e\u200b\u89e3\u538b\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u5982\u4e0b\u200b\u6587\u4ef6\u200b(\u200b\u653e\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\u4e86\u200b)   </li> </ul>"},{"location":"12_USB/02_1/#1","title":"1. \u200b\u5b9e\u9a8c\u200b\u73b0\u8c61","text":"<p>\u200b\u73b0\u8c61\u200b\uff1a\u200b\u628a\u200bUSB\u200b\u8bbe\u5907\u200b\u6bd4\u5982\u200bAndroid\u200b\u624b\u673a\u200b\u63a5\u5230\u200bPC</p> <ul> <li>\u200b\u53f3\u4e0b\u89d2\u200b\u5f39\u200b\u51fa\u200b\"\u200b\u53d1\u73b0\u200bandroid phone\"</li> <li>\u200b\u8df3\u51fa\u200b\u4e00\u4e2a\u200b\u5bf9\u8bdd\u6846\u200b\uff0c\u200b\u63d0\u793a\u200b\u4f60\u200b\u5b89\u88c5\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</li> </ul> <p>\u200b\u95ee\u200b1\uff1aUSB\u200b\u8bbe\u5907\u200b\u63d2\u200b\u5230\u200b\u7535\u8111\u200b\u4e0a\u53bb\u200b\uff0c\u200b\u63a5\u89e6\u200b\u5230\u200b\u7684\u200b\u5bf9\u65b9\u200b\u8bbe\u5907\u200b\u662f\u200b\u4ec0\u4e48\u200b\uff1f</p> <p>\u200b\u7b54\u200b1\uff1a\u200b\u662f\u200bUSB\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u662f\u200bUSB\u200b\u63a7\u5236\u5668\u200b\u5185\u5d4c\u200b\u7684\u200broot hub</p> <p>\u200b\u95ee\u200b2. \u200b\u65e2\u7136\u200b\u8fd8\u200b\u6ca1\u6709\u200b\"\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\"\uff0c\u200b\u4e3a\u4f55\u200b\u80fd\u200b\u77e5\u9053\u200b\u662f\u200b\"android phone\" \u200b\u7b54\u200b2. windows\u200b\u91cc\u200b\u5df2\u7ecf\u200b\u6709\u200b\u4e86\u200bUSB\u200b\u7684\u200b\u603b\u7ebf\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u63a5\u5165\u200bUSB\u200b\u8bbe\u5907\u200b\u540e\u200b\uff0c\u200b\u662f\u200b\"\u200b\u603b\u7ebf\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\"\u200b\u77e5\u9053\u200b\u4f60\u200b\u662f\u200b\"android phone\"      \u200b\u63d0\u793a\u200b\u4f60\u200b\u5b89\u88c5\u200b\u7684\u200b\u662f\u200b\"\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\"\u3002 USB\u200b\u603b\u7ebf\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u8d1f\u8d23\u200b\uff1a\u200b\u8bc6\u522b\u200bUSB\u200b\u8bbe\u5907\u200b, \u200b\u7ed9\u200bUSB\u200b\u8bbe\u5907\u200b\u627e\u5230\u200b\u5bf9\u5e94\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b</p> <p>\u200b    </p> <p>\u200b\u95ee\u200b3. \u200b\u4e3a\u4ec0\u4e48\u200b\u4e00\u200b\u63a5\u5165\u200bUSB\u200b\u8bbe\u5907\u200b\uff0cPC\u200b\u673a\u5c31\u80fd\u200b\u53d1\u73b0\u200b\u5b83\u200b\uff1f \u200b\u7b54\u200b3. PC\u200b\u7684\u200bUSB\u200b\u53e3\u200b\u5185\u90e8\u200b\uff0cD-\u200b\u548c\u200bD+\u200b\u63a5\u200b\u6709\u200b15K\u200b\u7684\u200b\u4e0b\u200b\u62c9\u200b\u7535\u963b\u200b\uff0c\u200b\u672a\u63a5\u200bUSB\u200b\u8bbe\u5907\u200b\u65f6\u4e3a\u200b\u4f4e\u7535\u5e73\u200b      USB\u200b\u8bbe\u5907\u200b\u7684\u200bUSB\u200b\u53e3\u200b\u5185\u90e8\u200b\uff0cD-\u200b\u6216\u200bD+\u200b\u63a5\u200b\u6709\u200b1.5K\u200b\u7684\u200b\u4e0a\u200b\u62c9\u200b\u7535\u963b\u200b\uff1b\u200b\u5b83\u200b\u4e00\u200b\u63a5\u5165\u200bPC\uff0c\u200b\u5c31\u200b\u4f1a\u200b\u628a\u200bPC USB\u200b\u53e3\u200b\u7684\u200bD-\u200b\u6216\u200bD+\u200b\u62c9\u9ad8\u200b\uff0c\u200b\u4ece\u200b\u786c\u4ef6\u200b\u7684\u200b\u89d2\u5ea6\u200b\u901a\u77e5\u200bPC\u200b\u6709\u200b\u65b0\u200b\u8bbe\u5907\u200b\u63a5\u5165\u200b\u3002</p> <p>\u200b\u95ee\u200b4. USB\u200b\u8bbe\u5907\u200b\u79cd\u7c7b\u200b\u975e\u5e38\u200b\u591a\u200b\uff0c\u200b\u4e3a\u4ec0\u4e48\u200b\u4e00\u200b\u63a5\u5165\u200b\u7535\u8111\u200b\uff0c\u200b\u5c31\u200b\u80fd\u200b\u8bc6\u522b\u200b\u51fa\u6765\u200b\u5b83\u200b\u7684\u200b\u79cd\u7c7b\u200b\uff1f \u200b\u7b54\u200b4. PC\u200b\u548c\u200bUSB\u200b\u8bbe\u5907\u200b\u90fd\u200b\u5f97\u200b\u9075\u5b88\u200b\u4e00\u4e9b\u200b\u89c4\u8303\u200b\u3002\u200b\u6bd4\u5982\u200b\uff1aUSB\u200b\u8bbe\u5907\u200b\u63a5\u5165\u200b\u7535\u8111\u200b\u540e\u200b\uff0cPC\u200b\u673a\u4f1a\u200b\u53d1\u51fa\u200b\"\u200b\u4f60\u200b\u662f\u200b\u4ec0\u4e48\u200b\"\uff1fUSB\u200b\u8bbe\u5907\u200b\u5c31\u200b\u5fc5\u987b\u200b\u56de\u7b54\u200b\"\u200b\u6211\u200b\u662f\u200bxxx\", \u200b\u5e76\u4e14\u200b\u56de\u7b54\u200b\u7684\u200b\u683c\u5f0f\u200b\u662f\u200b\u56fa\u5b9a\u200b\u7684\u200b\u3002USB\u200b\u603b\u7ebf\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4f1a\u200b\u53d1\u51fa\u200b\u67d0\u4e9b\u200b\u547d\u4ee4\u200b\u60f3\u200b\u83b7\u53d6\u200b\u8bbe\u5907\u200b\u4fe1\u606f\u200b(\u200b\u63cf\u8ff0\u7b26\u200b)\uff0cUSB\u200b\u8bbe\u5907\u200b\u5fc5\u987b\u200b\u8fd4\u56de\u200b\"\u200b\u63cf\u8ff0\u7b26\u200b\"\u200b\u7ed9\u200bPC\u3002</p> <p>\u200b\u95ee\u200b5. PC\u200b\u673a\u4e0a\u200b\u63a5\u200b\u6709\u200b\u975e\u5e38\u200b\u591a\u200b\u7684\u200bUSB\u200b\u8bbe\u5907\u200b\uff0c\u200b\u600e\u4e48\u200b\u5206\u8fa8\u200b\u5b83\u4eec\u200b\uff1f \u200b\u7b54\u200b5. \u200b\u6bcf\u200b\u4e00\u4e2a\u200bUSB\u200b\u8bbe\u5907\u200b\u63a5\u5165\u200bPC\u200b\u65f6\u200b\uff0cUSB\u200b\u603b\u7ebf\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u90fd\u200b\u4f1a\u200b\u7ed9\u200b\u5b83\u200b\u5206\u914d\u200b\u4e00\u4e2a\u200b\u7f16\u53f7\u200b\u3002PC\u200b\u673a\u60f3\u200b\u8bbf\u95ee\u200b\u67d0\u4e2a\u200bUSB\u200b\u8bbe\u5907\u200b\u65f6\u200b\uff0c\u200b\u53d1\u51fa\u200b\u7684\u200b\u547d\u4ee4\u200b\u90fd\u200b\u542b\u6709\u200b\u5bf9\u5e94\u200b\u7684\u200b\u7f16\u53f7\u200b(\u200b\u5730\u5740\u200b)\u3002</p> <p>\u200b\u95ee\u200b6. USB\u200b\u8bbe\u5907\u200b\u521a\u200b\u63a5\u5165\u200bPC\u200b\u65f6\u200b\uff0c\u200b\u8fd8\u200b\u6ca1\u6709\u200b\u7f16\u53f7\u200b\uff1b\u200b\u90a3\u4e48\u200bPC\u200b\u600e\u4e48\u200b\u628a\u200b\"\u200b\u5206\u914d\u200b\u7684\u200b\u7f16\u53f7\u200b\"\u200b\u544a\u8bc9\u200b\u5b83\u200b\uff1f \u200b\u7b54\u200b6. \u200b\u65b0\u200b\u63a5\u5165\u200b\u7684\u200bUSB\u200b\u8bbe\u5907\u200b\u7684\u200b\u9ed8\u8ba4\u200b\u7f16\u53f7\u200b\u662f\u200b0\uff0c\u200b\u5728\u200b\u672a\u200b\u5206\u914d\u200b\u65b0\u200b\u7f16\u53f7\u200b\u524d\u200b\uff0cPC\u200b\u4f7f\u7528\u200b0\u200b\u7f16\u53f7\u200b\u548c\u200b\u5b83\u200b\u901a\u4fe1\u200b\u3002</p>"},{"location":"12_USB/02_1/#2","title":"2. \u200b\u786c\u4ef6\u200b\u6846\u67b6","text":"<p>\u200b\u5728\u200bUSB\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\uff0c\u200b\u6709\u200b2\u200b\u4e2a\u200b\u786c\u4ef6\u200b\u6982\u5ff5\u200b\uff1a</p> <ul> <li>USB Host\uff1a\u200b\u5b83\u200b\u8ddf\u200b\u5904\u7406\u5668\u200b\u76f8\u8fde\u200b\uff0c\u200b\u5904\u7406\u5668\u200b\u901a\u8fc7\u200bUSB Host\u200b\u8ddf\u200b\u5404\u7c7b\u200bUSB\u200b\u8bbe\u5907\u200b\u901a\u4fe1\u200b\u3002USB Host\u200b\u4e2d\u200b\u96c6\u6210\u200b\u6709\u200b\u4e00\u4e2a\u200broot hub</li> <li>USB Device\uff1a\u200b\u8fd9\u200b\u5206\u4e3a\u200b\u4e24\u7c7b\u200b\u8bbe\u5907\u200b</li> <li>Hub\uff1a\u200b\u7528\u6765\u200b\u6269\u5c55\u200bUSB\u200b\u63a5\u53e3\u200b</li> <li>Function\uff1a\u200b\u5c31\u662f\u200b\u666e\u901a\u200b\u7684\u200bUSB\u200b\u8bbe\u5907\u200b\uff0c\u200b\u6bd4\u5982\u200bU\u200b\u76d8\u200b\u3001\u200b\u58f0\u5361\u200b\u7b49\u200b</li> </ul> <p></p>"},{"location":"12_USB/02_1/#3","title":"3. \u200b\u8f6f\u4ef6\u200b\u6846\u67b6","text":"<p>APP\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200bUSB\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u8bbf\u95ee\u200bUSB\u200b\u8bbe\u5907\u200b\uff0c \u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u7ed5\u8fc7\u200bUSB\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\uff0c\u200b\u76f4\u63a5\u200b\u901a\u8fc7\u200bUSB\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u8bbf\u95ee\u200bUSB\u200b\u8bbe\u5907\u200b\u3002</p>"},{"location":"12_USB/03_1/","title":"\u8f6f\u4ef6\u200b\u5de5\u7a0b\u5e08\u200b\u773c\u91cc\u200b\u7684\u200bUSB\u200b\u7535\u6c14\u200b\u4fe1\u53f7","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u300a\u200b\u5708\u5708\u200b\u6559\u200b\u4f60\u200b\u73a9\u200bUSB\u300b</li> <li>\u200b\u7b80\u4e66\u200bjianshu_kevin@126.com\u200b\u7684\u200b\u6587\u7ae0\u200b</li> <li>USB\u200b\u534f\u8bae\u200b\uff08\u200b\u4e00\u200b\uff09</li> <li>USB\u200b\u534f\u8bae\u200b(\u200b\u4e8c\u200b)</li> <li>USB\u200b\u534f\u8bae\u200b(\u200b\u4e09\u200b)</li> <li>\u200b\u5b98\u7f51\u200b\uff1ahttps://www.usb.org/documents </li> <li>\u300ausb_20.pdf\u300b\u200b\u7684\u200b\u300aChapter 7 Electrical\u300b</li> <li>USB\u200b\u7684\u200bNRZI\u200b\u4fe1\u53f7\u200b\u683c\u5f0f\u200b\uff1ahttps://zhuanlan.zhihu.com/p/460018993</li> <li>USB2.0\u200b\u5305\u200bPacket\u200b\u7684\u200b\u7ec4\u6210\u200b\uff1ahttps://www.usbzh.com/article/detail-459.html</li> </ul>"},{"location":"12_USB/03_1/#1","title":"1. \u200b\u5b66\u4e60\u200b\u7684\u200b\u8d77\u70b9","text":"<p>USB 2.0\u200b\u534f\u8bae\u200b\u652f\u6301\u200b3\u200b\u79cd\u200b\u901f\u7387\u200b\uff1a\u200b\u4f4e\u901f\u200b(Low Speed\uff0c1.5Mbps)\u3001\u200b\u5168\u901f\u200b(Full Speed, 12Mbps)\u3001\u200b\u9ad8\u901f\u200b(High Speed, 480Mbps)\u3002</p> <p>USB Hub\u3001USB\u200b\u8bbe\u5907\u200b\uff0c\u200b\u4e5f\u200b\u5206\u4e3a\u200b\u4f4e\u901f\u200b\u3001\u200b\u5168\u901f\u200b\u3001\u200b\u9ad8\u901f\u200b\u4e09\u79cd\u200b\u7c7b\u578b\u200b\u3002\u200b\u4e00\u4e2a\u200bUSB\u200b\u8bbe\u5907\u200b\uff0c\u200b\u53ef\u80fd\u200b\u517c\u5bb9\u200b\u4f4e\u901f\u200b\u3001\u200b\u5168\u901f\u200b\uff0c\u200b\u53ef\u80fd\u200b\u517c\u5bb9\u200b\u5168\u901f\u200b\u3001\u200b\u9ad8\u901f\u200b\uff0c\u200b\u4f46\u662f\u200b\u4e0d\u4f1a\u200b\u540c\u65f6\u200b\u517c\u5bb9\u200b\u4f4e\u901f\u200b\u3001\u200b\u9ad8\u901f\u200b\u3002</p>"},{"location":"12_USB/03_1/#11-usb","title":"1.1 USB\u200b\u8bbe\u5907\u200b\u72b6\u6001\u200b\u5207\u6362\u200b\u56fe","text":""},{"location":"12_USB/03_1/#12","title":"1.2 \u200b\u786c\u4ef6\u200b\u7ebf\u8def","text":"<p>\u200b\u4e0b\u56fe\u200b\u662f\u200b\u517c\u5bb9\u200b\u9ad8\u901f\u200b\u6a21\u5f0f\u200b\u7684\u200bUSB\u200b\u6536\u53d1\u5668\u200b\u7535\u8def\u56fe\u200b\uff1a</p> <p></p> <p>USB\u200b\u8fde\u63a5\u200b\u6d89\u53ca\u200bHub Port\u200b\u548c\u200bUSB\u200b\u8bbe\u5907\u200b\uff0c\u200b\u786c\u4ef6\u200b\u8fde\u63a5\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"12_USB/03_1/#2","title":"2. \u200b\u7535\u5b50\u200b\u4fe1\u53f7","text":"<p>USB\u200b\u8fde\u63a5\u7ebf\u200b\u6709\u200b4\u200b\u6761\u200b\uff1a5V\u3001D+\u3001D-\u3001GND\u3002\u200b\u6570\u636e\u7ebf\u200bD+\u3001D-\uff0c\u200b\u53ea\u80fd\u200b\u8868\u793a\u200b4\u200b\u79cd\u200b\u72b6\u6001\u200b\u3002USB\u200b\u534f\u8bae\u200b\u4e2d\u200b\uff0c\u200b\u5f88\u200b\u5de7\u5999\u200b\u5730\u200b\u4f7f\u7528\u200b\u8fd9\u200b\u4e24\u6761\u200b\u7ebf\u8def\u200b\u5b9e\u73b0\u200b\u4e86\u200b\u7a7a\u95f2\u200b(Idle)\u3001\u200b\u5f00\u59cb\u200b(SOP)\u3001\u200b\u4f20\u8f93\u6570\u636e\u200b(Data)\u3001\u200b\u7ed3\u675f\u200b(EOP)\u200b\u7b49\u200b\u529f\u80fd\u200b\u3002</p>"},{"location":"12_USB/03_1/#21","title":"2.1 \u200b\u4f4e\u901f\u200b/\u200b\u5168\u901f\u200b\u4fe1\u53f7\u200b\u7535\u5e73","text":""},{"location":"12_USB/03_1/#22","title":"2.2 \u200b\u9ad8\u901f\u200b\u4fe1\u53f7\u200b\u7535\u5e73","text":""},{"location":"12_USB/03_1/#23","title":"2.3 \u200b\u8bbe\u5907\u200b\u8fde\u63a5\u200b\u4e0e\u200b\u65ad\u5f00","text":""},{"location":"12_USB/03_1/#231","title":"2.3.1 \u200b\u8fde\u63a5","text":"<p>Hub\u200b\u7aef\u53e3\u200b\u7684\u200bD+\u3001D-\u200b\u90fd\u200b\u6709\u200b15K\u200b\u7684\u200b\u4e0b\u200b\u62c9\u200b\u7535\u963b\u200b\uff0c\u200b\u5e73\u65f6\u200b\u4e3a\u200b\u4f4e\u7535\u5e73\u200b\u3002\u200b\u5168\u901f\u200b\u8bbe\u5907\u200b\u5185\u90e8\u200b\u7684\u200bD+\u200b\u6709\u200b1.5K\u200b\u7684\u200b\u4e0a\u200b\u62c9\u200b\u7535\u963b\u200b\uff0c\u200b\u4f4e\u901f\u200b\u8bbe\u5907\u200b\u5185\u90e8\u200b\u7684\u200bD-\u200b\u6709\u200b1.5K\u200b\u7684\u200b\u4e0a\u200b\u62c9\u200b\u7535\u963b\u200b\uff0c\u200b\u8fde\u63a5\u200b\u5230\u200bHub\u200b\u540e\u200b\u4f1a\u200b\u5bfc\u81f4\u200bHub\u200b\u7684\u200bD+\u200b\u6216\u200bD-\u200b\u7535\u5e73\u200b\u53d8\u5316\u200b\uff0cHub\u200b\u6839\u636e\u200b\u53d8\u5316\u200b\u7684\u200b\u5f15\u811a\u200b\u5206\u8fa8\u200b\u63a5\u8fdb\u6765\u200b\u7684\u200b\u662f\u200b\u5168\u901f\u200b\u8bbe\u5907\u200b\u8fd8\u662f\u200b\u4f4e\u901f\u200b\u8bbe\u5907\u200b\u3002</p> <p>\u200b\u9ad8\u901f\u200b\u8bbe\u5907\u200b\u4e00\u200b\u5f00\u59cb\u200b\u4e5f\u200b\u662f\u200b\u4f5c\u4e3a\u200b\u5168\u901f\u200b\u8bbe\u5907\u200b\u88ab\u200b\u8bc6\u522b\u200b\u7684\u200b\u3002</p> <p>\u200b\u5168\u901f\u200b\u8bbe\u5907\u200b\u3001\u200b\u9ad8\u901f\u200b\u8bbe\u5907\u200b\u8fde\u63a5\u200b\u65f6\u200b\uff0cD+\u200b\u5f15\u811a\u200b\u7684\u200b\u7535\u5e73\u200b\u7531\u200b\u4f4e\u200b\u53d8\u9ad8\u200b\uff1a</p> <p></p> <p>\u200b\u4f4e\u901f\u200b\u8bbe\u5907\u200b\u8fde\u63a5\u200b\u65f6\u200b\uff0cD-\u200b\u5f15\u811a\u200b\u7684\u200b\u7535\u5e73\u200b\u7531\u200b\u4f4e\u200b\u53d8\u9ad8\u200b\uff1a</p> <p></p>"},{"location":"12_USB/03_1/#232","title":"2.3.2 \u200b\u65ad\u5f00","text":"<p>\u200b\u5bf9\u4e8e\u200b\u4f4e\u901f\u200b\u3001\u200b\u5168\u901f\u200b\u8bbe\u5907\u200b\uff0c\u200b\u63a5\u5230\u200bHub\u200b\u65f6\u200b\u5bfc\u81f4\u200bD-\u200b\u6216\u200bD+\u200b\u5f15\u811a\u200b\u53d8\u4e3a\u200b\u9ad8\u7535\u5e73\u200b\uff0c\u200b\u65ad\u5f00\u200b\u8bbe\u5907\u200b\u540e\u200b\uff0cD-\u200b\u6216\u200bD+\u200b\u5f15\u811a\u200b\u53d8\u4e3a\u200b\u4f4e\u7535\u5e73\u200b\uff1a</p> <p></p> <p>\u200b\u5bf9\u4e8e\u200b\u9ad8\u901f\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5b83\u200b\u5148\u200b\u4f5c\u4e3a\u200b\u5168\u901f\u200b\u8bbe\u5907\u200b\u88ab\u200b\u8bc6\u522b\u200b\u51fa\u6765\u200b\uff0c\u200b\u7136\u540e\u200b\u518d\u200b\u88ab\u200b\u8bc6\u522b\u200b\u4e3a\u200b\u9ad8\u901f\u200b\u8bbe\u5907\u200b\u3002\u200b\u5de5\u4f5c\u200b\u4e8e\u200b\u9ad8\u901f\u200b\u6a21\u5f0f\u200b\u65f6\u200b\uff0cD+\u200b\u7684\u200b\u4e0a\u200b\u62c9\u200b\u7535\u963b\u200b\u662f\u200b\u65ad\u5f00\u200b\u7684\u200b\uff0c\u200b\u6240\u4ee5\u200b\u5bf9\u4e8e\u200b\u5de5\u4f5c\u200b\u4e8e\u200b\u9ad8\u901f\u200b\u6a21\u5f0f\u200b\u7684\u200bUSB\u200b\u8bbe\u5907\u200b\uff0c\u200b\u65e0\u6cd5\u200b\u901a\u8fc7\u200bD+\u200b\u7684\u200b\u5f15\u811a\u200b\u7535\u5e73\u200b\u53d8\u5316\u200b\u76d1\u6d4b\u200b\u5230\u200b\u5b83\u200b\u5df2\u7ecf\u200b\u65ad\u5f00\u200b\u3002</p> <p>\u200b\u5de5\u4f5c\u200b\u4e8e\u200b\u9ad8\u901f\u200b\u6a21\u5f0f\u200b\u7684\u200b\u8bbe\u5907\u200b\uff0cD+\u3001D-\u200b\u4e24\u8fb9\u200b\u6709\u200b45\u200b\u6b27\u59c6\u200b\u7684\u200b\u4e0b\u200b\u62c9\u200b\u7535\u963b\u200b\uff0c\u200b\u7528\u6765\u200b\u6d88\u9664\u200b\u53cd\u5c04\u200b\u4fe1\u53f7\u200b\uff1a</p> <p></p> <p>\u200b\u5f53\u200b\u65ad\u5f00\u200b\u9ad8\u901f\u200b\u8bbe\u5907\u200b\u540e\u200b\uff0cHub\u200b\u53d1\u51fa\u4fe1\u53f7\u200b\uff0c\u200b\u5f97\u5230\u200b\u7684\u200b\u53cd\u5c04\u200b\u4fe1\u53f7\u200b\u65e0\u6cd5\u200b\u8870\u51cf\u200b\uff0cHub\u200b\u76d1\u6d4b\u200b\u5230\u200b\u8fd9\u4e9b\u200b\u4fe1\u53f7\u200b\u540e\u200b\u5c31\u200b\u77e5\u9053\u200b\u9ad8\u901f\u200b\u8bbe\u5907\u200b\u5df2\u7ecf\u200b\u65ad\u5f00\u200b\uff0c\u200b\u5185\u90e8\u200b\u7535\u8def\u56fe\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"12_USB/03_1/#24","title":"2.4 \u200b\u590d\u4f4d","text":"<p>\u200b\u4ece\u200b\u72b6\u6001\u200b\u5207\u6362\u200b\u56fe\u4e0a\u200b\u770b\u200b\uff0c\u200b\u4e00\u4e2a\u200bUSB\u200b\u8bbe\u5907\u200b\u8fde\u63a5\u200b\u540e\u200b\uff0c\u200b\u5b83\u200b\u5c06\u200b\u4f1a\u200b\u88ab\u200b\u4f9b\u7535\u200b\uff0c\u200b\u7136\u540e\u200b\u88ab\u200b\u590d\u4f4d\u200b\u3002\u200b\u5f53\u200b\u8f6f\u4ef6\u200b\u51fa\u9519\u200b\u65f6\u200b\uff0c\u200b\u6211\u4eec\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u53d1\u51fa\u200b\u590d\u4f4d\u200b\u4fe1\u53f7\u200b\u91cd\u65b0\u200b\u9a71\u52a8\u200b\u8bbe\u5907\u200b\u3002</p> <p>\u200b\u90a3\u4e48\u200b\uff0cUSB Hub\u200b\u7aef\u53e3\u200b\u6216\u200bUSB\u200b\u63a7\u5236\u5668\u200b\u7aef\u53e3\u200b\u5982\u4f55\u200b\u53d1\u51fa\u200b\u590d\u4f4d\u200b\u4fe1\u53f7\u200b\uff1f\u200b\u53d1\u51fa\u200bSE0\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u5e76\u200b\u7ef4\u6301\u200b\u81f3\u5c11\u200b10ms\u3002</p> <p>USB\u200b\u8bbe\u5907\u200b\u770b\u5230\u200bReset\u200b\u4fe1\u53f7\u200b\u540e\u200b\uff0c\u200b\u9700\u8981\u200b\u51c6\u5907\u200b\u63a5\u6536\u200b\"SetAddress()\"\u200b\u8bf7\u6c42\u200b\uff1b\u200b\u5982\u679c\u200b\u5b83\u200b\u4e0d\u80fd\u200b\u56de\u5e94\u200b\u8fd9\u4e2a\u200b\u8bf7\u6c42\u200b\uff0c\u200b\u5c31\u662f\u200b\"\u200b\u4e0d\u80fd\u200b\u8bc6\u522b\u200b\u7684\u200b\u8bbe\u5907\u200b\"\u3002</p>"},{"location":"12_USB/03_1/#25","title":"2.5 \u200b\u8bbe\u5907\u200b\u901f\u7387\u200b\u8bc6\u522b","text":""},{"location":"12_USB/03_1/#251","title":"2.5.1 \u200b\u4f4e\u901f\u200b/\u200b\u5168\u901f","text":"<p>Hub\u200b\u7aef\u53e3\u200b\u7684\u200bD+\u3001D-\u200b\u90fd\u200b\u6709\u200b15K\u200b\u7684\u200b\u4e0b\u200b\u62c9\u200b\u7535\u963b\u200b\uff0c\u200b\u5e73\u65f6\u200b\u4e3a\u200b\u4f4e\u7535\u5e73\u200b\u3002\u200b\u5168\u901f\u200b\u8bbe\u5907\u200b\u5185\u90e8\u200b\u7684\u200bD+\u200b\u6709\u200b1.5K\u200b\u7684\u200b\u4e0a\u200b\u62c9\u200b\u7535\u963b\u200b\uff0c\u200b\u4f4e\u901f\u200b\u8bbe\u5907\u200b\u5185\u90e8\u200b\u7684\u200bD-\u200b\u6709\u200b1.5K\u200b\u7684\u200b\u4e0a\u200b\u62c9\u200b\u7535\u963b\u200b\uff0c\u200b\u8fde\u63a5\u200b\u5230\u200bHub\u200b\u540e\u200b\u4f1a\u200b\u5bfc\u81f4\u200bHub\u200b\u7684\u200bD+\u200b\u6216\u200bD-\u200b\u7535\u5e73\u200b\u53d8\u5316\u200b\uff0cHub\u200b\u6839\u636e\u200b\u53d8\u5316\u200b\u7684\u200b\u5f15\u811a\u200b\u5206\u8fa8\u200b\u63a5\u8fdb\u6765\u200b\u7684\u200b\u662f\u200b\u5168\u901f\u200b\u8bbe\u5907\u200b\u8fd8\u662f\u200b\u4f4e\u901f\u200b\u8bbe\u5907\u200b\u3002</p> <p></p>"},{"location":"12_USB/03_1/#252","title":"2.5.2 \u200b\u9ad8\u901f","text":"<p>\u200b\u9ad8\u901f\u200b\u8bbe\u5907\u200b\u5fc5\u5b9a\u200b\u517c\u5bb9\u200b\u5168\u901f\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u6240\u4ee5\u200b\u9ad8\u901f\u200b\u8bbe\u5907\u200b\u5185\u90e8\u200bD+\u200b\u4e5f\u200b\u6709\u200b1.5K\u200b\u7684\u200b\u4e0a\u200b\u62c9\u200b\u7535\u963b\u200b\uff0c\u200b\u53ea\u4e0d\u8fc7\u200b\u8fd9\u4e2a\u200b\u7535\u963b\u200b\u662f\u200b\u53ef\u4ee5\u200b\u65ad\u5f00\u200b\u7684\u200b\uff1a\u200b\u5de5\u4f5c\u200b\u4e8e\u200b\u9ad8\u901f\u200b\u6a21\u5f0f\u200b\u65f6\u8981\u200b\u65ad\u5f00\u200b\u5b83\u200b\u3002</p> <p>\u200b\u9ad8\u901f\u200b\u8bbe\u5907\u200b\u9996\u5148\u200b\u4f5c\u4e3a\u200b\u5168\u901f\u200b\u8bbe\u5907\u200b\u88ab\u200b\u8bc6\u522b\u200b\u51fa\u6765\u200b\uff0c\u200b\u7136\u540e\u200bHub\u200b\u5982\u4f55\u200b\u786e\u5b9a\u200b\u5b83\u200b\u662f\u5426\u200b\u652f\u6301\u200b\u9ad8\u901f\u200b\u6a21\u5f0f\u200b\uff1f</p> <p>Hub\u200b\u7aef\u53e3\u200b\u5982\u4f55\u200b\u76d1\u6d4b\u200b\u4e00\u4e2a\u200b\u65b0\u200b\u63d2\u5165\u200b\u7684\u200bUSB\u200b\u8bbe\u5907\u200b\u80fd\u5426\u200b\u5de5\u4f5c\u200b\u4e8e\u200b\u9ad8\u901f\u200b\u6a21\u5f0f\u200b\uff1f\u200b\u6d41\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u5bf9\u4e8e\u200b\u4f4e\u901f\u200b\u8bbe\u5907\u200b\uff0cHub\u200b\u7aef\u53e3\u200b\u4e0d\u4f1a\u200b\u76d1\u6d4b\u200b\u5b83\u200b\u80fd\u5426\u200b\u5de5\u4f5c\u200b\u4e8e\u200b\u9ad8\u901f\u200b\u6a21\u5f0f\u200b\u3002\u200b\u4f4e\u901f\u200b\u8bbe\u5907\u200b\u4e0d\u80fd\u200b\u517c\u5bb9\u200b\u9ad8\u901f\u200b\u6a21\u5f0f\u200b\u3002</li> <li>Hub\u200b\u7aef\u53e3\u200b\u53d1\u51fa\u200bSE0\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u8fd9\u200b\u5c31\u662f\u200b\u590d\u4f4d\u200b\u4fe1\u53f7\u200b</li> <li>USB\u200b\u8bbe\u5907\u200b\u76d1\u6d4b\u200b\u5230\u200bSE0\u200b\u4fe1\u53f7\u200b\u540e\u200b\uff0c\u200b\u4f1a\u200b\u53d1\u51fa\u200b\"a high-speed detection handshake\"\u200b\u4fe1\u53f7\u200b\u8868\u793a\u200b\u81ea\u5df1\u200b\u80fd\u200b\u652f\u6301\u200b\u9ad8\u901f\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u8fd9\u200b\u53ef\u4ee5\u200b\u7ec6\u5206\u200b\u4e3a\u200b\u4e00\u4e0b\u200b3\u200b\u79cd\u200b\u60c5\u666f\u200b</li> <li>\u200b\u5982\u679c\u200bUSB\u200b\u8bbe\u5907\u200b\u539f\u6765\u200b\u5904\u4e8e\u200b\"suspend\"\u200b\u72b6\u6001\u200b\uff0c\u200b\u5b83\u200b\u68c0\u6d4b\u200b\u5230\u200bSE0\u200b\u4fe1\u53f7\u200b\u540e\u200b\uff0c\u200b\u5c31\u200b\u53d1\u51fa\u200b\"a high-speed detection handshake\"\u200b\u4fe1\u53f7\u200b</li> <li>\u200b\u5982\u679c\u200bUSB\u200b\u8bbe\u5907\u200b\u539f\u6765\u200b\u5904\u4e8e\u200b\"non-suspend\"\u200b\u72b6\u6001\u200b\uff0c\u200b\u5e76\u4e14\u200b\u5904\u4e8e\u200b\u5168\u901f\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u5b83\u200b\u68c0\u6d4b\u200b\u5230\u200bSE0\u200b\u4fe1\u53f7\u200b\u540e\u200b\uff0c\u200b\u5c31\u200b\u53d1\u51fa\u200b\"a high-speed detection handshake\"\u200b\u4fe1\u53f7\u200b\u3002\u200b\u8fd9\u4e2a\u200b\u60c5\u666f\u200b\uff0c\u200b\u5c31\u662f\u200b\u4e00\u4e2a\u200b\u8bbe\u5907\u200b\u521a\u200b\u63d2\u200b\u5230\u200bHub\u200b\u7aef\u53e3\u200b\u65f6\u200b\u7684\u200b\u60c5\u51b5\u200b\uff0c\u200b\u5b83\u200b\u4e00\u200b\u5f00\u59cb\u200b\u5de5\u4f5c\u200b\u4e8e\u200b\u5168\u901f\u200b\u6a21\u5f0f\u200b\u3002</li> <li>\u200b\u5982\u679c\u200bUSB\u200b\u8bbe\u5907\u200b\u539f\u6765\u200b\u5904\u4e8e\u200b\"non-suspend\"\u200b\u72b6\u6001\u200b\uff0c\u200b\u5e76\u4e14\u200b\u5904\u4e8e\u200b\u9ad8\u901f\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u5b83\u4f1a\u200b\u5207\u6362\u200b\u56de\u5230\u200b\u5168\u901f\u200b\u6a21\u5f0f\u200b(\u200b\u91cd\u65b0\u200b\u8fde\u63a5\u200bD+\u200b\u7684\u200b\u4e0a\u200b\u62c9\u200b\u7535\u963b\u200b)\uff0c\u200b\u7136\u540e\u200b\u53d1\u51fa\u200b\"a high-speed detection handshake\"\u200b\u4fe1\u53f7\u200b</li> </ul> <p>\"a high-speed detection handshake\"\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u5c31\u662f\u200b\"\u200b\u9ad8\u901f\u200b\u8bbe\u5907\u200b\u76d1\u6d4b\u200b\u63e1\u624b\u200b\u4fe1\u53f7\u200b\"\uff0c\u200b\u65e2\u7136\u200b\u662f\u200b\u63e1\u624b\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u81ea\u7136\u200b\u662f\u200b\u6709\u200b\u6765\u200b\u6709\u200b\u56de\u200b\uff1a</p> <ul> <li>USB\u200b\u8bbe\u5907\u200b\u7ef4\u6301\u200bD+\u200b\u7684\u200b\u4e0a\u200b\u62c9\u200b\u7535\u963b\u200b\uff0c\u200b\u53d1\u51fa\u200b\"Chirp K \"\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u8868\u793a\u200b\u81ea\u5df1\u200b\u80fd\u200b\u652f\u6301\u200b\u9ad8\u901f\u200b\u6a21\u5f0f\u200b</li> <li>\u200b\u5982\u679c\u200bHub\u200b\u6ca1\u200b\u76d1\u6d4b\u200b\u5230\u200b\"Chirp K \"\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u5b83\u200b\u5c31\u200b\u77e5\u9053\u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u4e0d\u200b\u652f\u6301\u200b\u9ad8\u901f\u200b\u6a21\u5f0f\u200b</li> <li>\u200b\u5982\u679c\u200bHub\u200b\u76d1\u6d4b\u200b\u5230\u200b\"Chirp K \"\u200b\u4fe1\u53f7\u200b\u540e\u200b\uff0c\u200b\u5982\u679c\u200bHub\u200b\u80fd\u200b\u652f\u6301\u200b\u9ad8\u901f\u200b\u6a21\u5f0f\u200b\uff0c\u200b\u5c31\u200b\u53d1\u51fa\u200b\u4e00\u7cfb\u5217\u200b\u7684\u200b\"Chirp K\"\u3001\"Chirp J\"\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u8fd9\u662f\u200b\u7528\u6765\u200b\u901a\u77e5\u200bUSB\u200b\u8bbe\u5907\u200b\uff1aHub\u200b\u4e5f\u200b\u80fd\u200b\u652f\u6301\u200b\u9ad8\u901f\u200b\u6a21\u5f0f\u200b\u3002\u200b\u53d1\u51fa\u200b\u4e00\u7cfb\u5217\u200b\u7684\u200b\"Chirp K\"\u3001\"Chirp J\"\u200b\u4fe1\u53f7\u200b\u540e\u200b\uff0cHub\u200b\u7ee7\u7eed\u200b\u7ef4\u6301\u200bSE0\u200b\u4fe1\u53f7\u200b\u76f4\u5230\u200b10ms\u3002</li> <li>USB\u200b\u8bbe\u5907\u200b\u53d1\u51fa\u200b\"Chirp K \"\u200b\u4fe1\u53f7\u200b\u540e\u200b\uff0c\u200b\u5c31\u200b\u7b49\u5f85\u200bHub\u200b\u56de\u5e94\u200b\u4e00\u7cfb\u5217\u200b\u7684\u200b\"Chirp K\"\u3001\"Chirp J\"\u200b\u4fe1\u53f7\u200b</li> <li>\u200b\u6536\u5230\u200b\u4e00\u7cfb\u5217\u200b\u7684\u200b\"Chirp K\"\u3001\"Chirp J\"\u200b\u4fe1\u53f7\u200b\uff1aUSB\u200b\u8bbe\u5907\u200b\u7aef\u53e3\u200bD+\u200b\u7684\u200b\u4e0a\u200b\u62c9\u200b\u7535\u963b\u200b\uff0c\u200b\u4f7f\u80fd\u200b\u9ad8\u901f\u200b\u6a21\u5f0f\u200b</li> <li>\u200b\u6ca1\u6709\u200b\u6536\u5230\u200b\u4e00\u7cfb\u5217\u200b\u7684\u200b\"Chirp K\"\u3001\"Chirp J\"\u200b\u4fe1\u53f7\u200b\uff1aUSB\u200b\u8bbe\u5907\u200b\u8f6c\u5165\u200b\u5168\u901f\u200b\u6a21\u5f0f\u200b</li> </ul> <p></p>"},{"location":"12_USB/03_1/#26","title":"2.6 \u200b\u6570\u636e\u4fe1\u53f7","text":""},{"location":"12_USB/03_1/#261-sopeop","title":"2.6.1 \u200b\u4f4e\u901f\u200b/\u200b\u5168\u901f\u200b\u7684\u200bSOP\u200b\u548c\u200bEOP","text":"<p>SOP\uff1aStart Of Packet\uff0cHub\u200b\u9a71\u52a8\u200bD+\u3001D-\u200b\u8fd9\u200b\u4e24\u6761\u200b\u7ebf\u8def\u200b\u4ece\u200bIdle\u200b\u72b6\u6001\u200b\u53d8\u4e3a\u200bK\u200b\u72b6\u6001\u200b\u3002SOP\u200b\u4e2d\u200b\u7684\u200bK\u200b\u72b6\u6001\u200b\u5c31\u662f\u200bSYNC\u200b\u4fe1\u53f7\u200b\u7684\u200b\u7b2c\u200b1\u200b\u4f4d\u200b\u6570\u636e\u200b\uff0cSYNC\u200b\u683c\u5f0f\u200b\u4e3a\u200b3\u200b\u5bf9\u200bKJ\u200b\u5916\u52a0\u200b2\u200b\u4e2a\u200bK\u3002</p> <p>EOP\uff1aEnd Of Packet\uff0c\u200b\u7531\u200b\u6570\u636e\u200b\u7684\u200b\u53d1\u9001\u200b\u65b9\u200b\u53d1\u51fa\u200bEOP\uff0c\u200b\u6570\u636e\u200b\u53d1\u9001\u200b\u65b9\u200b\u9a71\u52a8\u200bD+\u3001D-\u200b\u8fd9\u200b\u4e24\u6761\u200b\u7ebf\u8def\u200b\uff0c\u200b\u5148\u8bbe\u200b\u4e3a\u200bSE0\u200b\u72b6\u6001\u200b\u5e76\u200b\u7ef4\u6301\u200b2\u200b\u4f4d\u200b\u65f6\u95f4\u200b\uff0c\u200b\u518d\u200b\u8bbe\u7f6e\u200b\u4e3a\u200bJ\u200b\u72b6\u6001\u200b\u5e76\u200b\u7ef4\u6301\u200b1\u200b\u4f4d\u200b\u65f6\u95f4\u200b\uff0c\u200b\u6700\u540e\u200bD+\u3001D-\u200b\u53d8\u4e3a\u200b\u9ad8\u963b\u200b\u72b6\u6001\u200b\uff0c\u200b\u8fd9\u65f6\u200b\u7531\u200b\u7ebf\u8def\u200b\u7684\u200b\u4e0a\u4e0b\u200b\u62c9\u200b\u7535\u963b\u200b\u4f7f\u5f97\u200b\u603b\u7ebf\u200b\u8fdb\u5165\u200bIdle\u200b\u72b6\u6001\u200b\u3002</p> <p></p>"},{"location":"12_USB/03_1/#262-sop","title":"2.6.2 \u200b\u9ad8\u901f\u200b\u7684\u200bSOP","text":"<p>\u200b\u9ad8\u901f\u200b\u7684\u200bEOP\u200b\u6bd4\u8f83\u590d\u6742\u200b\uff0c\u200b\u4f5c\u4e3a\u200b\u8f6f\u4ef6\u200b\u5f00\u53d1\u4eba\u5458\u200b\u65e0\u9700\u200b\u638c\u63e1\u200b\u3002</p> <p>\u200b\u9ad8\u901f\u200b\u6a21\u5f0f\u200b\u4e2d\u200b\uff0cIde\u200b\u72b6\u6001\u200b\u4e3a\u200b\uff1aD+\u3001D-\u200b\u63a5\u5730\u200b\u3002SOP\u200b\u683c\u5f0f\u200b\u4e3a\u200b\uff1a\u200b\u4ece\u200bIdle\u200b\u72b6\u6001\u200b\u5207\u6362\u200b\u4e3a\u200bK\u200b\u72b6\u6001\u200b\u3002SOP\u200b\u4e2d\u200b\u7684\u200bK\u200b\u72b6\u6001\u200b\u5c31\u662f\u200bSYNC\u200b\u4fe1\u53f7\u200b\u7684\u200b\u7b2c\u200b1\u200b\u4f4d\u200b\u6570\u636e\u200b\u3002</p> <p>\u200b\u9ad8\u901f\u200b\u6a21\u5f0f\u200b\u4e2d\u200b\u7684\u200bSYNC\u200b\u683c\u5f0f\u200b\u4e3a\u200b\uff1aKJKJKJKJ KJKJKJKJ KJKJKJKJ KJKJKJKK\uff0c\u200b\u5373\u200b15\u200b\u5bf9\u200bKJ\uff0c\u200b\u5916\u52a0\u200b2\u200b\u4e2a\u200bK\u3002</p>"},{"location":"12_USB/03_1/#263-nrzi","title":"2.6.3 NRZI\u200b\u4e0e\u200b\u4f4d\u200b\u586b\u5145","text":"<p>\u200b\u53c2\u8003\u200b\u6587\u7ae0\u200b\uff1aUSB\u200b\u7684\u200bNRZI\u200b\u4fe1\u53f7\u200b\u683c\u5f0f\u200b</p> <p>NRZI\uff1aNon Return Zero Inverted Code\uff0c\u200b\u53cd\u5411\u200b\u4e0d\u200b\u5f52\u96f6\u200b\u7f16\u7801\u200b\u3002NRZI\u200b\u7684\u200b\u7f16\u7801\u200b\u65b9\u4f4d\u200b\u4e3a\u200b\uff1a\u200b\u5bf9\u4e8e\u200b\u6570\u636e\u200b0\uff0c\u200b\u6ce2\u5f62\u200b\u7ffb\u8f6c\u200b\uff1b\u200b\u5bf9\u4e8e\u200b\u6570\u636e\u200b1\uff0c\u200b\u6ce2\u5f62\u200b\u4e0d\u53d8\u200b\u3002</p> <p></p> <p>\u200b\u4f7f\u7528\u200bNRZI\uff0c\u200b\u53d1\u9001\u200b\u7aef\u200b\u53ef\u4ee5\u200b\u5f88\u200b\u5de7\u5999\u200b\u5730\u200b\u628a\u200b\"\u200b\u65f6\u949f\u200b\u9891\u7387\u200b\"\u200b\u544a\u8bc9\u200b\u63a5\u6536\u7aef\u200b\uff1a\u200b\u53ea\u8981\u200b\u4f20\u8f93\u200b\u8fde\u7eed\u200b\u7684\u200b\u6570\u636e\u200b0\u200b\u5373\u53ef\u200b\u3002\u200b\u5728\u200b\u4e0b\u56fe\u200b\u4e2d\u200b\uff0c\u200b\u4f4e\u901f\u200b/\u200b\u5168\u901f\u200b\u534f\u8bae\u200b\u4e2d\u200b\"Sync Pattern\"\u200b\u7684\u200b\u539f\u59cb\u6570\u636e\u200b\u662f\u200b\"00000001\"\uff0c\u200b\u63a5\u6536\u7aef\u200b\u4ece\u200b\u524d\u9762\u200b\u7684\u200b7\u200b\u4e2a\u200b0\u200b\u6ce2\u5f62\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u7b97\u200b\u51fa\u200b\"\u200b\u65f6\u949f\u200b\u9891\u7387\u200b\"\u3002</p> <p></p> <p>\u200b\u4f7f\u7528\u200bNRZI\u200b\u65f6\u200b\uff0c\u200b\u5982\u679c\u200b\u4f20\u8f93\u200b\u7684\u200b\u6570\u636e\u200b\u603b\u662f\u200b\"1\"\uff0c\u200b\u4f1a\u200b\u5bfc\u81f4\u200b\u6ce2\u5f62\u200b\u7ef4\u6301\u200b\u4e0d\u53d8\u200b\u3002\u200b\u5982\u679c\u200b\u7535\u5e73\u200b\u957f\u65f6\u95f4\u200b\u7ef4\u6301\u200b\u4e0d\u53d8\u200b\uff0c\u200b\u6bd4\u5982\u200b\u4f20\u8f93\u200b100\u200b\u4f4d\u200b1\u200b\u65f6\u200b\uff0c\u200b\u5982\u679c\u200b\u63a5\u6536\u200b\u65b9\u7a0d\u200b\u6709\u200b\u504f\u5dee\u200b\uff0c\u200b\u5c31\u200b\u53ef\u80fd\u200b\u8ba4\u4e3a\u200b\u63a5\u6536\u200b\u5230\u200b\u4e86\u200b99\u200b\u4f4d\u200b1\u3001101\u200b\u4f4d\u200b1\u3002\u200b\u800c\u200bUSB\u200b\u4e2d\u200b\u91c7\u7528\u200b\u4e86\u200bBit-Stuffing\u200b\u4f4d\u200b\u586b\u5145\u200b\u5904\u7406\u200b\uff0c\u200b\u5373\u200b\u5728\u200b\u8fde\u7eed\u200b\u53d1\u9001\u200b6\u200b\u4e2a\u200b1\u200b\u540e\u9762\u200b\u4f1a\u200b\u63d2\u5165\u200b1\u200b\u4e2a\u200b0\uff0c\u200b\u5f3a\u5236\u200b\u7ffb\u8f6c\u200b\u53d1\u9001\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u4ece\u800c\u200b\u8ba9\u200b\u63a5\u6536\u200b\u65b9\u200b\u8c03\u6574\u200b\u9891\u7387\u200b\uff0c\u200b\u540c\u6b65\u200b\u63a5\u6536\u200b\u3002\u200b\u800c\u200b\u63a5\u6536\u200b\u65b9\u5728\u200b\u63a5\u6536\u200b\u65f6\u200b\u53ea\u8981\u200b\u63a5\u6536\u200b\u5230\u200b\u8fde\u7eed\u200b\u7684\u200b6\u200b\u4e2a\u200b1\u200b\u540e\u200b\uff0c\u200b\u76f4\u63a5\u200b\u5c06\u200b\u540e\u9762\u200b\u7684\u200b0\u200b\u5220\u9664\u200b\u5373\u53ef\u200b\u6062\u590d\u200b\u6570\u636e\u200b\u7684\u200b\u539f\u8c8c\u200b\u3002</p> <p>NRZI\u200b\u6570\u636e\u683c\u5f0f\u200b\u5982\u4e0a\u56fe\u200b\u6240\u793a\u200b\u3002</p>"},{"location":"12_USB/04_1/","title":"USB\u200b\u534f\u8bae\u200b\u5c42\u200b\u6570\u636e\u683c\u5f0f","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u300a\u200b\u5708\u5708\u200b\u6559\u200b\u4f60\u200b\u73a9\u200bUSB\u300b</li> <li>\u200b\u7b80\u4e66\u200bjianshu_kevin@126.com\u200b\u7684\u200b\u6587\u7ae0\u200b</li> <li>USB\u200b\u534f\u8bae\u200b\uff08\u200b\u4e00\u200b\uff09</li> <li>USB\u200b\u534f\u8bae\u200b(\u200b\u4e8c\u200b)</li> <li>USB\u200b\u534f\u8bae\u200b(\u200b\u4e09\u200b)</li> <li>\u200b\u5b98\u7f51\u200b\uff1ahttps://www.usb.org/documents </li> <li>\u300ausb_20.pdf\u300b\u200b\u7684\u200b\u300aChapter 8  Protocol Layer\u300b</li> <li>USB\u200b\u7684\u200bNRZI\u200b\u4fe1\u53f7\u200b\u683c\u5f0f\u200b\uff1ahttps://zhuanlan.zhihu.com/p/460018993</li> <li>USB2.0\u200b\u5305\u200bPacket\u200b\u7684\u200b\u7ec4\u6210\u200b\uff1ahttps://www.usbzh.com/article/detail-459.html</li> </ul>"},{"location":"12_USB/04_1/#1","title":"1. \u200b\u786c\u4ef6\u200b\u62d3\u6251\u200b\u7ed3\u6784","text":"<ul> <li>compound device \uff1a\u200b\u591a\u4e2a\u200b\u8bbe\u5907\u200b\u7ec4\u5408\u200b\u8d77\u6765\u200b\uff0c\u200b\u901a\u8fc7\u200bHUB\u200b\u8ddf\u200bHost\u200b\u76f8\u8fde\u200b</li> <li>composite device  \uff1a\u200b\u4e00\u4e2a\u200b\u7269\u7406\u200b\u8bbe\u5907\u200b\u6709\u200b\u591a\u4e2a\u200b\u903b\u8f91\u8bbe\u5907\u200b(multiple interfaces)</li> </ul> <p>\u200b\u5728\u200b\u8f6f\u4ef6\u5f00\u53d1\u200b\u8fc7\u7a0b\u200b\u4e2d\u200b\uff0c\u200b\u6211\u4eec\u200b\u53ef\u4ee5\u200b\u5ffd\u7565\u200bHub\u200b\u7684\u200b\u5b58\u5728\u200b\uff0c\u200b\u786c\u4ef6\u200b\u62d3\u6251\u56fe\u200b\u7b80\u5316\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u4e00\u4e2a\u200b\u7269\u7406\u200b\u8bbe\u5907\u200b\u91cc\u9762\u200b\u53ef\u80fd\u200b\u6709\u200b\u591a\u4e2a\u200b\u903b\u8f91\u8bbe\u5907\u200b\uff0cHos\u200b\u53ef\u4ee5\u200b\u5916\u63a5\u200b\u591a\u4e2a\u200b\u903b\u8f91\u8bbe\u5907\u200b\uff0c\u200b\u786c\u4ef6\u200b\u62d3\u6251\u56fe\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"12_USB/04_1/#2","title":"2. \u200b\u534f\u8bae\u200b\u5c42","text":"<p>\u200b\u8981\u200b\u7406\u89e3\u200b\u534f\u8bae\u200b\u5c42\u200b\u3001\u200b\u7406\u89e3\u200b\u6570\u636e\u200b\u5982\u4f55\u200b\u4f20\u8f93\u200b\uff0c\u200b\u5e26\u200b\u7740\u200b\u8fd9\u200b\u51e0\u4e2a\u200b\u95ee\u9898\u200b\u53bb\u200b\u770b\u200b\u6587\u6863\u200b\u3001\u200b\u770b\u200b\u89c6\u9891\u200b\uff1a</p> <ul> <li>\u200b\u5982\u4f55\u200b\u5bfb\u5740\u200b\u8bbe\u5907\u200b\uff1f</li> <li>\u200b\u5982\u4f55\u200b\u8868\u793a\u200b\u6570\u636e\u200b\u65b9\u5411\u200b(\u200b\u8bfb\u200b\u3001\u200b\u8fd8\u662f\u200b\u5199\u200b)</li> <li>\u200b\u5982\u4f55\u200b\u786e\u8ba4\u200b\u7ed3\u679c\u200b\uff1f</li> </ul> <p>\u200b\u63d0\u524d\u200b\u7f57\u5217\u200b\u51fa\u6765\u200b\uff1a</p> <ul> <li>USB\u200b\u7cfb\u7edf\u200b\u662f\u200b\u4e00\u4e2a\u200bHost\u200b\u5bf9\u5e94\u200b\u591a\u4e2a\u200b\u8bbe\u5907\u200b\uff0c\u200b\u8981\u200b\u4f20\u8f93\u6570\u636e\u200b\u9996\u5148\u200b\u8981\u200b\u901a\u77e5\u200b\u8bbe\u5907\u200b\uff1a</li> <li>\u200b\u53d1\u51fa\u200bIN\u200b\u4ee4\u724c\u200b\u5305\u200b\uff1a\u200b\u8868\u793a\u200b\u60f3\u200b\u8bfb\u6570\u636e\u200b\uff0c\u200b\u91cc\u9762\u200b\u542b\u6709\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b</li> <li>\u200b\u53d1\u51fa\u200bOUT\u200b\u4ee4\u724c\u200b\u5305\u200b\uff1a\u200b\u8868\u793a\u200b\u60f3\u200b\u5199\u200b\u6570\u636e\u200b\uff0c\u200b\u91cc\u9762\u200b\u542b\u6709\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b</li> <li>\u200b\u6570\u636e\u200b\u9636\u6bb5\u200b\uff1a</li> <li>Host\u200b\u60f3\u200b\u8bfb\u6570\u636e\u200b\uff1a\u200b\u524d\u9762\u200b\u53d1\u51fa\u200bIN\u200b\u4ee4\u724c\u200b\u5305\u540e\u200b\uff0c\u200b\u73b0\u5728\u200b\u8bfb\u53d6\u6570\u636e\u200b\u5305\u200b</li> <li>Host\u200b\u60f3\u200b\u53d1\u51fa\u200b\u6570\u636e\u200b\uff1a\u200b\u524d\u9762\u200b\u53d1\u51fa\u200bOUT\u200b\u4ee4\u724c\u200b\u5305\u540e\u200b\uff0c\u200b\u73b0\u5728\u200b\u53d1\u51fa\u200b\u6570\u636e\u5305\u200b</li> <li>\u200b\u7ed3\u679c\u200b\u5982\u4f55\u200b\uff1f\u200b\u6709\u200b\u63e1\u624b\u200b\u5305\u200b</li> <li>Host\u200b\u60f3\u200b\u8bfb\u6570\u636e\u200b\uff0c\u200b\u8bbe\u5907\u200b\u53ef\u80fd\u200b\u672a\u200b\u5c31\u7eea\u200b\uff0c\u200b\u5c31\u200b\u4f1a\u200b\u56de\u5e94\u200bNAK\u200b\u5305\u200b</li> <li>Host\u200b\u60f3\u200b\u5199\u200b\u6570\u636e\u200b\uff0c\u200b\u5b83\u200b\u53d1\u51fa\u200b\u6570\u636e\u200b\u540e\u200b\uff0c\u200b\u8bbe\u5907\u200b\u6b63\u786e\u200b\u63a5\u6536\u200b\u4e86\u200b\uff0c\u200b\u5c31\u200b\u56de\u590d\u200bACK\u200b\u5305\u200b</li> </ul>"},{"location":"12_USB/04_1/#21","title":"2.1 \u200b\u5b57\u8282\u200b/\u200b\u4f4d\u200b\u4f20\u8f93\u200b\u987a\u5e8f","text":"<p>\u200b\u5148\u200b\u4f20\u8f93\u200b\u6700\u4f4e\u200b\u4f4d\u200b(LSB)\u3002\u200b\u5728\u200b\u540e\u7eed\u200b\u6587\u6863\u200b\u4e2d\u200b\uff0c\u200b\u63cf\u8ff0\u200b\u6570\u636e\u200b\u65f6\u200b\u6309\u7167\u200b\u4f20\u8f93\u200b\u987a\u5e8f\u200b\u4ece\u5de6\u5230\u53f3\u200b\u5217\u51fa\u6765\u200b\u3002</p>"},{"location":"12_USB/04_1/#22-sync","title":"2.2 SYNC\u200b\u57df","text":"<p>Host\u200b\u53d1\u51fa\u200bSOP\u200b\u4fe1\u53f7\u200b\u540e\u200b\uff0c\u200b\u5c31\u200b\u4f1a\u200b\u53d1\u51fa\u200bSYNC\u200b\u4fe1\u53f7\u200b\uff1a\u200b\u5b83\u200b\u662f\u200b\u4e00\u7cfb\u5217\u200b\u7684\u200b\u3001\u200b\u6700\u5927\u200b\u4f20\u8f93\u200b\u9891\u7387\u200b\u7684\u200b\u8109\u51b2\u200b\uff0c\u200b\u63a5\u6536\u200b\u65b9\u200b\u4f7f\u7528\u200b\u5b83\u200b\u6765\u200b\u540c\u6b65\u200b\u6570\u636e\u200b\u3002\u200b\u5bf9\u4e8e\u200b\u4f4e\u901f\u200b/\u200b\u5168\u901f\u200b\u8bbe\u5907\u200b\uff0cSYNC\u200b\u4fe1\u53f7\u200b\u662f\u200b8\u200b\u4f4d\u200b\u6570\u636e\u200b(\u200b\u4ece\u200b\u505a\u5230\u200b\u53f3\u200b\u662f\u200b00000001)\uff1b\u200b\u5bf9\u4e8e\u200b\u9ad8\u901f\u200b\u8bbe\u5907\u200b\uff0cSYNC\u200b\u4fe1\u53f7\u200b\u662f\u200b32\u200b\u4f4d\u200b\u6570\u636e\u200b(\u200b\u4ece\u5de6\u5230\u53f3\u200b\u662f\u200b00000000000000000000000000000001)\u3002\u200b\u4f7f\u7528\u200bNRZI\u200b\u7f16\u7801\u200b\u65f6\u200b\uff0c\u200b\u524d\u9762\u200b\u6bcf\u4e2a\u200b\"0\"\u200b\u90fd\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200b\u8df3\u53d8\u200b\u3002</p> <p>\u200b\u5728\u200b\u5f88\u591a\u200b\u6587\u6863\u200b\u91cc\u200b\uff0c\u200b\u628a\u200bSOP\u200b\u548c\u200bSYNC\u200b\u7edf\u4e00\u200b\u79f0\u4e3a\u200b\"SYNC\"\uff0c\u200b\u5b83\u200b\u7684\u200b\u610f\u601d\u200b\u662f\u200b\"SYNC\"\u200b\u4e2d\u200b\u542b\u6709\u200b\"SOP\"\u3002</p>"},{"location":"12_USB/04_1/#23","title":"2.3 \u200b\u5305\u200b\u683c\u5f0f","text":"<p>USB\u200b\u603b\u7ebf\u200b\u4e0a\u200b\u4f20\u8f93\u200b\u7684\u200b\u6570\u636e\u200b\u4ee5\u200b\u5305\u4e3a\u200b\u5355\u4f4d\u200b\u3002USB\u200b\u5305\u200b\u91cc\u200b\u542b\u6709\u200b\u54ea\u4e9b\u200b\u5185\u5bb9\u200b(\"\u200b\u57df\u200b\")\uff1f</p> <ul> <li>SOP\uff1a\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u5305\u200b\u7684\u200b\u8d77\u59cb\u200b</li> <li>SYNC\uff1a\u200b\u7528\u6765\u200b\u540c\u6b65\u200b\u65f6\u949f\u200b</li> <li>PID\uff1a\u200b\u8868\u793a\u200b\u5305\u200b\u7684\u200b\u7c7b\u578b\u200b</li> <li>\u200b\u5730\u5740\u200b\uff1a\u200b\u5728\u200bUSB\u200b\u786c\u4ef6\u200b\u4f53\u7cfb\u200b\u4e2d\u200b\uff0c\u200b\u4e00\u4e2a\u200bHost\u200b\u5bf9\u5e94\u200b\u591a\u4e2a\u200bLogical Device\uff0c\u200b\u90a3\u4e48\u200bHost\u200b\u53d1\u51fa\u200b\u7684\u200b\u5305\u200b\uff0c\u200b\u5982\u4f55\u200b\u786e\u5b9a\u200b\u53d1\u7ed9\u200b\u8c01\u200b\uff1f</li> <li>\u200b\u53d1\u7ed9\u200b\u6240\u6709\u200b\u8bbe\u5907\u200b\uff1a\u200b\u5305\u91cc\u200b\u4e0d\u200b\u542b\u6709\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b</li> <li> <p>\u200b\u53d1\u7ed9\u200b\u67d0\u4e2a\u200b\u8bbe\u5907\u200b\uff1a\u200b\u5305\u200b\u91cc\u200b\u542b\u6709\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\u3001\u200b\u7aef\u70b9\u200b\u53f7\u200b</p> </li> <li> <p>\u200b\u5e27\u200b\u53f7\u200b\u3001\u200b\u6570\u636e\u200b\u7b49\u200b\u8ddf\u200bPID\u200b\u76f8\u5173\u200b\u7684\u200b\u5185\u5bb9\u200b</p> </li> <li>CRC\u200b\u6821\u9a8c\u7801\u200b</li> </ul> <p>\u200b\u53d1\u8d77\u200b\u4e00\u6b21\u200b\u5b8c\u6574\u200b\u7684\u200b\u4f20\u8f93\u200b\uff0c\u200b\u53ef\u80fd\u200b\u6d89\u53ca\u200b\u591a\u4e2a\u200b\u5305\u200b\u3002\u200b\u90a3\u4e48\u200b\uff0c\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u5305\u91cc\u200b\u542b\u6709\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\u3001\u200b\u7aef\u70b9\u200b\u53f7\u200b\uff0c\u200b\u540e\u7eed\u200b\u7684\u200b\u5305\u200b\u5c31\u200b\u6ca1\u200b\u5fc5\u8981\u200b\u5305\u542b\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\u3001\u200b\u7aef\u70b9\u200b\u53f7\u200b\u3002</p>"},{"location":"12_USB/04_1/#231-pid","title":"2.3.1 PID\u200b\u57df","text":"<p>\u200b\u6ce8\u610f\u200b\uff1a\u200b\u6240\u6709\u200b\u7684\u200bUSB\u200b\u6587\u6863\u200b\u63d0\u5230\u200b\u7684\u200b\"\u200b\u8f93\u5165\u200b\"\u3001\"\u200b\u8f93\u51fa\u200b\"\uff0c\u200b\u90fd\u200b\u662f\u200b\u57fa\u4e8e\u200bHost\u200b\u7684\u200b\u89d2\u5ea6\u200b\uff0c\"\u200b\u8f93\u51fa\u200b\"\u200b\u8868\u793a\u200b\u4ece\u200bHost\u200b\u8f93\u51fa\u200b\u5230\u200b\u8bbe\u5907\u200b\uff0c\"\u200b\u8f93\u5165\u200b\"\u200b\u8868\u793a\u200bHost\u200b\u4ece\u200b\u8bbe\u5907\u200b\u5f97\u5230\u200b\u6570\u636e\u200b\u3002</p> <p>\u200b\u6709\u200b\u54ea\u4e9b\u200bUSB\u200b\u5305\u200b\uff1f\u200b\u6839\u636e\u200b\u5305\u200b\u6570\u636e\u200b\u91cc\u200b\u7684\u200bPID\u200b\u7684\u200bbit1, bit0\u200b\u53ef\u4ee5\u200b\u5206\u4e3a\u200b4\u200b\u7c7b\u200b\uff1a</p> <ul> <li>\u200b\u4ee4\u724c\u200b\u5305\u200b(Token)\uff1a01B</li> <li>\u200b\u6570\u636e\u5305\u200b(Data)\uff1a11B</li> <li>\u200b\u63e1\u624b\u200b\u5305\u200b(Handshake)\uff1a10B</li> <li>\u200b\u7279\u6b8a\u200b\u5305\u200b(Special)\uff1a00B</li> </ul> <p>PID\u200b\u6709\u200b4\u200b\u4f4d\u200b\uff0c\u200b\u4f7f\u7528\u200bbit1,bit0\u200b\u786e\u5b9a\u200b\u5206\u7c7b\u200b\uff0c\u200b\u4f7f\u7528\u200bbit3,bit2\u200b\u8fdb\u4e00\u6b65\u200b\u7ec6\u5206\u200b\u3002\u200b\u5982\u4e0b\u200b\u8868\u200b(\u200b\u6765\u81ea\u200b\u300a\u200b\u5708\u5708\u200b\u6559\u200b\u4f60\u200b\u73a9\u200bUSB\u300b)\u200b\u6240\u793a\u200b\uff1a</p> <p></p> <p>\u200b\u5728\u200bUSB\u200b\u5305\u4e2d\u200b\uff0cPID\u200b\u57df\u200b\u4f7f\u7528\u200b8\u200b\u4f4d\u6765\u200b\u8868\u793a\u200b\uff0c\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u524d\u200b4\u200b\u4f4d\u200b\u8868\u793a\u200bPID\uff0c\u200b\u540e\u200b4\u200b\u4f4d\u662f\u200b\u5bf9\u5e94\u200b\u4f4d\u200b\u7684\u200b\u53d6\u53cd\u200b\u3002\u200b\u63a5\u6536\u200b\u65b9\u200b\u53d1\u73b0\u200b\u540e\u200b4\u200b\u4f4d\u200b\u4e0d\u662f\u200b\u524d\u200b4\u200b\u4f4d\u200b\u7684\u200b\u53d6\u53cd\u200b\u7684\u8bdd\u200b\uff0c\u200b\u5c31\u200b\u8ba4\u4e3a\u200b\u53d1\u751f\u200b\u4e86\u200b\u9519\u8bef\u200b\u3002</p>"},{"location":"12_USB/04_1/#232-token","title":"2.3.2 \u200b\u4ee4\u724c\u200b\u5305\u200b(Token)","text":"<p>\u200b\u4ee4\u724c\u200b\u7c7b\u200b\u7684\u200bPID\uff0c\u200b\u8d77\u200b\"\u200b\u901a\u77e5\u200b\u4f5c\u7528\u200b\"\uff0c\u200b\u901a\u77e5\u200b\u8c01\u200b\uff1fSOF\u200b\u4ee4\u724c\u200b\u5305\u88ab\u200b\u7528\u6765\u200b\u901a\u77e5\u200b\u6240\u6709\u200b\u8bbe\u5907\u200b\uff0cOUT/IN/SETUP\u200b\u4ee4\u724c\u200b\u5305\u88ab\u200b\u7528\u6765\u200b\u901a\u77e5\u200b\u67d0\u4e2a\u200b\u8bbe\u5907\u200b\u3002</p> <p>\u200b\u5bf9\u4e8e\u200bOUT\u3001IN\u3001SETUP\u200b\u4ee4\u724c\u200b\u5305\u200b\uff0c\u200b\u5b83\u4eec\u200b\u90fd\u200b\u662f\u200b\u8981\u200b\u901a\u77e5\u200b\u5230\u200b\u5177\u4f53\u200b\u7684\u200b\u8bbe\u5907\u200b\uff0c\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>USB\u200b\u8bbe\u5907\u200b\u7684\u200b\u5730\u5740\u200b\u6709\u200b7\u200b\u4f4d\u200b\uff0c\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>USB\u200b\u8bbe\u5907\u200b\u7684\u200b\u7aef\u70b9\u200b\u53f7\u200b\u6709\u200b4\u200b\u4f4d\u200b\uff0c\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u5bf9\u4e8e\u200bSOF\u200b\u5305\u200b\uff0c\u200b\u82f1\u6587\u200b\u540d\u4e3a\u200b\"Start-of-Frame marker and frame number\"\u3002\u200b\u5bf9\u4e8e\u200bUSB\u200b\u5168\u901f\u200b\u8bbe\u5907\u200b\uff0cHost\u200b\u6bcf\u200b1ms\u200b\u4ea7\u751f\u200b\u4e00\u4e2a\u200b\u5e27\u200b\uff1b\u200b\u5bf9\u4e8e\u200b\u9ad8\u901f\u200b\u8bbe\u5907\u200b\uff0c\u200b\u6bcf\u200b125us\u200b\u4ea7\u751f\u200b\u4e00\u4e2a\u200b\u5fae\u5e27\u200b\uff0c1\u200b\u5e27\u200b\u91cc\u200b\u6709\u200b8\u200b\u4e2a\u200b\u5fae\u5e27\u200b\u3002Host\u200b\u4f1a\u200b\u5bf9\u200b\u5f53\u524d\u200b\u5e27\u200b\u53f7\u200b\u8fdb\u884c\u200b\u7d2f\u52a0\u200b\u8ba1\u6570\u200b\uff0c\u200b\u5728\u200b\u6bcf\u200b\u5e27\u200b\u6216\u200b\u6bcf\u5fae\u200b\u5e27\u200b\u5f00\u59cb\u200b\u65f6\u200b\uff0c\u200b\u901a\u8fc7\u200bSOF\u200b\u4ee4\u724c\u200b\u5305\u200b\u53d1\u9001\u200b\u5e27\u200b\u53f7\u200b\u3002\u200b\u5bf9\u4e8e\u200b\u9ad8\u901f\u200b\u8bbe\u5907\u200b\uff0c\u200b\u6bcf\u200b1\u200b\u6beb\u79d2\u200b\u91cc\u200b\u6709\u200b8\u200b\u4e2a\u200b\u5fae\u5e27\u200b\uff0c\u200b\u8fd9\u200b8\u200b\u4e2a\u200b\u5fae\u200b\u5e27\u200b\u7684\u200b\u5e27\u200b\u53f7\u200b\u662f\u200b\u4e00\u6837\u200b\u7684\u200b\uff0c\u200b\u6bcf\u200b125us\u200b\u53d1\u9001\u200b\u4e00\u4e2a\u200bSOF\u200b\u4ee4\u724c\u200b\u5305\u200b\u3002</p> <p>SOF\u200b\u4ee4\u724c\u200b\u5305\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"12_USB/04_1/#233","title":"2.3.3 \u200b\u6570\u636e\u5305","text":"<p>Host\u200b\u4f7f\u7528\u200bOUT\u3001IN\u3001SETUP\u200b\u6765\u200b\u901a\u77e5\u200b\u8bbe\u5907\u200b\uff1a\u200b\u6211\u8981\u200b\u4f20\u8f93\u6570\u636e\u200b\u4e86\u200b\u3002\u200b\u6570\u636e\u200b\u901a\u8fc7\u200b\"\u200b\u6570\u636e\u5305\u200b\"\u200b\u8fdb\u884c\u200b\u4f20\u8f93\u200b\u3002</p> <p>\u200b\u6570\u636e\u5305\u200b\u4e5f\u200b\u6709\u200b4\u200b\u79cd\u200b\u7c7b\u578b\u200b\uff1aDATA0\u3001DATA1\u3001DATA2\u3001MDATA\u3002\u200b\u5176\u4e2d\u200bDATA2\u3001MDATA\u200b\u5728\u200b\u9ad8\u901f\u200b\u8bbe\u5907\u200b\u4e2d\u200b\u4f7f\u7528\u200b\u3002\u200b\u5bf9\u200b\u8f6f\u4ef6\u200b\u5f00\u53d1\u4eba\u5458\u200b\u6765\u8bf4\u200b\uff0c\u200b\u6211\u4eec\u200b\u6682\u65f6\u200b\u4ec5\u200b\u9700\u200b\u4e86\u89e3\u200bDATA0\u3001DATA1\u3002</p> <p>\u200b\u4e3a\u4ec0\u4e48\u200b\u8981\u200b\u5f15\u5165\u200bDATA0\u3001DATA1\u200b\u8fd9\u4e9b\u200b\u4e0d\u540c\u200b\u7c7b\u578b\u200b\u7684\u200b\u6570\u636e\u5305\u200b\uff1f\u200b\u4e3a\u4e86\u200b\u7ea0\u9519\u200b\u3002</p> <p>Host\u200b\u548c\u200b\u8bbe\u5907\u200b\u90fd\u200b\u4f1a\u200b\u7ef4\u62a4\u200b\u81ea\u5df1\u200b\u7684\u200b\u6570\u636e\u5305\u200b\u5207\u6362\u200b\u673a\u5236\u200b\uff0c\u200b\u5f53\u200b\u6570\u636e\u5305\u200b\u6210\u529f\u200b\u53d1\u9001\u200b\u6216\u8005\u200b\u63a5\u6536\u200b\u65f6\u200b\uff0c\u200b\u6570\u636e\u5305\u200b\u7c7b\u578b\u200b\u5207\u6362\u200b\u3002\u200b\u5f53\u200b\u68c0\u6d4b\u200b\u5230\u200b\u5bf9\u65b9\u200b\u4f7f\u7528\u200b\u7684\u200b\u6570\u636e\u5305\u200b\u7c7b\u578b\u200b\u4e0d\u200b\u5bf9\u200b\u65f6\u200b\uff0cUSB\u200b\u7cfb\u7edf\u200b\u8ba4\u4e3a\u200b\u53d1\u751f\u200b\u4e86\u200b\u9519\u8bef\u200b\u3002</p> <p>\u200b\u6bd4\u5982\u200b\uff1a</p> <ul> <li>Host\u200b\u53d1\u9001\u200bDATA0\u200b\u7ed9\u200b\u8bbe\u5907\u200b\uff0c\u200b\u8bbe\u5907\u200b\u8fd4\u56de\u200bACK\u200b\u8868\u793a\u200b\u6210\u529f\u200b\u63a5\u6536\u200b\uff0c\u200b\u8bbe\u5907\u200b\u671f\u5f85\u200b\u4e0b\u200b\u4e00\u4e2a\u200b\u6570\u636e\u200b\u662f\u200bDATA1</li> <li>\u200b\u4f46\u662f\u200bHost\u200b\u6ca1\u6709\u200b\u63a5\u6536\u200b\u5230\u200bACK\uff0cHost\u200b\u8ba4\u4e3a\u200b\u6570\u636e\u200b\u6ca1\u6709\u200b\u53d1\u9001\u200b\u6210\u529f\u200b\uff0cHost\u200b\u7ee7\u7eed\u200b\u4f7f\u7528\u200bDATA0\u200b\u53d1\u9001\u200b\u4e0a\u200b\u4e00\u6b21\u200b\u7684\u200b\u6570\u636e\u200b</li> <li>\u200b\u8bbe\u5907\u200b\u518d\u6b21\u200b\u63a5\u6536\u200b\u5230\u200bDATA0\u200b\u6570\u636e\u5305\u200b\uff0c\u200b\u5b83\u200b\u5c31\u200b\u77e5\u9053\u200b\uff1a\u200b\u54e6\u200b\uff0c\u200b\u8fd9\u662f\u200b\u91cd\u4f20\u200b\u7684\u200b\u6570\u636e\u5305\u200b</li> </ul> <p>\u200b\u6570\u636e\u5305\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u5bf9\u4e8e\u200b\u5168\u901f\u200b\u8bbe\u5907\u200b\uff0c\u200b\u6570\u636e\u5305\u200b\u4e2d\u200b\u7684\u200b\u6570\u636e\u200b\u505a\u5927\u662f\u200b1023\u200b\u5b57\u8282\u200b\uff1b\u200b\u5bf9\u4e8e\u200b\u5168\u901f\u200b\u8bbe\u5907\u200b\uff0c\u200b\u6570\u636e\u5305\u200b\u4e2d\u200b\u7684\u200b\u6570\u636e\u200b\u505a\u5927\u662f\u200b1024\u200b\u5b57\u8282\u200b\u3002</p>"},{"location":"12_USB/04_1/#234","title":"2.3.4 \u200b\u63e1\u624b\u200b\u5305","text":"<p>\u200b\u63e1\u624b\u200b\u5305\u6709\u200b4\u200b\u7c7b\u200b\uff1aACK\u3001NAK\u3001STALL\u3001NYET</p> <ul> <li>ACK\uff1a\u200b\u6570\u636e\u200b\u63a5\u6536\u200b\u65b9\u200b\u7528\u6765\u200b\u56de\u590d\u200b\u53d1\u9001\u200b\u65b9\u200b\uff0c\u200b\u8868\u793a\u200b\u6b63\u786e\u200b\u63a5\u6536\u200b\u5230\u200b\u4e86\u200b\u6570\u636e\u200b\u5e76\u4e14\u200b\u6709\u200b\u8db3\u591f\u200b\u7684\u200b\u7a7a\u95f4\u200b\u4fdd\u5b58\u200b\u6570\u636e\u200b\u3002</li> <li>NAK\uff1aHost\u200b\u53d1\u9001\u6570\u636e\u200b\u7ed9\u200b\u8bbe\u5907\u200b\u65f6\u200b\uff0c\u200b\u8bbe\u5907\u200b\u53ef\u4ee5\u200b\u56de\u5e94\u200bNAK\u200b\u8868\u793a\u200b\"\u200b\u6211\u200b\u8fd8\u200b\u6ca1\u200b\u51c6\u5907\u200b\u597d\u200b\uff0c\u200b\u6ca1\u200b\u529e\u6cd5\u200b\u63a5\u6536\u6570\u636e\u200b\"\uff1bHost\u200b\u60f3\u200b\u8bfb\u53d6\u200b\u8bbe\u5907\u200b\u7684\u200b\u6570\u636e\u200b\u65f6\u200b\uff0c\u200b\u8bbe\u5907\u200b\u53ef\u4ee5\u200b\u56de\u590d\u200bNAK\u200b\u8868\u793a\u200b\"\u200b\u6211\u200b\u6ca1\u6709\u200b\u6570\u636e\u200b\u7ed9\u200b\u4f60\u200b\"\u3002</li> <li>STALL\uff1a\u200b\u8868\u793a\u200b\u53d1\u751f\u200b\u4e86\u200b\u9519\u8bef\u200b\uff0c\u200b\u6bd4\u5982\u200b\u8bbe\u5907\u200b\u65e0\u6cd5\u200b\u6267\u884c\u200b\u8fd9\u4e2a\u200b\u8bf7\u6c42\u200b(\u200b\u4e0d\u200b\u652f\u6301\u200b\u8be5\u200b\u65ad\u70b9\u200b\u7b49\u5f85\u200b)\u3001\u200b\u65ad\u70b9\u200b\u5df2\u7ecf\u200b\u6302\u200b\u8d77\u200b\u3002\u200b\u8bbe\u5907\u200b\u8fd4\u56de\u200bSTALL\u200b\u540e\u200b\uff0c\u200b\u9700\u8981\u200b\u4e3b\u673a\u200b\u8fdb\u884c\u200b\u5e72\u9884\u200b\u624d\u80fd\u200b\u63a5\u89e6\u200bSTALL\u200b\u72b6\u6001\u200b\u3002</li> <li>NYET\uff1a\u200b\u4ec5\u200b\u9002\u7528\u200b\u4e8e\u200b\u9ad8\u901f\u200b\u8bbe\u5907\u200b\u3002Host\u200b\u53ef\u4ee5\u200b\u53d1\u51fa\u200bPING\u200b\u5305\u200b\u7528\u6765\u200b\u786e\u8ba4\u200b\u8bbe\u5907\u200b\u6709\u200b\u6570\u636e\u200b\uff0c\u200b\u8bbe\u5907\u200b\u53ef\u4ee5\u200b\u56de\u5e94\u200bNYET\u200b\u8868\u793a\u200b\"\u200b\u8fd8\u200b\u6ca1\u200b\u5462\u200b\"\u3002Hub\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u56de\u5e94\u200bNYET\u200b\u8868\u793a\u200b\u4f4e\u901f\u200b/\u200b\u5168\u901f\u200b\u4f20\u8f93\u200b\u8fd8\u200b\u6ca1\u200b\u5b8c\u7ed3\u200b\u3002</li> </ul>"},{"location":"12_USB/04_1/#24","title":"2.4 \u200b\u4f20\u8f93\u200b\u7ec6\u8282","text":""},{"location":"12_USB/04_1/#241-transfertransaction","title":"2.4.1 \u200b\u4f20\u8f93\u200b(Transfer)\u200b\u548c\u200b\u4e8b\u52a1\u200b(Transaction)","text":"<p>USB\u200b\u4f20\u8f93\u200b\u7684\u200b\u57fa\u672c\u200b\u5355\u4f4d\u200b\u662f\u200b\u5305\u200b(Packet)\uff0c\u200b\u5305\u200b\u7684\u200b\u7c7b\u578b\u200b\u7531\u200bPID\u200b\u8868\u793a\u200b\u3002\u200b\u4e00\u4e2a\u200b\u5355\u7eaf\u200b\u7684\u200b\u5305\u200b\uff0c\u200b\u662f\u200b\u65e0\u6cd5\u200b\u4f20\u8f93\u200b\u5b8c\u6574\u200b\u7684\u200b\u6570\u636e\u200b\u3002</p> <p>\u200b\u4e3a\u4ec0\u4e48\u200b\uff1f\u200b\u6bd4\u5982\u200b\u60f3\u200b\u8f93\u51fa\u200b\u6570\u636e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u53d1\u51fa\u200bOUT\u200b\u4ee4\u724c\u200b\u5305\u200b\uff0cOUT\u200b\u4ee4\u724c\u200b\u5305\u200b\u53ef\u4ee5\u200b\u6307\u5b9a\u200b\u76ee\u7684\u5730\u200b\u3002\u200b\u4f46\u662f\u200b\u6570\u636e\u200b\u5982\u4f55\u200b\u4f20\u8f93\u200b\u5462\u200b\uff1f\u200b\u8fd8\u200b\u9700\u8981\u200b\u53d1\u51fa\u200bDATA0\u200b\u6216\u200bDATA1\u200b\u6570\u636e\u5305\u200b\u3002\u200b\u8bbe\u5907\u200b\u6536\u5230\u200b\u6570\u636e\u200b\u540e\u200b\uff0c\u200b\u8fd8\u8981\u200b\u56de\u590d\u200b\u4e00\u4e2a\u200bACK\u200b\u63e1\u624b\u200b\u5305\u200b\u3002</p> <p>\u200b\u6240\u4ee5\u200b\uff0c\u200b\u5b8c\u6574\u200b\u7684\u200b\u6570\u636e\u4f20\u8f93\u200b\uff0c\u200b\u9700\u8981\u200b\u6d89\u53ca\u200b\u591a\u4e2a\u200b\u5305\u200b\uff1a\u200b\u4ee4\u724c\u200b\u5305\u200b\u3001\u200b\u6570\u636e\u5305\u200b\u3001\u200b\u63e1\u624b\u200b\u5305\u200b\u3002\u200b\u8fd9\u4e2a\u200b\u5b8c\u6574\u200b\u7684\u200b\u6570\u636e\u4f20\u8f93\u200b\u8fc7\u7a0b\u200b\uff0c\u200b\u88ab\u200b\u79f0\u4e3a\u200b\u4e8b\u52a1\u200b(Transaction)\u3002</p> <p>\u200b\u6709\u4e9b\u200b\u4e8b\u52a1\u200b\u9700\u8981\u200b\u63e1\u624b\u200b\u5305\u200b\uff0c\u200b\u6709\u4e9b\u200b\u4e8b\u52a1\u200b\u4e0d\u200b\u9700\u8981\u200b\u63e1\u624b\u200b\u5305\u200b\uff0c\u200b\u6709\u4e9b\u200b\u4e8b\u52a1\u200b\u53ef\u4ee5\u200b\u4f20\u8f93\u200b\u5f88\u5927\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u6709\u4e9b\u200b\u4e8b\u52a1\u200b\u53ea\u80fd\u200b\u4f20\u8f93\u200b\u5c0f\u91cf\u200b\u6570\u636e\u200b\u3002</p> <p>\u200b\u6709\u200b\u56db\u7c7b\u200b\u4e8b\u52a1\u200b\uff1a</p> <ul> <li>\u200b\u6279\u91cf\u200b\u4e8b\u52a1\u200b\uff1a\u200b\u7528\u6765\u200b\u4f20\u8f93\u200b\u5927\u91cf\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u6570\u636e\u200b\u7684\u200b\u6b63\u786e\u6027\u200b\u6709\u200b\u4fdd\u8bc1\u200b\uff0c\u200b\u65f6\u6548\u200b\u6ca1\u6709\u200b\u4fdd\u8bc1\u200b\u3002</li> <li>\u200b\u4e2d\u65ad\u200b\u4e8b\u52a1\u200b\uff1a\u200b\u7528\u6765\u200b\u4f20\u8f93\u200b\u5468\u671f\u6027\u200b\u7684\u200b\u3001\u200b\u5c0f\u91cf\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u6570\u636e\u200b\u7684\u200b\u6b63\u786e\u6027\u200b\u548c\u200b\u65f6\u6548\u200b\u90fd\u200b\u6709\u200b\u4fdd\u8bc1\u200b\u3002</li> <li>\u200b\u5b9e\u65f6\u200b\u4e8b\u52a1\u200b\uff1a\u200b\u7528\u6765\u200b\u4f20\u8f93\u200b\u5b9e\u65f6\u200b\u6570\u636e\u200b\uff0c\u200b\u6570\u636e\u200b\u7684\u200b\u6b63\u786e\u6027\u200b\u6ca1\u6709\u200b\u4fdd\u8bc1\u200b\uff0c\u200b\u65f6\u6548\u200b\u6709\u200b\u4fdd\u8bc1\u200b\u3002</li> <li>\u200b\u5efa\u7acb\u200b\u4e8b\u52a1\u200b\uff1a\u200b\u8ddf\u200b\u6279\u91cf\u200b\u4e8b\u52a1\u200b\u7c7b\u4f3c\u200b\uff0c\u200b\u53ea\u4e0d\u8fc7\u200b\u4ee4\u724c\u200b\u5305\u662f\u200bSETUP\u200b\u4ee4\u724c\u200b\u5305\u200b\u3002</li> </ul> <p>\u200b\u6709\u200b\u56db\u7c7b\u200b\u4f20\u8f93\u200b(Transfer)\uff1a</p> <ul> <li>\u200b\u6279\u91cf\u200b\u4f20\u8f93\u200b\uff1a\u200b\u5c31\u662f\u200b\u4f7f\u7528\u200b\u6279\u91cf\u200b\u4e8b\u52a1\u200b\u5b9e\u73b0\u200b\u6570\u636e\u4f20\u8f93\u200b\uff0c\u200b\u6bd4\u5982\u200bU\u200b\u76d8\u200b\u3002</li> <li>\u200b\u4e2d\u65ad\u200b\u4f20\u8f93\u200b\uff1a\u200b\u5c31\u662f\u200b\u4f7f\u7528\u200b\u4e2d\u65ad\u200b\u4e8b\u52a1\u200b\u5b9e\u73b0\u200b\u6570\u636e\u4f20\u8f93\u200b\uff0c\u200b\u6bd4\u5982\u200b\u9f20\u6807\u200b\u3002</li> <li>\u200b\u5b9e\u65f6\u200b\u4f20\u8f93\u200b\uff1a\u200b\u5c31\u662f\u200b\u4f7f\u7528\u200b\u5b9e\u65f6\u200b\u4e8b\u52a1\u200b\u5b9e\u73b0\u200b\u6570\u636e\u4f20\u8f93\u200b\uff0c\u200b\u6bd4\u5982\u200b\u6444\u50cf\u5934\u200b\u3002</li> <li>\u200b\u63a7\u5236\u4f20\u8f93\u200b\uff1a\u200b\u7531\u200b\u5efa\u7acb\u200b\u4e8b\u52a1\u200b\u3001\u200b\u6279\u91cf\u200b\u4e8b\u52a1\u200b\u7ec4\u6210\u200b\uff0c\u200b\u6240\u6709\u200b\u7684\u200bUSB\u200b\u8bbe\u5907\u200b\u90fd\u200b\u5fc5\u987b\u200b\u652f\u6301\u200b\u63a7\u5236\u4f20\u8f93\u200b\uff0c\u200b\u7528\u4e8e\u200b\"\u200b\u8bc6\u522b\u200b/\u200b\u679a\u4e3e\u200b\"</li> </ul> <p>\u200b\u6682\u65f6\u200b\u8bb0\u4f4f\u200b\u8fd9\u4e2a\u200b\u5173\u7cfb\u200b\uff1a</p> <ul> <li>BIT\u200b\u7ec4\u6210\u200b\u57df\u200b(Field)</li> <li>\u200b\u57df\u200b\u7ec4\u6210\u200b\u5305\u200b(Packet)</li> <li>\u200b\u5305\u200b\u7ec4\u6210\u200b\u4e8b\u52a1\u200b(Transaction)</li> <li>\u200b\u4e8b\u52a1\u200b\u7ec4\u6210\u200b\u4f20\u8f93\u200b(Transfer)</li> </ul>"},{"location":"12_USB/04_1/#242-stagephase","title":"2.4.2 \u200b\u8fc7\u7a0b\u200b(stage)\u200b\u548c\u200b\u9636\u6bb5\u200b(phase)","text":"<p>\u200b\u4e8b\u52a1\u200b\u7531\u200b\u591a\u4e2a\u200b\u5305\u200b\u7ec4\u6210\u200b\uff0c\u200b\u6bd4\u5982\u200bHost\u200b\u8981\u200b\u53d1\u9001\u6570\u636e\u200b\u7ed9\u200b\u8bbe\u5907\u200b\uff0c\u200b\u8fd9\u200b\u5c31\u200b\u4f1a\u200b\u6d89\u53ca\u200b\u5f88\u591a\u200b\u4e2a\u200b\u5305\u200b\uff1a</p> <ul> <li> <p>Host\u200b\u53d1\u51fa\u200bOUT\u200b\u4ee4\u724c\u200b\u5305\u200b\uff0c\u200b\u8868\u793a\u200b\u8981\u53d1\u200b\u6570\u636e\u200b\u7ed9\u200b\u54ea\u4e2a\u200b\u8bbe\u5907\u200b</p> </li> <li> <p>Host\u200b\u53d1\u51fa\u200bDATA0\u200b\u6570\u636e\u5305\u200b</p> </li> <li> <p>\u200b\u8bbe\u5907\u200b\u6536\u5230\u200b\u6570\u636e\u200b\u540e\u200b\uff0c\u200b\u56de\u5e94\u200bACK\u200b\u5305\u200b</p> </li> </ul> <p>\u200b\u8fd9\u4e2a\u200b\u5b8c\u6574\u200b\u7684\u200b\u4e8b\u52a1\u200b\u6d89\u53ca\u200b3\u200b\u4e2a\u200b\u5305\u200b(Packet)\uff0c\u200b\u5206\u4e3a\u200b3\u200b\u4e2a\u200b\u9636\u6bb5\u200b(Phase)\uff1a</p> <ul> <li>\u200b\u4ee4\u724c\u200b\u9636\u6bb5\u200b(Token phase)\uff1a\u200b\u7531\u200b\u4ee4\u724c\u200b\u5305\u200b\u5b9e\u73b0\u200b</li> <li>\u200b\u6570\u636e\u200b\u9636\u6bb5\u200b(Data phase)\uff1a\u200b\u7531\u200b\u6570\u636e\u5305\u200b\u5b9e\u73b0\u200b</li> <li>\u200b\u63e1\u624b\u200b\u9636\u6bb5\u200b(Handshake phase)\uff1a\u200b\u7531\u200b\u63e1\u624b\u200b\u5305\u200b\u5b9e\u73b0\u200b</li> </ul> <p>\u200b\u4e8b\u52a1\u200b\u7531\u5305\u200b\u7ec4\u6210\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u5305\u200b\u5206\u522b\u200b\u5904\u4e8e\u200b3\u200b\u4e2a\u200b\u9636\u6bb5\u200b(phase)\uff1a\u200b\u4ee4\u724c\u200b\u9636\u6bb5\u200b\uff0c\u200b\u6570\u636e\u200b\u9636\u6bb5\u200b\uff0c\u200b\u63e1\u624b\u200b\u9636\u6bb5\u200b\u3002</p> <p>\u200b\u5bf9\u4e8e\u200b\u6279\u91cf\u200b\u4f20\u8f93\u200b\u3001\u200b\u4e2d\u65ad\u200b\u4f20\u8f93\u200b\u3001\u200b\u5b9e\u65f6\u200b\u4f20\u8f93\u200b\uff0c\u200b\u5b83\u4eec\u200b\u5206\u522b\u200b\u7531\u200b\u4e00\u4e2a\u200b\u4e8b\u52a1\u200b\u7ec4\u6210\u200b\uff0c\u200b\u4e0d\u518d\u200b\u7ec6\u5206\u200b\u4e3a\u200b\u82e5\u5e72\u4e2a\u200b\u8fc7\u7a0b\u200b\u3002</p> <p>\u200b\u4f46\u662f\u200b\u63a7\u5236\u4f20\u8f93\u200b\u7531\u200b\u591a\u4e2a\u200b\u4e8b\u52a1\u200b\u7ec4\u6210\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u4e8b\u52a1\u200b\u5206\u522b\u200b\u5904\u4e8e\u200b3\u200b\u4e2a\u200b\u8fc7\u7a0b\u200b\uff1a\u200b\u5efa\u7acb\u200b\u8fc7\u7a0b\u200b(stage)\u3001\u200b\u6570\u636e\u200b\u8fc7\u7a0b\u200b(stage)\u3001\u200b\u72b6\u6001\u200b\u8fc7\u7a0b\u200b(stage)\u3002</p> <p>\u200b\u603b\u7ed3\u200b\u8d77\u6765\u200b\u5c31\u662f\u200b\uff1a</p> <ul> <li>\u200b\u63a7\u5236\u4f20\u8f93\u200b\u7531\u200b\u591a\u4e2a\u200b\u8fc7\u7a0b\u200b(stage)\u200b\u7ec4\u6210\u200b\uff0c\u200b\u6bcf\u4e2a\u200b\u8fc7\u7a0b\u200b\u7531\u200b\u4e00\u4e2a\u200b\u4e8b\u52a1\u200b\u6765\u200b\u5b9e\u73b0\u200b</li> <li>\u200b\u6bcf\u4e2a\u200b\u4e8b\u52a1\u200b\u7531\u200b\u591a\u4e2a\u200b\u9636\u6bb5\u200b(phase)\u200b\u7ec4\u6210\u200b\uff0c\u200b\u6bcf\u4e2a\u200b\u9636\u6bb5\u200b\u6709\u200b\u4e00\u4e2a\u5305\u200b\u6765\u200b\u5b9e\u73b0\u200b</li> </ul>"},{"location":"12_USB/04_1/#243","title":"2.4.3 \u200b\u6279\u91cf\u200b\u4f20\u8f93","text":"<p>\u200b\u6279\u91cf\u200b\u4f20\u8f93\u200b\u7528\u200b\u6279\u91cf\u200b\u4e8b\u52a1\u200b\u6765\u200b\u5b9e\u73b0\u200b\uff0c\u200b\u7528\u4e8e\u200b\u4f20\u8f93\u200b\u5927\u91cf\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u6570\u636e\u200b\u7684\u200b\u6b63\u786e\u6027\u200b\u6709\u200b\u4fdd\u8bc1\u200b\uff0c\u200b\u65f6\u6548\u200b\u6ca1\u6709\u200b\u4fdd\u8bc1\u200b\u3002</p> <p>\u200b\u6279\u91cf\u200b\u4e8b\u52a1\u200b\u7531\u200b3\u200b\u4e2a\u200b\u9636\u6bb5\u200b(phase)\u200b\u7ec4\u6210\u200b\uff1a\u200b\u4ee4\u724c\u200b\u9636\u6bb5\u200b\u3001\u200b\u6570\u636e\u200b\u9636\u6bb5\u200b\u3001\u200b\u63e1\u624b\u200b\u9636\u6bb5\u200b\u3002\u200b\u6bcf\u4e2a\u200b\u9636\u6bb5\u200b\u90fd\u200b\u662f\u200b\u4e00\u4e2a\u200b\u5b8c\u6574\u200b\u7684\u200b\u5305\u200b\uff0c\u200b\u542b\u6709\u200bSOP\u3001SYNC\u3001PID\u3001EOP\u3002</p> <p>\u200b\u4e0b\u56fe\u200b\u4e2d\u200b\u5404\u4e2a\u200b\u77e9\u5f62\u6846\u200b\u5c31\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200b\u5b8c\u6574\u200b\u7684\u200b\u5305\u200b\u3002</p> <p></p> <p>\u300a\u200b\u5708\u5708\u200b\u6559\u200b\u4f60\u200b\u73a9\u200bUSB\u300b\u200b\u4e2d\u6709\u200b\u8be6\u7ec6\u200b\u7684\u200b\u793a\u4f8b\u200b\uff1a</p> <p></p>"},{"location":"12_USB/04_1/#244","title":"2.4.4 \u200b\u4e2d\u65ad\u200b\u4f20\u8f93","text":"<p>\u200b\u4e2d\u65ad\u200b\u4f20\u8f93\u200b\u7528\u200b\u4e2d\u65ad\u200b\u4e8b\u52a1\u200b\u6765\u200b\u5b9e\u73b0\u200b\uff0c\u200b\u7528\u4e8e\u200b\u4f20\u8f93\u200b\u5c0f\u91cf\u200b\u7684\u200b\u3001\u200b\u5468\u671f\u6027\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u6570\u636e\u200b\u7684\u200b\u6b63\u786e\u6027\u200b\u548c\u200b\u65f6\u6548\u200b\u90fd\u200b\u6709\u200b\u4fdd\u8bc1\u200b\u3002</p> <p>\u200b\u4e2d\u65ad\u200b\u4e8b\u52a1\u200b\u7531\u200b3\u200b\u4e2a\u200b\u9636\u6bb5\u200b(phase)\u200b\u7ec4\u6210\u200b\uff1a\u200b\u4ee4\u724c\u200b\u9636\u6bb5\u200b\u3001\u200b\u6570\u636e\u200b\u9636\u6bb5\u200b\u3001\u200b\u63e1\u624b\u200b\u9636\u6bb5\u200b\u3002\u200b\u6bcf\u4e2a\u200b\u9636\u6bb5\u200b\u90fd\u200b\u662f\u200b\u4e00\u4e2a\u200b\u5b8c\u6574\u200b\u7684\u200b\u5305\u200b\uff0c\u200b\u542b\u6709\u200bSOP\u3001SYNC\u3001PID\u3001EOP\u3002</p> <p>\u200b\u4e0b\u56fe\u200b\u4e2d\u200b\u5404\u4e2a\u200b\u77e9\u5f62\u6846\u200b\u5c31\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200b\u5b8c\u6574\u200b\u7684\u200b\u5305\u200b\u3002</p> <p></p> <p>\u200b\u4e2d\u65ad\u200b\u4e8b\u52a1\u200b\u8ddf\u200b\u6279\u91cf\u200b\u4e8b\u52a1\u200b\u975e\u5e38\u200b\u7c7b\u4f3c\u200b\uff0cHost\u200b\u4f7f\u7528\u200b\u5b83\u200b\u6765\u200b\u5468\u671f\u6027\u5730\u200b\u8bfb\u6570\u636e\u200b\u3001\u200b\u5199\u200b\u6570\u636e\u200b\u3002</p> <p>\u200b\u4ee5\u200b\u9f20\u6807\u200b\u4e3a\u4f8b\u200b\uff0c\u200b\u6211\u4eec\u200b\u9700\u8981\u200b\u53ca\u65f6\u200b\u83b7\u5f97\u200b\u9f20\u6807\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u4e0d\u200b\u53ca\u65f6\u200b\u7684\u8bdd\u200b\u4f60\u200b\u4f1a\u200b\u611f\u89c9\u200b\u9f20\u6807\u200b\u5f88\u200b\u8fdf\u949d\u200b\u3002\u200b\u4f46\u662f\u200bUSB\u200b\u534f\u8bae\u200b\u4e2d\u200b\u5e76\u200b\u6ca1\u6709\u200b\u4e2d\u65ad\u200b\u529f\u80fd\u200b\uff0c\u200b\u5b83\u200b\u4f7f\u7528\u200b\"\u200b\u5468\u671f\u6027\u200b\u7684\u200b\u8bfb\u200b\u3001\u200b\u5199\u200b\"\u200b\u6765\u200b\u5b9e\u73b0\u200b\u53ca\u65f6\u6027\u200b\u3002\u200b\u5177\u4f53\u200b\u8fc7\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>Host\u200b\u6bcf\u9694\u200bn\u200b\u6beb\u79d2\u200b\u53d1\u51fa\u200b\u4e00\u4e2a\u200bIN\u200b\u4ee4\u724c\u200b\u5305\u200b</li> <li>\u200b\u9f20\u6807\u200b\u6709\u200b\u6570\u636e\u200b\u7684\u8bdd\u200b\uff0c\u200b\u53d1\u51fa\u200bDATA0\u200b\u6216\u200bDATA1\u200b\u6570\u636e\u5305\u200b\u7ed9\u200bHost\uff1b\u200b\u9f20\u6807\u200b\u6ca1\u6709\u200b\u6570\u636e\u200b\u7684\u8bdd\u200b\uff0c\u200b\u53d1\u51fa\u200bNAK\u200b\u7ed9\u200bHost\u3002</li> </ul> <p>\u200b\u4e2d\u65ad\u200b\u4e8b\u52a1\u200b\u7684\u200b\u4f18\u5148\u7ea7\u200b\u6bd4\u200b\u6279\u91cf\u200b\u4e8b\u52a1\u200b\u66f4\u9ad8\u200b\uff0c\u200b\u5b83\u200b\u8981\u6c42\u200b\u5b9e\u65f6\u6027\u200b\uff0c\u200b\u800c\u200b\u6279\u91cf\u200b\u4e8b\u52a1\u200b\u4e0d\u200b\u8981\u6c42\u200b\u5b9e\u65f6\u6027\u200b\u3002</p>"},{"location":"12_USB/04_1/#245","title":"2.4.5 \u200b\u5b9e\u65f6\u200b\u4f20\u8f93","text":"<p>\u200b\u5b9e\u65f6\u200b\u4f20\u8f93\u200b\u7528\u200b\u5b9e\u65f6\u200b\u4e8b\u52a1\u200b\u6765\u200b\u5b9e\u73b0\u200b\uff0c\u200b\u7528\u4e8e\u200b\u4f20\u8f93\u200b\u5b9e\u65f6\u200b\u6570\u636e\u200b\uff0c\u200b\u5bf9\u200b\u6570\u636e\u200b\u7684\u200b\u6b63\u786e\u6027\u200b\u6ca1\u6709\u200b\u8981\u6c42\u200b\u3002</p> <p>\u200b\u5b9e\u65f6\u200b\u4e8b\u52a1\u200b\u7531\u200b2\u200b\u4e2a\u200b\u9636\u6bb5\u200b(phase)\u200b\u7ec4\u6210\u200b\uff1a\u200b\u4ee4\u724c\u200b\u9636\u6bb5\u200b\u3001\u200b\u6570\u636e\u200b\u9636\u6bb5\u200b\u3002\u200b\u6bcf\u4e2a\u200b\u9636\u6bb5\u200b\u90fd\u200b\u662f\u200b\u4e00\u4e2a\u200b\u5b8c\u6574\u200b\u7684\u200b\u5305\u200b\uff0c\u200b\u542b\u6709\u200bSOP\u3001SYNC\u3001PID\u3001EOP\u3002</p> <p>\u200b\u5b9e\u65f6\u200b\u4e8b\u52a1\u200b\u4e0d\u200b\u9700\u8981\u200b\u63e1\u624b\u200b\u9636\u6bb5\u200b\uff0c\u200b\u4e00\u4e2a\u200b\u793a\u4f8b\u200b\u7684\u200b\u573a\u666f\u200b\u662f\u200b\uff1a\u200b\u4e3a\u4e86\u200b\u4f20\u8f93\u200b\u6444\u50cf\u5934\u200b\u7684\u200b\u5b9e\u65f6\u200b\u6570\u636e\u200b\uff0c\u200b\u5076\u5c14\u200b\u7684\u200b\u6570\u636e\u200b\u9519\u8bef\u200b\u662f\u200b\u53ef\u4ee5\u200b\u5fcd\u53d7\u200b\u7684\u200b\uff0c\u200b\u5927\u4e0d\u4e86\u200b\u51fa\u73b0\u200b\u77ed\u6682\u200b\u7684\u200b\u82b1\u5c4f\u200b\u3002\u200b\u5982\u679c\u200b\u4e3a\u4e86\u200b\u89e3\u51b3\u200b\u82b1\u5c4f\u200b\u800c\u200b\u91cd\u4f20\u200b\u6570\u636e\u200b\uff0c\u200b\u90a3\u200b\u5c31\u200b\u4f1a\u200b\u5bfc\u81f4\u200b\u540e\u7eed\u200b\u753b\u9762\u200b\u88ab\u200b\u63a8\u8fdf\u200b\uff0c\u200b\u5b9e\u65f6\u6027\u200b\u65e0\u6cd5\u200b\u5f97\u5230\u200b\u4fdd\u8bc1\u200b\u3002</p> <p>\u200b\u4e0b\u56fe\u200b\u4e2d\u200b\u5404\u4e2a\u200b\u77e9\u5f62\u6846\u200b\u5c31\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200b\u5b8c\u6574\u200b\u7684\u200b\u5305\u200b\u3002</p> <p></p> <p>\u200b\u5b9e\u65f6\u200b\u4e8b\u52a1\u200b\u8ddf\u200b\u4e2d\u65ad\u200b\u4e8b\u52a1\u200b\u975e\u5e38\u200b\u7c7b\u4f3c\u200b\uff0cHost\u200b\u4e5f\u200b\u4f1a\u200b\u5468\u671f\u6027\u200b\u7684\u200b\u53d1\u8d77\u200b\u5b9e\u65f6\u200b\u4e8b\u52a1\u200b\uff0c\u200b\u4e3b\u8981\u200b\u533a\u522b\u200b\u5728\u4e8e\u200b\uff1a</p> <ul> <li>\u200b\u5b9e\u65f6\u200b\u4e8b\u52a1\u200b\u4e0d\u200b\u8981\u6c42\u200b\u51c6\u786e\u6027\u200b\uff0c\u200b\u6ca1\u6709\u200b\u63e1\u624b\u200b\u9636\u6bb5\u200b</li> <li>\u200b\u5b9e\u65f6\u200b\u4e8b\u52a1\u200b\u4f20\u8f93\u200b\u7684\u200b\u6570\u636e\u91cf\u200b\u6bd4\u8f83\u200b\u5927\u200b\uff0c\u200b\u4e2d\u65ad\u200b\u4e8b\u52a1\u200b\u4f20\u8f93\u200b\u7684\u200b\u6570\u636e\u91cf\u200b\u6bd4\u8f83\u200b\u5c0f\u200b</li> </ul>"},{"location":"12_USB/04_1/#246","title":"2.4.6 \u200b\u63a7\u5236\u4f20\u8f93","text":"<p>\u200b\u5728\u200b\u4f7f\u7528\u200b\u6279\u91cf\u200b\u4f20\u8f93\u200b\u65f6\u200b\uff0c\u200b\u4f7f\u7528\u200bIN\u200b\u4ee4\u724c\u200b\u5305\u200b\u6216\u200bOUT\u200b\u4ee4\u724c\u200b\u5305\u200b\u8868\u793a\u200b\u6570\u636e\u4f20\u8f93\u200b\u65b9\u5411\u200b\u3002</p> <p>\u200b\u63a7\u5236\u4f20\u8f93\u200b\u7684\u200b\u4ee4\u724c\u200b\u5305\u200b\u6c38\u8fdc\u200b\u662f\u200bSETUP\uff0c\u200b\u600e\u4e48\u200b\u5206\u8fa8\u200b\u662f\u200b\u8bfb\u6570\u636e\u200b\uff0c\u200b\u8fd8\u662f\u200b\u5199\u200b\u6570\u636e\u200b\uff1f\u200b\u53d1\u51fa\u200bSETUP\u200b\u4ee4\u724c\u200b\u5305\u540e\u200b\uff0c\u200b\u8fd8\u8981\u200b\u53d1\u51fa\u200bDATA0\u200b\u6570\u636e\u5305\u200b\uff0c\u200b\u6839\u636e\u200b\u6570\u636e\u200b\u7684\u200b\u5185\u5bb9\u200b\u6765\u200b\u786e\u5b9a\u200b\u540e\u7eed\u200b\u662f\u200b\u8bfb\u6570\u636e\u200b\uff0c\u200b\u8fd8\u662f\u200b\u5199\u200b\u6570\u636e\u200b\u3002\u200b\u8fd9\u4e2a\u200b\u8fc7\u7a0b\u200b\u79f0\u4e3a\u200b\"\u200b\u5efa\u7acb\u200b\u4e8b\u52a1\u200b\"(SETUP Transaction)</p> <p>\u200b\u4f46\u662f\u200b\u63a7\u5236\u4f20\u8f93\u200b\u7531\u200b\u591a\u4e2a\u200b\u4e8b\u52a1\u200b\u7ec4\u6210\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u4e8b\u52a1\u200b\u5206\u522b\u200b\u5904\u4e8e\u200b3\u200b\u4e2a\u200b\u8fc7\u7a0b\u200b\uff1a\u200b\u5efa\u7acb\u200b\u8fc7\u7a0b\u200b(stage)\u3001\u200b\u6570\u636e\u200b\u8fc7\u7a0b\u200b(stage)\u3001\u200b\u72b6\u6001\u200b\u8fc7\u7a0b\u200b(stage)\u3002</p> <ul> <li>\u200b\u5efa\u7acb\u200b\u8fc7\u7a0b\u200b(stage)\uff0c\u200b\u4f7f\u7528\u200bSETUP\u200b\u4e8b\u52a1\u200b\uff1aHost\u200b\u53d1\u51fa\u200bSETUP\u200b\u4ee4\u724c\u200b\u5305\u200b\u3001DATA0\u200b\u6570\u636e\u5305\u200b\u3001\u200b\u5f97\u5230\u200bACK\u200b\u63e1\u624b\u200b\u5305\u200b</li> <li>\u200b\u6570\u636e\u200b\u8fc7\u7a0b\u200b(stage)\uff0c\u200b\u4f7f\u7528\u200b\u6279\u91cf\u200b\u4e8b\u52a1\u200b\uff1a</li> <li>\u200b\u5bf9\u4e8e\u200b\u8f93\u51fa\u200b\uff1aHost\u200b\u53d1\u51fa\u200bOUT\u200b\u4ee4\u724c\u200b\u5305\u200b\uff0c\u200b\u53d1\u51fa\u200bDATA0\u3001DATA1\u200b\u6570\u636e\u5305\u200b\u3001\u200b\u5f97\u5230\u200bACK\u200b\u63e1\u624b\u200b\u5305\u200b</li> <li>\u200b\u5bf9\u4e8e\u200b\u8f93\u5165\u200b\uff1aHost\u200b\u53d1\u51fa\u200bIN\u200b\u4ee4\u724c\u200b\u5305\u200b\uff0c\u200b\u8bfb\u200b\u5230\u200bDATA0\u3001DATA1\u200b\u6570\u636e\u5305\u200b\u3001\u200b\u53d1\u51fa\u200bACK\u200b\u63e1\u624b\u200b\u5305\u200b</li> <li>\u200b\u72b6\u6001\u200b\u8fc7\u7a0b\u200b(stage)\uff0c\u200b\u4f7f\u7528\u200b\u6279\u91cf\u200b\u4e8b\u52a1\u200b\uff1a</li> <li>\u200b\u5bf9\u4e8e\u200b\u8f93\u51fa\u200b\uff1aHost\u200b\u53d1\u51fa\u200bIN\u200b\u4ee4\u724c\u200b\u5305\u200b\uff0c\u200b\u8bfb\u200b\u5230\u200bDATA1\u200b\u6570\u636e\u5305\u200b\uff0c\u200b\u53d1\u51fa\u200bACK\u200b\u63e1\u624b\u200b\u5305\u200b</li> <li>\u200b\u5bf9\u4e8e\u200b\u8f93\u5165\u200b\uff1aHost\u200b\u53d1\u51fa\u200bOUT\u200b\u4ee4\u724c\u200b\u5305\u200b\uff0c\u200b\u53d1\u51fa\u200bDATA1\u200b\u6570\u636e\u5305\u200b\uff0c\u200b\u7b49\u5f85\u200bACK\u200b\u63e1\u624b\u200b\u5305\u200b</li> </ul> <p></p> <p>\u200b\u4e0a\u56fe\u200b\u4e2d\u200b\u7684\u200b\u6bcf\u200b\u4e00\u4e2a\u200b\u65b9\u6846\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b\u4e00\u4e2a\u200b\u5b8c\u6574\u200b\u7684\u200b\u4e8b\u52a1\u200b\uff0c\u200b\u542b\u6709\u200b\uff1aToken Packet\u3001Data Packet\u3001Handshake Packet\u3002</p>"},{"location":"12_USB/04_1/#3","title":"3. \u200b\u4f7f\u7528\u200b\u5de5\u5177\u200b\u4f53\u9a8c\u200b\u6570\u636e\u683c\u5f0f","text":"<p>LeCroy(\u200b\u529b\u79d1\u200b)\u200b\u6210\u7acb\u200b\u4e8e\u200b1964\u200b\u5e74\u200b\uff0c\u200b\u662f\u200b\u4e00\u5bb6\u200b\u4e13\u4e1a\u200b\u751f\u4ea7\u200b\u793a\u6ce2\u5668\u200b\u5382\u5bb6\u200b\u3002\u200b\u65d7\u4e0b\u200b\u751f\u4ea7\u200b\u6709\u200b\u6570\u5b57\u200b\u793a\u6ce2\u5668\u200b\u3001SDA\u200b\u7cfb\u5217\u200b\u6570\u5b57\u200b\u793a\u6ce2\u5668\u200b\u3001\u200b\u6df7\u5408\u200b\u4fe1\u53f7\u200b\u793a\u6ce2\u5668\u200b\u3001\u200b\u6a21\u5757\u5316\u200b\u4eea\u5668\u200b\u3001\u200b\u4efb\u610f\u200b\u6ce2\u5f62\u53d1\u751f\u5668\u200b\u3002 \u200b\u5b98\u7f51\u200b\u662f\u200b\uff1ahttps://teledynelecroy.com/\uff0c\u200b\u4f3c\u4e4e\u200b\u65e0\u6cd5\u200b\u6ce8\u518c\u200b\u65b0\u200b\u7528\u6237\u200b\uff0c\u200b\u65e0\u6cd5\u200b\u4e0b\u8f7d\u200b\u8f6f\u4ef6\u200b\u3002 \u200b\u53ef\u4ee5\u200b\u5728\u200b\u641c\u7d22\u5f15\u64ce\u200b\u91cc\u200b\u641c\u200b\"usbprotocolsuite\"\u3002</p> <p>\u200b\u5b89\u88c5\u200b\"usbprotocolsuite\"\u200b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5728\u200b\u6587\u6863\u200b\u76ee\u5f55\u200b\u91cc\u200b\u627e\u200b\u6253\u200b\u5f88\u591a\u200b\u793a\u200b\u7a0b\u5e8f\u200b(\u200b\u540e\u7f00\u540d\u200b\u4e3a\u200busb)\uff1a</p> <p></p> <p>\u200b\u4f7f\u7528\u200b\"usbprotocolsuite\"\u200b\u6253\u5f00\u200b\u8fd9\u4e9b\u200b\u6587\u4ef6\u200b\uff0c\u200b\u5373\u53ef\u200b\u4f53\u9a8c\u200bUSB\u200b\u6570\u636e\u4f20\u8f93\u200b\uff1a</p> <p></p>"},{"location":"12_USB/05_1/","title":"USB\u200b\u63cf\u8ff0\u7b26","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u300a\u200b\u5708\u5708\u200b\u6559\u200b\u4f60\u200b\u73a9\u200bUSB\u300b</li> <li>\u200b\u7b80\u4e66\u200bjianshu_kevin@126.com\u200b\u7684\u200b\u6587\u7ae0\u200b</li> <li>USB\u200b\u534f\u8bae\u200b\uff08\u200b\u4e00\u200b\uff09</li> <li>USB\u200b\u534f\u8bae\u200b(\u200b\u4e8c\u200b)</li> <li>USB\u200b\u534f\u8bae\u200b(\u200b\u4e09\u200b)</li> <li>\u200b\u5b98\u7f51\u200b\uff1ahttps://www.usb.org/documents </li> <li>\u300ausb_20.pdf\u300b\u200b\u7684\u200b\u300aChapter 9  USB Device Framework\u300b</li> </ul>"},{"location":"12_USB/05_1/#1-usb","title":"1. USB\u200b\u8bbe\u5907\u200b\u72b6\u6001\u200b\u5207\u6362\u200b\u56fe","text":""},{"location":"12_USB/05_1/#2","title":"2. \u200b\u6807\u51c6\u200b\u8bbe\u5907\u200b\u8bf7\u6c42","text":""},{"location":"12_USB/05_1/#21-setup","title":"2.1 SETUP\u200b\u4e8b\u52a1\u200b\u7684\u200b\u6570\u636e\u683c\u5f0f","text":"<p>Host\u200b\u4f7f\u7528\u200b\u63a7\u5236\u4f20\u8f93\u200b\u6765\u200b\u8bc6\u522b\u200b\u8bbe\u5907\u200b\u3001\u200b\u8bbe\u7f6e\u200b\u8bbe\u5907\u200b\u5730\u5740\u200b\u3001\u200b\u542f\u52a8\u200b\u8bbe\u5907\u200b\u7684\u200b\u67d0\u4e9b\u200b\u7279\u6027\u200b\uff0c\u200b\u5bf9\u4e8e\u200b\u63a7\u5236\u4f20\u8f93\u200b\uff0c\u200b\u5b83\u200b\u9996\u5148\u200b\u53d1\u51fa\u200b\"setup\u200b\u4e8b\u52a1\u200b\"\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u5728\u200b\"setup\u200b\u4e8b\u52a1\u200b\"\u200b\u4e2d\u200b\uff0c</p> <ul> <li>SETUP\u200b\u4ee4\u724c\u200b\u5305\u200b\uff1a\u200b\u7528\u6765\u200b\u901a\u77e5\u200b\u8bbe\u5907\u200b\uff0c\"\u200b\u8981\u200b\u5f00\u59cb\u200b\u4f20\u8f93\u200b\u4e86\u200b\"</li> <li>DATA0\u200b\u6570\u636e\u5305\u200b\uff1a\u200b\u5b83\u200b\u542b\u6709\u200b\u56fa\u5b9a\u200b\u7684\u200b\u683c\u5f0f\u200b\uff0c\u200b\u7528\u6765\u200b\u544a\u8bc9\u200b\u8bbe\u5907\u200b\"\u200b\u662f\u200b\u8bfb\u200b\u8fd8\u662f\u200b\u5199\u200b\"\u3001\"\u200b\u8bfb\u200b\u4ec0\u4e48\u200b\"\u3001\"\u200b\u5199\u200b\u4ec0\u4e48\u200b\"</li> </ul> <p>Hos\u200b\u901a\u8fc7\u200bDATA0\u200b\u6570\u636e\u5305\u200b\u53d1\u9001\u200b8\u200b\u5b57\u8282\u200b\u6570\u636e\u200b\u7ed9\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b\uff1a</p> <p></p>"},{"location":"12_USB/05_1/#22","title":"2.2 \u200b\u6807\u51c6\u200b\u8bbe\u5907\u200b\u8bf7\u6c42","text":"<p>\u200b\u63a7\u5236\u4f20\u8f93\u200b\u7684\u200b\u5efa\u7acb\u200b\u4e8b\u52a1\u200b\u4e2d\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u4e0b\u5217\u200b\u683c\u5f0f\u200b\u7684\u200b\u6570\u636e\u200b\uff1a</p> <p></p> <p>\u200b\u4e0a\u8868\u200b\u4e2d\u200b\u5404\u4e2a\u200b\"\u200b\u5b8f\u200b\"\u200b\u53d6\u503c\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"12_USB/05_1/#22_1","title":"2.2 \u200b\u8bbe\u5907\u200b/\u200b\u914d\u7f6e\u200b/\u200b\u63a5\u53e3\u200b/\u200b\u7aef\u70b9","text":"<p>\u200b\u5728\u200bSETUP\u200b\u4e8b\u52a1\u200b\u7684\u200b\u6570\u636e\u200b\u91cc\u200b\uff0c\u200b\u8868\u793a\u200b\u4e86\u200b\u8981\u200b\u8bbf\u95ee\u200b\u7684\u200b\u662f\u200b\u4ec0\u4e48\u200b\uff1aDevice\uff1fInterface\uff1fEndpoint\uff1f</p> <p>\u200b\u5bf9\u4e8e\u200b\u4e00\u4e2a\u200bUSB\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5b83\u200b\u53ef\u4ee5\u200b\u591a\u79cd\u200b\u914d\u7f6e\u200b(Configuration)\u3002\u200b\u6bd4\u5982\u200b4G\u200b\u4e0a\u7f51\u5361\u200b\u5c31\u200b\u6709\u200b2\u200b\u79cd\u200b\u914d\u7f6e\u200b\uff1aU\u200b\u76d8\u200b\u3001\u200b\u4e0a\u7f51\u5361\u200b\u3002\u200b\u7b2c\u200b1\u200b\u6b21\u200b\u628a\u200b4G\u200b\u4e0a\u7f51\u5361\u200b\u63d2\u5165\u200b\u7535\u8111\u200b\u65f6\u200b\uff0c\u200b\u5b83\u200b\u662f\u200b\u4e00\u4e2a\u200bU\u200b\u76d8\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u6309\u7167\u200b\u91cc\u9762\u200b\u7684\u200b\u7a0b\u5e8f\u200b\u3002\u200b\u88c5\u200b\u597d\u200b\u7a0b\u5e8f\u200b\u540e\u200b\uff0c\u200b\u628a\u200b\u5b83\u200b\u518d\u6b21\u200b\u63d2\u5165\u200b\u7535\u8111\u200b\uff0c\u200b\u5b83\u200b\u5c31\u662f\u200b\u4e00\u4e2a\u200b\u4e0a\u7f51\u5361\u200b\u3002\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u53ef\u4ee5\u200b\u9009\u62e9\u200b\u8ba9\u200b\u5b83\u200b\u5de5\u4f5c\u200b\u4e8e\u200b\u54ea\u79cd\u200b\u914d\u7f6e\u200b\uff0c\u200b\u540c\u4e00\u65f6\u95f4\u200b\u53ea\u80fd\u200b\u6709\u200b\u4e00\u79cd\u200b\u914d\u7f6e\u200b\u3002\u200b\u5927\u591a\u6570\u200b\u7684\u200bUSB\u200b\u8bbe\u5907\u200b\u53ea\u6709\u200b\u4e00\u79cd\u200b\u914d\u7f6e\u200b\u3002</p> <p>\u200b\u4e00\u4e2a\u200b\u914d\u7f6e\u200b\u4e0b\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u6709\u200b\u591a\u4e2a\u200b\u63a5\u53e3\u200b(Interface)\uff0c\u200b\u63a5\u53e3\u200b\u7b49\u540c\u4e8e\u200b\u529f\u80fd\u200b(Function)\u3002\u200b\u6bd4\u5982\u200bUSB\u200b\u8033\u673a\u200b\u6709\u200b\u4e24\u4e2a\u200b\u63a5\u53e3\u200b(\u200b\u529f\u80fd\u200b)\uff1a\u200b\u58f0\u97f3\u200b\u6536\u53d1\u200b\u3001\u200b\u6309\u952e\u200b\u63a7\u5236\u200b\u3002</p> <p>\u200b\u4e00\u4e2a\u200b\u63a5\u53e3\u200b\uff0c\u200b\u53ef\u80fd\u200b\u6709\u200b\u591a\u4e2a\u200b\u8bbe\u7f6e\u200b(Setting)\uff0c\u200b\u6bd4\u5982\u200b\u9ed8\u8ba4\u8bbe\u7f6e\u200b\u4e0b\u200b\u5b83\u200b\u4f7f\u7528\u200b\u8f83\u200b\u4f4e\u200b\u7684\u200b\u5e26\u5bbd\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u9009\u62e9\u200b\u5176\u4ed6\u200b\u8bbe\u7f6e\u200b\u4ee5\u200b\u4f7f\u7528\u200b\u66f4\u200b\u9ad8\u5e26\u5bbd\u200b\u3002</p> <p>\u200b\u4e00\u4e2a\u200b\u63a5\u53e3\u200b\uff0c\u200b\u7531\u200b\u4e00\u4e2a\u200b\u6216\u200b\u591a\u4e2a\u200b\u7aef\u70b9\u200b(Endpoint)\u200b\u7ec4\u6210\u200b\u3002\u200b\u7aef\u70b9\u200b0\u200b\u5c5e\u4e8e\u200b\u6574\u4e2a\u200b\u8bbe\u5907\u200b\u7684\u200b\uff0c\u200b\u7aef\u70b9\u200b0\u200b\u662f\u200b\u53cc\u5411\u200b\u7684\u200b\u3002\u200b\u63a5\u53e3\u200b\u8fd8\u200b\u53ef\u4ee5\u200b\u6709\u200b\u5176\u4ed6\u200b\u7aef\u70b9\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u7aef\u70b9\u200b\u662f\u200b\u5355\u5411\u200b\u7684\u200b\uff0c\u200b\u8981\u4e48\u200b\u662f\u200b\u6279\u91cf\u200b(Bulk)\u200b\u7aef\u70b9\u200b\u3001\u200b\u8981\u4e48\u200b\u662f\u200b\u4e2d\u65ad\u200b(Interrupt)\u200b\u7aef\u70b9\u200b\u3001\u200b\u8981\u4e48\u200b\u662f\u200b\u540c\u6b65\u200b(Isochronous)\u200b\u7aef\u70b9\u200b\u3002</p>"},{"location":"12_USB/05_1/#3","title":"3. \u200b\u63cf\u8ff0\u7b26","text":"<p>\u200b\u600e\u4e48\u200b\u63cf\u8ff0\u200b\u8bbe\u5907\u200b\u3001\u200b\u914d\u7f6e\u200b\u3001\u200b\u63a5\u53e3\u200b\u3001\u200b\u7aef\u70b9\u200b\uff1f\u200b\u4f7f\u7528\u200b\u63cf\u8ff0\u7b26\u200b(Descriptors)\uff0c\u200b\u6709\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b\u3001\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26\u200b\u3001\u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26\u200b\u3001\u200b\u7aef\u70b9\u200b\u63cf\u8ff0\u7b26\u200b\u3002\u200b\u6240\u8c13\u200b\u63cf\u8ff0\u7b26\u200b\uff0c\u200b\u5c31\u662f\u200b\u4e00\u4e9b\u200b\u683c\u5f0f\u5316\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u7528\u6765\u200b\u63cf\u8ff0\u200b\u4fe1\u606f\u200b\u3002 \u200b\u4e00\u4e2a\u200bUSB\u200b\u8bbe\u5907\u200b\uff0c</p> <ul> <li>\u200b\u53ea\u6709\u200b\u4e00\u4e2a\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b\uff1a\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u8bbe\u5907\u200b\u7684\u200bID\u3001\u200b\u5b83\u200b\u6709\u200b\u591a\u5c11\u200b\u4e2a\u200b\u914d\u7f6e\u200b\u3001\u200b\u5b83\u200b\u7684\u200b\u7aef\u70b9\u200b0\u200b\u4e00\u6b21\u200b\u6700\u5927\u200b\u80fd\u200b\u4f20\u8f93\u200b\u591a\u5c11\u200b\u5b57\u8282\u200b\u6570\u636e\u200b</li> <li>\u200b\u53ef\u80fd\u200b\u6709\u200b\u591a\u4e2a\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26\u200b\uff1a\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u5b83\u200b\u6709\u200b\u591a\u5c11\u200b\u4e2a\u200b\u63a5\u53e3\u200b\u3001\u200b\u4f9b\u7535\u200b\u65b9\u5f0f\u200b\u3001\u200b\u6700\u5927\u200b\u7535\u6d41\u200b</li> <li>\u200b\u4e00\u4e2a\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26\u200b\u4e0b\u9762\u200b\uff0c\u200b\u53ef\u80fd\u200b\u6709\u200b\u591a\u4e2a\u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26\u200b\uff1a\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u5b83\u200b\u662f\u200b\u54ea\u7c7b\u200b\u63a5\u53e3\u200b\u3001\u200b\u6709\u200b\u51e0\u4e2a\u200b\u8bbe\u7f6e\u200b(Setting)\u3001\u200b\u6709\u200b\u51e0\u4e2a\u200b\u7aef\u70b9\u200b</li> <li>\u200b\u4e00\u4e2a\u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26\u200b\u7b26\u200b\u4e0b\u9762\u200b\uff0c\u200b\u53ef\u80fd\u200b\u6709\u200b\u591a\u4e2a\u200b\u7aef\u70b9\u200b\u63cf\u8ff0\u7b26\u200b\uff1a\u200b\u7528\u6765\u200b\u8868\u793a\u200b\u7aef\u70b9\u200b\u53f7\u200b\u3001\u200b\u65b9\u5411\u200b(IN/OUT)\u3001\u200b\u7c7b\u578b\u200b(\u200b\u6279\u91cf\u200b/\u200b\u4e2d\u65ad\u200b/\u200b\u540c\u6b65\u200b)</li> </ul> <p>\u200b\u8fd8\u6709\u200b\u4e00\u4e9b\u200b\u5b57\u7b26\u4e32\u200b\u63cf\u8ff0\u7b26\u200b(String descriptors)\uff0c\u200b\u5b83\u7528\u200b\u53ef\u8bfb\u200b\u7684\u200b\u6587\u5b57\u200b\u6765\u200b\u63cf\u8ff0\u200b\u8bbe\u5907\u200b\uff0c\u200b\u662f\u200b\u53ef\u9009\u200b\u7684\u200b\u3002</p> <p></p>"},{"location":"12_USB/05_1/#31","title":"3.1 \u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26","text":""},{"location":"12_USB/05_1/#32","title":"3.2 \u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26","text":""},{"location":"12_USB/05_1/#33","title":"3.3 \u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26","text":""},{"location":"12_USB/05_1/#34","title":"3.4 \u200b\u7aef\u70b9\u200b\u63cf\u8ff0\u7b26","text":""},{"location":"12_USB/05_1/#35","title":"3.5 \u200b\u793a\u4f8b","text":"<p>\u200b\u5728\u200bUbuntu\u200b\u4e2d\u200b\u53ef\u4ee5\u200b\u6267\u884c\u200b<code>lsusb -v</code>\u200b\u67e5\u770b\u200bUSB\u200b\u8bbe\u5907\u200b\u7684\u200b\u63cf\u8ff0\u7b26\u200b\u4fe1\u606f\u200b\uff1a</p> <pre><code>book@100ask:~$ sudo lsusb -v\n[sudo] password for book:\n\nBus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub\nDevice Descriptor:\n  bLength                18\n  bDescriptorType         1\n  bcdUSB               2.00\n  bDeviceClass            9 Hub\n  bDeviceSubClass         0 Unused\n  bDeviceProtocol         0 Full speed (or root) hub\n  bMaxPacketSize0        64\n  idVendor           0x1d6b Linux Foundation\n  idProduct          0x0002 2.0 root hub\n  bcdDevice            5.04\n  iManufacturer           3 Linux 5.4.0-124-generic ehci_hcd\n  iProduct                2 EHCI Host Controller\n  iSerial                 1 0000:02:03.0\n  bNumConfigurations      1\n  Configuration Descriptor:\n    bLength                 9\n    bDescriptorType         2\n    wTotalLength           25\n    bNumInterfaces          1\n    bConfigurationValue     1\n    iConfiguration          0\n    bmAttributes         0xe0\n      Self Powered\n      Remote Wakeup\n    MaxPower                0mA\n    Interface Descriptor:\n      bLength                 9\n      bDescriptorType         4\n      bInterfaceNumber        0\n      bAlternateSetting       0\n      bNumEndpoints           1\n      bInterfaceClass         9 Hub\n      bInterfaceSubClass      0 Unused\n      bInterfaceProtocol      0 Full speed (or root) hub\n      iInterface              0\n      Endpoint Descriptor:\n        bLength                 7\n        bDescriptorType         5\n        bEndpointAddress     0x81  EP 1 IN\n        bmAttributes            3\n          Transfer Type            Interrupt\n          Synch Type               None\n          Usage Type               Data\n        wMaxPacketSize     0x0004  1x 4 bytes\n        bInterval              12\nHub Descriptor:\n  bLength               9\n  bDescriptorType      41\n  nNbrPorts             6\n  wHubCharacteristic 0x000a\n    No power switching (usb 1.0)\n    Per-port overcurrent protection\n  bPwrOn2PwrGood       10 * 2 milli seconds\n  bHubContrCurrent      0 milli Ampere\n  DeviceRemovable    0x00\n  PortPwrCtrlMask    0xff\n Hub Port Status:\n   Port 1: 0000.0100 power\n   Port 2: 0000.0100 power\n   Port 3: 0000.0100 power\n   Port 4: 0000.0100 power\n   Port 5: 0000.0100 power\n   Port 6: 0000.0100 power\nDevice Status:     0x0001\n  Self Powered\n\nBus 002 Device 003: ID 0e0f:0002 VMware, Inc. Virtual USB Hub\nDevice Descriptor:\n  bLength                18\n  bDescriptorType         1\n  bcdUSB               1.10\n  bDeviceClass            9 Hub\n  bDeviceSubClass         0 Unused\n  bDeviceProtocol         0 Full speed (or root) hub\n  bMaxPacketSize0         8\n  idVendor           0x0e0f VMware, Inc.\n  idProduct          0x0002 Virtual USB Hub\n  bcdDevice            1.00\n  iManufacturer           1 VMware, Inc.\n  iProduct                2 VMware Virtual USB Hub\n  iSerial                 0\n  bNumConfigurations      1\n  Configuration Descriptor:\n    bLength                 9\n    bDescriptorType         2\n    wTotalLength           25\n    bNumInterfaces          1\n    bConfigurationValue     1\n    iConfiguration          1 VMware, Inc.\n    bmAttributes         0xe0\n      Self Powered\n      Remote Wakeup\n    MaxPower                0mA\n    Interface Descriptor:\n      bLength                 9\n      bDescriptorType         4\n      bInterfaceNumber        0\n      bAlternateSetting       0\n      bNumEndpoints           1\n      bInterfaceClass         9 Hub\n      bInterfaceSubClass      0 Unused\n      bInterfaceProtocol      0 Full speed (or root) hub\n      iInterface              1 VMware, Inc.\n      Endpoint Descriptor:\n        bLength                 7\n        bDescriptorType         5\n        bEndpointAddress     0x81  EP 1 IN\n        bmAttributes            3\n          Transfer Type            Interrupt\n          Synch Type               None\n          Usage Type               Data\n        wMaxPacketSize     0x0001  1x 1 bytes\n        bInterval             255\nHub Descriptor:\n  bLength               9\n  bDescriptorType      41\n  nNbrPorts             7\n  wHubCharacteristic 0x0009\n    Per-port power switching\n    Per-port overcurrent protection\n  bPwrOn2PwrGood       50 * 2 milli seconds\n  bHubContrCurrent    100 milli Ampere\n  DeviceRemovable    0x00\n  PortPwrCtrlMask    0xfe\n Hub Port Status:\n   Port 1: 0000.0100 power\n   Port 2: 0000.0100 power\n   Port 3: 0000.0100 power\n   Port 4: 0000.0100 power\n   Port 5: 0000.0100 power\n   Port 6: 0000.0100 power\n   Port 7: 0000.0100 power\nDevice Status:     0x2909\n  Self Powered\n\nBus 002 Device 002: ID 0e0f:0003 VMware, Inc. Virtual Mouse\nDevice Descriptor:\n  bLength                18\n  bDescriptorType         1\n  bcdUSB               1.10\n  bDeviceClass            0 (Defined at Interface level)\n  bDeviceSubClass         0\n  bDeviceProtocol         0\n  bMaxPacketSize0         8\n  idVendor           0x0e0f VMware, Inc.\n  idProduct          0x0003 Virtual Mouse\n  bcdDevice            1.03\n  iManufacturer           1 VMware\n  iProduct                2 VMware Virtual USB Mouse\n  iSerial                 0\n  bNumConfigurations      1\n  Configuration Descriptor:\n    bLength                 9\n    bDescriptorType         2\n    wTotalLength           34\n    bNumInterfaces          1\n    bConfigurationValue     1\n    iConfiguration          1 VMware\n    bmAttributes         0xc0\n      Self Powered\n    MaxPower                0mA\n    Interface Descriptor:\n      bLength                 9\n      bDescriptorType         4\n      bInterfaceNumber        0\n      bAlternateSetting       0\n      bNumEndpoints           1\n      bInterfaceClass         3 Human Interface Device\n      bInterfaceSubClass      1 Boot Interface Subclass\n      bInterfaceProtocol      2 Mouse\n      iInterface              1 VMware\n        HID Device Descriptor:\n          bLength                 9\n          bDescriptorType        33\n          bcdHID               1.10\n          bCountryCode            0 Not supported\n          bNumDescriptors         1\n          bDescriptorType        34 Report\n          wDescriptorLength      46\n         Report Descriptors:\n           ** UNAVAILABLE **\n      Endpoint Descriptor:\n        bLength                 7\n        bDescriptorType         5\n        bEndpointAddress     0x81  EP 1 IN\n        bmAttributes            3\n          Transfer Type            Interrupt\n          Synch Type               None\n          Usage Type               Data\n        wMaxPacketSize     0x0008  1x 8 bytes\n        bInterval               1\nDevice Status:     0x0001\n  Self Powered\n\nBus 002 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub\nDevice Descriptor:\n  bLength                18\n  bDescriptorType         1\n  bcdUSB               1.10\n  bDeviceClass            9 Hub\n  bDeviceSubClass         0 Unused\n  bDeviceProtocol         0 Full speed (or root) hub\n  bMaxPacketSize0        64\n  idVendor           0x1d6b Linux Foundation\n  idProduct          0x0001 1.1 root hub\n  bcdDevice            5.04\n  iManufacturer           3 Linux 5.4.0-124-generic uhci_hcd\n  iProduct                2 UHCI Host Controller\n  iSerial                 1 0000:02:00.0\n  bNumConfigurations      1\n  Configuration Descriptor:\n    bLength                 9\n    bDescriptorType         2\n    wTotalLength           25\n    bNumInterfaces          1\n    bConfigurationValue     1\n    iConfiguration          0\n    bmAttributes         0xe0\n      Self Powered\n      Remote Wakeup\n    MaxPower                0mA\n    Interface Descriptor:\n      bLength                 9\n      bDescriptorType         4\n      bInterfaceNumber        0\n      bAlternateSetting       0\n      bNumEndpoints           1\n      bInterfaceClass         9 Hub\n      bInterfaceSubClass      0 Unused\n      bInterfaceProtocol      0 Full speed (or root) hub\n      iInterface              0\n      Endpoint Descriptor:\n        bLength                 7\n        bDescriptorType         5\n        bEndpointAddress     0x81  EP 1 IN\n        bmAttributes            3\n          Transfer Type            Interrupt\n          Synch Type               None\n          Usage Type               Data\n        wMaxPacketSize     0x0002  1x 2 bytes\n        bInterval             255\nHub Descriptor:\n  bLength               9\n  bDescriptorType      41\n  nNbrPorts             2\n  wHubCharacteristic 0x000a\n    No power switching (usb 1.0)\n    Per-port overcurrent protection\n  bPwrOn2PwrGood        1 * 2 milli seconds\n  bHubContrCurrent      0 milli Ampere\n  DeviceRemovable    0x00\n  PortPwrCtrlMask    0xff\n Hub Port Status:\n   Port 1: 0000.0103 power enable connect\n   Port 2: 0000.0107 power suspend enable connect\nDevice Status:     0x0001\n  Self Powered\n</code></pre>"},{"location":"12_USB/05_1/#4","title":"4. \u200b\u8bbe\u5907\u200b\u679a\u4e3e\u200b\u8fc7\u7a0b\u200b\u793a\u4f8b","text":"<p>\u200b\u4f7f\u7528\u200b\"usbprotocolsuite\"\u200b\u6253\u5f00\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200b\u8bbe\u5907\u200b\u7684\u200b\u679a\u4e3e\u200b\u8fc7\u7a0b\u200b\uff1a</p> <ul> <li>\u200b\u4f7f\u7528\u200b\u63a7\u5236\u4f20\u8f93\u200b\uff0c\u200b\u8bfb\u53d6\u200b\u8bbe\u5907\u200b\u4fe1\u606f\u200b(\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b)\uff1a\u200b\u7b2c\u4e00\u6b21\u200b\u8bfb\u53d6\u200b\u65f6\u200b\uff0c\u200b\u5b83\u200b\u53ea\u200b\u9700\u8981\u200b\u5f97\u5230\u200b8\u200b\u5b57\u8282\u200b\u6570\u636e\u200b\uff0c\u200b\u56e0\u4e3a\u200b\u7b2c\u200b8\u200b\u4e2a\u200b\u6570\u636e\u8868\u793a\u200b\u7aef\u70b9\u200b0\u200b\u80fd\u200b\u4f20\u8f93\u200b\u7684\u200b\u6700\u5927\u200b\u6570\u636e\u200b\u957f\u5ea6\u200b\u3002   </li> <li>Host\u200b\u5206\u914d\u200b\u5730\u5740\u200b\u7ed9\u200b\u8bbe\u5907\u200b\uff0c\u200b\u7136\u540e\u200b\u628a\u200b\u65b0\u200b\u5730\u5740\u200b\u53d1\u7ed9\u200b\u8bbe\u5907\u200b\uff1a   </li> <li>\u200b\u4f7f\u7528\u200b\u65b0\u200b\u5730\u5740\u200b\uff0c\u200b\u91cd\u65b0\u200b\u8bfb\u53d6\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b\uff0c\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b\u957f\u5ea6\u200b\u662f\u200b18\uff1a   </li> <li>\u200b\u8bfb\u53d6\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26\u200b\uff1a\u200b\u5b83\u200b\u4f20\u5165\u200b\u7684\u200b\u957f\u5ea6\u200b\u662f\u200b255\uff0c\u200b\u60f3\u200b\u4e00\u6b21\u6027\u200b\u628a\u200b\u5f53\u524d\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26\u200b\u3001\u200b\u5b83\u200b\u4e0b\u9762\u200b\u7684\u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26\u200b\u3001\u200b\u7aef\u70b9\u200b\u63cf\u8ff0\u7b26\u200b\u5168\u90e8\u200b\u8bfb\u51fa\u6765\u200b   </li> <li>\u200b\u8bfb\u53d6\u200b\u5b57\u7b26\u200b\u63cf\u8ff0\u7b26\u200b</li> </ul> <p></p>"},{"location":"12_USB/06_1/","title":"libusb\u200b\u7684\u200b\u4f7f\u7528","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u300a\u200b\u5708\u5708\u200b\u6559\u200b\u4f60\u200b\u73a9\u200bUSB\u300b</li> <li>\u200b\u7b80\u4e66\u200bjianshu_kevin@126.com\u200b\u7684\u200b\u6587\u7ae0\u200b</li> <li>USB\u200b\u534f\u8bae\u200b\uff08\u200b\u4e00\u200b\uff09</li> <li>USB\u200b\u534f\u8bae\u200b(\u200b\u4e8c\u200b)</li> <li>USB\u200b\u534f\u8bae\u200b(\u200b\u4e09\u200b)</li> <li>\u200b\u5b98\u7f51\u200b\uff1ahttps://www.usb.org/documents </li> <li>libusb GIT\u200b\u4ed3\u5e93\u200b\uff1ahttps://github.com/libusb/libusb.git</li> <li>libusb \u200b\u5b98\u7f51\u200b\uff1ahttps://libusb.info/</li> <li>libusb API\u200b\u63a5\u53e3\u200b\uff1ahttps://libusb.sourceforge.io/api-1.0/</li> <li>libusb \u200b\u793a\u4f8b\u200b\uff1ahttps://github.com/libusb/libusb/tree/master/examples</li> </ul>"},{"location":"12_USB/06_1/#1","title":"1. \u200b\u6982\u8ff0","text":""},{"location":"12_USB/06_1/#11","title":"1.1 \u200b\u4ecb\u7ecd","text":"<p>libusb\u200b\u662f\u200b\u4e00\u4e2a\u200b\u4f7f\u7528\u200bC\u200b\u7f16\u5199\u200b\u7684\u200b\u5e93\u200b\uff0c\u200b\u5b83\u200b\u63d0\u4f9b\u200bUSB\u200b\u8bbe\u5907\u200b\u7684\u200b\u901a\u7528\u200b\u7684\u200b\u8bbf\u95ee\u200b\u65b9\u6cd5\u200b\u3002APP\u200b\u901a\u8fc7\u200b\u5b83\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u65b9\u4fbf\u200b\u5730\u200b\u8bbf\u95ee\u200bUSB\u200b\u8bbe\u5907\u200b\uff0c\u200b\u65e0\u9700\u200b\u7f16\u5199\u200bUSB\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u3002</p> <ul> <li>\u200b\u53ef\u79fb\u690d\u6027\u200b\uff1a\u200b\u652f\u6301\u200bLinux\u3001macOS\u3001Windows\u3001Android\u3001OpenBSD\u200b\u7b49\u200b</li> <li>\u200b\u7528\u6237\u200b\u6a21\u5f0f\u200b\uff1aAPP\u200b\u4e0d\u200b\u9700\u8981\u200b\u7279\u6743\u200b\u6a21\u5f0f\u200b\u3001\u200b\u4e5f\u200b\u4e0d\u200b\u9700\u8981\u200b\u63d0\u5347\u200b\u81ea\u5df1\u200b\u7684\u200b\u6743\u9650\u200b\u5373\u53ef\u200b\u8bbf\u95ee\u200bUSB\u200b\u8bbe\u5907\u200b</li> <li>\u200b\u652f\u6301\u200b\u6240\u6709\u200bUSB\u200b\u534f\u8bae\u200b\uff1a\u200b\u4ece\u200b1.0\u200b\u5230\u200b3.1\u200b\u90fd\u200b\u652f\u6301\u200b</li> </ul> <p>libusb\u200b\u652f\u6301\u200b\u6240\u6709\u200b\u7684\u200b\u4f20\u8f93\u200b\u7c7b\u578b\u200b(\u200b\u63a7\u5236\u200b/\u200b\u6279\u91cf\u200b/\u200b\u4e2d\u65ad\u200b/\u200b\u5b9e\u65f6\u200b)\uff0c\u200b\u6709\u200b\u4e24\u7c7b\u200bAPI\u200b\u63a5\u53e3\u200b\uff1a\u200b\u540c\u6b65\u200b(Synchronous\uff0c\u200b\u7b80\u5355\u200b)\uff0c\u200b\u5f02\u6b65\u200b(Asynchronous\uff0c\u200b\u590d\u6742\u200b\u4f46\u662f\u200b\u66f4\u200b\u5f3a\u5927\u200b)\u3002\u200b\u5b83\u200b\u662f\u200b\u8f7b\u91cf\u7ea7\u200b\u7684\u200b\u3001\u200b\u7ebf\u7a0b\u200b\u5b89\u5168\u200b\u7684\u200b\u3002\u200b\u8fd8\u200b\u652f\u6301\u200b\u70ed\u62d4\u200b\u63d2\u200b\u3002</p>"},{"location":"12_USB/06_1/#12","title":"1.2 \u200b\u7528\u6cd5","text":"<p>\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200blibusb\u200b\u8bbf\u95ee\u200bUSB\u200b\u8bbe\u5907\u200b\uff0c\u200b\u4e0d\u200b\u9700\u8981\u200bUSB\u200b\u8bbe\u5907\u200b\u7aef\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u9700\u8981\u200b\u79fb\u9664\u200b\u539f\u6765\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u3002\u200b\u7136\u540e\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u76f4\u63a5\u200b\u8bbf\u95ee\u200bUSB\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u4f7f\u7528\u200bopen/read/write/ioctl/close\u200b\u8fd9\u4e9b\u200b\u63a5\u53e3\u200b\u6765\u200b\u6253\u5f00\u200b\u8bbe\u5907\u200b\u3001\u200b\u6536\u53d1\u200b\u6570\u636e\u200b\u3001\u200b\u5173\u95ed\u200b\u8bbe\u5907\u200b\u3002 libusb\u200b\u5c01\u88c5\u200b\u4e86\u200b\u66f4\u597d\u200b\u7528\u200b\u7684\u200b\u51fd\u6570\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u51fd\u6570\u200b\u7684\u200b\u4f7f\u7528\u200b\u53ef\u4ee5\u200b\u5206\u4e3a\u200b5\u200b\u4e2a\u200b\u6b65\u9aa4\u200b\uff1a</p> <ul> <li>\u200b\u521d\u59cb\u5316\u200b</li> <li>\u200b\u6253\u5f00\u200b\u8bbe\u5907\u200b</li> <li>\u200b\u79fb\u9664\u200b\u539f\u200b\u9a71\u52a8\u200b/\u200b\u8ba4\u9886\u200b\u63a5\u53e3\u200b</li> <li>\u200b\u4f20\u8f93\u200b</li> <li>\u200b\u5173\u95ed\u200b\u8bbe\u5907\u200b</li> </ul> <p></p>"},{"location":"12_USB/06_1/#2-api","title":"2. API\u200b\u63a5\u53e3","text":""},{"location":"12_USB/06_1/#21","title":"2.1 \u200b\u5206\u7c7b","text":"<p>libusb\u200b\u7684\u200b\u63a5\u53e3\u51fd\u6570\u200b\u5206\u4e3a\u200b\u4e24\u7c7b\u200b\uff1a\u200b\u540c\u6b65\u200b(Synchronous device I/O)\u3001\u200b\u5f02\u6b65\u200b(Asynchronous device I/O)\u3002</p> <p>USB\u200b\u6570\u636e\u4f20\u8f93\u200b\u5206\u4e3a\u200b\u4e24\u4e2a\u200b\u6b65\u9aa4\u200b\uff0c\u200b\u5bf9\u4e8e\u200b\u8bfb\u6570\u636e\u200b\uff0c\u200b\u5148\u7ed9\u200b\u8bbe\u5907\u200b\u53d1\u51fa\u200b\u6570\u636e\u200b\u7684\u200b\u8bf7\u6c42\u200b\uff0c\u200b\u4e00\u6bb5\u65f6\u95f4\u200b\u540e\u200b\u6570\u636e\u200b\u8fd4\u56de\u200b\uff1b\u200b\u5bf9\u4e8e\u200b\u5199\u200b\u6570\u636e\u200b\uff0c\u200b\u5148\u200b\u53d1\u9001\u6570\u636e\u200b\u7ed9\u200b\u8bbe\u5907\u200b\uff0c\u200b\u4e00\u6bb5\u65f6\u95f4\u200b\u540e\u200b\u5f97\u5230\u200b\u56de\u5e94\u200b\u3002</p> <p>\u200b\u540c\u6b65\u200b\u63a5\u53e3\u200b\u7684\u200b\u6838\u5fc3\u200b\u5728\u4e8e\u200b\u628a\u200b\u4e0a\u8ff0\u200b\u4e24\u4e2a\u200b\u6b65\u9aa4\u200b\u653e\u5728\u200b\u4e00\u4e2a\u200b\u51fd\u6570\u200b\u91cc\u9762\u200b\u3002\u200b\u6bd4\u5982\u200b\u60f3\u200b\u53bb\u200b\u8bfb\u53d6\u200b\u4e00\u4e2a\u200bUSB\u200b\u952e\u76d8\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u7ed9\u200b\u952e\u76d8\u200b\u53d1\u51fa\u200b\u8bfb\u200b\u8bf7\u6c42\u200b\u540e\u200b\uff0c\u200b\u5982\u679c\u200b\u7528\u6237\u200b\u4e00\u76f4\u200b\u6ca1\u6709\u200b\u6309\u4e0b\u200b\u952e\u76d8\u200b\uff0c\u200b\u90a3\u4e48\u200b\u8bfb\u200b\u51fd\u6570\u200b\u4f1a\u200b\u4e00\u76f4\u200b\u7b49\u5f85\u200b\u3002</p> <p>\u200b\u5f02\u6b65\u200b\u63a5\u53e3\u200b\u7684\u200b\u6838\u5fc3\u200b\u5728\u4e8e\u200b\u628a\u200b\u4e0a\u8ff0\u200b\u4e24\u4e2a\u200b\u6b65\u9aa4\u200b\u5206\u5f00\u200b\uff1a\u200b\u4f7f\u7528\u200b\u4e00\u4e2a\u200b\u975e\u200b\u963b\u585e\u200b\u7684\u200b\u51fd\u6570\u200b\u542f\u52a8\u200b\u4f20\u8f93\u200b\uff0c\u200b\u5b83\u4f1a\u200b\u7acb\u523b\u200b\u8fd4\u56de\u200b\uff1b\u200b\u63d0\u4f9b\u200b\u4e00\u4e2a\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u7528\u6765\u200b\u5904\u7406\u200b\u8fd4\u56de\u200b\u7ed3\u679c\u200b\u3002</p> <p>\u200b\u540c\u6b65\u200b\u63a5\u53e3\u200b\u7684\u200b\u793a\u4f8b\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b\uff0c\u200b\u5728\u200b<code>libusb_bulk_transfer</code>\u200b\u51fd\u6570\u200b\u5185\u90e8\u200b\uff0c\u200b\u5982\u679c\u200b\u6ca1\u6709\u200b\u6570\u636e\u200b\u5219\u200b\u4f1a\u200b\u4f11\u7720\u200b\uff1a</p> <pre><code>unsigned char data[4];\nint actual_length;\nint r = libusb_bulk_transfer(dev_handle, LIBUSB_ENDPOINT_IN, data, sizeof(data), &amp;actual_length, 0);\nif (r == 0 &amp;&amp; actual_length == sizeof(data)) {\n    // \u200b\u63a5\u6536\u200b\u5230\u200b\u7684\u200b\u6570\u636e\u200b\u4fdd\u5b58\u200b\u5728\u200bdata\u200b\u6570\u7ec4\u200b\u91cc\u200b\n    // \u200b\u89e3\u6790\u200b\u8fd9\u4e9b\u200b\u6570\u636e\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u77e5\u9053\u200b\u6309\u952e\u200b\u72b6\u6001\u200b\n} else {\n    error();\n}\n</code></pre> <p>\u200b\u4f7f\u7528\u200b\u540c\u6b65\u200b\u63a5\u53e3\u200b\u65f6\u200b\uff0c\u200b\u4ee3\u7801\u200b\u6bd4\u8f83\u7b80\u5355\u200b\u3002\u200b\u4f46\u662f\u200b\u65e0\u6cd5\u200b\u5b9e\u73b0\u200b\"\u200b\u591a\u200bendpoint\"\u200b\u7684\u200b\u64cd\u4f5c\u200b\uff1a\u200b\u4e0a\u200b\u4e00\u4e2a\u200bendpoint\u200b\u7684\u200b\u4f20\u8f93\u200b\u5728\u200b\u4f11\u7720\u200b\uff0c\u200b\u9664\u975e\u200b\u4f7f\u7528\u200b\u53e6\u200b\u4e00\u4e2a\u200b\u7ebf\u7a0b\u200b\uff0c\u200b\u5426\u5219\u200b\u5728\u200b\u540c\u4e00\u4e2a\u200b\u7ebf\u7a0b\u200b\u5185\u90e8\u200b\u5728\u200b\u7b49\u5f85\u200b\u671f\u95f4\u200b\u662f\u200b\u65e0\u6cd5\u200b\u64cd\u4f5c\u200b\u53e6\u200b\u4e00\u4e2a\u200bendpoint\u200b\u7684\u200b\u3002\u200b\u8fd8\u6709\u200b\u53e6\u200b\u4e00\u4e2a\u200b\u7f3a\u70b9\u200b\uff1a\u200b\u65e0\u6cd5\u200b\u53d6\u6d88\u200b\u4f20\u8f93\u200b\u3002</p> <p>\u200b\u5f02\u6b65\u200b\u63a5\u53e3\u200b\u662f\u200b\u5728\u200blibusb-1.0\u200b\u5f15\u5165\u200b\u7684\u200b\u65b0\u200b\u6027\u80fd\u200b\uff0c\u200b\u63a5\u53e3\u200b\u66f4\u200b\u590d\u6742\u200b\uff0c\u200b\u4f46\u662f\u200b\u529f\u80fd\u200b\u66f4\u200b\u5f3a\u5927\u200b\u3002\u200b\u5728\u200b\u5f02\u6b65\u200b\u63a5\u53e3\u51fd\u6570\u200b\u91cc\u200b\uff0c\u200b\u5b83\u200b\u542f\u52a8\u200b\u4f20\u8f93\u200b\u3001\u200b\u8bbe\u7f6e\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u540e\u200b\u5c31\u200b\u7acb\u523b\u200b\u8fd4\u56de\u200b\u3002\u200b\u7b49\u200b\"\u200b\u8bfb\u200b\u5230\u200b\u6570\u636e\u200b\"\u200b\u6216\u662f\u200b\"\u200b\u5f97\u5230\u200b\u56de\u5e94\u200b\"\u200b\u540e\u200b\uff0c\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b\u3002\u200b\u53d1\u8d77\u200b\u6570\u636e\u4f20\u8f93\u200b\u7684\u200b\u7ebf\u7a0b\u200b\u65e0\u9700\u200b\u4f11\u7720\u200b\u7b49\u5f85\u200b\u7ed3\u679c\u200b\uff0c\u200b\u5b83\u200b\u652f\u6301\u200b\"\u200b\u591a\u200bendpoint\"\u200b\u7684\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u4e5f\u200b\u652f\u6301\u200b\u53d6\u6d88\u200b\u4f20\u8f93\u200b\u3002</p>"},{"location":"12_USB/06_1/#22","title":"2.2 \u200b\u521d\u59cb\u5316\u200b/\u200b\u53cd\u200b\u521d\u59cb\u5316","text":"<pre><code>/** \\ingroup libusb_lib\n * \u200b\u521d\u59cb\u5316\u200blibusb\uff0c\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u5fc5\u987b\u200b\u5148\u4e8e\u200b\u5176\u4ed6\u200blibusb\u200b\u7684\u200b\u51fd\u6570\u200b\u6267\u884c\u200b\n *\n * \u200b\u5982\u679c\u200b\u4f20\u5165\u200bNULL\uff0c\u200b\u90a3\u4e48\u200b\u51fd\u6570\u200b\u5185\u90e8\u200b\u4f1a\u200b\u7a7f\u4ef6\u200b\u4e00\u4e2a\u200b\u9ed8\u8ba4\u200b\u7684\u200bcontext\n * \u200b\u5982\u679c\u200b\u5df2\u7ecf\u200b\u521b\u5efa\u200b\u8fc7\u200b\u9ed8\u8ba4\u200b\u7684\u200bcontext\uff0c\u200b\u8fd9\u4e2a\u200bcontext\u200b\u4f1a\u200b\u88ab\u200b\u91cd\u65b0\u200b\u4f7f\u7528\u200b(\u200b\u4e0d\u4f1a\u200b\u91cd\u65b0\u200b\u521d\u59cb\u5316\u200b\u5b83\u200b)\n *\n * \u200b\u53c2\u6570\u200b\uff1a\n * ctx : context pointer\u200b\u7684\u200b\u4f4d\u7f6e\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u4f20\u5165\u200bNULL\n * \u200b\u8fd4\u56de\u503c\u200b\n * 0 - \u200b\u6210\u529f\u200b\n * \u200b\u8d1f\u6570\u200b - \u200b\u5931\u8d25\u200b\n */\nint API_EXPORTED libusb_init(libusb_context **ctx);\n</code></pre> <p>\u200b\u521d\u59cb\u5316\u200blibusb\uff0c\u200b\u53c2\u6570\u200b\u662f\u200b\u4e00\u4e2a\u200b\"a context pointer\"\u200b\u7684\u200b\u6307\u9488\u200b\uff0c\u200b\u5982\u679c\u200b\u8fd9\u4e2a\u200b\u53c2\u6570\u200b\u4e3a\u200bNULL\uff0c\u200b\u5219\u200b\u51fd\u6570\u200b\u5185\u90e8\u200b\u4f1a\u200b\u521b\u5efa\u200b\u4e00\u4e2a\u200b\"default context\"\u3002\u200b\u6240\u8c13\u200b\"libusb context\"\u200b\u5c31\u662f\u200blibusb\u200b\u4e0a\u4e0b\u6587\u200b\uff0c\u200b\u5c31\u662f\u200b\u4e00\u4e2a\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u91cc\u9762\u200b\u4fdd\u5b58\u200b\u6709\u200b\u5404\u7c7b\u200b\u4fe1\u606f\u200b\uff0c\u200b\u6bd4\u5982\u200b\uff1alibusb\u200b\u7684\u200b\u8c03\u8bd5\u4fe1\u606f\u200b\u662f\u5426\u200b\u9700\u8981\u200b\u6253\u5370\u200b\u3001\u200b\u5404\u79cd\u200b\u4e92\u65a5\u200b\u9501\u200b\u3001\u200b\u5404\u7c7b\u200b\u94fe\u8868\u200b(\u200b\u7528\u6765\u200b\u8bb0\u5f55\u200bUSB\u200b\u4f20\u8f93\u200b\u7b49\u7b49\u200b)\u3002</p> <p>\u200b\u7a0b\u5e8f\u200b\u9000\u51fa\u200b\u524d\u200b\uff0c\u200b\u8c03\u7528\u200b\u5982\u4e0b\u200b\u51fd\u6570\u200b\uff1a</p> <pre><code>/** \\ingroup libusb_lib\n * \u200b\u53d1\u200b\u521d\u59cb\u5316\u200blibusb\n * \u200b\u5728\u200b\u5173\u95ed\u200busb\u200b\u8bbe\u5907\u200b(libusb_close)\u200b\u540e\u200b\u3001\u200b\u9000\u51fa\u200b\u7a0b\u5e8f\u200b\u524d\u200b\u8c03\u7528\u200b\u6b64\u200b\u51fd\u6570\u200b\n *\n * \u200b\u53c2\u6570\u200b:\n * ctx : context, \u200b\u4f20\u5165\u200bNULL\u200b\u8868\u793a\u200bdefault context\n */\nvoid API_EXPORTED libusb_exit(libusb_context *ctx);\n</code></pre>"},{"location":"12_USB/06_1/#23","title":"2.3 \u200b\u83b7\u53d6\u200b\u8bbe\u5907","text":"<p>\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b<code>libusb_get_device_list</code>\u200b\u53d6\u51fa\u200b\u6240\u6709\u200b\u8bbe\u5907\u200b\uff0c\u200b\u51fd\u6570\u200b\u63a5\u53e3\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>/** @ingroup libusb_dev\n * \u200b\u8fd4\u56de\u200b\u4e00\u4e2a\u200blist\uff0clist\u200b\u91cc\u200b\u542b\u6709\u200b\u5f53\u524d\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\u6240\u6709\u200b\u7684\u200bUSB\u200b\u8bbe\u5907\u200b\n *\n * \u200b\u6211\u4eec\u200b\u4e00\u822c\u200b\u4f1a\u200b\u5728\u200blist\u200b\u91cc\u200b\u5bfb\u627e\u200b\u9700\u8981\u200b\u8bbf\u95ee\u200b\u7684\u200b\u8bbe\u5907\u200b\uff0c\u200b\u627e\u5230\u200b\u4e4b\u540e\u200b\u4f7f\u7528\u200blibusb_open\u200b\u51fd\u6570\u200b\u6253\u5f00\u200b\u5b83\u200b\n * \u200b\u7136\u540e\u200b\u8c03\u7528\u200blibusb_free_device_list\u200b\u91ca\u653e\u200blist\n *\n * \u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u7684\u200b\u8fd4\u56de\u503c\u200b\u8868\u793a\u200blist\u200b\u4e2d\u6709\u200b\u591a\u5c11\u200b\u4e2a\u200b\u8bbe\u5907\u200b\n * list\u200b\u7684\u200b\u6700\u540e\u200b\u4e00\u9879\u200b\u662f\u200bNULL\n *\n * \u200b\u53c2\u6570\u200b:\n * ctx  : context\n * list : output location for a list of devices, \u200b\u6700\u540e\u200b\u5fc5\u987b\u200b\u8c03\u7528\u200blibusb_free_device_list()\u200b\u6765\u200b\u91ca\u653e\u200b\u5b83\u200b\n * \u200b\u8fd4\u56de\u503c\u200b: list\u200b\u4e2d\u200b\u8bbe\u5907\u200b\u7684\u200b\u4e2a\u6570\u200b, \u200b\u6216\u200b\u9519\u8bef\u200b\u503c\u200b\n */\nssize_t API_EXPORTED libusb_get_device_list(libusb_context *ctx,\n    libusb_device ***list);\n</code></pre> <p>\u200b\u8c03\u7528\u200b\u6b64\u200b\u51fd\u6570\u200b\u540e\u200b\uff0c\u200b\u6240\u6709\u200b\u8bbe\u5907\u200b\u7684\u200b\u4fe1\u606f\u200b\u5b58\u5165\u200blist\uff0c\u200b\u7136\u540e\u200b\u904d\u5386\u200blist\uff0c\u200b\u627e\u5230\u200b\u60f3\u200b\u64cd\u4f5c\u200b\u7684\u200b\u8bbe\u5907\u200b\u3002\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u5185\u90e8\u200b\u4f1a\u200b\u5206\u914d\u200blist\u200b\u7684\u200b\u7a7a\u95f4\u200b\uff0c\u200b\u6240\u4ee5\u200b\u7528\u200b\u5b8c\u540e\u200b\u8981\u200b\u91ca\u653e\u200b\u6389\u200b\uff0c\u200b\u4f7f\u7528\u200b\u4ee5\u4e0b\u200b\u51fd\u6570\u200b\u91ca\u653e\u200b\uff1a</p> <pre><code>/** \\ingroup libusb_dev\n * \u200b\u524d\u9762\u200b\u4f7f\u7528\u200blibusb_get_device_list()\u200b\u83b7\u5f97\u200b\u4e86\u200b\u8bbe\u5907\u200blist, \n * \u200b\u4f7f\u7528\u200b\u5b8c\u540e\u200b\u8981\u200b\u8c03\u7528\u200blibusb_free_device_list()\u200b\u91ca\u653e\u200b\u8fd9\u4e2a\u200blist\n * \u200b\u5982\u679c\u200b\u53c2\u6570\u200bunref_devices\u200b\u4e3a\u200b1, \u200b\u5219\u200blist\u200b\u4e2d\u200b\u6bcf\u4e2a\u200b\u8bbe\u5907\u200b\u7684\u200b\u5f15\u7528\u200b\u8ba1\u200b\u6570\u503c\u200b\u51cf\u5c0f\u200b1\n * \u200b\u53c2\u6570\u200b: \n * list : \u200b\u8981\u200b\u91ca\u653e\u200b\u7684\u200b\u8bbe\u5907\u200blist\n * unref_devices : \u200b\u662f\u5426\u200b\u8981\u200b\u5c06\u200b\u8bbe\u5907\u200b\u7684\u200b\u5f15\u7528\u200b\u8ba1\u6570\u200b\u51cf\u200b1\n */\nvoid API_EXPORTED libusb_free_device_list(libusb_device **list,\n    int unref_devices);\n</code></pre>"},{"location":"12_USB/06_1/#24","title":"2.4 \u200b\u6253\u5f00\u200b/\u200b\u5173\u95ed\u200b\u8bbe\u5907","text":"<p>\u200b\u4f7f\u7528\u200blibusb_get_device_list\u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u5217\u8868\u200b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u9009\u62e9\u200b\u91cc\u9762\u200b\u7684\u200b\u67d0\u4e2a\u200b\u8bbe\u5907\u200b\uff0c\u200b\u7136\u540e\u200b\u8c03\u7528\u200blibusb_open\uff1a</p> <pre><code>/** \\ingroup libusb_dev\n * \u200b\u6253\u5f00\u200b\u4e00\u4e2a\u200b\u8bbe\u5907\u200b\u5e76\u200b\u5f97\u5230\u200b\u5b83\u200b\u7684\u200b\u53e5\u67c4\u200b, \u200b\u4ee5\u540e\u200b\u8fdb\u884c\u200bIO\u200b\u64cd\u4f5c\u200b\u65f6\u200b\u90fd\u200b\u662f\u200b\u4f7f\u7528\u200b\u53e5\u67c4\u200b\n *\n * \u200b\u4f7f\u7528\u200blibusb_get_device()\u200b\u51fd\u6570\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u8bbe\u5907\u200b\u7684\u200blist, \n * \u200b\u4ece\u200blist\u200b\u91cc\u200b\u786e\u5b9a\u200b\u4f60\u200b\u8981\u200b\u8bbf\u95ee\u200b\u7684\u200b\u8bbe\u5907\u200b\u540e\u200b, \u200b\u4f7f\u7528\u200blibusb_open()\u200b\u53bb\u200b\u6253\u5f00\u200b\u5b83\u200b\u3002\n * libusb_open()\u200b\u51fd\u6570\u200b\u5185\u90e8\u200b\u4f1a\u200b\u589e\u52a0\u200b\u6b64\u200b\u8bbe\u5907\u200b\u7684\u200b\u5f15\u7528\u200b\u8ba1\u6570\u200b, \u200b\u4f7f\u7528\u200b\u5b8c\u6bd5\u200b\u540e\u8981\u200b\u8c03\u7528\u200blibusb_close()\u200b\u51cf\u5c0f\u200b\u5f15\u7528\u200b\u8ba1\u6570\u200b\u3002\n *\n * \u200b\u53c2\u6570\u200b:\n * dev : \u200b\u8981\u200b\u6253\u5f00\u200b\u7684\u200b\u8bbe\u5907\u200b\n * dev_handle : \u200b\u8f93\u51fa\u200b\u53c2\u6570\u200b, \u200b\u7528\u6765\u200b\u4fdd\u5b58\u200b\u53e5\u67c4\u200b\n * \u200b\u8fd4\u56de\u503c\u200b: \n * 0 - \u200b\u6210\u529f\u200b\n * LIBUSB_ERROR_NO_MEM : \u200b\u7f3a\u5c11\u200b\u5185\u5b58\u200b\n * LIBUSB_ERROR_ACCESS : \u200b\u6743\u9650\u200b\u4e0d\u8db3\u200b\n * LIBUSB_ERROR_NO_DEVICE : \u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u672a\u200b\u8fde\u63a5\u200b\n * \u200b\u5176\u4ed6\u200b\u9519\u8bef\u200b : \u200b\u5176\u4ed6\u200bLIBUSB_ERROR\u200b\u9519\u8bef\u7801\u200b\n */\nint API_EXPORTED libusb_open(libusb_device *dev,\n    libusb_device_handle **dev_handle);\n</code></pre> <p>\u200b\u4f7f\u7528\u200blibusb_open\u200b\u51fd\u6570\u200b\u6253\u5f00\u200bUSB\u200b\u8bbe\u5907\u200b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u4e00\u4e2a\u200b\u53e5\u67c4\u200b\uff1alibusb_device_handle\u3002\u200b\u4ee5\u540e\u200b\u8c03\u7528\u200b\u5404\u79cd\u200b\u6570\u636e\u4f20\u8f93\u200b\u51fd\u6570\u200b\u65f6\u200b\uff0c\u200b\u5c31\u662f\u200b\u4f7f\u7528\u200blibusb_device_handle\u3002</p> <p>\u200b\u4f7f\u7528\u200b\u5b8c\u6bd5\u200b\u540e\u200b\uff0c\u200b\u8c03\u7528\u200blibusb_close\u200b\u5173\u95ed\u200b\u8bbe\u5907\u200b\uff0c\u200b\u51fd\u6570\u200b\u539f\u578b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>/** \\ingroup libusb_dev\n * \u200b\u5173\u95ed\u200b\u8bbe\u5907\u200b\u53e5\u67c4\u200b, \u200b\u5728\u200b\u7a0b\u5e8f\u200b\u9000\u51fa\u200b\u4e4b\u524d\u200b\u5e94\u8be5\u200b\u4f7f\u7528\u200b\u5b83\u200b\u53bb\u200b\u5173\u95ed\u200b\u5df2\u7ecf\u200b\u6253\u5f00\u200b\u7684\u200b\u53e5\u67c4\u200b\n *\n * \u200b\u8bbe\u5907\u200b\u7684\u200b\u5f15\u7528\u200b\u8ba1\u6570\u200b\u5728\u200b\u524d\u9762\u200b\u88ab\u200blibusb_open()\u200b\u51fd\u6570\u200b\u589e\u52a0\u200b\u4e86\u200b\u3002\n * \u200b\u5728\u200blibusb_close()\u200b\u51fd\u6570\u200b\u7684\u200b\u5185\u90e8\u200b\uff0c\u200b\u5b83\u4f1a\u200b\u51cf\u5c0f\u200b\u8bbe\u5907\u200b\u7684\u200b\u5f15\u7528\u200b\u8ba1\u6570\u200b\u3002\n *\n * \u200b\u53c2\u6570\u200b: dev_handle - \u200b\u53e5\u67c4\u200b\n */\nvoid API_EXPORTED libusb_close(libusb_device_handle *dev_handle);\n</code></pre>"},{"location":"12_USB/06_1/#25-id","title":"2.5 \u200b\u6839\u636e\u200bID\u200b\u6253\u5f00\u200b\u8bbe\u5907","text":"<p>\u200b\u5982\u679c\u200b\u77e5\u9053\u200b\u8bbe\u5907\u200b\u7684\u200bVID\u3001PID\uff0c\u200b\u90a3\u4e48\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200blibusb_open_device_with_vid_pid\u200b\u6765\u200b\u627e\u5230\u200b\u5b83\u200b\u3001\u200b\u6253\u5f00\u200b\u5b83\u200b\u3002\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u7684\u200b\u5185\u90e8\u200b\uff0c\u200b\u5148\u200b\u4f7f\u7528\u200b<code>libusb_get_device_list</code>\u200b\u5217\u51fa\u200b\u6240\u6709\u200b\u8bbe\u5907\u200b\uff0c\u200b\u7136\u540e\u200b\u904d\u5386\u200b\u5b83\u4eec\u200b\u6839\u636e\u200bID\u200b\u9009\u51fa\u200b\u8bbe\u5907\u200b\uff0c\u200b\u63a5\u7740\u200b\u8c03\u7528\u200blibusb_open\u200b\u6253\u5f00\u200b\u5b83\u200b\uff0c\u200b\u6700\u540e\u200b\u8c03\u7528\u200blibusb_free_device_list\u200b\u91ca\u653e\u200b\u8bbe\u5907\u200b\u3002</p> <p>libusb_open_device_with_vid_pid\u200b\u51fd\u6570\u200b\u539f\u578b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>/** \\ingroup libusb_dev\n * \u200b\u6253\u5f00\u200b\u8bbe\u5907\u200b\u7684\u200b\u5e38\u89c4\u200b\u505a\u6cd5\u200b\u662f\u200b\u4f7f\u7528\u200blibusb_get_device_list()\u200b\u5f97\u5230\u200b\u8bbe\u5907\u200blist\uff0c\n * \u200b\u7136\u540e\u200b\u904d\u5386\u200blist\uff0c\u200b\u627e\u5230\u200b\u8bbe\u5907\u200b\n * \u200b\u63a5\u7740\u200b\u4f7f\u7528\u200blibusb_open()\u200b\u51fd\u6570\u200b\u5f97\u5230\u200b\u53e5\u67c4\u200b\n * \n * \u200b\u5982\u679c\u200b\u77e5\u9053\u200bUSB\u200b\u8bbe\u5907\u200b\u7684\u200bVID\u3001PID\uff0c\u200b\u90a3\u4e48\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200blibusb_open_device_with_vid_pid()\u200b\u51fd\u6570\u200b\u5feb\u901f\u200b\u6253\u5f00\u200b\u5b83\u200b\uff0c\u200b\u5f97\u5230\u200b\u53e5\u67c4\u200b\u3002\n * \n * \u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u6709\u200b\u4e00\u4e2a\u200b\u7f3a\u70b9\u200b: \u200b\u5982\u679c\u200b\u7cfb\u7edf\u200b\u4e2d\u6709\u200b\u591a\u4e2a\u200bID\u200b\u76f8\u540c\u200b\u7684\u200b\u8bbe\u5907\u200b\uff0c\u200b\u4f60\u200b\u53ea\u80fd\u200b\u6253\u5f00\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u8bbe\u5907\u200b\n *\n * \u200b\u53c2\u6570\u200b:\n * ctx : context, \u200b\u6216\u8005\u200b\u4f20\u5165\u200bNULL\u200b\u4ee5\u200b\u4f7f\u7528\u200b\u9ed8\u8ba4\u200b\u7684\u200bcontext\n * vendor_id : \u200b\u5382\u5bb6\u200bID\n * product_id : \u200b\u4ea7\u54c1\u200bID\n * \n * \u200b\u8fd4\u56de\u503c\u200b: \n * \u200b\u53e5\u67c4\u200b - \u200b\u627e\u5230\u200b\u7684\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u8bbe\u5907\u200b\u7684\u200b\u53e5\u67c4\u200b\n * NULL - \u200b\u6ca1\u6709\u200b\u627e\u5230\u200b\u8bbe\u5907\u200b\n */\nDEFAULT_VISIBILITY\nlibusb_device_handle * LIBUSB_CALL libusb_open_device_with_vid_pid(\n    libusb_context *ctx, uint16_t vendor_id, uint16_t product_id);\n</code></pre>"},{"location":"12_USB/06_1/#26","title":"2.6 \u200b\u63cf\u8ff0\u7b26\u200b\u76f8\u5173\u200b\u51fd\u6570","text":""},{"location":"12_USB/06_1/#261","title":"2.6.1 \u200b\u83b7\u5f97\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26","text":"<pre><code>/** \\ingroup libusb_desc\n * \u200b\u83b7\u5f97\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b\n *\n * \u200b\u53c2\u6570\u200b:\n * dev - \u200b\u54ea\u4e2a\u200b\u8bbe\u5907\u200b\n * desc - \u200b\u8f93\u51fa\u200b\u53c2\u6570\u200b, \u200b\u7528\u6765\u200b\u4fdd\u5b58\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b\n *\n * \u200b\u8fd4\u56de\u503c\u200b:\n * 0 - \u200b\u6210\u529f\u200b, \u200b\u6216\u200b\u5176\u4ed6\u200bLIBUSB_ERROR\u200b\u9519\u8bef\u7801\u200b\n */\nint API_EXPORTED libusb_get_device_descriptor(libusb_device *dev,\n    struct libusb_device_descriptor *desc);\n</code></pre>"},{"location":"12_USB/06_1/#262","title":"2.6.2 \u200b\u83b7\u5f97\u200b/\u200b\u91ca\u653e\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26","text":"<pre><code>/** \\ingroup libusb_desc\n * \u200b\u83b7\u5f97\u200b\u6307\u5b9a\u200b\u7684\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26\u200b\n *\n * \u200b\u53c2\u6570\u200b:\n * dev - \u200b\u54ea\u4e2a\u200b\u8bbe\u5907\u200b\n * config_index - \u200b\u54ea\u4e2a\u200b\u914d\u7f6e\u200b\n * config - \u200b\u8f93\u51fa\u200b\u53c2\u6570\u200b, \u200b\u7528\u6765\u200b\u4fdd\u5b58\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26\u200b, \u200b\u4f7f\u7528\u200b\u5b8c\u6bd5\u200b\u8981\u200b\u8c03\u7528\u200blibusb_free_config_descriptor()\u200b\u91ca\u653e\u200b\u6389\u200b\n * \n * \u200b\u8fd4\u56de\u503c\u200b:\n * 0 - \u200b\u6210\u529f\u200b\n * LIBUSB_ERROR_NOT_FOUND - \u200b\u6ca1\u6709\u200b\u8fd9\u4e2a\u200b\u914d\u7f6e\u200b\n * \u200b\u5176\u4ed6\u200bLIBUSB_ERROR\u200b\u9519\u8bef\u7801\u200b\n */\nint API_EXPORTED libusb_get_config_descriptor(libusb_device *dev,\n    uint8_t config_index, struct libusb_config_descriptor **config);\n\n/** \\ingroup libusb_desc\n * Free a configuration descriptor obtained from\n * \u200b\u524d\u9762\u200b\u4f7f\u7528\u200blibusb_get_active_config_descriptor()\u200b\u6216\u200blibusb_get_config_descriptor()\u200b\u83b7\u5f97\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26\u200b\uff0c\n * \u200b\u7528\u200b\u5b8c\u540e\u200b\u8c03\u7528\u200blibusb_free_config_descriptor()\u200b\u91ca\u653e\u200b\u6389\u200b\n */\nvoid API_EXPORTED libusb_free_config_descriptor(\n    struct libusb_config_descriptor *config);\n</code></pre>"},{"location":"12_USB/06_1/#27-detachattach","title":"2.7 detach/attach\u200b\u9a71\u52a8","text":""},{"location":"12_USB/06_1/#271","title":"2.7.1 \u200b\u4e24\u79cd\u200b\u65b9\u6cd5","text":"<p>\u200b\u4f7f\u7528\u200blibusb\u200b\u8bbf\u95ee\u200bUSB\u200b\u8bbe\u5907\u200b\u65f6\u200b\uff0c\u200b\u9700\u8981\u200b\u5148\u200b\u79fb\u9664\u200b(detach)\u200b\u8bbe\u5907\u200b\u539f\u6765\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u7136\u540e\u200b\u8ba4\u9886\u200b\u63a5\u53e3\u200b(claim interface)\u3002\u200b\u6709\u200b\u4e24\u79cd\u200b\u529e\u6cd5\u200b\uff1a</p> <ul> <li>\u200b\u65b9\u6cd5\u200b1\uff1a</li> </ul> <pre><code>// \u200b\u53ea\u662f\u200b\u8bbe\u7f6e\u200b\u4e00\u4e2a\u200b\u6807\u8bb0\u200b\u4f4d\u200b\u8868\u793a\u200blibusb_claim_interface\n// \u200b\u4f7f\u7528\u200blibusb_claim_interface\u200b\u65f6\u4f1a\u200bdetach\u200b\u539f\u6765\u200b\u7684\u200b\u9a71\u52a8\u200b\nlibusb_set_auto_detach_kernel_driver(hdev, 1);  \n\n// \u200b\u6807\u8bb0\u200b\u8fd9\u4e2a\u200binterface\u200b\u5df2\u7ecf\u200b\u88ab\u200b\u4f7f\u7528\u200b\u8ba4\u9886\u200b\u4e86\u200b\nlibusb_claim_interface(hdev, interface_number);\n</code></pre> <ul> <li>\u200b\u65b9\u6cd5\u200b2\uff1a</li> </ul> <pre><code>// detach\u200b\u539f\u6765\u200b\u7684\u200b\u9a71\u52a8\u200b\nlibusb_detach_kernel_driver(hdev, interface_number);\n\n// \u200b\u6807\u8bb0\u200b\u8fd9\u4e2a\u200binterface\u200b\u5df2\u7ecf\u200b\u88ab\u200b\u4f7f\u7528\u200b\u8ba4\u9886\u200b\u4e86\u200b\nlibusb_claim_interface(hdev, interface_number);\n</code></pre>"},{"location":"12_USB/06_1/#272","title":"2.7.2 \u200b\u51fd\u6570\u200b\u539f\u578b","text":"<p>\u200b\u51fd\u6570\u200b<code>libusb_detach_kernel_driver</code>\u200b\u539f\u578b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>/** \\ingroup libusb_dev\n * \u200b\u7ed9\u200bUSB\u200b\u8bbe\u5907\u200b\u7684\u200b\u63a5\u53e3\u200b(interface)\u200b\u79fb\u9664\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b. If successful, you will then be\n * \u200b\u79fb\u9664\u200b\u539f\u6765\u200b\u7684\u200b\u9a71\u52a8\u200b\u540e\u200b\u624d\u80fd\u200b\"claim the interface\"\u3001\u200b\u6267\u884c\u200bIO\u200b\u64cd\u4f5c\u200b\n *\n * \u200b\u5b9e\u9645\u4e0a\u200blibusb\u200b\u4f1a\u200b\u7ed9\u200b\u8fd9\u4e2a\u200b\u63a5\u53e3\u200b\u5b89\u88c5\u200b\u4e00\u4e2a\u200b\u7279\u6b8a\u200b\u7684\u200b\u5185\u6838\u200b\u9a71\u52a8\u200b,\n * \u200b\u6240\u4ee5\u200b\u672c\u200b\u51fd\u6570\u200b\"\u200b\u79fb\u9664\u200b\u9a71\u52a8\u200b\"\u200b\u662f\u200b\u79fb\u9664\u200b\u5176\u4ed6\u200b\u9a71\u52a8\u200b\uff0c\u200b\u4e0d\u662f\u200b\u79fb\u9664\u200b\u8fd9\u4e2a\u200b\u7279\u6b8a\u200b\u7684\u200b\u9a71\u52a8\u200b\u3002\n * \u200b\u82e5\u5e72\u200b\u8fd9\u4e2a\u200b\u63a5\u53e3\u200b\u5df2\u7ecf\u200b\u5b89\u88c5\u200b\u4e86\u200b\u8fd9\u4e2a\u200b\u7279\u6b8a\u200b\u7684\u200b\u9a71\u52a8\u200b\uff0c\u200b\u672c\u200b\u51fd\u6570\u200b\u4f1a\u200b\u8fd4\u56de\u200bLIBUSB_ERROR_NOT_FOUND.\n *\n * \u200b\u53c2\u6570\u200b:\n * dev_handle - \u200b\u8bbe\u5907\u200b\u53e5\u67c4\u200b\n * interface_number - \u200b\u54ea\u200b\u4e00\u4e2a\u200b\u63a5\u53e3\u200b\n * \n * \u200b\u8fd4\u56de\u503c\u200b:\n * 0 - \u200b\u6210\u529f\u200b\n * LIBUSB_ERROR_NOT_FOUND - \u200b\u8fd9\u4e2a\u200b\u63a5\u53e3\u200b\u6ca1\u6709\u200b\u5b89\u88c5\u200b\u5176\u4ed6\u200b\u9a71\u52a8\u200b\n * LIBUSB_ERROR_INVALID_PARAM - \u200b\u6ca1\u6709\u200b\u8fd9\u4e2a\u200b\u63a5\u53e3\u200b\n * LIBUSB_ERROR_NO_DEVICE - \u200b\u8fd9\u4e2a\u200b\u8bbe\u5907\u200b\u672a\u200b\u8fde\u63a5\u200b\n * LIBUSB_ERROR_NOT_SUPPORTED - \u200b\u7cfb\u7edf\u200b\u4e0d\u200b\u652f\u6301\u200b\u6b64\u200b\u64cd\u4f5c\u200b, \u200b\u6bd4\u5982\u200bWindows\n * \u200b\u5176\u4ed6\u200bLIBUSB_ERROR\u200b\u9519\u8bef\u7801\u200b\n */\nint API_EXPORTED libusb_detach_kernel_driver(libusb_device_handle *dev_handle,\n    int interface_number);\n</code></pre> <p>\u200b\u51fd\u6570\u200b<code>libusb_claim_interface</code>\u200b\u539f\u578b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>/** \\ingroup libusb_dev\n * libusb\u200b\u4f7f\u7528\u200b\u5185\u6838\u200b\u91cc\u200b\u4e00\u4e2a\u200b\u7279\u6b8a\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\n * libusb_claim_interface()\u200b\u51fd\u6570\u200b\u5c31\u662f\u200b\u7ed9\u200b\u67d0\u4e2a\u200busb\u200b\u63a5\u53e3\u200b\u5b89\u88c5\u200b\u8fd9\u4e2a\u200b\u7279\u6b8a\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\n * \u200b\u5728\u200b\u4f7f\u7528\u200blibusb\u200b\u7684\u200b\u51fd\u6570\u200b\u6267\u884c\u200bIO\u200b\u64cd\u4f5c\u200b\u4e4b\u524d\u200b\u5fc5\u987b\u200b\u8c03\u7528\u200b\u672c\u200b\u51fd\u6570\u200b\u3002\n *\n * \u200b\u4f60\u200b\u53ef\u4ee5\u200b\u7ed9\u200b\"\u200b\u5df2\u7ecf\u200bclaim\u200b\u8fc7\u200b\u7684\u200b\u63a5\u53e3\u200b\"\u200b\u518d\u6b21\u200b\u8c03\u7528\u200b\u672c\u200b\u51fd\u6570\u200b\uff0c\u200b\u5b83\u200b\u76f4\u63a5\u200b\u8fd4\u56de\u200b0\u3002\n *\n * \u200b\u5982\u679c\u200b\u8fd9\u4e2a\u200b\u63a5\u53e3\u200b\u7684\u200bauto_detach_kernel_driver\u200b\u88ab\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b1\uff0c\n * libusb_claim_interface()\u200b\u51fd\u6570\u200b\u4f1a\u5148\u200b\u79fb\u9664\u200b\u5176\u4ed6\u200b\u9a71\u52a8\u200b\u3002\n *\n * \u200b\u672c\u200b\u51fd\u6570\u200b\u65f6\u200b\u7eaf\u7cb9\u200b\u7684\u200b\u903b\u8f91\u200b\u64cd\u4f5c\u200b\uff1a\u200b\u53ea\u662f\u200b\u66ff\u6362\u200b\u63a5\u53e3\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u800c\u5df2\u200b\uff0c\u200b\u4e0d\u4f1a\u200b\u5bfc\u81f4\u200bUSB\u200b\u786c\u4ef6\u200b\u4f20\u8f93\u200b\u3002\n *\n * \u200b\u53c2\u6570\u200b:\n * dev_handle - \u200b\u53e5\u67c4\u200b, \u200b\u8868\u793a\u200bUSB\u200b\u8bbe\u5907\u200b\n * interface_number - \u200b\u63a5\u53e3\u200b\n *\n * \u200b\u8fd4\u56de\u503c\u200b:\n * 0 - \u200b\u6210\u529f\u200b\n * LIBUSB_ERROR_NOT_FOUND - \u200b\u6ca1\u6709\u200b\u8fd9\u4e2a\u200b\u63a5\u53e3\u200b\n * LIBUSB_ERROR_BUSY - \u200b\u5176\u4ed6\u200bAPP\u200b\u6216\u8005\u200b\u9a71\u52a8\u200b\u6b63\u5728\u200b\u4f7f\u7528\u200b\u8fd9\u4e2a\u200b\u63a5\u53e3\u200b\n * LIBUSB_ERROR_NO_DEVICE - \u200b\u8bbe\u5907\u200b\u672a\u200b\u8fde\u63a5\u200b\n * \u200b\u5176\u4ed6\u200bLIBUSB_ERROR\u200b\u9519\u8bef\u7801\u200b\n */\nint API_EXPORTED libusb_claim_interface(libusb_device_handle *dev_handle,\n    int interface_number);\n</code></pre> <p>\u200b\u4f7f\u7528\u200b\u5b8c\u200bUSB\u200b\u8bbe\u5907\u200b\u540e\u200b\uff0c\u200b\u5728\u200b\u8c03\u7528\u200blibusb_close\u200b\u4e4b\u524d\u200b\uff0c\u200b\u5e94\u8be5\u200b<code>libusb_release_interface</code>\u200b\u91ca\u653e\u200b\u63a5\u53e3\u200b\uff1a</p> <pre><code>/** \\ingroup libusb_dev\n * \u200b\u524d\u9762\u200b\u4f7f\u7528\u200blibusb_claim_interface()\u200b\u7ed9\u200b\u63a5\u53e3\u200b\u5b89\u88c5\u200b\u4e86\u200b\u7ed9\u200blibusb\u200b\u4f7f\u7528\u200b\u7684\u200b\u7279\u6b8a\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b,\n * \u200b\u4f7f\u7528\u200b\u5b8c\u6bd5\u200b\u540e\u200b\uff0c\u200b\u5728\u200b\u8c03\u7528\u200blibusb_close()\u200b\u5173\u95ed\u200b\u53e5\u67c4\u200b\u4e4b\u524d\u200b\uff0c\n * \u200b\u53ef\u4ee5\u200b\u8c03\u7528\u200blibusb_release_interface()\u200b\u5378\u8f7d\u200b\u7279\u6b8a\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\n * \u200b\u5982\u679c\u200b\u8bbe\u5907\u200b\u7684\u200bauto_detach_kernel_driver\u200b\u4e3a\u200b1\uff0c\u200b\u8fd8\u4f1a\u200b\u91cd\u65b0\u5b89\u88c5\u200b\u666e\u901a\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\n * \n * \u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u963b\u585e\u200b\u51fd\u6570\u200b, \u200b\u5b83\u4f1a\u200b\u7ed9\u200bUSB\u200b\u8bbe\u5907\u200b\u53d1\u9001\u200b\u4e00\u4e2a\u200b\u8bf7\u6c42\u200b: SET_INTERFACE control,\n * \u200b\u7528\u6765\u200b\u628a\u200b\u63a5\u53e3\u200b\u7684\u200b\u72b6\u6001\u200b\u590d\u4f4d\u200b\u5230\u200b\u7b2c\u200b1\u200b\u4e2a\u200bsetting(the first alternate setting)\n *\n * \u200b\u53c2\u6570\u200b:\n * dev_handle - \u200b\u8bbe\u5907\u200b\u53e5\u67c4\u200b\n * interface_number - \u200b\u54ea\u4e2a\u200b\u63a5\u53e3\u200b\n * \n * \u200b\u8fd4\u56de\u503c\u200b:\n * 0 - \u200b\u6210\u529f\u200b\n * LIBUSB_ERROR_NOT_FOUND - \u200b\u8fd9\u4e2a\u200b\u63a5\u53e3\u200b\u6ca1\u6709\u200b\u88ab\u200bclaim(\u200b\u6ca1\u6709\u200b\u5b89\u88c5\u200b\u7279\u6b8a\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b)\n * LIBUSB_ERROR_NO_DEVICE - \u200b\u8bbe\u5907\u200b\u672a\u200b\u8fde\u63a5\u200b\n * \u200b\u5176\u4ed6\u200bLIBUSB_ERROR\u200b\u9519\u8bef\u7801\u200b\n */\nint API_EXPORTED libusb_release_interface(libusb_device_handle *dev_handle,\n    int interface_number);\n</code></pre>"},{"location":"12_USB/06_1/#28","title":"2.8 \u200b\u540c\u6b65\u200b\u4f20\u8f93\u200b\u51fd\u6570","text":""},{"location":"12_USB/06_1/#281","title":"2.8.1 \u200b\u63a7\u5236\u4f20\u8f93","text":"<pre><code>/** \\ingroup libusb_syncio\n * \u200b\u542f\u52a8\u200b\u63a7\u5236\u4f20\u8f93\u200b\n *\n * \u200b\u4f20\u8f93\u200b\u65b9\u5411\u200b\u5728\u200bbmRequestType\u200b\u91cc\u200b\n * wValue,wIndex\u200b\u548c\u200bwLength\u200b\u662f\u200bhost-endian\u200b\u5b57\u8282\u200b\u5e8f\u200b\n *\n * \u200b\u53c2\u6570\u200b:\n * dev_handle - \u200b\u8bbe\u5907\u200b\u53e5\u67c4\u200b\n * bmRequestType - setup\u200b\u6570\u636e\u5305\u200b\u7684\u200bbmRequestType\u200b\u57df\u200b\n * bRequest      - setup\u200b\u6570\u636e\u5305\u200b\u7684\u200bbRequest\u200b\u57df\u200b\n * wValue        - setup\u200b\u6570\u636e\u5305\u200b\u7684\u200bwValue\u200b\u57df\u200b\n * wIndex        - setup\u200b\u6570\u636e\u5305\u200b\u7684\u200bwIndex\u200b\u57df\u200b\n * data          - \u200b\u4fdd\u5b58\u200b\u6570\u636e\u200b\u7684\u200bbuffer, \u200b\u53ef\u4ee5\u200b\u662f\u200bin\u3001out\u200b\u6570\u636e\u200b\n * wLength       - setup\u200b\u6570\u636e\u5305\u200b\u7684\u200bwLength\u200b\u57df\u200b\n * timeout       - \u200b\u8d85\u65f6\u200b\u65f6\u95f4\u200b(\u200b\u5355\u4f4d\u200bms)\uff0c\u200b\u5c31\u662f\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u80fd\u200b\u7b49\u5f85\u200b\u7684\u200b\u6700\u5927\u200b\u65f6\u95f4\u200b; 0\u200b\u8868\u793a\u200b\u4e00\u76f4\u200b\u7b49\u5f85\u200b\u76f4\u5230\u200b\u6210\u529f\u200b\n * \n * \u200b\u8fd4\u56de\u503c\u200b:\n * \u200b\u6b63\u6574\u6570\u200b - \u200b\u6210\u529f\u200b\u4f20\u8f93\u200b\u7684\u200b\u6570\u636e\u200b\u7684\u200b\u957f\u5ea6\u200b\n * LIBUSB_ERROR_TIMEOUT - \u200b\u8d85\u65f6\u200b\n * LIBUSB_ERROR_PIPE  - \u200b\u8bbe\u5907\u200b\u4e0d\u200b\u652f\u6301\u200b\u8be5\u200b\u8bf7\u6c42\u200b\n * LIBUSB_ERROR_NO_DEVICE - \u200b\u8bbe\u5907\u200b\u672a\u200b\u8fde\u63a5\u200b\n * LIBUSB_ERROR_BUSY - \u200b\u5982\u679c\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u65f6\u200b\u5728\u200b\u4e8b\u4ef6\u5904\u7406\u200b\u4e0a\u4e0b\u6587\u200b(event handling context)\u200b\u91cc\u200b\u5219\u200b\u8fd4\u56de\u200b\u8fd9\u4e2a\u200b\u9519\u8bef\u200b\n * LIBUSB_ERROR_INVALID_PARAM - \u200b\u4f20\u8f93\u200b\u7684\u200b\u5b57\u8282\u200b\u8d85\u8fc7\u200bOS\u200b\u6216\u786c\u4ef6\u200b\u7684\u200b\u652f\u6301\u200b\n * the operating system and/or hardware can support (see \\ref asynclimits)\n * \u200b\u5176\u4ed6\u200bLIBUSB_ERROR\u200b\u9519\u8bef\u7801\u200b\n */\nint API_EXPORTED libusb_control_transfer(libusb_device_handle *dev_handle,\n    uint8_t bmRequestType, uint8_t bRequest, uint16_t wValue, uint16_t wIndex,\n    unsigned char *data, uint16_t wLength, unsigned int timeout);\n</code></pre>"},{"location":"12_USB/06_1/#282","title":"2.8.2 \u200b\u6279\u91cf\u200b\u4f20\u8f93","text":"<pre><code>/** \\ingroup libusb_syncio\n * \u200b\u542f\u52a8\u200b\u6279\u91cf\u200b\u4f20\u8f93\u200b\n * \u200b\u4f20\u8f93\u200b\u65b9\u5411\u200b\u5728\u200bendpoint\u200b\u7684\u200b\"\u200b\u65b9\u5411\u200b\u4f4d\u200b\"\u200b\u91cc\u200b\u8868\u793a\u200b\n *\n * \u200b\u5bf9\u4e8e\u200b\u6279\u91cf\u200b\u8bfb\u200b\uff0c\u200b\u53c2\u6570\u200blength\u200b\u8868\u793a\u200b\"\u200b\u671f\u671b\u200b\u8bfb\u5230\u200b\u7684\u200b\u6570\u636e\u200b\u6700\u5927\u200b\u957f\u5ea6\u200b\", \u200b\u5b9e\u9645\u200b\u8bfb\u5230\u200b\u7684\u200b\u957f\u5ea6\u200b\u4fdd\u5b58\u200b\u5728\u200btransferred\u200b\u53c2\u6570\u200b\u91cc\u200b\n *\n * \u200b\u5bf9\u4e8e\u200b\u6279\u91cf\u200b\u5199\u200b, transferred\u200b\u53c2\u6570\u200b\u8868\u793a\u200b\u5b9e\u9645\u200b\u53d1\u9001\u200b\u51fa\u53bb\u200b\u7684\u200b\u6570\u636e\u200b\u957f\u5ea6\u200b\n *\n * \u200b\u53d1\u751f\u200b\u8d85\u65f6\u200b\u9519\u8bef\u200b\u65f6\u200b\uff0c\u200b\u4e5f\u200b\u5e94\u8be5\u200b\u68c0\u67e5\u200btransferred\u200b\u53c2\u6570\u200b\u3002\n * libusb\u200b\u4f1a\u200b\u6839\u636e\u200b\u786c\u4ef6\u200b\u7684\u200b\u7279\u70b9\u200b\u628a\u200b\u6570\u636e\u200b\u62c6\u200b\u5206\u4e3a\u200b\u4e00\u5c0f\u200b\u6bb5\u200b\u4e00\u5c0f\u200b\u6bb5\u200b\u5730\u200b\u53d1\u9001\u200b\u51fa\u53bb\u200b\uff0c\n * \u200b\u8fd9\u200b\u610f\u5473\u7740\u200b\u53d1\u9001\u200b\u6ee1\u200b\u67d0\u6bb5\u200b\u6570\u636e\u200b\u540e\u200b\u53ef\u80fd\u200b\u5c31\u200b\u53d1\u751f\u200b\u8d85\u65f6\u200b\u9519\u8bef\u200b\uff0c\u200b\u9700\u8981\u200b\u6839\u636e\u200btransferred\u200b\u53c2\u6570\u200b\u5224\u65ad\u200b\u4f20\u8f93\u200b\u4e86\u200b\u591a\u5c11\u200b\u6570\u636e\u200b\u3002\n *\n * \u200b\u53c2\u6570\u200b:\n * dev_handle - \u200b\u8bbe\u5907\u200b\u53e5\u67c4\u200b\n * endpoint - \u200b\u7aef\u70b9\u200b\n * data          - \u200b\u4fdd\u5b58\u200b\u6570\u636e\u200b\u7684\u200bbuffer, \u200b\u53ef\u4ee5\u200b\u662f\u200bin\u3001out\u200b\u6570\u636e\u200b\n * length  - \u200b\u5bf9\u4e8e\u200b\u6279\u91cf\u200b\u5199\u200b\uff0c\u200b\u5b83\u200b\u8868\u793a\u200b\u8981\u200b\u53d1\u9001\u200b\u7684\u200b\u6570\u636e\u200b\u957f\u5ea6\u200b; \u200b\u5bf9\u4e8e\u200b\u6279\u91cf\u200b\u8bfb\u200b\uff0c\u200b\u5b83\u200b\u8868\u793a\u200b\"\u200b\u8981\u8bfb\u200b\u7684\u200b\u6570\u636e\u200b\u7684\u200b\u6700\u5927\u200b\u957f\u5ea6\u200b\"\n * transferred - \u200b\u8f93\u51fa\u200b\u53c2\u6570\u200b\uff0c\u200b\u8868\u793a\u200b\u5b9e\u9645\u200b\u4f20\u8f93\u200b\u7684\u200b\u6570\u636e\u200b\u957f\u5ea6\u200b\n * timeout       - \u200b\u8d85\u65f6\u200b\u65f6\u95f4\u200b(\u200b\u5355\u4f4d\u200bms)\uff0c\u200b\u5c31\u662f\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u80fd\u200b\u7b49\u5f85\u200b\u7684\u200b\u6700\u5927\u200b\u65f6\u95f4\u200b; 0\u200b\u8868\u793a\u200b\u4e00\u76f4\u200b\u7b49\u5f85\u200b\u76f4\u5230\u200b\u6210\u529f\u200b\n *\n * \u200b\u8fd4\u56de\u503c\u200b:\n * 0 - \u200b\u6210\u529f\u200b\uff0c\u200b\u6839\u636e\u200btransferred\u200b\u53c2\u6570\u200b\u5224\u65ad\u200b\u4f20\u8f93\u200b\u4e86\u200b\u591a\u5c11\u200b\u957f\u5ea6\u200b\u7684\u200b\u6570\u636e\u200b\n * LIBUSB_ERROR_TIMEOUT - \u200b\u8d85\u65f6\u200b, \u200b\u6839\u636e\u200btransferred\u200b\u53c2\u6570\u200b\u5224\u65ad\u200b\u4f20\u8f93\u200b\u4e86\u200b\u591a\u5c11\u200b\u957f\u5ea6\u200b\u7684\u200b\u6570\u636e\u200b\n * LIBUSB_ERROR_PIPE - \u200b\u7aef\u70b9\u200b\u9519\u8bef\u200b\uff0c\u200b\u7aef\u70b9\u200b\u88ab\u200b\u6302\u200b\u8d77\u200b\u4e86\u200b\n * LIBUSB_ERROR_OVERFLOW - \u200b\u6ea2\u51fa\u200b\uff0c\u200b\u8bbe\u5907\u200b\u63d0\u4f9b\u200b\u7684\u200b\u6570\u636e\u200b\u592a\u591a\u200b\u4e86\u200b\n * LIBUSB_ERROR_NO_DEVICE - \u200b\u8bbe\u5907\u200b\u672a\u200b\u8fde\u63a5\u200b\n * LIBUSB_ERROR_BUSY - \u200b\u5982\u679c\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u65f6\u200b\u5728\u200b\u4e8b\u4ef6\u5904\u7406\u200b\u4e0a\u4e0b\u6587\u200b(event handling context)\u200b\u91cc\u200b\u5219\u200b\u8fd4\u56de\u200b\u8fd9\u4e2a\u200b\u9519\u8bef\u200b\n * LIBUSB_ERROR_INVALID_PARAM - \u200b\u4f20\u8f93\u200b\u7684\u200b\u5b57\u8282\u200b\u8d85\u8fc7\u200bOS\u200b\u6216\u786c\u4ef6\u200b\u7684\u200b\u652f\u6301\u200b\n * \u200b\u5176\u4ed6\u200bLIBUSB_ERROR\u200b\u9519\u8bef\u7801\u200b\n */\nint API_EXPORTED libusb_bulk_transfer(libusb_device_handle *dev_handle,\n    unsigned char endpoint, unsigned char *data, int length,\n    int *transferred, unsigned int timeout);\n</code></pre>"},{"location":"12_USB/06_1/#283","title":"2.8.3 \u200b\u4e2d\u65ad\u200b\u4f20\u8f93","text":"<pre><code>/** \\ingroup libusb_syncio\n * \u200b\u542f\u52a8\u200b\u4e2d\u65ad\u200b\u4f20\u8f93\u200b\n * \u200b\u4f20\u8f93\u200b\u65b9\u5411\u200b\u5728\u200bendpoint\u200b\u7684\u200b\"\u200b\u65b9\u5411\u200b\u4f4d\u200b\"\u200b\u91cc\u200b\u8868\u793a\u200b\n *\n * \u200b\u5bf9\u4e8e\u200b\u4e2d\u65ad\u200b\u8bfb\u200b\uff0c\u200b\u53c2\u6570\u200blength\u200b\u8868\u793a\u200b\"\u200b\u671f\u671b\u200b\u8bfb\u5230\u200b\u7684\u200b\u6570\u636e\u200b\u6700\u5927\u200b\u957f\u5ea6\u200b\", \u200b\u5b9e\u9645\u200b\u8bfb\u5230\u200b\u7684\u200b\u957f\u5ea6\u200b\u4fdd\u5b58\u200b\u5728\u200btransferred\u200b\u53c2\u6570\u200b\u91cc\u200b\n *\n * \u200b\u5bf9\u4e8e\u200b\u4e2d\u65ad\u200b\u5199\u200b, transferred\u200b\u53c2\u6570\u200b\u8868\u793a\u200b\u5b9e\u9645\u200b\u53d1\u9001\u200b\u51fa\u53bb\u200b\u7684\u200b\u6570\u636e\u200b\u957f\u5ea6\u200b\uff0c\u200b\u4e0d\u200b\u4e00\u5b9a\u200b\u80fd\u200b\u53d1\u9001\u200b\u5b8c\u5168\u200b\u90e8\u200b\u6570\u636e\u200b\u3002\n *\n * \u200b\u53d1\u751f\u200b\u8d85\u65f6\u200b\u9519\u8bef\u200b\u65f6\u200b\uff0c\u200b\u4e5f\u200b\u5e94\u8be5\u200b\u68c0\u67e5\u200btransferred\u200b\u53c2\u6570\u200b\u3002\n * libusb\u200b\u4f1a\u200b\u6839\u636e\u200b\u786c\u4ef6\u200b\u7684\u200b\u7279\u70b9\u200b\u628a\u200b\u6570\u636e\u200b\u62c6\u200b\u5206\u4e3a\u200b\u4e00\u5c0f\u200b\u6bb5\u200b\u4e00\u5c0f\u200b\u6bb5\u200b\u5730\u200b\u53d1\u9001\u200b\u51fa\u53bb\u200b\uff0c\n * \u200b\u8fd9\u200b\u610f\u5473\u7740\u200b\u53d1\u9001\u200b\u6ee1\u200b\u67d0\u6bb5\u200b\u6570\u636e\u200b\u540e\u200b\u53ef\u80fd\u200b\u5c31\u200b\u53d1\u751f\u200b\u8d85\u65f6\u200b\u9519\u8bef\u200b\uff0c\u200b\u9700\u8981\u200b\u6839\u636e\u200btransferred\u200b\u53c2\u6570\u200b\u5224\u65ad\u200b\u4f20\u8f93\u200b\u4e86\u200b\u591a\u5c11\u200b\u6570\u636e\u200b\u3002\n *\n * \u200b\u53c2\u6570\u200b:\n * dev_handle - \u200b\u8bbe\u5907\u200b\u53e5\u67c4\u200b\n * endpoint - \u200b\u7aef\u70b9\u200b\n * data          - \u200b\u4fdd\u5b58\u200b\u6570\u636e\u200b\u7684\u200bbuffer, \u200b\u53ef\u4ee5\u200b\u662f\u200bin\u3001out\u200b\u6570\u636e\u200b\n * length  - \u200b\u5bf9\u4e8e\u200b\u6279\u91cf\u200b\u5199\u200b\uff0c\u200b\u5b83\u200b\u8868\u793a\u200b\u8981\u200b\u53d1\u9001\u200b\u7684\u200b\u6570\u636e\u200b\u957f\u5ea6\u200b; \u200b\u5bf9\u4e8e\u200b\u6279\u91cf\u200b\u8bfb\u200b\uff0c\u200b\u5b83\u200b\u8868\u793a\u200b\"\u200b\u8981\u8bfb\u200b\u7684\u200b\u6570\u636e\u200b\u7684\u200b\u6700\u5927\u200b\u957f\u5ea6\u200b\"\n * transferred - \u200b\u8f93\u51fa\u200b\u53c2\u6570\u200b\uff0c\u200b\u8868\u793a\u200b\u5b9e\u9645\u200b\u4f20\u8f93\u200b\u7684\u200b\u6570\u636e\u200b\u957f\u5ea6\u200b\n * timeout       - \u200b\u8d85\u65f6\u200b\u65f6\u95f4\u200b(\u200b\u5355\u4f4d\u200bms)\uff0c\u200b\u5c31\u662f\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u80fd\u200b\u7b49\u5f85\u200b\u7684\u200b\u6700\u5927\u200b\u65f6\u95f4\u200b; 0\u200b\u8868\u793a\u200b\u4e00\u76f4\u200b\u7b49\u5f85\u200b\u76f4\u5230\u200b\u6210\u529f\u200b\n *\n * \u200b\u8fd4\u56de\u503c\u200b:\n * 0 - \u200b\u6210\u529f\u200b\uff0c\u200b\u6839\u636e\u200btransferred\u200b\u53c2\u6570\u200b\u5224\u65ad\u200b\u4f20\u8f93\u200b\u4e86\u200b\u591a\u5c11\u200b\u957f\u5ea6\u200b\u7684\u200b\u6570\u636e\u200b\n * LIBUSB_ERROR_TIMEOUT - \u200b\u8d85\u65f6\u200b, \u200b\u6839\u636e\u200btransferred\u200b\u53c2\u6570\u200b\u5224\u65ad\u200b\u4f20\u8f93\u200b\u4e86\u200b\u591a\u5c11\u200b\u957f\u5ea6\u200b\u7684\u200b\u6570\u636e\u200b\n * LIBUSB_ERROR_PIPE - \u200b\u7aef\u70b9\u200b\u9519\u8bef\u200b\uff0c\u200b\u7aef\u70b9\u200b\u88ab\u200b\u6302\u200b\u8d77\u200b\u4e86\u200b\n * LIBUSB_ERROR_OVERFLOW - \u200b\u6ea2\u51fa\u200b\uff0c\u200b\u8bbe\u5907\u200b\u63d0\u4f9b\u200b\u7684\u200b\u6570\u636e\u200b\u592a\u591a\u200b\u4e86\u200b\n * LIBUSB_ERROR_NO_DEVICE - \u200b\u8bbe\u5907\u200b\u672a\u200b\u8fde\u63a5\u200b\n * LIBUSB_ERROR_BUSY - \u200b\u5982\u679c\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u65f6\u200b\u5728\u200b\u4e8b\u4ef6\u5904\u7406\u200b\u4e0a\u4e0b\u6587\u200b(event handling context)\u200b\u91cc\u200b\u5219\u200b\u8fd4\u56de\u200b\u8fd9\u4e2a\u200b\u9519\u8bef\u200b\n * LIBUSB_ERROR_INVALID_PARAM - \u200b\u4f20\u8f93\u200b\u7684\u200b\u5b57\u8282\u200b\u8d85\u8fc7\u200bOS\u200b\u6216\u786c\u4ef6\u200b\u7684\u200b\u652f\u6301\u200b\n * \u200b\u5176\u4ed6\u200bLIBUSB_ERROR\u200b\u9519\u8bef\u7801\u200b\n */\nint API_EXPORTED libusb_interrupt_transfer(libusb_device_handle *dev_handle,\n    unsigned char endpoint, unsigned char *data, int length,\n    int *transferred, unsigned int timeout);\n</code></pre>"},{"location":"12_USB/06_1/#29","title":"2.9 \u200b\u5f02\u6b65\u200b\u4f20\u8f93\u200b\u51fd\u6570","text":""},{"location":"12_USB/06_1/#291","title":"2.9.1 \u200b\u4f7f\u7528\u200b\u6b65\u9aa4","text":"<p>\u200b\u4f7f\u7528\u200blibusb\u200b\u7684\u200b\u5f02\u6b65\u200b\u51fd\u6570\u200b\u65f6\u200b\uff0c\u200b\u6709\u200b\u5982\u4e0b\u200b\u6b65\u9aa4\u200b\uff1a</p> <ul> <li>\u200b\u5206\u914d\u200b\uff1a\u200b\u5206\u914d\u200b\u4e00\u4e2a\u200b<code>libusb_transfer</code>\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> <li>\u200b\u586b\u5145\u200b\uff1a\u200b\u586b\u5145\u200b<code>libusb_transfer</code>\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u6bd4\u5982\u200b\u60f3\u200b\u8bbf\u95ee\u200b\u54ea\u4e2a\u200bendpoint\u3001\u200b\u6570\u636e\u200bbuffer\u3001\u200b\u957f\u5ea6\u200b\u7b49\u7b49\u200b</li> <li>\u200b\u63d0\u4ea4\u200b\uff1a\u200b\u63d0\u4ea4\u200b<code>libusb_transfer</code>\u200b\u7ed3\u6784\u200b\u4f53\u200b\u542f\u52a8\u200b\u4f20\u8f93\u200b</li> <li>\u200b\u5904\u7406\u4e8b\u4ef6\u200b\uff1a\u200b\u68c0\u67e5\u200b\u4f20\u8f93\u200b\u7684\u200b\u7ed3\u679c\u200b\uff0c\u200b\u8c03\u7528\u200b<code>libusb_transfer</code>\u200b\u7ed3\u6784\u200b\u4f53\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b</li> <li>\u200b\u91ca\u653e\u200b\uff1a\u200b\u91ca\u653e\u200b\u8d44\u6e90\u200b\uff0c\u200b\u6bd4\u5982\u200b\u91ca\u653e\u200b<code>libusb_transfer</code>\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> </ul>"},{"location":"12_USB/06_1/#292-transfer","title":"2.9.2 \u200b\u5206\u914d\u200btransfer\u200b\u7ed3\u6784\u200b\u4f53","text":"<pre><code>/** \\ingroup libusb_asyncio\n * \u200b\u5206\u914d\u200b\u4e00\u4e2a\u200blibusb_transfer\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\n * \u200b\u5982\u679c\u200biso_packets\u200b\u4e0d\u200b\u4e3a\u200b0\uff0c\u200b\u8fd8\u4f1a\u200b\u5206\u914d\u200biso_packets\u200b\u4e2a\u200blibusb_iso_packet_descriptor\u200b\u7ed3\u6784\u200b\u4f53\u200b\n * \u200b\u4f7f\u7528\u200b\u5b8c\u6bd5\u200b\u540e\u200b\u9700\u8981\u200b\u8c03\u7528\u200blibusb_free_transfer()\u200b\u51fd\u6570\u200b\u91ca\u653e\u200b\u6389\u200b\n *\n * \u200b\u5bf9\u4e8e\u200b\u63a7\u5236\u4f20\u8f93\u200b\u3001\u200b\u6279\u91cf\u200b\u4f20\u8f93\u200b\u3001\u200b\u4e2d\u65ad\u200b\u4f20\u8f93\u200b\uff0ciso_packets\u200b\u53c2\u6570\u200b\u9700\u8981\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b0\n *\n * \u200b\u5bf9\u4e8e\u200b\u5b9e\u65f6\u200b\u4f20\u8f93\u200b\uff0c\u200b\u9700\u8981\u200b\u6307\u5b9a\u200biso_packets\u200b\u53c2\u6570\u200b\uff0c\n * \u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u4f1a\u200b\u4e00\u8d77\u200b\u5206\u914d\u200biso_packets\u200b\u4e2a\u200blibusb_iso_packet_descriptor\u200b\u7ed3\u6784\u200b\u4f53\u200b\u3002\n * \u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u8fd4\u56de\u200b\u7684\u200blibusb_transfer\u200b\u7ed3\u6784\u200b\u4f53\u200b\u5e76\u672a\u200b\u521d\u59cb\u5316\u200b\uff0c\n * \u200b\u4f60\u200b\u8fd8\u200b\u9700\u8981\u200b\u521d\u59cb\u5316\u200b\u5b83\u200b\u7684\u200b\u8fd9\u4e9b\u200b\u6210\u5458\u200b:\n *   libusb_transfer::num_iso_packets\n *   libusb_transfer::type\n *\n * \u200b\u4f60\u200b\u53ef\u4ee5\u200b\u6307\u5b9a\u200biso_packets\u200b\u53c2\u6570\u200b\uff0c\u200b\u610f\u56fe\u200b\u7ed9\u200b\u5b9e\u65f6\u200b\u4f20\u8f93\u200b\u5206\u914d\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\n * \u200b\u4f46\u662f\u200b\u4f60\u200b\u53ef\u4ee5\u200b\u628a\u200b\u8fd9\u4e2a\u200b\u7ed3\u6784\u200b\u9898\u200b\u7528\u4e8e\u200b\u5176\u4ed6\u200b\u7c7b\u578b\u200b\u7684\u200b\u4f20\u8f93\u200b\uff0c\n * \u200b\u5728\u200b\u8fd9\u79cd\u200b\u60c5\u51b5\u200b\u4e0b\u200b\uff0c\u200b\u53ea\u8981\u200b\u786e\u4fdd\u200bnum_iso_packets\u200b\u4e3a\u200b0\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u3002\n *\n * \u200b\u53c2\u6570\u200b:\n * iso_packets - \u200b\u5206\u914d\u200b\u591a\u5c11\u200b\u4e2a\u200bisochronous packet descriptors to allocate\n *\n * \u200b\u8fd4\u56de\u503c\u200b:\n * \u200b\u8fd4\u56de\u200b\u4e00\u4e2a\u200blibusb_transfer\u200b\u7ed3\u6784\u200b\u4f53\u200b\u6216\u200bNULL\n */\nDEFAULT_VISIBILITY\nstruct libusb_transfer * LIBUSB_CALL libusb_alloc_transfer(\n    int iso_packets);\n</code></pre>"},{"location":"12_USB/06_1/#293","title":"2.9.3 \u200b\u586b\u5145\u200b\u63a7\u5236\u4f20\u8f93","text":"<pre><code>/** \\ingroup libusb_asyncio\n * \u200b\u6784\u9020\u200b\u63a7\u5236\u4f20\u8f93\u200b\u7ed3\u6784\u200b\u4f53\u200b\n *\n * \u200b\u5982\u679c\u200b\u4f60\u200b\u4f20\u5165\u200bbuffer\u200b\u53c2\u6570\u200b\uff0c\u200b\u90a3\u4e48\u200bbuffer\u200b\u7684\u200b\u524d\u9762\u200b8\u200b\u5b57\u8282\u200b\u4f1a\u200b\u88ab\u200b\u5f53\u505a\u200b\"control setup packet\"\u200b\u6765\u200b\u89e3\u6790\u200b\uff0c\n * buffer\u200b\u7684\u200b\u6700\u540e\u200b2\u200b\u5b57\u8282\u200b\u8868\u793a\u200bwLength\uff0c\u200b\u5b83\u200b\u4e5f\u200b\u4f1a\u200b\u88ab\u200b\u7528\u6765\u200b\u8bbe\u7f6e\u200blibusb_transfer::length\n * \u200b\u6240\u4ee5\u200b\uff0c\u200b\u5efa\u8bae\u200b\u4f7f\u7528\u200b\u6d41\u7a0b\u200b\u5982\u4e0b\u200b:\n * 1. \u200b\u5206\u914d\u200bbuffer\uff0c\u200b\u8fd9\u4e2a\u200bbuffer\u200b\u7684\u200b\u524d\u9762\u200b8\u200b\u5b57\u8282\u200b\u5bf9\u5e94\u200b\"control setup packet\"\uff0c\u200b\u540e\u9762\u200b\u7684\u200b\u7a7a\u95f4\u200b\u53ef\u4ee5\u200b\u7528\u6765\u200b\u4fdd\u5b58\u200b\u5176\u4ed6\u200b\u6570\u636e\u200b\n * 2. \u200b\u8bbe\u7f6e\u200b\"control setup packet\"\uff0c\u200b\u901a\u8fc7\u200b\u8c03\u7528\u200blibusb_fill_control_setup()\u200b\u51fd\u6570\u200b\u6765\u200b\u8bbe\u7f6e\u200b\n * 3. \u200b\u5982\u679c\u200b\u662f\u200b\u8981\u200b\u628a\u200b\u6570\u636e\u200b\u53d1\u9001\u200b\u4e2a\u200b\u8bbe\u5907\u200b\uff0c\u200b\u628a\u200b\u8981\u200b\u53d1\u9001\u200b\u7684\u200b\u6570\u636e\u200b\u653e\u5728\u200bbuffer\u200b\u7684\u200b\u540e\u9762\u200b(\u200b\u4ece\u200bbuffer[8]\u200b\u5f00\u59cb\u200b\u653e\u200b)\n * 4. \u200b\u8c03\u7528\u200blibusb_fill_bulk_transfer\n * 5. \u200b\u63d0\u4ea4\u200b\u4f20\u8f93\u200b: \u200b\u8c03\u7528\u200blibusb_submit_transfer()\n *\n * \u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u8ba9\u200bbuffer\u200b\u53c2\u6570\u200b\u4e3a\u200bNULL\uff0c\n * \u200b\u8fd9\u79cd\u200b\u60c5\u51b5\u200b\u4e0b\u200blibusb_transfer::length\u200b\u5c31\u200b\u4e0d\u4f1a\u200b\u88ab\u200b\u8bbe\u7f6e\u200b,\n * \u200b\u9700\u8981\u200b\u624b\u5de5\u200b\u53bb\u200b\u8bbe\u7f6e\u200bibusb_transfer::buffer\u3001ibusb_transfer::length\n *\n * \u200b\u53c2\u6570\u200b:\n * transfer - \u200b\u8981\u200b\u8bbe\u7f6e\u200b\u7684\u200blibusb_transfer\u200b\u7ed3\u6784\u200b\u4f53\u200b\n * dev_handle - \u200b\u8bbe\u5907\u200b\u53e5\u67c4\u200b\n * buffer - \u200b\u6570\u636e\u200bbuffer\uff0c\u200b\u5982\u679c\u200b\u4e0d\u662f\u200bNULL\u200b\u7684\u8bdd\u200b\uff0c\u200b\u5b83\u200b\u524d\u9762\u200b8\u200b\u76f4\u63a5\u200b\u4f1a\u200b\u88ab\u200b\u5f53\u505a\u200b\"control setup packet\"\u200b\u6765\u200b\u5904\u7406\u200b\uff0c\n *          \u200b\u4e5f\u200b\u4f1a\u200b\u4ece\u200bbuffer[6], buffer[7]\u200b\u628a\u200blength\u200b\u63d0\u53d6\u200b\u51fa\u6765\u200b\uff0c\u200b\u7528\u6765\u200b\u8bbe\u7f6e\u200blibusb_transfer::length\n *           \u200b\u8fd9\u4e2a\u200bbuffer\u200b\u5fc5\u987b\u200b\u662f\u200b2\u200b\u5b57\u8282\u200b\u5bf9\u9f50\u200b\n * callback - \u200b\u4f20\u8f93\u200b\u5b8c\u6210\u200b\u65f6\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\n * user_data - \u200b\u4f20\u7ed9\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u7684\u200b\u53c2\u6570\u200b\n * timeout - \u200b\u8d85\u65f6\u200b\u65f6\u95f4\u200b(\u200b\u5355\u4f4d\u200b: ms)\n */\nstatic inline void libusb_fill_control_transfer(\n    struct libusb_transfer *transfer, libusb_device_handle *dev_handle,\n    unsigned char *buffer, libusb_transfer_cb_fn callback, void *user_data,\n    unsigned int timeout);\n</code></pre>"},{"location":"12_USB/06_1/#294","title":"2.9.4 \u200b\u586b\u5145\u200b\u6279\u91cf\u200b\u4f20\u8f93","text":"<pre><code>/** \\ingroup libusb_asyncio\n * \u200b\u6784\u9020\u200b\u6279\u91cf\u200b\u4f20\u8f93\u200b\u7ed3\u6784\u200b\u4f53\u200b\n *\n * \u200b\u53c2\u6570\u200b:\n * transfer - \u200b\u8981\u200b\u8bbe\u7f6e\u200b\u7684\u200blibusb_transfer\u200b\u7ed3\u6784\u200b\u4f53\u200b\n * dev_handle - \u200b\u8bbe\u5907\u200b\u53e5\u67c4\u200b\n * endpoint - \u200b\u7aef\u70b9\u200b\n * buffer - \u200b\u6570\u636e\u200bbuffer\n * length - buffer\u200b\u7684\u200b\u6570\u636e\u200b\u957f\u5ea6\u200b\n * callback - \u200b\u4f20\u8f93\u200b\u5b8c\u6210\u200b\u65f6\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\n * user_data - \u200b\u4f20\u7ed9\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u7684\u200b\u53c2\u6570\u200b\n * timeout - \u200b\u8d85\u65f6\u200b\u65f6\u95f4\u200b(\u200b\u5355\u4f4d\u200b: ms)\n */\nstatic inline void libusb_fill_bulk_transfer(struct libusb_transfer *transfer,\n    libusb_device_handle *dev_handle, unsigned char endpoint,\n    unsigned char *buffer, int length, libusb_transfer_cb_fn callback,\n    void *user_data, unsigned int timeout);\n</code></pre>"},{"location":"12_USB/06_1/#295","title":"2.9.5 \u200b\u586b\u5145\u200b\u4e2d\u65ad\u200b\u4f20\u8f93","text":"<pre><code>/** \\ingroup libusb_asyncio\n * \u200b\u6784\u9020\u200b\u4e2d\u65ad\u200b\u4f20\u8f93\u200b\u7ed3\u6784\u200b\u4f53\u200b\n *\n * \u200b\u53c2\u6570\u200b:\n * transfer - \u200b\u8981\u200b\u8bbe\u7f6e\u200b\u7684\u200blibusb_transfer\u200b\u7ed3\u6784\u200b\u4f53\u200b\n * dev_handle - \u200b\u8bbe\u5907\u200b\u53e5\u67c4\u200b\n * endpoint - \u200b\u7aef\u70b9\u200b\n * buffer - \u200b\u6570\u636e\u200bbuffer\n * length - buffer\u200b\u7684\u200b\u6570\u636e\u200b\u957f\u5ea6\u200b\n * callback - \u200b\u4f20\u8f93\u200b\u5b8c\u6210\u200b\u65f6\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\n * user_data - \u200b\u4f20\u7ed9\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u7684\u200b\u53c2\u6570\u200b\n * timeout - \u200b\u8d85\u65f6\u200b\u65f6\u95f4\u200b(\u200b\u5355\u4f4d\u200b: ms)\n */\nstatic inline void libusb_fill_interrupt_transfer(\n    struct libusb_transfer *transfer, libusb_device_handle *dev_handle,\n    unsigned char endpoint, unsigned char *buffer, int length,\n    libusb_transfer_cb_fn callback, void *user_data, unsigned int timeout);\n</code></pre>"},{"location":"12_USB/06_1/#296","title":"2.9.6 \u200b\u586b\u5145\u200b\u5b9e\u65f6\u200b\u4f20\u8f93","text":"<pre><code>/** \\ingroup libusb_asyncio\n * \u200b\u6784\u9020\u200b\u5b9e\u65f6\u200b\u4f20\u8f93\u200b\u7ed3\u6784\u200b\u4f53\u200b\n *\n * \u200b\u53c2\u6570\u200b:\n * transfer - \u200b\u8981\u200b\u8bbe\u7f6e\u200b\u7684\u200blibusb_transfer\u200b\u7ed3\u6784\u200b\u4f53\u200b\n * dev_handle - \u200b\u8bbe\u5907\u200b\u53e5\u67c4\u200b\n * endpoint - \u200b\u7aef\u70b9\u200b\n * buffer - \u200b\u6570\u636e\u200bbuffer\n * length - buffer\u200b\u7684\u200b\u6570\u636e\u200b\u957f\u5ea6\u200b\n * num_iso_packets - \u200b\u5b9e\u65f6\u200b\u4f20\u8f93\u200b\u5305\u200b\u7684\u200b\u4e2a\u6570\u200b\n * callback - \u200b\u4f20\u8f93\u200b\u5b8c\u6210\u200b\u65f6\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\n * user_data - \u200b\u4f20\u7ed9\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u7684\u200b\u53c2\u6570\u200b\n * timeout - \u200b\u8d85\u65f6\u200b\u65f6\u95f4\u200b(\u200b\u5355\u4f4d\u200b: ms)\n */\nstatic inline void libusb_fill_iso_transfer(struct libusb_transfer *transfer,\n    libusb_device_handle *dev_handle, unsigned char endpoint,\n    unsigned char *buffer, int length, int num_iso_packets,\n    libusb_transfer_cb_fn callback, void *user_data, unsigned int timeout);\n</code></pre>"},{"location":"12_USB/06_1/#297","title":"2.9.7 \u200b\u63d0\u4ea4\u200b\u4f20\u8f93","text":"<pre><code>/** \\ingroup libusb_asyncio\n * \u200b\u63d0\u4ea4\u200b\u4f20\u8f93\u200bSubmit\uff0c\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u4f1a\u200b\u542f\u52a8\u200b\u4f20\u8f93\u200b\uff0c\u200b\u7136\u540e\u200b\u7acb\u523b\u200b\u8fd4\u56de\u200b\n *\n * \u200b\u53c2\u6570\u200b:\n * transfer - \u200b\u8981\u200b\u4f20\u8f93\u200b\u7684\u200blibusb_transfer\u200b\u7ed3\u6784\u200b\u4f53\u200b\n *\n * \u200b\u8fd4\u56de\u503c\u200b:\n * 0 - \u200b\u6210\u529f\u200b\n * LIBUSB_ERROR_NO_DEVICE - \u200b\u8bbe\u5907\u200b\u672a\u200b\u8fde\u63a5\u200b\n * LIBUSB_ERROR_BUSY - \u200b\u8fd9\u4e2a\u200b\u4f20\u8f93\u200b\u5df2\u7ecf\u200b\u63d0\u4ea4\u200b\u8fc7\u200b\u4e86\u200b\n * LIBUSB_ERROR_NOT_SUPPORTED - \u200b\u4e0d\u200b\u652f\u6301\u200b\u8fd9\u4e2a\u200b\u4f20\u8f93\u200b\n * LIBUSB_ERROR_INVALID_PARAM - \u200b\u4f20\u8f93\u200b\u7684\u200b\u5b57\u8282\u200b\u8d85\u8fc7\u200bOS\u200b\u6216\u786c\u4ef6\u200b\u7684\u200b\u652f\u6301\u200b\n * \u200b\u5176\u4ed6\u200bLIBUSB_ERROR\u200b\u9519\u8bef\u7801\u200b\n */\nint API_EXPORTED libusb_submit_transfer(struct libusb_transfer *transfer);\n</code></pre>"},{"location":"12_USB/06_1/#298","title":"2.9.8 \u200b\u5904\u7406\u4e8b\u4ef6","text":"<p>\u200b\u6709\u200b4\u200b\u4e2a\u200b\u51fd\u6570\u200b\uff0c\u200b\u5176\u4e2d\u200b2\u200b\u4e2a\u200b\u6ca1\u6709\u200b<code>completed</code>\u200b\u540e\u7f00\u200b\u7684\u200b\u51fd\u6570\u200b\u8fc7\u65f6\u200b\u4e86\u200b\uff1a</p> <pre><code>/** \\ingroup libusb_poll\n * \u200b\u5904\u7406\u200b\u4efb\u4f55\u200b\"pengding\u200b\u7684\u200b\u4e8b\u4ef6\u200b\"\n *\n * \u200b\u4f7f\u7528\u200b\u5f02\u6b65\u200b\u4f20\u8f93\u200b\u51fd\u6570\u200b\u65f6\u200b\uff0c\u200b\u63d0\u4ea4\u200b\u7684\u200btranfer\u200b\u7ed3\u6784\u200b\u4f53\u540e\u200b\u5c31\u200b\u8fd4\u56de\u200b\u4e86\u200b\u3002\n * \u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u672c\u200b\u51fd\u6570\u200b\u5904\u7406\u200b\u8fd9\u4e9b\u200b\u4f20\u8f93\u200b\u7684\u200b\u8fd4\u56de\u200b\u7ed3\u679c\u200b\u3002\n *\n * \u200b\u5982\u679c\u200btimeval\u200b\u53c2\u6570\u200b\u4e3a\u200b0\uff0c\u200b\u672c\u200b\u51fd\u6570\u200b\u4f1a\u200b\u5904\u7406\u200b\"\u200b\u5f53\u524d\u200b\u3001\u200b\u5df2\u7ecf\u200bpending\u200b\u7684\u200b\u4e8b\u4ef6\u200b\"\uff0c\u200b\u7136\u540e\u200b\u9a6c\u4e0a\u200b\u8fd4\u56de\u200b\u3002\n *\n * \u200b\u5982\u679c\u200btimeval\u200b\u53c2\u6570\u200b\u4e0d\u200b\u4e3a\u200b0\uff0c\u200b\u5e76\u4e14\u200b\u5f53\u524d\u200b\u6ca1\u6709\u200b\u5f85\u5904\u7406\u200b\u7684\u200b\u4e8b\u4ef6\u200b\uff0c\u200b\u672c\u200b\u51fd\u6570\u200b\u4f1a\u200b\u963b\u585e\u200b\u4ee5\u200b\u7b49\u5f85\u200b\u4e8b\u4ef6\u200b\uff0c\u200b\u76f4\u5230\u200b\u8d85\u65f6\u200b\u3002\n * \u200b\u5728\u200b\u7b49\u5f85\u200b\u8fc7\u7a0b\u200b\u4e2d\u200b\uff0c\u200b\u5982\u679c\u200b\u4e8b\u4ef6\u200b\u53d1\u751f\u200b\u4e86\u200b\u3001\u200b\u6216\u8005\u200b\u5f97\u5230\u200b\u4e86\u200b\u4fe1\u53f7\u200b(signal)\uff0c\u200b\u90a3\u4e48\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u4f1a\u200b\u63d0\u524d\u200b\u8fd4\u56de\u200b\u3002\n *\n * completed\u200b\u53c2\u6570\u200b\u7528\u6765\u200b\u907f\u514d\u200b\u7ade\u4e89\u200b\uff0c\u200b\u5982\u679c\u200b\u5b83\u200b\u4e0d\u200b\u4e3a\u200bNULL:\n * \u200b\u672c\u200b\u51fd\u6570\u200b\u83b7\u5f97\u200b\"event handling lock\"\u200b\u540e\u200b\uff0c\u200b\u4f1a\u200b\u5224\u65ad\u200bcompleted\u200b\u6307\u5411\u200b\u7684\u200b\u6570\u503c\u200b\uff0c\n * \u200b\u5982\u679c\u200b\u8fd9\u4e2a\u200b\u6570\u503c\u200b\u975e\u200b0(\u200b\u8868\u793a\u200b\u522b\u7684\u200b\u7ebf\u7a0b\u200b\u5df2\u7ecf\u200b\u5904\u7406\u200b\u4e86\u200b\u3001\u200b\u5df2\u7ecf\u200bcompleted\u200b\u4e86\u200b)\uff0c\n * \u200b\u5219\u200b\u672c\u200b\u51fd\u6570\u200b\u4f1a\u200b\u7acb\u523b\u200b\u8fd4\u56de\u200b(\u200b\u65e2\u7136\u200b\u90fd\u200bcompleted\u200b\u4e86\u200b\uff0c\u200b\u5f53\u7136\u200b\u65e0\u9700\u200b\u518d\u200b\u5904\u7406\u200b)\n *\n * \u200b\u53c2\u6570\u200b:\n * ctx - context(\u200b\u5982\u679c\u200b\u4f20\u5165\u200bNULL\u200b\u5219\u200b\u4f7f\u7528\u200b\u9ed8\u8ba4\u200bcontext)\n * tv - \u200b\u7b49\u5f85\u200b\u4e8b\u4ef6\u200b\u7684\u200b\u6700\u5927\u200b\u65f6\u95f4\u200b\uff0c0\u200b\u8868\u793a\u200b\u4e0d\u200b\u7b49\u5f85\u200b\n * completed - \u200b\u6307\u9488\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u4f20\u5165\u200bNULL\n *\n * \u200b\u8fd4\u56de\u503c\u200b:\n * 0 - \u200b\u6210\u529f\u200b\n * LIBUSB_ERROR_INVALID_PARAM - timeval\u200b\u53c2\u6570\u200b\u65e0\u6548\u200b\n * \u200b\u5176\u4ed6\u200bLIBUSB_ERROR\u200b\u9519\u8bef\u7801\u200b\n */\nint API_EXPORTED libusb_handle_events_timeout_completed(libusb_context *ctx,\n    struct timeval *tv, int *completed);\n\n/** \\ingroup libusb_poll\n * \u200b\u5904\u7406\u200b\u4efb\u4f55\u200b\"pengding\u200b\u7684\u200b\u4e8b\u4ef6\u200b\"\n *\n * \u200b\u8ddf\u200blibusb_handle_events_timeout_completed()\u200b\u7c7b\u4f3c\u200b,\n * \u200b\u5c31\u662f\u200b\u8c03\u7528\u200b\"libusb_handle_events_timeout_completed(ctx, tv, NULL);\"\n * \u200b\u6700\u540e\u200b\u7684\u200bcompleted\u200b\u53c2\u6570\u200b\u4e3a\u200bNULL\u3002\n *\n * \u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u53ea\u662f\u200b\u4e3a\u4e86\u200b\u4fdd\u6301\u200b\u5411\u200b\u540e\u200b\u517c\u5bb9\u200b\uff0c\u200b\u65b0\u200b\u7684\u200b\u4ee3\u7801\u200b\u5efa\u8bae\u200b\u4f7f\u7528\u200blibusb_handle_events_completed()\u200b\u6216\u200b\n * libusb_handle_events_timeout_completed()\uff0c\n * \u200b\u8fd9\u200b2\u200b\u4e2a\u200b\u65b0\u200b\u51fd\u6570\u200b\u53ef\u4ee5\u200b\u5904\u7406\u200b\u7ade\u4e89\u200b\u3002\n *\n * \u200b\u53c2\u6570\u200b:\n * ctx - context(\u200b\u5982\u679c\u200b\u4f20\u5165\u200bNULL\u200b\u5219\u200b\u4f7f\u7528\u200b\u9ed8\u8ba4\u200bcontext)\n * tv - \u200b\u7b49\u5f85\u200b\u4e8b\u4ef6\u200b\u7684\u200b\u6700\u5927\u200b\u65f6\u95f4\u200b\uff0c0\u200b\u8868\u793a\u200b\u4e0d\u200b\u7b49\u5f85\u200b\n *\n * \u200b\u8fd4\u56de\u503c\u200b:\n * 0 - \u200b\u6210\u529f\u200b\n * LIBUSB_ERROR_INVALID_PARAM - timeval\u200b\u53c2\u6570\u200b\u65e0\u6548\u200b\n * \u200b\u5176\u4ed6\u200bLIBUSB_ERROR\u200b\u9519\u8bef\u7801\u200b\n */\nint API_EXPORTED libusb_handle_events_timeout(libusb_context *ctx,\n    struct timeval *tv);\n\n/** \\ingroup libusb_poll\n * \u200b\u5904\u7406\u200b\u4efb\u4f55\u200b\"pengding\u200b\u7684\u200b\u4e8b\u4ef6\u200b\"\uff0c\u200b\u4ee5\u200b\u963b\u585e\u200b\u65b9\u5f0f\u200b\u5904\u7406\u200b(blocking mode)\n *\n * \u200b\u672c\u200b\u51fd\u6570\u200b\u7684\u200b\u5185\u90e8\u200b\u5b9e\u73b0\u200b\u5c31\u662f\u200b\u8c03\u7528\u200b: libusb_handle_events_timeout_completed(ctx, &amp;tv, completed);\n * \u200b\u8d85\u65f6\u200b\u65f6\u95f4\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b60\u200b\u79d2\u200b\n *\n * \u200b\u53c2\u6570\u200b:\n * ctx - context(\u200b\u5982\u679c\u200b\u4f20\u5165\u200bNULL\u200b\u5219\u200b\u4f7f\u7528\u200b\u9ed8\u8ba4\u200bcontext)\n * completed - \u200b\u6307\u9488\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u4f20\u5165\u200bNULL\n *\n * \u200b\u8fd4\u56de\u503c\u200b:\n * 0 - \u200b\u6210\u529f\u200b\n * LIBUSB_ERROR_INVALID_PARAM - timeval\u200b\u53c2\u6570\u200b\u65e0\u6548\u200b\n * \u200b\u5176\u4ed6\u200bLIBUSB_ERROR\u200b\u9519\u8bef\u7801\u200b\n */\nint API_EXPORTED libusb_handle_events_completed(libusb_context *ctx,\n    int *completed);\n\n/** \\ingroup libusb_poll\n * \u200b\u5904\u7406\u200b\u4efb\u4f55\u200b\"pengding\u200b\u7684\u200b\u4e8b\u4ef6\u200b\"\uff0c\u200b\u4ee5\u200b\u963b\u585e\u200b\u65b9\u5f0f\u200b\u5904\u7406\u200b(blocking mode)\n *\n * \u200b\u672c\u200b\u51fd\u6570\u200b\u7684\u200b\u5185\u90e8\u200b\u5b9e\u73b0\u200b\u5c31\u662f\u200b\u8c03\u7528\u200b: libusb_handle_events_timeout_completed(ctx, &amp;tv, NULL);\n * \u200b\u8d85\u65f6\u200b\u65f6\u95f4\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b60\u200b\u79d2\u200b\n *\n * \u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u53ea\u662f\u200b\u4e3a\u4e86\u200b\u4fdd\u6301\u200b\u5411\u200b\u540e\u200b\u517c\u5bb9\u200b\uff0c\u200b\u65b0\u200b\u7684\u200b\u4ee3\u7801\u200b\u5efa\u8bae\u200b\u4f7f\u7528\u200blibusb_handle_events_completed()\u200b\u6216\u200b\n * libusb_handle_events_timeout_completed()\uff0c\n * \u200b\u8fd9\u200b2\u200b\u4e2a\u200b\u65b0\u200b\u51fd\u6570\u200b\u53ef\u4ee5\u200b\u5904\u7406\u200b\u7ade\u4e89\u200b\u3002\n * \n * \u200b\u53c2\u6570\u200b:\n * ctx - context(\u200b\u5982\u679c\u200b\u4f20\u5165\u200bNULL\u200b\u5219\u200b\u4f7f\u7528\u200b\u9ed8\u8ba4\u200bcontext)\n *\n * \u200b\u8fd4\u56de\u503c\u200b:\n * 0 - \u200b\u6210\u529f\u200b\n * LIBUSB_ERROR_INVALID_PARAM - timeval\u200b\u53c2\u6570\u200b\u65e0\u6548\u200b\n * \u200b\u5176\u4ed6\u200bLIBUSB_ERROR\u200b\u9519\u8bef\u7801\u200b\n */\nint API_EXPORTED libusb_handle_events(libusb_context *ctx);\n</code></pre>"},{"location":"12_USB/06_1/#299-transfer","title":"2.9.9 \u200b\u91ca\u653e\u200btransfer\u200b\u7ed3\u6784\u200b\u4f53","text":"<p>\u200b\u4f20\u8f93\u200b\u5b8c\u6bd5\u200b\uff0c\u200b\u9700\u8981\u200b\u91ca\u653e\u200blibusb_transfer\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u5982\u679c\u200b\u8981\u200b\u91cd\u590d\u200b\u5229\u7528\u200b\u8fd9\u4e2a\u200b\u7ed3\u6784\u200b\u4f53\u5219\u200b\u65e0\u9700\u200b\u91ca\u653e\u200b\u3002</p> <pre><code>/** \\ingroup libusb_asyncio\n * \u200b\u91ca\u653e\u200blibusb_transfer\u200b\u7ed3\u6784\u200b\u4f53\u200b\n * \u200b\u524d\u9762\u200b\u4f7f\u7528\u200blibusb_alloc_transfer()\u200b\u5206\u914d\u200b\u7684\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u8981\u200b\u4f7f\u7528\u200b\u672c\u200b\u51fd\u6570\u200b\u6765\u200b\u91ca\u653e\u200b\u3002\n *\n * \u200b\u5982\u679c\u200blibusb_transfer::flags\u200b\u7684\u200bLIBUSB_TRANSFER_FREE_BUFFER\u200b\u4f4d\u975e\u200b0\uff0c\n * \u200b\u90a3\u4e48\u200b\u4f1a\u200b\u4f7f\u7528\u200bfree()\u200b\u51fd\u6570\u200b\u91ca\u653e\u200bibusb_transfer::buffer\n * \n * \u200b\u4e0d\u80fd\u200b\u4f7f\u7528\u200b\u672c\u200b\u51fd\u6570\u200b\u91ca\u653e\u200b\u4e00\u4e2a\u200b\u6d3b\u52a8\u200b\u7684\u200b\u4f20\u8f93\u200b\u7ed3\u6784\u200b\u4f53\u200b(active, \u200b\u5df2\u7ecf\u200b\u63d0\u4ea4\u200b\u5c1a\u672a\u200b\u7ed3\u675f\u200b)\n * \n */\nvoid API_EXPORTED libusb_free_transfer(struct libusb_transfer *transfer);\n</code></pre>"},{"location":"12_USB/06_1/#3","title":"3. \u200b\u4f7f\u7528\u200b\u793a\u4f8b","text":"<p>\u200b\u5728\u200blibusb\u200b\u6e90\u7801\u200b\u7684\u200bexamples\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6709\u200b\u793a\u4f8b\u200b\u7a0b\u5e8f\u200b\uff0c\u200b\u6211\u4eec\u200b\u4e5f\u200b\u6709\u200b\u4e00\u4e9b\u200b\u771f\u5b9e\u200b\u7684\u200b\u6848\u5217\u200b\u3002</p>"},{"location":"12_USB/06_1/#31-dnw","title":"3.1 dnw\u200b\u5de5\u5177","text":"<p>dnw\u200b\u662f\u200bs3c2440\u200b\u65f6\u4ee3\u200b\u7684\u200b\u5de5\u5177\u200b\uff0c\u200b\u4f7f\u7528\u200b\u5b83\u200b\u53ef\u4ee5\u200b\u4ece\u200bPC\u200b\u7ed9\u200b\u5f00\u53d1\u677f\u200b\u4f20\u8f93\u200b\u6587\u4ef6\u200b\u3002\u200b\u5b83\u200b\u7684\u200b\u6838\u5fc3\u200b\u6e90\u7801\u200b\u5982\u4e0b\u200b\uff0c\u200b\u4f7f\u7528\u200b\u540c\u6b65\u200b\u63a5\u53e3\u200b\u8fdb\u884c\u200b\u6570\u636e\u4f20\u8f93\u200b\uff1a</p> <pre><code>    /* open the device using libusb */\n    status = libusb_init(NULL);\n    if (status &lt; 0) {\n        printf(\"libusb_init() failed: %s\\n\", libusb_error_name(status));\n        return -1;\n    }\n\n    hdev = libusb_open_device_with_vid_pid(NULL, (uint16_t)DNW_DEVICE_IDVENDOR, (uint16_t)DNW_DEVICE_IDPRODUCT);\n    if (hdev == NULL) {\n        printf(\"libusb_open() failed\\n\");\n        goto err3;\n    }\n\n    /* We need to claim the first interface */\n    libusb_set_auto_detach_kernel_driver(hdev, 1);\n    status = libusb_claim_interface(hdev, 0);\n    if (status != LIBUSB_SUCCESS) {\n        libusb_close(hdev);\n        printf(\"libusb_claim_interface failed: %s\\n\", libusb_error_name(status));\n        goto err2;\n    }\n\n    ret =  libusb_bulk_transfer(hdev, 0x03, buf, num_write, &amp;transferred, 3000);\n</code></pre>"},{"location":"12_USB/06_1/#32-openocd","title":"3.2 openocd","text":"<p>openocd\u200b\u662f\u200b\u4e00\u4e2a\u200b\u5f00\u6e90\u200b\u7684\u200bUSB JTAG\u200b\u8c03\u8bd5\u200b\u8f6f\u4ef6\u200b\uff0c\u200b\u5b83\u200b\u4e5f\u200b\u662f\u200b\u4f7f\u7528\u200blibusb\uff0c\u200b\u6d89\u53ca\u200bUSB\u200b\u7684\u200b\u64cd\u4f5c\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b\u3002</p>"},{"location":"12_USB/06_1/#321","title":"3.2.1 \u200b\u627e\u5230\u200b\u8bbe\u5907","text":"<pre><code>static int cmsis_dap_usb_open(struct cmsis_dap *dap, uint16_t vids[], uint16_t pids[], const char *serial)\n{\n    int err;\n    struct libusb_context *ctx;\n    struct libusb_device **device_list;\n\n    err = libusb_init(&amp;ctx);\n    if (err) {\n        LOG_ERROR(\"libusb initialization failed: %s\", libusb_strerror(err));\n        return ERROR_FAIL;\n    }\n\n    int num_devices = libusb_get_device_list(ctx, &amp;device_list);\n    if (num_devices &lt; 0) {\n        LOG_ERROR(\"could not enumerate USB devices: %s\", libusb_strerror(num_devices));\n        libusb_exit(ctx);\n        return ERROR_FAIL;\n    }\n\n    for (int i = 0; i &lt; num_devices; i++) {\n        struct libusb_device *dev = device_list[i];\n        struct libusb_device_descriptor dev_desc;\n\n        err = libusb_get_device_descriptor(dev, &amp;dev_desc);\n        if (err) {\n            LOG_ERROR(\"could not get device descriptor for device %d: %s\", i, libusb_strerror(err));\n            continue;\n        }\n\n        /* Match VID/PID */\n\n        bool id_match = false;\n        bool id_filter = vids[0] || pids[0];\n        for (int id = 0; vids[id] || pids[id]; id++) {\n            id_match = !vids[id] || dev_desc.idVendor == vids[id];\n            id_match &amp;= !pids[id] || dev_desc.idProduct == pids[id];\n\n            if (id_match)\n                break;\n        }\n\n        if (id_filter &amp;&amp; !id_match)\n            continue;\n\n        /* Don't continue if we asked for a serial number and the device doesn't have one */\n        if (dev_desc.iSerialNumber == 0 &amp;&amp; serial &amp;&amp; serial[0])\n            continue;\n\n        struct libusb_device_handle *dev_handle = NULL;\n        err = libusb_open(dev, &amp;dev_handle);\n        if (err) {\n            /* It's to be expected that most USB devices can't be opened\n             * so only report an error if it was explicitly selected\n             */\n            if (id_filter) {\n                LOG_ERROR(\"could not open device 0x%04x:0x%04x: %s\",\n                        dev_desc.idVendor, dev_desc.idProduct, libusb_strerror(err));\n            } else {\n                LOG_DEBUG(\"could not open device 0x%04x:0x%04x: %s\",\n                        dev_desc.idVendor, dev_desc.idProduct, libusb_strerror(err));\n            }\n            continue;\n        }\n\n        /* Match serial number */\n\n        bool serial_match = false;\n        char dev_serial[256] = {0};\n        if (dev_desc.iSerialNumber &gt; 0) {\n            err = libusb_get_string_descriptor_ascii(\n                    dev_handle, dev_desc.iSerialNumber,\n                    (uint8_t *)dev_serial, sizeof(dev_serial));\n\n            if (err &lt; 0) {\n                const char *msg = \"could not read serial number for device 0x%04x:0x%04x: %s\";\n                if (serial)\n                    LOG_WARNING(msg, dev_desc.idVendor, dev_desc.idProduct,\n                                libusb_strerror(err));\n                else\n                    LOG_DEBUG(msg, dev_desc.idVendor, dev_desc.idProduct,\n                                libusb_strerror(err));\n            } else if (serial &amp;&amp; strncmp(dev_serial, serial, sizeof(dev_serial)) == 0) {\n                serial_match = true;\n            }\n        }\n\n        if (serial &amp;&amp; !serial_match) {\n            libusb_close(dev_handle);\n            continue;\n        }\n\n        /* Find the CMSIS-DAP string in product string */\n\n        bool cmsis_dap_in_product_str = false;\n        char product_string[256] = {0};\n        if (dev_desc.iProduct &gt; 0) {\n            err = libusb_get_string_descriptor_ascii(\n                    dev_handle, dev_desc.iProduct,\n                    (uint8_t *)product_string, sizeof(product_string));\n            if (err &lt; 0) {\n                LOG_WARNING(\"could not read product string for device 0x%04x:0x%04x: %s\",\n                        dev_desc.idVendor, dev_desc.idProduct, libusb_strerror(err));\n            } else if (strstr(product_string, \"CMSIS-DAP\")) {\n                LOG_DEBUG(\"found product string of 0x%04x:0x%04x '%s'\",\n                          dev_desc.idVendor, dev_desc.idProduct, product_string);\n                cmsis_dap_in_product_str = true;\n            }\n        }\n\n        bool device_identified_reliably = cmsis_dap_in_product_str\n                                            || serial_match || id_match;\n\n        /* Find the CMSIS-DAP interface */\n\n        for (int config = 0; config &lt; dev_desc.bNumConfigurations; config++) {\n            struct libusb_config_descriptor *config_desc;\n            err = libusb_get_config_descriptor(dev, config, &amp;config_desc);\n            if (err) {\n                LOG_ERROR(\"could not get configuration descriptor %d for device 0x%04x:0x%04x: %s\",\n                        config, dev_desc.idVendor, dev_desc.idProduct, libusb_strerror(err));\n                continue;\n            }\n\n            LOG_DEBUG(\"enumerating interfaces of 0x%04x:0x%04x\",\n                      dev_desc.idVendor, dev_desc.idProduct);\n            int config_num = config_desc-&gt;bConfigurationValue;\n            const struct libusb_interface_descriptor *intf_desc_candidate = NULL;\n            const struct libusb_interface_descriptor *intf_desc_found = NULL;\n\n            for (int interface = 0; interface &lt; config_desc-&gt;bNumInterfaces; interface++) {\n                const struct libusb_interface_descriptor *intf_desc = &amp;config_desc-&gt;interface[interface].altsetting[0];\n                int interface_num = intf_desc-&gt;bInterfaceNumber;\n\n                /* Skip this interface if another one was requested explicitly */\n                if (cmsis_dap_usb_interface != -1 &amp;&amp; cmsis_dap_usb_interface != interface_num)\n                    continue;\n\n                /* CMSIS-DAP v2 spec says:\n                 *\n                 * CMSIS-DAP with default V2 configuration uses WinUSB and is therefore faster.\n                 * Optionally support for streaming SWO trace is provided via an additional USB endpoint.\n                 *\n                 * The WinUSB configuration requires custom class support with the interface setting\n                 *     Class Code: 0xFF (Vendor specific)\n                 *     Subclass: 0x00\n                 *     Protocol code: 0x00\n                 *\n                 * Depending on the configuration it uses the following USB endpoints which should be configured\n                 * in the interface descriptor in this order:\n                 *  - Endpoint 1: Bulk Out \u2013 used for commands received from host PC.\n                 *  - Endpoint 2: Bulk In \u2013 used for responses send to host PC.\n                 *  - Endpoint 3: Bulk In (optional) \u2013 used for streaming SWO trace (if enabled with SWO_STREAM).\n                 */\n\n                /* Search for \"CMSIS-DAP\" in the interface string */\n                bool cmsis_dap_in_interface_str = false;\n                if (intf_desc-&gt;iInterface != 0) {\n\n                    char interface_str[256] = {0};\n\n                    err = libusb_get_string_descriptor_ascii(\n                            dev_handle, intf_desc-&gt;iInterface,\n                            (uint8_t *)interface_str, sizeof(interface_str));\n                    if (err &lt; 0) {\n                        LOG_DEBUG(\"could not read interface string %d for device 0x%04x:0x%04x: %s\",\n                                  intf_desc-&gt;iInterface,\n                                  dev_desc.idVendor, dev_desc.idProduct,\n                                  libusb_strerror(err));\n                    } else if (strstr(interface_str, \"CMSIS-DAP\")) {\n                        cmsis_dap_in_interface_str = true;\n                        LOG_DEBUG(\"found interface %d string '%s'\",\n                                  interface_num, interface_str);\n                    }\n                }\n\n                /* Bypass the following check if this interface was explicitly requested. */\n                if (cmsis_dap_usb_interface == -1) {\n                    if (!cmsis_dap_in_product_str &amp;&amp; !cmsis_dap_in_interface_str)\n                        continue;\n                }\n\n                /* check endpoints */\n                if (intf_desc-&gt;bNumEndpoints &lt; 2) {\n                    LOG_DEBUG(\"skipping interface %d, has only %d endpoints\",\n                              interface_num, intf_desc-&gt;bNumEndpoints);\n                    continue;\n                }\n\n                if ((intf_desc-&gt;endpoint[0].bmAttributes &amp; 3) != LIBUSB_TRANSFER_TYPE_BULK ||\n                        (intf_desc-&gt;endpoint[0].bEndpointAddress &amp; 0x80) != LIBUSB_ENDPOINT_OUT) {\n                    LOG_DEBUG(\"skipping interface %d, endpoint[0] is not bulk out\",\n                              interface_num);\n                    continue;\n                }\n\n                if ((intf_desc-&gt;endpoint[1].bmAttributes &amp; 3) != LIBUSB_TRANSFER_TYPE_BULK ||\n                        (intf_desc-&gt;endpoint[1].bEndpointAddress &amp; 0x80) != LIBUSB_ENDPOINT_IN) {\n                    LOG_DEBUG(\"skipping interface %d, endpoint[1] is not bulk in\",\n                              interface_num);\n                    continue;\n                }\n\n                /* We can rely on the interface is really CMSIS-DAP if\n                 * - we've seen CMSIS-DAP in the interface string\n                 * - config asked explicitly for an interface number\n                 * - the device has only one interface\n                 * The later two cases should be honored only if we know\n                 * we are on the right device */\n                bool intf_identified_reliably = cmsis_dap_in_interface_str\n                            || (device_identified_reliably &amp;&amp;\n                                    (cmsis_dap_usb_interface != -1\n                                     || config_desc-&gt;bNumInterfaces == 1));\n\n                if (intf_desc-&gt;bInterfaceClass != LIBUSB_CLASS_VENDOR_SPEC ||\n                        intf_desc-&gt;bInterfaceSubClass != 0 || intf_desc-&gt;bInterfaceProtocol != 0) {\n                    /* If the interface is reliably identified\n                     * then we need not insist on setting USB class, subclass and protocol\n                     * exactly as the specification requires.\n                     * At least KitProg3 uses class 0 contrary to the specification */\n                    if (intf_identified_reliably) {\n                        LOG_WARNING(\"Using CMSIS-DAPv2 interface %d with wrong class %\" PRId8\n                                  \" subclass %\" PRId8 \" or protocol %\" PRId8,\n                                  interface_num,\n                                  intf_desc-&gt;bInterfaceClass,\n                                  intf_desc-&gt;bInterfaceSubClass,\n                                  intf_desc-&gt;bInterfaceProtocol);\n                    } else {\n                        LOG_DEBUG(\"skipping interface %d, class %\" PRId8\n                                  \" subclass %\" PRId8 \" protocol %\" PRId8,\n                                  interface_num,\n                                  intf_desc-&gt;bInterfaceClass,\n                                  intf_desc-&gt;bInterfaceSubClass,\n                                  intf_desc-&gt;bInterfaceProtocol);\n                        continue;\n\n                    }\n                }\n\n                if (intf_identified_reliably) {\n                    /* That's the one! */\n                    intf_desc_found = intf_desc;\n                    break;\n                }\n\n                if (!intf_desc_candidate &amp;&amp; device_identified_reliably) {\n                    /* This interface looks suitable for CMSIS-DAP. Store the pointer to it\n                     * and keep searching for another one with CMSIS-DAP in interface string */\n                    intf_desc_candidate = intf_desc;\n                }\n            }\n\n            if (!intf_desc_found) {\n                /* We were not able to identify reliably which interface is CMSIS-DAP.\n                 * Let's use the first suitable if we found one */\n                intf_desc_found = intf_desc_candidate;\n            }\n\n            if (!intf_desc_found) {\n                libusb_free_config_descriptor(config_desc);\n                continue;\n            }\n\n            /* We've chosen an interface, connect to it */\n            int interface_num = intf_desc_found-&gt;bInterfaceNumber;\n            int packet_size = intf_desc_found-&gt;endpoint[0].wMaxPacketSize;\n            int ep_out = intf_desc_found-&gt;endpoint[0].bEndpointAddress;\n            int ep_in = intf_desc_found-&gt;endpoint[1].bEndpointAddress;\n\n            libusb_free_config_descriptor(config_desc);\n            libusb_free_device_list(device_list, true);\n\n            LOG_INFO(\"Using CMSIS-DAPv2 interface with VID:PID=0x%04x:0x%04x, serial=%s\",\n                    dev_desc.idVendor, dev_desc.idProduct, dev_serial);\n\n            int current_config;\n            err = libusb_get_configuration(dev_handle, &amp;current_config);\n            if (err) {\n                LOG_ERROR(\"could not find current configuration: %s\", libusb_strerror(err));\n                libusb_close(dev_handle);\n                libusb_exit(ctx);\n                return ERROR_FAIL;\n            }\n\n            if (config_num != current_config) {\n                err = libusb_set_configuration(dev_handle, config_num);\n                if (err) {\n                    LOG_ERROR(\"could not set configuration: %s\", libusb_strerror(err));\n                    libusb_close(dev_handle);\n                    libusb_exit(ctx);\n                    return ERROR_FAIL;\n                }\n            }\n\n            err = libusb_claim_interface(dev_handle, interface_num);\n            if (err)\n                LOG_WARNING(\"could not claim interface: %s\", libusb_strerror(err));\n\n            dap-&gt;bdata = malloc(sizeof(struct cmsis_dap_backend_data));\n            if (!dap-&gt;bdata) {\n                LOG_ERROR(\"unable to allocate memory\");\n                libusb_release_interface(dev_handle, interface_num);\n                libusb_close(dev_handle);\n                libusb_exit(ctx);\n                return ERROR_FAIL;\n            }\n\n            dap-&gt;packet_size = packet_size;\n            dap-&gt;packet_buffer_size = packet_size;\n            dap-&gt;bdata-&gt;usb_ctx = ctx;\n            dap-&gt;bdata-&gt;dev_handle = dev_handle;\n            dap-&gt;bdata-&gt;ep_out = ep_out;\n            dap-&gt;bdata-&gt;ep_in = ep_in;\n            dap-&gt;bdata-&gt;interface = interface_num;\n\n            dap-&gt;packet_buffer = malloc(dap-&gt;packet_buffer_size);\n            if (!dap-&gt;packet_buffer) {\n                LOG_ERROR(\"unable to allocate memory\");\n                cmsis_dap_usb_close(dap);\n                return ERROR_FAIL;\n            }\n\n            dap-&gt;command = dap-&gt;packet_buffer;\n            dap-&gt;response = dap-&gt;packet_buffer;\n\n            return ERROR_OK;\n        }\n\n        libusb_close(dev_handle);\n    }\n\n    libusb_free_device_list(device_list, true);\n\n    libusb_exit(ctx);\n    return ERROR_FAIL;\n}\n</code></pre>"},{"location":"12_USB/06_1/#322","title":"3.2.2 \u200b\u8bfb\u5199\u200b\u6570\u636e","text":"<pre><code>static int cmsis_dap_usb_read(struct cmsis_dap *dap, int timeout_ms)\n{\n    int transferred = 0;\n    int err;\n\n    err = libusb_bulk_transfer(dap-&gt;bdata-&gt;dev_handle, dap-&gt;bdata-&gt;ep_in,\n                            dap-&gt;packet_buffer, dap-&gt;packet_size, &amp;transferred, timeout_ms);\n    if (err) {\n        if (err == LIBUSB_ERROR_TIMEOUT) {\n            return ERROR_TIMEOUT_REACHED;\n        } else {\n            LOG_ERROR(\"error reading data: %s\", libusb_strerror(err));\n            return ERROR_FAIL;\n        }\n    }\n\n    memset(&amp;dap-&gt;packet_buffer[transferred], 0, dap-&gt;packet_buffer_size - transferred);\n\n    return transferred;\n}\n\nstatic int cmsis_dap_usb_write(struct cmsis_dap *dap, int txlen, int timeout_ms)\n{\n    int transferred = 0;\n    int err;\n\n    /* skip the first byte that is only used by the HID backend */\n    err = libusb_bulk_transfer(dap-&gt;bdata-&gt;dev_handle, dap-&gt;bdata-&gt;ep_out,\n                            dap-&gt;packet_buffer, txlen, &amp;transferred, timeout_ms);\n    if (err) {\n        if (err == LIBUSB_ERROR_TIMEOUT) {\n            return ERROR_TIMEOUT_REACHED;\n        } else {\n            LOG_ERROR(\"error writing data: %s\", libusb_strerror(err));\n            return ERROR_FAIL;\n        }\n    }\n\n    return transferred;\n}\n</code></pre>"},{"location":"12_USB/07_1/","title":"\u4f7f\u7528\u200blibusb\u200b\u8bfb\u53d6\u200b\u9f20\u6807\u200b\u6570\u636e","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>libusb API\u200b\u63a5\u53e3\u200b\uff1ahttps://libusb.sourceforge.io/api-1.0/</p> </li> <li> <p>libusb \u200b\u793a\u4f8b\u200b\uff1ahttps://github.com/libusb/libusb/tree/master/examples</p> </li> <li> <p>HID\u200b\u89c4\u8303\u200b\uff1ahttps://www.usb.org/sites/default/files/hid1_11.pdf (\u200b\u6587\u4ef6\u200b\u5df2\u7ecf\u200b\u4e0b\u8f7d\u200b\u653e\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b)</p> </li> <li> <p>\u200b\u6587\u6863\u200b\uff1aUSB Human Interface Devices,  https://wiki.osdev.org/USB_Human_Interface_Devices</p> </li> </ul>"},{"location":"12_USB/07_1/#1-hid","title":"1. HID\u200b\u534f\u8bae","text":"<p>HID: Human Interface Devices, \u200b\u4eba\u7c7b\u200b\u7528\u6765\u200b\u8ddf\u200b\u8ba1\u7b97\u673a\u200b\u4ea4\u4e92\u200b\u7684\u200b\u8bbe\u5907\u200b\u3002\u200b\u5c31\u662f\u200b\u9f20\u6807\u200b\u3001\u200b\u952e\u76d8\u200b\u3001\u200b\u6e38\u620f\u200b\u624b\u67c4\u200b\u7b49\u200b\u8bbe\u5907\u200b\u3002 \u200b\u5bf9\u4e8e\u200bUSB\u200b\u63a5\u53e3\u200b\u7684\u200bHID\u200b\u8bbe\u5907\u200b\uff0c\u200b\u6709\u200b\u4e00\u5957\u200b\u534f\u8bae\u200b\u3002</p>"},{"location":"12_USB/07_1/#11","title":"1.1 \u200b\u63cf\u8ff0\u7b26","text":"<p>HID\u200b\u8bbe\u5907\u200b\u6709\u200b\u5982\u4e0b\u200b\u63cf\u8ff0\u7b26\u200b\uff1a</p> <p></p> <ul> <li>HID\u200b\u8bbe\u5907\u200b\u7684\u200b\"\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b\"\u200b\u5e76\u200b\u65e0\u200b\u5b9e\u9645\u610f\u4e49\u200b\uff0c\u200b\u6ca1\u6709\u200b\u4f7f\u7528\u200b\"\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b\"\u200b\u6765\u200b\u8868\u793a\u200b\u81ea\u5df1\u200b\u662f\u200bHID\u200b\u8bbe\u5907\u200b\u3002</li> <li>HID\u200b\u8bbe\u5907\u200b\u53ea\u6709\u200b\u4e00\u4e2a\u200b\u914d\u7f6e\u200b\uff0c\u200b\u6240\u4ee5\u200b\u53ea\u6709\u200b\u4e00\u4e2a\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26\u200b</li> <li>\u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26\u200b</li> <li>bInterfaceClass\u200b\u4e3a\u200b3\uff0c\u200b\u8868\u793a\u200b\u5b83\u200b\u662f\u200bHID\u200b\u8bbe\u5907\u200b</li> <li>bInterfaceSubClass\u200b\u662f\u200b0\u200b\u6216\u200b1\uff0c1\u200b\u8868\u793a\u200b\u5b83\u200b\u652f\u6301\u200b\"Boot Interface\"(\u200b\u8868\u793a\u200bPC\u200b\u7684\u200bBIOS\u200b\u80fd\u200b\u8bc6\u522b\u200b\u3001\u200b\u4f7f\u7528\u200b\u5b83\u200b)\uff0c0\u200b\u8868\u793a\u200b\u5fc5\u987b\u200b\u7b49\u200b\u64cd\u4f5c\u7cfb\u7edf\u200b\u542f\u52a8\u200b\u540e\u200b\u901a\u8fc7\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6765\u200b\u4f7f\u7528\u200b\u5b83\u200b\u3002</li> <li>bInterfaceProtocol\uff1a0-None, 1-\u200b\u952e\u76d8\u200b, 2-\u200b\u9f20\u6807\u200b</li> <li>\u200b\u7aef\u70b9\u200b\u63cf\u8ff0\u7b26\u200b\uff1aHID\u200b\u8bbe\u5907\u200b\u6709\u200b\u4e00\u4e2a\u200b\u63a7\u5236\u200b\u7aef\u70b9\u200b\u3001\u200b\u4e00\u4e2a\u200b\u4e2d\u65ad\u200b\u7aef\u70b9\u200b   </li> </ul> <p>\u200b\u5bf9\u4e8e\u200b\u9f20\u6807\u200b\uff0cHOST\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200b\u4e2d\u65ad\u200b\u7aef\u70b9\u200b\u8bfb\u200b\u5230\u200b\u6570\u636e\u200b\u3002</p>"},{"location":"12_USB/07_1/#12","title":"1.2 \u200b\u6570\u636e\u683c\u5f0f","text":""},{"location":"12_USB/07_1/#121","title":"1.2.1 \u200b\u952e\u76d8","text":"<p>\u200b\u901a\u8fc7\u200b\u4e2d\u65ad\u200b\u4f20\u8f93\u200b\u53ef\u4ee5\u200b\u8bfb\u200b\u5230\u200b\u952e\u76d8\u200b\u6570\u636e\u200b\uff0c\u200b\u5b83\u200b\u662f\u200b8\u200b\u5b57\u8282\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> \u200b\u504f\u79fb\u200b \u200b\u5927\u5c0f\u200b \u200b\u63cf\u8ff0\u200b 0 1\u200b\u5b57\u8282\u200b \"Modifier keys status\"\uff0c\u200b\u5c31\u662f\u200bctrl\u3001alt\u3001shift\u200b\u7b49\u200b\u6309\u952e\u200b\u7684\u200b\u72b6\u6001\u200b 1 1\u200b\u5b57\u8282\u200b \u200b\u4fdd\u7559\u200b 2 1\u200b\u5b57\u8282\u200b \u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u6309\u952e\u200b\u7684\u200b\u952e\u503c\u200b 3 1\u200b\u5b57\u8282\u200b \u200b\u7b2c\u200b2\u200b\u4e2a\u200b\u6309\u952e\u200b\u7684\u200b\u952e\u503c\u200b 4 1\u200b\u5b57\u8282\u200b \u200b\u7b2c\u200b3\u200b\u4e2a\u200b\u6309\u952e\u200b\u7684\u200b\u952e\u503c\u200b 5 1\u200b\u5b57\u8282\u200b \u200b\u7b2c\u200b4\u200b\u4e2a\u200b\u6309\u952e\u200b\u7684\u200b\u952e\u503c\u200b 6 1\u200b\u5b57\u8282\u200b \u200b\u7b2c\u200b5\u200b\u4e2a\u200b\u6309\u952e\u200b\u7684\u200b\u952e\u503c\u200b 7 1\u200b\u5b57\u8282\u200b \u200b\u7b2c\u200b6\u200b\u4e2a\u200b\u6309\u952e\u200b\u7684\u200b\u952e\u503c\u200b <p>\u200b\u7b2c\u200b0\u200b\u4e2a\u200b\u5b57\u8282\u200b\u4e2d\u200b\u6bcf\u200b\u4e00\u4f4d\u200b\u90fd\u200b\u8868\u793a\u200b\u4e00\u4e2a\u200b\u6309\u952e\u200b\u7684\u200b\u72b6\u6001\u200b\uff0c\u200b\u67d0\u4f4d\u200b\u7b49\u4e8e\u200b1\u200b\u65f6\u200b\uff0c\u200b\u8868\u793a\u200b\u5bf9\u5e94\u200b\u7684\u200b\u6309\u952e\u200b\u88ab\u200b\u6309\u200b\u4e0b\u200b\uff0c\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> \u200b\u4f4d\u200b \u200b\u957f\u5ea6\u200b \u200b\u63cf\u8ff0\u200b 0 1 Left Ctrl 1 1 Left Shift 2 1 Left Alt 3 1 Left GUI(Windows/Super key) 4 1 Right Ctrl 5 1 Right Shift 6 1 Right Alt 7 1 Right GUI(Windows/Super key) <p>\u200b\u8bfb\u5230\u200b\u7684\u200b\u952e\u76d8\u200b\u6570\u636e\u200b\u91cc\u200b\u6709\u200b6\u200b\u4e2a\u200b\u6309\u952e\u200b\u503c\u200b\uff0c\u200b\u6bcf\u4e2a\u200b\u6309\u952e\u200b\u503c\u200b\u90fd\u200b\u662f\u200b8\u200b\u4f4d\u200b\u7684\u200b\u6570\u636e\u200b\u3002\u200b\u5982\u679c\u200b\u67d0\u4e2a\u200b\u6309\u952e\u200b\u503c\u200b\u4e0d\u200b\u7b49\u4e8e\u200b0\uff0c\u200b\u5c31\u200b\u8868\u793a\u200b\u67d0\u4e2a\u200b\u6309\u952e\u200b\u88ab\u200b\u6309\u200b\u4e0b\u200b\u4e86\u200b\u3002 \u200b\u6309\u952e\u200b\u503c\u200b\u8ddf\u200b\u6309\u952e\u200b\u7684\u200b\u5bf9\u5e94\u200b\u5173\u7cfb\u200b\uff0c\u200b\u8bf7\u200b\u770b\u200b\u540e\u9762\u200b\u7684\u200b\u300a1.2.4 \u200b\u626b\u63cf\u200b\u7801\u200b\u300b\u3002</p> <p>\u200b\u793a\u4f8b\u200b\uff1a\u200b\u6309\u952e\u200b\"A\"\u3001\"B\"\u3001\"C\"\u3001\"X\"\u200b\u7684\u200b\u6309\u952e\u200b\u503c\u200b\u5206\u522b\u200b\u662f\u200b4\u30015\u30016\u30010x1B\u3002</p> <p>\u200b\u6309\u4e0b\u200b\u4e86\u200b\"A\"\uff0cUSB\u200b\u952e\u76d8\u200b\u4e0a\u62a5\u200b\u7684\u200b\u6570\u636e\u200b\u4e3a\u200b\uff1a</p> <pre><code>00 00 04 00 00 00 00 00\n</code></pre> <p>\u200b\u677e\u5f00\u200b\"A\"\uff0cUSB\u200b\u952e\u76d8\u200b\u4e0a\u62a5\u200b\u7684\u200b\u6570\u636e\u200b\u4e3a\u200b\uff1a</p> <pre><code>00 00 00 00 00 00 00 00\n</code></pre> <p>\u200b\u6309\u4e0b\u200b\"A\"\u3001\"B\"\uff0cUSB\u200b\u952e\u76d8\u200b\u4e0a\u62a5\u200b\u7684\u200b\u6570\u636e\u200b\u4e3a\u200b\uff1a</p> <pre><code>00 00 04 05 00 00 00 00\n</code></pre> <p>\u200b\u4fdd\u6301\u200b\"A\"\u3001\"B\"\u200b\u4e0d\u200b\u677e\u5f00\u200b\uff0c\u200b\u7ee7\u7eed\u200b\u6309\u4e0b\u200b\"C\"\uff0cUSB\u200b\u952e\u76d8\u200b\u4e0a\u62a5\u200b\u7684\u200b\u6570\u636e\u200b\u4e3a\u200b\uff1a</p> <pre><code>00 00 04 05 06 00 00 00\n</code></pre> <p>\u200b\u677e\u5f00\u200b\"A\"\uff0c\u200b\u4f46\u662f\u200b\u4fdd\u6301\u200b\"B\"\u3001\"C\"\u200b\u4e0d\u200b\u677e\u5f00\u200b\uff0cUSB\u200b\u952e\u76d8\u200b\u4e0a\u62a5\u200b\u7684\u200b\u6570\u636e\u200b\u4e3a\u200b\uff1a</p> <pre><code>00 00 05 06 00 00 00 00\n</code></pre> <p>USB\u200b\u952e\u76d8\u200b\u4e0a\u62a5\u200b\u7684\u200b\u6570\u636e\u200b\u91cc\u200b\uff0c\u200b\u54ea\u4e2a\u200b\u6309\u952e\u200b\u5148\u200b\u88ab\u200b\u6309\u200b\u4e0b\u200b\uff0c\u200b\u5c31\u200b\u5148\u200b\u8bb0\u5f55\u200b\u5b83\u200b\u7684\u200b\u6309\u952e\u200b\u503c\u200b\u3002\u200b\u5728\u200b\u4e0a\u9762\u200b\u7684\u200b\u4f8b\u5b50\u200b\u91cc\u200b\uff0c\"A\"\u200b\u677e\u5f00\u200b\u540e\u200b\u53ea\u6709\u200b\"B\"\u3001\"C\"\u200b\u8fd9\u200b\u4e24\u4e2a\u200b\u6309\u952e\u200b\uff0c\"B\"\u3001\"C\"\u200b\u7684\u200b\u6309\u952e\u200b\u503c\u200b\u632a\u5230\u200b\u4e86\u200b\u524d\u9762\u200b\u3002</p> <p>\u200b\u6309\u4e0b\u200b\"Left shift\"\u3001\u200b\u5e76\u4e14\u200b\u6309\u4e0b\u200b\"X\"\uff0cUSB\u200b\u952e\u76d8\u200b\u4e0a\u62a5\u200b\u7684\u200b\u6570\u636e\u200b\u4e3a\u200b\uff1a</p> <pre><code>02 00 1B 00 00 00 00 00\n</code></pre> <p>USB\u200b\u952e\u76d8\u200b\u53ea\u80fd\u200b\u4e0a\u62a5\u200b6\u200b\u4e2a\u200b\u6309\u952e\u200b\u503c\u200b\uff0c\u200b\u5982\u679c\u200b\u6709\u200b\u8d85\u8fc7\u200b6\u200b\u4e2a\u200b\u6309\u952e\u200b\u88ab\u200b\u6309\u200b\u4e0b\u200b\uff0c\u200b\u90a3\u4e48\u200b\u5b83\u200b\u8bb2\u200b\u4e0a\u62a5\u200b\"phantom condition\"(6\u200b\u4e2a\u200b\u6309\u952e\u200b\u503c\u200b\u90fd\u200b\u662f\u200b1)\uff0c\u200b\u4f46\u662f\u200b\"Modifier keys status\"\u200b\u8fd8\u662f\u200b\u6709\u6548\u200b\u7684\u200b\u3002\u200b\u6bd4\u5982\u200b\"Right Shift\"\u200b\u88ab\u200b\u6309\u200b\u4e0b\u200b\uff0c\u200b\u53e6\u5916\u200b\u8d85\u8fc7\u200b6\u200b\u4e2a\u200b\u7684\u200b\u6309\u952e\u200b\u4e5f\u200b\u88ab\u200b\u6309\u200b\u4e0b\u200b\u65f6\u200b\uff0cUSB\u200b\u952e\u76d8\u200b\u4e0a\u62a5\u200b\u7684\u200b\u6570\u636e\u200b\u4e3a\u200b\uff1a</p> <pre><code>20 00 01 01 01 01 01 01\n</code></pre>"},{"location":"12_USB/07_1/#122-led","title":"1.2.2 LED","text":"<p>\u200b\u6211\u4eec\u200b\u8fd8\u200b\u53ef\u200b\u63a7\u5236\u200b\u952e\u76d8\u200b\u7684\u200bLED\uff0c\u200b\u9700\u8981\u200b\u53d1\u51fa\u200b\u4e00\u4e2a\u200b\u63a7\u5236\u4f20\u8f93\u200b\u8bf7\u6c42\u200b\uff1aSetReport \uff0c\u200b\u4f7f\u7528\u200b\u8fd9\u4e2a\u200b\u8bf7\u6c42\u200b\u53d1\u9001\u200b\u4e00\u4e2a\u200b\u5b57\u8282\u200b\u7684\u200b\u6570\u636e\u200b\u3002</p> <p>\u200b\u8fd9\u4e2a\u200b\u5b57\u8282\u200b\u7684\u200b\u6570\u636e\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff0c\u200b\u67d0\u4f4d\u200b\u4e3a\u200b1\u200b\u65f6\u200b\uff0c\u200b\u4f1a\u200b\u70b9\u4eae\u200b\u76f8\u5e94\u200b\u7684\u200bLED\uff1a</p> \u200b\u4f4d\u200b \u200b\u957f\u5ea6\u200b \u200b\u63cf\u8ff0\u200b 0 1 Num Lock 1 1 Caps Lock 2 1 Scroll Lock 3 1 Compose 4 1 Kana 5 1 \u200b\u4fdd\u7559\u200b\uff0c\u200b\u5199\u4e3a\u200b0 <p>\u200b\u53d1\u51fa\u200b\u7684\u200bSetReport\uff0c\u200b\u662f\u200b\u4e00\u4e2a\u200b\u63a7\u5236\u4f20\u8f93\u200b\u7684\u200b\"setup packet\"\uff0c\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u4ee5\u200blibusb\u200b\u7684\u200b\u51fd\u6570\u200b\u63cf\u8ff0\u200b\u5b83\u200b\u7684\u200b\u53c2\u6570\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>int LIBUSB_CALL libusb_control_transfer(libusb_device_handle *dev_handle,\n    uint8_t request_type, uint8_t bRequest, uint16_t wValue, uint16_t wIndex,\n    unsigned char *data, uint16_t wLength, unsigned int timeout);\n\n/* \u200b\u793a\u4f8b\u200b\u4ee3\u7801\u200b */\nunsigned char data = (1&lt;&lt;1); /* \u200b\u70b9\u4eae\u200bCaps Lock */\nuint16_t wValue = (0x02&lt;&lt;8)|0; // 0x02: \u200b\u53d1\u7ed9\u200b\u8bbe\u5907\u200b, 0: report ID\nuint16_t wIndex = 0; // \u200b\u4e00\u822c\u200b\u662f\u200b0, the interface number of the USB keyboard\nlibusb_control_transfer(dev_handle, 0x21, 0x09, wValue, wIndex, &amp;data, 1, timeout);\n</code></pre>"},{"location":"12_USB/07_1/#123","title":"1.2.3 \u200b\u9f20\u6807","text":"<p>\u200b\u901a\u8fc7\u200b\u4e2d\u65ad\u200b\u4f20\u8f93\u200b\u53ef\u4ee5\u200b\u8bfb\u200b\u5230\u200b\u9f20\u6807\u200b\u6570\u636e\u200b\uff0c\u200b\u5b83\u200b\u662f\u200b8\u200b\u5b57\u8282\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> \u200b\u504f\u79fb\u200b \u200b\u5927\u5c0f\u200b \u200b\u63cf\u8ff0\u200b 0 1\u200b\u5b57\u8282\u200b 1 1\u200b\u5b57\u8282\u200b \u200b\u6309\u952e\u200b\u72b6\u6001\u200b 2 2\u200b\u5b57\u8282\u200b X\u200b\u4f4d\u79fb\u200b 4 2\u200b\u5b57\u8282\u200b Y\u200b\u4f4d\u79fb\u200b 6 1\u200b\u5b57\u8282\u200b\u6216\u200b2\u200b\u5b57\u8282\u200b \u200b\u6eda\u8f6e\u200b <p>\u200b\u6309\u952e\u200b\u72b6\u6001\u200b\u91cc\u200b\uff0c\u200b\u6bcf\u200b\u4e00\u4f4d\u200b\u5bf9\u5e94\u200b\u9f20\u6807\u200b\u7684\u200b\u4e00\u4e2a\u200b\u6309\u952e\u200b\uff0c\u200b\u7b49\u200b1\u200b\u65f6\u200b\u8868\u793a\u200b\u5bf9\u5e94\u200b\u6309\u952e\u200b\u88ab\u200b\u70b9\u51fb\u200b\u4e86\u200b\uff0c\u200b\u683c\u5f0f\u200b\u5982\u4e0b\u200b\uff1a</p> \u200b\u4f4d\u200b \u200b\u957f\u5ea6\u200b \u200b\u63cf\u8ff0\u200b 0 1 \u200b\u9f20\u6807\u200b\u7684\u200b\u5de6\u952e\u200b 1 1 \u200b\u9f20\u6807\u200b\u7684\u200b\u53f3\u952e\u200b 2 1 \u200b\u9f20\u6807\u200b\u7684\u200b\u4e2d\u95f4\u200b\u952e\u200b 3 5 \u200b\u4fdd\u7559\u200b\uff0c\u200b\u8bbe\u5907\u200b\u81ea\u5df1\u200b\u5b9a\u4e49\u200bbit3: \u200b\u9f20\u6807\u200b\u7684\u200b\u4fa7\u8fb9\u200b\u6309\u952e\u200bbit4: <p>X\u200b\u4f4d\u79fb\u200b\u3001Y\u200b\u4f4d\u79fb\u200b\u90fd\u200b\u662f\u200b8\u200b\u4f4d\u200b\u7684\u200b\u6709\u200b\u7b26\u53f7\u200b\u6570\u200b\u3002\u200b\u5bf9\u4e8e\u200bX\u200b\u4f4d\u79fb\u200b\uff0c\u200b\u8d1f\u6570\u200b\u8868\u793a\u200b\u9f20\u6807\u200b\u5411\u200b\u5de6\u200b\u79fb\u52a8\u200b\uff0c\u200b\u6b63\u6570\u200b\u8868\u793a\u200b\u9f20\u6807\u200b\u5411\u200b\u53f3\u200b\u79fb\u52a8\u200b\uff0c\u200b\u79fb\u52a8\u200b\u7684\u200b\u5e45\u5ea6\u200b\u5c31\u200b\u4f7f\u7528\u200b\u8fd9\u4e2a\u200b8\u200b\u4f4d\u200b\u6570\u636e\u8868\u793a\u200b\u3002\u200b\u5bf9\u4e8e\u200bY\u200b\u4f4d\u79fb\u200b\uff0c\u200b\u8d1f\u6570\u200b\u8868\u793a\u200b\u9f20\u6807\u200b\u5411\u4e0a\u200b\u79fb\u52a8\u200b\uff0c\u200b\u6b63\u6570\u200b\u8868\u793a\u200b\u9f20\u6807\u200b\u5411\u4e0b\u200b\u79fb\u52a8\u200b\uff0c\u200b\u79fb\u52a8\u200b\u7684\u200b\u5e45\u5ea6\u200b\u5c31\u200b\u4f7f\u7528\u200b\u8fd9\u4e2a\u200b8\u200b\u4f4d\u200b\u6570\u636e\u8868\u793a\u200b\u3002</p>"},{"location":"12_USB/07_1/#124","title":"1.2.4 \u200b\u626b\u63cf\u200b\u7801","text":"<p>USB\u200b\u89c4\u8303\u200b\u91cc\u200b\u4e3a\u200b\u6bcf\u4e2a\u200b\u6309\u952e\u200b\u5b9a\u4e49\u200b\u4e86\u200b16\u200b\u4f4d\u200b\u7684\u200b\u6309\u952e\u200b\u503c\u200b\uff0c\u200b\u6ce8\u610f\u200b\uff1a\u200b\u5b83\u200b\u662f\u200b16\u200b\u4f4d\u200b\u7684\u200b\uff0c\u200b\u4f46\u662f\u200bUSB\u200b\u952e\u76d8\u200b\u53ea\u200b\u4f7f\u7528\u200b8\u200b\u4f4d\u200b\u8868\u793a\u200b\u6309\u952e\u200b\u503c\u200b\u3002\u200b\u6240\u4ee5\u200b\u6709\u4e9b\u200b\u6309\u952e\u200b\u9700\u8981\u200b\u901a\u8fc7\u200b\"Modifier keys status\"\u200b\u6765\u200b\u786e\u5b9a\u200b\u3002\u200b\u6bd4\u5982\u200b\"Left Ctrl\"\u200b\u7684\u200b\u6309\u952e\u200b\u503c\u200b\u662f\u200b224\uff0c\u200b\u8fd9\u200b\u65e0\u6cd5\u200b\u901a\u8fc7\u200b8\u200b\u4f4d\u200b\u6570\u636e\u200b\u6765\u200b\u8868\u793a\u200b\uff0c\u200b\u5728\u200bUSB\u200b\u952e\u76d8\u200b\u4e0a\u62a5\u200b\u7684\u200b\u6570\u636e\u200b\u91cc\u200b\uff0c\u200b\u4f7f\u7528\u200b\u7b2c\u200b0\u200b\u5b57\u8282\u200b\u7684\u200bbit4\u200b\u6765\u200b\u8868\u793a\u200b\u3002</p> <p></p>"},{"location":"12_USB/07_1/#2","title":"2. \u200b\u4f7f\u7528\u200b\u540c\u6b65\u200b\u63a5\u53e3\u200b\u8bfb\u53d6\u200b\u9f20\u6807\u200b\u6570\u636e","text":"<p>\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u5982\u4e0b\u200b\u4f4d\u7f6e\u200b\uff1a</p> <p></p>"},{"location":"12_USB/07_1/#21","title":"2.1 \u200b\u7f16\u5199\u200b\u6e90\u7801","text":"<pre><code>#include &lt;errno.h&gt;\n#include &lt;signal.h&gt;\n#include &lt;stdio.h&gt;\n#include &lt;stdlib.h&gt;\n#include &lt;string.h&gt;\n\n#include &lt;libusb-1.0/libusb.h&gt;\n\nint main(int argc, char **argv)\n{\n    int err;\n    libusb_device *dev, **devs;\n    int num_devices;\n    int endpoint;\n    int interface_num;\n    int found = 0;\n    int transferred;\n    int count = 0;\n    unsigned char buffer[16];\n    struct libusb_config_descriptor *config_desc;\n    struct libusb_device_handle *dev_handle = NULL;\n\n    /* libusb_init */\n\n    err = libusb_init(NULL);\n    if (err &lt; 0) {\n        fprintf(stderr, \"failed to initialise libusb %d - %s\\n\", err, libusb_strerror(err));\n        exit(1);\n    }\n\n    /* get device list */\n    if ((num_devices = libusb_get_device_list(NULL, &amp;devs)) &lt; 0) {\n        fprintf(stderr, \"libusb_get_device_list() failed\\n\");\n        libusb_exit(NULL);\n        exit(1);\n    }\n    fprintf(stdout, \"libusb_get_device_list() ok\\n\");\n\n    /* for each device, get config descriptor */\n    for (int i = 0; i &lt; num_devices; i++) {\n        dev = devs[i];\n\n        /* parse interface descriptor, find usb mouse */        \n        err = libusb_get_config_descriptor(dev, 0, &amp;config_desc);\n        if (err) {\n            fprintf(stderr, \"could not get configuration descriptor\\n\");\n            continue;\n        }\n        fprintf(stdout, \"libusb_get_config_descriptor() ok\\n\");\n\n        for (int interface = 0; interface &lt; config_desc-&gt;bNumInterfaces; interface++) {\n            const struct libusb_interface_descriptor *intf_desc = &amp;config_desc-&gt;interface[interface].altsetting[0];\n            interface_num = intf_desc-&gt;bInterfaceNumber;\n\n            if (intf_desc-&gt;bInterfaceClass != 3 || intf_desc-&gt;bInterfaceProtocol != 2)\n                continue;\n            else\n            {\n                /* \u200b\u627e\u5230\u200b\u4e86\u200bUSB\u200b\u9f20\u6807\u200b */\n                fprintf(stdout, \"find usb mouse ok\\n\");\n                for (int ep = 0; ep &lt; intf_desc-&gt;bNumEndpoints; ep++)\n                {\n                    if ((intf_desc-&gt;endpoint[ep].bmAttributes &amp; 3) == LIBUSB_TRANSFER_TYPE_INTERRUPT ||\n                            (intf_desc-&gt;endpoint[ep].bEndpointAddress &amp; 0x80) == LIBUSB_ENDPOINT_IN) {\n                        /* \u200b\u627e\u5230\u200b\u4e86\u200b\u8f93\u5165\u200b\u7684\u200b\u4e2d\u65ad\u200b\u7aef\u70b9\u200b */\n                        fprintf(stdout, \"find in int endpoint\\n\");\n                        endpoint = intf_desc-&gt;endpoint[ep].bEndpointAddress;\n                        found = 1;\n                        break;\n                    }\n\n                }\n            }\n\n            if (found)\n                break;\n        }\n\n        libusb_free_config_descriptor(config_desc);\n\n        if (found)\n            break;        \n    }\n\n    if (!found)\n    {\n        /* free device list */\n        libusb_free_device_list(devs, 1);\n        libusb_exit(NULL);\n        exit(1);\n    }\n\n    if (found)\n    {\n        /* libusb_open */\n        err = libusb_open(dev, &amp;dev_handle);\n        if (err)\n        {\n            fprintf(stderr, \"failed to open usb mouse\\n\");\n            exit(1);\n        }\n        fprintf(stdout, \"libusb_open ok\\n\");\n    }\n\n    /* free device list */\n    libusb_free_device_list(devs, 1);\n\n    /* claim interface */\n    libusb_set_auto_detach_kernel_driver(dev_handle, 1);  \n    err = libusb_claim_interface(dev_handle, interface_num);\n    if (err)\n    {\n        fprintf(stderr, \"failed to libusb_claim_interface\\n\");\n        exit(1);\n    }\n    fprintf(stdout, \"libusb_claim_interface ok\\n\");\n\n    /* libusb_interrupt_transfer */\n    while (1)\n    {\n        err = libusb_interrupt_transfer(dev_handle, endpoint, buffer, 16, &amp;transferred, 5000);\n        if (!err) {\n            /* parser data */\n            printf(\"%04d datas: \", count++);\n            for (int i = 0; i &lt; transferred; i++)\n            {\n                printf(\"%02x \", buffer[i]);\n            }\n            printf(\"\\n\");\n        } else if (err == LIBUSB_ERROR_TIMEOUT){\n            fprintf(stderr, \"libusb_interrupt_transfer timout\\n\");\n        } else {\n            fprintf(stderr, \"libusb_interrupt_transfer err : %d\\n\", err);\n            //exit(1);\n        }\n\n    }\n\n    /* libusb_close */\n    libusb_release_interface(dev_handle, interface_num);\n    libusb_close(dev_handle);\n    libusb_exit(NULL);\n}\n</code></pre>"},{"location":"12_USB/07_1/#22","title":"2.2 \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":""},{"location":"12_USB/07_1/#221-ubuntu","title":"2.2.1 \u200b\u5728\u200bUbuntu\u200b\u4e0a\u200b\u5b9e\u9a8c","text":"<pre><code>// 1. \u200b\u5b89\u88c5\u200b\u5f00\u53d1\u5305\u200b\n$ sudo apt install libusb-1.0-0-dev\n\n// 2. \u200b\u4fee\u6539\u200b\u6e90\u7801\u200b\uff0c\u200b\u5305\u542b\u200blibusb.h \u200b\u5934\u6587\u4ef6\u200b\u65f6\u7528\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\n#include &lt;libusb-1.0/libusb.h&gt;\n\n// 3. \u200b\u7f16\u8bd1\u7a0b\u5e8f\u200b\u6307\u5b9a\u200b\u5e93\u200b\ngcc -o readmouse readmouse.c -lusb-1.0\n</code></pre>"},{"location":"12_USB/07_1/#222-imx6ull","title":"2.2.2 \u200b\u5728\u200bIMX6ULL\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u5b9e\u9a8c","text":"<ul> <li>\u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200blibusb</li> </ul> <pre><code>sudo apt-get install libtool\n\nunzip libusb-1.0.26.zip\ncd libusb-1.0.26\n./autogen.sh\n\n./configure --host=arm-buildroot-linux-gnueabihf --prefix=$PWD/tmp\n\nmake\n\nmake install\n\nls tmp/\ninclude  lib\n</code></pre> <ul> <li>\u200b\u5b89\u88c5\u200b\u5e93\u200b\u3001\u200b\u5934\u6587\u4ef6\u200b\u5230\u200b\u5de5\u5177\u200b\u94fe\u200b\u7684\u200b\u76ee\u5f55\u200b\u91cc\u200b</li> </ul> <pre><code>libusb-1.0.26/tmp/lib$ cp * -rfd /home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/arm-buildroot-linux-gnueabihf/sysroot/usr/lib/\n\nlibusb-1.0.26/tmp/include$ cp libusb-1.0 -rf /home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/arm-buildroot-linux-gnueabihf/sysroot/usr/include/\n</code></pre> <ul> <li>\u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200bapp</li> </ul> <pre><code>arm-buildroot-linux-gnueabihf-gcc -o  readmouse.c -lusb-1.0\n</code></pre> <ul> <li>\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u63d2\u5165\u200bUSB\u200b\u9f20\u6807\u200b\uff0c\u200b\u6267\u884c\u547d\u4ee4\u200b</li> </ul> <pre><code>./readmouse\n</code></pre>"},{"location":"12_USB/07_1/#223-stm32mp157","title":"2.2.3 \u200b\u5728\u200bSTM32MP157\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u5b9e\u9a8c","text":"<ul> <li> <p>STM32MP157\u200b\u7684\u200b\u5de5\u5177\u200b\u94fe\u91cc\u200b\u5df2\u7ecf\u200b\u542b\u6709\u200blibusb\uff0c\u200b\u6240\u4ee5\u200b\u65e0\u9700\u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200b\u3001\u200b\u5b89\u88c5\u200blibusb</p> </li> <li> <p>\u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200bapp</p> </li> </ul> <pre><code>arm-buildroot-linux-gnueabihf-gcc -o readmouse readmouse.c -lusb-1.0\n</code></pre> <ul> <li>\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u63d2\u5165\u200bUSB\u200b\u9f20\u6807\u200b\uff0c\u200b\u6267\u884c\u547d\u4ee4\u200b</li> </ul> <pre><code>./readmouse\n</code></pre>"},{"location":"12_USB/07_1/#3","title":"3. \u200b\u4f7f\u7528\u200b\u5f02\u6b65\u200b\u63a5\u53e3\u200b\u8bfb\u53d6\u200b\u9f20\u6807\u200b\u6570\u636e","text":"<p>\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u5982\u4e0b\u200b\u4f4d\u7f6e\u200b\uff1a</p> <p></p>"},{"location":"12_USB/07_1/#31","title":"3.1 \u200b\u7f16\u5199\u200b\u6e90\u7801","text":"<pre><code>#include &lt;errno.h&gt;\n#include &lt;signal.h&gt;\n#include &lt;stdio.h&gt;\n#include &lt;stdlib.h&gt;\n#include &lt;string.h&gt;\n\n#include &lt;libusb-1.0/libusb.h&gt;\n\nstruct usb_mouse {\n    struct libusb_device_handle *handle;\n    int interface;\n    int endpoint;\n    unsigned char buf[16];\n    int transferred;\n    struct libusb_transfer *transfer;\n    struct usb_mouse *next;\n};\n\nstatic struct usb_mouse *usb_mouse_list;\n\n\nvoid free_usb_mouses(struct usb_mouse *usb_mouse_list)\n{\n    struct usb_mouse *pnext;\n    while (usb_mouse_list)\n    {\n        pnext = usb_mouse_list-&gt;next;\n        free(usb_mouse_list);\n        usb_mouse_list = pnext;\n    }\n}\n\n\n/*  */\nint get_usb_mouses(libusb_device **devs, int num_devices, struct usb_mouse **usb_mouse_list)\n{\n    int err;\n    libusb_device *dev;\n    int endpoint;\n    int interface_num;\n    struct libusb_config_descriptor *config_desc;\n    struct libusb_device_handle *dev_handle = NULL;\n    struct usb_mouse *pmouse;\n    struct usb_mouse *list = NULL;\n    int mouse_cnt = 0;\n\n    /* for each device, get config descriptor */\n    for (int i = 0; i &lt; num_devices; i++) {\n        dev = devs[i];\n\n        /* parse interface descriptor, find usb mouse */        \n        err = libusb_get_config_descriptor(dev, 0, &amp;config_desc);\n        if (err) {\n            fprintf(stderr, \"could not get configuration descriptor\\n\");\n            continue;\n        }\n        fprintf(stdout, \"libusb_get_config_descriptor() ok\\n\");\n\n        for (int interface = 0; interface &lt; config_desc-&gt;bNumInterfaces; interface++) {\n            const struct libusb_interface_descriptor *intf_desc = &amp;config_desc-&gt;interface[interface].altsetting[0];\n            interface_num = intf_desc-&gt;bInterfaceNumber;\n\n            if (intf_desc-&gt;bInterfaceClass != 3 || intf_desc-&gt;bInterfaceProtocol != 2)\n                continue;\n            else\n            {\n                /* \u200b\u627e\u5230\u200b\u4e86\u200bUSB\u200b\u9f20\u6807\u200b */\n                fprintf(stdout, \"find usb mouse ok\\n\");\n                for (int ep = 0; ep &lt; intf_desc-&gt;bNumEndpoints; ep++)\n                {\n                    if ((intf_desc-&gt;endpoint[ep].bmAttributes &amp; 3) == LIBUSB_TRANSFER_TYPE_INTERRUPT ||\n                            (intf_desc-&gt;endpoint[ep].bEndpointAddress &amp; 0x80) == LIBUSB_ENDPOINT_IN) {\n                        /* \u200b\u627e\u5230\u200b\u4e86\u200b\u8f93\u5165\u200b\u7684\u200b\u4e2d\u65ad\u200b\u7aef\u70b9\u200b */\n                        fprintf(stdout, \"find in int endpoint\\n\");\n                        endpoint = intf_desc-&gt;endpoint[ep].bEndpointAddress;\n\n                        /* libusb_open */\n                        err = libusb_open(dev, &amp;dev_handle);\n                        if (err)\n                        {\n                            fprintf(stderr, \"failed to open usb mouse\\n\");\n                            return -1;\n                        }\n                        fprintf(stdout, \"libusb_open ok\\n\");\n\n                        /* \u200b\u8bb0\u5f55\u4e0b\u6765\u200b: \u200b\u653e\u5165\u200b\u94fe\u8868\u200b */\n                        pmouse = malloc(sizeof(struct usb_mouse));\n                        if (!pmouse)\n                        {\n                            fprintf(stderr, \"can not malloc\\n\");\n                            return -1;\n                        }\n                        pmouse-&gt;endpoint  = endpoint;\n                        pmouse-&gt;interface = interface_num;\n                        pmouse-&gt;handle    = dev_handle;\n                        pmouse-&gt;next      = NULL;\n\n                        if (!list)\n                            list = pmouse;\n                        else\n                        {\n                            pmouse-&gt;next = list;\n                            list = pmouse;\n                        }\n                        mouse_cnt++;\n                        break;\n                    }\n\n                }\n            }\n\n        }\n\n        libusb_free_config_descriptor(config_desc);\n    }\n\n    *usb_mouse_list = list;\n    return mouse_cnt;\n}\n\n\nstatic void mouse_irq(struct libusb_transfer *transfer)\n{\n    static int count = 0;\n    if (transfer-&gt;status == LIBUSB_TRANSFER_COMPLETED)\n    {\n        /* parser data */\n        printf(\"%04d datas: \", count++);\n        for (int i = 0; i &lt; transfer-&gt;actual_length; i++)\n        {\n            printf(\"%02x \", transfer-&gt;buffer[i]);\n        }\n        printf(\"\\n\");\n\n    }\n\n    if (libusb_submit_transfer(transfer) &lt; 0)\n    {\n        fprintf(stderr, \"libusb_submit_transfer err\\n\");\n    }\n}\n\nint main(int argc, char **argv)\n{\n    int err;\n    libusb_device **devs;\n    int num_devices, num_mouse;\n    struct usb_mouse *pmouse;\n\n    /* libusb_init */\n\n    err = libusb_init(NULL);\n    if (err &lt; 0) {\n        fprintf(stderr, \"failed to initialise libusb %d - %s\\n\", err, libusb_strerror(err));\n        exit(1);\n    }\n\n    /* get device list */\n    if ((num_devices = libusb_get_device_list(NULL, &amp;devs)) &lt; 0) {\n        fprintf(stderr, \"libusb_get_device_list() failed\\n\");\n        libusb_exit(NULL);\n        exit(1);\n    }\n    fprintf(stdout, \"libusb_get_device_list() ok\\n\");\n\n    /* get usb mouse */\n    num_mouse = get_usb_mouses(devs, num_devices, &amp;usb_mouse_list);\n\n    if (num_mouse &lt;= 0)\n    {\n        /* free device list */\n        libusb_free_device_list(devs, 1);\n        libusb_exit(NULL);\n        exit(1);\n    }\n    fprintf(stdout, \"get %d mouses\\n\", num_mouse);\n\n    /* free device list */\n    libusb_free_device_list(devs, 1);\n\n    /* claim interface */\n    pmouse = usb_mouse_list;\n    while (pmouse)\n    {\n        libusb_set_auto_detach_kernel_driver(pmouse-&gt;handle, 1);  \n        err = libusb_claim_interface(pmouse-&gt;handle, pmouse-&gt;interface);\n        if (err)\n        {\n            fprintf(stderr, \"failed to libusb_claim_interface\\n\");\n            exit(1);\n        }\n        pmouse = pmouse-&gt;next;\n    }\n    fprintf(stdout, \"libusb_claim_interface ok\\n\");\n\n    /* for each mouse, alloc transfer, fill transfer, submit transfer */\n    pmouse = usb_mouse_list;\n    while (pmouse)\n    {\n        /* alloc transfer */\n        pmouse-&gt;transfer = libusb_alloc_transfer(0);\n\n        /* fill transfer */\n        libusb_fill_interrupt_transfer(pmouse-&gt;transfer, pmouse-&gt;handle, pmouse-&gt;endpoint, pmouse-&gt;buf,\n            sizeof(pmouse-&gt;buf), mouse_irq, pmouse, 0);\n\n        /* submit transfer */\n        libusb_submit_transfer(pmouse-&gt;transfer);\n\n        pmouse = pmouse-&gt;next;\n    }\n\n    /* handle events */\n    while (1) {\n        struct timeval tv = { 5, 0 };\n        int r;\n\n        r = libusb_handle_events_timeout(NULL, &amp;tv);\n        if (r &lt; 0) {\n            fprintf(stderr, \"libusb_handle_events_timeout err\\n\");\n            break;\n        }\n    }\n\n\n    /* libusb_close */\n    pmouse = usb_mouse_list;\n    while (pmouse)\n    {\n        libusb_release_interface(pmouse-&gt;handle, pmouse-&gt;interface);\n        libusb_close(pmouse-&gt;handle);        \n        pmouse = pmouse-&gt;next;\n    }\n\n    free_usb_mouses(usb_mouse_list);\n\n    libusb_exit(NULL);\n}\n</code></pre>"},{"location":"12_USB/07_1/#32","title":"3.2 \u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u5b9e\u9a8c","text":""},{"location":"12_USB/08_1/","title":"USB\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u6a21\u578b","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>Linux\u200b\u5185\u6838\u200b\u6e90\u7801\u200b\uff1a<code>include\\linux\\usb.h</code></p> </li> <li> <p>Linux\u200b\u5185\u6838\u200b\u6e90\u7801\u200b\uff1a<code>drivers\\hid\\usbhid\\usbmouse.c</code></p> </li> </ul>"},{"location":"12_USB/08_1/#1-busdevdrv","title":"1. BUS/DEV/DRV\u200b\u6a21\u578b","text":"<ul> <li>\"USB\u200b\u63a5\u53e3\u200b\"\u200b\u662f\u200b\u903b\u8f91\u200b\u4e0a\u200b\u7684\u200bUSB\u200b\u8bbe\u5907\u200b\uff0c\u200b\u6211\u4eec\u200b\u7f16\u5199\u200b\u7684\u200busb_driver\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u652f\u6301\u200b\u7684\u200b\u662f\u200b\"USB\u200b\u63a5\u53e3\u200b\"\uff1a</li> </ul> <ul> <li> <p>USB\u200b\u63a7\u5236\u5668\u200b\u6216\u200bHub\u200b\u8bc6\u522b\u200b\u51fa\u200bUSB\u200b\u8bbe\u5907\u200b\u540e\u200b\uff0c\u200b\u4f1a\u200b\u521b\u5efa\u200b\u3001\u200b\u6ce8\u518c\u200busb_deive</p> </li> <li> <p>usb_device\u200b\u88ab\u200b\"drivers\\usb\\core\\generic.c\"\u200b\u9a71\u52a8\u200b\u8ba4\u9886\u200b\u540e\u200b\uff0c\u200b\u4f1a\u200b\u9009\u62e9\u200b\u3001\u200b\u8bbe\u7f6e\u200b\u67d0\u4e2a\u200b\u914d\u7f6e\u200b</p> </li> <li> <p>\u200b\u8fd9\u4e2a\u200b\u914d\u7f6e\u200b\u4e0b\u9762\u200b\u7684\u200b\u63a5\u53e3\u200b\uff0c\u200b\u90fd\u200b\u4f1a\u200b\u5206\u914d\u200b\u3001\u200b\u8bbe\u7f6e\u200b\u3001\u200b\u6ce8\u518c\u200b\u4e00\u4e2a\u200busb_interface</p> </li> <li> <p>\u200b\u5de6\u8fb9\u200b\u7684\u200busb_driver\u200b\u548c\u200b\u53f3\u8fb9\u200b\u7684\u200busb_interface\u200b\u5982\u679c\u200b\u5339\u914d\u200b\uff0c\u200b\u5219\u200b\u6389\u200b\u7528\u200busb_driver.probe</p> </li> </ul>"},{"location":"12_USB/08_1/#2","title":"2. \u200b\u63a5\u53e3\u51fd\u6570","text":"<p>\u200b\u5728\u200bUSB\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e2d\u200b\uff0c\u200b\u80fd\u200b\u4f7f\u7528\u200b\u7684\u200bUSB\u200b\u51fd\u6570\u200b\u90fd\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u5934\u6587\u4ef6\u200b\u91cc\u200b\uff1a<code>include\\linux\\usb.h</code>\u3002</p>"},{"location":"12_USB/08_1/#21-pipe","title":"2.1 pipe","text":"<p>\u200b\u4f7f\u7528\u200b\u8fd9\u4e9b\u200b\u63a5\u53e3\u51fd\u6570\u200b\u7684\u200b\u4e3b\u8981\u200b\u76ee\u7684\u200b\u662f\u200b\u4f20\u8f93\u6570\u636e\u200b\uff0c\u200b\u4f20\u8f93\u6570\u636e\u200b\u7684\u200b\u5bf9\u8c61\u200b\u662f\u200bUSB\u200b\u8bbe\u5907\u200b\u91cc\u200b\u7684\u200b\u67d0\u4e2a\u200bendpoint\uff0c\u200b\u8fd9\u200b\u88ab\u200b\u79f0\u4e3a\u200bpipe\uff1a</p> <pre><code>/* Create various pipes... */\n#define usb_sndctrlpipe(dev, endpoint)  \\\n    ((PIPE_CONTROL &lt;&lt; 30) | __create_pipe(dev, endpoint))\n#define usb_rcvctrlpipe(dev, endpoint)  \\\n    ((PIPE_CONTROL &lt;&lt; 30) | __create_pipe(dev, endpoint) | USB_DIR_IN)\n#define usb_sndisocpipe(dev, endpoint)  \\\n    ((PIPE_ISOCHRONOUS &lt;&lt; 30) | __create_pipe(dev, endpoint))\n#define usb_rcvisocpipe(dev, endpoint)  \\\n    ((PIPE_ISOCHRONOUS &lt;&lt; 30) | __create_pipe(dev, endpoint) | USB_DIR_IN)\n#define usb_sndbulkpipe(dev, endpoint)  \\\n    ((PIPE_BULK &lt;&lt; 30) | __create_pipe(dev, endpoint))\n#define usb_rcvbulkpipe(dev, endpoint)  \\\n    ((PIPE_BULK &lt;&lt; 30) | __create_pipe(dev, endpoint) | USB_DIR_IN)\n#define usb_sndintpipe(dev, endpoint)   \\\n    ((PIPE_INTERRUPT &lt;&lt; 30) | __create_pipe(dev, endpoint))\n#define usb_rcvintpipe(dev, endpoint)   \\\n    ((PIPE_INTERRUPT &lt;&lt; 30) | __create_pipe(dev, endpoint) | USB_DIR_IN)\n</code></pre>"},{"location":"12_USB/08_1/#22","title":"2.2 \u200b\u540c\u6b65\u200b\u4f20\u8f93\u200b\u51fd\u6570","text":"<p>\u200b\u5bf9\u4e8e\u200b\u63a7\u5236\u4f20\u8f93\u200b\u3001\u200b\u6279\u91cf\u200b\u4f20\u8f93\u200b\u3001\u200b\u4e2d\u65ad\u200b\u4f20\u8f93\u200b\uff0c\u200b\u6709\u200b3\u200b\u4e2a\u200b\u540c\u6b65\u200b\u51fd\u6570\u200b\u53ef\u4ee5\u200b\u7528\u6765\u200b\u76f4\u63a5\u200b\u53d1\u8d77\u200b\u4f20\u8f93\u200b\u3002\u200b\u8fd9\u4e9b\u200b\u51fd\u6570\u200b\u5185\u90e8\u200b\u4f1a\u200b\u521b\u5efa\u200b\u3001\u200b\u586b\u5145\u200b\u3001\u200b\u63d0\u4ea4\u200b\u4e00\u4e2a\u200bURB(\"usb request block\")\uff0c\u200b\u5e76\u200b\u7b49\u5f85\u200b\u5b83\u200b\u5b8c\u6210\u200b\u6216\u200b\u8d85\u65f6\u200b\u3002</p> <p>\u200b\u51fd\u6570\u200b\u539f\u578b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>/**\n * usb_control_msg - Builds a control urb, sends it off and waits for completion\n * @dev: pointer to the usb device to send the message to\n * @pipe: endpoint \"pipe\" to send the message to\n * @request: USB message request value\n * @requesttype: USB message request type value\n * @value: USB message value\n * @index: USB message index value\n * @data: pointer to the data to send\n * @size: length in bytes of the data to send\n * @timeout: time in msecs to wait for the message to complete before timing\n *  out (if 0 the wait is forever)\n *\n * Context: !in_interrupt ()\n *\n * This function sends a simple control message to a specified endpoint and\n * waits for the message to complete, or timeout.\n *\n * Don't use this function from within an interrupt context, like a bottom half\n * handler.  If you need an asynchronous message, or need to send a message\n * from within interrupt context, use usb_submit_urb().\n * If a thread in your driver uses this call, make sure your disconnect()\n * method can wait for it to complete.  Since you don't have a handle on the\n * URB used, you can't cancel the request.\n *\n * Return: If successful, the number of bytes transferred. Otherwise, a negative\n * error number.\n */\nint usb_control_msg(struct usb_device *dev, unsigned int pipe, __u8 request,\n            __u8 requesttype, __u16 value, __u16 index, void *data,\n            __u16 size, int timeout);\n\n/**\n * usb_bulk_msg - Builds a bulk urb, sends it off and waits for completion\n * @usb_dev: pointer to the usb device to send the message to\n * @pipe: endpoint \"pipe\" to send the message to\n * @data: pointer to the data to send\n * @len: length in bytes of the data to send\n * @actual_length: pointer to a location to put the actual length transferred\n *  in bytes\n * @timeout: time in msecs to wait for the message to complete before\n *  timing out (if 0 the wait is forever)\n *\n * Context: !in_interrupt ()\n *\n * This function sends a simple bulk message to a specified endpoint\n * and waits for the message to complete, or timeout.\n *\n * Don't use this function from within an interrupt context, like a bottom half\n * handler.  If you need an asynchronous message, or need to send a message\n * from within interrupt context, use usb_submit_urb() If a thread in your\n * driver uses this call, make sure your disconnect() method can wait for it to\n * complete.  Since you don't have a handle on the URB used, you can't cancel\n * the request.\n *\n * Because there is no usb_interrupt_msg() and no USBDEVFS_INTERRUPT ioctl,\n * users are forced to abuse this routine by using it to submit URBs for\n * interrupt endpoints.  We will take the liberty of creating an interrupt URB\n * (with the default interval) if the target is an interrupt endpoint.\n *\n * Return:\n * If successful, 0. Otherwise a negative error number. The number of actual\n * bytes transferred will be stored in the @actual_length parameter.\n *\n */\nint usb_bulk_msg(struct usb_device *usb_dev, unsigned int pipe,\n         void *data, int len, int *actual_length, int timeout);\n\n\n/**\n * usb_interrupt_msg - Builds an interrupt urb, sends it off and waits for completion\n * @usb_dev: pointer to the usb device to send the message to\n * @pipe: endpoint \"pipe\" to send the message to\n * @data: pointer to the data to send\n * @len: length in bytes of the data to send\n * @actual_length: pointer to a location to put the actual length transferred\n *  in bytes\n * @timeout: time in msecs to wait for the message to complete before\n *  timing out (if 0 the wait is forever)\n *\n * Context: !in_interrupt ()\n *\n * This function sends a simple interrupt message to a specified endpoint and\n * waits for the message to complete, or timeout.\n *\n * Don't use this function from within an interrupt context, like a bottom half\n * handler.  If you need an asynchronous message, or need to send a message\n * from within interrupt context, use usb_submit_urb() If a thread in your\n * driver uses this call, make sure your disconnect() method can wait for it to\n * complete.  Since you don't have a handle on the URB used, you can't cancel\n * the request.\n *\n * Return:\n * If successful, 0. Otherwise a negative error number. The number of actual\n * bytes transferred will be stored in the @actual_length parameter.\n */\nint usb_interrupt_msg(struct usb_device *usb_dev, unsigned int pipe,\n              void *data, int len, int *actual_length, int timeout);\n</code></pre>"},{"location":"12_USB/08_1/#23","title":"2.3 \u200b\u5f02\u6b65\u200b\u4f20\u8f93\u200b\u51fd\u6570","text":"<p>\u200b\u4f7f\u7528\u200bURB\u200b\u8fdb\u884c\u200b\u4f20\u8f93\u200b\u65f6\u200b\uff0c\u200b\u5b83\u200b\u662f\u200b\u5f02\u6b65\u200b\u65b9\u5f0f\u200b\uff1a\u200b\u9700\u8981\u200b\u5148\u200b\u5206\u914d\u200b\u3001\u200b\u6784\u9020\u200b\u3001\u200b\u63d0\u4ea4\u200b\u4e00\u4e2a\u200bURB(\"usb request block\")\uff0c\u200b\u5f53\u200b\u4f20\u8f93\u200b\u5b8c\u6210\u200b\u540e\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b\u3002</p> <p>\u200b\u5173\u952e\u200b\u5c31\u200b\u5728\u4e8e\u200b\u9700\u8981\u200b\u586b\u5145\u200bURB\uff1a</p> <ul> <li>dev\uff1a\u200b\u8ddf\u200b\u8c01\u200b\u4f20\u8f93\u6570\u636e\u200b</li> <li>pipe\uff1a\u200b\u8ddf\u200b\u54ea\u4e2a\u200bpipe\u200b\u4f20\u8f93\u6570\u636e\u200b</li> <li>buffer\uff1a\u200b\u91cc\u9762\u200b\u5b58\u6709\u200b\u8981\u200b\u53d1\u9001\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u6216\u8005\u200b\u7528\u6765\u200b\u63a5\u6536\u200b\u8981\u200b\u8bfb\u53d6\u200b\u7684\u200b\u6570\u636e\u200b</li> <li>\u200b\u6570\u636e\u200b\u957f\u5ea6\u200b</li> <li>\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b</li> </ul>"},{"location":"12_USB/08_1/#231-urb","title":"2.3.1 \u200b\u5206\u914d\u200b\u548c\u200b\u91ca\u653e\u200bURB","text":"<p>\u200b\u51fd\u6570\u200b\u539f\u578b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>/**\n * usb_alloc_urb - creates a new urb for a USB driver to use\n * @iso_packets: number of iso packets for this urb\n * @mem_flags: the type of memory to allocate, see kmalloc() for a list of\n *  valid options for this.\n *\n * Creates an urb for the USB driver to use, initializes a few internal\n * structures, increments the usage counter, and returns a pointer to it.\n *\n * If the driver want to use this urb for interrupt, control, or bulk\n * endpoints, pass '0' as the number of iso packets.\n *\n * The driver must call usb_free_urb() when it is finished with the urb.\n *\n * Return: A pointer to the new urb, or %NULL if no memory is available.\n */\nstruct urb *usb_alloc_urb(int iso_packets, gfp_t mem_flags);\n\n\n/**\n * usb_free_urb - frees the memory used by a urb when all users of it are finished\n * @urb: pointer to the urb to free, may be NULL\n *\n * Must be called when a user of a urb is finished with it.  When the last user\n * of the urb calls this function, the memory of the urb is freed.\n *\n * Note: The transfer buffer associated with the urb is not freed unless the\n * URB_FREE_BUFFER transfer flag is set.\n */\nvoid usb_free_urb(struct urb *urb);\n</code></pre>"},{"location":"12_USB/08_1/#232-dma-buffer","title":"2.3.2 \u200b\u5206\u914d\u200b/\u200b\u91ca\u653e\u200bDMA Buffer","text":"<p>\u200b\u53d1\u8d77\u200bUSB\u200b\u4f20\u8f93\u200b\u65f6\u200b\uff0c\u200b\u6570\u636e\u200b\u4fdd\u5b58\u200b\u5728\u200bbuffer\u200b\u91cc\u200b\u3002\u200b\u8fd9\u4e2a\u200bbuffer\u200b\u53ef\u4ee5\u200b\u662f\u200b\u4e00\u822c\u200b\u7684\u200bbuffer\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u662f\u200bDMA Buffer\u3002</p> <p>\u200b\u5bf9\u4e8e\u200b\u4e00\u822c\u200b\u7684\u200bbuffer\uff0c\u200b\u5728\u200b\u63d0\u4ea4\u200bURB\u200b\u65f6\u4f1a\u200b\u4e34\u65f6\u200b\u5206\u914d\u200b\u4e00\u4e2a\u200bDMA Buffer\uff1a</p> <ul> <li>\u200b\u53d1\u9001\u6570\u636e\u200b\u65f6\u200b\uff1a\u200b\u51fd\u6570\u200b\u5185\u90e8\u200b\u4f1a\u5148\u200b\u4ece\u200b\u4e00\u822c\u200bbuffer\u200b\u4e2d\u200b\u628a\u200b\u6570\u636e\u200b\u590d\u5236\u5230\u200bDMA Buffer\uff0c\u200b\u5728\u200b\u63d0\u4ea4\u200b\u7ed9\u200bUSB\u200b\u63a7\u5236\u5668\u200b</li> <li>\u200b\u8bfb\u53d6\u6570\u636e\u200b\u65f6\u200b\uff1aUSB\u200b\u63a7\u5236\u5668\u200b\u5148\u200b\u628a\u200b\u6570\u636e\u200b\u4f20\u5230\u200bDMA Buffer\uff0c\u200b\u51fd\u6570\u200b\u5185\u90e8\u200b\u5728\u200b\u628a\u200bDMA Buffer\u200b\u7684\u200b\u6570\u636e\u200b\u590d\u5236\u5230\u200b\u4e00\u822c\u200bbuffer</li> <li>\u200b\u4e2d\u95f4\u200b\u589e\u52a0\u200b\u4e86\u200b\u4e00\u6b21\u200b\u6570\u636e\u200b\u7684\u200b\u62f7\u8d1d\u200b\uff0c\u200b\u6548\u7387\u200b\u4f4e\u200b</li> </ul> <p>\u200b\u6211\u4eec\u200b\u53ef\u4ee5\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200bDMA Buffer\uff0c\u200b\u51fd\u6570\u200b\u539f\u578b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>/**\n * usb_alloc_coherent - allocate dma-consistent buffer for URB_NO_xxx_DMA_MAP\n * @dev: device the buffer will be used with\n * @size: requested buffer size\n * @mem_flags: affect whether allocation may block\n * @dma: used to return DMA address of buffer\n *\n * Return: Either null (indicating no buffer could be allocated), or the\n * cpu-space pointer to a buffer that may be used to perform DMA to the\n * specified device.  Such cpu-space buffers are returned along with the DMA\n * address (through the pointer provided).\n *\n * Note:\n * These buffers are used with URB_NO_xxx_DMA_MAP set in urb-&gt;transfer_flags\n * to avoid behaviors like using \"DMA bounce buffers\", or thrashing IOMMU\n * hardware during URB completion/resubmit.  The implementation varies between\n * platforms, depending on details of how DMA will work to this device.\n * Using these buffers also eliminates cacheline sharing problems on\n * architectures where CPU caches are not DMA-coherent.  On systems without\n * bus-snooping caches, these buffers are uncached.\n *\n * When the buffer is no longer used, free it with usb_free_coherent().\n */\nvoid *usb_alloc_coherent(struct usb_device *dev, size_t size, gfp_t mem_flags,\n             dma_addr_t *dma);\n\n\n/**\n * usb_free_coherent - free memory allocated with usb_alloc_coherent()\n * @dev: device the buffer was used with\n * @size: requested buffer size\n * @addr: CPU address of buffer\n * @dma: DMA address of buffer\n *\n * This reclaims an I/O buffer, letting it be reused.  The memory must have\n * been allocated using usb_alloc_coherent(), and the parameters must match\n * those provided in that allocation request.\n */\nvoid usb_free_coherent(struct usb_device *dev, size_t size, void *addr,\n               dma_addr_t dma);\n</code></pre>"},{"location":"12_USB/08_1/#233-urb","title":"2.3.3 \u200b\u586b\u5145\u200bURB","text":"<p>\u200b\u5bf9\u4e8e\u200b\u63a7\u5236\u4f20\u8f93\u200b\u3001\u200b\u6279\u91cf\u200b\u4f20\u8f93\u200b\u3001\u200b\u4e2d\u65ad\u200b\u4f20\u8f93\u200b\uff0c\u200b\u5206\u522b\u200b\u6709\u200b\u5982\u4e0b\u200b\u51fd\u6570\u200b\uff1a</p> <pre><code>/**\n * usb_fill_control_urb - initializes a control urb\n * @urb: pointer to the urb to initialize.\n * @dev: pointer to the struct usb_device for this urb.\n * @pipe: the endpoint pipe\n * @setup_packet: pointer to the setup_packet buffer\n * @transfer_buffer: pointer to the transfer buffer\n * @buffer_length: length of the transfer buffer\n * @complete_fn: pointer to the usb_complete_t function\n * @context: what to set the urb context to.\n *\n * Initializes a control urb with the proper information needed to submit\n * it to a device.\n */\nstatic inline void usb_fill_control_urb(struct urb *urb,\n                    struct usb_device *dev,\n                    unsigned int pipe,\n                    unsigned char *setup_packet,\n                    void *transfer_buffer,\n                    int buffer_length,\n                    usb_complete_t complete_fn,\n                    void *context);\n\n\n/**\n * usb_fill_bulk_urb - macro to help initialize a bulk urb\n * @urb: pointer to the urb to initialize.\n * @dev: pointer to the struct usb_device for this urb.\n * @pipe: the endpoint pipe\n * @transfer_buffer: pointer to the transfer buffer\n * @buffer_length: length of the transfer buffer\n * @complete_fn: pointer to the usb_complete_t function\n * @context: what to set the urb context to.\n *\n * Initializes a bulk urb with the proper information needed to submit it\n * to a device.\n */\nstatic inline void usb_fill_bulk_urb(struct urb *urb,\n                     struct usb_device *dev,\n                     unsigned int pipe,\n                     void *transfer_buffer,\n                     int buffer_length,\n                     usb_complete_t complete_fn,\n                     void *context);\n\n/**\n * usb_fill_int_urb - macro to help initialize a interrupt urb\n * @urb: pointer to the urb to initialize.\n * @dev: pointer to the struct usb_device for this urb.\n * @pipe: the endpoint pipe\n * @transfer_buffer: pointer to the transfer buffer\n * @buffer_length: length of the transfer buffer\n * @complete_fn: pointer to the usb_complete_t function\n * @context: what to set the urb context to.\n * @interval: what to set the urb interval to, encoded like\n *  the endpoint descriptor's bInterval value.\n *\n * Initializes a interrupt urb with the proper information needed to submit\n * it to a device.\n *\n * Note that High Speed and SuperSpeed(+) interrupt endpoints use a logarithmic\n * encoding of the endpoint interval, and express polling intervals in\n * microframes (eight per millisecond) rather than in frames (one per\n * millisecond).\n *\n * Wireless USB also uses the logarithmic encoding, but specifies it in units of\n * 128us instead of 125us.  For Wireless USB devices, the interval is passed\n * through to the host controller, rather than being translated into microframe\n * units.\n */\nstatic inline void usb_fill_int_urb(struct urb *urb,\n                    struct usb_device *dev,\n                    unsigned int pipe,\n                    void *transfer_buffer,\n                    int buffer_length,\n                    usb_complete_t complete_fn,\n                    void *context,\n                    int interval);\n</code></pre> <p>\u200b\u5982\u679c\u200bURB\u200b\u4f7f\u7528\u200bDMA Buffer\uff0c\u200b\u90a3\u4e48\u200b\u8fd8\u200b\u9700\u8981\u200b\u8bbe\u7f6e\u200b\u4e00\u4e2a\u200bflag\u200b\u8868\u660e\u200b\u8fd9\u70b9\u200b\uff1a</p> <pre><code>urb-&gt;transfer_dma = DMA address of buffer; // usb_alloc_coherent\u200b\u7684\u200b\u8f93\u51fa\u200b\u53c2\u6570\u200b\nurb-&gt;transfer_flags |= URB_NO_TRANSFER_DMA_MAP;\n</code></pre>"},{"location":"12_USB/08_1/#234-urb","title":"2.3.4 \u200b\u63d0\u4ea4\u200bURB","text":"<p>\u200b\u6784\u9020\u200b\u597d\u200bURB\u200b\u540e\u200b\uff0c\u200b\u9700\u8981\u200b\u63d0\u4ea4\u200b\u5230\u200bUSB\u200b\u7cfb\u7edf\u200b\u91cc\u200b\uff0c\u200b\u624d\u80fd\u200b\u542f\u52a8\u200b\u4f20\u8f93\u200b\u3002</p> <pre><code>/**\n * usb_submit_urb - issue an asynchronous transfer request for an endpoint\n * @urb: pointer to the urb describing the request\n * @mem_flags: the type of memory to allocate, see kmalloc() for a list\n *  of valid options for this.\n *\n * This submits a transfer request, and transfers control of the URB\n * describing that request to the USB subsystem.  Request completion will\n * be indicated later, asynchronously, by calling the completion handler.\n * The three types of completion are success, error, and unlink\n * (a software-induced fault, also called \"request cancellation\").\n *\n * URBs may be submitted in interrupt context.\n *\n * The caller must have correctly initialized the URB before submitting\n * it.  Functions such as usb_fill_bulk_urb() and usb_fill_control_urb() are\n * available to ensure that most fields are correctly initialized, for\n * the particular kind of transfer, although they will not initialize\n * any transfer flags.\n *\n * If the submission is successful, the complete() callback from the URB\n * will be called exactly once, when the USB core and Host Controller Driver\n * (HCD) are finished with the URB.  When the completion function is called,\n * control of the URB is returned to the device driver which issued the\n * request.  The completion handler may then immediately free or reuse that\n * URB.\n *\n * With few exceptions, USB device drivers should never access URB fields\n * provided by usbcore or the HCD until its complete() is called.\n * The exceptions relate to periodic transfer scheduling.  For both\n * interrupt and isochronous urbs, as part of successful URB submission\n * urb-&gt;interval is modified to reflect the actual transfer period used\n * (normally some power of two units).  And for isochronous urbs,\n * urb-&gt;start_frame is modified to reflect when the URB's transfers were\n * scheduled to start.\n *\n * Not all isochronous transfer scheduling policies will work, but most\n * host controller drivers should easily handle ISO queues going from now\n * until 10-200 msec into the future.  Drivers should try to keep at\n * least one or two msec of data in the queue; many controllers require\n * that new transfers start at least 1 msec in the future when they are\n * added.  If the driver is unable to keep up and the queue empties out,\n * the behavior for new submissions is governed by the URB_ISO_ASAP flag.\n * If the flag is set, or if the queue is idle, then the URB is always\n * assigned to the first available (and not yet expired) slot in the\n * endpoint's schedule.  If the flag is not set and the queue is active\n * then the URB is always assigned to the next slot in the schedule\n * following the end of the endpoint's previous URB, even if that slot is\n * in the past.  When a packet is assigned in this way to a slot that has\n * already expired, the packet is not transmitted and the corresponding\n * usb_iso_packet_descriptor's status field will return -EXDEV.  If this\n * would happen to all the packets in the URB, submission fails with a\n * -EXDEV error code.\n *\n * For control endpoints, the synchronous usb_control_msg() call is\n * often used (in non-interrupt context) instead of this call.\n * That is often used through convenience wrappers, for the requests\n * that are standardized in the USB 2.0 specification.  For bulk\n * endpoints, a synchronous usb_bulk_msg() call is available.\n *\n * Return:\n * 0 on successful submissions. A negative error number otherwise.\n *\n * Request Queuing:\n *\n * URBs may be submitted to endpoints before previous ones complete, to\n * minimize the impact of interrupt latencies and system overhead on data\n * throughput.  With that queuing policy, an endpoint's queue would never\n * be empty.  This is required for continuous isochronous data streams,\n * and may also be required for some kinds of interrupt transfers. Such\n * queuing also maximizes bandwidth utilization by letting USB controllers\n * start work on later requests before driver software has finished the\n * completion processing for earlier (successful) requests.\n *\n * As of Linux 2.6, all USB endpoint transfer queues support depths greater\n * than one.  This was previously a HCD-specific behavior, except for ISO\n * transfers.  Non-isochronous endpoint queues are inactive during cleanup\n * after faults (transfer errors or cancellation).\n *\n * Reserved Bandwidth Transfers:\n *\n * Periodic transfers (interrupt or isochronous) are performed repeatedly,\n * using the interval specified in the urb.  Submitting the first urb to\n * the endpoint reserves the bandwidth necessary to make those transfers.\n * If the USB subsystem can't allocate sufficient bandwidth to perform\n * the periodic request, submitting such a periodic request should fail.\n *\n * For devices under xHCI, the bandwidth is reserved at configuration time, or\n * when the alt setting is selected.  If there is not enough bus bandwidth, the\n * configuration/alt setting request will fail.  Therefore, submissions to\n * periodic endpoints on devices under xHCI should never fail due to bandwidth\n * constraints.\n *\n * Device drivers must explicitly request that repetition, by ensuring that\n * some URB is always on the endpoint's queue (except possibly for short\n * periods during completion callbacks).  When there is no longer an urb\n * queued, the endpoint's bandwidth reservation is canceled.  This means\n * drivers can use their completion handlers to ensure they keep bandwidth\n * they need, by reinitializing and resubmitting the just-completed urb\n * until the driver longer needs that periodic bandwidth.\n *\n * Memory Flags:\n *\n * The general rules for how to decide which mem_flags to use\n * are the same as for kmalloc.  There are four\n * different possible values; GFP_KERNEL, GFP_NOFS, GFP_NOIO and\n * GFP_ATOMIC.\n *\n * GFP_NOFS is not ever used, as it has not been implemented yet.\n *\n * GFP_ATOMIC is used when\n *   (a) you are inside a completion handler, an interrupt, bottom half,\n *       tasklet or timer, or\n *   (b) you are holding a spinlock or rwlock (does not apply to\n *       semaphores), or\n *   (c) current-&gt;state != TASK_RUNNING, this is the case only after\n *       you've changed it.\n *\n * GFP_NOIO is used in the block io path and error handling of storage\n * devices.\n *\n * All other situations use GFP_KERNEL.\n *\n * Some more specific rules for mem_flags can be inferred, such as\n *  (1) start_xmit, timeout, and receive methods of network drivers must\n *      use GFP_ATOMIC (they are called with a spinlock held);\n *  (2) queuecommand methods of scsi drivers must use GFP_ATOMIC (also\n *      called with a spinlock held);\n *  (3) If you use a kernel thread with a network driver you must use\n *      GFP_NOIO, unless (b) or (c) apply;\n *  (4) after you have done a down() you can use GFP_KERNEL, unless (b) or (c)\n *      apply or your are in a storage driver's block io path;\n *  (5) USB probe and disconnect can use GFP_KERNEL unless (b) or (c) apply; and\n *  (6) changing firmware on a running storage or net device uses\n *      GFP_NOIO, unless b) or c) apply\n *\n */\nint usb_submit_urb(struct urb *urb, gfp_t mem_flags);\n</code></pre>"},{"location":"12_USB/08_1/#235-urb","title":"2.3.5 \u200b\u53d6\u6d88\u200bURB","text":"<p>\u200b\u5df2\u7ecf\u200b\u63d0\u4ea4\u200b\u7684\u200bURB\uff0c\u200b\u53ef\u4ee5\u200b\u53d6\u6d88\u200b\u5b83\u200b\uff0c\u200b\u6709\u200b2\u200b\u4e2a\u200b\u51fd\u6570\u200b\uff1a</p> <ul> <li>usb_kill_urb\uff1a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u540c\u6b65\u200b\u51fd\u6570\u200b\uff0c\u200b\u5b83\u4f1a\u200b\u7b49\u5f85\u200bURB\u200b\u7ed3\u675f\u200b</li> <li>usb_unlink_urb\uff1a\u200b\u8fd9\u662f\u200b\u4e00\u4e2a\u200b\u5f02\u6b65\u200b\u51fd\u6570\u200b\uff0c\u200b\u5b83\u200b\u4e0d\u4f1a\u200b\u7b49\u5f85\u200bURB\u200b\u7ed3\u675f\u200b\uff0cUSB\u200b\u63a7\u5236\u5668\u9a71\u52a8\u200b\u4f1a\u200b\u8c03\u7528\u200b\u5b83\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b</li> </ul> <pre><code>/**\n * usb_kill_urb - cancel a transfer request and wait for it to finish\n * @urb: pointer to URB describing a previously submitted request,\n *  may be NULL\n *\n * This routine cancels an in-progress request.  It is guaranteed that\n * upon return all completion handlers will have finished and the URB\n * will be totally idle and available for reuse.  These features make\n * this an ideal way to stop I/O in a disconnect() callback or close()\n * function.  If the request has not already finished or been unlinked\n * the completion handler will see urb-&gt;status == -ENOENT.\n *\n * While the routine is running, attempts to resubmit the URB will fail\n * with error -EPERM.  Thus even if the URB's completion handler always\n * tries to resubmit, it will not succeed and the URB will become idle.\n *\n * The URB must not be deallocated while this routine is running.  In\n * particular, when a driver calls this routine, it must insure that the\n * completion handler cannot deallocate the URB.\n *\n * This routine may not be used in an interrupt context (such as a bottom\n * half or a completion handler), or when holding a spinlock, or in other\n * situations where the caller can't schedule().\n *\n * This routine should not be called by a driver after its disconnect\n * method has returned.\n */\nvoid usb_kill_urb(struct urb *urb);\n\n/**\n * usb_unlink_urb - abort/cancel a transfer request for an endpoint\n * @urb: pointer to urb describing a previously submitted request,\n *  may be NULL\n *\n * This routine cancels an in-progress request.  URBs complete only once\n * per submission, and may be canceled only once per submission.\n * Successful cancellation means termination of @urb will be expedited\n * and the completion handler will be called with a status code\n * indicating that the request has been canceled (rather than any other\n * code).\n *\n * Drivers should not call this routine or related routines, such as\n * usb_kill_urb() or usb_unlink_anchored_urbs(), after their disconnect\n * method has returned.  The disconnect function should synchronize with\n * a driver's I/O routines to insure that all URB-related activity has\n * completed before it returns.\n *\n * This request is asynchronous, however the HCD might call the -&gt;complete()\n * callback during unlink. Therefore when drivers call usb_unlink_urb(), they\n * must not hold any locks that may be taken by the completion function.\n * Success is indicated by returning -EINPROGRESS, at which time the URB will\n * probably not yet have been given back to the device driver. When it is\n * eventually called, the completion function will see @urb-&gt;status ==\n * -ECONNRESET.\n * Failure is indicated by usb_unlink_urb() returning any other value.\n * Unlinking will fail when @urb is not currently \"linked\" (i.e., it was\n * never submitted, or it was unlinked before, or the hardware is already\n * finished with it), even if the completion handler has not yet run.\n *\n * The URB must not be deallocated while this routine is running.  In\n * particular, when a driver calls this routine, it must insure that the\n * completion handler cannot deallocate the URB.\n *\n * Return: -EINPROGRESS on success. See description for other values on\n * failure.\n *\n * Unlinking and Endpoint Queues:\n *\n * [The behaviors and guarantees described below do not apply to virtual\n * root hubs but only to endpoint queues for physical USB devices.]\n *\n * Host Controller Drivers (HCDs) place all the URBs for a particular\n * endpoint in a queue.  Normally the queue advances as the controller\n * hardware processes each request.  But when an URB terminates with an\n * error its queue generally stops (see below), at least until that URB's\n * completion routine returns.  It is guaranteed that a stopped queue\n * will not restart until all its unlinked URBs have been fully retired,\n * with their completion routines run, even if that's not until some time\n * after the original completion handler returns.  The same behavior and\n * guarantee apply when an URB terminates because it was unlinked.\n *\n * Bulk and interrupt endpoint queues are guaranteed to stop whenever an\n * URB terminates with any sort of error, including -ECONNRESET, -ENOENT,\n * and -EREMOTEIO.  Control endpoint queues behave the same way except\n * that they are not guaranteed to stop for -EREMOTEIO errors.  Queues\n * for isochronous endpoints are treated differently, because they must\n * advance at fixed rates.  Such queues do not stop when an URB\n * encounters an error or is unlinked.  An unlinked isochronous URB may\n * leave a gap in the stream of packets; it is undefined whether such\n * gaps can be filled in.\n *\n * Note that early termination of an URB because a short packet was\n * received will generate a -EREMOTEIO error if and only if the\n * URB_SHORT_NOT_OK flag is set.  By setting this flag, USB device\n * drivers can build deep queues for large or complex bulk transfers\n * and clean them up reliably after any sort of aborted transfer by\n * unlinking all pending URBs at the first fault.\n *\n * When a control URB terminates with an error other than -EREMOTEIO, it\n * is quite likely that the status stage of the transfer will not take\n * place.\n */\nint usb_unlink_urb(struct urb *urb);\n</code></pre>"},{"location":"12_USB/09_1/","title":"\u7f16\u5199\u200bUSB\u200b\u9f20\u6807\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li> <p>Linux\u200b\u5185\u6838\u200b\u6e90\u7801\u200b\uff1a<code>include\\linux\\usb.h</code></p> </li> <li> <p>Linux\u200b\u5185\u6838\u200b\u6e90\u7801\u200b\uff1a<code>drivers\\hid\\usbhid\\usbmouse.c</code></p> </li> <li> <p>\u200b\u672c\u200b\u89c6\u9891\u200b\u6e90\u7801\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u5982\u4e0b\u200b\u4f4d\u7f6e\u200b\uff1a</p> </li> </ul> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\source\\12_USB\\04_usbmouse_as_key\n</code></pre>"},{"location":"12_USB/09_1/#1","title":"1. \u200b\u76ee\u6807","text":"<p>\u200b\u4f7f\u7528\u200b\u9f20\u6807\u200b\u6a21\u62df\u200b\u6309\u952e\u200b\uff1a\u200b\u5de6\u952e\u200b\u76f8\u5f53\u4e8e\u200b\"L\"\u3001\u200b\u53f3\u952e\u200b\u76f8\u5f53\u4e8e\u200b\"S\"\u3001\"\u200b\u4e2d\u200b\u952e\u200b\"\u200b\u76f8\u5f53\u4e8e\u200b \"\u200b\u56de\u8f66\u200b\"\u3002</p>"},{"location":"12_USB/09_1/#2","title":"2. \u200b\u7f16\u7a0b","text":""},{"location":"12_USB/09_1/#21","title":"2.1 \u200b\u9a71\u52a8\u200b\u6846\u67b6","text":"<p>\u200b\u5bf9\u4e8e\u200bGPIO\u200b\u6309\u952e\u200b\uff0c\u200b\u662f\u200b\u76f4\u63a5\u200b\u6784\u9020\u200b\u3001\u200b\u6ce8\u518c\u200b\u4e00\u4e2a\u200binput_dev\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u5728\u200bGPIO\u200b\u4e2d\u65ad\u200b\u51fd\u6570\u200b\u91cc\u200b\u83b7\u5f97\u200b\u6570\u636e\u200b\u3002</p> <p>\u200b\u73b0\u5728\u200b\u6570\u636e\u200b\u6765\u6e90\u200b\u53d1\u751f\u200b\u4e86\u200b\u53d8\u5316\u200b\uff0c\u200b\u6570\u636e\u200b\u6765\u81ea\u200bUSB\u200b\u8bbe\u5907\u200b\uff0c\u200b\u9700\u8981\u200b\u505a\u200b\u7684\u200b\u4e8b\u60c5\u200b\u662f\u200b\uff1a</p> <ul> <li>\u200b\u6784\u9020\u200b\u3001\u200b\u6ce8\u610f\u200busb_driver</li> <li>usb_driver\u200b\u53d1\u73b0\u200b\u80fd\u200b\u652f\u6301\u200b\u662f\u200b\u8bbe\u5907\u200b\u540e\u200b\uff0c\u200b\u5b83\u200b\u7684\u200bprobe\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b\uff1a</li> <li>\u200b\u6784\u9020\u200b\u3001\u200b\u6ce8\u518c\u200binput_dev\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> <li>\u200b\u83b7\u5f97\u200b\u6570\u636e\u200b\uff1a</li> <li>\u200b\u6784\u9020\u200b\u3001\u200b\u63d0\u4ea4\u200bURB</li> <li>\u200b\u5728\u200bURB\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u91cc\u200b\uff0c\u200b\u5411\u200bInput\u200b\u7cfb\u7edf\u200b\u4e0a\u62a5\u200b\u6570\u636e\u200b</li> </ul>"},{"location":"12_USB/09_1/#22-usb_driver","title":"2.2 \u200b\u5b9e\u73b0\u200busb_driver","text":"<p>\u200b\u4eff\u7167\u200busbmouse.c\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\u6784\u9020\u200b\u4e00\u4e2a\u200busb_driver\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff1a</p> <p></p> <p>\u200b\u6838\u5fc3\u200b\u662f\u200b\uff1a</p> <ul> <li>id_table\uff1a\u200b\u8fd9\u4e2a\u200b\u9a71\u52a8\u200b\u80fd\u200b\u652f\u6301\u200b\u54ea\u4e9b\u200b\u8bbe\u5907\u200b</li> <li>probe\u200b\u51fd\u6570\u200b\uff1a\u200b\u53d1\u73b0\u200b\u80fd\u200b\u652f\u6301\u200b\u7684\u200b\u8bbe\u5907\u200b\u540e\u200b\uff0cprobe\u200b\u51fd\u6570\u200b\u8bb0\u5f55\u200b\u8bbe\u5907\u200b\u4fe1\u606f\u200b\u3001\u200b\u6ce8\u518c\u200b\u8f93\u5165\u200b\u8bbe\u5907\u200b\u7b49\u7b49\u200b</li> </ul>"},{"location":"12_USB/09_1/#221-id_table","title":"2.2.1 id_table","text":"<p>id_table\u200b\u662f\u200b\u4e00\u4e2a\u200busb_device_id\u200b\u6570\u7ec4\u200b\uff0c\u200b\u793a\u4f8b\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>usb_device_id\u200b\u7ed3\u6784\u200b\u4f53\u200b\u5b9a\u4e49\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>match_flags\uff1a\u200b\u8868\u793a\u200b\u8981\u200b\u6bd4\u8f83\u200b\u54ea\u4e9b\u200b\u4fe1\u606f\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u6bd4\u8f83\u200b\u8bbe\u5907\u200bID\u3001DeviceClass\u3001InterfaceClass\u200b\u7b49\u7b49\u200b</li> <li>\u200b\u6839\u636e\u200bmatch_flags\u200b\u63d0\u4f9b\u200b\u5176\u4ed6\u200b\u4fe1\u606f\u200b\uff1a\u200b\u6bd4\u5982\u200b\u8bbe\u5907\u200bID\u3001DeviceClass\u3001InterfaceClass\u200b\u7b49\u7b49\u200b</li> <li>driver_info\uff1a\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u53ef\u80fd\u200b\u7528\u5230\u200b\u7684\u200b\u4e00\u4e9b\u200b\u4fe1\u606f\u200b</li> </ul> <pre><code>struct usb_device_id {\n    /* which fields to match against? */\n    __u16       match_flags;\n\n    /* Used for product specific matches; range is inclusive */\n    __u16       idVendor;\n    __u16       idProduct;\n    __u16       bcdDevice_lo;\n    __u16       bcdDevice_hi;\n\n    /* Used for device class matches */\n    __u8        bDeviceClass;\n    __u8        bDeviceSubClass;\n    __u8        bDeviceProtocol;\n\n    /* Used for interface class matches */\n    __u8        bInterfaceClass;\n    __u8        bInterfaceSubClass;\n    __u8        bInterfaceProtocol;\n\n    /* Used for vendor-specific interface matches */\n    __u8        bInterfaceNumber;\n\n    /* not matched against */\n    kernel_ulong_t  driver_info\n        __attribute__((aligned(sizeof(kernel_ulong_t))));\n};\n</code></pre>"},{"location":"12_USB/09_1/#222-probe","title":"2.2.2 probe\u200b\u51fd\u6570","text":"<p>probe\u200b\u51fd\u6570\u200b\u539f\u578b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>int (*probe) (struct usb_interface *intf,\n              const struct usb_device_id *id);\n</code></pre> <p>\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u53c2\u6570\u200b\u662f\u200b\"struct usb_interface *\"\u200b\u7c7b\u578b\u200b\uff0c\u200b\u8868\u793a\u200b\u5339\u914d\u200b\u5230\u200b\u7684\u200b\"USB\u200b\u903b\u8f91\u8bbe\u5907\u200b\"\u3002</p> <p>\u200b\u7b2c\u200b2\u200b\u4e2a\u200b\u53c2\u6570\u200b\u662f\u200b\"struct usb_device_id *\"\u200b\u7c7b\u578b\u200b\uff0c\u200b\u5b83\u200b\u662f\u200busb_driver\u200b\u7684\u200bid_table\u200b\u4e2d\u200b\u7684\u200b\u67d0\u9879\u200b\uff0c\u200b\u8868\u793a\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u53c2\u6570\u200b\u5c31\u662f\u200b\u8ddf\u200b\u8fd9\u4e2a\u200busb_device_id\u200b\u5339\u914d\u200b\u7684\u200b\u3002\u200b\u6709\u200b\u5fc5\u8981\u200b\u7684\u8bdd\u200b\uff0cprobe\u200b\u51fd\u6570\u200b\u91cc\u200b\u53ef\u4ee5\u200b\u4ece\u200bid-&gt;driver_info\u200b\u5f97\u5230\u200b\u9a71\u52a8\u200b\u76f8\u5173\u200b\u7684\u200b\u4e00\u4e9b\u200b\u4fe1\u606f\u200b\u3002</p> <p>\u200b\u5728\u200bprobe\u200b\u51fd\u6570\u200b\uff0c\u200b\u4e00\u822c\u200b\u8981\u200b\u8bb0\u5f55\u200bintf\u200b\u4fe1\u606f\u200b\uff0c\u200b\u4ee5\u540e\u200b\u53d1\u8d77\u200bUSB\u200b\u4f20\u8f93\u200b\u65f6\u4f1a\u200b\u7528\u5230\u200bintf\u200b\u4fe1\u606f\u200b\u3002</p>"},{"location":"12_USB/09_1/#23","title":"2.3 \u200b\u5b9e\u73b0\u200b\u8f93\u5165\u200b\u8bbe\u5907","text":"<p>\u200b\u6838\u5fc3\u200b\u662f\u200b\uff1a\u200b\u5206\u914d\u200b\u3001\u200b\u8bbe\u7f6e\u200b\u3001\u200b\u6ce8\u518c\u200b\u4e00\u4e2a\u200binput_device\u200b\u7ed3\u6784\u200b\u4f53\u200b\u3002</p>"},{"location":"12_USB/09_1/#24","title":"2.4 \u200b\u5b9e\u73b0\u200b\u6570\u636e\u4f20\u8f93","text":"<p>\u200b\u5206\u914d\u200b\u3001\u200b\u586b\u5145\u200b\u3001\u200b\u63d0\u4ea4\u200bURB\uff0c\u200b\u5728\u200bURB\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u91cc\u200b\u4e0a\u62a5\u200b\"input_event\"\u3002</p>"},{"location":"12_USB/09_1/#3","title":"3. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<p>\u200b\u9700\u8981\u200b\u91cd\u65b0\u914d\u7f6e\u200b\u5185\u6838\u200b\uff0c\u200b\u53bb\u6389\u200b\u5185\u6838\u200b\u81ea\u5e26\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u3002\u200b\u5728\u200b\u5185\u6838\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6267\u884c\u200b\"make  menuconfig\"\uff1a</p> <pre><code>Device Drivers  ---&gt;\n    HID support  ---&gt;\n        USB HID support  ---&gt;\n            &lt; &gt; USB HID transport layer  // \u200b\u4e0d\u8981\u200b\u9009\u4e2d\u200b\n</code></pre> <p>\u200b\u7136\u540e\u200b\u91cd\u65b0\u200b\u7f16\u8bd1\u200b\u5185\u6838\u200b\u3001\u200b\u7ed9\u200b\u5f00\u53d1\u677f\u200b\u66ff\u6362\u200b\u5185\u6838\u200b\u3002</p> <p>\u200b\u6d4b\u8bd5\u200b\uff1a</p> <pre><code># \u200b\u628a\u200bUSB\u200b\u9f20\u6807\u200b\u67e5\u200b\u5230\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\n# \u200b\u5148\u200b\u770b\u770b\u200b\u539f\u6765\u200b\u6709\u200b\u54ea\u4e9b\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\nls /dev/input/event*\n\n# \u200b\u5b89\u88c5\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\ninsmod usbmouse_as_key.ko\n\n# \u200b\u518d\u200b\u770b\u770b\u200b\u65b0\u200b\u5f97\u5230\u200b\u4e86\u200b\u54ea\u4e2a\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\nls /dev/input/event*\n\n# \u200b\u6267\u884c\u547d\u4ee4\u200b, \u200b\u5047\u8bbe\u200bevent4\u200b\u662f\u200b\u65b0\u200b\u8282\u70b9\u200b\nhexdump /dev/input/event4\n\n# \u200b\u70b9\u51fb\u200b\u9f20\u6807\u200b\u6309\u952e\u200b\u5373\u53ef\u200b\u89c2\u5bdf\u200b\u8f93\u51fa\u200b\u4fe1\u606f\u200b\n\n# \u200b\u7b2c\u200b2\u200b\u79cd\u200b\u6d4b\u8bd5\u65b9\u6cd5\u200b: \u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\uff0c\u200b\u6309\u200b\u9f20\u6807\u200b\u5de6\u952e\u200b\u3001\u200b\u53f3\u952e\u200b\uff0c\u200b\u518d\u200b\u6309\u200b\u4e2d\u952e\u200b\u5c31\u200b\u6709\u200b\u8f93\u51fa\u200b\"ls\"\ncat /dev/tty0\n\n# \u200b\u7b2c\u200b3\u200b\u79cd\u200b\u6d4b\u8bd5\u65b9\u6cd5\u200b: \u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b(\u200b\u6ce8\u610f\u200b\"&lt;\"\u200b\u53f7\u200b\u524d\u540e\u200b\u6ca1\u6709\u200b\u7a7a\u683c\u200b)\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u9f20\u6807\u200b\u6309\u952e\u200b\u5728\u200b\u63a7\u5236\u53f0\u200b\u8f93\u5165\u200b\u5b57\u7b26\u200b\nexec 0&lt;/dev/tty0\n</code></pre>"},{"location":"12_USB/10_1/","title":"OTG\u200b\u786c\u4ef6\u200b\u68c0\u6d4b\u200b\u7535\u8def","text":""},{"location":"12_USB/10_1/#1-otg","title":"1. OTG\u200b\u63a5\u53e3\u200b\u4e0e\u200b\u8f6c\u6362\u5668","text":"<p>OTG\u200b\u662f\u200b\"On The Go\"\u200b\u7684\u200b\u82f1\u6587\u200b\u7f29\u5199\u200b\uff0c\u200b\u5b57\u9762\u4e0a\u200b\u53ef\u4ee5\u200b\u7406\u89e3\u200b\u4e3a\u200b\u201c\u200b\u5b89\u4e0a\u200b\u5373\u53ef\u200b\u7528\u200b\u201d\u3002USB\u200b\u4f20\u8f93\u200b\u662f\u200b\u4e3b\u4ece\u200b\u7ed3\u6784\u200b\uff0c\u200b\u4e00\u5207\u200bUSB\u200b\u4f20\u8f93\u200b\u90fd\u200b\u6709\u200bHost\u200b\u53d1\u8d77\u200b\u3002\u200b\u6bd4\u5982\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u53ef\u4ee5\u200b\u63d2\u5165\u200bU\u200b\u76d8\u200b\uff0c\u200b\u8fd9\u65f6\u200b\u5f00\u53d1\u677f\u200b\u4f5c\u4e3a\u200bUSB Host\u3002\u200b\u4f46\u662f\u200b\u5f00\u53d1\u677f\u200b\u8981\u200b\u8ddf\u200bPC\u200b\u901a\u4fe1\u200b\uff0c\u200b\u5f00\u53d1\u677f\u200b\u5c31\u8981\u200b\u4f5c\u4e3a\u200bUSB Device\u3002\u200b\u5f00\u53d1\u677f\u200b\u8981\u200b\u4f5c\u4e3a\u200bUSB Host\u3001USB Device\u200b\u4e24\u79cd\u200b\u89d2\u8272\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200bOTG\u200b\u63d2\u53e3\u200b\uff1a\u200b\u5b83\u200b\u53ef\u4ee5\u200b\u6839\u636e\u200b\u786c\u4ef6\u200b\u7535\u8def\u200b\u81ea\u52a8\u8bc6\u522b\u200b\u81ea\u5df1\u200b\u7684\u200b\u89d2\u8272\u200b\uff0c\u200b\u5207\u6362\u200b\u4e3a\u200bUSB Host\u200b\u6216\u200bUSB Deivce\u3002</p> <p>OTG\u200b\u63d2\u53e3\u200b\u6709\u200b\u591a\u79cd\u200b\u5f62\u6001\u200b\uff0c\u200b\u5e38\u7528\u200b\u7684\u200b\u6709\u200bMicro USB\u3001Type C\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"12_USB/10_1/#11-micro-usb","title":"1.1 Micro USB","text":"<p>\u200b\u5bf9\u4e8e\u200bMicro USB\u200b\u63d2\u5ea7\u200b\uff0c\u200b\u5b83\u200b\u6709\u200b5\u200b\u6761\u200b\u5f15\u811a\u200b\uff1a</p> <p></p> <p>\u200b\u5f15\u811a\u200b\u4f5c\u7528\u200b\u5982\u4e0b\u200b\u8868\u200b\u6240\u793a\u200b\uff1a</p> \u200b\u5f15\u811a\u200b\u540d\u200b \u200b\u4f5c\u7528\u200b VBUS \u200b\u4f5c\u4e3a\u200bHost\u200b\u65f6\u200b\uff0c\u200b\u5bf9\u5916\u200b\u4f9b\u7535\u200b\u4f5c\u4e3a\u200bDevice\u200b\u65f6\u200b\uff0c\u200b\u63a5\u6536\u200b\u5916\u90e8\u200b\u8f93\u5165\u200b\u7684\u200b\u7535\u6e90\u200b DM \u200b\u6570\u636e\u4fe1\u53f7\u200b DP \u200b\u6570\u636e\u4fe1\u53f7\u200b ID \u200b\u5206\u8fa8\u200b\u81ea\u5df1\u200b\u89d2\u8272\u200b\u7684\u200b\u5f15\u811a\u200b\uff1a1\uff1a\u200b\u4f5c\u4e3a\u200bDevice0\uff1a\u200b\u4f5c\u4e3a\u200bHost GND \u200b\u5730\u200b\u7ebf\u200b <p>\u200b\u5f00\u53d1\u677f\u200b\u4f5c\u4e3a\u200bUSB Device\u200b\u65f6\u200b\u8ddf\u200bPC\u200b\u4e0a\u200b\u7684\u200bUSB\u200b\u76f8\u8fde\u200b\uff0cPC\u200b\u7684\u200bUSB\u200b\u63a5\u53e3\u200b\u53ea\u6709\u200bVBUS\u3001DM\u3001DP\u3001GND\uff0c\u200b\u6240\u4ee5\u200b\u5f00\u53d1\u677f\u200b\u7684\u200bID\u200b\u5f15\u200b\u811a\u8ddf\u200bPC\u200b\u7684\u200bUSB\u200b\u53e3\u200b\u5e76\u200b\u65e0\u200b\u8fde\u63a5\u200b\uff0c\u200b\u5b83\u200b\u88ab\u200b\u677f\u5b50\u200b\u4e0a\u200b\u7684\u200b\u4e0a\u200b\u62c9\u200b\u7535\u963b\u200b\u62c9\u9ad8\u200b\u3002</p> <p>\u200b\u5f00\u53d1\u677f\u200b\u4f5c\u4e3a\u200bUSB Host\u200b\u65f6\u200b\uff0c\u200b\u9700\u8981\u200b\u63a5\u5165\u200b\u4e00\u4e2a\u200b\"OTG\u200b\u8f6c\u6362\u5668\u200b\"\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\u9ed1\u8272\u200b\u7684\u200b\u8f6c\u6362\u5668\u200b\uff1a</p> <p></p> <p>OTG\u200b\u8f6c\u6362\u5668\u200b\u7684\u200b\u5185\u90e8\u200b\u7535\u8def\u200b\u5f88\u200b\u7b80\u5355\u200b(\u200b\u53c2\u8003\u200b\uff1ahttps://www.lulian.cn/news/otg_gongneng_jiexi-cn.html)\uff1a</p> <p></p> <p>\u200b\u8fd9\u4e2a\u200b\u8f6c\u6362\u5668\u200b\u63d2\u5165\u200b\u5f00\u53d1\u677f\u200b\u7684\u200bOTG\u200b\u53e3\u200b\u4e4b\u540e\u200b\uff0cOTG\u200b\u53e3\u4e0a\u200b\u7684\u200bID\u200b\u5f15\u811a\u200b\u5c31\u200b\u88ab\u200b\u62c9\u200b\u4f4e\u200b\uff0c\u200b\u8f6f\u4ef6\u200b\u8f6c\u6362\u200b\u4e3a\u200bUSB Host\u3002</p>"},{"location":"12_USB/10_1/#12-type-c","title":"1.2 Type C","text":"<p>Type C\u200b\u63d2\u5ea7\u200b\u91cc\u9762\u200b\u6709\u200b\u4e24\u7ec4\u200b\u5b8c\u5168\u200b\u4e00\u6837\u200b\u7684\u200b\u4fe1\u53f7\u200b\uff0cType C\u200b\u6570\u636e\u7ebf\u200b\u65e0\u8bba\u200b\u6b63\u200b\u63d2\u200b\u3001\u200b\u53cd\u63d2\u200b\uff0c\u200b\u90fd\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\uff1a</p> <p></p> <p>Type C\u200b\u63d2\u5ea7\u200b\u6709\u200b\u5982\u4e0b\u200b\u4fe1\u53f7\u200b(\u200b\u53c2\u8003\u200b\uff1ahttps://blog.csdn.net/qq_37659014/article/details/124479125)\uff0c\u200b\u5728\u200bUSB2.0\u200b\u534f\u8bae\u200b\u91cc\u200b\u6211\u4eec\u200b\u53ea\u200b\u5173\u5fc3\u200b\u7ea2\u6846\u200b\u91cc\u200b\u7684\u200b\u4fe1\u53f7\u200b\uff1a</p> <p></p> <p>\u200b\u5f00\u53d1\u677f\u200b\u4f5c\u4e3a\u200bUSB Device\u200b\u65f6\u200b\u8ddf\u200bPC\u200b\u4e0a\u200b\u7684\u200bUSB\u200b\u76f8\u8fde\u200b\uff0cPC\u200b\u7684\u200bUSB\u200b\u63a5\u53e3\u200b\u53ea\u6709\u200bVBUS\u3001DM\u3001DP\u3001GND\uff0c\u200b\u6240\u4ee5\u200b\u5f00\u53d1\u677f\u200b\u7684\u200bCC1\u3001CC2\u200b\u5f15\u200b\u811a\u8ddf\u200bPC\u200b\u7684\u200bUSB\u200b\u53e3\u200b\u5e76\u200b\u65e0\u200b\u8fde\u63a5\u200b\uff0c\u200b\u5b83\u200b\u88ab\u200b\u677f\u5b50\u200b\u4e0a\u200b\u7684\u200b\u4e0a\u200b\u62c9\u200b\u7535\u963b\u200b\u62c9\u9ad8\u200b\u3002</p> <p>\u200b\u5f00\u53d1\u677f\u200b\u4f5c\u4e3a\u200bUSB Host\u200b\u65f6\u200b\uff0c\u200b\u9700\u8981\u200b\u63a5\u5165\u200b\u4e00\u4e2a\u200b\"OTG\u200b\u8f6c\u6362\u5668\u200b\"\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\u9ed1\u8272\u200b\u7684\u200b\u8f6c\u6362\u5668\u200b\uff1a</p> <p></p> <p>\u200b\u5982\u679c\u200b\u4e0d\u200b\u8003\u8651\u200b\u517c\u5bb9\u200bUSB 3.0\u200b\u534f\u8bae\u200b\uff0c\u200b\u4e0a\u8ff0\u200b\u8f6c\u6362\u5668\u200b\u7684\u200b\u7535\u8def\u56fe\u200b\u5f88\u200b\u7b80\u5355\u200b\uff0c\u200b\u628a\u200bType C\u200b\u63d2\u5934\u200b\u91cc\u9762\u200b\u7684\u200bCC\u200b\u5f15\u811a\u200b\u8fde\u63a5\u200b5.1K\u200b\u6b27\u59c6\u7535\u963b\u200b\u5230\u200bGND\u200b\u5373\u53ef\u200b\u3002\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b(\u200b\u53c2\u8003\u200b\uff1ahttps://www.elecfans.com/connector/20180309645002_a.html)\uff1a</p> <p></p>"},{"location":"12_USB/10_1/#2-otg","title":"2. OTG\u200b\u63a5\u53e3\u200b\u7535\u8def","text":"<p>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u7684\u200bOTG\u200b\u63a5\u53e3\u200b\u9700\u8981\u200b\u5b9e\u73b0\u200b\u4e24\u4e2a\u200b\u529f\u80fd\u200b\uff1a</p> <ul> <li>\u200b\u68c0\u6d4b\u200bID\u200b\u5f15\u811a\u200b(\u200b\u4f7f\u7528\u200bType C\u200b\u63a5\u53e3\u200b\u7684\u8bdd\u200b\u662f\u200bCC1\u3001CC2\u200b\u5f15\u811a\u200b)\uff0c\u200b\u5f15\u5165\u200b\u4e3b\u63a7\u200b\u82af\u7247\u200b\uff1a\u200b\u8f6f\u4ef6\u200b\u6839\u636e\u200b\u5b83\u200b\u8bbe\u7f6e\u200bUSB\u200b\u63a7\u5236\u5668\u200b\u7684\u200b\u89d2\u8272\u200b(Host\u200b\u6216\u200bDevice)</li> <li>\u200b\u6839\u636e\u200bID\u200b\u5f15\u811a\u200b(\u200b\u6216\u8005\u200bCC1\u3001CC2)\u200b\u51b3\u5b9a\u200bVBUS\u200b\u662f\u5426\u200b\u8f93\u51fa\u200b\u7535\u6e90\u200b\uff1a\u200b\u786c\u4ef6\u200b\u7535\u8def\u200b\u81ea\u52a8\u200b\u5b9e\u73b0\u200b</li> </ul>"},{"location":"12_USB/10_1/#21-micro-usb","title":"2.1 Micro USB","text":""},{"location":"12_USB/10_1/#22-type-c","title":"2.2 Type C","text":"<p>\u200b\u5982\u679c\u200b\u4e0d\u200b\u8003\u8651\u200b\u517c\u5bb9\u200bUSB 3.0\u200b\u534f\u8bae\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u5982\u4e0b\u200b\u7cbe\u7b80\u200b\u7535\u8def\u200b\uff1aCC1\u3001CC2\u200b\u4f5c\u4e3a\u200bID\u200b\u5f15\u811a\u200b\u3002</p> <p></p> <p>\u200b\u5982\u679c\u200b\u8981\u200b\u517c\u5bb9\u200bUSB 3.0\u200b\u534f\u8bae\u200b\uff0c\u200b\u5219\u200b\u9700\u8981\u200b\u52a0\u5165\u200b\u4e13\u7528\u200b\u7684\u200b\u82af\u7247\u200b\uff1a</p> <p></p>"},{"location":"12_USB/11_1/","title":"Gadget\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux\u200b\u4e0b\u200bUSB gadget\u200b\u8bbe\u5907\u200b\u8be6\u89e3\u200b\uff1ahttps://www.docin.com/p-1852320293.html</li> <li>Linux usb gadget\u200b\u6846\u67b6\u200b\u6982\u8ff0\u200b\uff1ahttps://blog.csdn.net/daocaokafei/article/details/114114824</li> <li>USB\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b-USB Gadget Driver(\u200b\u4e8c\u200b)\uff1ahttps://blog.csdn.net/chenzhen1080/article/details/53742924</li> <li>usb gadge\u200b\u9a71\u52a8\u200b\u8bbe\u8ba1\u200b\u4e4b\u200b\u6211\u200b\u662f\u200bzero\uff1ahttps://www.bbsmax.com/A/Ae5RvbwM5Q/</li> <li>Linux-USB\u200b\u9a71\u52a8\u200b\u7b14\u8bb0\u200b\uff08\u200b\u56db\u200b\uff09--USB\u200b\u6574\u4f53\u200b\u6846\u67b6\u200b: https://qingmu.blog.csdn.net/article/details/119979199</li> <li>USB gadget\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u89e3\u6790\u200b:  https://www.likecs.com/show-843861.html</li> <li>\u200b\u8c03\u8bd5\u200b\u8f6f\u4ef6\u200b\uff1aUSB view \u3001bushound \u3001\u200b\u53ca\u200b\u4e00\u4e9b\u200b\u786c\u4ef6\u200bUSB\u200b\u4fe1\u53f7\u200b\u5206\u6790\u4eea\u200b</li> <li>\u200b\u53ef\u4ee5\u200b\u7528\u200bwireshark+usbmon\u200b\u6355\u6349\u200busb\u200b\u534f\u8bae\u200b\u6570\u636e\u5305\u200b\u3002</li> </ul>"},{"location":"12_USB/11_1/#1-gadget","title":"1. \u200b\u600e\u6837\u200b\u7406\u89e3\u200bGadget\u200b\u6846\u67b6","text":"<p>USB\u200b\u534f\u8bae\u200b\u662f\u200b\u4e3b\u4ece\u200b\u7ed3\u6784\u200b\uff1a</p> <p></p> <p>\u200b\u6211\u4eec\u200b\u7f16\u5199\u200bUSB\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u65f6\u200b\uff0c\u200b\u4e3b\u8981\u200b\u662f\u200b\uff1a</p> <ul> <li>\u200b\u8bfb\u53d6\u200b\u8bbe\u5907\u200b\u7684\u200b\u5404\u7c7b\u200b\u63cf\u8ff0\u7b26\u200b\uff0c\u200b\u6bd4\u5982\u200bendpoint\u200b\u63cf\u8ff0\u7b26\u200b\uff0c\u200b\u5f97\u5230\u200b\u7aef\u70b9\u200b\u53f7\u200b</li> <li>\u200b\u4f7f\u7528\u200b\u5e95\u5c42\u200bUSB Host Controller\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u63d0\u4f9b\u200b\u7684\u200bAPI\u200b\u51fd\u6570\u200b\uff0c\u200b\u4ece\u200bendpoint\u200b\u4e0a\u200b\u8bfb\u5199\u200b\u6570\u636e\u200b</li> </ul> <p>\u200b\u90a3\u4e48\u200b\u8981\u200b\u57fa\u4e8e\u200bGadget\u200b\u9a71\u52a8\u200b\u6846\u67b6\u200b\u6a21\u62df\u200b\u4e00\u4e2a\u200bUSB\u200b\u8bbe\u5907\u200b\u65f6\u200b\uff0cendpoint\u200b\u7684\u200b\u6570\u636e\u4f20\u8f93\u200b\u80fd\u529b\u200b\u662f\u200b\u5e95\u5c42\u200b\u7684\u200bUSB Device Controller\u200b\u9a71\u52a8\u200b\u63d0\u4f9b\u200b\u7684\u200b\uff0c\u200b\u6211\u4eec\u200b\u8981\u200b\u505a\u200b\u7684\u200b\u5c31\u662f\u200b\uff1a</p> <ul> <li>\u200b\u63d0\u4f9b\u200b\u5404\u7c7b\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b</li> <li>\u200b\u4f7f\u7528\u200b\u5e95\u5c42\u200bUSB Device Controller\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u63d0\u4f9b\u200b\u7684\u200bAPI\u200b\u51fd\u6570\u200b\uff0c\u200b\u4ece\u200bendpoint\u200b\u5f97\u5230\u200b\u6570\u636e\u200b\u3001\u200b\u53cd\u9988\u200b\u6570\u636e\u200b</li> </ul> <p>Gadget\u200b\u7684\u200b\u542b\u4e49\u200b\u662f\u200b\"\u200b\u5c0f\u200b\u5668\u4ef6\u200b\"\uff0c\u200b\u5728\u200bLinux\u200b\u7684\u200bUSB\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\uff0c\u200b\u5b83\u200b\u8868\u793a\u200b\"usb device\"\u3002Gadget\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u5c31\u662f\u200b\u7528\u6765\u200b\u6a21\u62df\u200bUSB Device\u3002\u200b\u5bf9\u4e8e\u200b\u771f\u5b9e\u200b\u7684\u200bUSB Device\uff0c\u200b\u5b83\u200b\u6709\u200b\u4e24\u5927\u200b\u8981\u7d20\u200b\uff1a</p> <ul> <li>\u200b\u600e\u4e48\u200b\u8868\u793a\u200b\u81ea\u5df1\u200b\uff1f</li> <li>\u200b\u6bcf\u4e2a\u200bUSB Device\u200b\u90fd\u200b\u6709\u200b1\u200b\u4e2a\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b</li> <li>\u200b\u90fd\u200b1\u200b\u4e2a\u200b\u6216\u200b\u591a\u4e2a\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26\u200b</li> <li>\u200b\u6bcf\u4e2a\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26\u200b\u91cc\u9762\u200b\u6709\u200b1\u200b\u4e2a\u200b\u6216\u200b\u591a\u4e2a\u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26\u200b</li> <li>\u200b\u6bcf\u4e2a\u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26\u200b\u91cc\u9762\u200b\u6709\u200b0\u200b\u4e2a\u200b\u591a\u4e2a\u200b\u7aef\u70b9\u200b\u63cf\u8ff0\u7b26\u200b</li> <li>\u200b\u600e\u4e48\u200b\u8fdb\u884c\u200b\u6570\u636e\u4f20\u8f93\u200b\uff1f</li> <li>\u200b\u901a\u8fc7\u200b\u7aef\u70b9\u200b\u8fdb\u884c\u200b\u4f20\u8f93\u200b</li> <li>\u200b\u6709\u200b\u7aef\u70b9\u200b\u7684\u200b\u64cd\u4f5c\u200b\u51fd\u6570\u200b     </li> </ul> <p>\u200b\u5728\u200b\u5b66\u4e60\u200b\u8fc7\u7a0b\u200b\u4e2d\u200b\uff0c\u200b\u8bb0\u4f4f\u200b\u8fd9\u200b\u51e0\u4e2a\u200b\u8981\u70b9\u200b\u975e\u5e38\u200b\u6709\u200b\u5e2e\u52a9\u200b\uff1a</p> <ul> <li>\u200b\u5404\u7c7b\u200b\u63cf\u8ff0\u7b26\u200b\u7684\u200b\u6784\u9020\u200b</li> <li>USB Host\u200b\u83b7\u5f97\u200bGadget\u200b\u5404\u7c7b\u200b\u63cf\u8ff0\u7b26\u200b\u7684\u200b\u8fc7\u7a0b\u200b</li> <li>\u200b\u6570\u636e\u4f20\u8f93\u200b\u7684\u200b\u6d41\u7a0b\u200b</li> </ul>"},{"location":"12_USB/11_1/#2-gadget","title":"2. \u200b\u4ece\u200b\u786c\u4ef6\u200b\u8f6f\u4ef6\u200b\u89d2\u5ea6\u200b\u7406\u89e3\u200bGadget\u200b\u6846\u67b6","text":"<p>USB\u200b\u4f20\u8f93\u200b\u7684\u200b\u6838\u5fc3\u200b\u662f\u200bendpoint\uff0c\u200b\u4f7f\u7528\u200bendpoint\u200b\u53ef\u4ee5\u200b\u6536\u53d1\u200b\u6570\u636e\u200b\u3002\u200b\u5728\u200bendpoint\u200b\u4e4b\u4e0a\u200b\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u6a21\u62df\u200bUSB\u200b\u4e32\u53e3\u200b\u3001USB\u200b\u89e6\u78b0\u5c4f\u200b\u3001USB\u200b\u6444\u50cf\u5934\u200b\u3002\u200b\u57fa\u4e8e\u200b\u8fd9\u4e2a\u200b\u89d2\u5ea6\u200b\uff0cGadget\u200b\u6846\u67b6\u200b\u53ef\u4ee5\u200b\u5206\u4e3a\u200b\u4e24\u5c42\u200b\uff1a</p> <ul> <li>\u200b\u5e95\u5c42\u200bendpoint\u200b\u64cd\u4f5c\u200b</li> <li>\u200b\u4e0a\u5c42\u200b\u6a21\u62df\u200b\u5404\u7c7b\u200bUSB\u200b\u8bbe\u5907\u200b</li> </ul> <p></p>"},{"location":"12_USB/11_1/#21-_udc","title":"2.1 \u200b\u5e95\u5c42\u200b\u786c\u4ef6\u200b\u64cd\u4f5c\u200b_UDC\u200b\u9a71\u52a8","text":"<p>\u200b\u5bf9\u4e8e\u200b\u5e95\u5c42\u200bendpoint\u200b\u7684\u200b\u4ee3\u7801\u200b\uff0c\u200b\u9700\u8981\u200b\u4ece\u200bUDC\u200b\u9a71\u52a8\u200b\u5f00\u59cb\u200b\u5206\u6790\u200b\uff1a</p> <ul> <li>IMX6ULL\u200b\u7684\u200b\u4ee3\u7801\u200b\uff1a<code>Linux-4.9.88\\drivers\\usb\\chipidea\\ci_hdrc_imx.c</code></li> </ul> <pre><code>ci_hdrc_imx_probe\n    ci_hdrc_add_device\n      pdev = platform_device_alloc(\"ci_hdrc\", id);\n\n\n// Linux-4.9.88\\drivers\\usb\\chipidea\\core.c\nstatic struct platform_driver ci_hdrc_driver = {\n  .probe  = ci_hdrc_probe,\n  .remove = ci_hdrc_remove,\n  .driver = {\n      .name   = \"ci_hdrc\",\n      .pm = &amp;ci_pm_ops,\n  },\n};\n\nci_hdrc_probe\n      ret = ci_hdrc_gadget_init(ci);\n              udc_start           \n</code></pre> <p></p> <ul> <li>STM32MP157\u200b\u7684\u200b\u4ee3\u7801\u200b\uff1a<code>Linux-5.4\\drivers\\usb\\dwc2\\platform.c</code></li> </ul> <pre><code>dwc2_driver_probe\n    retval = dwc2_gadget_init(hsotg);             \n</code></pre> <p></p>"},{"location":"12_USB/11_1/#22","title":"2.2 \u200b\u4e0a\u5c42\u200b\u8f6f\u4ef6\u200b\u64cd\u4f5c","text":"<p>\u200b\u6a21\u62df\u200b\u5404\u7c7b\u200bUSB\u200b\u8bbe\u5907\u200b\u65f6\u200b\uff0c\u200b\u8f6f\u4ef6\u200b\u600e\u4e48\u200b\u5206\u5c42\u200b\uff1f\u200b\u4ee5\u200b\u8bbf\u95ee\u200b\u8bbe\u5907\u200b\u3001\u200b\u83b7\u53d6\u200b\u63cf\u8ff0\u7b26\u200b\u4e3a\u4f8b\u200b\uff1a</p> <ul> <li>Host\u200b\u8981\u200b\u5206\u914d\u200b\u5730\u5740\u200b\u3001\u200b\u628a\u200b\u5730\u5740\u200b\u53d1\u9001\u7ed9\u200b\u8bbe\u5907\u200b\uff1a\u200b\u4e0d\u7ba1\u200b\u8981\u200b\u6a21\u62df\u200b\u4ec0\u4e48\u200b\u8bbe\u5907\u200b\uff0cGadget\u200b\u90fd\u200b\u5fc5\u987b\u200b\u63a5\u6536\u200b\u5730\u5740\u200b\uff0c\u200b\u8fd9\u90e8\u5206\u200b\u7531\u200busb_gadget(\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b)\u200b\u5b9e\u73b0\u200b</li> <li>Host\u200b\u8981\u200b\u8bfb\u53d6\u200b\u5404\u7c7b\u200b\u63cf\u8ff0\u7b26\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u63cf\u8ff0\u7b26\u200b\u662f\u200b\u7531\u200b\u4e0a\u5c42\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u63d0\u4f9b\u200b\u7684\u200b</li> <li>\u200b\u600e\u4e48\u200b\u628a\u200b\u4e0a\u5c42\u200b\u7684\u200b\u63cf\u8ff0\u7b26\u200b\u901a\u8fc7\u200b\u5e95\u5c42\u200b\u7684\u200busb_gadget\u200b\u4f20\u56de\u200b\u7ed9\u200bHost\uff1f\u200b\u8fd8\u200b\u9700\u8981\u200b\u4e00\u4e2a\u200b\u4e2d\u95f4\u5c42\u200b\u3002Host\u200b\u83b7\u53d6\u200b\u63cf\u8ff0\u7b26\u200b\u65f6\u200b\uff0c\u200b\u65b9\u6cd5\u200b\u662f\u200b\u56fa\u5b9a\u200b\u3001\u200b\u901a\u7528\u200b\u7684\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u65b9\u6cd5\u200b\u53ef\u4ee5\u200b\u7531\u200b\u5185\u6838\u200b\u7edf\u4e00\u200b\u63d0\u4f9b\u200b\uff0c\u200b\u8fd9\u200b\u5c31\u662f\u200b\uff1ausb_gadget_driver\u3002</li> </ul> <p>\u200b\u6240\u4ee5\u200b\uff0c\u200b\u4ece\u200b\u83b7\u53d6\u200b\u63cf\u8ff0\u7b26\u200b\u7684\u200b\u89d2\u5ea6\u200b\u770b\u770b\u200b\uff0c\u200b\u4e0a\u5c42\u200b\u8f6f\u4ef6\u200b\u81f3\u5c11\u200b\u5206\u4e3a\u200b2\u200b\u5c42\u200b\uff1a</p> <ul> <li>usb_gadget_driver\uff1a\u200b\u5b9e\u73b0\u200b\u4e00\u4e9b\u200b\u901a\u7528\u200b\u7684\u200bUSB\u200b\u8bbf\u95ee\u200b\u65b9\u6cd5\u200b\uff0c\u200b\u6bd4\u5982\u200bHost\u200b\u8bbf\u95ee\u200b\u63cf\u8ff0\u7b26\u200b\u65f6\u200b\uff0c\u200b\u7531\u200busb_gadget_driver\u200b\u63d0\u4f9b\u200b</li> <li>\u200b\u5728\u200b\u8fd9\u200b\u4e0a\u9762\u200b\u63d0\u4f9b\u200b\u5404\u7c7b\u200b\u63cf\u8ff0\u7b26\u200b\uff0c\u200b\u5b9e\u9645\u4e0a\u200b\uff0c\u200b\u63cf\u8ff0\u7b26\u200b\u7684\u200b\u63d0\u4f9b\u200b\u8fd8\u200b\u53ef\u4ee5\u200b\u5206\u4e3a\u200b\u4e24\u5c42\u200b\uff1a</li> <li>\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b\u3001\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26\u200b\uff1a\u200b\u7531\u200b\u7a0b\u5e8f\u5458\u200b\u51b3\u5b9a\u200b\uff0c\u200b\u7531\u200busb_composite_driver\u200b\u63d0\u4f9b\u200b</li> <li>\u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26\u200b\u3001endpoint\u200b\u63cf\u8ff0\u7b26\u200b\uff1a\u200b\u7531\u200b\u5185\u6838\u200b\u4e8b\u5148\u200b\u5b9e\u73b0\u200b\u7684\u200b\u3001\u200b\u5e38\u7528\u200b\u7684\u200bfunction driver\u200b\u63d0\u4f9b\u200b</li> </ul> <p>\u200b\u8f6f\u4ef6\u200b\u5c42\u6b21\u200b\u53ef\u4ee5\u200b\u8fdb\u4e00\u6b65\u200b\u7ec6\u5316\u200b\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\uff1a</p> <p></p> <p>\u200b\u8fd9\u200b\u6d89\u53ca\u200b2\u200b\u4e2a\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff1a</p> <ul> <li>usb_composite_dev\uff1a\u200b\u5b83\u200b\u91cc\u9762\u200b\u6c47\u96c6\u200b\u6709\u200b\u5404\u7c7b\u200b\u63cf\u8ff0\u7b26\u200b\u3001\u200b\u6709\u200b\u4e00\u4e2a\u200busb_funciton\u200b\u94fe\u8868\u200b(\u200b\u5b9e\u73b0\u200b\u6570\u636e\u4f20\u8f93\u200b)</li> </ul> <pre><code>struct usb_composite_dev {\n  struct usb_gadget       *gadget;\n  struct usb_request      *req;\n  struct usb_request      *os_desc_req;\n\n  struct usb_configuration    *config;\n\n  /* OS String is a custom (yet popular) extension to the USB standard. */\n  u8              qw_sign[OS_STRING_QW_SIGN_LEN];\n  u8              b_vendor_code;\n  struct usb_configuration    *os_desc_config;\n  unsigned int            use_os_string:1;\n\n  /* private: */\n  /* internals */\n  unsigned int            suspended:1;\n  struct usb_device_descriptor    desc;\n  struct list_head        configs;\n  struct list_head        gstrings;\n  struct usb_composite_driver *driver;\n  u8              next_string_id;\n  char                *def_manufacturer;\n\n  /* the gadget driver won't enable the data pullup\n   * while the deactivation count is nonzero.\n   */\n  unsigned            deactivations;\n\n  /* the composite driver won't complete the control transfer's\n   * data/status stages till delayed_status is zero.\n   */\n  int             delayed_status;\n\n  /* protects deactivations and delayed_status counts*/\n  spinlock_t          lock;\n\n  /* public: */\n  unsigned int            setup_pending:1;\n  unsigned int            os_desc_pending:1;\n};\n</code></pre> <ul> <li>usb_udc\uff1aUDC\u200b\u7684\u200b\u672c\u610f\u200b\u662f\u200b\"usb device controller\"\uff0cusb_udc\u200b\u7ed3\u6784\u200b\u4f53\u200b\u91cc\u9762\u200b\u6709\u200busb_gadget(\u200b\u8868\u793a\u200bUDC\u200b\u672c\u8eab\u200b)\u3001usb_gadget_driver()</li> </ul> <pre><code>struct usb_udc {\n  struct usb_gadget_driver    *driver;\n  struct usb_gadget       *gadget;\n  struct device           dev;\n  struct list_head        list;\n  bool                vbus;\n};\n</code></pre>"},{"location":"12_USB/11_1/#3-gadget","title":"3. \u200b\u4ece\u200b\u6784\u9020\u200b\u63cf\u8ff0\u7b26\u200b\u7684\u200b\u89d2\u5ea6\u200b\u7406\u89e3\u200bGadget\u200b\u6846\u67b6","text":"<p>\u200b\u5047\u8bbe\u200b\u4f60\u200b\u8981\u200b\u6a21\u62df\u200b\u4e00\u4e2a\u200bUSB\u200b\u8bbe\u5907\u200b\uff0c</p> <ul> <li>\u200b\u8fd9\u4e2a\u200bUSB\u200b\u8bbe\u5907\u200b\u542b\u6709\u200b\u5382\u5bb6\u200b\u4fe1\u606f\u200b\uff1a\u200b\u5b83\u200b\u8bb0\u5f55\u200b\u5728\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b\u91cc\u200b\uff0c\u200b\u6240\u4ee5\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b\u5e94\u8be5\u200b\u7531\u200b\u4f60\u200b\u63d0\u4f9b\u200b</li> <li>\u200b\u8fd9\u4e2a\u200b\u82af\u7247\u200b\u53ef\u80fd\u200b\u6709\u200b\u591a\u79cd\u200b\u914d\u7f6e\u200b\uff0c\u200b\u8fd9\u200b\u4e5f\u200b\u662f\u200b\u7531\u200b\u4f60\u200b\u51b3\u5b9a\u200b\uff0c\u200b\u6240\u4ee5\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26\u200b\u5e94\u8be5\u200b\u7531\u200b\u4f60\u200b\u63d0\u4f9b\u200b</li> <li>\u200b\u67d0\u4e2a\u200b\u914d\u7f6e\u200b\u4e0b\u200b\u591a\u4e2a\u200b\u63a5\u53e3\u200b\uff0c\u200b\u63a5\u53e3\u200b\u5c31\u662f\u200b\u529f\u80fd\u200b\uff0cLinux\u200b\u5185\u6838\u200b\u91cc\u200b\u4e8b\u5148\u200b\u63d0\u4f9b\u200b\u4e86\u200b\u5f88\u591a\u200b\u529f\u80fd\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u6240\u4ee5\u200b\uff1a\u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26\u200b\u662f\u200b\u5185\u6838\u200b\u63d0\u4f9b\u200b\u7684\u200b</li> <li>\u200b\u67d0\u4e2a\u200b\u63a5\u53e3\u200b\u4e0b\u200b\u9700\u8981\u200b\u4ec0\u4e48\u200b\u7aef\u70b9\u200b\uff0c\u200b\u4e5f\u200b\u662f\u200b\u5185\u6838\u200b\u91cc\u200b\u5404\u7c7b\u200b\u529f\u80fd\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u63d0\u4f9b\u200b\u7684\u200b</li> </ul> <p>\u200b\u4ee5\u200bzero.c\u200b\u4e3a\u4f8b\u200b\uff1a</p> <ul> <li>\u200b\u914d\u7f6e\u200b1\uff1aloopback\uff0cHost\u200b\u5199\u200b\u6570\u636e\u200b\u7ed9\u200b\u5b83\u200b\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u8bfb\u51fa\u200b\u539f\u6837\u200b\u7684\u200b\u6570\u636e\u200b</li> <li>\u200b\u914d\u7f6e\u200b2\uff1asourcesink\uff0cHost\u200b\u5199\u200b\u6570\u636e\u200b\u7ed9\u200b\u5b83\u200b(\u200b\u5b83\u200b\u53ea\u662f\u200b\u8bb0\u5f55\u200b\u4e0b\u200b\u6570\u636e\u200b)\uff0cHost\u200b\u8fd8\u200b\u53ef\u4ee5\u200b\u8bfb\u6570\u636e\u200b(\u200b\u8bfb\u5230\u200b\u7684\u200b\u90fd\u200b\u662f\u200b0)</li> </ul> <p>\u200b\u4ece\u4e0b\u5230\u4e0a\u200b\u6d89\u53ca\u200b\u8fd9\u4e9b\u200b\u6587\u4ef6\u200b\uff1a</p> <p></p> <p>\u200b\u9605\u8bfb\u200b\u6e90\u7801\u200b\u65f6\u200b\uff0c\u200b\u5165\u53e3\u200b\u51fd\u6570\u200b\u662f\u200b<code>usb_composite_probe(&amp;zero_driver)</code>\uff1a</p> <p></p> <p>\u200b\u51fd\u6570\u8c03\u7528\u200b\u8fc7\u7a0b\u200b\u4e2d\u200b\u4e3b\u8981\u200b\u7684\u200b\u51fd\u6570\u200b\u5982\u4e0b\u200b\uff0c\u200b\u91cd\u70b9\u200b\u5173\u6ce8\u200b\"xxx_bind\"\u200b\u51fd\u6570\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u8ba4\u4e3a\u200bbind\u200b\u5c31\u662f\u200b\u521d\u59cb\u5316\u200b\u7684\u200b\u610f\u601d\u200b\uff1a</p> <ul> <li>usb_composite_probe</li> <li>composite_bind</li> <li>zero_bind</li> <li>sourcesink_bind/loopback_bind</li> </ul> <p></p> <p>\u200b\u6df1\u5165\u200b\u89e3\u8bfb\u200b\u63cf\u8ff0\u7b26\u200b\u7684\u200b\u6784\u9020\u200b\u8fc7\u7a0b\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u4e0b\u9762\u200b\u7684\u200b\u56fe\u200b\uff1a</p> <ul> <li>\u200b\u6784\u9020\u200b\u51fa\u200b\u4e00\u4e2a\u200busb_composite_dev\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> <li>\u200b\u5b83\u200b\u628a\u200b\u5404\u5c42\u200b\u4e32\u8054\u200b\u8d77\u6765\u200b\uff0c\u200b\u91cc\u9762\u200b\u6784\u9020\u200b\u6709\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b\u3001\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26\u200b\u3001\u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26\u200b\u3001\u200b\u7aef\u70b9\u200b\u63cf\u8ff0\u7b26\u200b</li> </ul> <p></p>"},{"location":"12_USB/11_1/#4-gadget","title":"4. \u200b\u4ece\u200b\u83b7\u53d6\u200b\u63cf\u8ff0\u7b26\u200b\u7684\u200b\u89d2\u5ea6\u200b\u7406\u89e3\u200bGadget\u200b\u6846\u67b6","text":"<p>\u200b\u5b89\u88c5\u200b\u597d\u200bgadget\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u540e\u200b(\u200b\u6bd4\u5982\u200bmodprobe g_zero), \u200b\u5b83\u200b\u53ea\u662f\u200b\u6784\u9020\u200b\u597d\u200b\u4e86\u200b\u5404\u7c7b\u200b\u63cf\u8ff0\u7b26\u200b\u3002\u200b\u5728\u200b\u8bbe\u5907\u200b\u7684\u200b\u679a\u4e3e\u200b\u8fc7\u7a0b\u200b\u4f1a\u200b\u8bfb\u53d6\u200b\u63cf\u8ff0\u7b26\u200b\uff0c\u200b\u679a\u4e3e\u200b\u8fc7\u7a0b\u200b\u8981\u200b\u505a\u200b\u7684\u200b\u4e8b\u60c5\u200b\u53ef\u4ee5\u200b\u53c2\u8003\u200b\u300a05_USB\u200b\u63cf\u8ff0\u7b26\u200b.md\u300b\u200b\u7684\u200b\u300a4. \u200b\u8bbe\u5907\u200b\u679a\u4e3e\u200b\u8fc7\u7a0b\u200b\u793a\u4f8b\u200b\u300b\u3002</p> <p>\u200b\u4f7f\u7528\u200bOTG\u200b\u7ebf\u200b\u8fde\u63a5\u200b\u7535\u8111\u200b\u548c\u200b\u5f00\u53d1\u677f\u200b\u65f6\u200b\uff0c\u200b\u7535\u8111\u8f6f\u4ef6\u200b\u4f1a\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u64cd\u4f5c\u200b\uff1a</p> <ul> <li>\u200b\u4f7f\u7528\u200b\u63a7\u5236\u4f20\u8f93\u200b\uff0c\u200b\u8bfb\u53d6\u200b\u8bbe\u5907\u200b\u4fe1\u606f\u200b(\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b)\uff1a\u200b\u7b2c\u4e00\u6b21\u200b\u8bfb\u53d6\u200b\u65f6\u200b\uff0c\u200b\u5b83\u200b\u53ea\u200b\u9700\u8981\u200b\u5f97\u5230\u200b8\u200b\u5b57\u8282\u200b\u6570\u636e\u200b\uff0c\u200b\u56e0\u4e3a\u200b\u7b2c\u200b8\u200b\u4e2a\u200b\u6570\u636e\u8868\u793a\u200b\u7aef\u70b9\u200b0\u200b\u80fd\u200b\u4f20\u8f93\u200b\u7684\u200b\u6700\u5927\u200b\u6570\u636e\u200b\u957f\u5ea6\u200b\u3002</li> <li>Host\u200b\u5206\u914d\u200b\u5730\u5740\u200b\u7ed9\u200b\u8bbe\u5907\u200b\uff0c\u200b\u7136\u540e\u200b\u628a\u200b\u65b0\u200b\u5730\u5740\u200b\u53d1\u7ed9\u200b\u8bbe\u5907\u200b</li> <li>\u200b\u4f7f\u7528\u200b\u65b0\u200b\u5730\u5740\u200b\uff0c\u200b\u91cd\u65b0\u200b\u8bfb\u53d6\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b\uff0c\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b\u957f\u5ea6\u200b\u662f\u200b18</li> <li>\u200b\u8bfb\u53d6\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26\u200b\uff1a\u200b\u5b83\u200b\u4f20\u5165\u200b\u7684\u200b\u957f\u5ea6\u200b\u662f\u200b255\uff0c\u200b\u60f3\u200b\u4e00\u6b21\u6027\u200b\u628a\u200b\u5f53\u524d\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26\u200b\u3001\u200b\u5b83\u200b\u4e0b\u9762\u200b\u7684\u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26\u200b\u3001\u200b\u7aef\u70b9\u200b\u63cf\u8ff0\u7b26\u200b\u5168\u90e8\u200b\u8bfb\u51fa\u6765\u200b</li> <li>\u200b\u8bfb\u53d6\u200b\u5b57\u7b26\u200b\u63cf\u8ff0\u7b26\u200b</li> </ul> <p>\u200b\u4e0a\u8ff0\u200b\u8fc7\u7a0b\u200b\u91cc\u200b\uff0c\u200b\u8bbe\u5907\u200b\u65b9\u90fd\u200b\u662f\u200b\u63a5\u6536\u200b\u5230\u200bHost\u200b\u53d1\u7ed9\u200bendpoint 0\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u7136\u540e\u200b\u505a\u51fa\u200b\u56de\u5e94\u200b\u3002\u200b\u4e0d\u540c\u200b\u7684\u200bGadget\u200b\u8bbe\u5907\u200b\uff0c\u200b\u5728\u200b\u8fd4\u56de\u200b\u63cf\u8ff0\u7b26\u200b\u7ed9\u200b\u4e3b\u673a\u200b\u65f6\u200b\uff0c\u200b\u8fd9\u4e9b\u200b\u64cd\u4f5c\u200b\u90fd\u200b\u662f\u200b\u4e00\u6837\u200b\u7684\u200b\uff0c\u200b\u53ea\u662f\u200b\u56de\u5e94\u200b\u7684\u200b\u6570\u636e\u200b\u4e0d\u540c\u200b\u800c\u5df2\u200b\u3002\u200b\u6e90\u7801\u200b\u5206\u6790\u200b\u7684\u200b\u8d77\u70b9\u200b\u90fd\u200b\u662f\u200b\u67d0\u4e2a\u200b\u4e2d\u65ad\u200b\u51fd\u6570\u200b\uff1a</p> <ul> <li>IMX6ULL\uff1aci_irq(drivers/usb/chipidea/core.c)</li> <li>STM32MP157: dwc2_hsotg_irq(drivers/usb/dwc2/gadget.c)</li> </ul>"},{"location":"12_USB/11_1/#41-imx6ull","title":"4.1 IMX6ULL\u200b\u7684\u200b\u6838\u5fc3\u200b\u51fd\u6570","text":"<p>IMX6ULL\u200b\u82af\u7247\u200b\u4e2d\u200bUSB\u200b\u63a7\u5236\u5668\u200b\u578b\u53f7\u200b\u662f\u200bchipidea\uff0c\u200b\u5728\u200b<code>Linux-4.9.88\\drivers\\usb\\chipidea\\core.c</code>\u200b\u4e2d\u200b\u6ce8\u518c\u200b\u4e86\u200b\u4e2d\u65ad\u200b\u51fd\u6570\u200b\uff1a</p> <pre><code>ci_hdrc_probe\n    ret = devm_request_irq(dev, ci-&gt;irq, ci_irq, IRQF_SHARED,\n            ci-&gt;platdata-&gt;name, ci);    \n</code></pre> <p>\u200b\u53d1\u751f\u200b\u4e2d\u65ad\u200b\u540e\u200b\uff0c\u200b\u5bf9\u4e8e\u200bendpoint 0\u200b\u7684\u200b\u6570\u636e\u5904\u7406\u200b\u6d41\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>// Linux-4.9.88\\drivers\\usb\\chipidea\\core.c\nci_irq\n    /* Handle device/host interrupt */\n    if (ci-&gt;role != CI_ROLE_END)\n        ret = ci_role(ci)-&gt;irq(ci);  // udc_irq\n\n            // Linux-4.9.88\\drivers\\usb\\chipidea\\udc.c\n            udc_irq\n                if (USBi_UI  &amp; intr)\n                    // Linux-4.9.88\\drivers\\usb\\chipidea\\udc.c\n                    isr_tr_complete_handler(ci);\n                        /* Only handle setup packet below */\n                        if (i == 0 &amp;&amp;\n                            hw_test_and_clear(ci, OP_ENDPTSETUPSTAT, BIT(0)))\n                            // Linux-4.9.88\\drivers\\usb\\chipidea\\udc.c\n                            isr_setup_packet_handler(ci);\n</code></pre> <p>\u200b\u51fd\u6570\u200b<code>isr_setup_packet_handler</code>\u200b\u5c31\u662f\u200b\u5904\u7406\u200bendpoint 0\u200b\u63a5\u6536\u200b\u5230\u200b\u7684\u200b\u63a7\u5236\u4f20\u8f93\u200b\u7684\u200b\u5173\u952e\u200b\u3002</p>"},{"location":"12_USB/11_1/#42-stm32mp157","title":"4.2 STM32MP157\u200b\u7684\u200b\u6838\u5fc3\u200b\u51fd\u6570","text":"<p>STM32MP157\u200b\u82af\u7247\u200b\u4e2d\u200bUSB\u200b\u63a7\u5236\u5668\u200b\u578b\u53f7\u200b\u662f\u200bdwc2\uff0c\u200b\u5728\u200b<code>Linux-5.4\\drivers\\usb\\dwc2\\gadget.c</code>\u200b\u4e2d\u200b\u6ce8\u518c\u200b\u4e86\u200b\u4e2d\u65ad\u200b\u51fd\u6570\u200b\uff1a</p> <pre><code>dwc2_gadget_init\n    ret = devm_request_irq(hsotg-&gt;dev, hsotg-&gt;irq, dwc2_hsotg_irq,\n                   IRQF_SHARED, dev_name(hsotg-&gt;dev), hsotg);   \n</code></pre> <p>\u200b\u53d1\u751f\u200b\u4e2d\u65ad\u200b\u540e\u200b\uff0c\u200b\u51fd\u6570\u200b<code>dwc2_hsotg_irq</code>\u200b\u88ab\u200b\u8c03\u7528\u200b\uff0c\u200b\u5b83\u200b\u5904\u7406\u200bendpoint\u200b\u4e2d\u65ad\u200b\u6709\u200b\u4e24\u79cd\u200b\u65b9\u6cd5\u200b\uff1a</p> <ul> <li>\u200b\u4f7f\u7528\u200bDMA\u200b\u65f6\u200b\uff1a\u200b\u8c03\u7528\u200b<code>dwc2_hsotg_epint</code>\u200b\u6765\u200b\u5904\u7406\u200b</li> <li>\u200b\u4e0d\u200b\u4f7f\u7528\u200bDMA\u200b\u65f6\u200b\uff1a\u200b\u8c03\u7528\u200b<code>dwc2_hsotg_handle_rx</code>\u200b\u6765\u200b\u5904\u7406\u200b</li> </ul> <p>\u200b\u4ee5\u200b<code>dwc2_hsotg_epint</code>\u200b\u4e3a\u4f8b\u200b\u8fdb\u884c\u200b\u5206\u6790\u200b\uff0c\u200b\u5bf9\u4e8e\u200bendpoint 0\u200b\u7684\u200b\u6570\u636e\u5904\u7406\u200b\u6d41\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>// Linux-5.4\\drivers\\usb\\dwc2\\gadget.c\ndwc2_hsotg_irq\n        // \u200b\u5904\u7406\u200bendpoint\u200b\u4e2d\u65ad\u200b\n        for (ep = 0; ep &lt; hsotg-&gt;num_of_eps &amp;&amp; daint_out;\n                        ep++, daint_out &gt;&gt;= 1) {\n            if (daint_out &amp; 1)\n                dwc2_hsotg_epint(hsotg, ep, 0);\n        }\n\n        for (ep = 0; ep &lt; hsotg-&gt;num_of_eps  &amp;&amp; daint_in;\n                        ep++, daint_in &gt;&gt;= 1) {\n            if (daint_in &amp; 1)\n                dwc2_hsotg_epint(hsotg, ep, 1);\n        }   \n</code></pre> <p>\u200b\u51fd\u6570\u200b<code>dwc2_hsotg_epint</code>\u200b\u4e2d\u200b\uff0c\u200b\u5bf9\u4e8e\u200bendpoint 0\u200b\u7684\u200b\u5904\u7406\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>// Linux-5.4\\drivers\\usb\\dwc2\\gadget.c\ndwc2_hsotg_epint\n    if (idx == 0 &amp;&amp; !hs_ep-&gt;req)\n        dwc2_hsotg_enqueue_setup(hsotg); \n</code></pre> <p>\u200b\u51fd\u6570\u200b<code>dwc2_hsotg_enqueue_setup</code>\u200b\u88ab\u200b\u8c03\u7528\u200b\u65f6\u200b\uff0cGadget\u200b\u8bbe\u5907\u200b\u5df2\u7ecf\u200b\u6536\u5230\u200b\u4e86\u200bSETUP\u200b\u4ee4\u724c\u200b\u5305\u200b\uff0c\u200b\u4f46\u662f\u200b\u8fd8\u200b\u6ca1\u6536\u200b\u5230\u200bDATA0\u200b\u4ee4\u724c\u200b\u5305\u200b\u3002<code>dwc2_hsotg_enqueue_setup</code>\u200b\u7684\u200b\u4f5c\u7528\u200b\u662f\u200b\uff0c\u200b\u8bbe\u7f6e\u200b\u3001\u200b\u542f\u52a8\u200b\u4e00\u4e2a\u200brequest\uff0c\u200b\u6838\u5fc3\u200b\u5728\u4e8e\u200b\u8bbe\u7f6e\u200b\u4e86\u200brequest\u200b\u7684\u200bcomplete\u200b\u51fd\u6570\u200b(\u200b\u5f53\u200bSETTUP\u200b\u4e8b\u52a1\u200b\u5b8c\u6210\u200b\u540e\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b)\uff1a</p> <p></p> <p>\u200b\u5f53\u200b\u63a7\u5236\u4f20\u8f93\u200b\u7684\u200b\"setup\u200b\u4e8b\u52a1\u200b\"\u200b\u5b8c\u6210\u200b\u65f6\u200b\uff0c\u200b\u51fd\u6570\u200b<code>dwc2_hsotg_complete_setup</code>\u200b\u88ab\u200b\u8c03\u7528\u200b\u3002</p>"},{"location":"12_USB/11_1/#43","title":"4.3 \u200b\u5982\u4f55\u200b\u5904\u7406\u200b\u63a7\u5236\u4f20\u8f93","text":"<p>\u200b\u65e0\u8bba\u662f\u200bIMX6ULL\u200b\u7684\u200b\u51fd\u6570\u200b<code>isr_setup_packet_handler</code>\uff0c\u200b\u8fd8\u662f\u200bSTM32M157\u200b\u7684\u200b\u51fd\u6570\u200b<code>dwc2_hsotg_complete_setup</code>\uff0c\u200b\u5b83\u4eec\u200b\u90fd\u200b\u662f\u200b\u5728\u200bGadget\u200b\u8bbe\u5907\u200b\u6536\u5230\u200b\"SETUP\u200b\u4e8b\u52a1\u200b\"\u200b\u540e\u200b\u624d\u200b\u88ab\u200b\u8c03\u7528\u200b\u3002\u200b\u63a5\u6536\u200b\u5b8c\u200b\"SETUP\u200b\u4e8b\u52a1\u200b\"\u200b\u540e\u200b\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u4ece\u200b\u91cc\u9762\u200b\u77e5\u9053\u200b\u8fd9\u4e2a\u200b\u63a7\u5236\u4f20\u8f93\u200b\u60f3\u200b\u505a\u200b\u4ec0\u4e48\u200b(req.bRequest\u200b\u662f\u200b\u4ec0\u4e48\u200b)\uff0c\u200b\u7136\u540e\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u5904\u7406\u200b\u5b83\u200b\u4e86\u200b\u3002</p> <p>\u200b\u600e\u4e48\u200b\u5904\u7406\u200b\u5462\u200b\uff1f\u200b\u53ef\u4ee5\u200b\u5206\u4e3a\u200b3\u200b\u5c42\u200b\uff1a</p> <p></p> <ul> <li> <p>UDC\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff1a\u200b\u7c7b\u4f3c\u200b\"\u200b\u8bbe\u7f6e\u200b\u5730\u5740\u200b\"\u200b\u7684\u200b\u63a7\u5236\u4f20\u8f93\u200b\uff0c\u200b\u5728\u200b\u5e95\u5c42\u200b\u7684\u200bUDC\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u91cc\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u5904\u7406\u200b\uff0c</p> </li> <li> <p>\u200b\u8fd9\u200b\u7c7b\u200b\u8bf7\u6c42\u200b\u6709\u200b\uff1a</p> <p><pre><code>USB_REQ_SET_ADDRESS\nUSB_REQ_SET_FEATURE     // \u200b\u6709\u200b\u4e00\u4e9b\u200b\u8bf7\u6c42\u200b\u53ef\u80fd\u200b\u9700\u8981\u200b\u4e0a\u62a5\u200b\u6539\u200bgadget driver\nUSB_REQ_CLEAR_FEATURE   // \u200b\u6709\u200b\u4e00\u4e9b\u200b\u8bf7\u6c42\u200b\u53ef\u80fd\u200b\u9700\u8981\u200b\u4e0a\u62a5\u200b\u6539\u200bgadget driver\nUSB_REQ_GET_STATUS      // \u200b\u6709\u200b\u4e00\u4e9b\u200b\u8bf7\u6c42\u200b\u53ef\u80fd\u200b\u9700\u8981\u200b\u4e0a\u62a5\u200b\u6539\u200bgadget driver\n</code></pre>   * \u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4f4d\u7f6e\u200b</p> <pre><code>IMX6ULL: Linux-4.9.88\\drivers\\usb\\chipidea\\udc.c, \u200b\u51fd\u6570\u200bisr_setup_packet_handler\nSTM32MP157: Linux-5.4\\drivers\\usb\\dwc2\\gadget.c, \u200b\u51fd\u6570\u200bdwc2_hsotg_complete_setup\n</code></pre> </li> <li> <p>gadget driver\uff1a\u200b\u6d89\u53ca\u200b\u63cf\u8ff0\u7b26\u200b\u7684\u200b\u64cd\u4f5c\u200b</p> </li> <li> <p>\u200b\u8fd9\u200b\u7c7b\u200b\u8bf7\u6c42\u200b\u6709\u200b\uff1a</p> <pre><code>USB_REQ_GET_DESCRIPTOR\nUSB_REQ_SET_CONFIGURATION\nUSB_REQ_GET_CONFIGURATION\nUSB_REQ_SET_INTERFACE\nUSB_REQ_GET_INTERFACE\nUSB_REQ_GET_STATUS     // \u200b\u5e95\u5c42\u200bUDC\u200b\u9a71\u52a8\u200b\u65e0\u6cd5\u200b\u5904\u7406\u200b\u7684\u8bdd\u200b, gadget driver\u200b\u6765\u200b\u5904\u7406\u200b\nUSB_REQ_CLEAR_FEATURE  // \u200b\u5e95\u5c42\u200bUDC\u200b\u9a71\u52a8\u200b\u65e0\u6cd5\u200b\u5904\u7406\u200b\u7684\u8bdd\u200b, gadget driver\u200b\u6765\u200b\u5904\u7406\u200b\nUSB_REQ_SET_FEATURE    // \u200b\u5e95\u5c42\u200bUDC\u200b\u9a71\u52a8\u200b\u65e0\u6cd5\u200b\u5904\u7406\u200b\u7684\u8bdd\u200b, gadget driver\u200b\u6765\u200b\u5904\u7406\u200b\n</code></pre> </li> <li> <p>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4f4d\u7f6e\u200b</p> <pre><code>\u200b\u6587\u4ef6\u200b\uff1adrivers\\usb\\gadget\\composite.c\n\u200b\u51fd\u6570\u200b\uff1acomposite_setup\n</code></pre> </li> <li> <p>usb_configuration\u200b\u6216\u200busb_function\u200b\u7684\u200b\u5904\u7406\u200b\uff1a\u200b\u8fd9\u662f\u200b\u4e8c\u9009\u200b\u4e00\u200b\u7684\u200b\u3002\u200b\u5927\u90e8\u5206\u200b\u8bbe\u5907\u200b\u4f7f\u7528\u200b\u63a7\u5236\u4f20\u8f93\u200b\u5b9e\u73b0\u200b\u6807\u51c6\u200b\u7684\u200bUSB\u200b\u8bf7\u6c42\u200b\uff0c\u200b\u4f46\u662f\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u7528\u200b\u63a7\u5236\u4f20\u8f93\u200b\u6765\u200b\u8fdb\u884c\u200b\u5b9e\u73b0\u200b\u76f8\u5173\u200b\u7684\u200b\u8bf7\u6c42\u200b\uff0c\u200b\u5bf9\u4e8e\u200b\u8fd9\u4e9b\u200b\u975e\u6807\u51c6\u200b\u7684\u200b\u8bf7\u6c42\u200b\uff0c\u200b\u5c31\u200b\u9700\u8981\u200b\u4e0a\u5c42\u200b\u9a71\u52a8\u200b\u6765\u200b\u5904\u7406\u200b\u3002</p> </li> </ul>"},{"location":"12_USB/11_1/#5-gadget","title":"5. \u200b\u4ece\u200b\u6570\u636e\u4f20\u8f93\u200b\u7684\u200b\u89d2\u5ea6\u200b\u7406\u89e3\u200bGadget\u200b\u6846\u67b6","text":""},{"location":"12_USB/11_1/#51","title":"5.1 \u200b\u4f7f\u7528\u200b\u6d41\u7a0b","text":"<p>\u200b\u5728\u200bUSB\u200b\u534f\u8bae\u200b\u4e2d\u200b\uff0c\u200b\u6c38\u8fdc\u200b\u662f\u200bHost\u200b\u4e3b\u52a8\u200b\u53d1\u8d77\u200b\u4f20\u8f93\u200b\u3002\u200b\u4f5c\u4e3a\u200b\u4e00\u4e2a\u200bGadget\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u5b83\u200b\u6c38\u8fdc\u90fd\u662f\u200b\u8fd9\u6837\u200b\uff1a</p> <ul> <li>\u200b\u60f3\u200b\u63a5\u6536\u6570\u636e\u200b\uff1a</li> <li>\u200b\u5148\u200b\u6784\u9020\u200b\u597d\u200busb_request\uff1a\u200b\u5206\u914d\u200bbuffer\u3001\u200b\u8bbe\u7f6e\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b</li> <li>\u200b\u628a\u200busb_request\u200b\u653e\u5165\u200b\u961f\u5217\u200b</li> <li>UDC\u200b\u548c\u200bHost\u200b\u5b8c\u6210\u200bUSB\u200b\u4f20\u8f93\u200b\uff0c\u200b\u5728\u200busb_request\u200b\u4e2d\u200b\u586b\u5145\u200b\u6570\u636e\u200b\uff0c\u200b\u5e76\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\u8c03\u7528\u200busb_request\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b</li> <li>\u200b\u60f3\u200b\u53d1\u9001\u6570\u636e\u200b\uff1a</li> <li>\u200b\u5148\u200b\u6784\u9020\u200b\u597d\u200busb_request\uff1a\u200b\u5206\u914d\u200bbuffer\u3001\u200b\u5728\u200bbuffer\u200b\u91cc\u200b\u586b\u5145\u200b\u6570\u636e\u200b\u3001\u200b\u8bbe\u7f6e\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b</li> <li>\u200b\u628a\u200busb_request\u200b\u653e\u5165\u200b\u961f\u5217\u200b</li> <li>UDC\u200b\u548c\u200bHost\u200b\u5b8c\u6210\u200bUSB\u200b\u4f20\u8f93\u200b\uff0c\u200b\u628a\u200busb_request\u200b\u7684\u200b\u6570\u636e\u200b\u53d1\u7ed9\u200bHost\uff0c\u200b\u5e76\u200b\u89e6\u53d1\u200b\u4e2d\u65ad\u200b\u8c03\u7528\u200busb_request\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b</li> </ul>"},{"location":"12_USB/11_1/#52-endpoint","title":"5.2 endpoint\u200b\u662f\u200b\u6838\u5fc3","text":"<p>USB\u200b\u4f20\u8f93\u200b\u7684\u200b\u5bf9\u8c61\u200b\u662f\u200bendpoint\uff0c\u200b\u4f7f\u7528\u200b\u6d41\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u529f\u80fd\u200b\u9a71\u52a8\u200b\u91cc\u200b\uff0c\u200b\u901a\u8fc7\u200bendpoint\u200b\u63cf\u8ff0\u7b26\u200b\u8868\u660e\u200b\u9700\u8981\u200b\u600e\u6837\u200b\u7684\u200bendpoint\uff0c\u200b\u6bd4\u5982\u200b\uff08\u200b\u6ce8\u610f\u200b\uff1abEndpointAddress\u200b\u53ea\u662f\u200b\u8868\u660e\u200b\u65b9\u5411\u200b\uff0c\u200b\u91cc\u9762\u200b\u8fd8\u200b\u6ca1\u6709\u200b\u5730\u5740\u200b\uff0cdrivers\\usb\\gadget\\function\\f_loopback.c\uff09\uff1a</li> </ul> <p></p> <ul> <li>\u200b\u529f\u80fd\u200b\u9a71\u52a8\u200b\u91cc\u200b\uff0c\u200b\u5b83\u200b\u7684\u200bbind\u200b\u51fd\u6570\u200b\u6839\u636e\u200bendpoint\u200b\u63cf\u8ff0\u7b26\u200b\u5411\u200b\u5e95\u5c42\u200b\u7533\u8bf7\u200b\u5206\u914d\u200bendpoint\uff0c\u200b\u6bd4\u5982\u200b\uff1a</li> </ul> <p></p> <ul> <li>\u200b\u529f\u80fd\u200b\u9a71\u52a8\u200b\u91cc\u200b\uff0c\u200b\u4f7f\u80fd\u200bendpoint\uff0c\u200b\u6bd4\u5982\u200b\uff1a</li> </ul> <p></p> <ul> <li>\u200b\u529f\u80fd\u200b\u9a71\u52a8\u200b\u91cc\u200b\uff0c\u200b\u7ed9\u200bendpoint\u200b\u5206\u914d\u200bbuffer\u3001\u200b\u8bbe\u7f6e\u200busb_request\u3001\u200b\u63d0\u4ea4\u200busb_request\uff0c\u200b\u6bd4\u5982\u200b\uff1a</li> </ul> <p></p>"},{"location":"12_USB/11_1/#53","title":"5.3 \u200b\u56de\u8c03\u200b\u51fd\u6570","text":"<p>\u200b\u529f\u80fd\u200b\u9a71\u52a8\u200b\u91cc\u200b\u6784\u9020\u200b\u7684\u200busb_request\uff0c\u200b\u53ef\u4ee5\u200b\u662f\u200b\u63a5\u6536\u200bHost\u200b\u53d1\u6765\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u662f\u200b\u5411\u200bHost\u200b\u53d1\u9001\u6570\u636e\u200b\u3002\u200b\u5f53\u200b\u4f20\u8f93\u200b\u5b8c\u6210\u200b\uff0cusb_request\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b\u3002</p> <p>\u200b\u5728\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u91cc\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u518d\u6b21\u200b\u63d0\u4ea4\u200busb_request\u3002</p> <p>\u200b\u600e\u4e48\u200b\u8c03\u7528\u200b\u5230\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\uff1f\u200b\u6e90\u5934\u200b\u662f\u200bUDC\u200b\u7684\u200b\u4e2d\u65ad\u200b\u51fd\u6570\u200b\u3002</p>"},{"location":"12_USB/11_1/#531-imx6ull","title":"5.3.1 IMX6ULL","text":"<p>\u200b\u8c03\u7528\u200b\u5173\u7cfb\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>// Linux-4.9.88\\drivers\\usb\\chipidea\\core.c\nci_irq\n    /* Handle device/host interrupt */\n    if (ci-&gt;role != CI_ROLE_END)\n        ret = ci_role(ci)-&gt;irq(ci);  // udc_irq\n            udc_irq\n                if (USBi_UI  &amp; intr)\n                    isr_tr_complete_handler(ci);\n                        err = isr_tr_complete_low(hwep);\n                                    usb_gadget_giveback_request(&amp;hweptemp-&gt;ep, &amp;hwreq-&gt;req);\n                                        req-&gt;complete(ep, req);             \n</code></pre>"},{"location":"12_USB/11_1/#532-stm32mp157","title":"5.3.2 STM32MP157","text":"<p>\u200b\u8c03\u7528\u200b\u5173\u7cfb\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>// Linux-5.4\\drivers\\usb\\dwc2\\gadget.c\ndwc2_hsotg_irq\n        // \u200b\u5904\u7406\u200bendpoint\u200b\u4e2d\u65ad\u200b\n        for (ep = 0; ep &lt; hsotg-&gt;num_of_eps &amp;&amp; daint_out;\n                        ep++, daint_out &gt;&gt;= 1) {\n            if (daint_out &amp; 1)\n                dwc2_hsotg_epint(hsotg, ep, 0);\n                    dwc2_hsotg_handle_outdone(hsotg, idx);\n                        dwc2_hsotg_complete_request(hsotg, hs_ep, hs_req, result);\n                            usb_gadget_giveback_request(&amp;hs_ep-&gt;ep, &amp;hs_req-&gt;req);\n                                req-&gt;complete(ep, req);\n        }\n\n        for (ep = 0; ep &lt; hsotg-&gt;num_of_eps  &amp;&amp; daint_in;\n                        ep++, daint_in &gt;&gt;= 1) {\n            if (daint_in &amp; 1)\n                dwc2_hsotg_epint(hsotg, ep, 1);\n                    dwc2_hsotg_complete_in(hsotg, hs_ep);\n                        dwc2_hsotg_complete_request(hsotg, hs_ep, hs_req, 0);\n                            usb_gadget_giveback_request(&amp;hs_ep-&gt;ep, &amp;hs_req-&gt;req);\n                                req-&gt;complete(ep, req);\n        }   \n</code></pre>"},{"location":"12_USB/11_1/#54-f_loopback","title":"5.4 f_loopback\u200b\u5206\u6790","text":"<p>loopback\u200b\u5c31\u662f\u200b\u56de\u73af\u200b\uff0cHost\u200b\u53d1\u200b\u6570\u636e\u200b\u7ed9\u200bGadget\uff0c\u200b\u7136\u540e\u200b\u518d\u200b\u8bfb\u200bGadget\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u5f97\u5230\u200b\u539f\u6837\u200b\u7684\u200b\u6570\u636e\u200b\u3002</p>"},{"location":"12_USB/11_1/#541-gadget","title":"5.4.1 Gadget\u200b\u63a5\u6536\u6570\u636e","text":"<p>Host\u200b\u9009\u62e9\u200b\u67d0\u4e2a\u200b\u914d\u7f6e\u200b\u65f6\u200b\uff0c\u200b\u9ed8\u8ba4\u200b\u4f1a\u200b\u9009\u62e9\u200b\u8fd9\u4e2a\u200b\u914d\u7f6e\u200b\u4e0b\u200b\u90a3\u4e9b\u200b\u63a5\u53e3\u200b\u7684\u200b\u7b2c\u200b0\u200b\u4e2a\u200b\u8bbe\u7f6e\u200b(altsetting)\uff1b</p> <p>\u200b\u5f53\u200bHost\u200b\u53d1\u6765\u200bUSB_REQ_SET_INTERFACE\u200b\u8bf7\u6c42\u200b\u65f6\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u9009\u62e9\u200b\u6307\u5b9a\u200b\u7684\u200b\u8bbe\u7f6e\u200b\u3002</p> <p>\u200b\u6240\u200b\u4e3a\u200b\uff0c\u200b\u6211\u4eec\u200b\u4ece\u200bf_loopback.c\u200b\u7684\u200b\u51fd\u6570\u200b<code>loopback_set_alt</code>\u200b\u5f00\u59cb\u200b\u5206\u6790\u200b\u3002</p> <p>\u200b\u8c03\u7528\u200b\u5173\u7cfb\u200b\u4e3a\u200b\uff1a</p> <pre><code>loopback_set_alt\n    enable_loopback\n        result = enable_endpoint(cdev, loop, loop-&gt;in_ep);\n\n        result = enable_endpoint(cdev, loop, loop-&gt;out_ep);\n\n        result = alloc_requests(cdev, loop);\n</code></pre> <p></p> <p>\u200b\u5982\u4e0a\u56fe\u200b\u6240\u793a\u200b\uff0c\u200b\u5148\u200b\u63d0\u4ea4\u200b\u7684\u200b\u662f\u200bout_req\uff0c\u200b\u5b83\u200b\u5728\u200b\u7b49\u5f85\u200bHost\u200b\u53d1\u6765\u200b\u6570\u636e\u200b\u3002</p> <p>\u200b\u5047\u8bbe\u200b\u65ad\u70b9\u200bloop-&gt;out_ep\u200b\u7684\u200bout_req\u200b\u83b7\u5f97\u200b\u4e86\u200b\u6570\u636e\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b<code>loopback_complete</code>\u200b\u88ab\u200b\u8c03\u7528\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"12_USB/11_1/#542-gadget","title":"5.4.2 Gadget\u200b\u56de\u73af\u200b\u6570\u636e","text":""},{"location":"12_USB/11_1/#55-f_sourcesink","title":"5.5 f_sourcesink\u200b\u5206\u6790","text":"<p>\u200b\u524d\u9762\u200b\u7684\u200bf_loopback\u200b\u4e5f\u200b\u5b9e\u73b0\u200b\u4e86\u200b\u4e24\u4e2a\u200b\u65b9\u5411\u200b\u7684\u200b\u6570\u636e\u4f20\u8f93\u200b\uff1aHost\u200b\u5230\u200bGadget\u3001Gadget\u200b\u5230\u200bHost\uff0c\u200b\u4f46\u662f\u200b\u5b83\u4eec\u200b\u4e4b\u95f4\u200b\u662f\u200b\u6709\u200b\u4f9d\u8d56\u200b\u5173\u7cfb\u200b\u7684\u200b\uff0cHost\u200b\u5fc5\u987b\u200b\u5148\u200b\u53d1\u9001\u6570\u636e\u200b\u518d\u200b\u8bfb\u6570\u636e\u200b\u3002</p> <p>f_sourcesink.c\u200b\u4e5f\u200b\u5b9e\u73b0\u200b\u4e86\u200b\u4e24\u4e2a\u200b\u65b9\u5411\u200b\u7684\u200b\u6570\u636e\u4f20\u8f93\u200b\uff1aHost\u200b\u5230\u200bGadget\u3001Gadget\u200b\u5230\u200bHost\uff0c\u200b\u5b83\u4eec\u200b\u662f\u200b\u72ec\u7acb\u200b\u7684\u200b\u3002</p> <ul> <li>Host\u200b\u8bfb\u200bGadget\uff1a\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u91cc\u200b\u6784\u9020\u200b\u597d\u200b\u6570\u636e\u200b\uff0cHost\u200b\u53ef\u4ee5\u200b\u8bfb\u200b\u5230\u200b\uff0cGadget\u200b\u4f5c\u4e3a\u200b\u6e90\u200b(\u200b\u5c31\u662f\u200bsource)</li> <li>Host\u200b\u5199\u200bGadget\uff1a\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u91cc\u200b\u5f97\u5230\u200bHost\u200b\u53d1\u6765\u200b\u7684\u200b\u6570\u636e\u200b\uff0cGadget\u200b\u4f5c\u4e3a\u200b\u76ee\u7684\u200b(\u200b\u5c31\u662f\u200bsink)</li> </ul>"},{"location":"12_USB/11_1/#551-hostgadget","title":"5.5.1 Host\u200b\u5199\u200bGadget","text":"<p>Host\u200b\u9009\u62e9\u200b\u67d0\u4e2a\u200b\u914d\u7f6e\u200b\u65f6\u200b\uff0c\u200b\u9ed8\u8ba4\u200b\u4f1a\u200b\u9009\u62e9\u200b\u8fd9\u4e2a\u200b\u914d\u7f6e\u200b\u4e0b\u200b\u90a3\u4e9b\u200b\u63a5\u53e3\u200b\u7684\u200b\u7b2c\u200b0\u200b\u4e2a\u200b\u8bbe\u7f6e\u200b(altsetting)\uff1b</p> <p>\u200b\u5f53\u200bHost\u200b\u53d1\u6765\u200bUSB_REQ_SET_INTERFACE\u200b\u8bf7\u6c42\u200b\u65f6\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u9009\u62e9\u200b\u6307\u5b9a\u200b\u7684\u200b\u8bbe\u7f6e\u200b\u3002</p> <p>\u200b\u6240\u200b\u4e3a\u200b\uff0c\u200b\u6211\u4eec\u200b\u4ece\u200bf_sourcesink.c\u200b\u7684\u200b\u51fd\u6570\u200b<code>sourcesink_set_alt</code>\u200b\u5f00\u59cb\u200b\u5206\u6790\u200b\u3002</p> <pre><code>sourcesink_set_alt\n    enable_source_sink(cdev, ss, alt);      \n</code></pre> <p></p> <p>\u200b\u4f5c\u4e3a\u200b\"source\"\uff0c\u200b\u51fd\u6570\u200b<code>source_sink_start_ep</code>\u200b\u4f1a\u200b\u6784\u9020\u200b\u6570\u636e\u200b\u3001\u200b\u63d0\u4ea4\u200busb_request\uff1a</p> <p></p> <p>\u200b\u5f53\u200bHost\u200b\u8bfb\u53d6\u200b\u5230\u200b\u6570\u636e\u200b\u540e\u200b\uff0cusb_request\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b\uff0c\u200b\u5b83\u200b\u53ea\u662f\u200b\u518d\u6b21\u200b\u63d0\u4ea4\u200bUSB\u200b\u8bf7\u6c42\u200b\uff0c\u200b\u7ed9\u200bHost\u200b\u7ee7\u7eed\u200b\u63d0\u4f9b\u200b\u8ddf\u200b\u4e0a\u6b21\u200b\u4e00\u6837\u200b\u7684\u200b\u6570\u636e\u200b\uff1a</p> <p></p>"},{"location":"12_USB/11_1/#552-hostgadget","title":"5.5.2 Host\u200b\u8bfb\u200bGadget","text":"<p>\u200b\u4ecd\u7136\u200b\u4ece\u200bf_sourcesink.c\u200b\u7684\u200b\u51fd\u6570\u200b<code>sourcesink_set_alt</code>\u200b\u5f00\u59cb\u200b\u5206\u6790\u200b\u3002</p> <pre><code>sourcesink_set_alt\n    enable_source_sink(cdev, ss, alt);      \n</code></pre> <p></p> <p>\u200b\u4f5c\u4e3a\u200b\"sink\"\uff0c\u200b\u51fd\u6570\u200b<code>source_sink_start_ep</code>\u200b\u4f1a\u200b\u6545\u610f\u200b\u628a\u200b\u6570\u636e\u200b\u8bbe\u7f6e\u200b\u4e3a\u200b0x55\uff08\u200b\u8fd9\u662f\u200b\u4e3a\u4e86\u200b\u8c03\u8bd5\u200b\uff0c\u200b\u5f53\u8bfb\u200b\u5230\u200b\u6570\u636e\u200b\u65f6\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200b0x55\u200b\u88ab\u200b\u8986\u76d6\u200b\uff09\u3001\u200b\u63d0\u4ea4\u200busb_request\uff1a</p> <p></p> <p>\u200b\u5f53\u200bHost\u200b\u53d1\u6765\u200b\u6570\u636e\u200b\uff0cusb_request\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b\uff0c\u200b\u5b83\u200b\u68c0\u67e5\u200b\u6536\u5230\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u518d\u6b21\u200b\u63d0\u4ea4\u200busb_request\uff1a</p> <p></p>"},{"location":"12_USB/12_1/","title":"Gadget\u200b\u5e94\u7528\u200b\u5b9e\u4f8b\u200b\u4e4b\u200bzero","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u300a06_libusb\u200b\u7684\u200b\u4f7f\u7528\u200b\u300b</li> <li> <p>\u300a11.5_\u200b\u4ece\u200b\u6570\u636e\u4f20\u8f93\u200b\u7684\u200b\u89d2\u5ea6\u200b\u7406\u89e3\u200bGadget\u200b\u6846\u67b6\u200b\u300b</p> </li> <li> <p>\u200b\u5b9e\u9a8c\u200b\u4ee3\u7801\u200b\uff1aGIT\u200b\u4ed3\u5e93\u200b<code>source\\12_USB\\05_libusb_zero</code></p> </li> </ul>"},{"location":"12_USB/12_1/#1","title":"1. \u200b\u7f16\u5199\u7a0b\u5e8f","text":""},{"location":"12_USB/12_1/#11","title":"1.1 \u200b\u7f16\u7a0b\u200b\u601d\u8def","text":"<p>\u200b\u6d89\u53ca\u200b\u7684\u200b\u7a0b\u5e8f\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b\uff1a</p> <p></p> <p>\u200b\u57fa\u4e8e\u200blibusb\u200b\u7f16\u5199\u7a0b\u5e8f\u200b\uff1a</p> <ul> <li>\u200b\u627e\u5230\u200b\u8bbe\u5907\u200b</li> <li>\u200b\u9009\u62e9\u200b\u914d\u7f6e\u200b\uff1aloopback\u3001sourcesink</li> <li>\u200b\u5f97\u5230\u200b\u7aef\u70b9\u200b\uff1a\u200b\u627e\u5230\u200binterface\u200b\u8fdb\u800c\u200b\u5f97\u5230\u200bendpoint</li> <li>\u200b\u8bfb\u5199\u200b\u6570\u636e\u200b\uff1a\u200b\u64cd\u4f5c\u200bendpoint</li> </ul>"},{"location":"12_USB/12_1/#12-zero","title":"1.2 zero\u200b\u8bbe\u5907\u200b\u7684\u200b\u63cf\u8ff0\u7b26","text":"<p>\u200b\u5728\u200bUbuntu\u200b\u91cc\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b\uff1a</p> <pre><code>$ lsusb -v -d 0525:a4a0\n</code></pre> <p>\u200b\u53ef\u4ee5\u200b\u5217\u51fa\u200bzero\u200b\u8bbe\u5907\u200b\u7684\u200b\u63cf\u8ff0\u7b26\u200b\uff1a</p> <pre><code>Bus 001 Device 002: ID 0525:a4a0 Netchip Technology, Inc. Linux-USB \"Gadget Zero\"\nCouldn't open device, some information will be missing\nDevice Descriptor:\n  bLength                18\n  bDescriptorType         1\n  bcdUSB               2.00\n  bDeviceClass          255 Vendor Specific Class\n  bDeviceSubClass         0\n  bDeviceProtocol         0\n  bMaxPacketSize0        64\n  idVendor           0x0525 Netchip Technology, Inc.\n  idProduct          0xa4a0 Linux-USB \"Gadget Zero\"\n  bcdDevice            4.09\n  iManufacturer           1\n  iProduct                2\n  iSerial                 3\n  bNumConfigurations      2\n  Configuration Descriptor:\n    bLength                 9\n    bDescriptorType         2\n    wTotalLength           69\n    bNumInterfaces          1\n    bConfigurationValue     3\n    iConfiguration          4\n    bmAttributes         0xc0\n      Self Powered\n    MaxPower                2mA\n    Interface Descriptor:\n      bLength                 9\n      bDescriptorType         4\n      bInterfaceNumber        0\n      bAlternateSetting       0\n      bNumEndpoints           2\n      bInterfaceClass       255 Vendor Specific Class\n      bInterfaceSubClass      0\n      bInterfaceProtocol      0\n      iInterface              0\n      Endpoint Descriptor:\n        bLength                 7\n        bDescriptorType         5\n        bEndpointAddress     0x81  EP 1 IN\n        bmAttributes            2\n          Transfer Type            Bulk\n          Synch Type               None\n          Usage Type               Data\n        wMaxPacketSize     0x0200  1x 512 bytes\n        bInterval               0\n      Endpoint Descriptor:\n        bLength                 7\n        bDescriptorType         5\n        bEndpointAddress     0x01  EP 1 OUT\n        bmAttributes            2\n          Transfer Type            Bulk\n          Synch Type               None\n          Usage Type               Data\n        wMaxPacketSize     0x0200  1x 512 bytes\n        bInterval               0\n    Interface Descriptor:\n      bLength                 9\n      bDescriptorType         4\n      bInterfaceNumber        0\n      bAlternateSetting       1\n      bNumEndpoints           4\n      bInterfaceClass       255 Vendor Specific Class\n      bInterfaceSubClass      0\n      bInterfaceProtocol      0\n      iInterface              0\n      Endpoint Descriptor:\n        bLength                 7\n        bDescriptorType         5\n        bEndpointAddress     0x81  EP 1 IN\n        bmAttributes            2\n          Transfer Type            Bulk\n          Synch Type               None\n          Usage Type               Data\n        wMaxPacketSize     0x0200  1x 512 bytes\n        bInterval               0\n      Endpoint Descriptor:\n        bLength                 7\n        bDescriptorType         5\n        bEndpointAddress     0x01  EP 1 OUT\n        bmAttributes            2\n          Transfer Type            Bulk\n          Synch Type               None\n          Usage Type               Data\n        wMaxPacketSize     0x0200  1x 512 bytes\n        bInterval               0\n      Endpoint Descriptor:\n        bLength                 7\n        bDescriptorType         5\n        bEndpointAddress     0x82  EP 2 IN\n        bmAttributes            1\n          Transfer Type            Isochronous\n          Synch Type               None\n          Usage Type               Data\n        wMaxPacketSize     0x0400  1x 1024 bytes\n        bInterval               4\n      Endpoint Descriptor:\n        bLength                 7\n        bDescriptorType         5\n        bEndpointAddress     0x02  EP 2 OUT\n        bmAttributes            1\n          Transfer Type            Isochronous\n          Synch Type               None\n          Usage Type               Data\n        wMaxPacketSize     0x0400  1x 1024 bytes\n        bInterval               4\n  Configuration Descriptor:\n    bLength                 9\n    bDescriptorType         2\n    wTotalLength           32\n    bNumInterfaces          1\n    bConfigurationValue     2\n    iConfiguration          5\n    bmAttributes         0xc0\n      Self Powered\n    MaxPower                2mA\n    Interface Descriptor:\n      bLength                 9\n      bDescriptorType         4\n      bInterfaceNumber        0\n      bAlternateSetting       0\n      bNumEndpoints           2\n      bInterfaceClass       255 Vendor Specific Class\n      bInterfaceSubClass      0\n      bInterfaceProtocol      0\n      iInterface              6\n      Endpoint Descriptor:\n        bLength                 7\n        bDescriptorType         5\n        bEndpointAddress     0x81  EP 1 IN\n        bmAttributes            2\n          Transfer Type            Bulk\n          Synch Type               None\n          Usage Type               Data\n        wMaxPacketSize     0x0200  1x 512 bytes\n        bInterval               0\n      Endpoint Descriptor:\n        bLength                 7\n        bDescriptorType         5\n        bEndpointAddress     0x01  EP 1 OUT\n        bmAttributes            2\n          Transfer Type            Bulk\n          Synch Type               None\n          Usage Type               Data\n        wMaxPacketSize     0x0200  1x 512 bytes\n        bInterval               0\n</code></pre> <p>\u200b\u5b83\u200b\u6709\u200b2\u200b\u4e2a\u200b\u914d\u7f6e\u200b\uff1a</p> <ul> <li>\u200b\u7b2c\u200b1\u200b\u4e2a\u200b\u914d\u7f6e\u200b(bConfigurationValue = 2)\u200b\u5bf9\u5e94\u200bloopback\u200b\u529f\u80fd\u200b\uff1a\u200b\u91cc\u9762\u200b\u6709\u200b1\u200b\u4e2a\u200b\u63a5\u53e3\u200b\uff0c\u200b\u63a5\u53e3\u200b\u6709\u200b1\u200b\u4e2a\u200bsetting\uff0c\u200b\u4e0b\u9762\u200b\u6709\u200b2\u200b\u4e2a\u200bendpoint</li> <li>\u200b\u7b2c\u200b2\u200b\u4e2a\u200b\u914d\u7f6e\u200b(bConfigurationValue = 3)\u200b\u5bf9\u5e94\u200bSourceSink\u200b\u529f\u80fd\u200b\uff1a\u200b\u91cc\u9762\u200b\u6709\u200b1\u200b\u4e2a\u200b\u63a5\u53e3\u200b\uff0c\u200b\u63a5\u53e3\u200b\u6709\u200b2\u200b\u4e2a\u200bsetting</li> <li>\u200b\u7b2c\u200b1\u200b\u4e2a\u200bsetting\u200b\u4e0b\u9762\u200b\u6709\u200b2\u200b\u4e2a\u200bendpoint\uff1a\u200b\u90fd\u200b\u662f\u200bbulk\u200b\u7aef\u70b9\u200b</li> <li>\u200b\u7b2c\u200b2\u200b\u4e2a\u200bsetting\u200b\u4e0b\u9762\u200b\u6709\u200b4\u200b\u4e2a\u200bendpoint\uff1a2\u200b\u4e2a\u200b\u662f\u200bbulk\u200b\u7aef\u70b9\u200b\uff0c\u200b\u53e6\u5916\u200b2\u200b\u4e2a\u200b\u662f\u200bIsochronous\u200b\u7aef\u70b9\u200b</li> </ul>"},{"location":"12_USB/12_1/#13","title":"1.3 \u200b\u7f16\u7a0b","text":"<p>\u200b\u53c2\u8003\u200blibusb\u200b\u793a\u4f8b\u200b\uff1alibusb\\examples\\xusb.c</p>"},{"location":"12_USB/12_1/#2","title":"2. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<p>\u200b\u5b9e\u9a8c\u200b\u6b65\u9aa4\u200b\uff1a</p> <ul> <li> <p>\u200b\u5148\u200b\u5b89\u88c5\u200bg_zero\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff1a\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b<code>modprobe  g_zero</code></p> </li> <li> <p>\u200b\u7136\u540e\u200b\u8fde\u63a5\u200bOTG\u200b\u7ebf\u5230\u200bPC</p> </li> <li> <p>\u200b\u5728\u200bUbuntu\u200b\u4e2d\u200b\u8bc6\u522b\u200b\u51fa\u200b\u8bbe\u5907\u200b</p> </li> <li> <p>\u200b\u6267\u884c\u200b\u6d4b\u8bd5\u7a0b\u5e8f\u200b</p> </li> <li> <p>\u200b\u5148\u200b\u7f16\u8bd1\u200b\uff1a\u200b\u5728\u200bUbuntu\u200b\u91cc\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b</p> <pre><code>apt-cache search libusb  # \u200b\u67e5\u627e\u200blibusb\u200b\u5f00\u53d1\u5305\u200b\nsudo apt install libusb-1.0-0-dev  # \u200b\u5b89\u88c5\u200blibusb\u200b\u5f00\u53d1\u5305\u200b\ngcc -o zero_app zero_app.c -lusb-1.0  # \u200b\u7f16\u8bd1\u200b\n</code></pre> </li> <li> <p>\u200b\u6d4b\u8bd5\u200b\uff1a\u200b\u5728\u200bUbuntu\u200b\u91cc\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b</p> <pre><code>$ sudo ./zero_app -l    # \u200b\u5217\u51fa\u200b\u8bbe\u5907\u200b\u7684\u200b\u914d\u7f6e\u200b\u503c\u200b\nconfig 0: bConfigurationValue = 3\nconfig 1: bConfigurationValue = 2\n\n\n# \u200b\u6d4b\u8bd5\u200bloopback\u200b\u529f\u80fd\u200b\n$ sudo ./zero_app -s 2                  # \u200b\u9009\u62e9\u200bloopback\u200b\u7684\u200b\u914d\u7f6e\u200b\n$ sudo ./zero_app -wstr www.100ask.net  # \u200b\u5199\u5165\u200b\u5b57\u7b26\u4e32\u200b\ncurrent config: 2\nin_ep = 0x81, out_ep = 0x1\n$ sudo ./zero_app -rstr                # \u200b\u8bfb\u51fa\u200b\u5b57\u7b26\u4e32\u200b\ncurrent config: 2\nin_ep = 0x81, out_ep = 0x1\nRead string: www.100ask.net\n\n$ sudo ./zero_app -w 1 2 3 4 5 6 7 8   # \u200b\u5199\u5165\u200b8\u200b\u4e2a\u200b\u5b57\u8282\u200b\ncurrent config: 2\nin_ep = 0x81, out_ep = 0x1\nsudo ./zero_app -r                     # \u200b\u8bfb\u200b\u5230\u200b8\u200b\u4e2a\u200b\u5b57\u8282\u200b\ncurrent config: 2\nin_ep = 0x81, out_ep = 0x1\ntransferred != in_ep_maxlen\nRead datas:\n01 02 03 04 05 06 07 08\n\n\n#\u200b\u6d4b\u8bd5\u200bSource/Sink\u200b\u529f\u80fd\u200b\n$ sudo ./zero_app -s 3                   # \u200b\u9009\u62e9\u200bsource/sink\u200b\u7684\u200b\u914d\u7f6e\u200b         \nbook@100ask:~/nfs_rootfs/05_libusb_zero$ sudo ./zero_app -r  # \u200b\u8bfb\u6570\u636e\u200b\ncurrent config: 3\nin_ep = 0x81, out_ep = 0x1\nRead datas:\n00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\n00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\n00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\n00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\n\nsudo ./zero_app -w 0 0 0  # \u200b\u5199\u200b\u6570\u636e\u200b, \u200b\u53ea\u80fd\u200b\u5199\u5165\u200b0, \n                          # \u200b\u5199\u5165\u200b\u5176\u4ed6\u200b\u503c\u200b\u5c06\u200b\u4f1a\u200b\u5bfc\u81f4\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u7684\u200b\u9a71\u52a8\u200b\u8ba4\u4e3a\u200b\u662f\u200b\u9519\u8bef\u200b\u7136\u540e\u200bhalt out\u200b\u7aef\u70b9\u200b\n                          # \u200b\u7136\u540e\u200b\u53ea\u80fd\u200b\u91cd\u65b0\u200b\u6267\u884c\u200b \u201dsudo ./zero_app -s 3\u201c \u200b\u624d\u80fd\u200b\u6062\u590d\u200b\n</code></pre> </li> </ul>"},{"location":"12_USB/13_1/","title":"Gadget\u200b\u5e94\u7528\u200b\u5b9e\u4f8b\u200b\u4e4b\u200bserial","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>https://blog.csdn.net/embededswordman/article/details/6689593</li> <li>Linux\u200b\u6587\u6863\u200b\uff1aDocumentation\\usb\\gadget_serial.txt</li> <li>UART\u200b\u6559\u7a0b\u200b\uff1aGIT\u200b\u4ed3\u5e93\u200b<code>doc_and_source_for_drivers\\IMX6ULL\\doc_pic\\09_UART</code></li> <li>\u200b\u56de\u987e\u200bTTY\u200b\u7684\u200b\u6982\u5ff5\u200b</li> <li>\u200b\u56de\u987e\u200bconsole\u200b\u7684\u200b\u6982\u5ff5\u200b</li> </ul>"},{"location":"12_USB/13_1/#1","title":"1. \u200b\u786c\u4ef6\u200b\u4f53\u9a8c","text":"<p>\u200b\u4f7f\u7528\u200bUSB\u200b\u7ebf\u200b\u8fde\u63a5\u200b\u677f\u5b50\u200b\u7684\u200bOTG\u200b\u53e3\u200b\u548c\u200bPC\u200b\u7684\u200bUSB\u200b\u53e3\u200b\u3002</p> <p>\u200b\u7136\u540e\u200b\u5728\u200b\u677f\u5b50\u200b\u52a0\u8f7d\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u540e\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200b\u65b0\u200b\u7684\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b/dev/ttyGS0\uff1a</p> <pre><code># modprobe g_serial\ng_serial gadget: Gadget Serial v2.4\ng_serial gadget: g_serial ready\ng_serial gadget: high-speed config #2: CDC ACM config\n\n# ls /dev/ttyGS0 -l\ncrw-rw----    1 root     dialout   246,   0 Jan  1 00:30 /dev/ttyGS0\n</code></pre> <p>\u200b\u5728\u200bPC\u200b\u4e0a\u200b\uff0c\u200b\u5982\u679c\u200b\u662f\u200bWindows\u200b\u7cfb\u7edf\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5728\u200b\u8bbe\u5907\u200b\u7ba1\u7406\u5668\u200b\u91cc\u200b\u770b\u5230\u200b\u65b0\u200b\u7684\u200bUSB\u200b\u4e32\u53e3\u200b\uff1a</p> <p></p> <p>\u200b\u5728\u200bPC\u200b\u4e0a\u200b\uff0c\u200b\u5982\u679c\u200b\u662f\u200bVMware\u200b\u4e0a\u200b\u7684\u200bLinux\u200b\u7cfb\u7edf\u200b\uff0c\u200b\u6309\u200b\u4e0b\u56fe\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u5148\u200b\u628a\u200bUSB\u200b\u4e32\u53e3\u200b\u8fde\u63a5\u200b\u5230\u200bVMware\uff1a</p> <p></p> <p>\u200b\u7136\u540e\u200b\u5728\u200bPC Linux\u200b\u4e2d\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200b\u65b0\u200b\u7684\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\uff1a</p> <pre><code>book@100ask:~$ dmesg\n[  286.903239] usb 1-1: new high-speed USB device number 2 using ehci-pci\n[  287.254549] usb 1-1: New USB device found, idVendor=0525, idProduct=a4a7, bcdDevice= 4.09\n[  287.254550] usb 1-1: New USB device strings: Mfr=1, Product=2, SerialNumber=0\n[  287.254551] usb 1-1: Product: Gadget Serial v2.4\n[  287.254552] usb 1-1: Manufacturer: Linux 4.9.88 with 2184000.usb\n[  287.342786] cdc_acm 1-1:2.0: ttyACM0: USB ACM device\n[  287.343202] usbcore: registered new interface driver cdc_acm\n[  287.343202] cdc_acm: USB Abstract Control Model driver for USB modems and ISDN adapters\nbook@100ask:~$ ls /dev/ttyACM0 -l\ncrw-rw---- 1 root dialout 166, 0 Mar  5 22:38 /dev/ttyACM0\n</code></pre>"},{"location":"12_USB/13_1/#2-serial","title":"2. Serial\u200b\u5206\u6790","text":""},{"location":"12_USB/13_1/#21","title":"2.1 \u200b\u8f6f\u4ef6\u200b\u6846\u67b6","text":"<p>Gadget\u200b\u4e32\u53e3\u200b\u7684\u200b\u6846\u67b6\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>u_serial\u200b\u63d0\u4f9b\u200b\u4e86\u200b\u6709\u200b2\u200b\u79cd\u200b\u65b9\u6cd5\u200b\u6765\u200b\u4f7f\u7528\u200bGadget\u200b\u4e32\u53e3\u200b\uff1a</p> <ul> <li> <p>u_serial.c\u200b\u91cc\u200b\u6ce8\u518c\u200btty_driver\u200b\u7ed3\u6784\u200b\u4f53\u200bgs_tty_driver\uff0c\u200b\u5728\u200b\u677f\u5b50\u200b\u4e0a\u200b\u7f16\u5199\u200bAPP\u200b\u8bbf\u95ee\u200b\u8bbe\u5907\u200b/dev/ttyGS0\u200b\u5373\u53ef\u200b\u4e0e\u200bHost\u200b\u4ea4\u4e92\u200b(Host\u200b\u8981\u200b\u6253\u5f00\u200bUSB\u200b\u4e32\u53e3\u200b)   </p> </li> <li> <p>u_serial.c\u200b\u91cc\u200b\u6ce8\u518c\u200bconsole\u200b\u7ed3\u6784\u200b\u4f53\u200bgserial_cons\u3002\u200b\u542f\u52a8\u200bLinux\u200b\u5185\u6838\u200b\u65f6\u200b\u4f20\u5165\u200bcommandline\u200b\u53c2\u6570\u200b\"console=ttyGS0\"\u200b\u540e\u200b\uff0c\u200b\u5185\u6838\u200b\u7684\u200bprintk\u200b\u7684\u200b\u4fe1\u606f\u200b\u901a\u8fc7\u200bGadget\u200b\u4e32\u53e3\u200b\u6253\u5370\u200b\u51fa\u6765\u200b(Host\u200b\u8981\u200b\u6253\u5f00\u200bUSB\u200b\u4e32\u53e3\u200b)\uff1a</p> </li> </ul> <p></p> <p>\u200b\u6ce8\u518c\u200bTTY\u200b\u548c\u200bconsole\u200b\u7684\u200b\u8fc7\u7a0b\u200b\uff1a</p> <pre><code>gs_bind // drivers\\usb\\gadget\\legacy\\serial.c\n    status  = serial_register_ports(cdev, &amp;serial_config_driver,\n            \"acm\");\n\n                fi_serial[i] = usb_get_function_instance(f_name);\n\n\nacm_alloc_instance // drivers\\usb\\gadget\\function\\f_acm.c\n    ret = gserial_alloc_line(&amp;opts-&gt;port_num); // drivers\\usb\\gadget\\function\\u_serial.c\n\n            // \u200b\u6ce8\u518c\u200bTTY\n            tty_dev = tty_port_register_device(&amp;ports[port_num].port-&gt;port,\n                    gs_tty_driver, port_num, NULL);\n\n            // \u200b\u6ce8\u518c\u200bconsole\n            gserial_console_init();\n                register_console(&amp;gserial_cons);\n</code></pre>"},{"location":"12_USB/13_1/#22","title":"2.2 \u200b\u6570\u636e\u4f20\u8f93","text":""},{"location":"12_USB/13_1/#221-app","title":"2.2.1 APP\u200b\u8bbf\u95ee","text":"<p>\u200b\u6ce8\u610f\u200b\uff0c\u200b\u5728\u200bUSB\u200b\u4e2d\u200b\u6570\u636e\u4f20\u8f93\u200b\u603b\u662f\u200b\u7531\u200bHost\u200b\u53d1\u8d77\u200b\uff0c\u200b\u6240\u4ee5\u200b\uff1a</p> <ul> <li>\u200b\u677f\u5b50\u200b\u8981\u200b\u4e8b\u5148\u200b\u51c6\u5907\u200b\u597d\u200b\u7a7a\u95f4\u200b(\u200b\u8bbe\u7f6e\u200b\u597d\u200bout\u200b\u65b9\u5411\u200b\u7684\u200busb_request\u200b\u5e76\u200b\u653e\u5165\u200b\u961f\u5217\u200b)\uff0c\u200b\u4ee5\u4fbf\u200b\u63a5\u6536\u200bHost\u200b\u53d1\u6765\u200b\u7684\u200b\u6570\u636e\u200b\uff1b</li> <li>\u200b\u677f\u5b50\u200b\u6709\u200b\u6570\u636e\u200b\u60f3\u200b\u53d1\u9001\u7ed9\u200bHost\u200b\u65f6\u200b\u9700\u8981\u200b\u8bbe\u7f6e\u200bin\u200b\u65b9\u5411\u200b\u7684\u200busb_request\uff0c\u200b\u4ee5\u4fbf\u200bHost\u200b\u8bfb\u53d6\u200b\u3002</li> </ul> <p>\u200b\u677f\u5b50\u200b\u4e0a\u200b\u7684\u200bAPP\u200b\u8bbf\u95ee\u200b/dev/ttyGS0\u200b\u65f6\u200b\uff0c\u200b\u5c31\u200b\u4f1a\u200b\u5bfc\u81f4\u200bgs_tty_ops\u200b\u7ed3\u6784\u200b\u4f53\u200b\u7684\u200b\u5bf9\u5e94\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b\uff1a</p> <p></p> <p>APP\u200b\u8c03\u7528\u200bopen\u200b\u51fd\u6570\u200b\u65f6\u200b\uff0c\u200b\u4f1a\u200b\u5bfc\u81f4\u200b\u5982\u4e0b\u200b\u8c03\u7528\u200b\uff1a</p> <pre><code>gs_open\n    gs_start_io(port);\n        // \u200b\u53d6\u51fa\u200bout\u200b\u7aef\u70b9\u200b(\u200b\u5bf9\u5e94\u200bHost\u200b\u6765\u8bf4\u200b\u662f\u200bout, \u200b\u5bf9\u4e8e\u200b\u677f\u5b50\u200b\u6765\u8bf4\u200b\u5c31\u662f\u200b\u8f93\u5165\u200b)\n        struct usb_ep       *ep = port-&gt;port_usb-&gt;out;\n\n        // \u200b\u7ed9\u200bout\u200b\u7aef\u70b9\u200b\u5206\u914d\u200busb_request\n        status = gs_alloc_requests(ep, head, gs_read_complete,\n            &amp;port-&gt;read_allocated);\n\n        // \u200b\u7ed9\u200bin\u200b\u7aef\u70b9\u200b\u5206\u914d\u200busb_request, \u200b\u4f46\u662f\u200b\u5728\u200bopen\u200b\u65f6\u200b\u5e76\u200b\u6ca1\u6709\u200b\u628a\u200bin\u200b\u65b9\u5411\u200b\u7684\u200busb_request\u200b\u653e\u5165\u200b\u961f\u5217\u200b\n        status = gs_alloc_requests(port-&gt;port_usb-&gt;in, &amp;port-&gt;write_pool,\n                gs_write_complete, &amp;port-&gt;write_allocated);\n\n        // \u200b\u628a\u200busb_request\u200b\u653e\u5165\u200b\u961f\u5217\u200b, \u200b\u5982\u679c\u200bHost\u200b\u53d1\u6765\u200b\u6570\u636e\u200b, \u200b\u8fd9\u4e2a\u200busb_request\u200b\u7684\u200bcomplete\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b\n        started = gs_start_rx(port);\n                    status = usb_ep_queue(out, req, GFP_ATOMIC);\n</code></pre> <p>APP\u200b\u8c03\u7528\u200bwrite\u200b\u51fd\u6570\u200b\u65f6\u200b\uff0c\u200b\u4f1a\u200b\u5bfc\u81f4\u200b\u5982\u4e0b\u200b\u8c03\u7528\u200b\uff1a</p> <pre><code>gs_write\n    gs_start_tx(port);\n        // \u200b\u628a\u200busb_request\u200b\u653e\u5165\u200b\u961f\u5217\u200b, Host\u200b\u8bfb\u53d6\u6570\u636e\u200b\u65f6\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u4ece\u4e2d\u200b\u5f97\u5230\u200b\u6570\u636e\u200b\n        status = usb_ep_queue(in, req, GFP_ATOMIC);\n</code></pre>"},{"location":"12_USB/13_1/#222-printk","title":"2.2.2 printk","text":"<p>\u200b\u542f\u52a8\u200bLinux\u200b\u5185\u6838\u200b\u65f6\u200b\u4f20\u5165\u200bcommandline\u200b\u53c2\u6570\u200b\"console=ttyGS0\"\u200b\u540e\u200b\uff0c\u200b\u5185\u6838\u200b\u7684\u200bprintk\u200b\u7684\u200b\u4fe1\u606f\u200b\u901a\u8fc7\u200bGadget\u200b\u4e32\u53e3\u200b\u6253\u5370\u200b\u51fa\u6765\u200b(Host\u200b\u8981\u200b\u6253\u5f00\u200bUSB\u200b\u4e32\u53e3\u200b)\u3002</p> <p>\u200b\u5185\u6838\u200b\u7684\u200bprintk\u200b\u51fd\u6570\u200b\u4f1a\u200b\u5bfc\u81f4\u200bgserial_cons\u200b\u7ed3\u6784\u200b\u4f53\u4e2d\u200b\u7684\u200bwrite\u200b\u6307\u9488\u200b\u5373\u200b<code>gs_console_write</code>\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b\uff1a</p> <p></p> <p>gs_console_write\u200b\u51fd\u6570\u200b\u7684\u200b\u8c03\u7528\u200b\u5173\u7cfb\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>gs_console_write\n    // \u200b\u628a\u200b\u8981\u200b\u6253\u5370\u200b\u7684\u200b\u6570\u636e\u200b\u653e\u5165\u200b\u73af\u5f62\u200bbuffer\n    gs_buf_put(&amp;info-&gt;con_buf, buf, count);\n\n    // \u200b\u5524\u9192\u200b\u5185\u6838\u200b\u7ebf\u7a0b\u200b\n    wake_up_process(info-&gt;console_thread);\n\n// \u200b\u5185\u6838\u200b\u7ebf\u7a0b\u200b\ngs_console_thread\n    // \u200b\u88ab\u200b\u5524\u9192\u200b\u540e\u200b\n\n    // \u200b\u53d6\u51fa\u200b\u8f93\u5165\u200b\u7aef\u70b9\u200b\u548c\u200b\u5b83\u200b\u7684\u200busb_request\n    req = info-&gt;console_req;\n    ep = port-&gt;port_usb-&gt;in;\n\n    // \u200b\u4ece\u200b\u73af\u5f62\u200bbuffer\u200b\u5f97\u5230\u200b\u6570\u636e\u200b\u3001\u200b\u8bbe\u7f6e\u200busb_request\n    xfer = gs_buf_get(&amp;info-&gt;con_buf, req-&gt;buf, size);\n    req-&gt;length = xfer;\n\n    // \u200b\u628a\u200busb_request\u200b\u653e\u5165\u200b\u961f\u5217\u200b\uff0c\u200b\u4ee5\u4fbf\u200bHost\u200b\u8bfb\u53d6\u200b\n    ret = usb_ep_queue(ep, req, GFP_ATOMIC);\n</code></pre>"},{"location":"12_USB/13_1/#3","title":"3. \u200b\u7f16\u7a0b","text":"<p>PC: open/read/write  /dev/ttyACM0</p> <p>\u200b\u677f\u5b50\u200b: open/read/write  /dev/ttyGS0</p> <p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1ahttps://stackoverflow.com/questions/7469139/what-is-the-equivalent-to-getch-getche-in-linux</p> <p>\u200b\u6e90\u7801\u200b\uff1a</p> <p></p>"},{"location":"12_USB/13_1/#4","title":"4. \u200b\u4e0a\u673a\u200b\u5b9e\u9a8c","text":"<p>\u200b\u7f16\u8bd1\u200b2\u200b\u4e2a\u200b\u7248\u672c\u200b\uff1aPC\u3001ARM</p> <pre><code>gcc -o serial_send_recv_pc serial_send_recv.c -lpthread\narm-buildroot-linux-gnueabihf-gcc -o serial_send_recv_arm serial_send_recv.c -lpthread\n</code></pre> <p>\u200b\u4f7f\u7528\u200bUSB\u200b\u7ebf\u200b\u8fde\u63a5\u200b\u677f\u5b50\u200b\u7684\u200bOTG\u200b\u53e3\u200b\u3001PC\u200b\u7684\u200bUSB\u200b\u53e3\u200b\uff0cPC\u200b\u4e0a\u200b\u76d1\u6d4b\u200b\u5230\u200bUSB\u200b\u4e32\u53e3\u200b\u540e\u200b\u628a\u200b\u5b83\u200b\u8fde\u63a5\u200b\u5230\u200bVMWare\uff0c\u200b\u786e\u5b9a\u200b\uff1a</p> <ul> <li>\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6709\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\uff1a/dev/ttyGS0</li> <li>Ubuntu\u200b\u4e0a\u200b\u6709\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\uff1a/dev/ttyACM0</li> </ul> <p>\u200b\u6d4b\u8bd5\u200b\uff1a</p> <ul> <li>\u200b\u5728\u200bUbuntu\u200b\u4e0a\u200b\u6267\u884c\u200b\uff1a<code>sudo  ./serial_send_recv_pc  /dev/ttyACM0</code></li> <li>\u200b\u5728\u200b\u677f\u5b50\u200b\u4e0a\u200b\u6267\u884c\u200b\uff1a<code>sudo  ./serial_send_recv_arm  /dev/ttyGS0</code></li> <li>\u200b\u53cc\u65b9\u200b\u5373\u53ef\u200b\u4e92\u53d1\u200b\u6570\u636e\u200b</li> </ul>"},{"location":"12_USB/14_1/","title":"configfs\u200b\u7684\u200b\u4f7f\u7528\u200b\u4e0e\u200b\u5185\u90e8\u200b\u673a\u5236","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u200b\u5185\u6838\u200b\u6587\u6863\u200b\uff1a</li> <li>Documentation\\filesystems\\configfs\\configfs.txt</li> <li>Documentation\\usb\\gadget_configfs.txt</li> </ul>"},{"location":"12_USB/14_1/#1","title":"1. \u200b\u4f53\u9a8c","text":""},{"location":"12_USB/14_1/#11","title":"1.1 \u200b\u4f7f\u7528","text":"<p>\u200b\u6240\u6709\u200b\u547d\u4ee4\u200b\u90fd\u200b\u662f\u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u6267\u884c\u200b\u3002</p> <ul> <li>\u200b\u6302\u8f7d\u200bconfigfs\u200b\u6587\u4ef6\u7cfb\u7edf\u200b</li> </ul> <pre><code># modprobe libcomposite\n# mount -t configfs none /sys/kernel/config\n# ls /sys/kernel/config/\nusb_gadget\n\n#ls /sys/kernel/config/usb_gadget  // \u200b\u4e00\u200b\u5f00\u59cb\u200b\u5b83\u200b\u662f\u200b\u7a7a\u76ee\u5f55\u200b\n</code></pre> <ul> <li>\u200b\u521b\u5efa\u200b\u76ee\u5f55\u200b</li> </ul> <pre><code># cd /sys/kernel/config/usb_gadget\n# mkdir test_serial\n# ls test_serial/ -l\ntotal 0\n-rw-r--r--    1 root     root          4096 Jan  1 03:20 UDC\n-rw-r--r--    1 root     root          4096 Jan  1 03:20 bDeviceClass\n-rw-r--r--    1 root     root          4096 Jan  1 03:20 bDeviceProtocol\n-rw-r--r--    1 root     root          4096 Jan  1 03:20 bDeviceSubClass\n-rw-r--r--    1 root     root          4096 Jan  1 03:20 bMaxPacketSize0\n-rw-r--r--    1 root     root          4096 Jan  1 03:20 bcdDevice\n-rw-r--r--    1 root     root          4096 Jan  1 03:20 bcdUSB\ndrwxr-xr-x    2 root     root             0 Jan  1 01:49 configs\ndrwxr-xr-x    2 root     root             0 Jan  1 01:49 functions\n-rw-r--r--    1 root     root          4096 Jan  1 03:20 idProduct\n-rw-r--r--    1 root     root          4096 Jan  1 03:20 idVendor\ndrwxr-xr-x    2 root     root             0 Jan  1 01:49 os_desc\ndrwxr-xr-x    2 root     root             0 Jan  1 01:49 strings\n</code></pre> <p>\u200b\u521b\u5efa\u200b\u76ee\u5f55\u200b\u540e\u200b\uff0c\u200b\u91cc\u9762\u200b\u5c31\u200b\u81ea\u52a8\u200b\u751f\u6210\u200b\u4e86\u200b\u5f88\u591a\u200b\u6587\u4ef6\u200b\u3001\u200b\u76ee\u5f55\u200b\uff0c\u200b\u6bd4\u5982\u200b\uff1a</p> <ul> <li>idVendor\uff1a\u200b\u8868\u793a\u200b\u5382\u5bb6\u200bID\uff0c\u200b\u9ed8\u8ba4\u503c\u200b\u662f\u200b0</li> <li> <p>idProduct\uff1a\u200b\u8868\u793a\u200b\u4ea7\u54c1\u200bID\uff0c\u200b\u9ed8\u8ba4\u503c\u200b\u662f\u200b0</p> </li> <li> <p>\u200b\u8bbe\u7f6e\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b\uff0c\u200b\u6bd4\u5982\u200b\u8bbe\u7f6e\u200b\u5382\u5bb6\u200bID\u3001\u200b\u4ea7\u54c1\u200bID\uff0c\u200b\u8fd9\u662f\u200b\u53ef\u9009\u200b\u7684\u200b</p> </li> </ul> <pre><code>echo \"0x1234\" &gt; idVendor\necho \"0x5678\" &gt; idProduct\n</code></pre> <ul> <li>\u200b\u521b\u5efa\u200b\u914d\u7f6e\u200b\uff1a\u200b\u683c\u5f0f\u200b\u4e3a\u200b\"configs/.\"\uff0cname\u200b\u53ef\u4ee5\u200b\u53d6\u200b\u4efb\u610f\u200b\u5b57\u7b26\u200b\uff0cnumber\u200b\u662f\u200b\u914d\u7f6e\u200b\u7f16\u53f7\u200b</li> </ul> <pre><code>mkdir configs/c.1\n</code></pre> <ul> <li>\u200b\u521b\u5efa\u200b\u529f\u80fd\u200b(function\u3001\u200b\u63a5\u53e3\u200b)\uff1a\u200b\u683c\u5f0f\u200b\u4e3a\u200b\"functions/.\"\uff0cname\u200b\u5bf9\u5e94\u200bfunction\u200b\u7684\u200b\u540d\u5b57\u200b\uff0c\u200b\u6bd4\u5982\u200bacm\u200b\u5bf9\u5e94\u200bACM\u200b\u529f\u80fd\u200b\uff0c\u200b\u5bf9\u5e94\u200b\u7684\u200b\u9a71\u52a8\u200b\u4e3a\u200busb_f_acm.ko\uff1binstance name\u200b\u53ef\u4ee5\u200b\u53d6\u200b\u4efb\u610f\u200b\u5b57\u7b26\u200b</li> </ul> <pre><code>mkdir functions/acm.test1\n</code></pre> <ul> <li>\u200b\u628a\u200b\u914d\u7f6e\u200b\u548c\u200b\u529f\u80fd\u200b\u8054\u7cfb\u200b\u8d77\u6765\u200b\uff1aln -s functions/. configs/.</li> </ul> <pre><code>ln -s functions/acm.test1  configs/c.1/\n</code></pre> <ul> <li>\u200b\u4f7f\u80fd\u200bGadget(\u200b\u786e\u5b9a\u200b\u4f7f\u7528\u200b\u54ea\u4e2a\u200bUSB Device Controller)\uff1aecho  &gt; UDC   \u200b\u53ef\u7528\u200b\u7684\u200bUDC\uff0c\u200b\u53ef\u4ee5\u200b\u5728\u200b/sys/class/udc/*\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u67e5\u770b\u200b</li> </ul> <pre><code>echo ci_hdrc.0 &gt; UDC\n</code></pre>"},{"location":"12_USB/14_1/#12","title":"1.2 \u200b\u6e05\u9664","text":"<ul> <li>\u200b\u7981\u6b62\u200bGadget</li> </ul> <pre><code>echo \"\" &gt; UDC\n</code></pre> <ul> <li>\u200b\u79fb\u9664\u200b\u914d\u7f6e\u200b\u91cc\u200b\u7684\u200b\u529f\u80fd\u200b(Remove functions from configurations)\uff1a   \u200b\u547d\u4ee4\u200b\uff1arm configs/./</li> </ul> <pre><code>rm  configs/c.1/acm.test1\n</code></pre> <ul> <li>\u200b\u79fb\u9664\u200b\u914d\u7f6e\u200b\uff1armdir configs/.</li> </ul> <pre><code>rmdir configs/c.1\n</code></pre> <ul> <li>\u200b\u79fb\u9664\u200b\u529f\u80fd\u200b\uff1armdir functions/.</li> </ul> <pre><code>rmdir functions/acm.test1\n</code></pre> <ul> <li>\u200b\u79fb\u9664\u200bGadget</li> </ul> <pre><code>rmdir test_serial\n</code></pre>"},{"location":"12_USB/14_1/#13-stm32mp157","title":"1.3 STM32MP157\u200b\u4e0a\u200b\u7684\u200b\u5b9e\u9a8c","text":"<p>\u200b\u56e0\u4e3a\u200bSTM32MP157\u200b\u7cfb\u7edf\u200b\u91cc\u200b\u5df2\u7ecf\u200b\u4f7f\u7528\u200b\u7684\u200badb\u200b\u8bbe\u5907\u200b\uff0c\u200b\u8981\u200b\u60f3\u200b\u6a21\u62df\u200b\u4e32\u53e3\u200b\u8bbe\u5907\u200b\uff0c\u200b\u9700\u8981\u200b\u5148\u200b\u6e05\u9664\u200badb\uff0c\u200b\u547d\u4ee4\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>cd /sys/kernel/config/usb_gadget/g1\necho \"\" &gt; UDC\nrm configs/b.1/ffs.adb\nrmdir configs/b.1/strings/0x409\nrmdir configs/b.1\nrmdir functions/ffs.adb\nrm strings/0x409\ncd ..\nrmdir g1\n</code></pre> <p>\u200b\u6e05\u9664\u200b\u540e\u200b\uff0c\u200b\u5c31\u200b\u6309\u7167\u200b\u300a1.1 \u200b\u4f7f\u7528\u200b\u300b\u200b\u6765\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u9700\u8981\u200b\u6ce8\u610f\u200b\u7684\u200b\u662f\u200b\u6700\u540e\u200b\u4e00\u6b65\u200b\uff1a</p> <pre><code>ls  /sys/class/udc/\n49000000.usb-otg\n\necho 49000000.usb-otg &gt; UDC\n</code></pre>"},{"location":"12_USB/14_1/#2","title":"2. \u200b\u5185\u90e8\u200b\u673a\u5236","text":""},{"location":"12_USB/14_1/#21-configfssysfs","title":"2.1 configfs\u200b\u548c\u200bsysfs","text":"<p>configfs\u200b\u548c\u200bsysfs\u200b\u90fd\u200b\u662f\u200b\u57fa\u4e8e\u200b\u5185\u5b58\u200b\u7684\u200b\u865a\u62df\u200b\u6587\u4ef6\u7cfb\u7edf\u200b\uff0c\u200b\u4f46\u662f\u200b\u5b83\u4eec\u200b\u5e76\u4e0d\u76f8\u540c\u200b\u3002</p> <p>\u200b\u5bf9\u4e8e\u200bsysfs\uff0c\u200b\u5f53\u200b\u5185\u6838\u200b\u521b\u5efa\u200b\u67d0\u4e2a\u200b\u5bf9\u8c61\u200b\u65f6\u200b\uff0c\u200b\u6bd4\u5982\u200b\u6ce8\u518c\u200b\u4e00\u4e2a\u200bplatform_drvier\u200b\u65f6\u200b\uff0c\u200b\u5b83\u200b\u5c31\u200b\u4f1a\u200b\u88ab\u200b\u6ce8\u518c\u200b\u8fdb\u200bsysfs\u200b\u91cc\u200b\u3002\u200b\u5b83\u200b\u7684\u200b\u5c5e\u6027\u200b\u5c31\u200b\u4f1a\u200b\u5728\u200bsysfs\u200b\u4e2d\u200b\u51fa\u73b0\u200b\uff1a\u200b\u7528\u6237\u7a0b\u5e8f\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200breaddir\u3001read\u200b\u51fd\u6570\u200b\u8bfb\u53d6\u200b\u8fd9\u4e9b\u200b\u5c5e\u6027\u200b\uff0c\u200b\u53c8\u200b\u662f\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200bwrite\u200b\u51fd\u6570\u200b\u4fee\u6539\u200b\u67d0\u4e9b\u200b\u5c5e\u6027\u200b\u3002\u200b\u91cd\u70b9\u200b\u5728\u4e8e\u200b\uff1asysfs\u200b\u4e2d\u200b\u7684\u200b\u5185\u5bb9\u200b\u662f\u200b\u5728\u200b\u5185\u6838\u200b\u91cc\u200b\u521b\u5efa\u200b\u3001\u200b\u9500\u6bc1\u200b\uff0c\u200b\u5185\u6838\u200b\u63a7\u5236\u200b\u7740\u200bsysfs\u200b\u7684\u200b\u751f\u547d\u5468\u671f\u200b\u3002\u200b\u53ef\u4ee5\u200b\u8ba4\u4e3a\u200bsysfs\u200b\u5c31\u662f\u200b\u8fd9\u4e9b\u200b\u5185\u6838\u200b\u5bf9\u8c61\u200b\u7684\u200b\u89c2\u5bdf\u200b\u7a97\u53e3\u200b\u3002</p> <p>\u200b\u5bf9\u4e8e\u200bconfigfs\uff0c\u200b\u5f53\u7136\u200b\u4e5f\u200b\u9700\u8981\u200b\u5185\u6838\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u7684\u200b\u652f\u6491\u200b\u3002\u200b\u4f46\u662f\u200b\u64cd\u4f5c\u200bconfigfs\u200b\u7684\u200b\u542f\u52a8\u200b\u65f6\u200b\u7528\u6237\u7a0b\u5e8f\u200b\uff1a\u200b\u7528\u6237\u200b\u6267\u884c\u200bmkdir\u200b\u65f6\u4f1a\u200b\u5728\u200b\u5185\u6838\u200b\u91cc\u200b\u521b\u5efa\u200b\u4e00\u4e2a\u200bconfig_item\u200b\u5bf9\u8c61\u200b\uff0c\u200b\u7528\u6237\u200b\u6267\u884c\u200brmdir\u200b\u65f6\u4f1a\u200b\u9500\u6bc1\u200b\u8fd9\u4e2a\u200b\u5185\u6838\u200b\u5bf9\u8c61\u200b\u3002\u200b\u5f53\u200b\u6267\u884c\u200bmkdir\u200b\u521b\u5efa\u200b\u76ee\u5f55\u200b\u65f6\u200b\uff0c\u200b\u8fd9\u4e2a\u200bconfig_item\u200b\u7684\u200b\u5c5e\u6027\u200b\u5c31\u200b\u4f1a\u200b\u51fa\u73b0\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u3002\u200b\u7528\u6237\u7a0b\u5e8f\u200b\u53ef\u4ee5\u200b\u6267\u884c\u200bread\u3001write\u200b\u64cd\u4f5c\u200b\u8bfb\u5199\u200b\u8fd9\u4e9b\u200b\u5c5e\u6027\u200b\u3002\u200b\u4e0e\u200bsysfs\u200b\u7684\u200b\u4e0d\u540c\u200b\u5728\u4e8e\u200b\uff1aconfigfs\u200b\u4e2d\u200b\u76ee\u5f55\u200b\u3001\u200b\u6587\u4ef6\u200b\u7684\u200b\u751f\u547d\u5468\u671f\u200b\u7531\u200b\u7528\u6237\u7a0b\u5e8f\u200b\u51b3\u5b9a\u200b\u3002</p>"},{"location":"12_USB/14_1/#22","title":"2.2 \u200b\u91cd\u8981\u200b\u7ed3\u6784\u200b\u4f53","text":"<p>\u200b\u6302\u8f7d\u200bconfigfs\u200b\u6587\u4ef6\u7cfb\u7edf\u200b\u540e\u200b\uff0c\u200b\u5728\u200b\u91cc\u9762\u200b\u521b\u5efa\u200b/\u200b\u5220\u9664\u200b\u76ee\u5f55\u200b\u3001\u200b\u8bfb\u5199\u200b\u6587\u4ef6\u200b\u3001\u200b\u5efa\u7acb\u200b\u94fe\u63a5\u200b\u6587\u4ef6\u200b\uff0c\u200b\u90fd\u200b\u4f1a\u200b\u5bfc\u81f4\u200b\u5185\u6838\u200b\u4e2d\u200b\u76f8\u5173\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b\u3002</p> <p>\u200b\u7ad9\u200b\u5728\u200b\u7528\u6237\u200b\u7684\u200b\u89d2\u5ea6\u200b\u6765\u8bf4\u200b\uff0c\u200b\u4e00\u4e2a\u200b\u6587\u4ef6\u7cfb\u7edf\u200b\u91cc\u9762\u200b\u6709\u200b\u76ee\u5f55\u200b\u3001\u200b\u6587\u4ef6\u200b\u4e24\u79cd\u200b\u5bf9\u8c61\u200b\u3002\u200b\u5728\u200bconfigfs\u200b\u7684\u200b\u5185\u6838\u200b\u5b9e\u73b0\u200b\u4e2d\u200b\uff0c\u200b\u5bf9\u5e94\u200b4\u200b\u4e2a\u200b\u6982\u5ff5\u200b\u3002\u200b\u4ece\u5e95\u200b\u5f80\u200b\u4e0a\u200b\u770b\u200b\uff1a</p> <ul> <li> <p>configfs_attribute\u3001configfs_bin_attribute\uff1a\u200b\u5bf9\u5e94\u200b\u6587\u4ef6\u200b</p> </li> <li> <p>configfs_attribute\u200b\u5bf9\u5e94\u200b\u7684\u200b\u6587\u4ef6\u200b\u91cc\u200b\u542b\u6709\u200b\u7684\u200b\u662f\u200b\u53ef\u89c6\u5316\u200b\u7684\u200b\u5b57\u7b26\u4e32\u200b\u4fe1\u606f\u200b\uff0c\u200b\u5b83\u200b\u5728\u200b\u5185\u6838\u200b\u91cc\u200b\u6709\u200b\u4e00\u4e2a\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff1a</p> <pre><code>    struct configfs_attribute {\n        char                    *ca_name;\n        struct module           *ca_owner;\n        umode_t                  ca_mode;\n        ssize_t (*show)(struct config_item *, char *);\n        ssize_t (*store)(struct config_item *, const char *, size_t);\n    };\n</code></pre> </li> <li> <p>configfs_bin_attribute\u200b\u5bf9\u5e94\u200b\u7684\u200b\u6587\u4ef6\u200b\u91cc\u200b\u542b\u6709\u200b\u7684\u200b\u662f\u200b\u4e8c\u8fdb\u5236\u200b\u4fe1\u606f\u200b\uff0c\u200b\u5b83\u200b\u5728\u200b\u5185\u6838\u200b\u91cc\u200b\u6709\u200b\u4e00\u4e2a\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff1a</p> <pre><code>struct configfs_bin_attribute {\n    struct configfs_attribute cb_attr;  /* std. attribute */\n    void *cb_private;           /* for user       */\n    size_t cb_max_size;         /* max core size  */\n    ssize_t (*read)(struct config_item *, void *, size_t);\n    ssize_t (*write)(struct config_item *, const void *, size_t);\n};\n</code></pre> </li> <li> <p>\u200b\u8bfb\u5199\u200b\u6587\u4ef6\u200b\u65f6\u200b\uff0c\u200b\u4f1a\u200b\u5bfc\u81f4\u200b\u4e0a\u8ff0\u200b\u7ed3\u6784\u200b\u4f53\u91cc\u200b\u7684\u200bshow/store\u200b\u6216\u8005\u200bread/write\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b</p> </li> <li> <p>\u200b\u6587\u4ef6\u200b\u662f\u200b\u4f4d\u4e8e\u200b\u67d0\u4e2a\u200b\u76ee\u5f55\u200b\u7684\u200b: config_item</p> </li> <li> <p>config_item\uff1aconfigfs\u200b\u4e2d\u200b\u7684\u200b\u6bcf\u4e2a\u200b\u5bf9\u8c61\u200b\u90fd\u200b\u662f\u200bconfig_item\uff0c\u200b\u540e\u9762\u200b\u7684\u200bconfig_group\u3001subsystem\u200b\u672c\u8d28\u200b\u4e0a\u200b\u90fd\u200b\u5c5e\u4e8e\u200b\u7279\u6b8a\u200b\u7684\u200bconfig_item</p> </li> <li> <p>config_group\u3001subsystem\uff0cconfig_item\u200b\u90fd\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200b\u76ee\u5f55\u200b</p> </li> <li> <p>\u200b\u8ddf\u200bconfig_group\u3001subsystem\u200b\u5bf9\u6bd4\u200b\u65f6\u200b\uff0cconfig_item\u200b\u8fd9\u4e2a\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u4e0d\u518d\u200b\u6709\u200b\u76ee\u5f55\u200b</p> </li> <li> <p>\u200b\u5728\u200bconfig_item\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u6709\u200b\u5c5e\u6027\u200b\u6587\u4ef6\u200b\uff0c\u200b\u8fd8\u200b\u53ef\u4ee5\u200b\u521b\u5efa\u200b\u94fe\u63a5\u200b\u6587\u4ef6\u200b</p> </li> <li> <p>\u200b\u94fe\u63a5\u200b\u6587\u4ef6\u200b\u7684\u200b\u64cd\u4f5c\u200b\u7ed3\u6784\u200b\u4f53\u662f\u200b\uff1aconfig_item_type\u200b\u91cc\u200b\u7684\u200bconfigs_item_operations</p> <p></p> </li> <li> <p>config_group\uff1a\u200b\u5b83\u200b\u662f\u200b\u7279\u6b8a\u200b\u7684\u200bconfig_item\uff0c\u200b\u5b83\u200b\u6709\u200b\u5bf9\u5e94\u200b\u4e00\u4e2a\u200b\u76ee\u5f55\u200b</p> </li> <li> <p>\u200b\u666e\u901a\u200b\u7684\u200bconfig_item\uff1a\u200b\u4e0b\u9762\u200b\u4e0d\u518d\u200b\u6709\u200b\u5b50\u76ee\u5f55\u200b</p> </li> <li>config_group\uff1a\u200b\u4e0b\u9762\u200b\u8fd8\u200b\u53ef\u4ee5\u200b\u521b\u5efa\u200bconfig_item\u200b\u6216\u8005\u200bconfig_group\uff0c\u200b\u5373\u200b\uff1a\u200b\u4e0b\u9762\u200b\u53ef\u4ee5\u200b\u518d\u200b\u521b\u5efa\u200b\u5b50\u76ee\u5f55\u200b</li> <li> <p>\u200b\u5728\u200b\u5f53\u524d\u76ee\u5f55\u200b\u4e0b\u200b\u64cd\u4f5c\u200b\u5b50\u76ee\u5f55\u200b\u65f6\u200b\uff0c\u200b\u5bf9\u5e94\u200b\u7684\u200b\u64cd\u4f5c\u200b\u7ed3\u6784\u200b\u4f53\u662f\u200b\uff1aconfig_item_type\u200b\u91cc\u200b\u7684\u200bconfigs_group_operations     </p> </li> <li> <p>subsystem\uff1a\u200b\u5b83\u200b\u662f\u200bconfigfs\u200b\u6587\u4ef6\u200b\u7cfb\u4e2d\u200b\u7684\u200b\u6700\u200b\u9876\u5c42\u200b</p> </li> <li> <p>\u200b\u6bd4\u5982\u200b\uff1a<code>/sys/kernel/config/usb_gadget</code>\u3001<code>/sys/kernel/config/iio</code></p> </li> <li>\u200b\u5728\u200b<code>drivers\\usb\\gadget\\configfs.c</code>\u200b\u4e2d\u200b\u8c03\u7528\u200b<code>configfs_register_subsystem(&amp;gadget_subsys)</code>\u200b\u5c31\u200b\u4f1a\u200b\u521b\u5efa\u200bsubsystem\uff0c\u200b\u5b83\u200b\u5bf9\u5e94\u200bconfigfs\u200b\u6587\u4ef6\u7cfb\u7edf\u200b\u4e2d\u200b\u7684\u200b\u9876\u5c42\u200b\u76ee\u5f55\u200b<code>usb_gadget</code></li> <li>subsystem\u200b\u4e5f\u200b\u5c5e\u4e8e\u200bconfig_group     </li> </ul>"},{"location":"12_USB/14_1/#23-configfs","title":"2.3 configfs\u200b\u4f7f\u7528\u200b\u6d41\u7a0b","text":"<p>\u200b\u8ddf\u200blegacy\u200b\u65b9\u6cd5\u200b\u7c7b\u6bd4\u200b\uff0c\u200b\u8981\u200b\u505a\u200b\u7684\u200b\u4e8b\u60c5\u200b\u662f\u200b\u4e00\u6837\u200b\u7684\u200b\uff1a</p> <ul> <li>\u200b\u521b\u5efa\u200busb_composite_dev</li> <li>\u200b\u8bbe\u7f6e\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b</li> <li>\u200b\u8bbe\u7f6e\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26\u200b</li> <li>\u200b\u6dfb\u52a0\u200b\u63a5\u53e3\u200b\uff08\u200b\u529f\u80fd\u200b\uff09</li> </ul> <p>\u200b\u5728\u200b\u89c6\u9891\u200b\u91cc\u200b\u6f14\u793a\u200b\u3002</p>"},{"location":"12_USB/15_1/","title":"Gadget\u200b\u5e94\u7528\u200b\u5b9e\u4f8b\u200b\u4e4b\u200badb","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u300aLinux usb 7. Linux \u200b\u914d\u7f6e\u200b ADBD\u300bhttps://blog.csdn.net/pwl999/article/details/121873236</li> <li>https://blog.csdn.net/kunkliu/article/details/122746762</li> <li>usb functionfs\u200b\u901a\u4fe1\u200b\u673a\u5236\u200b\u5206\u6790\u200b: https://blog.csdn.net/baidxi/article/details/123618276</li> <li>linux usb gadget functionfs\u200b\u7684\u200b\u4f7f\u7528\u200b: https://blog.csdn.net/baidxi/article/details/122874525</li> </ul>"},{"location":"12_USB/15_1/#1-adb","title":"1. ADB\u200b\u6846\u67b6","text":"<p>ADB\u200b\u5168\u200b\u79f0\u4e3a\u200b\"Android Debug Bridge\"\uff0cAndroid\u200b\u8c03\u8bd5\u200b\u6865\u200b\u3002\u200b\u5728\u200b\u7eaf\u200bLinux\u200b\u7cfb\u7edf\u200b\u4e2d\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u3002\u200b\u5b83\u200b\u662f\u200bclient-server\u200b\u67b6\u6784\u200b\uff0c\u200b\u7531\u200b\u4e09\u200b\u90e8\u5206\u200b\u7ec4\u6210\u200b\uff1a</p> <ul> <li>adbclient\uff1a\u200b\u6211\u4eec\u200b\u8fd0\u884c\u200b\u7684\u200badb\u200b\u547d\u4ee4\u200b\u5c31\u200b\u5c5e\u4e8e\u200badbclient\uff0c\u200b\u6bd4\u5982\u200b\u6211\u4eec\u200b\u8fd0\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b<code>adb push d:\\1.txt /root</code>\u200b\u65f6\u200b\uff0c\u200b\u5b83\u200b\u5c31\u662f\u200b\u4e00\u4e2a\u200badbclient\uff0c\u200b\u5b83\u200b\u901a\u8fc7\u200badbserver\u200b\u628a\u200bwindows\u200b\u4e0b\u200b\u7684\u200b\u6587\u4ef6\u200b\"d:\\1.txt\"\u200b\u63a8\u9001\u200b\u5230\u200b\u5f00\u53d1\u677f\u200b\u7684\u200b/root\u200b\u76ee\u5f55\u200b</li> <li>adbserver\uff1a\u200b\u4f5c\u4e3a\u200b\u4e00\u4e2a\u200b\u540e\u53f0\u7a0b\u5e8f\u200b\u8fd0\u884c\u200b\u8fd0\u884c\u200b\u4e8e\u200bPC\uff0c\u200b\u5b83\u200b\u8d1f\u8d23\u7ba1\u7406\u200bPC\u200b\u548c\u200b\u5f00\u53d1\u677f\u200b\u4e4b\u95f4\u200b\u7684\u200b\u901a\u4fe1\u200b\uff0c\u200b\u5b8c\u6210\u200badbclient\u200b\u7684\u200b\u8bf7\u6c42\u200b</li> <li>adbd\uff1a\u200b\u8fd0\u884c\u200b\u4e8e\u200b\u5f00\u53d1\u677f\u200b\u7684\u200b\u5b88\u62a4\u200b\u8fdb\u7a0b\u200b\uff0c\u200b\u5b83\u200b\u901a\u8fc7\u200b\u5e95\u4e0b\u200b\u7684\u200bGadget\u200b\u8ddf\u200badbserver\u200b\u901a\u4fe1\u200b</li> </ul> <p>\u200b\u5b9e\u9645\u4e0a\u200b\uff0cadbclient\u200b\u548c\u200badbserver\u200b\u90fd\u200b\u662f\u200b\u540c\u4e00\u4e2a\u200b\u5e94\u7528\u7a0b\u5e8f\u200b\uff1a\u200b\u6bd4\u5982\u200bWindows\u200b\u4e0b\u200b\u7684\u200badb.exe\uff0c\u200b\u4f7f\u7528\u200b\u4e0d\u540c\u200b\u7684\u200b\u53c2\u6570\u200b\u6765\u200b\u542f\u52a8\u200b\u65f6\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u4f5c\u4e3a\u200badbclient\u200b\u6216\u8005\u200badbserver\u3002\u200b\u6211\u4eec\u200b\u7b2c\u200b1\u200b\u6b21\u200b\u6267\u884c\u200badb\u200b\u547d\u4ee4\u200b\u65f6\u200b\uff0c\u200b\u5b83\u4f1a\u200b\u5e2e\u200b\u6211\u4eec\u200b\u542f\u52a8\u200b\u4e00\u4e2a\u200badb\u200b\u7a0b\u5e8f\u200b\u4f5c\u4e3a\u200badbserver\u3002</p>"},{"location":"12_USB/15_1/#2-adb","title":"2. \u200b\u4f53\u9a8c\u200bADB","text":""},{"location":"12_USB/15_1/#21-windows","title":"2.1 \u200b\u5728\u200bWindows\u200b\u5b89\u88c5\u200b\u8f6f\u4ef6","text":"<p>\u200b\u89e3\u538b\u200bGIT\u200b\u4ed3\u5e93\u200b\u5982\u4e0b\u200b\u6587\u4ef6\u200b\uff1a</p> <p></p> <p>\u200b\u786e\u8ba4\u200b\u91cc\u9762\u200b\u7684\u200badb.exe\u200b\u6240\u5728\u200b\u76ee\u5f55\u200b\uff0c\u200b\u628a\u200b\u8fd9\u4e2a\u200b\u76ee\u5f55\u200b\u6dfb\u52a0\u200b\u8fdb\u200bWindows\u200b\u7684\u200bPath\u200b\u73af\u5883\u53d8\u91cf\u200b\u91cc\u200b\u3002</p>"},{"location":"12_USB/15_1/#22-stm32mp157","title":"2.2 \u200b\u5728\u200bSTM32MP157\u200b\u4e0a\u200b\u5b9e\u9a8c","text":"<p>STM32MP157\u200b\u7684\u200b\u51fa\u5382\u200b\u7cfb\u7edf\u200b\u5df2\u7ecf\u200b\u5b89\u88c5\u200b\u597d\u200b\u4e86\u200badbd\uff0c\u200b\u53ef\u4ee5\u200b\u76f4\u63a5\u200b\u8fde\u63a5\u200bUSB\u200b\u7ebf\u200b\u8fdb\u884c\u200b\u6d4b\u8bd5\u200b\u3002</p> <p>\u200b\u6bd4\u5982\u200b\u5728\u200bWindows\u200b\u4e0a\u200b\u6267\u884c\u547d\u4ee4\u200b\uff1a</p> <pre><code>adb  devices  # \u200b\u5217\u51fa\u200badb\u200b\u8bbe\u5907\u200b\nadb  push  d:\\1.txt  /root  # \u200b\u4e0a\u4f20\u200b\u6587\u4ef6\u200b\u5230\u200b\u5f00\u53d1\u677f\u200b/root\u200b\u76ee\u5f55\u200b\nadb  shell   # \u200b\u542f\u52a8\u200badb\u200b\u547d\u4ee4\u884c\u200b\n</code></pre> <p>IMX6ULL\u200b\u7684\u200b\u51fa\u5382\u200b\u7cfb\u7edf\u200b\u8fd8\u200b\u6ca1\u200b\u5b89\u88c5\u200badbd\uff0c\u200b\u7b49\u200b\u79fb\u690d\u200bADB\u200b\u65f6\u200b\u518d\u200b\u8fdb\u884c\u200b\u5b9e\u9a8c\u200b\u3002</p>"},{"location":"12_USB/15_1/#3-functionfs","title":"3. functionfs","text":"<p>\u200b\u6211\u4eec\u200b\u5173\u6ce8\u200b\u7684\u200b\u662f\u200bGadget\u200b\u90e8\u5206\u200b\uff1a\u200b\u4f7f\u7528\u200blegacy\u200b\u7684\u200b\u65b9\u6cd5\u200b\u65f6\u200b\uff0c\u200b\u6211\u4eec\u200b\u9700\u8981\u200b\u5728\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u91cc\u200b\u6307\u5b9a\u200b\u8bbe\u5907\u200b\u4fe1\u606f\u200b\uff08\u200b\u6bd4\u5982\u200b\u8bbe\u5907\u200b\u63cf\u8ff0\u7b26\u200b\u3001\u200b\u914d\u7f6e\u200b\u63cf\u8ff0\u7b26\u200b\u7b49\u7b49\u200b\uff09\uff0c\u200b\u8fd8\u200b\u9700\u8981\u200b\u5728\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u91cc\u200b\u5b9e\u73b0\u200b\u6570\u636e\u200b\u7684\u200b\u4f20\u8f93\u200b\u529f\u80fd\u200b\uff0c\u200b\u8fd9\u200b\u90fd\u200b\u5728\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u91cc\u200b\u9650\u5b9a\u200b\u6b7b\u200b\u4e86\u200b\u3002</p> <p>\u200b\u4f7f\u7528\u200bconfigfs\u200b\u65f6\u200b\uff0c\u200b\u6211\u4eec\u200b\u53ef\u4ee5\u200b\u7075\u6d3b\u200b\u5730\u200b\u6307\u5b9a\u200b\u8bbe\u5907\u200b\u4fe1\u606f\u200b\u3001\u200b\u7075\u6d3b\u200b\u5730\u200b\u9009\u62e9\u200b\u5404\u79cd\u200bfunction\u3002\u200b\u4f46\u662f\u200b\uff0c\u200b\u8fd8\u200b\u4e0d\u591f\u200b\u7075\u6d3b\u200b\uff1a\u200b\u4f60\u200b\u5fc5\u987b\u200b\u9009\u62e9\u200b\u67d0\u4e2a\u200bfunction\uff0c\u200b\u8fd9\u4e2a\u200bfunction\u200b\u91cc\u200b\u5df2\u7ecf\u200b\u5b9e\u73b0\u200b\u5b9e\u73b0\u200b\u4e86\u200b\u6570\u636e\u200b\u7684\u200b\u4f20\u8f93\u200b\u529f\u80fd\u200b\uff0c\u200b\u4f60\u200b\u65e0\u6cd5\u200b\u66f4\u6539\u200b\u3002</p> <p>\u200b\u6211\u4eec\u200b\u80fd\u5426\u200b\u628a\u200bGadget\u200b\u8bbe\u5907\u200b\u7684\u200b\u7aef\u70b9\u200b\u66b4\u9732\u200b\u7ed9\u200b\u7528\u6237\u7a0b\u5e8f\u200b\uff1f\u200b\u8ba9\u200b\u7528\u6237\u7a0b\u5e8f\u200b\u81ea\u5df1\u200b\u64cd\u4f5c\u200b\u7aef\u70b9\u200b\u6765\u200b\u4f20\u8f93\u6570\u636e\u200b\uff1f\u200b\u53ef\u4ee5\u200b\uff01\u200b\u8fd9\u200b\u5c31\u662f\u200bfunctionfs\u3002</p> <p>functionfs\u200b\u662f\u200b\u4e00\u79cd\u200b\u6587\u4ef6\u7cfb\u7edf\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u4f7f\u7528\u200b\u5206\u4e3a\u200b\u4e24\u6b65\u200b\uff1a</p> <ul> <li>\u200b\u5185\u6838\u200b\u6001\u200b\uff1a\u200b\u6ce8\u518c\u200bfunctionfs</li> <li>\u200b\u7528\u6237\u200b\u6001\u200b\uff1a\u200b\u6302\u8f7d\u200bfunctionfs</li> </ul> <p>\u200b\u6293\u4f4f\u200b\u8fd9\u4e24\u70b9\u200b\u6765\u200b\u5206\u6790\u200b\u4ee3\u7801\u200b\u3002</p>"},{"location":"12_USB/15_1/#31-functionfs","title":"3.1 \u200b\u6ce8\u518c\u200bfunctionfs","text":"<p>\u200b\u4ee5\u200blegacy\u200b\u7684\u200b\u65b9\u5f0f\u200b\u6765\u200b\u5206\u6790\u200b\uff0c\u200b\u53ea\u8981\u200b\u5b89\u88c5\u200bg_ffs.ko\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff1a</p> <pre><code>insmod g_ffs.ko\n</code></pre> <p>\u200b\u5c31\u200b\u4f1a\u200b\u89e6\u53d1\u200b\u4ee5\u4e0b\u200b\u8c03\u7528\u200b\u8fc7\u7a0b\u200b\uff1a</p> <pre><code># drivers\\usb\\gadget\\legacy\\g_ffs.c\ngfs_init\n    usb_get_function_instance(\"ffs\");\n        try_get_usb_function_instance\n            fi = fd-&gt;alloc_inst();\n                # drivers\\usb\\gadget\\function\\f_fs.c\n                ffs_alloc_inst\n                    dev = _ffs_alloc_dev();\n                        ret = functionfs_init();\n                            ret = register_filesystem(&amp;ffs_fs_type);\n</code></pre> <p>\u200b\u4f7f\u7528\u200bconfigfs\u200b\u65b9\u5f0f\u200b\u7684\u8bdd\u200b\uff0c\u200b\u9700\u8981\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\uff1a</p> <pre><code>modprobe libcomposite\nmount -t configfs none /sys/kernel/config\n\nmkdir -p /sys/kernel/config/usb_gadget/g1\nmkdir  -p /sys/kernel/config/usb_gadget/g1/functions/ffs.adb\n</code></pre> <p>\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200b\u63d0\u793a\u4fe1\u606f\u200b\uff1a</p> <p></p> <p>\u200b\u6267\u884c\u547d\u4ee4\u200b<code>cat /proc/filesystems</code>\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200bfunctionfs\u3002</p>"},{"location":"12_USB/15_1/#32-functionfs","title":"3.2 \u200b\u6302\u8f7d\u200bfunctionfs","text":"<p>\u200b\u8fd9\u65f6\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u6302\u8f7d\u200bfunctionfs\u200b\u4e86\u200b\uff0c\u200b\u6267\u884c\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b\uff1a</p> <pre><code># mkdir -p /dev/usb-ffs/adb\n# mount -t functionfs adb /dev/usb-ffs/adb  # \u200b\u4e0a\u9762\u200b\u521b\u5efa\u200b\u4e86\u200bfunctions/ffs.adb, \u200b\u6302\u8f7d\u200b\u65f6\u200bdev\u200b\u5c31\u8981\u200b\u6307\u5b9a\u200b\u4e3a\u200badb\n# ls /dev/usb-ffs/adb/\nep0\n</code></pre> <p>\u200b\u6709\u200b\u4e86\u200bep0\u200b\u65ad\u70b9\u200b\u540e\u200b\uff0c\u200b\u7528\u6237\u200b\u6001\u200b\u7a0b\u5e8f\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200b\u5b83\u200b\u8ddf\u200b\u4e3b\u673a\u200b\u901a\u4fe1\u200b\u4e86\u200b\u3002</p>"},{"location":"12_USB/15_1/#33-ep0","title":"3.3 ep0\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f","text":"<p>ep0\u200b\u5bf9\u5e94\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\uff0c\u200b\u5206\u6790\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u6302\u8f7d\u200bfunctionfs\u200b\u65f6\u200b\uff0c\u200b\u4f1a\u200b\u5bfc\u81f4\u200b\u4e00\u4e2a\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b\uff1a</li> </ul> <p></p> <ul> <li>ffs_sb_fill\u200b\u4e2d\u200b\uff0c\u200b\u4f1a\u200b\u5728\u200bfunctionfs\u200b\u7684\u200b\u6839\u76ee\u5f55\u200b\u4e0b\u200b\u521b\u5efa\u200b\u540d\u4e3a\u200bep0\u200b\u7684\u200b\u6587\u4ef6\u200b\uff0c\u200b\u5e76\u200b\u7ed9\u200b\u5b83\u200b\u63d0\u4f9b\u200bfile_operations\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff1a   </li> </ul>"},{"location":"12_USB/15_1/#4-adb","title":"4. ADB\u200b\u5b9e\u73b0\u200b\u901f\u89c8","text":"<p>\u200b\u6e90\u7801\u200b\uff1ahttps://www.github.com/hadess/adbd</p> <p>\u200b\u6211\u4eec\u200b\u4e5f\u200b\u4e0b\u8f7d\u200b\u653e\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u4e86\u200b\uff1a</p> <p></p> <p>\u200b\u6211\u4eec\u200b\u5173\u6ce8\u200b\u7684\u200b\u4e0d\u662f\u200badb\u200b\u672c\u8eab\u200b\u7684\u200b\u5b9e\u73b0\u200b\uff0c\u200b\u800c\u662f\u200b\u6570\u636e\u200b\u5982\u4f55\u200b\u4f20\u8f93\u200b\u3002</p> <p>\u200b\u5206\u6790\u200b\u6587\u4ef6\u200b\uff1aadbd-master\\adb\\usb_linux_client.cpp</p>"},{"location":"12_USB/15_1/#41","title":"4.1 \u200b\u521d\u59cb\u5316\u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26","text":""},{"location":"12_USB/15_1/#42","title":"4.2 \u200b\u7533\u8bf7\u200b\u66f4\u200b\u591a\u200b\u7aef\u70b9","text":"<p>\u200b\u5728\u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26\u200b\u91cc\u200b\uff0c\u200b\u5b9a\u4e49\u200b\u4e86\u200b\u591a\u4e2a\u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26\u200b\uff0c\u200b\u8fd9\u662f\u200bAPP\u200b\u63d0\u51fa\u200b\u7684\u200b\u8bf7\u6c42\u200b\u3002\u200b\u5982\u679c\u200bGadget\u200b\u8bbe\u5907\u200b\u6709\u200b\u8db3\u591f\u200b\u7684\u200b\u7aef\u70b9\u200b\uff0c\u200b\u90a3\u4e48\u200b\u5c31\u200b\u4f1a\u200b\u5728\u200b\u5728\u200bfunctionfs\u200b\u8ddf\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u521b\u5efa\u200b\u51fa\u200b\u8fd9\u4e9b\u200b\u7aef\u70b9\u200b\uff0c\u200b\u6bd4\u5982\u200bep1\u3001ep2\u3002</p> <p>ADB\u200b\u7a0b\u5e8f\u200b\u7684\u200b\u8c03\u7528\u200b\u5173\u7cfb\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>init_functionfs\n\n    // \u200b\u8bbe\u7f6e\u200b\u529f\u80fd\u200b\u63cf\u8ff0\u7b26\u200b(\u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26\u200b)\n    v2_descriptor.fs_count = 3;\n    v2_descriptor.hs_count = 3;\n    v2_descriptor.ss_count = 5;\n    v2_descriptor.os_count = 1;\n    v2_descriptor.fs_descs = fs_descriptors;\n    v2_descriptor.hs_descs = hs_descriptors;\n    v2_descriptor.ss_descs = ss_descriptors;\n    v2_descriptor.os_header = os_desc_header;\n    v2_descriptor.os_desc = os_desc_compat;\n\n    h-&gt;control = adb_open(USB_FFS_ADB_EP0, O_RDWR); // \u200b\u6253\u5f00\u200b\u7aef\u70b9\u200b0\n\n    // \u200b\u628a\u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26\u200b\u53d1\u7ed9\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\n    ret = adb_write(h-&gt;control, &amp;v2_descriptor, sizeof(v2_descriptor));\n\n    // \u200b\u53d1\u9001\u200b\u5b57\u7b26\u4e32\u200b\u63cf\u8ff0\u7b26\u200b, \u200b\u8fd9\u4f1a\u200b\u89e6\u53d1\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6839\u636e\u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26\u200b\u521b\u5efa\u200b\u66f4\u200b\u591a\u200b\u7684\u200bendpoint\n    ret = adb_write(h-&gt;control, &amp;strings, sizeof(strings));\n</code></pre> <p>\u200b\u4e0a\u9762\u200b\u7684\u200b\u51fd\u6570\u200b\u64cd\u4f5c\u200b\u7684\u200b\u90fd\u200b\u662f\u200bep0\uff0c\u200b\u5bf9\u5e94\u200b\u7684\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u51fd\u6570\u200bffs_epfiles_create\u200b\u4f1a\u200b\u6839\u636e\u200b\u63a5\u53e3\u200b\u63cf\u8ff0\u7b26\u200b\u7533\u8bf7\u200b\u66f4\u200b\u591a\u200b\u7684\u200bendpoint\uff0c\u200b\u5e76\u4e14\u200b\u5728\u200bfunctionfs\u200b\u91cc\u200b\u521b\u5efa\u200b\u5bf9\u5e94\u200b\u7684\u200b\u8282\u70b9\u200b\uff1a</p> <p></p>"},{"location":"12_USB/15_1/#5-adb","title":"5. \u200b\u79fb\u690d\u200bADB","text":""},{"location":"12_USB/15_1/#51-adb","title":"5.1 \u200b\u4ea4\u53c9\u200b\u7f16\u8bd1\u200badb","text":"<p>\u200b\u5982\u679c\u200b\u4e0d\u60f3\u200b\u81ea\u5df1\u200b\u7f16\u8bd1\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\u7684\u200b\u53ef\u6267\u884c\u7a0b\u5e8f\u200b\uff1a</p> <p></p> <p>\u200b\u4ee5\u200bIMX6ULL\u200b\u4e3a\u4f8b\u200b\uff0c\u200b\u6253\u5f00\u200b\u300a\u200b\u5d4c\u5165\u5f0f\u200bLinux\u200b\u5e94\u7528\u200b\u5f00\u53d1\u200b\u5b8c\u5168\u200b\u624b\u518c\u200bV5_IMX6ULL_Pro\u200b\u5f00\u53d1\u677f\u200b.pdf\u300b\uff0c\u200b\u627e\u5230\u200b\u300a6.5 \u200b\u6784\u5efa\u200bIMX6ULL Pro\u200b\u7248\u200b\u7684\u200b\u6839\u200b\u6587\u4ef6\u7cfb\u7edf\u200b\u300b\u200b\u7ae0\u8282\u200b\uff0c\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\uff1a</p> <pre><code>make clean\nmake 100ask_imx6ull_pro_ddr512m_systemV_qt5_defconfig\nmake menuconfig\n</code></pre> <p>\u200b\u914d\u7f6e\u200bADB\uff1a-&gt; Target packages  -&gt; System tools</p> <p></p> <p>\u200b\u7136\u540e\u200b\u6267\u884c\u200b\uff1a</p> <pre><code>make android-tools-rebuild\n</code></pre> <p>\u200b\u671f\u95f4\u200b\u4f1a\u200b\u81ea\u52a8\u200b\u4e0b\u8f7d\u200b\u6e90\u7801\u200b\u3001\u200b\u7f16\u8bd1\u200b\u3002</p> <p>\u200b\u6210\u529f\u200b\u540e\u200b\uff0c\u200b\u53ef\u200b\u5728\u200b\u5982\u4e0b\u200b\u76ee\u5f55\u200b\u67e5\u770b\u200b\u5230\u200b\u53ef\u6267\u884c\u7a0b\u5e8f\u200badb\u3001adbd\uff1a</p> <pre><code>/home/book/100ask_imx6ull-sdk/Buildroot_2020.02.x/output/target/usr/bin\n</code></pre> <p>\u200b\u628a\u200b\u53ef\u6267\u884c\u7a0b\u5e8f\u200b\u653e\u5230\u200b\u5f00\u53d1\u677f\u200b\u7684\u200b/usr/bin\u200b\u76ee\u5f55\u200b\u3002</p>"},{"location":"12_USB/15_1/#52","title":"5.2 \u200b\u811a\u672c","text":"<p>IMX6ULL\u200b\u4e0a\u200b\u4f7f\u7528\u200b\u7684\u200b\u7b80\u5316\u200b\u811a\u672c\u200b\uff1a</p> <pre><code>modprobe libcomposite\nmount -t configfs none /sys/kernel/config\nmkdir -p /dev/usb-ffs/adb\nmkdir -p /sys/kernel/config/usb_gadget/g1 \nmkdir  -p /sys/kernel/config/usb_gadget/g1/functions/ffs.adb\nmkdir  -p /sys/kernel/config/usb_gadget/g1/configs/b.1\nln -s  /sys/kernel/config/usb_gadget/g1/functions/ffs.adb /sys/kernel/config/usb_gadget/g1/configs/b.1\nmount -t functionfs adb /dev/usb-ffs/adb\nstart-stop-daemon --start --oknodo --pidfile /var/run/adbd.pid --startas /usr/bin/adbd --background\nsleep 1\necho ci_hdrc.0 &gt; /sys/kernel/config/usb_gadget/g1/UDC\n</code></pre> <p>\u200b\u53ef\u4ee5\u200b\u5728\u200b/etc/init.d/\u200b\u76ee\u5f55\u200b\u4e0b\u200b\u521b\u5efa\u200b\u4e00\u4e2a\u200bS99adbd\u200b\u6587\u4ef6\u200b\uff0c\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u81ea\u52a8\u200b\u4f7f\u80fd\u200bADB\u200b\u529f\u80fd\u200b\u3002\u200b\u8fd9\u4e2a\u200b\u6587\u4ef6\u200b\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff1a</p> <p></p> <p>\u200b\u6765\u81ea\u200bSTM32MP157\u200b\u7684\u200b\u4f9b\u53c2\u8003\u200b\u7684\u200b\u811a\u672c\u200b\uff1a</p> <pre><code>#!/bin/bash -e\n### BEGIN INIT INFO\n# Provides:          adbd\n# Required-Start:\n# Required-Stop:\n# Default-Start:\n# Default-Stop:\n# Short-Description:\n# Description:       Linux ADB\n### END INIT INFO\n\nVENDOR_ID=\"0x1d6b\"\nPRODUCT_ID=\"0x0104\"\nUDC=`ls /sys/class/udc/ | awk '{print $1}'`\n\nstart() {\n        mkdir -p /dev/usb-ffs/adb -m 0770\n\n        mkdir -p /sys/kernel/config/usb_gadget/g1  -m 0770\n\n        echo ${VENDOR_ID} &gt; /sys/kernel/config/usb_gadget/g1//idVendor\n        echo ${PRODUCT_ID} &gt; /sys/kernel/config/usb_gadget/g1//idProduct\n\n        mkdir  -p /sys/kernel/config/usb_gadget/g1/strings/0x409   -m 0770\n\n        echo \"0123456789ABCDEF\" &gt; /sys/kernel/config/usb_gadget/g1/strings/0x409/serialnumber\n        echo \"STMicroelectronics\"  &gt; /sys/kernel/config/usb_gadget/g1/strings/0x409/manufacturer\n        echo \"STM32MP1\"  &gt; /sys/kernel/config/usb_gadget/g1/strings/0x409/product\n\n        mkdir  -p /sys/kernel/config/usb_gadget/g1/functions/ffs.adb\n        mkdir  -p /sys/kernel/config/usb_gadget/g1/configs/b.1  -m 0770\n        mkdir  -p /sys/kernel/config/usb_gadget/g1/configs/b.1/strings/0x409  -m 0770\n\n        ln -s  /sys/kernel/config/usb_gadget/g1/functions/ffs.adb /sys/kernel/config/usb_gadget/g1/configs/b.1\n        echo \"adb\" &gt; /sys/kernel/config/usb_gadget/g1/configs/b.1/strings/0x409/configuration\n        mount -t functionfs adb /dev/usb-ffs/adb\n\n        start-stop-daemon --start --oknodo --pidfile /var/run/adbd.pid --startas /bin/adbd --background\n\n        sleep 1\n\n        echo $UDC &gt; /sys/kernel/config/usb_gadget/g1/UDC\n}\n\nstop() {\n        start-stop-daemon --stop --oknodo --pidfile /var/run/adbd.pid --retry 5\n        umount /dev/usb-ffs/adb\n}\n\nrestart() {\n        echo $UDC &gt; /sys/kernel/config/usb_gadget/g1/UDC\n}\n\nif [  \"$UDC\" != \"\" ]; then\n        case $1 in\n                start|stop|restart) \"$1\" ;;\n        esac\nfi\n\nexit $?\n</code></pre>"},{"location":"12_USB/16_1/","title":"tmp","text":"<p>\u200b\u542b\u6709\u200b\u591a\u4e2a\u200b\u914d\u7f6e\u200b\u7684\u200b\u63cf\u8ff0\u7b26\u200b</p> <p>https://github.com/linuxhw/LsUSB/blob/master/Notebook/Hewlett-Packard/Laptop/Laptop%2015s-fq0xxx/4BB07732F905/ROSA-12.2/5.10.74-GENERIC-2ROSA2021.1-X86_64/X86_64/5C45B0B08A</p> <p>/sys/kernel/debug/usb/devices</p> <p>https://programmerall.com/article/42562063276/</p> <p>\u200b\u5c31\u662f\u200busb \u200b\u7684\u200bvcp \u200b\u6a21\u5f0f\u200b\u548c\u200bmsd \u200b\u6302\u8f7d\u200b \u200b\u6211\u5148\u200b\u52a0\u5165\u200b\u7b14\u8bb0\u200b\u91cc\u200b\uff0c\u200b\u5230\u200b\u65f6\u200b\u770b\u770b\u200b\u662f\u5426\u200b\u5b9e\u7528\u200b\u3001\u200b\u5b9e\u7528\u200b\u7684\u8bdd\u200b\u518d\u200b\u8bb2\u200b</p> <p>\u200b\u97e6\u200b\u8001\u5e08\u200b\uff0cUSB\u200b\u91cc\u9762\u200b\u4f11\u7720\u200b\u5524\u9192\u200bsuspend/resueme/autosuspend/remote-wakeup\u200b\u8fd9\u4e9b\u200b\u4e5f\u200b\u633a\u200b\u5e38\u7528\u200b\u7684\u200b\uff0c\u200b\u5e0c\u671b\u200b\u8001\u5e08\u200b\u540e\u9762\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u8bb2\u200b\u4e00\u4e0b\u200b</p> <pre><code>L:\\kernel_projects\\Linux-4.9.88\\drivers\\usb\\core\\message.c\n    usb_set_configuration\n        nintf = cp-&gt;desc.bNumInterfaces;\n        new_interfaces = kmalloc(nintf * sizeof(*new_interfaces),\n                GFP_NOIO);\n\n        intf-&gt;dev.bus = &amp;usb_bus_type;\n        intf-&gt;dev.type = &amp;usb_if_device_type;\n        intf-&gt;dev.groups = usb_interface_groups;\n\n        ret = device_add(&amp;intf-&gt;dev);\n</code></pre>"},{"location":"12_USB/17_1/","title":"Gadget\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>Linux\u200b\u4e0b\u200bUSB gadget\u200b\u8bbe\u5907\u200b\u8be6\u89e3\u200b\uff1ahttps://www.docin.com/p-1852320293.html</li> <li>Linux usb gadget\u200b\u6846\u67b6\u200b\u6982\u8ff0\u200b\uff1ahttps://blog.csdn.net/daocaokafei/article/details/114114824</li> <li>USB\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b-USB Gadget Driver(\u200b\u4e8c\u200b)\uff1ahttps://blog.csdn.net/chenzhen1080/article/details/53742924</li> <li>usb gadge\u200b\u9a71\u52a8\u200b\u8bbe\u8ba1\u200b\u4e4b\u200b\u6211\u200b\u662f\u200bzero\uff1ahttps://www.bbsmax.com/A/Ae5RvbwM5Q/</li> <li>Linux-USB\u200b\u9a71\u52a8\u200b\u7b14\u8bb0\u200b\uff08\u200b\u56db\u200b\uff09--USB\u200b\u6574\u4f53\u200b\u6846\u67b6\u200b: https://qingmu.blog.csdn.net/article/details/119979199</li> <li>USB gadget\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u89e3\u6790\u200b:  https://www.likecs.com/show-843861.html</li> <li>\u200b\u8c03\u8bd5\u200b\u8f6f\u4ef6\u200b\uff1aUSB view \u3001bushound \u3001\u200b\u53ca\u200b\u4e00\u4e9b\u200b\u786c\u4ef6\u200bUSB\u200b\u4fe1\u53f7\u200b\u5206\u6790\u4eea\u200b</li> <li>\u200b\u53ef\u4ee5\u200b\u7528\u200bwireshark+usbmon\u200b\u6355\u6349\u200busb\u200b\u534f\u8bae\u200b\u6570\u636e\u5305\u200b\u3002</li> </ul>"},{"location":"12_USB/17_1/#1","title":"1. \u200b\u7b14\u8bb0","text":"<p>Tutorial about USB HID Report Descriptors</p> <p>https://eleccelerator.com/tutorial-about-usb-hid-report-descriptors/</p> <p>USB HID Report Descriptor \u200b\u62a5\u544a\u200b\u63cf\u8ff0\u7b26\u200b\u8be6\u89e3\u200b - Climber\u200b\u4e36\u200b - \u200b\u535a\u5ba2\u56ed\u200b.html</p> <p>https://www.cnblogs.com/AlwaysOnLines/p/3859557.html</p> <p></p> <pre><code>struct usb_gadget - represents a usb slave device\nstruct usb_composite_device - represents one composite usb gadget\nstruct usb_udc - describes one usb device controller\n</code></pre> <pre><code>/**\n * struct usb_udc - describes one usb device controller\n * @driver - the gadget driver pointer. For use by the class code\n * @dev - the child device to the actual controller\n * @gadget - the gadget. For use by the class code\n * @list - for use by the udc class driver\n * @vbus - for udcs who care about vbus status, this value is real vbus status;\n * for udcs who do not care about vbus status, this value is always true\n *\n * This represents the internal data structure which is used by the UDC-class\n * to hold information about udc driver and gadget together.\n */\nstruct usb_udc {\n    struct usb_gadget_driver    *driver;\n    struct usb_gadget       *gadget;\n    struct device           dev;\n    struct list_head        list;\n    bool                vbus;\n};\n\n\n// usb_udc\u200b\u7528\u6765\u200b\u8868\u793a\u200bUSB\u200b\u8bbe\u5907\u200b\u63a7\u5236\u5668\u200b\uff0c\u200b\u5b83\u200b\u91cc\u9762\u200b\u6709\u200b\uff1a\n// 1. usb_gadget : \u200b\u7528\u6765\u200b\u8868\u793a\u200b\u786c\u4ef6\u200b\u4fe1\u606f\u200b\uff1frepresents a usb slave device\uff0c\u200b\u6bd4\u5982\u200bUSB\u200b\u4e32\u53e3\u200b\uff1f\n// 2. usb_gadget_driver: \u200b\u7528\u6765\u200b\u8868\u793a\u200b\u8f6f\u4ef6\u200b\u4fe1\u606f\u200b\uff1fdriver for usb 'slave' devices\n</code></pre> <p>usb_gadget\u200b\u548c\u200busb_composite_dev\u200b\u5fc5\u5b9a\u200b\u4e00\u8d77\u200b\u51fa\u73b0\u200b\uff1ausb_gadget\u200b\u63cf\u8ff0\u200b\u7684\u200b\u662f\u200b\u786c\u4ef6\u200b\u5e95\u5c42\u200b\u4fe1\u606f\u200b(?)\uff0cusb_composite_dev\u200b\u63cf\u8ff0\u200b\u7684\u200b\u662f\u200b\u786c\u4ef6\u200b\u7684\u200b\u4e0a\u5c42\u200b\u4fe1\u606f\u200b(\uff1f)</p> <p></p>"},{"location":"12_USB/17_1/#11","title":"1.1 \u200b\u7ed3\u6784\u200b\u4f53","text":"<pre><code>struct usb_udc - describes one usb device controller\nstruct usb_gadget - represents a usb slave device\nstruct usb_gadget_driver - driver for usb 'slave' devices\nstruct usb_composite_device - represents one composite usb gadget\nstruct usb_function - describes one function of a configuration\nstruct usb_composite_driver - groups configurations into a gadget\n</code></pre>"},{"location":"12_USB/17_1/#12-udc","title":"1.2 UDC\u200b\u9a71\u52a8\u200b\u5206\u6790","text":"<pre><code>/home/book/100ask_imx6ull-sdk/Linux-4.9.88/drivers/usb/chipidea/ci_hdrc_imx.c\n    data-&gt;ci_pdev = ci_hdrc_add_device(dev,\n                pdev-&gt;resource, pdev-&gt;num_resources,\n                &amp;pdata);\n\n/home/book/100ask_imx6ull-sdk/Linux-4.9.88/drivers/usb/chipidea/core.c\nstatic struct platform_driver ci_hdrc_driver = {\n    .probe  = ci_hdrc_probe,\n    .remove = ci_hdrc_remove,\n    .driver = {\n        .name   = \"ci_hdrc\",\n        .pm = &amp;ci_pm_ops,\n    },\n};\n</code></pre> <p>\u200b\u4e2d\u65ad\u200b\uff1a</p> <p></p>"},{"location":"12_USB/17_1/#121-udc","title":"1.2.1 \u200b\u6ce8\u518c\u200budc","text":"<pre><code>// drivers/usb/chipidea/core.c\nci_hdrc_probe\n    ret = ci_hdrc_gadget_init(ci);\n                struct ci_role_driver *rdrv;\n                rdrv-&gt;start = udc_id_switch_for_device;\n                rdrv-&gt;stop  = udc_id_switch_for_host;\n                rdrv-&gt;irq   = udc_irq;\n                rdrv-&gt;suspend   = udc_suspend;\n                rdrv-&gt;resume    = udc_resume;\n                rdrv-&gt;name  = \"gadget\";\n\n                ret = udc_start(ci);    \n                        ci-&gt;gadget.ops          = &amp;usb_gadget_ops;\n                        ci-&gt;gadget.speed        = USB_SPEED_UNKNOWN;\n                        ci-&gt;gadget.max_speed    = USB_SPEED_HIGH;\n                        ci-&gt;gadget.name         = ci-&gt;platdata-&gt;name;\n                        ci-&gt;gadget.otg_caps = otg_caps;\n\n                        retval = init_eps(ci);\n                                    hwep-&gt;ep.name      = hwep-&gt;name;\n                                    hwep-&gt;ep.ops       = &amp;usb_ep_ops;\n                        if (retval)\n                            goto free_pools;\n\n                        ci-&gt;gadget.ep0 = &amp;ci-&gt;ep0in-&gt;ep;\n\n                        retval = usb_add_gadget_udc(dev, &amp;ci-&gt;gadget);\n                                    usb_add_gadget_udc_release(parent, gadget, NULL);\n                                        list_add_tail(&amp;udc-&gt;list, &amp;udc_list);\n                if (!ret)\n                    ci-&gt;roles[CI_ROLE_GADGET] = rdrv;\n\n    platform_set_drvdata(pdev, ci);\n    ret = devm_request_irq(dev, ci-&gt;irq, ci_irq, IRQF_SHARED,\n                           ci-&gt;platdata-&gt;name, ci);\n    if (ret)\n        goto stop;\n</code></pre>"},{"location":"12_USB/17_1/#122-udc","title":"1.2.2 UDC\u200b\u4e2d\u65ad\u200b\u5904\u7406\u51fd\u6570","text":"<pre><code>// /home/book/100ask_imx6ull-sdk/Linux-4.9.88/drivers/usb/chipidea/core.c\nci_irq\n    /* Handle device/host interrupt */\n    if (ci-&gt;role != CI_ROLE_END)\n        ret = ci_role(ci)-&gt;irq(ci);    \n                    udc_irq\n                        if (USBi_UI  &amp; intr)\n                            isr_tr_complete_handler(ci);      \n\n                                /* Only handle setup packet below */\n                                if (i == 0 &amp;&amp;\n                                    hw_test_and_clear(ci, OP_ENDPTSETUPSTAT, BIT(0)))\n                                    isr_setup_packet_handler(ci);\n</code></pre>"},{"location":"12_USB/17_1/#123","title":"1.2.3 \u200b\u63a7\u5236\u4f20\u8f93\u200b\u7684\u200b\u5904\u7406","text":"<p>isr_setup_packet_handler\u200b\u5bf9\u4e8e\u200bep0\u200b\u7684\u200b\u5904\u7406\u200b\uff0c</p> <p>\u200b\u6709\u200b\u5f88\u591a\u200bx\u200b\u6d88\u606f\u200b\u5e76\u4e0d\u9700\u8981\u200b\u4f20\u9012\u200b\u5230\u200b\u6700\u4e0a\u5c42\u200b\u7684\u200bcomposite\u200b\u9a71\u52a8\u200b\uff0c</p> <p>\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u7684\u200b\u524d\u9762\u200b\u4ee3\u7801\u200b\u5c31\u200b\u81ea\u5df1\u200b\u5904\u7406\u200b\u4e86\u200b\u8fd9\u4e9b\u200bsetup\u200b\u5305\u200b\uff0c</p> <p>\u200b\u540e\u9762\u200b\u65e0\u6cd5\u200b\u5904\u7406\u200b\u7684\u200brequest\u200b\u624d\u200b\u4ea4\u7ed9\u200b\u4e0a\u5c42\u200b</p> <pre><code>static void isr_setup_packet_handler(struct ci_hdrc *ci)\n__releases(ci-&gt;lock)\n__acquires(ci-&gt;lock)\n{\n    struct ci_hw_ep *hwep = &amp;ci-&gt;ci_hw_ep[0];\n    struct usb_ctrlrequest req;\n    int type, num, dir, err = -EINVAL;\n    u8 tmode = 0;\n\n    /*\n     * Flush data and handshake transactions of previous\n     * setup packet.\n     */\n    _ep_nuke(ci-&gt;ep0out);\n    _ep_nuke(ci-&gt;ep0in);\n\n    /* read_setup_packet */\n    do {\n        hw_test_and_set_setup_guard(ci);\n        memcpy(&amp;req, &amp;hwep-&gt;qh.ptr-&gt;setup, sizeof(req));\n    } while (!hw_test_and_clear_setup_guard(ci));\n\n    type = req.bRequestType;\n\n    ci-&gt;ep0_dir = (type &amp; USB_DIR_IN) ? TX : RX;\n\n    switch (req.bRequest) {\n    case USB_REQ_CLEAR_FEATURE:\n        if (type == (USB_DIR_OUT|USB_RECIP_ENDPOINT) &amp;&amp;\n                le16_to_cpu(req.wValue) ==\n                USB_ENDPOINT_HALT) {\n            if (req.wLength != 0)\n                break;\n            num  = le16_to_cpu(req.wIndex);\n            dir = (num &amp; USB_ENDPOINT_DIR_MASK) ? TX : RX;\n            num &amp;= USB_ENDPOINT_NUMBER_MASK;\n            if (dir == TX)\n                num += ci-&gt;hw_ep_max / 2;\n            if (!ci-&gt;ci_hw_ep[num].wedge) {\n                spin_unlock(&amp;ci-&gt;lock);\n                err = usb_ep_clear_halt(\n                    &amp;ci-&gt;ci_hw_ep[num].ep);\n                spin_lock(&amp;ci-&gt;lock);\n                if (err)\n                    break;\n            }\n            err = isr_setup_status_phase(ci);\n        } else if (type == (USB_DIR_OUT|USB_RECIP_DEVICE) &amp;&amp;\n                le16_to_cpu(req.wValue) ==\n                USB_DEVICE_REMOTE_WAKEUP) {\n            if (req.wLength != 0)\n                break;\n            ci-&gt;remote_wakeup = 0;\n            err = isr_setup_status_phase(ci);\n        } else {\n            goto delegate;\n        }\n        break;\n    case USB_REQ_GET_STATUS:\n        if ((type != (USB_DIR_IN|USB_RECIP_DEVICE) ||\n            le16_to_cpu(req.wIndex) == OTG_STS_SELECTOR) &amp;&amp;\n            type != (USB_DIR_IN|USB_RECIP_ENDPOINT) &amp;&amp;\n            type != (USB_DIR_IN|USB_RECIP_INTERFACE))\n            goto delegate;\n        if ((le16_to_cpu(req.wLength) != 2 &amp;&amp;\n            le16_to_cpu(req.wLength) != 1) ||\n                le16_to_cpu(req.wValue) != 0)\n            break;\n        err = isr_get_status_response(ci, &amp;req);\n        break;\n    case USB_REQ_SET_ADDRESS:\n        if (type != (USB_DIR_OUT|USB_RECIP_DEVICE))\n            goto delegate;\n        if (le16_to_cpu(req.wLength) != 0 ||\n            le16_to_cpu(req.wIndex)  != 0)\n            break;\n        ci-&gt;address = (u8)le16_to_cpu(req.wValue);\n        ci-&gt;setaddr = true;\n        err = isr_setup_status_phase(ci);\n        break;\n    case USB_REQ_SET_FEATURE:\n        if (type == (USB_DIR_OUT|USB_RECIP_ENDPOINT) &amp;&amp;\n                le16_to_cpu(req.wValue) ==\n                USB_ENDPOINT_HALT) {\n            if (req.wLength != 0)\n                break;\n            num  = le16_to_cpu(req.wIndex);\n            dir = (num &amp; USB_ENDPOINT_DIR_MASK) ? TX : RX;\n            num &amp;= USB_ENDPOINT_NUMBER_MASK;\n            if (dir == TX)\n                num += ci-&gt;hw_ep_max / 2;\n\n            spin_unlock(&amp;ci-&gt;lock);\n            err = _ep_set_halt(&amp;ci-&gt;ci_hw_ep[num].ep, 1, false);\n            spin_lock(&amp;ci-&gt;lock);\n            if (!err)\n                isr_setup_status_phase(ci);\n        } else if (type == (USB_DIR_OUT|USB_RECIP_DEVICE)) {\n            if (req.wLength != 0)\n                break;\n            switch (le16_to_cpu(req.wValue)) {\n            case USB_DEVICE_REMOTE_WAKEUP:\n                ci-&gt;remote_wakeup = 1;\n                err = isr_setup_status_phase(ci);\n                break;\n            case USB_DEVICE_TEST_MODE:\n                tmode = le16_to_cpu(req.wIndex) &gt;&gt; 8;\n                switch (tmode) {\n                case TEST_J:\n                case TEST_K:\n                case TEST_SE0_NAK:\n                case TEST_PACKET:\n                case TEST_FORCE_EN:\n                    ci-&gt;test_mode = tmode;\n                    err = isr_setup_status_phase(\n                            ci);\n                    break;\n                case TEST_OTG_SRP_REQD:\n                    err = otg_srp_reqd(ci);\n                    break;\n                case TEST_OTG_HNP_REQD:\n                    err = otg_hnp_reqd(ci);\n                    break;\n                default:\n                    break;\n                }\n                break;\n            case USB_DEVICE_B_HNP_ENABLE:\n                if (ci_otg_is_fsm_mode(ci)) {\n                    ci-&gt;gadget.b_hnp_enable = 1;\n                    err = isr_setup_status_phase(\n                            ci);\n                }\n                break;\n            case USB_DEVICE_A_ALT_HNP_SUPPORT:\n                if (ci_otg_is_fsm_mode(ci))\n                    err = otg_a_alt_hnp_support(ci);\n                break;\n            case USB_DEVICE_A_HNP_SUPPORT:\n                if (ci_otg_is_fsm_mode(ci)) {\n                    ci-&gt;gadget.a_hnp_support = 1;\n                    err = isr_setup_status_phase(\n                            ci);\n                }\n                break;\n            default:\n                goto delegate;\n            }\n        } else {\n            goto delegate;\n        }\n        break;\n    default:\ndelegate:\n        if (req.wLength == 0)   /* no data phase */\n            ci-&gt;ep0_dir = TX;\n\n        spin_unlock(&amp;ci-&gt;lock);\n        err = ci-&gt;driver-&gt;setup(&amp;ci-&gt;gadget, &amp;req);\n                // composite_driver_template.setup\n                composite_setup\n        spin_lock(&amp;ci-&gt;lock);\n        break;\n    }\n\n    if (err &lt; 0) {\n        spin_unlock(&amp;ci-&gt;lock);\n        if (_ep_set_halt(&amp;hwep-&gt;ep, 1, false))\n            dev_err(ci-&gt;dev, \"error: _ep_set_halt\\n\");\n        spin_lock(&amp;ci-&gt;lock);\n    }\n}\n</code></pre>"},{"location":"12_USB/17_1/#124-ep","title":"1.2.4 EP\u200b\u4ec0\u4e48\u200b\u65f6\u5019\u200b\u4f7f\u80fd","text":"<pre><code>static int udc_bind_to_driver(struct usb_udc *udc, struct usb_gadget_driver *driver)\n{\n    int ret;\n\n    dev_dbg(&amp;udc-&gt;dev, \"registering UDC driver [%s]\\n\",\n            driver-&gt;function);\n\n    udc-&gt;driver = driver;\n    udc-&gt;dev.driver = &amp;driver-&gt;driver;\n    udc-&gt;gadget-&gt;dev.driver = &amp;driver-&gt;driver;\n\n    ret = driver-&gt;bind(udc-&gt;gadget, driver);\n    if (ret)\n        goto err1;\n    ret = usb_gadget_udc_start(udc);\n                return udc-&gt;gadget-&gt;ops-&gt;udc_start(udc-&gt;gadget, udc-&gt;driver);\n                            ci_udc_start\n</code></pre>"},{"location":"12_USB/17_1/#_1","title":"Gadget\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":""},{"location":"13_V4L2/01_1/","title":"V4L2\u200b\u5e94\u7528\u200b\u7a0b\u5e8f\u5f00\u53d1","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>mjpg-streamer\uff1ahttps://github.com/jacksonliam/mjpg-streamer</li> <li>video2lcd\uff1a\u200b\u8fd9\u662f\u200b\u767e\u95ee\u200b\u7f51\u200b\u7f16\u5199\u200b\u7684\u200bAPP\uff0c\u200b\u5b83\u200b\u53ef\u4ee5\u200b\u5728\u200bLCD\u200b\u4e0a\u200b\u76f4\u63a5\u200b\u663e\u793a\u200b\u6444\u50cf\u5934\u200b\u7684\u200b\u56fe\u50cf\u200b</li> <li> <p>\u200b\u8fd9\u200b2\u200b\u4e2a\u200b\u6e90\u7801\u200b\u90fd\u200b\u653e\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff1a   </p> </li> <li> <p>UVC\u200b\u6587\u6863\u200b   </p> </li> <li> <p>\u200b\u53c2\u8003\u200b\u6587\u7ae0\u200b\uff1ahttps://www.xjx100.cn/news/700965.html?action=onClick</p> </li> </ul>"},{"location":"13_V4L2/01_1/#1","title":"1. \u200b\u6570\u636e\u200b\u91c7\u96c6\u200b\u6d41\u7a0b","text":"<p>\u200b\u53ef\u4ee5\u200b\u53c2\u8003\u200b\u8fd9\u4e9b\u200b\u6587\u4ef6\u200b\uff1a</p> <ul> <li>mjpg-streamer\\mjpg-streamer-experimental\\plugins\\input_control\\input_uvc.c</li> <li>video2lcd\\video\\v4l2.c</li> </ul> <p>Video for Linux two(Video4Linux2)\u200b\u7b80\u79f0\u200bV4L2\uff0c\u200b\u662f\u200bV4L\u200b\u7684\u200b\u6539\u8fdb\u7248\u200b\u3002V4L2\u200b\u652f\u6301\u200b\u4e09\u79cd\u200b\u65b9\u5f0f\u200b\u6765\u200b\u91c7\u96c6\u200b\u56fe\u50cf\u200b\uff1a\u200b\u5185\u5b58\u200b\u6620\u5c04\u200b\u65b9\u5f0f\u200b(mmap)\u3001\u200b\u76f4\u63a5\u200b\u8bfb\u53d6\u200b\u65b9\u5f0f\u200b(read)\u200b\u548c\u200b\u7528\u6237\u200b\u6307\u9488\u200b\u3002\u200b\u5185\u5b58\u200b\u6620\u5c04\u200b\u7684\u200b\u65b9\u5f0f\u200b\u91c7\u96c6\u200b\u901f\u5ea6\u200b\u8f83\u200b\u5feb\u200b\uff0c\u200b\u4e00\u822c\u200b\u7528\u4e8e\u200b\u8fde\u7eed\u200b\u89c6\u9891\u200b\u6570\u636e\u200b\u7684\u200b\u91c7\u96c6\u200b\uff0c\u200b\u5b9e\u9645\u200b\u5de5\u4f5c\u200b\u4e2d\u200b\u7684\u200b\u5e94\u7528\u200b\u6982\u7387\u200b\u66f4\u9ad8\u200b\uff1b\u200b\u76f4\u63a5\u200b\u8bfb\u53d6\u200b\u7684\u200b\u65b9\u5f0f\u200b\u76f8\u5bf9\u200b\u901f\u5ea6\u6162\u200b\u4e00\u4e9b\u200b\uff0c\u200b\u6240\u4ee5\u200b\u5e38\u7528\u200b\u4e8e\u200b\u9759\u6001\u200b\u56fe\u7247\u200b\u6570\u636e\u200b\u7684\u200b\u91c7\u96c6\u200b\uff1b\u200b\u7528\u6237\u200b\u6307\u9488\u200b\u4f7f\u7528\u200b\u8f83\u200b\u5c11\u200b\uff0c\u200b\u5982\u200b\u6709\u200b\u5174\u8da3\u200b\u53ef\u200b\u81ea\u884c\u200b\u7814\u7a76\u200b\u3002</p>"},{"location":"13_V4L2/01_1/#11-buffer","title":"1.1 buffer\u200b\u7684\u200b\u7ba1\u7406","text":"<p>\u200b\u4f7f\u7528\u200b\u6444\u50cf\u5934\u200b\u65f6\u200b\uff0c\u200b\u6838\u5fc3\u200b\u662f\u200b\"\u200b\u83b7\u5f97\u200b\u6570\u636e\u200b\"\u3002\u200b\u6240\u4ee5\u200b\u5148\u8bb2\u200b\u5982\u4f55\u200b\u83b7\u53d6\u6570\u636e\u200b\uff0c\u200b\u5373\u200b\u5982\u4f55\u200b\u5f97\u5230\u200bbuffer\u3002</p> <p>\u200b\u6444\u50cf\u5934\u200b\u91c7\u96c6\u200b\u6570\u636e\u200b\u65f6\u200b\uff0c\u200b\u662f\u200b\u4e00\u5e27\u200b\u53c8\u200b\u4e00\u5e27\u200b\u5730\u200b\u8fde\u7eed\u200b\u91c7\u96c6\u200b\u3002\u200b\u6240\u4ee5\u200b\u9700\u8981\u200b\u7533\u8bf7\u200b\u82e5\u5e72\u4e2a\u200bbuffer\uff0c\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u628a\u200b\u6570\u636e\u200b\u653e\u5165\u200bbuffer\uff0cAPP\u200b\u4ece\u200bbuffer\u200b\u5f97\u5230\u200b\u6570\u636e\u200b\u3002\u200b\u8fd9\u4e9b\u200bbuffer\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u94fe\u8868\u200b\u6765\u200b\u7ba1\u7406\u200b\u3002</p> <p>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5468\u800c\u590d\u59cb\u200b\u5730\u200b\u505a\u200b\u5982\u4e0b\u200b\u4e8b\u60c5\u200b\uff1a</p> <ul> <li>\u200b\u4ece\u200b\u786c\u4ef6\u200b\u91c7\u96c6\u200b\u5230\u200b\u6570\u636e\u200b</li> <li>\u200b\u628a\u200b\"\u200b\u7a7a\u95f2\u200b\u94fe\u8868\u200b\"\u200b\u53d6\u51fa\u200bbuffer\uff0c\u200b\u628a\u200b\u6570\u636e\u200b\u5b58\u5165\u200bbuffer</li> <li>\u200b\u628a\u200b\u542b\u6709\u200b\u6570\u636e\u200b\u7684\u200bbuffer\u200b\u653e\u5165\u200b\"\u200b\u5b8c\u6210\u200b\u94fe\u8868\u200b\"</li> </ul> <p>APP\u200b\u4e5f\u200b\u4f1a\u200b\u5468\u800c\u590d\u59cb\u200b\u5730\u200b\u505a\u200b\u5982\u4e0b\u200b\u4e8b\u60c5\u200b\uff1a</p> <ul> <li>\u200b\u76d1\u6d4b\u200b\"\u200b\u5b8c\u6210\u200b\u94fe\u8868\u200b\"\uff0c\u200b\u7b49\u5f85\u200b\u5b83\u200b\u542b\u6709\u200bbuffer</li> <li>\u200b\u4ece\u200b\"\u200b\u5b8c\u6210\u200b\u94fe\u8868\u200b\"\u200b\u4e2d\u200b\u53d6\u51fa\u200bbuffer</li> <li>\u200b\u5904\u7406\u200b\u6570\u636e\u200b</li> <li>\u200b\u628a\u200bbuffer\u200b\u653e\u5165\u200b\"\u200b\u7a7a\u95f2\u200b\u94fe\u8868\u200b\"</li> </ul> <p>\u200b\u94fe\u8868\u200b\u64cd\u4f5c\u200b\u793a\u610f\u56fe\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"13_V4L2/01_1/#12","title":"1.2 \u200b\u5b8c\u6574\u200b\u7684\u200b\u4f7f\u7528\u200b\u6d41\u7a0b","text":"<p>\u200b\u53c2\u8003\u200bmjpg-streamer\u200b\u548c\u200bvideo2lcd\uff0c\u200b\u603b\u7ed3\u200b\u4e86\u200b\u6444\u50cf\u5934\u200b\u7684\u200b\u4f7f\u7528\u200b\u6d41\u7a0b\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>open\uff1a\u200b\u6253\u5f00\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b/dev/videoX</li> <li>ioctl VIDIOC_QUERYCAP\uff1aQuery Capbility\uff0c\u200b\u67e5\u8be2\u200b\u80fd\u529b\u200b\uff0c\u200b\u6bd4\u5982\u200b</li> <li>\u200b\u786e\u8ba4\u200b\u5b83\u200b\u662f\u5426\u662f\u200b\"\u200b\u6355\u83b7\u200b\u8bbe\u5907\u200b\"\uff0c\u200b\u56e0\u4e3a\u200b\u6709\u4e9b\u200b\u8282\u70b9\u200b\u662f\u200b\u8f93\u51fa\u8bbe\u5907\u200b</li> <li>\u200b\u786e\u8ba4\u200b\u5b83\u200b\u662f\u5426\u200b\u652f\u6301\u200bmmap\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u8fd8\u662f\u200b\u4ec5\u200b\u652f\u6301\u200bread/write\u200b\u64cd\u4f5c\u200b</li> <li>ioctl VIDIOC_ENUM_FMT\uff1a\u200b\u679a\u4e3e\u200b\u5b83\u200b\u652f\u6301\u200b\u7684\u200b\u683c\u5f0f\u200b</li> <li>ioctl VIDIOC_S_FMT\uff1a\u200b\u5728\u200b\u4e0a\u9762\u200b\u679a\u4e3e\u200b\u51fa\u6765\u200b\u7684\u200b\u683c\u5f0f\u200b\u91cc\u200b\uff0c\u200b\u9009\u62e9\u200b\u4e00\u4e2a\u200b\u6765\u200b\u8bbe\u7f6e\u200b\u683c\u5f0f\u200b</li> <li>ioctl VIDIOC_REQBUFS\uff1a\u200b\u7533\u8bf7\u200bbuffer\uff0cAPP\u200b\u53ef\u4ee5\u200b\u7533\u8bf7\u200b\u5f88\u591a\u200b\u4e2a\u200bbuffer\uff0c\u200b\u4f46\u662f\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e0d\u200b\u4e00\u5b9a\u200b\u80fd\u200b\u7533\u8bf7\u200b\u5230\u200b</li> <li>ioctl VIDIOC_QUERYBUF\u200b\u548c\u200bmmap\uff1a\u200b\u67e5\u8be2\u200bbuffer\u200b\u4fe1\u606f\u200b\u3001\u200b\u6620\u5c04\u200b</li> <li>\u200b\u5982\u679c\u200b\u7533\u8bf7\u200b\u5230\u200b\u4e86\u200bN\u200b\u4e2a\u200bbuffer\uff0c\u200b\u8fd9\u4e2a\u200bioctl\u200b\u5c31\u200b\u5e94\u8be5\u200b\u6267\u884c\u200bN\u200b\u6b21\u200b</li> <li>\u200b\u6267\u884c\u200bmmap\u200b\u540e\u200b\uff0cAPP\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u76f4\u63a5\u200b\u8bfb\u5199\u200b\u8fd9\u4e9b\u200bbuffer</li> <li>ioctl VIDIOC_QBUF\uff1a\u200b\u628a\u200bbuffer\u200b\u653e\u5165\u200b\"\u200b\u7a7a\u95f2\u200b\u94fe\u8868\u200b\"</li> <li>\u200b\u5982\u679c\u200b\u7533\u8bf7\u200b\u5230\u200b\u4e86\u200bN\u200b\u4e2a\u200bbuffer\uff0c\u200b\u8fd9\u4e2a\u200bioctl\u200b\u5c31\u200b\u5e94\u8be5\u200b\u6267\u884c\u200bN\u200b\u6b21\u200b</li> <li>ioctl VIDIOC_STREAMON\uff1a\u200b\u542f\u52a8\u200b\u6444\u50cf\u5934\u200b</li> <li>\u200b\u8fd9\u91cc\u200b\u662f\u200b\u4e00\u4e2a\u200b\u5faa\u73af\u200b\uff1a\u200b\u4f7f\u7528\u200bpoll/select\u200b\u76d1\u6d4b\u200bbuffer\uff0c\u200b\u7136\u540e\u200b\u4ece\u200b\"\u200b\u5b8c\u6210\u200b\u94fe\u8868\u200b\"\u200b\u4e2d\u200b\u53d6\u51fa\u200bbuffer\uff0c\u200b\u5904\u7406\u200b\u540e\u200b\u518d\u200b\u653e\u5165\u200b\"\u200b\u7a7a\u95f2\u200b\u94fe\u8868\u200b\"</li> <li>poll/select</li> <li>ioctl VIDIOC_DQBUF\uff1a\u200b\u4ece\u200b\"\u200b\u5b8c\u6210\u200b\u94fe\u8868\u200b\"\u200b\u4e2d\u200b\u53d6\u51fa\u200bbuffer</li> <li>\u200b\u5904\u7406\u200b\uff1a\u200b\u524d\u9762\u200b\u4f7f\u7528\u200bmmap\u200b\u6620\u5c04\u200b\u4e86\u200b\u6bcf\u4e2a\u200bbuffer\u200b\u7684\u200b\u5730\u5740\u200b\uff0c\u200b\u5904\u7406\u200b\u65f6\u200b\u5c31\u200b\u53ef\u4ee5\u200b\u76f4\u63a5\u200b\u4f7f\u7528\u200b\u5730\u5740\u200b\u6765\u200b\u8bbf\u95ee\u200bbuffer</li> <li>ioclt VIDIOC_QBUF\uff1a\u200b\u628a\u200bbuffer\u200b\u653e\u5165\u200b\"\u200b\u7a7a\u95f2\u200b\u94fe\u8868\u200b\"</li> <li>ioctl VIDIOC_STREAMOFF\uff1a\u200b\u505c\u6b62\u200b\u6444\u50cf\u5934\u200b</li> </ul>"},{"location":"13_V4L2/01_1/#2","title":"2. \u200b\u63a7\u5236\u200b\u6d41\u7a0b","text":"<p>\u200b\u4f7f\u7528\u200b\u6444\u50cf\u5934\u200b\u65f6\u200b\uff0c\u200b\u6211\u4eec\u200b\u53ef\u4ee5\u200b\u8c03\u6574\u200b\u5f88\u591a\u200b\u53c2\u6570\u200b\uff0c\u200b\u6bd4\u5982\u200b\uff1a</p> <ul> <li>\u200b\u5bf9\u4e8e\u200b\u89c6\u9891\u6d41\u200b\u672c\u8eab\u200b\uff1a</li> <li>\u200b\u8bbe\u7f6e\u200b\u683c\u5f0f\u200b\uff1a\u200b\u6bd4\u5982\u200bV4L2_PIX_FMT_YUYV\u3001V4L2_PIX_FMT_MJPEG\u3001V4L2_PIX_FMT_RGB565</li> <li> <p>\u200b\u8bbe\u7f6e\u200b\u5206\u8fa8\u7387\u200b\uff1a1024*768\u200b\u7b49\u200b</p> </li> <li> <p>\u200b\u5bf9\u4e8e\u200b\u63a7\u5236\u200b\u90e8\u5206\u200b\uff1a</p> </li> <li>\u200b\u8c03\u8282\u200b\u4eae\u5ea6\u200b</li> <li>\u200b\u8c03\u8282\u200b\u5bf9\u6bd4\u5ea6\u200b</li> <li>\u200b\u8c03\u8282\u200b\u8272\u5ea6\u200b</li> </ul>"},{"location":"13_V4L2/01_1/#21-app","title":"2.1 APP\u200b\u63a5\u53e3","text":"<p>\u200b\u5c31\u200bAPP\u200b\u800c\u8a00\u200b\uff0c\u200b\u5bf9\u4e8e\u200b\u8fd9\u4e9b\u200b\u53c2\u6570\u200b\u6709\u200b3\u200b\u5957\u200b\u63a5\u53e3\u200b\uff1a\u200b\u67e5\u8be2\u200b\u6216\u200b\u679a\u4e3e\u200b(Query/Enum)\u3001\u200b\u83b7\u5f97\u200b(Get)\u3001\u200b\u8bbe\u7f6e\u200b(Set)\u3002</p>"},{"location":"13_V4L2/01_1/#211","title":"2.1.1 \u200b\u6570\u636e\u683c\u5f0f","text":"<p>\u200b\u4ee5\u200b\u8bbe\u7f6e\u200b\u6570\u636e\u683c\u5f0f\u200b\u4e3a\u4f8b\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5148\u200b\u679a\u4e3e\u200b\uff1a</p> <pre><code>struct v4l2_fmtdesc fmtdesc;\nfmtdesc.index = 0;  // \u200b\u6bd4\u5982\u200b\u4ece\u200b0\u200b\u5f00\u59cb\u200b\nfmtdesc.type  = V4L2_BUF_TYPE_VIDEO_CAPTURE;  // \u200b\u6307\u5b9a\u200btype\u200b\u4e3a\u200b\"\u200b\u6355\u83b7\u200b\"\nioctl(vd-&gt;fd, VIDIOC_ENUM_FMT, &amp;fmtdesc);\n\n#if 0\n/*\n *  F O R M A T   E N U M E R A T I O N\n */\nstruct v4l2_fmtdesc {\n    __u32           index;             /* Format number      */\n    __u32           type;              /* enum v4l2_buf_type */\n    __u32               flags;\n    __u8            description[32];   /* Description string */\n    __u32           pixelformat;       /* Format fourcc      */\n    __u32           reserved[4];\n};\n#endif\n</code></pre> <p>\u200b\u8fd8\u200b\u53ef\u4ee5\u200b\u83b7\u5f97\u200b\u5f53\u524d\u200b\u7684\u200b\u683c\u5f0f\u200b\uff1a</p> <pre><code>struct v4l2_format currentFormat;\nmemset(&amp;currentFormat, 0, sizeof(struct v4l2_format));\ncurrentFormat.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;\nioctl(vd-&gt;fd, VIDIOC_G_FMT, &amp;currentFormat);\n\n#if 0\nstruct v4l2_format {\n    __u32    type;\n    union {\n        struct v4l2_pix_format      pix;     /* V4L2_BUF_TYPE_VIDEO_CAPTURE */\n        struct v4l2_pix_format_mplane   pix_mp;  /* V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE */\n        struct v4l2_window      win;     /* V4L2_BUF_TYPE_VIDEO_OVERLAY */\n        struct v4l2_vbi_format      vbi;     /* V4L2_BUF_TYPE_VBI_CAPTURE */\n        struct v4l2_sliced_vbi_format   sliced;  /* V4L2_BUF_TYPE_SLICED_VBI_CAPTURE */\n        struct v4l2_sdr_format      sdr;     /* V4L2_BUF_TYPE_SDR_CAPTURE */\n        __u8    raw_data[200];                   /* user-defined */\n    } fmt;\n};\n\n/*\n *  V I D E O   I M A G E   F O R M A T\n */\nstruct v4l2_pix_format {v4l2_format\n    __u32               width;\n    __u32           height;\n    __u32           pixelformat;\n    __u32           field;      /* enum v4l2_field */\n    __u32               bytesperline;   /* for padding, zero if unused */\n    __u32               sizeimage;\n    __u32           colorspace; /* enum v4l2_colorspace */\n    __u32           priv;       /* private data, depends on pixelformat */\n    __u32           flags;      /* format flags (V4L2_PIX_FMT_FLAG_*) */\n    __u32           ycbcr_enc;  /* enum v4l2_ycbcr_encoding */\n    __u32           quantization;   /* enum v4l2_quantization */\n    __u32           xfer_func;  /* enum v4l2_xfer_func */\n};\n#endif\n</code></pre> <p>\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u8bbe\u7f6e\u200b\u5f53\u524d\u200b\u7684\u200b\u683c\u5f0f\u200b\uff1a</p> <pre><code>struct v4l2_format fmt;\nmemset(&amp;fmt, 0, sizeof(struct v4l2_format));\nfmt.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;\nfmt.fmt.pix.width = 1024;\nfmt.fmt.pix.height = 768;\nfmt.fmt.pix.pixelformat = V4L2_PIX_FMT_MJPEG;\nfmt.fmt.pix.field = V4L2_FIELD_ANY;\nint ret = ioctl(vd-&gt;fd, VIDIOC_S_FMT, &amp;fmt);\n</code></pre>"},{"location":"13_V4L2/01_1/#212","title":"2.1.2 \u200b\u9009\u62e9\u200b\u8f93\u5165\u200b\u6e90","text":"<p>\u200b\u53ef\u4ee5\u200b\u83b7\u5f97\u200b\u5f53\u671f\u200b\u8f93\u5165\u200b\u6e90\u200b\u3001\u200b\u8bbe\u7f6e\u200b\u5f53\u524d\u200b\u8f93\u5165\u200b\u6e90\u200b\uff1a</p> <pre><code>int value;\nioctl(h-&gt;fd,VIDIOC_G_INPUT,&amp;value);  // \u200b\u8bfb\u5230\u200b\u7684\u200bvalue\u200b\u4ece\u200b0\u200b\u5f00\u59cb\u200b, 0\u200b\u8868\u793a\u200b\u7b2c\u200b1\u200b\u4e2a\u200binput\u200b\u6e90\u200b\n\nint value = 0;  // 0\u200b\u8868\u793a\u200b\u7b2c\u200b1\u200b\u4e2a\u200binput\u200b\u6e90\u200b\nioctl(h-&gt;fd,VIDIOC_S_INPUT,&amp;value)\n</code></pre>"},{"location":"13_V4L2/01_1/#213","title":"2.1.3 \u200b\u5176\u4ed6\u200b\u53c2\u6570","text":"<p>\u200b\u5982\u679c\u200b\u6bcf\u4e00\u200b\u53c2\u6570\u200b\u90fd\u200b\u63d0\u4f9b\u200b\u4e00\u7cfb\u5217\u200b\u7684\u200bioctl cmd\uff0c\u200b\u90a3\u200b\u4f7f\u7528\u200b\u8d77\u6765\u200b\u5f88\u200b\u4e0d\u200b\u65b9\u4fbf\u200b\u3002</p> <p>\u200b\u5bf9\u4e8e\u200b\u8fd9\u4e9b\u200b\u53c2\u6570\u200b\uff0cAPP\u200b\u4f7f\u7528\u200b\u5bf9\u5e94\u200bID\u200b\u6765\u200b\u9009\u4e2d\u200b\u5b83\u200b\uff0c\u200b\u7136\u540e\u200b\u4f7f\u7528\u200bVIDIOC_QUERYCTRL\u3001VIDIOC_G_CTRL\u3001VIDIOC_S_CTRL\u200b\u6765\u200b\u64cd\u4f5c\u200b\u5b83\u200b\u3002</p> <p>\u200b\u4e0d\u540c\u200b\u53c2\u6570\u200b\u7684\u200bID\u200b\u503c\u200b\u4e0d\u540c\u200b\u3002</p> <p>\u200b\u4ee5\u200b\u4eae\u5ea6\u200bBrightness\u200b\u4e3a\u4f8b\u200b\uff0c\u200b\u6709\u200b\u5982\u4e0b\u200b\u8c03\u7528\u200b\u65b9\u6cd5\u200b:</p> <ul> <li>\u200b\u67e5\u8be2\u200b\uff1a</li> </ul> <pre><code>struct v4l2_queryctrl   qctrl;\nmemset(&amp;qctrl, 0, sizeof(qctrl));\nqctrl.id = V4L2_CID_BRIGHTNESS; // V4L2_CID_BASE+0;\nioctl(fd, VIDIOC_QUERYCTRL, &amp;qctrl);\n\n/*  Used in the VIDIOC_QUERYCTRL ioctl for querying controls */\nstruct v4l2_queryctrl {\n    __u32            id;\n    __u32            type;  /* enum v4l2_ctrl_type */\n    __u8             name[32];  /* Whatever */\n    __s32            minimum;   /* Note signedness */\n    __s32            maximum;\n    __s32            step;\n    __s32            default_value;\n    __u32                flags;\n    __u32            reserved[2];\n};\n</code></pre> <ul> <li>\u200b\u83b7\u5f97\u200b\u5f53\u524d\u200b\u503c\u200b</li> </ul> <pre><code>struct v4l2_control c;\nc.id = V4L2_CID_BRIGHTNESS; // V4L2_CID_BASE+0;\nioctl(h-&gt;fd, VIDIOC_G_CTRL, &amp;c);\n\n\n/*\n *  C O N T R O L S\n */\nstruct v4l2_control {\n    __u32            id;\n    __s32            value;\n};\n</code></pre> <ul> <li>\u200b\u8bbe\u7f6e\u200b</li> </ul> <pre><code>struct v4l2_control c;\nc.id = V4L2_CID_BRIGHTNESS; // V4L2_CID_BASE+0;\nc.value = 99;\nioctl(h-&gt;fd, VIDIOC_S_CTRL, &amp;c);\n</code></pre>"},{"location":"13_V4L2/01_1/#22","title":"2.2 \u200b\u7406\u89e3\u200b\u63a5\u53e3","text":""},{"location":"13_V4L2/01_1/#221","title":"2.2.1 \u200b\u6982\u5ff5","text":"<p>\u200b\u4ee5\u200bUSB\u200b\u6444\u50cf\u5934\u200b\u4e3a\u4f8b\u200b\uff0c\u200b\u5b83\u200b\u7684\u200b\u5185\u90e8\u7ed3\u6784\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u4e00\u4e2a\u200bUSB\u200b\u6444\u50cf\u5934\u200b\u5fc5\u5b9a\u200b\u6709\u200b\u4e00\u4e2a\u200bVideoControl\u200b\u63a5\u53e3\u200b\uff0c\u200b\u7528\u4e8e\u200b\u63a7\u5236\u200b\u3002\u200b\u6709\u200b0\u200b\u4e2a\u200b\u6216\u200b\u591a\u4e2a\u200bVideoStreaming\u200b\u63a5\u53e3\u200b\uff0c\u200b\u7528\u4e8e\u200b\u4f20\u8f93\u200b\u89c6\u9891\u200b\u3002</p> <p>\u200b\u5728\u200bVideoControl\u200b\u5185\u90e8\u200b\uff0c\u200b\u6709\u200b\u591a\u4e2a\u200bUnit\u200b\u6216\u200bTerminal\uff0c\u200b\u4e0a\u200b\u4e00\u4e2a\u200bUnit\u200b\u6216\u200bTerminal\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u6d41\u5411\u200b\u4e0b\u200b\u4e00\u4e2a\u200bUnit\u200b\u6216\u200bTerminal\uff0c\u200b\u591a\u4e2a\u200bUnit\u200b\u6216\u200bTerminal\u200b\u7ec4\u6210\u200b\u4e00\u4e2a\u200b\u5b8c\u6574\u200b\u7684\u200bUVC\u200b\u529f\u80fd\u200b\u8bbe\u5907\u200b\u3002</p> <ul> <li> <p>\u200b\u53ea\u6709\u200b\u4e00\u4e2a\u200b\u8f93\u51fa\u200b\u5f15\u811a\u200b   </p> </li> <li> <p>\u200b\u53ef\u4ee5\u200bFan-out\uff0c\u200b\u4e0d\u80fd\u200bFan-in   </p> </li> <li> <p>Terminal\uff1a\u200b\u4f4d\u4e8e\u200b\u8fb9\u754c\u200b\uff0c\u200b\u7528\u4e8e\u200b\u8054\u901a\u200b\u5916\u754c\u200b\u3002\u200b\u6709\u200b\uff1aIT(Input Terminal)\u3001OT(Output Terminal)\u3001CT(Camera Terminal)\u3002\u200b\u6a21\u578b\u200b\u5982\u4e0b\u200b\uff0c\u200b\u6709\u200b\u4e00\u4e2a\u200b\u8f93\u51fa\u200b\u5f15\u811a\u200b\uff1a</p> </li> </ul> <p></p> <ul> <li>Unit\uff1a\u200b\u4f4d\u4e8e\u200bVideoControl\u200b\u5185\u90e8\u200b\uff0c\u200b\u7528\u6765\u200b\u8fdb\u884c\u200b\u5404\u79cd\u200b\u63a7\u5236\u200b</li> <li>SU\uff1aSelector Unit(\u200b\u9009\u62e9\u200b\u5355\u5143\u200b)\uff0c\u200b\u4ece\u200b\u591a\u8def\u200b\u8f93\u5165\u200b\u4e2d\u200b\u9009\u62e9\u200b\u4e00\u8def\u200b\uff0c\u200b\u6bd4\u5982\u200b\u8bbe\u5907\u200b\u652f\u6301\u200b\u591a\u79cd\u200b\u8f93\u5165\u200b\u6e90\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u901a\u8fc7\u200bSU\u200b\u8fdb\u884c\u200b\u9009\u62e9\u200b\u5207\u6362\u200b\u3002\u200b\u6a21\u578b\u200b\u5982\u4e0b\u200b     </li> <li>PU\uff1aPorocessing Unit(\u200b\u5904\u7406\u5355\u5143\u200b)\uff0c\u200b\u7528\u4e8e\u200b\u8c03\u6574\u200b\u4eae\u5ea6\u200b\u3001\u200b\u5bf9\u6bd4\u5ea6\u200b\u3001\u200b\u8272\u5ea6\u200b\u7b49\u200b\uff0c\u200b\u6709\u200b\u5982\u4e0b\u200b\u63a7\u5236\u200b\u529f\u80fd\u200b\uff1a<ul> <li>User Controls</li> <li>Brightness \u200b\u80cc\u5149\u200b</li> <li>Hue \u200b\u8272\u5ea6\u200b</li> <li>Saturation \u200b\u9971\u548c\u5ea6\u200b</li> <li>Sharpness \u200b\u9510\u5ea6\u200b</li> <li>Gamma \u200b\u4f3d\u9a6c\u200b</li> <li>Digital Multiplier (Zoom) \u200b\u6570\u5b57\u200b\u653e\u5927\u200b</li> <li>Auto Controls</li> <li>White Balance Temperature \u200b\u767d\u5e73\u8861\u200b\u8272\u6e29\u200b</li> <li>White Balance Component \u200b\u767d\u5e73\u8861\u200b\u7ec4\u4ef6\u200b</li> <li>Backlight Compensation \u200b\u80cc\u5149\u200b\u8865\u507f\u200b</li> <li>Contrast \u200b\u5bf9\u6bd4\u5ea6\u200b</li> <li>Other</li> <li>Gain \u200b\u589e\u76ca\u200b</li> <li>Power Line Frequency \u200b\u7535\u6e90\u7ebf\u200b\u9891\u7387\u200b</li> <li>Analog Video Standard \u200b\u6a21\u62df\u200b\u89c6\u9891\u200b\u6807\u51c6\u200b</li> <li>Analog Video Lock Status \u200b\u6a21\u62df\u200b\u89c6\u9891\u200b\u9501\u200b\u72b6\u6001\u200b</li> <li>\u200b\u6a21\u578b\u200b\u5982\u4e0b\u200b   </li> </ul> </li> <li>EU\uff1aEncoding Unit(\u200b\u7f16\u7801\u200b\u5355\u5143\u200b)\uff0c\u200b\u5bf9\u200b\u91c7\u96c6\u200b\u6240\u5f97\u200b\u7684\u200b\u6570\u636e\u200b\u8fdb\u884c\u200b\u4e2a\u6027\u5316\u200b\u5904\u7406\u200b\u7684\u200b\u529f\u80fd\u200b\u3002\u200b\u7f16\u7801\u200b\u5355\u5143\u200b\u63a7\u5236\u200b\u7f16\u7801\u5668\u200b\u7684\u200b\u5c5e\u6027\u200b\uff0c\u200b\u8be5\u200b\u7f16\u7801\u5668\u200b\u5bf9\u200b\u901a\u8fc7\u200b\u5b83\u200b\u6d41\u5f0f\u200b\u4f20\u8f93\u200b\u7684\u200b\u89c6\u9891\u200b\u8fdb\u884c\u200b\u7f16\u7801\u200b\u3002\u200b\u5b83\u200b\u5177\u6709\u200b\u5982\u4e0b\u200b\u529f\u80fd\u200b\uff1a     </li> <li> <p>\u200b\u6a21\u578b\u200b\u5982\u4e0b\u200b     </p> </li> <li> <p>XU\uff1aExtension Unit(\u200b\u6269\u5c55\u200b\u5355\u5143\u200b)\uff0c\u200b\u5382\u5bb6\u200b\u53ef\u4ee5\u200b\u5728\u200bXU\u200b\u4e0a\u200b\u63d0\u4f9b\u200b\u81ea\u5b9a\u4e49\u200b\u7684\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u6a21\u578b\u200b\u5982\u4e0b\u200b\uff1a   </p> </li> </ul>"},{"location":"13_V4L2/01_1/#222","title":"2.2.2 \u200b\u64cd\u4f5c\u65b9\u6cd5","text":"<p>\u200b\u6211\u4eec\u200b\u4f7f\u7528\u200bioctl\u200b\u64cd\u4f5c\u200b\u8bbe\u5907\u200b\u8282\u70b9\u200b\"/dev/video0\"\u200b\u65f6\u200b\uff0c\u200b\u4e0d\u540c\u200b\u7684\u200bioctl\u200b\u64cd\u4f5c\u200b\u7684\u200b\u53ef\u80fd\u200b\u662f\u200bVideoControl\u200b\u63a5\u53e3\u200b\uff0c\u200b\u6216\u8005\u200bVideoStreaming\u200b\u63a5\u53e3\u200b\u3002</p> <p>\u200b\u8ddf\u200b\u89c6\u9891\u6d41\u200b\u76f8\u5173\u200b\u7684\u200b\u64cd\u4f5c\u200b\uff0c\u200b\u6bd4\u5982\u200b\uff1aVIDIOC_ENUM_FMT\u3001VIDIOC_G_FMT\u3001VIDIOC_S_FMT\u3001VIDIOC_STREAMON\u3001VIDIOC_STREAMOFF\uff0c\u200b\u662f\u200b\u64cd\u4f5c\u200bVideoStreaming\u200b\u63a5\u53e3\u200b\u3002</p> <p>\u200b\u5176\u4ed6\u200bioctl\uff0c\u200b\u5927\u591a\u200b\u90fd\u200b\u662f\u200b\u64cd\u4f5c\u200bVideoControl\u200b\u63a5\u53e3\u200b\u3002</p> <p>\u200b\u4ece\u200b\u5e95\u5c42\u200b\u9a71\u52a8\u200b\u548c\u200b\u786c\u4ef6\u200b\u89d2\u5ea6\u770b\u200b\uff0c\u200b\u8981\u200b\u64cd\u4f5c\u200bVideoControl\u200b\u63a5\u53e3\u200b\uff0c\u200b\u9700\u8981\u200b\u6307\u660e\u200b\uff1a</p> <ul> <li>entity\uff1a\u200b\u4f60\u200b\u8981\u200b\u64cd\u4f5c\u200b\u54ea\u4e2a\u200bTerminal\u200b\u6216\u200bUnit\uff0c\u200b\u6bd4\u5982\u200bPU</li> <li>Control Selector\uff1a\u200b\u4f60\u200b\u8981\u200b\u64cd\u4f5c\u200bentity\u200b\u91cc\u9762\u200b\u7684\u200b\u54ea\u4e2a\u200b\u63a7\u5236\u200b\u9879\u200b\uff1f\u200b\u6bd4\u5982\u200b\u4eae\u5ea6\u200bPU_BRIGHTNESS_CONTROL</li> <li>\u200b\u63a7\u5236\u200b\u9879\u91cc\u200b\u54ea\u4e9b\u200b\u4f4d\u200b\uff1a\u200b\u6bd4\u5982\u200bCT(Camera Terminal)\u200b\u91cc\u200b\u7684\u200bCT_PANTILT_RELATIVE_CONTROL\u200b\u63a7\u5236\u200b\u9879\u200b\u5bf9\u5e94\u200b32\u200b\u4f4d\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u5176\u4e2d\u200b\u524d\u200b16\u200b\u4f4d\u200b\u5bf9\u5e94\u200bPAN\u200b\u63a7\u5236\u200b(\u200b\u5de6\u53f3\u200b\u8f6c\u52a8\u200b)\uff0c\u200b\u540e\u200b16\u200b\u4f4d\u200b\u5bf9\u5e94\u200bTILE\u200b\u63a7\u5236\u200b(\u200b\u4e0a\u4e0b\u200b\u8f6c\u52a8\u200b)</li> </ul> <p>\u200b\u4f46\u662f\u200bAPP\u200b\u4e0d\u200b\u5173\u6ce8\u200b\u8fd9\u4e9b\u200b\u7ec6\u8282\u200b\uff0c\u200b\u4f7f\u7528\u200b\u4e00\u4e2a\u200bID\u200b\u6765\u200b\u6307\u5b9a\u200bentity\u3001Control Selector\u3001\u200b\u54ea\u4e9b\u200b\u4f4d\u200b\uff1a</p> <pre><code>/*\n *  C O N T R O L S\n */\nstruct v4l2_control {\n    __u32            id;\n    __s32            value;\n};\n</code></pre> <p>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u91cc\u200b\uff0c\u200b\u4f1a\u200b\u89e3\u6790\u200bAPP\u200b\u4f20\u5165\u200b\u7684\u200bID\uff0c\u200b\u627e\u5230\u200bentity\u3001Control Selector\u3001\u200b\u90a3\u4e9b\u200b\u4f4d\u200b\u3002</p> <p>\u200b\u4f46\u662f\u200b\u6709\u200b\u4e86\u200b\u4e0a\u8ff0\u200b\u77e5\u8bc6\u200b\u540e\u200b\uff0c\u200b\u6211\u4eec\u200b\u624d\u200b\u80fd\u770b\u61c2\u200bmjpg-streamer\u200b\u7684\u200b\u5982\u4e0b\u200b\u4ee3\u7801\u200b\uff1a</p> <ul> <li> <p>XU\uff1a\u200b\u4f7f\u7528\u200b\u6bd4\u8f83\u200b\u8001\u200b\u7684\u200bUVC\u200b\u9a71\u52a8\u200b\u65f6\u200b\uff0c\u200b\u9700\u8981\u200bAPP\u200b\u4f20\u5165\u200b\u5382\u5bb6\u200b\u7684\u200bXU\u200b\u4fe1\u606f\u200b\uff1b\u200b\u65b0\u200b\u9a71\u52a8\u200b\u91cc\u200b\u53ef\u4ee5\u200b\u89e3\u6790\u200b\u51fa\u200bXU\u200b\u4fe1\u606f\u200b\uff0c\u200b\u65e0\u9700\u200bAPP\u200b\u4f20\u5165\u200b   </p> </li> <li> <p>mapping\uff1a\u200b\u65e0\u8bba\u200b\u65b0\u8001\u200bUVC\u200b\u9a71\u52a8\u200b\uff0c\u200b\u90fd\u200b\u9700\u8981\u200b\u63d0\u4f9b\u200b\u66f4\u200b\u7ec6\u5316\u200b\u7684\u200bmapping\u200b\u4fe1\u606f\u200b</p> </li> </ul> <p></p> <ul> <li>\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b   </li> </ul>"},{"location":"13_V4L2/01_1/#3-app","title":"3. \u200b\u7f16\u5199\u200bAPP","text":"<p>\u200b\u53c2\u8003\u200b\uff1amjpg-streamer\uff0chttps://github.com/jacksonliam/mjpg-streamer</p>"},{"location":"13_V4L2/01_1/#31","title":"3.1 \u200b\u5217\u51fa\u200b\u5e27\u200b\u7ec6\u8282","text":"<p>\u200b\u8c03\u7528\u200bioctl VIDIOC_ENUM_FMT\u200b\u53ef\u4ee5\u200b\u679a\u4e3e\u200b\u6444\u50cf\u5934\u200b\u652f\u6301\u200b\u7684\u200b\u683c\u5f0f\u200b\uff0c\u200b\u4f46\u662f\u200b\u65e0\u6cd5\u200b\u83b7\u5f97\u200b\u66f4\u200b\u591a\u200b\u7ec6\u8282\u200b\uff08\u200b\u6bd4\u5982\u200b\u652f\u6301\u200b\u54ea\u4e9b\u200b\u5206\u8fa8\u7387\u200b\uff09\uff0c</p> <p>\u200b\u8c03\u7528\u200bioctl VIDIOC_G_FMT\u200b\u53ef\u4ee5\u200b\u83b7\u5f97\u200b\"\u200b\u5f53\u524d\u200b\u7684\u200b\u683c\u5f0f\u200b\"\uff0c\u200b\u5305\u62ec\u200b\u5206\u8fa8\u7387\u200b\u7b49\u200b\u7ec6\u8282\u200b\uff0c\u200b\u4f46\u662f\u200b\u65e0\u6cd5\u200b\u83b7\u5f97\u200b\u5176\u4ed6\u200b\u683c\u5f0f\u200b\u7684\u200b\u7ec6\u8282\u200b\u3002</p> <p>\u200b\u9700\u8981\u200b\u7ed3\u5408\u200bVIDIOC_ENUM_FMT\u3001VIDIOC_ENUM_FRAMESIZES\u200b\u8fd9\u200b2\u200b\u4e2a\u200bioctl\u200b\u6765\u200b\u83b7\u5f97\u200b\u8fd9\u4e9b\u200b\u7ec6\u8282\u200b\uff1a</p> <ul> <li>VIDIOC_ENUM_FMT\uff1a\u200b\u679a\u4e3e\u200b\u683c\u5f0f\u200b</li> <li>VIDIOC_ENUM_FRAMESIZES\uff1a\u200b\u679a\u4e3e\u200b\u6307\u5b9a\u200b\u683c\u5f0f\u200b\u7684\u200b\u5e27\u200b\u5927\u5c0f\u200b(\u200b\u5373\u200b\u5206\u8fa8\u7387\u200b)</li> </ul> <p>\u200b\u793a\u4f8b\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>#include &lt;sys/types.h&gt;\n#include &lt;sys/stat.h&gt;\n#include &lt;fcntl.h&gt;\n#include &lt;sys/ioctl.h&gt;\n#include &lt;unistd.h&gt;\n#include &lt;stdio.h&gt;\n#include &lt;string.h&gt;\n#include &lt;linux/types.h&gt;          /* for videodev2.h */\n#include &lt;linux/videodev2.h&gt;\n\n/* ./video_test &lt;/dev/video0&gt; */\n\nint main(int argc, char **argv)\n{\n    int fd;\n    struct v4l2_fmtdesc fmtdesc;\n    struct v4l2_frmsizeenum fsenum;\n    int fmt_index = 0;\n    int frame_index = 0;\n\n    if (argc != 2)\n    {\n        printf(\"Usage: %s &lt;/dev/videoX&gt;, print format detail for video device\\n\", argv[0]);\n        return -1;\n    }\n\n    /* open */\n    fd = open(argv[1], O_RDWR);\n    if (fd &lt; 0)\n    {\n        printf(\"can not open %s\\n\", argv[1]);\n        return -1;\n    }\n\n    while (1)\n    {\n        /* \u200b\u679a\u4e3e\u200b\u683c\u5f0f\u200b */\n        fmtdesc.index = fmt_index;  // \u200b\u6bd4\u5982\u200b\u4ece\u200b0\u200b\u5f00\u59cb\u200b\n        fmtdesc.type  = V4L2_BUF_TYPE_VIDEO_CAPTURE;  // \u200b\u6307\u5b9a\u200btype\u200b\u4e3a\u200b\"\u200b\u6355\u83b7\u200b\"\n        if (0 != ioctl(fd, VIDIOC_ENUM_FMT, &amp;fmtdesc))\n            break;\n\n        frame_index = 0;\n        while (1)\n        {\n            /* \u200b\u679a\u4e3e\u200b\u8fd9\u79cd\u200b\u683c\u5f0f\u200b\u6240\u200b\u652f\u6301\u200b\u7684\u200b\u5e27\u200b\u5927\u5c0f\u200b */\n            memset(&amp;fsenum, 0, sizeof(struct v4l2_frmsizeenum));\n            fsenum.pixel_format = fmtdesc.pixelformat;\n            fsenum.index = frame_index;\n\n            if (ioctl(fd, VIDIOC_ENUM_FRAMESIZES, &amp;fsenum) == 0)\n            {\n                printf(\"format %s,%d, framesize %d: %d x %d\\n\", fmtdesc.description, fmtdesc.pixelformat, frame_index, fsenum.discrete.width, fsenum.discrete.height);\n            }\n            else\n            {\n                break;\n            }\n\n            frame_index++;\n        }\n\n        fmt_index++;\n    }\n\n    return 0;\n}\n</code></pre>"},{"location":"13_V4L2/01_1/#32","title":"3.2 \u200b\u83b7\u53d6\u6570\u636e","text":"<p>\u200b\u6839\u636e\u200b\u300a1.2 \u200b\u5b8c\u6574\u200b\u7684\u200b\u4f7f\u7528\u200b\u6d41\u7a0b\u200b\u300b\u200b\u6765\u200b\u7f16\u5199\u7a0b\u5e8f\u200b\uff0c\u200b\u6b65\u9aa4\u200b\u5982\u4e0b\u200b\uff1a</p> <ul> <li>\u200b\u6253\u5f00\u200b\u8bbe\u5907\u200b</li> <li>ioctl VIDIOC_QUERYCAP\uff1aQuery Capbility\uff0c\u200b\u67e5\u8be2\u200b\u80fd\u529b\u200b</li> <li>\u200b\u679a\u4e3e\u200b\u683c\u5f0f\u200b\u3001\u200b\u8bbe\u7f6e\u200b\u683c\u5f0f\u200b</li> <li>ioctl VIDIOC_REQBUFS\uff1a\u200b\u7533\u8bf7\u200bbuffer</li> <li>ioctl VIDIOC_QUERYBUF\u200b\u548c\u200bmmap\uff1a\u200b\u67e5\u8be2\u200bbuffer\u200b\u4fe1\u606f\u200b\u3001\u200b\u6620\u5c04\u200b</li> <li>ioctl VIDIOC_QBUF\uff1a\u200b\u628a\u200bbuffer\u200b\u653e\u5165\u200b\"\u200b\u7a7a\u95f2\u200b\u94fe\u8868\u200b\"</li> <li>ioctl VIDIOC_STREAMON\uff1a\u200b\u542f\u52a8\u200b\u6444\u50cf\u5934\u200b</li> <li>\u200b\u8fd9\u91cc\u200b\u662f\u200b\u4e00\u4e2a\u200b\u5faa\u73af\u200b\uff1a\u200b\u4f7f\u7528\u200bpoll/select\u200b\u76d1\u6d4b\u200bbuffer\uff0c\u200b\u7136\u540e\u200b\u4ece\u200b\"\u200b\u5b8c\u6210\u200b\u94fe\u8868\u200b\"\u200b\u4e2d\u200b\u53d6\u51fa\u200bbuffer\uff0c\u200b\u5904\u7406\u200b\u540e\u200b\u518d\u200b\u653e\u5165\u200b\"\u200b\u7a7a\u95f2\u200b\u94fe\u8868\u200b\"</li> <li>poll/select</li> <li>ioctl VIDIOC_DQBUF\uff1a\u200b\u4ece\u200b\"\u200b\u5b8c\u6210\u200b\u94fe\u8868\u200b\"\u200b\u4e2d\u200b\u53d6\u51fa\u200bbuffer</li> <li>\u200b\u5904\u7406\u200b\uff1a\u200b\u524d\u9762\u200b\u4f7f\u7528\u200bmmap\u200b\u6620\u5c04\u200b\u4e86\u200b\u6bcf\u4e2a\u200bbuffer\u200b\u7684\u200b\u5730\u5740\u200b\uff0c\u200b\u628a\u200b\u8fd9\u4e2a\u200bbuffer\u200b\u7684\u200b\u6570\u636e\u200b\u5b58\u200b\u4e3a\u200b\u6587\u4ef6\u200b</li> <li>ioclt VIDIOC_QBUF\uff1a\u200b\u628a\u200bbuffer\u200b\u653e\u5165\u200b\"\u200b\u7a7a\u95f2\u200b\u94fe\u8868\u200b\"</li> <li>ioctl VIDIOC_STREAMOFF\uff1a\u200b\u505c\u6b62\u200b\u6444\u50cf\u5934\u200b</li> </ul> <p></p>"},{"location":"13_V4L2/01_1/#33","title":"3.3 \u200b\u63a7\u5236\u200b\u4eae\u5ea6","text":""},{"location":"13_V4L2/02_1/","title":"V4L2\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6846\u67b6","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u200b\u6df1\u5165\u200b\u7406\u89e3\u200blinux\u200b\u5185\u6838\u200bv4l2\u200b\u6846\u67b6\u200b\u4e4b\u200bvideobuf2\uff1ahttps://blog.csdn.net/yyjsword/article/details/9243717</li> <li>V4L2\u200b\u6846\u67b6\u200b-videobuf2\uff1ahttps://blog.csdn.net/u013904227/article/details/81054611</li> </ul>"},{"location":"13_V4L2/02_1/#1","title":"1. \u200b\u6574\u4f53\u200b\u6846\u67b6","text":"<ul> <li>\u200b\u5b57\u7b26\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u7684\u200b\u6838\u5fc3\u200b\u662f\u200b\uff1afile_operations\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> <li>V4L2\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u7684\u200b\u6838\u5fc3\u200b\u662f\u200b\uff1avideo_device\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u5b83\u200b\u91cc\u9762\u200b\u6709\u200b2\u200b\u5927\u200b\u6210\u5458\u200b</li> <li>v4l2_file_operations\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff1a\u200b\u5b9e\u73b0\u200b\u5177\u4f53\u200b\u7684\u200bopen/read/write/ioctl/mmap\u200b\u64cd\u4f5c\u200b</li> <li>v4l2_ioctl_ops\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff1av4l2_file_operations\u200b\u7ed3\u6784\u200b\u4f53\u200b\u4e00\u822c\u200b\u4f7f\u7528\u200bvideo_ioctl2\u200b\u51fd\u6570\u200b\uff0c\u200b\u5b83\u200b\u8981\u200b\u8c03\u7528\u200bv4l2_ioctl_ops\u200b\u7ed3\u6784\u200b\u4f53\u200b</li> </ul>"},{"location":"13_V4L2/02_1/#11-v4l2","title":"1.1 V4L2\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6ce8\u518c\u200b\u6d41\u7a0b","text":"<p>\u200b\u53c2\u8003\u200b<code>drivers\\media\\usb\\airspy\\airspy.c</code>\uff1a</p> <pre><code>static struct video_device airspy_template = {\n    .name                     = \"AirSpy SDR\",\n    .release                  = video_device_release_empty,\n    .fops                     = &amp;airspy_fops,\n    .ioctl_ops                = &amp;airspy_ioctl_ops,\n};\n\n// \u200b\u5206\u914d\u200b/\u200b\u8bbe\u7f6e\u200bvideo_device\u200b\u7ed3\u6784\u200b\u4f53\u200b\ns-&gt;vdev = airspy_template;\n\n// \u200b\u521d\u59cb\u5316\u200b\u4e00\u4e2a\u200bv4l2_device\u200b\u7ed3\u6784\u200b\u4f53\u200b(\u200b\u8d77\u200b\u8f85\u52a9\u200b\u4f5c\u7528\u200b)\n/* Register the v4l2_device structure */\ns-&gt;v4l2_dev.release = airspy_video_release;\nret = v4l2_device_register(&amp;intf-&gt;dev, &amp;s-&gt;v4l2_dev);\n\n// video_device\u200b\u548c\u200b4l2_device\u200b\u5efa\u7acb\u8054\u7cfb\u200b\ns-&gt;vdev.v4l2_dev = &amp;s-&gt;v4l2_dev;\n\n// \u200b\u6ce8\u518c\u200bvideo_device\u200b\u7ed3\u6784\u200b\u4f53\u200b\nret = video_register_device(&amp;s-&gt;vdev, VFL_TYPE_SDR, -1);\n        __video_register_device\n            // \u200b\u6839\u636e\u200b\u6b21\u200b\u8bbe\u5907\u200b\u53f7\u200b\u628a\u200bvideo_device\u200b\u7ed3\u6784\u200b\u4f53\u200b\u653e\u5165\u200b\u6570\u7ec4\u200b\n            video_device[vdev-&gt;minor] = vdev;\n\n            // \u200b\u6ce8\u518c\u200b\u5b57\u7b26\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\n            vdev-&gt;cdev-&gt;ops = &amp;v4l2_fops;\n            vdev-&gt;cdev-&gt;owner = owner;\n            ret = cdev_add(vdev-&gt;cdev, MKDEV(VIDEO_MAJOR, vdev-&gt;minor), 1);\n</code></pre>"},{"location":"13_V4L2/02_1/#12-ioctl","title":"1.2 ioctl\u200b\u8c03\u7528\u200b\u6d41\u7a0b\u200b\u5206\u6790","text":""},{"location":"13_V4L2/02_1/#121-ioctl","title":"1.2.1 \u200b\u4e24\u7c7b\u200bioctl","text":"<p>\u200b\u5e95\u5c42\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u63d0\u4f9b\u200b\u4e86\u200b\u5f88\u591a\u200bioctl\u200b\u7684\u200b\u5904\u7406\u51fd\u6570\u200b\uff0c\u200b\u6bd4\u5982\u200b\uff1a</p> <p></p> <p>\u200b\u8fd9\u4e9b\u200bioctl\u200b\u88ab\u200b\u5206\u4e3a\u200b2\u200b\u7c7b\u200b\uff1a</p> <ul> <li>INFO_FL_STD\uff1a\u200b\u6807\u51c6\u200b\u7684\u200b\uff0c\u200b\u65e0\u9700\u200b\u7279\u6b8a\u200b\u7684\u200b\u4ee3\u7801\u200b\u6765\u200b\u5904\u7406\u200b\uff0cAPP\u200b\u7684\u200b\u8c03\u7528\u200b\u53ef\u4ee5\u200b\u76f4\u8fbe\u200b\u8fd9\u4e9b\u200b\u5904\u7406\u51fd\u6570\u200b</li> <li>INFO_FL_FUNC\uff1a\u200b\u8fd9\u200b\u7c7b\u200bioctl\u200b\u9700\u8981\u200b\u7279\u6b8a\u200b\u5904\u7406\u200b\uff0c\u200b\u6bd4\u5982\u200b\u5bf9\u4e8e\u200b<code>VIDIOC_ENUM_FMT</code>\uff0c\u200b\u5b83\u200b\u9700\u8981\u200b\u6839\u636e\u200b\u8bbe\u5907\u200b\u7684\u200b\u7c7b\u578b\u200b\u5206\u522b\u200b\u679a\u4e3e\u200b\uff1a   </li> </ul> <p>\u200b\u7b80\u5355\u200b\u5730\u8bf4\u200b\uff0c\u200b\u8fd9\u200b2\u200b\u7c7b\u200bioctl\u200b\u7684\u200b\u5dee\u522b\u200b\u5728\u4e8e\u200b\uff1a</p> <ul> <li>INFO_FL_STD\uff1aAPP\u200b\u53d1\u51fa\u200b\u7684\u200bioctl\u200b\u76f4\u63a5\u200b\u8c03\u7528\u200b\u5e95\u5c42\u200b\u7684\u200bvideo_device-&gt;ioctl_ops-&gt;xxxx(....)</li> <li>INFO_FL_FUNC\uff1aAPP\u200b\u53d1\u51fa\u200b\u7684\u200bioctl\uff0c\u200b\u4ea4\u7ed9\u200b<code>drivers\\media\\v4l2-core\\v4l2-ioctl.c</code>\uff0c\u200b\u5b83\u200b\u5148\u200b\u8fdb\u884c\u200b\u4e00\u4e9b\u200b\u7279\u6b8a\u200b\u5904\u7406\u200b\u540e\u200b\uff0c\u200b\u518d\u200b\u8c03\u7528\u200b\u5e95\u5c42\u200b\u7684\u200bvideo_device-&gt;ioctl_ops-&gt;xxxx(....)</li> </ul> <p>\u200b\u600e\u4e48\u200b\u533a\u5206\u200b\u8fd9\u4e9b\u200bioctl\u200b\u5462\u200b\uff1f<code>drivers\\media\\v4l2-core\\v4l2-ioctl.c</code>\u200b\u4e2d\u6709\u200b\u4e2a\u200b\u6570\u7ec4\u200b\uff1a</p> <p></p> <p>\u200b\u8fd9\u4e2a\u200b\u6570\u7ec4\u200b\u91cc\u200b\uff0c\u200b\u6bcf\u4e00\u9879\u200b\u90fd\u200b\u8868\u793a\u200b\u4e00\u4e2a\u200bioctl\uff1a</p> <ul> <li>\u200b\u4f7f\u7528\u200b<code>IOCTL_INFO_FNC</code>\u200b\u5b9a\u4e49\u200b\u7684\u200b\u6570\u7ec4\u200b\u9879\u200b\uff0c\u200b\u8868\u793a\u200b\u5b83\u200b\u662f\u200b<code>INFO_FL_FUNC</code>\u200b\u7c7b\u578b\u200b\u7684\u200b   </li> <li>\u200b\u4f7f\u7528\u200b<code>IOCTL_INFO_STD</code>\u200b\u5b9a\u4e49\u200b\u7684\u200b\u6570\u7ec4\u200b\u9879\u200b\uff0c\u200b\u8868\u793a\u200b\u5b83\u200b\u662f\u200b<code>INFO_FL_STD</code>\u200b\u7c7b\u578b\u200b\u7684\u200b   </li> </ul>"},{"location":"13_V4L2/02_1/#122","title":"1.2.2 \u200b\u8c03\u7528\u200b\u6d41\u7a0b","text":"<p>APP\u200b\u8c03\u7528\u200b\u6444\u50cf\u5934\u200b\u7684\u200bioctl\uff0c\u200b\u6d41\u7a0b\u200b\u4e3a\u200b\uff1a</p> <p></p>"},{"location":"13_V4L2/02_1/#13-buffer","title":"1.3 buffer\u200b\u7684\u200b\u5185\u6838\u200b\u5b9e\u73b0","text":"<p>APP\u200b\u64cd\u4f5c\u200bbuffer\u200b\u7684\u200b\u793a\u610f\u56fe\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e2d\u200b\u5982\u4f55\u200b\u7ba1\u7406\u200b\u8fd9\u4e9b\u200bbuffer\u200b\u5462\u200b\uff1f</p>"},{"location":"13_V4L2/02_1/#131-videobuffer2","title":"1.3.1 videobuffer2\u200b\u7f13\u51b2\u533a\u200b\u7ed3\u6784\u200b\u4f53","text":"<p>\u200b\u5206\u914d\u200b\u6d41\u7a0b\u200b\uff1a</p> <ul> <li>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u521d\u59cb\u5316\u200b\u65f6\u200b\uff0c\u200b\u5c31\u200b\u6784\u9020\u200b\u4e86\u200bvb2_queue\uff0c\u200b\u8fd9\u662f\u200b\"buffer\u200b\u7684\u200b\u961f\u5217\u200b\"\uff0c\u200b\u4e00\u200b\u5f00\u59cb\u200b\u91cc\u9762\u200b\u6ca1\u6709\u200b\"buffer\"</li> <li>APP\u200b\u8c03\u7528\u200bioctl VIDIOC_REQBUFS\u200b\u5411\u200b\u9a71\u52a8\u200b\u7533\u8bf7\u200bN\u200b\u4e2a\u200bbuffer</li> <li>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5206\u914d\u200bn(n&lt;=N)\u200b\u4e2a\u200bvb2_buffer\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u7136\u540e\u200b</li> <li>\u200b\u5bf9\u4e8e\u200b\u666e\u901a\u200b\u6444\u50cf\u5934\u200b\uff0c\u200b\u8fd8\u200b\u5206\u914d\u200b\u4e00\u4e2a\u200bvb2_plane\u200b\u7ed3\u6784\u200b\u4f53\u200b\u3001vb2_vmalloc_buf\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u6700\u540e\u200b\u5206\u914d\u200b\u5b58\u200b\u6570\u636e\u200b\u7684\u200bbuffer</li> <li>\u200b\u5bf9\u4e8e\u200b\u591a\u200b\u5e73\u9762\u200b\u6444\u50cf\u5934\u200b\uff0c\u200b\u7ed9\u200b\u6bcf\u4e2a\u200bvb2_buffer\u200b\u5206\u914d\u200b\u591a\u4e2a\u200b\"vb2_plane\u200b\u7ed3\u6784\u200b\u4f53\u200b\u3001vb2_vmalloc_buf\u200b\u7ed3\u6784\u200b\u4f53\u200b\u3001\u200b\u5b58\u200b\u6570\u636e\u200b\u7684\u200bbuffer\"</li> </ul> <p>\u200b\u5165\u200b\u961f\u5217\u200b\u6d41\u7a0b\u200b\uff1a</p> <ul> <li>APP\u200b\u8c03\u7528\u200bioctl VIDIOC_QBUF</li> <li>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6839\u636e\u200b\u5176\u200bindex\u200b\u627e\u5230\u200bvb2_buffer</li> <li>\u200b\u628a\u200b\u8fd9\u4e2a\u200bvb2_buffer\u200b\u653e\u5165\u200b\u94fe\u8868\u200bvb2_queue.queued_list</li> </ul> <p>\u200b\u786c\u4ef6\u200b\u9a71\u52a8\u200b\u63a5\u6536\u200b\u5230\u200b\u6570\u636e\u200b\u540e\u200b\uff0c\u200b\u6bd4\u5982\u200bURB\u200b\u4f20\u8f93\u200b\u5b8c\u6210\u200b\u540e\u200b\uff1a</p> <ul> <li>\u200b\u4ece\u200b\u94fe\u8868\u200bvb2_queue.queued_list\u200b\u627e\u5230\u200b(\u200b\u4f46\u662f\u200b\u4e0d\u200b\u79fb\u9664\u200b)vb2_buffer</li> <li>\u200b\u628a\u200b\u786c\u4ef6\u200b\u6570\u636e\u200b\u5b58\u5165\u200bvb2_buffer</li> <li>\u200b\u628a\u200bvb2_buffer\u200b\u653e\u5165\u200b\u94fe\u8868\u200bvb2_queue.done_list</li> </ul> <p>\u200b\u51fa\u200b\u961f\u5217\u200b\u6d41\u7a0b\u200b\uff1a</p> <ul> <li>APP\u200b\u8c03\u7528\u200bioctl VIDIOC_DQBUF</li> <li>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4ece\u200b\u94fe\u8868\u200bvb2_queue.done_list\u200b\u53d6\u51fa\u200b\u5e76\u200b\u79fb\u9664\u200b\u7b2c\u200b1\u200b\u4e2a\u200bvb2_buffer</li> <li>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e5f\u200b\u628a\u200b\u8fd9\u4e2a\u200bvb2_buffer\u200b\u4ece\u200b\u94fe\u8868\u200bvb2_queue.queued_list\u200b\u79fb\u9664\u200b</li> </ul>"},{"location":"13_V4L2/02_1/#132-videobuffer23ops","title":"1.3.2 videobuffer2\u200b\u7684\u200b3\u200b\u4e2a\u200bops","text":"<p>V4L2\u200b\u4e2d\u200b\u4f7f\u7528\u200bvb2_queue\u200b\u6765\u200b\u7ba1\u7406\u200b\u7f13\u51b2\u533a\u200b\uff0c\u200b\u91cc\u9762\u200b\u6709\u200b3\u200b\u4e2a\u200b\u64cd\u4f5c\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff1a</p> <p></p> <p>\u200b\u8fd9\u200b3\u200b\u4e2a\u200b\u64cd\u4f5c\u200b\u7ed3\u6784\u200b\u4f53\u200b\u7684\u200b\u4f5c\u7528\u200b\u4e3a\u200b\uff1a</p> <ul> <li><code>const struct vb2_buf_ops *buf_ops</code>\uff1a\u200b\u5728\u200b\u7528\u6237\u200b\u7a7a\u95f4\u200b\u3001\u200b\u5185\u6838\u200b\u7a7a\u95f4\u200b\u4e4b\u95f4\u200b\u4f20\u9012\u200bbuffer\u200b\u4fe1\u606f\u200b\uff0c\u200b\u901a\u8fc7\u200b\u4e0b\u9762\u200b\u51e0\u4e2a\u200b\u5b8f\u6765\u200b\u8c03\u7528\u200b   </li> <li> <p><code>const struct vb2_mem_ops *mem_ops</code>\uff1a\u200b\u5206\u914d\u5185\u5b58\u200b\u7528\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\uff0c\u200b\u901a\u8fc7\u200b\u4e0b\u9762\u200b\u51e0\u4e2a\u200b\u5b8f\u6765\u200b\u8c03\u7528\u200b   </p> </li> <li> <p><code>const struct vb2_ops *ops</code>\uff1a\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u56de\u8c03\u200b\u51fd\u6570\u200b\uff0c\u200b\u901a\u8fc7\u200b\u4e0b\u9762\u200b\u51e0\u4e2a\u200b\u5b8f\u6765\u200b\u8c03\u7528\u200b   </p> </li> </ul> <p>\u200b\u8fd9\u200b3\u200b\u4e2a\u200bops\u200b\u7684\u200b\u5c42\u6b21\u200b\u56fe\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u5b8c\u6574\u200b\u7684\u200b\u6ce8\u518c\u200b\u6d41\u7a0b\u200b(\u200b\u53c2\u8003\u200b<code>drivers\\media\\usb\\airspy\\airspy.c</code>)\uff1a</p> <pre><code>static struct video_device airspy_template = {\n    .name                     = \"AirSpy SDR\",\n    .release                  = video_device_release_empty,\n    .fops                     = &amp;airspy_fops,\n    .ioctl_ops                = &amp;airspy_ioctl_ops,\n};\n\n/* \u200b\u6784\u9020\u200b\u4e00\u4e2a\u200bvb2_queue */\n    /* Init videobuf2 queue structure */\n    s-&gt;vb_queue.type = V4L2_BUF_TYPE_SDR_CAPTURE;\n    s-&gt;vb_queue.io_modes = VB2_MMAP | VB2_USERPTR | VB2_READ;\n    s-&gt;vb_queue.drv_priv = s;\n    s-&gt;vb_queue.buf_struct_size = sizeof(struct airspy_frame_buf);\n    s-&gt;vb_queue.ops = &amp;airspy_vb2_ops;          // vb2_ops, \u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u64cd\u4f5c\u200b\u51fd\u6570\u200b\n    s-&gt;vb_queue.mem_ops = &amp;vb2_vmalloc_memops;  // vb2_mem_ops, \u200b\u8f85\u52a9\u200b\u7ed3\u6784\u200b\u4f53\u200b,\u200b\u7528\u4e8e\u200bmem ops(alloc\u3001mmap)\n    s-&gt;vb_queue.timestamp_flags = V4L2_BUF_FLAG_TIMESTAMP_MONOTONIC;\n    ret = vb2_queue_init(&amp;s-&gt;vb_queue);\n                q-&gt;buf_ops = &amp;v4l2_buf_ops;    // vb2_buf_ops, \u200b\u7528\u4e8e\u200bAPP\u200b\u548c\u200b\u9a71\u52a8\u200b\u4f20\u9012\u200b\u53c2\u6570\u200b\n\n// \u200b\u5206\u914d\u200b/\u200b\u8bbe\u7f6e\u200bvideo_device\u200b\u7ed3\u6784\u200b\u4f53\u200b\ns-&gt;vdev = airspy_template;\ns-&gt;vdev.queue = &amp;s-&gt;vb_queue;    // \u200b\u6307\u5411\u200b\u524d\u9762\u200b\u6784\u9020\u200b\u7684\u200bvb2_queue\n\n// \u200b\u521d\u59cb\u5316\u200b\u4e00\u4e2a\u200bv4l2_device\u200b\u7ed3\u6784\u200b\u4f53\u200b(\u200b\u8d77\u200b\u8f85\u52a9\u200b\u4f5c\u7528\u200b)\n/* Register the v4l2_device structure */\ns-&gt;v4l2_dev.release = airspy_video_release;\nret = v4l2_device_register(&amp;intf-&gt;dev, &amp;s-&gt;v4l2_dev);\n\n// video_device\u200b\u548c\u200b4l2_device\u200b\u5efa\u7acb\u8054\u7cfb\u200b\ns-&gt;vdev.v4l2_dev = &amp;s-&gt;v4l2_dev;\n\n// \u200b\u6ce8\u518c\u200bvideo_device\u200b\u7ed3\u6784\u200b\u4f53\u200b\nret = video_register_device(&amp;s-&gt;vdev, VFL_TYPE_SDR, -1);\n        __video_register_device\n            // \u200b\u6839\u636e\u200b\u6b21\u200b\u8bbe\u5907\u200b\u53f7\u200b\u628a\u200bvideo_device\u200b\u7ed3\u6784\u200b\u4f53\u200b\u653e\u5165\u200b\u6570\u7ec4\u200b\n            video_device[vdev-&gt;minor] = vdev;\n\n            // \u200b\u6ce8\u518c\u200b\u5b57\u7b26\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\n            vdev-&gt;cdev-&gt;ops = &amp;v4l2_fops;\n            vdev-&gt;cdev-&gt;owner = owner;\n            ret = cdev_add(vdev-&gt;cdev, MKDEV(VIDEO_MAJOR, vdev-&gt;minor), 1);\n</code></pre>"},{"location":"13_V4L2/02_1/#133-vb2_buf_ops","title":"1.3.3 vb2_buf_ops","text":"<p><code>struct vb2_buf_ops</code>\u200b\u793a\u4f8b\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u539f\u578b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>struct vb2_buf_ops {\n    int (*verify_planes_array)(struct vb2_buffer *vb, const void *pb);\n    void (*fill_user_buffer)(struct vb2_buffer *vb, void *pb);\n    int (*fill_vb2_buffer)(struct vb2_buffer *vb, const void *pb,\n                struct vb2_plane *planes);\n    void (*copy_timestamp)(struct vb2_buffer *vb, const void *pb);\n};\n</code></pre> <p>\u200b\u5404\u200b\u6210\u5458\u200b\u7684\u200b\u4f5c\u7528\u200b\u4e3a\u200b\uff1a</p> vb2_buf_ops\u200b\u7ed3\u6784\u200b\u4f53\u200b\u6210\u5458\u200b \u200b\u4f5c\u7528\u200b verify_planes_array APP\u200b\u8c03\u7528\u200bioctl VIDIOC_DQBUF\u200b\u65f6\u200b\uff0c\u200b\u5728\u200b\u9a71\u52a8\u200b\u5185\u90e8\u200b\u4f1a\u200b\u8c03\u7528\u200b\u6b64\u200b\u51fd\u6570\u200b\uff0c\u200b\u7528\u6765\u200b\u9a8c\u8bc1\u200b\u8fd9\u4e2a\u200bbuffer\u200b\u542b\u6709\u200b\u8db3\u591f\u200b\u591a\u200b\u7684\u200bplane\u3002 fill_user_buffer \u200b\u4f7f\u7528\u200b\u9a71\u52a8\u200b\u7684\u200bvb2_buffer\u200b\u7ed3\u6784\u200b\u4f53\u6765\u200b\u586b\u5145\u200b\u4e00\u4e2a\u200bv4l2_buffer\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u7528\u6765\u200b\u7ed9\u200b\u7528\u6237\u200b\u7a7a\u95f4\u200b\u63d0\u4f9b\u200b\u66f4\u200b\u591a\u200b\u4fe1\u606f\u200b\u3002APP\u200b\u8c03\u7528\u200bioctl VIDIOC_QUERYBUF\u3001VIDIOC_PREPARE_BUF\u3001VIDIOC_QBUF\u3001VIDIOC_DQBUF\u200b\u65f6\u200b\uff0c\u200b\u90fd\u200b\u4f1a\u200b\u4f20\u5165\u200b\u4e00\u4e2a\u200bv4l2_buffer\u200b\u7ed3\u6784\u200b\u4f53\u200b\u3002 fill_vb2_buffer APP\u200b\u8c03\u7528\u200bioctl VIDIOC_QBUF\u200b\u65f6\u200b\uff0c\u200b\u4f20\u5165\u200b\u4e00\u4e2a\u200bv4l2_buffer\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u9a71\u52a8\u200b\u91cc\u4f1a\u7528\u200b\u5b83\u200b\u6765\u200b\u586b\u5145\u200bvb2_buffer\u200b\u7ed3\u6784\u200b\u4f53\u200b\u3002 copy_timestamp APP\u200b\u8c03\u7528\u200bioctl VIDIOC_QBUF\u200b\u65f6\u200b\uff0c\u200b\u4f20\u5165\u200b\u4e00\u4e2a\u200bv4l2_buffer\u200b\u7ed3\u6784\u200b\u4f53\u200b\uff0c\u200b\u7528\u6237\u7a0b\u5e8f\u200b\u53ef\u4ee5\u200b\u5728\u200b\u5b83\u200b\u7684\u200btimestamp\u200b\u91cc\u200b\u8bb0\u4e0b\u200b\u65f6\u95f4\u200b\u3002\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u53ef\u4ee5\u200b\u8c03\u7528\u200b\u6b64\u200b\u51fd\u6570\u200b\u628a\u200btimestamp\u200b\u5199\u5165\u200bvb2_buffer.timestamp\u200b\u91cc\u200b\u3002"},{"location":"13_V4L2/02_1/#134-vb2_mem_ops","title":"1.3.4 vb2_mem_ops","text":"<p><code>struct vb2_mem_ops</code>\u200b\u793a\u4f8b\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u539f\u578b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>struct vb2_mem_ops {\n    void        *(*alloc)(struct device *dev, unsigned long attrs,\n                  unsigned long size,\n                  enum dma_data_direction dma_dir,\n                  gfp_t gfp_flags);\n    void        (*put)(void *buf_priv);\n    struct dma_buf *(*get_dmabuf)(void *buf_priv, unsigned long flags);\n\n    void        *(*get_userptr)(struct device *dev, unsigned long vaddr,\n                    unsigned long size,\n                    enum dma_data_direction dma_dir);\n    void        (*put_userptr)(void *buf_priv);\n\n    void        (*prepare)(void *buf_priv);\n    void        (*finish)(void *buf_priv);\n\n    void        *(*attach_dmabuf)(struct device *dev,\n                      struct dma_buf *dbuf,\n                      unsigned long size,\n                      enum dma_data_direction dma_dir);\n    void        (*detach_dmabuf)(void *buf_priv);\n    int     (*map_dmabuf)(void *buf_priv);\n    void        (*unmap_dmabuf)(void *buf_priv);\n\n    void        *(*vaddr)(void *buf_priv);\n    void        *(*cookie)(void *buf_priv);\n\n    unsigned int    (*num_users)(void *buf_priv);\n\n    int     (*mmap)(void *buf_priv, struct vm_area_struct *vma);\n};\n</code></pre> <p>\u200b\u5404\u200b\u6210\u5458\u200b\u7684\u200b\u4f5c\u7528\u200b\u4e3a\u200b\uff1a</p> vb2_mem_ops\u200b\u7ed3\u6784\u200b\u4f53\u200b\u6210\u5458\u200b \u200b\u4f5c\u7528\u200b alloc \u200b\u5206\u914d\u200b\u771f\u6b63\u200b\u7528\u4e8e\u200b\u5b58\u50a8\u200b\u89c6\u9891\u200b\u6570\u636e\u200b\u7684\u200bbuffer\uff0c\u200b\u53ef\u80fd\u200b\u8fd8\u200b\u5206\u914d\u200b\u79c1\u6709\u200b\u6570\u636e\u200b put \u200b\u901a\u77e5\u200b\u5206\u914d\u5668\u200b\uff1a\u200b\u8fd9\u5757\u200bbuffer\u200b\u4e0d\u518d\u200b\u4f7f\u7528\u200b\u4e86\u200b\u3002\u200b\u901a\u5e38\u200b\u4f1a\u200b\u91ca\u653e\u200b\u5185\u5b58\u200b\u3002 get_dmabuf \u200b\u83b7\u5f97\u200bDMA BUF\u200b\u7ed9\u200b\u5e95\u5c42\u200b\u9a71\u52a8\u200b\u4f7f\u7528\u200b get_userptr \u200b\u5982\u679c\u200b\u5b58\u50a8\u200b\u89c6\u9891\u200b\u6570\u636e\u200b\u7684\u200bbuffer\u200b\u662f\u200buserptr\uff08\u200b\u7531\u200bAPP\u200b\u63d0\u4f9b\u200b\uff09\uff0c\u200b\u90a3\u4e48\u200bAPP\u200b\u8c03\u7528\u200bioctl VIDIOC_QBUF\u200b\u65f6\u200b\uff0c\u200b\u9700\u8981\u200b\u4f20\u5165\u200bAPP\u200b\u7684\u200bbuffer\u200b\u6307\u9488\u200b\u3002\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5185\u90e8\u200b\u901a\u8fc7\u200b\u6b64\u200b\u51fd\u6570\u200b\u628a\u200b\u7528\u6237\u200b\u7a7a\u95f4\u200b\u7684\u200bbuffer\u200b\u6620\u5c04\u200b\u5230\u200b\u5185\u6838\u200b\u7a7a\u95f4\u200b\u3002 put_userptr \u200b\u901a\u77e5\u200b\u5206\u914d\u5668\u200b\uff1a\u200b\u8fd9\u5757\u200bUSERPTR\u200b\u7f13\u51b2\u533a\u200b\u4e0d\u518d\u200b\u4f7f\u7528\u200b attach_dmabuf \u200b\u5982\u679c\u200b\u5b58\u50a8\u200b\u89c6\u9891\u200b\u6570\u636e\u200b\u7684\u200bbuffer\u200b\u662f\u200bDMA Buf\uff0c\u200b\u90a3\u4e48\u200b\u5728\u200b\u628a\u200b\u8fd9\u4e2a\u200bbuffer\u200b\u653e\u5165\u200b\u961f\u5217\u200b\u524d\u4f1a\u200b\u8c03\u7528\u200b\u6b64\u200b\u51fd\u6570\u200b\uff1a\u200b\u8bb0\u5f55\u200b\u8fd9\u4e2a\u200bDMA Buf\u3002 detach_dmabuf \u200b\u4e0d\u518d\u200b\u4f7f\u7528\u200b\u8fd9\u4e2a\u200bDMA Buf\u200b\u65f6\u200b\uff0c\u200b\u505a\u4e9b\u200b\u6e05\u7406\u200b\u5de5\u4f5c\u200b\uff08\u200b\u6bd4\u5982\u200b\u5728\u200battach_dmabuf\u200b\u91cc\u200b\u5206\u914d\u200b\u4e86\u200b\u6570\u636e\u200b\uff0c\u200b\u5c31\u200b\u5728\u200b\u8fd9\u91cc\u200b\u91ca\u653e\u200b\u6389\u200b\uff09 map_dmabuf \u200b\u628a\u200bDMA Buf\u200b\u6620\u5c04\u200b\u5230\u200b\u5185\u6838\u200b\u7a7a\u95f4\u200b unmap_dmabuf map_dmabuf\u200b\u7684\u200b\u53cd\u200b\u64cd\u4f5c\u200b prepare \u200b\u6bcf\u5f53\u200bbuffer\u200b\u88ab\u200b\u4ece\u200b\u7528\u6237\u200b\u7a7a\u95f4\u200b\u4f20\u9012\u200b\u5230\u200b\u9a71\u52a8\u200b\u65f6\u200b\uff0c\u200b\u6b64\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u7528\u6765\u200b\u505a\u200b\u67d0\u4e9b\u200b\u540c\u6b65\u64cd\u4f5c\u200b\u3002\u200b\u53ef\u200b\u9009\u200b\u3002 finish \u200b\u6bcf\u5f53\u200bbuffer\u200b\u88ab\u200b\u4ece\u200b\u9a71\u52a8\u200b\u4f20\u9012\u200b\u5230\u200b\u7528\u6237\u200b\u7a7a\u95f4\u200b\u65f6\u200b\uff0c\u200b\u6b64\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u7528\u6765\u200b\u505a\u200b\u67d0\u4e9b\u200b\u540c\u6b65\u64cd\u4f5c\u200b\u3002\u200b\u53ef\u200b\u9009\u200b\u3002 vaddr \u200b\u8fd4\u56de\u200b\u8fd9\u5757\u200b\u5185\u5b58\u200b\u7684\u200b\u5185\u6838\u200b\u7a7a\u95f4\u200b\u5730\u5740\u200b cookie \u200b\u6ca1\u4ec0\u4e48\u200b\u7528\u200b num_users \u200b\u8fd4\u56de\u200b\u8fd9\u5757\u200b\u5185\u5b58\u200b\u7684\u200b\u5f15\u7528\u200b\u8ba1\u6570\u200b mmap \u200b\u628a\u200b\u8fd9\u5757\u200b\u5185\u5b58\u200b\uff0c\u200b\u6620\u5c04\u200b\u5230\u200b\u7528\u6237\u200b\u7a7a\u95f4"},{"location":"13_V4L2/02_1/#135-vb2_ops","title":"1.3.5 vb2_ops","text":"<p><code>struct vb2_ops</code>\u200b\u793a\u4f8b\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u539f\u578b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>struct vb2_ops {\n    int (*queue_setup)(struct vb2_queue *q,\n               unsigned int *num_buffers, unsigned int *num_planes,\n               unsigned int sizes[], struct device *alloc_devs[]);\n\n    void (*wait_prepare)(struct vb2_queue *q);\n    void (*wait_finish)(struct vb2_queue *q);\n\n    int (*buf_init)(struct vb2_buffer *vb);\n    int (*buf_prepare)(struct vb2_buffer *vb);\n    void (*buf_finish)(struct vb2_buffer *vb);\n    void (*buf_cleanup)(struct vb2_buffer *vb);\n\n    int (*start_streaming)(struct vb2_queue *q, unsigned int count);\n    void (*stop_streaming)(struct vb2_queue *q);\n\n    void (*buf_queue)(struct vb2_buffer *vb);\n};\n</code></pre> <p>\u200b\u5404\u200b\u6210\u5458\u200b\u7684\u200b\u4f5c\u7528\u200b\u4e3a\u200b\uff1a</p> vb2_ops\u200b\u7ed3\u6784\u200b\u4f53\u200b\u6210\u5458\u200b \u200b\u4f5c\u7528\u200b queue_setup APP\u200b\u8c03\u7528\u200bioctl VIDIOC_REQBUFS\u200b\u6216\u200bVIDIOC_CREATE_BUFS\u200b\u65f6\u200b\uff0c\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5728\u200b\u5206\u914d\u5185\u5b58\u200b\u4e4b\u524d\u200b\uff0c\u200b\u4f1a\u200b\u8c03\u7528\u200b\u6b64\u200b\u51fd\u6570\u200b\u3002\u200b\u4f5c\u7528\u200b\uff1a\u200b\u901a\u8fc7\u200b\u5b83\u200b\u6765\u200b\u8be2\u95ee\u200b\u786c\u4ef6\u200b\u9a71\u52a8\u200b\"\u200b\u4f60\u200b\u9700\u8981\u200b\u591a\u5c11\u200b\u4e2a\u200bbuffer\uff1f\u200b\u6bcf\u4e2a\u200bbuffer\u200b\u9700\u8981\u200b\u591a\u5c11\u200b\u4e2a\u200bplane\uff1f\"\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b2\u200b\u6b21\u200b\uff1a\u200b\u7b2c\u200b1\u200b\u6b21\u200b\u7528\u6765\u200b\u8868\u660e\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5bf9\u200bbuffer\u200b\u7684\u200b\u9700\u6c42\u200b\uff0c\u200b\u4f46\u662f\u200b\u4e0d\u200b\u4e00\u5b9a\u200b\u80fd\u200b\u5168\u90e8\u200b\u5206\u914d\u200b\u8fd9\u4e9b\u200bbuffer\uff0c\u200b\u5f53\u200b\u5206\u914d\u200b\u51fa\u200bbuffer\u200b\u540e\u200b\uff0c\u200b\u518d\u200b\u8c03\u7528\u200b\u7b2c\u200b2\u200b\u6b21\u4ee5\u200b\u9a8c\u8bc1\u200b\"\u200b\u8fd9\u4e9b\u200bbuffer\u200b\u662f\u5426\u200b\u8db3\u591f\u200b\"\u3002 wait_prepare \u200b\u91ca\u653e\u200b\u9a71\u52a8\u200b\u81ea\u5df1\u200b\u7684\u200b\u4e92\u65a5\u200b\u9501\u200b wait_finish \u200b\u7533\u8bf7\u200b\u9a71\u52a8\u200b\u81ea\u5df1\u200b\u7684\u200b\u4e92\u65a5\u200b\u9501\u200b buf_init \u200b\u5206\u914d\u200bvb2_buffer\u200b\u53ca\u200b\u5b83\u200b\u5185\u90e8\u200b\u5b58\u50a8\u200b\u6570\u636e\u200b\u7684\u200bbuffer\u200b\u540e\u200b\uff0c\u200b\u4f7f\u7528\u200bbuf_init\u200b\u8fdb\u884c\u200b\u9a71\u52a8\u200b\u76f8\u5173\u200b\u7684\u200b\u521d\u59cb\u5316\u200b buf_prepare APP\u200b\u8c03\u7528\u200bioctl VIDIOC_QBUF\u200b\u6216\u200bVIDIOC_PREPARE_BUF\u200b\u65f6\u200b\uff0c\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4f1a\u200b\u5728\u200b\u6267\u884c\u200b\u786c\u4ef6\u200b\u64cd\u4f5c\u524d\u200b\uff0c\u200b\u8c03\u7528\u200b\u6b64\u200b\u51fd\u6570\u200b\u8fdb\u884c\u200b\u5fc5\u8981\u200b\u7684\u200b\u521d\u59cb\u5316\u200b\u3002 buf_finish APP\u200b\u8c03\u7528\u200bioctl VIDIOC_DQBUF\u200b\u540e\u200b\uff0c\u200b\u5728\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u8fd4\u56de\u200b\u7528\u6237\u200b\u7a7a\u95f4\u200b\u4e4b\u524d\u200b\uff0c\u200b\u4f1a\u200b\u8c03\u7528\u200b\u6b64\u200b\u51fd\u6570\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u91cc\u200b\u4fee\u6539\u200bbuffer\u3002\u200b\u6216\u8005\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5185\u90e8\u200b\u505c\u6b62\u200b\u6216\u200b\u6682\u505c\u200bstreaming\u200b\u65f6\u200b\uff0c\u200b\u4e5f\u200b\u4f1a\u200b\u8c03\u7528\u200b\u6b64\u200b\u51fd\u6570\u200b\u3002 buf_cleanup \u200b\u5728\u200bbuffer\u200b\u88ab\u200b\u91ca\u653e\u200b\u524d\u200b\u8c03\u7528\u200b\uff0c\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u91cc\u200b\u6267\u884c\u200b\u989d\u5916\u200b\u7684\u200b\u6e05\u9664\u200b\u5de5\u4f5c\u200b\u3002 start_streaming \u200b\u9a71\u52a8\u200b\u76f8\u5173\u200b\u7684\u200b\"\u200b\u542f\u52a8\u200bstreaming\"\u200b\u51fd\u6570\u200b stop_streaming \u200b\u9a71\u52a8\u200b\u76f8\u5173\u200b\u7684\u200b\"\u200b\u505c\u6b62\u200bstreaming\"\u200b\u51fd\u6570\u200b buf_queue \u200b\u628a\u200bbuffer\u200b\u4f20\u9001\u200b\u7ed9\u200b\u9a71\u52a8\u200b\uff0c\u200b\u9a71\u52a8\u200b\u83b7\u5f97\u200b\u6570\u636e\u200b\u3001\u200b\u586b\u5145\u200b\u597d\u200bbuffer\u200b\u540e\u200b\u4f1a\u200b\u8c03\u7528\u200bvb2_buffer_done\u200b\u51fd\u6570\u200b\u8fd4\u8fd8\u200bbuffer\u3002"},{"location":"13_V4L2/02_1/#136-videobuffer2","title":"1.3.6 videobuffer2\u200b\u60c5\u666f\u200b\u5206\u6790","text":"<p>\u200b\u60c5\u666f\u200b\u5206\u6790\u200b1\uff1a\u200b\u7533\u8bf7\u200bbuffer</p> <pre><code>APP ioctl VIDIOC_REQBUFS\n------------------------------\n    v4l_reqbufs // v4l2-ioctl.c\n        ops-&gt;vidioc_reqbufs(file, fh, p);\n            vb2_ioctl_reqbufs // videobuf2-v4l2.c\n                vb2_core_reqbufs \n                    /*\n                     * Ask the driver how many buffers and planes per buffer it requires.\n                     * Driver also sets the size and allocator context for each plane.\n                     */\n                    /* \u200b\u8c03\u7528\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200bvb2_ops.queue_setup\uff0c\u200b\u786e\u8ba4\u200b\u9700\u8981\u200b\u591a\u5c11\u200b\u4e2a\u200bbuffer\u3001\u200b\u6bcf\u4e2a\u200bbuffer\u200b\u91cc\u200b\u6709\u200b\u591a\u5c11\u200b\u4e2a\u200bplane */\n                    ret = call_qop(q, queue_setup, q, &amp;num_buffers, &amp;num_planes,\n                               plane_sizes, q-&gt;alloc_devs);\n\n\n                    /* Finally, allocate buffers and video memory */                    \n                    allocated_buffers =\n                        __vb2_queue_alloc(q, memory, num_buffers, num_planes, plane_sizes);\n                            ret = __vb2_buf_mem_alloc(vb);\n                                        // \u200b\u8c03\u7528\u200bvb2_mem_ops.alloc\u200b\u5206\u914d\u5185\u5b58\u200b\n                                        mem_priv = call_ptr_memop(vb, alloc,\n                                            q-&gt;alloc_devs[plane] ? : q-&gt;dev,\n                                            q-&gt;dma_attrs, size, dma_dir, q-&gt;gfp_flags);\n\n                    /* \u200b\u9a71\u52a8\u200b\u60f3\u5f97\u5230\u200bM\u200b\u4e2a\u200bbuffer\uff0c\u200b\u4f46\u662f\u200b\u53ef\u80fd\u200b\u53ea\u200b\u5206\u914d\u200b\u4e86\u200bN\u200b\u4e2a\u200bbuffer\uff0c\u200b\u53ef\u4ee5\u200b\u5417\u200b\uff1f\u200b\u95ee\u200b\u9a71\u52a8\u200b\n                     * \u200b\u518d\u6b21\u200b\u8c03\u7528\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200bvb2_ops.queue_setup\uff0c\u200b\u786e\u8ba4\u200b\u5df2\u7ecf\u200b\u5206\u914d\u200b\u7684\u200bbuffer\u200b\u4e2a\u6570\u200b\u3001\u200b\u6bcf\u4e2a\u200bbuffer\u200b\u7684\u200bplane\u200b\u4e2a\u6570\u200b\u662f\u5426\u200b\u7b26\u5408\u200b\u786c\u4ef6\u200b\u9700\u6c42\u200b\n                     */\n                    ret = call_qop(q, queue_setup, q, &amp;num_buffers,\n                               &amp;num_planes, plane_sizes, q-&gt;alloc_devs);\n</code></pre> <p>\u200b\u60c5\u666f\u200b\u5206\u6790\u200b2\uff1a\u200b\u628a\u200bbuffer\u200b\u653e\u5165\u200b\u961f\u5217\u200b</p> <pre><code>APP ioctl VIDIOC_QBUF\n------------------------------\n    v4l_qbuf // v4l2-ioctl.c\n        ops-&gt;vidioc_qbuf(file, fh, p);\n            vb2_ioctl_qbuf // videobuf2-v4l2.c\n                vb2_qbuf(vdev-&gt;queue, p);  // videobuf2-v4l2.c\n                    vb2_core_qbuf(q, b-&gt;index, b); // videobuf2-core.c\n                        ret = __buf_prepare(vb, pb);\n                                ret = __qbuf_mmap(vb, pb);  // videobuf2-core.c\n\n                                        if (pb) // \u200b\u8c03\u7528\u200bvb2_buf_ops.fill_vb2_buffer, \u200b\u4f7f\u7528\u200bAPP\u200b\u4f20\u5165\u200b\u7684\u200bv4l2_buffer\u200b\u6765\u200b\u8bbe\u7f6e\u200b\u9a71\u52a8\u200b\u7684\u200bvb2_buffer\n                                            ret = call_bufop(vb-&gt;vb2_queue, fill_vb2_buffer,\n                                                     vb, pb, vb-&gt;planes);\n                                        // \u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200bvb2_ops.buf_prepare, \u200b\u5bf9\u200bbuffer\u200b\u505a\u4e9b\u200b\u51c6\u5907\u200b\u5de5\u4f5c\u200b\n                                        return ret ? ret : call_vb_qop(vb, buf_prepare, vb);\n                        // \u200b\u628a\u200bbuffer\u200b\u653e\u5165\u200b\u7a7a\u95f2\u200b\u94fe\u8868\u200b\n                        list_add_tail(&amp;vb-&gt;queued_entry, &amp;q-&gt;queued_list);\n\n                        if (pb) // \u200b\u8c03\u7528\u200bvb2_buf_ops.copy_timestamp, \u200b\u4f7f\u7528\u200bAPP\u200b\u4f20\u5165\u200b\u7684\u200bv4l2_buffer\u200b\u6765\u200b\u8bbe\u7f6e\u200b\u9a71\u52a8\u200b\u7684\u200bvb2_buffer\n                            call_void_bufop(q, copy_timestamp, vb, pb);\n\n                        /*\n                         * If already streaming, give the buffer to driver for processing.\n                         * If not, the buffer will be given to driver on next streamon.\n                         */\n                        if (q-&gt;start_streaming_called)\n                            __enqueue_in_driver(vb);\n                                    /* sync buffers */\n                                    for (plane = 0; plane &lt; vb-&gt;num_planes; ++plane)\n                                        // \u200b\u8c03\u7528\u200bvb2_mem_ops.prepare\u200b\u505a\u200b\u51c6\u5907\u200b\n                                        call_void_memop(vb, prepare, vb-&gt;planes[plane].mem_priv); \n\n                                    // \u200b\u8c03\u7528\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200bvb2_ops.buf_queue\u200b\u628a\u200bbuffer\u200b\u4f20\u9001\u200b\u7ed9\u200b\u9a71\u52a8\u200b\n                                    call_void_vb_qop(vb, buf_queue, vb);\n\n                        /* Fill buffer information for the userspace */\n                        if (pb) // \u200b\u8c03\u7528\u200bvb2_buf_ops.fill_user_buffer, \u200b\u4f7f\u7528\u200b\u9a71\u52a8\u200b\u7684\u200bvb2_buffer\u200b\u4e3a\u200bAPP\u200b\u8bbe\u7f6e\u200bv4l2_buffer\n                            call_void_bufop(q, fill_user_buffer, vb, pb);\n\n                        /*\n                         * If streamon has been called, and we haven't yet called\n                         * start_streaming() since not enough buffers were queued, and\n                         * we now have reached the minimum number of queued buffers,\n                         * then we can finally call start_streaming().\n                         */\n                        if (q-&gt;streaming &amp;&amp; !q-&gt;start_streaming_called &amp;&amp;\n                            q-&gt;queued_count &gt;= q-&gt;min_buffers_needed) {\n                            ret = vb2_start_streaming(q);\n                                        /*\n                                         * If any buffers were queued before streamon,\n                                         * we can now pass them to driver for processing.\n                                         */\n                                        list_for_each_entry(vb, &amp;q-&gt;queued_list, queued_entry)\n                                            __enqueue_in_driver(vb);\n                                                    /* sync buffers */\n                                                    for (plane = 0; plane &lt; vb-&gt;num_planes; ++plane)\n                                                        // \u200b\u8c03\u7528\u200bvb2_mem_ops.prepare\u200b\u505a\u200b\u51c6\u5907\u200b\n                                                        call_void_memop(vb, prepare, vb-&gt;planes[plane].mem_priv);\n                                                    // \u200b\u8c03\u7528\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200bvb2_ops.buf_queue\u200b\u628a\u200bbuffer\u200b\u4f20\u9001\u200b\u7ed9\u200b\u9a71\u52a8\u200b\n                                                    call_void_vb_qop(vb, buf_queue, vb);\n\n                                        /* Tell the driver to start streaming */\n                                        q-&gt;start_streaming_called = 1;\n                                        // \u200b\u8c03\u7528\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200bvb2_ops.start_streaming\u200b\u542f\u52a8\u200b\u786c\u4ef6\u200b\u4f20\u8f93\u200b\n                                        ret = call_qop(q, start_streaming, q,\n                                                   atomic_read(&amp;q-&gt;owned_by_drv_count));\n</code></pre> <p>\u200b\u60c5\u666f\u200b\u5206\u6790\u200b3\uff1a\u200b\u628a\u200bbuffer\u200b\u53d6\u51fa\u200b\u961f\u5217\u200b</p> <pre><code>APP ioctl VIDIOC_DQBUF\n------------------------------\n    v4l_dqbuf // v4l2-ioctl.c\n        ops-&gt;vidioc_dqbuf(file, fh, p);\n            vb2_ioctl_dqbuf // videobuf2-v4l2.c\n                vb2_dqbuf(vdev-&gt;queue, p, file-&gt;f_flags &amp; O_NONBLOCK);\n                    ret = vb2_core_dqbuf(q, NULL, b, nonblocking);\n                            ret = __vb2_get_done_vb(q, &amp;vb, pb, nonblocking);\n                                    ret = __vb2_wait_for_done_vb(q, nonblocking);\n                                            call_void_qop(q, wait_prepare, q);\n                                            wait_event_interruptible\n                                            call_void_qop(q, wait_finish, q);\n                                    *vb = list_first_entry(&amp;q-&gt;done_list, struct vb2_buffer, done_entry);\n                                    if (pb)\n                                        ret = call_bufop(q, verify_planes_array, *vb, pb);\n                                                    __verify_planes_array_core\n                                                        __verify_planes_array(vb, pb);\n                                    if (!ret)\n                                        list_del(&amp;(*vb)-&gt;done_entry);           \n                            call_void_vb_qop(vb, buf_finish, vb);\n\n                            /* go back to dequeued state */\n                            __vb2_dqbuf(vb);\n                                call_void_memop(vb, unmap_dmabuf, vb-&gt;planes[i].mem_priv);\n                                    vb2_vmalloc_unmap_dmabuf\n                                        dma_buf_vunmap(buf-&gt;dbuf, buf-&gt;vaddr);\n</code></pre>"},{"location":"13_V4L2/03_1/","title":"\u4ece\u200b0\u200b\u7f16\u5199\u200b\u4e00\u4e2a\u200b\u865a\u62df\u200b\u6444\u50cf\u5934\u200b\u9a71\u52a8","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u200b\u6df1\u5165\u200b\u7406\u89e3\u200blinux\u200b\u5185\u6838\u200bv4l2\u200b\u6846\u67b6\u200b\u4e4b\u200bvideobuf2\uff1ahttps://blog.csdn.net/yyjsword/article/details/9243717</li> <li>V4L2\u200b\u6846\u67b6\u200b-videobuf2\uff1ahttps://blog.csdn.net/u013904227/article/details/81054611</li> </ul>"},{"location":"13_V4L2/03_1/#1","title":"1. \u200b\u56de\u987e\u200b\u4e0e\u200b\u7f16\u5199\u7a0b\u5e8f\u200b\u6846\u67b6","text":"<p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u5bf9\u5e94\u200b\u7684\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>doc_and_source_for_drivers\\\n    IMX6ULL\\source\\\n        13_V4L2\\\n            06_virtual_driver\\\n                01_virtual_driver_framework\n</code></pre> <p>\u200b\u53c2\u8003\u200b\u300a1.3.2 videobuffer2\u200b\u7684\u200b3\u200b\u4e2a\u200bops\u300b\u200b\u91cc\u9762\u200b\u5b8c\u6574\u200b\u7684\u200b\u6ce8\u518c\u200b\u6d41\u7a0b\u200b\u3002</p> <p>\u200b\u5b8c\u6574\u200b\u7684\u200b\u6ce8\u518c\u200b\u6d41\u7a0b\u200b(\u200b\u53c2\u8003\u200b<code>drivers\\media\\usb\\airspy\\airspy.c</code>)\uff1a</p> <pre><code>static struct video_device airspy_template = {\n    .name                     = \"AirSpy SDR\",\n    .release                  = video_device_release_empty,\n    .fops                     = &amp;airspy_fops,\n    .ioctl_ops                = &amp;airspy_ioctl_ops,\n};\n\n/* \u200b\u6784\u9020\u200b\u4e00\u4e2a\u200bvb2_queue */\n    /* Init videobuf2 queue structure */\n    s-&gt;vb_queue.type = V4L2_BUF_TYPE_SDR_CAPTURE;\n    s-&gt;vb_queue.io_modes = VB2_MMAP | VB2_USERPTR | VB2_READ;\n    s-&gt;vb_queue.drv_priv = s;\n    s-&gt;vb_queue.buf_struct_size = sizeof(struct airspy_frame_buf);\n    s-&gt;vb_queue.ops = &amp;airspy_vb2_ops;          // vb2_ops, \u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200b\u64cd\u4f5c\u200b\u51fd\u6570\u200b\n    s-&gt;vb_queue.mem_ops = &amp;vb2_vmalloc_memops;  // vb2_mem_ops, \u200b\u8f85\u52a9\u200b\u7ed3\u6784\u200b\u4f53\u200b,\u200b\u7528\u4e8e\u200bmem ops(alloc\u3001mmap)\n    s-&gt;vb_queue.timestamp_flags = V4L2_BUF_FLAG_TIMESTAMP_MONOTONIC;\n    ret = vb2_queue_init(&amp;s-&gt;vb_queue);\n                q-&gt;buf_ops = &amp;v4l2_buf_ops;    // vb2_buf_ops, \u200b\u7528\u4e8e\u200bAPP\u200b\u548c\u200b\u9a71\u52a8\u200b\u4f20\u9012\u200b\u53c2\u6570\u200b\n\n// \u200b\u5206\u914d\u200b/\u200b\u8bbe\u7f6e\u200bvideo_device\u200b\u7ed3\u6784\u200b\u4f53\u200b\ns-&gt;vdev = airspy_template;\ns-&gt;vdev.queue = &amp;s-&gt;vb_queue;    // \u200b\u6307\u5411\u200b\u524d\u9762\u200b\u6784\u9020\u200b\u7684\u200bvb2_queue\n\n// \u200b\u521d\u59cb\u5316\u200b\u4e00\u4e2a\u200bv4l2_device\u200b\u7ed3\u6784\u200b\u4f53\u200b(\u200b\u8d77\u200b\u8f85\u52a9\u200b\u4f5c\u7528\u200b)\n/* Register the v4l2_device structure */\ns-&gt;v4l2_dev.release = airspy_video_release;\nret = v4l2_device_register(&amp;intf-&gt;dev, &amp;s-&gt;v4l2_dev);\n\n// video_device\u200b\u548c\u200b4l2_device\u200b\u5efa\u7acb\u8054\u7cfb\u200b\ns-&gt;vdev.v4l2_dev = &amp;s-&gt;v4l2_dev;\n\n// \u200b\u6ce8\u518c\u200bvideo_device\u200b\u7ed3\u6784\u200b\u4f53\u200b\nret = video_register_device(&amp;s-&gt;vdev, VFL_TYPE_SDR, -1);\n        __video_register_device\n            // \u200b\u6839\u636e\u200b\u6b21\u200b\u8bbe\u5907\u200b\u53f7\u200b\u628a\u200bvideo_device\u200b\u7ed3\u6784\u200b\u4f53\u200b\u653e\u5165\u200b\u6570\u7ec4\u200b\n            video_device[vdev-&gt;minor] = vdev;\n\n            // \u200b\u6ce8\u518c\u200b\u5b57\u7b26\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\n            vdev-&gt;cdev-&gt;ops = &amp;v4l2_fops;\n            vdev-&gt;cdev-&gt;owner = owner;\n            ret = cdev_add(vdev-&gt;cdev, MKDEV(VIDEO_MAJOR, vdev-&gt;minor), 1);\n</code></pre>"},{"location":"13_V4L2/03_1/#2","title":"2. \u200b\u7f16\u5199\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u4ee3\u7801","text":"<p>\u200b\u672c\u200b\u8282\u200b\u89c6\u9891\u200b\u5bf9\u5e94\u200b\u7684\u200b\u4ee3\u7801\u200b\uff1a</p> <pre><code>doc_and_source_for_drivers\\\n    IMX6ULL\\source\\\n        13_V4L2\\\n            06_virtual_driver\\\n                02_virtual_driver_hardware\n</code></pre>"},{"location":"13_V4L2/03_1/#21-ioctl","title":"2.1 ioctl\u200b\u76f8\u5173\u200b\u7684\u200b\u4ee3\u7801","text":""},{"location":"13_V4L2/03_1/#22-buffer","title":"2.2 buffer\u200b\u76f8\u5173\u200b\u7684\u200b\u4ee3\u7801","text":""},{"location":"13_V4L2/03_1/#23","title":"2.3 \u200b\u6570\u636e\u4f20\u8f93","text":"<p>linux\u200b\u4e0b\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200b\u5982\u4e0b\u200b\u547d\u4ee4\u200b\uff1a</p> <pre><code>hexdump -v -e '8/1 \"0x%02x, \" \"\\n\"'  red.jpg\n</code></pre> <p>windows\u200b\u4e0b\u200b\u4f7f\u7528\u200bwinhex\u200b\u5de5\u5177\u200b\uff0c\u200b\u89c6\u9891\u200b\u6709\u6559\u200b\u3002</p>"},{"location":"13_V4L2/03_1/#3","title":"3. \u200b\u4e0a\u673a\u200b\u6d4b\u8bd5","text":"<p>\u200b\u53ef\u4ee5\u200b\u7981\u6b62\u200bLCD\u200b\u81ea\u52a8\u200b\u9ed1\u5c4f\u200b\uff0c\u200b\u6267\u884c\u200b\u4ee5\u4e0b\u200b\u547d\u4ee4\u200b\u5373\u53ef\u200b\uff1a</p> <pre><code>#close lcd sleep\necho -e \"\\033[9;0]\" &gt; /dev/tty1\necho -e \"\\033[?25l\"  &gt; /dev/tty1\n</code></pre>"},{"location":"13_V4L2/03_1/#31-imx6ull","title":"3.1 IMX6ULL","text":"<p>\u200b\u5148\u200b\u5173\u95ed\u200bGUI\uff1a</p> <pre><code>[root@100ask:~]# mv /etc/init.d/S99myirhmi2 /root/\n[root@100ask:~]# mv /etc/init.d/*lvgl* /root/\n[root@100ask:~]# reboot\n</code></pre> <p>\u200b\u7136\u540e\u200b\u7f16\u8bd1\u200b\u9a71\u52a8\u200b\uff1a13_V4L2\\06_virtual_driver\\04_virtual_driver_ok\\</p> <p>\u200b\u7f16\u8bd1\u200bAPP\uff1a13_V4L2\\02_video2lcd\\</p> <p>\u200b\u6d4b\u8bd5\u200b\uff1a</p> <pre><code>insmod my_video_drv.ko\n./video2lcd /dev/video1\n</code></pre>"},{"location":"13_V4L2/03_1/#32-stm32mp157","title":"3.2 STM32MP157","text":""},{"location":"13_V4L2/03_1/#321","title":"3.2.1 \u200b\u7f16\u8bd1","text":"<p>\u200b\u5148\u200b\u7f16\u8bd1\u200b\u5185\u6838\u200b\uff0c\u200b\u7f16\u8bd1\u200b\u6a21\u5757\u200b\uff1a</p> <pre><code>make 100ask_stm32mp157_pro_defconfig\nmake uImage LOADADDR=0xC2000040  -j 12\nmake modules -j 12\n</code></pre> <p>\u200b\u7136\u540e\u200b\u7f16\u8bd1\u200b\u9a71\u52a8\u200b\uff1a13_V4L2\\06_virtual_driver\\04_virtual_driver_ok\\</p> <p>\u200b\u7f16\u8bd1\u200bAPP\uff1a13_V4L2\\02_video2lcd\\</p>"},{"location":"13_V4L2/03_1/#322","title":"3.2.2 \u200b\u5728\u200b\u5f00\u53d1\u677f\u200b\u4e0a\u200b\u64cd\u4f5c","text":"<p>\u200b\u5173\u95ed\u200bGUI\uff1a</p> <pre><code>systemctl stop myir  //\u200b\u5173\u95ed\u200b\u81ea\u5e26\u200b\u7684\u200bGUI\u200b\u7a0b\u5e8f\u200b\n</code></pre> <p>\u200b\u6d4b\u8bd5\u200b\uff1a</p> <pre><code>modprobe videobuf2-common\nmodprobe videobuf2-v4l2\nmodprobe videobuf2-memops\nmodprobe videobuf2-vmalloc\n\ninsmod my_video_drv.ko\n./video2lcd /dev/video0\n</code></pre>"},{"location":"13_V4L2/04_1/","title":"USB\u200b\u6444\u50cf\u5934\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5206\u6790","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u200b\u5185\u6838\u200b\u6e90\u7801\u200b: <code>drivers\\media\\usb\\uvc\\uvc_driver.c</code></li> </ul>"},{"location":"13_V4L2/04_1/#1","title":"1. \u200b\u63cf\u8ff0\u7b26\u200b\u89e3\u6790","text":""},{"location":"13_V4L2/04_1/#11","title":"1.1 \u200b\u5185\u90e8\u200b\u903b\u8f91\u200b\u7ed3\u6784","text":"<p>USB\u200b\u6444\u50cf\u5934\u200b\u7684\u200b\u5185\u90e8\u7ed3\u6784\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u4e00\u4e2a\u200bUSB\u200b\u6444\u50cf\u5934\u200b\u5fc5\u5b9a\u200b\u6709\u200b\u4e00\u4e2a\u200bVideoControl\u200b\u63a5\u53e3\u200b\uff0c\u200b\u7528\u4e8e\u200b\u63a7\u5236\u200b\u3002\u200b\u6709\u200b0\u200b\u4e2a\u200b\u6216\u200b\u591a\u4e2a\u200bVideoStreaming\u200b\u63a5\u53e3\u200b\uff0c\u200b\u7528\u4e8e\u200b\u4f20\u8f93\u200b\u89c6\u9891\u200b\u3002</p> <p>\u200b\u5728\u200bVideoControl\u200b\u5185\u90e8\u200b\uff0c\u200b\u6709\u200b\u591a\u4e2a\u200bUnit\u200b\u6216\u200bTerminal\uff0c\u200b\u4e0a\u200b\u4e00\u4e2a\u200bUnit\u200b\u6216\u200bTerminal\u200b\u7684\u200b\u6570\u636e\u200b\uff0c\u200b\u6d41\u5411\u200b\u4e0b\u200b\u4e00\u4e2a\u200bUnit\u200b\u6216\u200bTerminal\uff0c\u200b\u591a\u4e2a\u200bUnit\u200b\u6216\u200bTerminal\u200b\u7ec4\u6210\u200b\u4e00\u4e2a\u200b\u5b8c\u6574\u200b\u7684\u200bUVC\u200b\u529f\u80fd\u200b\u8bbe\u5907\u200b\u3002</p>"},{"location":"13_V4L2/04_1/#12","title":"1.2 \u200b\u63cf\u8ff0\u7b26\u200b\u5b9e\u4f8b\u200b\u89e3\u6790","text":"<p>\u200b\u4e0b\u8f7d\u5b89\u88c5\u200b\uff1ahttps://www.uwe-sieber.de/usbtreeview_e.html</p> <p>\u200b\u4e5f\u200b\u53ef\u4ee5\u200b\u4f7f\u7528\u200blinux\u200b\u5de5\u5177\u200blsusb\u3002</p> <pre><code>lsusb -v -d 038f:0541\n\nBus 001 Device 004: ID 038f:0541  \nDevice Descriptor:\n  bLength                18\n  bDescriptorType         1\n  bcdUSB               2.00\n  bDeviceClass          239 Miscellaneous Device\n  bDeviceSubClass         2 ?\n  bDeviceProtocol         1 Interface Association\n  bMaxPacketSize0        64\n  idVendor           0x038f \n  idProduct          0x0541 \n  bcdDevice            0.04\n  iManufacturer           1 lihappe8 Corp.\n  iProduct                2 USB 2.0 Camera\n  iSerial                 0 \n  bNumConfigurations      1\n  Configuration Descriptor:\n    bLength                 9\n    bDescriptorType         2\n    wTotalLength         1096\n    bNumInterfaces          4\n    bConfigurationValue     1\n    iConfiguration          0 \n    bmAttributes         0x80\n      (Bus Powered)\n    MaxPower              500mA\n    Interface Association:\n      bLength                 8\n      bDescriptorType        11\n      bFirstInterface         0\n      bInterfaceCount         2\n      bFunctionClass         14 Video\n      bFunctionSubClass       3 Video Interface Collection\n      bFunctionProtocol       0 \n      iFunction               4 USB 2.0 Camera\n    Interface Descriptor:\n      bLength                 9\n      bDescriptorType         4\n      bInterfaceNumber        0\n      bAlternateSetting       0\n      bNumEndpoints           1\n      bInterfaceClass        14 Video\n      bInterfaceSubClass      1 Video Control\n      bInterfaceProtocol      0 \n      iInterface              4 USB 2.0 Camera\n      VideoControl Interface Descriptor:\n        bLength                13\n        bDescriptorType        36\n        bDescriptorSubtype      1 (HEADER)\n        bcdUVC               1.00\n        wTotalLength           79\n        dwClockFrequency       30.000000MHz\n        bInCollection           1\n        baInterfaceNr( 0)       1\n      VideoControl Interface Descriptor:\n        bLength                28\n        bDescriptorType        36\n        bDescriptorSubtype      6 (EXTENSION_UNIT)\n        bUnitID                 6\n        guidExtensionCode         {b0d0bb68-a461-834b-90b7-a6215f3c4f70}\n        bNumControl            24\n        bNrPins                 1\n        baSourceID( 0)          2\n        bControlSize            3\n        bmControls( 0)       0xff\n        bmControls( 1)       0xff\n        bmControls( 2)       0xff\n        iExtension              0 \n      VideoControl Interface Descriptor:\n        bLength                18\n        bDescriptorType        36\n        bDescriptorSubtype      2 (INPUT_TERMINAL)\n        bTerminalID             1\n        wTerminalType      0x0201 Camera Sensor\n        bAssocTerminal          0\n        iTerminal               0 \n        wObjectiveFocalLengthMin      0\n        wObjectiveFocalLengthMax      0\n        wOcularFocalLength            0\n        bControlSize                  3\n        bmControls           0x00000000\n      VideoControl Interface Descriptor:\n        bLength                11\n        bDescriptorType        36\n        bDescriptorSubtype      5 (PROCESSING_UNIT)\n      Warning: Descriptor too short\n        bUnitID                 2\n        bSourceID               1\n        wMaxMultiplier          0\n        bControlSize            2\n        bmControls     0x0000157f\n          Brightness\n          Contrast\n          Hue\n          Saturation\n          Sharpness\n          Gamma\n          White Balance Temperature\n          Backlight Compensation\n          Power Line Frequency\n          White Balance Temperature, Auto\n        iProcessing             0 \n        bmVideoStandards     0x 9\n          None\n          SECAM - 625/50\n      VideoControl Interface Descriptor:\n        bLength                 9\n        bDescriptorType        36\n        bDescriptorSubtype      3 (OUTPUT_TERMINAL)\n        bTerminalID             3\n        wTerminalType      0x0101 USB Streaming\n        bAssocTerminal          0\n        bSourceID               2\n        iTerminal               0 \n      Endpoint Descriptor:\n        bLength                 7\n        bDescriptorType         5\n        bEndpointAddress     0x81  EP 1 IN\n        bmAttributes            3\n          Transfer Type            Interrupt\n          Synch Type               None\n          Usage Type               Data\n        wMaxPacketSize     0x0010  1x 16 bytes\n        bInterval               7\n    Interface Descriptor:\n      bLength                 9\n      bDescriptorType         4\n      bInterfaceNumber        1\n      bAlternateSetting       0\n      bNumEndpoints           0\n      bInterfaceClass        14 Video\n      bInterfaceSubClass      2 Video Streaming\n      bInterfaceProtocol      0 \n      iInterface              4 USB 2.0 Camera\n      VideoStreaming Interface Descriptor:\n        bLength                            15\n        bDescriptorType                    36\n        bDescriptorSubtype                  1 (INPUT_HEADER)\n        bNumFormats                         2\n        wTotalLength                      773\n        bEndPointAddress                  130\n        bmInfo                              0\n        bTerminalLink                       3\n        bStillCaptureMethod                 2\n        bTriggerSupport                     1\n        bTriggerUsage                       0\n        bControlSize                        1\n        bmaControls( 0)                    27\n        bmaControls( 1)                    27\n      VideoStreaming Interface Descriptor:\n        bLength                            27\n        bDescriptorType                    36\n        bDescriptorSubtype                  4 (FORMAT_UNCOMPRESSED)\n        bFormatIndex                        1\n        bNumFrameDescriptors                8\n        guidFormat                            {59555932-0000-1000-8000-00aa00389b71}\n        bBitsPerPixel                      16\n        bDefaultFrameIndex                  1\n        bAspectRatioX                       0\n        bAspectRatioY                       0\n        bmInterlaceFlags                 0x00\n          Interlaced stream or variable: No\n          Fields per frame: 2 fields\n          Field 1 first: No\n          Field pattern: Field 1 only\n          bCopyProtect                      0\n      VideoStreaming Interface Descriptor:\n        bLength                            50\n        bDescriptorType                    36\n        bDescriptorSubtype                  5 (FRAME_UNCOMPRESSED)\n        bFrameIndex                         1\n        bmCapabilities                   0x00\n          Still image unsupported\n        wWidth                            640\n        wHeight                           480\n        dwMinBitRate                 24576000\n        dwMaxBitRate                147456000\n        dwMaxVideoFrameBufferSize      614400\n        dwDefaultFrameInterval         333333\n        bFrameIntervalType                  6\n        dwFrameInterval( 0)            333333\n        dwFrameInterval( 1)            400000\n        dwFrameInterval( 2)            500000\n        dwFrameInterval( 3)            666666\n        dwFrameInterval( 4)           1000000\n        dwFrameInterval( 5)           2000000\n      VideoStreaming Interface Descriptor:\n        bLength                            50\n        bDescriptorType                    36\n        bDescriptorSubtype                  5 (FRAME_UNCOMPRESSED)\n        bFrameIndex                         2\n        bmCapabilities                   0x00\n          Still image unsupported\n        wWidth                            160\n        wHeight                           120\n        dwMinBitRate                  1536000\n        dwMaxBitRate                  9216000\n        dwMaxVideoFrameBufferSize       38400\n        dwDefaultFrameInterval         333333\n        bFrameIntervalType                  6\n        dwFrameInterval( 0)            333333\n        dwFrameInterval( 1)            400000\n        dwFrameInterval( 2)            500000\n        dwFrameInterval( 3)            666666\n        dwFrameInterval( 4)           1000000\n        dwFrameInterval( 5)           2000000\n      VideoStreaming Interface Descriptor:\n        bLength                            50\n        bDescriptorType                    36\n        bDescriptorSubtype                  5 (FRAME_UNCOMPRESSED)\n        bFrameIndex                         3\n        bmCapabilities                   0x00\n          Still image unsupported\n        wWidth                            320\n        wHeight                           240\n        dwMinBitRate                  6144000\n        dwMaxBitRate                 36864000\n        dwMaxVideoFrameBufferSize      153600\n        dwDefaultFrameInterval         333333\n        bFrameIntervalType                  6\n        dwFrameInterval( 0)            333333\n        dwFrameInterval( 1)            400000\n        dwFrameInterval( 2)            500000\n        dwFrameInterval( 3)            666666\n        dwFrameInterval( 4)           1000000\n        dwFrameInterval( 5)           2000000\n      VideoStreaming Interface Descriptor:\n        bLength                            50\n        bDescriptorType                    36\n        bDescriptorSubtype                  5 (FRAME_UNCOMPRESSED)\n        bFrameIndex                         4\n        bmCapabilities                   0x00\n          Still image unsupported\n        wWidth                            352\n        wHeight                           288\n        dwMinBitRate                  8110080\n        dwMaxBitRate                 48660480\n        dwMaxVideoFrameBufferSize      202752\n        dwDefaultFrameInterval         333333\n        bFrameIntervalType                  6\n        dwFrameInterval( 0)            333333\n        dwFrameInterval( 1)            400000\n        dwFrameInterval( 2)            500000\n        dwFrameInterval( 3)            666666\n        dwFrameInterval( 4)           1000000\n        dwFrameInterval( 5)           2000000\n      VideoStreaming Interface Descriptor:\n        bLength                            38\n        bDescriptorType                    36\n        bDescriptorSubtype                  5 (FRAME_UNCOMPRESSED)\n        bFrameIndex                         5\n        bmCapabilities                   0x00\n          Still image unsupported\n        wWidth                            800\n        wHeight                           600\n        dwMinBitRate                 38400000\n        dwMaxBitRate                115200000\n        dwMaxVideoFrameBufferSize      960000\n        dwDefaultFrameInterval         666666\n        bFrameIntervalType                  3\n        dwFrameInterval( 0)            666666\n        dwFrameInterval( 1)           1000000\n        dwFrameInterval( 2)           2000000\n      VideoStreaming Interface Descriptor:\n        bLength                            38\n        bDescriptorType                    36\n        bDescriptorSubtype                  5 (FRAME_UNCOMPRESSED)\n        bFrameIndex                         6\n        bmCapabilities                   0x00\n          Still image unsupported\n        wWidth                           1280\n        wHeight                           720\n        dwMinBitRate                 73728000\n        dwMaxBitRate                221184000\n        dwMaxVideoFrameBufferSize     1843200\n        dwDefaultFrameInterval         666666\n        bFrameIntervalType                  3\n        dwFrameInterval( 0)            666666\n        dwFrameInterval( 1)           1000000\n        dwFrameInterval( 2)           2000000\n      VideoStreaming Interface Descriptor:\n        bLength                            38\n        bDescriptorType                    36\n        bDescriptorSubtype                  5 (FRAME_UNCOMPRESSED)\n        bFrameIndex                         7\n        bmCapabilities                   0x00\n          Still image unsupported\n        wWidth                           1280\n        wHeight                          1024\n        dwMinBitRate                104857600\n        dwMaxBitRate                251658240\n        dwMaxVideoFrameBufferSize     2621440\n        dwDefaultFrameInterval         833333\n        bFrameIntervalType                  3\n        dwFrameInterval( 0)            833333\n        dwFrameInterval( 1)           1000000\n        dwFrameInterval( 2)           2000000\n      VideoStreaming Interface Descriptor:\n        bLength                            34\n        bDescriptorType                    36\n        bDescriptorSubtype                  5 (FRAME_UNCOMPRESSED)\n        bFrameIndex                         8\n        bmCapabilities                   0x00\n          Still image unsupported\n        wWidth                           1600\n        wHeight                          1200\n        dwMinBitRate                153600000\n        dwMaxBitRate                276480000\n        dwMaxVideoFrameBufferSize     3840000\n        dwDefaultFrameInterval        1111111\n        bFrameIntervalType                  2\n        dwFrameInterval( 0)           1111111\n        dwFrameInterval( 1)           2000000\n      VideoStreaming Interface Descriptor:\n        bLength                            10\n        bDescriptorType                    36\n        bDescriptorSubtype                  3 (STILL_IMAGE_FRAME)\n        bEndpointAddress                    0\n        bNumImageSizePatterns               1\n        wWidth( 0)                       1600\n        wHeight( 0)                      1200\n        bNumCompressionPatterns             1\n      VideoStreaming Interface Descriptor:\n        bLength                             6\n        bDescriptorType                    36\n        bDescriptorSubtype                 13 (COLORFORMAT)\n        bColorPrimaries                     1 (BT.709,sRGB)\n        bTransferCharacteristics            1 (BT.709)\n        bMatrixCoefficients                 4 (SMPTE 170M (BT.601))\n      VideoStreaming Interface Descriptor:\n        bLength                            11\n        bDescriptorType                    36\n        bDescriptorSubtype                  6 (FORMAT_MJPEG)\n        bFormatIndex                        2\n        bNumFrameDescriptors                7\n        bFlags                              1\n          Fixed-size samples: Yes\n        bDefaultFrameIndex                  1\n        bAspectRatioX                       0\n        bAspectRatioY                       0\n        bmInterlaceFlags                 0x00\n          Interlaced stream or variable: No\n          Fields per frame: 1 fields\n          Field 1 first: No\n          Field pattern: Field 1 only\n          bCopyProtect                      0\n      VideoStreaming Interface Descriptor:\n        bLength                            50\n        bDescriptorType                    36\n        bDescriptorSubtype                  7 (FRAME_MJPEG)\n        bFrameIndex                         1\n        bmCapabilities                   0x00\n          Still image unsupported\n        wWidth                            640\n        wHeight                           480\n        dwMinBitRate                 36864000\n        dwMaxBitRate                221184000\n        dwMaxVideoFrameBufferSize      921600\n        dwDefaultFrameInterval         333333\n        bFrameIntervalType                  6\n        dwFrameInterval( 0)            333333\n        dwFrameInterval( 1)            400000\n        dwFrameInterval( 2)            500000\n        dwFrameInterval( 3)            666666\n        dwFrameInterval( 4)           1000000\n        dwFrameInterval( 5)           2000000\n      VideoStreaming Interface Descriptor:\n        bLength                            50\n        bDescriptorType                    36\n        bDescriptorSubtype                  7 (FRAME_MJPEG)\n        bFrameIndex                         2\n        bmCapabilities                   0x00\n          Still image unsupported\n        wWidth                            160\n        wHeight                           120\n        dwMinBitRate                  2304000\n        dwMaxBitRate                 13824000\n        dwMaxVideoFrameBufferSize       57600\n        dwDefaultFrameInterval         333333\n        bFrameIntervalType                  6\n        dwFrameInterval( 0)            333333\n        dwFrameInterval( 1)            400000\n        dwFrameInterval( 2)            500000\n        dwFrameInterval( 3)            666666\n        dwFrameInterval( 4)           1000000\n        dwFrameInterval( 5)           2000000\n      VideoStreaming Interface Descriptor:\n        bLength                            50\n        bDescriptorType                    36\n        bDescriptorSubtype                  7 (FRAME_MJPEG)\n        bFrameIndex                         3\n        bmCapabilities                   0x00\n          Still image unsupported\n        wWidth                            320\n        wHeight                           240\n        dwMinBitRate                  9216000\n        dwMaxBitRate                 55296000\n        dwMaxVideoFrameBufferSize      230400\n        dwDefaultFrameInterval         333333\n        bFrameIntervalType                  6\n        dwFrameInterval( 0)            333333\n        dwFrameInterval( 1)            400000\n        dwFrameInterval( 2)            500000\n        dwFrameInterval( 3)            666666\n        dwFrameInterval( 4)           1000000\n        dwFrameInterval( 5)           2000000\n      VideoStreaming Interface Descriptor:\n        bLength                            50\n        bDescriptorType                    36\n        bDescriptorSubtype                  7 (FRAME_MJPEG)\n        bFrameIndex                         4\n        bmCapabilities                   0x00\n          Still image unsupported\n        wWidth                            352\n        wHeight                           288\n        dwMinBitRate                 12165120\n        dwMaxBitRate                 72990720\n        dwMaxVideoFrameBufferSize      304128\n        dwDefaultFrameInterval         333333\n        bFrameIntervalType                  6\n        dwFrameInterval( 0)            333333\n        dwFrameInterval( 1)            400000\n        dwFrameInterval( 2)            500000\n        dwFrameInterval( 3)            666666\n        dwFrameInterval( 4)           1000000\n        dwFrameInterval( 5)           2000000\n      VideoStreaming Interface Descriptor:\n        bLength                            50\n        bDescriptorType                    36\n        bDescriptorSubtype                  7 (FRAME_MJPEG)\n        bFrameIndex                         5\n        bmCapabilities                   0x00\n          Still image unsupported\n        wWidth                            800\n        wHeight                           600\n        dwMinBitRate                 57600000\n        dwMaxBitRate                345600000\n        dwMaxVideoFrameBufferSize     1440000\n        dwDefaultFrameInterval         333333\n        bFrameIntervalType                  6\n        dwFrameInterval( 0)            333333\n        dwFrameInterval( 1)            400000\n        dwFrameInterval( 2)            500000\n        dwFrameInterval( 3)            666666\n        dwFrameInterval( 4)           1000000\n        dwFrameInterval( 5)           2000000\n      VideoStreaming Interface Descriptor:\n        bLength                            50\n        bDescriptorType                    36\n        bDescriptorSubtype                  7 (FRAME_MJPEG)\n        bFrameIndex                         6\n        bmCapabilities                   0x00\n          Still image unsupported\n        wWidth                           1280\n        wHeight                           720\n        dwMinBitRate                110592000\n        dwMaxBitRate                663552000\n        dwMaxVideoFrameBufferSize     2764800\n        dwDefaultFrameInterval         333333\n        bFrameIntervalType                  6\n        dwFrameInterval( 0)            333333\n        dwFrameInterval( 1)            400000\n        dwFrameInterval( 2)            500000\n        dwFrameInterval( 3)            666666\n        dwFrameInterval( 4)           1000000\n        dwFrameInterval( 5)           2000000\n      VideoStreaming Interface Descriptor:\n        bLength                            50\n        bDescriptorType                    36\n        bDescriptorSubtype                  7 (FRAME_MJPEG)\n        bFrameIndex                         7\n        bmCapabilities                   0x00\n          Still image unsupported\n        wWidth                           1280\n        wHeight                          1024\n        dwMinBitRate                157286400\n        dwMaxBitRate                943718400\n        dwMaxVideoFrameBufferSize     3932160\n        dwDefaultFrameInterval         333333\n        bFrameIntervalType                  6\n        dwFrameInterval( 0)            333333\n        dwFrameInterval( 1)            400000\n        dwFrameInterval( 2)            500000\n        dwFrameInterval( 3)            666666\n        dwFrameInterval( 4)           1000000\n        dwFrameInterval( 5)           2000000\n      VideoStreaming Interface Descriptor:\n        bLength                             6\n        bDescriptorType                    36\n        bDescriptorSubtype                 13 (COLORFORMAT)\n        bColorPrimaries                     1 (BT.709,sRGB)\n        bTransferCharacteristics            1 (BT.709)\n        bMatrixCoefficients                 4 (SMPTE 170M (BT.601))\n    Interface Descriptor:\n      bLength                 9\n      bDescriptorType         4\n      bInterfaceNumber        1\n      bAlternateSetting       1\n      bNumEndpoints           1\n      bInterfaceClass        14 Video\n      bInterfaceSubClass      2 Video Streaming\n      bInterfaceProtocol      0 \n      iInterface              4 USB 2.0 Camera\n      Endpoint Descriptor:\n        bLength                 7\n        bDescriptorType         5\n        bEndpointAddress     0x82  EP 2 IN\n        bmAttributes            5\n          Transfer Type            Isochronous\n          Synch Type               Asynchronous\n          Usage Type               Data\n        wMaxPacketSize     0x1400  3x 1024 bytes\n        bInterval               1\n    Interface Descriptor:\n      bLength                 9\n      bDescriptorType         4\n      bInterfaceNumber        1\n      bAlternateSetting       2\n      bNumEndpoints           1\n      bInterfaceClass        14 Video\n      bInterfaceSubClass      2 Video Streaming\n      bInterfaceProtocol      0 \n      iInterface              4 USB 2.0 Camera\n      Endpoint Descriptor:\n        bLength                 7\n        bDescriptorType         5\n        bEndpointAddress     0x82  EP 2 IN\n        bmAttributes            5\n          Transfer Type            Isochronous\n          Synch Type               Asynchronous\n          Usage Type               Data\n        wMaxPacketSize     0x0c00  2x 1024 bytes\n        bInterval               1\n    Interface Descriptor:\n      bLength                 9\n      bDescriptorType         4\n      bInterfaceNumber        1\n      bAlternateSetting       3\n      bNumEndpoints           1\n      bInterfaceClass        14 Video\n      bInterfaceSubClass      2 Video Streaming\n      bInterfaceProtocol      0 \n      iInterface              4 USB 2.0 Camera\n      Endpoint Descriptor:\n        bLength                 7\n        bDescriptorType         5\n        bEndpointAddress     0x82  EP 2 IN\n        bmAttributes            5\n          Transfer Type            Isochronous\n          Synch Type               Asynchronous\n          Usage Type               Data\n        wMaxPacketSize     0x0400  1x 1024 bytes\n        bInterval               1\n    Interface Descriptor:\n      bLength                 9\n      bDescriptorType         4\n      bInterfaceNumber        1\n      bAlternateSetting       4\n      bNumEndpoints           1\n      bInterfaceClass        14 Video\n      bInterfaceSubClass      2 Video Streaming\n      bInterfaceProtocol      0 \n      iInterface              4 USB 2.0 Camera\n      Endpoint Descriptor:\n        bLength                 7\n        bDescriptorType         5\n        bEndpointAddress     0x82  EP 2 IN\n        bmAttributes            5\n          Transfer Type            Isochronous\n          Synch Type               Asynchronous\n          Usage Type               Data\n        wMaxPacketSize     0x0200  1x 512 bytes\n        bInterval               1\n    Interface Association:\n      bLength                 8\n      bDescriptorType        11\n      bFirstInterface         2\n      bInterfaceCount         2\n      bFunctionClass          1 Audio\n      bFunctionSubClass       0 \n      bFunctionProtocol       0 \n      iFunction               5 USB Digital Audio\n    Interface Descriptor:\n      bLength                 9\n      bDescriptorType         4\n      bInterfaceNumber        2\n      bAlternateSetting       0\n      bNumEndpoints           0\n      bInterfaceClass         1 Audio\n      bInterfaceSubClass      1 Control Device\n      bInterfaceProtocol      0 \n      iInterface              5 USB Digital Audio\n      AudioControl Interface Descriptor:\n        bLength                 9\n        bDescriptorType        36\n        bDescriptorSubtype      1 (HEADER)\n        bcdADC               1.00\n        wTotalLength           43\n        bInCollection           1\n        baInterfaceNr( 0)       3\n      AudioControl Interface Descriptor:\n        bLength                12\n        bDescriptorType        36\n        bDescriptorSubtype      2 (INPUT_TERMINAL)\n        bTerminalID             1\n        wTerminalType      0x0201 Microphone\n        bAssocTerminal          0\n        bNrChannels             2\n        wChannelConfig     0x0003\n          Left Front (L)\n          Right Front (R)\n        iChannelNames           0 \n        iTerminal               0 \n      AudioControl Interface Descriptor:\n        bLength                13\n        bDescriptorType        36\n        bDescriptorSubtype      6 (FEATURE_UNIT)\n        bUnitID                 5\n        bSourceID               1\n        bControlSize            2\n        bmaControls( 0)      0x01\n        bmaControls( 0)      0x00\n          Mute Control\n        bmaControls( 1)      0x03\n        bmaControls( 1)      0x00\n          Mute Control\n          Volume Control\n        bmaControls( 2)      0x03\n        bmaControls( 2)      0x00\n          Mute Control\n          Volume Control\n        iFeature                0 \n      AudioControl Interface Descriptor:\n        bLength                 9\n        bDescriptorType        36\n        bDescriptorSubtype      3 (OUTPUT_TERMINAL)\n        bTerminalID             3\n        wTerminalType      0x0101 USB Streaming\n        bAssocTerminal          0\n        bSourceID               5\n        iTerminal               0 \n    Interface Descriptor:\n      bLength                 9\n      bDescriptorType         4\n      bInterfaceNumber        3\n      bAlternateSetting       0\n      bNumEndpoints           0\n      bInterfaceClass         1 Audio\n      bInterfaceSubClass      2 Streaming\n      bInterfaceProtocol      0 \n      iInterface              5 USB Digital Audio\n    Interface Descriptor:\n      bLength                 9\n      bDescriptorType         4\n      bInterfaceNumber        3\n      bAlternateSetting       1\n      bNumEndpoints           1\n      bInterfaceClass         1 Audio\n      bInterfaceSubClass      2 Streaming\n      bInterfaceProtocol      0 \n      iInterface              5 USB Digital Audio\n      AudioStreaming Interface Descriptor:\n        bLength                 7\n        bDescriptorType        36\n        bDescriptorSubtype      1 (AS_GENERAL)\n        bTerminalLink           3\n        bDelay                  1 frames\n        wFormatTag              1 PCM\n      AudioStreaming Interface Descriptor:\n        bLength                32\n        bDescriptorType        36\n        bDescriptorSubtype      2 (FORMAT_TYPE)\n        bFormatType             1 (FORMAT_TYPE_I)\n        bNrChannels             2\n        bSubframeSize           2\n        bBitResolution         16\n        bSamFreqType            8 Discrete\n        tSamFreq[ 0]        48000\n        tSamFreq[ 1]        44100\n        tSamFreq[ 2]        24000\n        tSamFreq[ 3]        22050\n        tSamFreq[ 4]        16000\n        tSamFreq[ 5]        12000\n        tSamFreq[ 6]        11025\n        tSamFreq[ 7]         8000\n      Endpoint Descriptor:\n        bLength                 9\n        bDescriptorType         5\n        bEndpointAddress     0x83  EP 3 IN\n        bmAttributes           13\n          Transfer Type            Isochronous\n          Synch Type               Synchronous\n          Usage Type               Data\n        wMaxPacketSize     0x00c8  1x 200 bytes\n        bInterval               4\n        bRefresh                0\n        bSynchAddress           0\n        AudioControl Endpoint Descriptor:\n          bLength                 7\n          bDescriptorType        37\n          bDescriptorSubtype      1 (EP_GENERAL)\n          bmAttributes         0x01\n            Sampling Frequency\n          bLockDelayUnits         1 Milliseconds\n          wLockDelay              0 Milliseconds\nDevice Qualifier (for other device speed):\n  bLength                10\n  bDescriptorType         6\n  bcdUSB               2.00\n  bDeviceClass          239 Miscellaneous Device\n  bDeviceSubClass         2 ?\n  bDeviceProtocol         1 Interface Association\n  bMaxPacketSize0        64\n  bNumConfigurations      1\nDevice Status:     0x0000\n  (Bus Powered)\n</code></pre>"},{"location":"13_V4L2/04_1/#2-uvc","title":"2. UVC\u200b\u9a71\u52a8\u200b\u6846\u67b6","text":"<p>\u200b\u5185\u6838\u200b\u6e90\u7801\u200b: <code>drivers\\media\\usb\\uvc\\uvc_driver.c</code>\uff0c\u200b\u6ce8\u518c\u200b\u4e86\u200b\u4e00\u4e2a\u200busb_driver\uff0c\u200b\u5b83\u200b\u7684\u200bid_table\u200b\u8868\u793a\u200b\uff1a\u200b\u5b83\u200b\u662f\u200bVideoControl Interface\u200b\u7684\u200b\u9a71\u52a8\u200b\u3002\u200b\u5728\u200buvc_probe\u200b\u91cc\u200b\uff0c\u200b\u518d\u200b\u9488\u5bf9\u200bVideoStreaming Interface\u200b\u8fdb\u884c\u200b\u5904\u7406\u200b\u3002</p> <p></p>"},{"location":"13_V4L2/04_1/#21","title":"2.1 \u200b\u8bbe\u5907\u200b\u679a\u4e3e\u200b\u8fc7\u7a0b","text":"<p>\u200b\u5206\u6790\u200b\u4ee3\u7801\u200b\uff1a<code>drivers\\media\\usb\\uvc\\uvc_driver.c</code></p> <p>\u200b\u4ee3\u7801\u200b\u8c03\u7528\u200b\u8fc7\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>uvc_probe\n    struct uvc_device *dev;\n\n    // \u200b\u521b\u5efa\u200b\u4e00\u4e2a\u200buvc_devcie\n    if ((dev = kzalloc(sizeof *dev, GFP_KERNEL)) == NULL) \n\n    /* Parse the Video Class control descriptor. */\n    if (uvc_parse_control(dev) &lt; 0) \n            if ((ret = uvc_parse_standard_control(dev, buffer, buflen)) &lt; 0)\n                // 1. \u200b\u89e3\u6790\u200bVideoStreaming Interface\n                // 1.1 \u200b\u5206\u914d\u200b\u5bf9\u5e94\u200b\u7684\u200buvc_streaming\u200b\u7ed3\u6784\u200b\u4f53\u200b\n                // 1.2 \u200b\u63a5\u7eed\u200bformat\u3001format\u200b\u4e0b\u200b\u7684\u200bframe\n                // 1.3 \u200b\u52a0\u5165\u200buvc_device\u200b\u7684\u200bstreams\u200b\u94fe\u8868\u200b\uff1a\n                list_add_tail(&amp;streaming-&gt;list, &amp;dev-&gt;streams);\n\n                // 2.1 \u200b\u89e3\u6790\u200bVideoControl Interface\u200b\u91cc\u200b\u7684\u200b\u6bcf\u200b\u4e00\u4e2a\u200bentity\n                // 2.2 \u200b\u5206\u914d\u200b\u5bf9\u5e94\u200b\u7684\u200buvc_entity\u200b\u7ed3\u6784\u200b\u4f53\u200b\n                // 2.3 \u200b\u52a0\u5165\u200buvc_device\u200b\u7684\u200bentities\u200b\u94fe\u8868\u200b\n\n    // \u200b\u521d\u59cb\u5316\u200bv4l2_dev\u200b\u7ed3\u6784\u200b\u4f53\u200b\n    if (v4l2_device_register(&amp;intf-&gt;dev, &amp;dev-&gt;vdev) &lt; 0)\n\n    // Initialize controls.\n    // \u200b\u5bf9\u4e8e\u200b\u6bcf\u4e2a\u200bentity\uff0c\u200b\u521d\u59cb\u5316\u200b\u5b83\u4eec\u200b\u7684\u200bcontrol\n    if (uvc_ctrl_init_device(dev) &lt; 0)\n\n    // Scan the device for video chains.\n    // \u200b\u4ece\u200b\u6bcf\u200b\u4e00\u4e2a\u200boutput terminal\u200b\u5f80\u56de\u200b\u904d\u5386\u200b\uff0c\u200b\u627e\u5230\u200bchain\u200b\u4e0a\u200b\u7684\u200b\u6bcf\u4e2a\u200bentity\n    if (uvc_scan_device(dev) &lt; 0)\n            // 1. \u200b\u5206\u914d\u200buvc_video_chain\u200b\u7ed3\u6784\u200b\u4f53\u200b: chain = uvc_alloc_chain(dev);\n            // 2. list_add_tail(&amp;chain-&gt;list, &amp;dev-&gt;chains);\n\n    // Register video device nodes.\n    if (uvc_register_chains(dev) &lt; 0)\n        // 1. \u200b\u5bf9\u4e8e\u200b\u7c7b\u578b\u200b\u4e3a\u200bUVC_TT_STREAMING\u200b\u7684\u200bOT\n        // 2. \u200b\u627e\u5230\u200b\u5bf9\u5e94\u200b\u7684\u200buvc_streaming\n        // 3. ret = uvc_register_video(dev, stream);\n                        // \u200b\u5c31\u662f\u200bvideo\u200b\u8bbe\u5907\u200b\u90a3\u200b\u4e00\u5957\u200b\u4e86\u200b\n</code></pre> <p>UVC\u200b\u8ddf\u200bvideo\u200b\u7684\u200b\u5bf9\u63a5\u200b\uff1a</p> <pre><code>static int uvc_register_video(struct uvc_device *dev,\n        struct uvc_streaming *stream)\n{\n    struct video_device *vdev = &amp;stream-&gt;vdev;\n    int ret;\n\n    /* Initialize the video buffers queue. */\n    ret = uvc_queue_init(&amp;stream-&gt;queue, stream-&gt;type, !uvc_no_drop_param);\n    if (ret)\n        return ret;\n\n    /* Initialize the streaming interface with default streaming\n     * parameters.\n     */\n    ret = uvc_video_init(stream);\n    if (ret &lt; 0) {\n        uvc_printk(KERN_ERR, \"Failed to initialize the device \"\n            \"(%d).\\n\", ret);\n        return ret;\n    }\n\n    uvc_debugfs_init_stream(stream);\n\n    /* Register the device with V4L. */\n\n    /* We already hold a reference to dev-&gt;udev. The video device will be\n     * unregistered before the reference is released, so we don't need to\n     * get another one.\n     */\n    vdev-&gt;v4l2_dev = &amp;dev-&gt;vdev;\n    vdev-&gt;fops = &amp;uvc_fops;\n    vdev-&gt;ioctl_ops = &amp;uvc_ioctl_ops;\n    vdev-&gt;release = uvc_release;\n    vdev-&gt;prio = &amp;stream-&gt;chain-&gt;prio;\n    if (stream-&gt;type == V4L2_BUF_TYPE_VIDEO_OUTPUT)\n        vdev-&gt;vfl_dir = VFL_DIR_TX;\n    strlcpy(vdev-&gt;name, dev-&gt;name, sizeof vdev-&gt;name);\n\n    /* Set the driver data before calling video_register_device, otherwise\n     * uvc_v4l2_open might race us.\n     */\n    video_set_drvdata(vdev, stream);\n\n    ret = video_register_device(vdev, VFL_TYPE_GRABBER, -1);\n    if (ret &lt; 0) {\n        uvc_printk(KERN_ERR, \"Failed to register video device (%d).\\n\",\n               ret);\n        return ret;\n    }\n\n    if (stream-&gt;type == V4L2_BUF_TYPE_VIDEO_CAPTURE)\n        stream-&gt;chain-&gt;caps |= V4L2_CAP_VIDEO_CAPTURE;\n    else\n        stream-&gt;chain-&gt;caps |= V4L2_CAP_VIDEO_OUTPUT;\n\n    atomic_inc(&amp;dev-&gt;nstreams);\n    return 0;\n}\n</code></pre>"},{"location":"13_V4L2/04_1/#22","title":"2.2 \u200b\u8bbe\u5907\u200b\u63a7\u5236\u200b\u8fc7\u7a0b","text":"<p>\u200b\u4ee5\u200b\u8c03\u8282\u200b\u4eae\u5ea6\u200b\u4e3a\u4f8b\u200b\u3002</p> <p>APP\uff1a\u200b\u53c2\u8003\u200bGIT\u200b\u4ed3\u5e93\u200b</p> <pre><code>doc_and_source_for_drivers\\IMX6ULL\\source\\13_V4L2\\\n    05_video_brightness\\\n        video_test.c\n</code></pre> <p>\u200b\u6838\u5fc3\u200b\u4ee3\u7801\u200b\u4e3a\u200b\uff1a</p> <pre><code>struct v4l2_control ctl;\nctl.id = V4L2_CID_BRIGHTNESS; // V4L2_CID_BASE+0;\nctl.value = value;\nioctl(fd, VIDIOC_S_CTRL, &amp;ctl);\n</code></pre> <p>\u200b\u4e0a\u8ff0\u200b\u4ee3\u7801\u200b\u65f6\u200b\u5982\u4f55\u200b\u89e6\u53d1\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u8bbe\u7f6e\u200b\u91cc\u200b\u5bc4\u5b58\u5668\u200b\u7684\u200b\u67d0\u4e9b\u200b\u4f4d\u200b\u7684\u200b\uff1f</p>"},{"location":"13_V4L2/04_1/#221-control","title":"2.2.1 \u200b\u9a71\u52a8\u200b\u521d\u59cb\u5316\u200bcontrol\u200b\u7684\u200b\u8fc7\u7a0b","text":"<p>\u200b\u5206\u6790\u200b\u4ee3\u7801\u200b\uff1a<code>drivers\\media\\usb\\uvc\\uvc_driver.c</code></p> <p>\u200b\u8c03\u7528\u200b\u5173\u7cfb\u200b\uff1a</p> <pre><code>uvc_probe\n    uvc_parse_control // \u200b\u5f97\u5230\u200bPU\u200b\u7684\u200bentity\n    uvc_ctrl_init_device  // \u200b\u521d\u59cb\u5316\u200bPU\u200b\u7684\u200bcontrol\n        // \u200b\u4ece\u200b\u63cf\u8ff0\u7b26\u200b\u91cc\u200b\u5f97\u5230\u200b\u5173\u952e\u200b\u6570\u636e\u200b\n        bmControls = entity-&gt;processing.bmControls; // \u200b\u6bd4\u5982\u200b0x7F, 0x15\n        bControlSize = entity-&gt;processing.bControlSize;\n\n        // \u200b\u6839\u636e\u200bbmControls\u200b\u5206\u914d\u200b\u591a\u4e2a\u200buvc_control\u200b\u7ed3\u6784\u200b\u4f53\u200b\n        entity-&gt;controls = kcalloc(ncontrols, sizeof(*ctrl),\n                       GFP_KERNEL);\n\n        // \u200b\u5bf9\u4e8e\u200b\u6bcf\u4e2a\u200bcontrol\n        for (i = 0; i &lt; bControlSize * 8; ++i) {\n            ctrl-&gt;entity = entity;\n            ctrl-&gt;index = i;\n            uvc_ctrl_init_ctrl(dev, ctrl);\n        }\n</code></pre> <p>uvc_ctrl_init_ctrl\u200b\u5c31\u662f\u200b\u5173\u952e\u200b\u51fd\u6570\u200b\uff1a</p> <p></p> <p>\u200b\u5b83\u200b\u7684\u200b\u7ed3\u679c\u200b\u5982\u4e0b\u200b\u56fe\u200b\u6240\u793a\u200b\uff1a</p> <p></p>"},{"location":"13_V4L2/04_1/#222-appcontrol","title":"2.2.2 APP\u200b\u8bbe\u7f6e\u200bcontrol\u200b\u7684\u200b\u8fc7\u7a0b","text":"<p>APP\u200b\u8c03\u7528\u200b<code>ioctl(fd, VIDIOC_S_CTRL, &amp;ctl);</code>\uff0c\u200b\u4f1a\u200b\u8fdb\u5165\u200b\u9a71\u52a8\u200b\u3002</p> <p>\u200b\u8fdb\u5165\u200b\u9a71\u52a8\u200b\u540e\u200b\uff0c\u200b\u5bf9\u5e94\u200b\u51fd\u6570\u200b\u4e3a\u200b\uff1a</p> <p></p> <p>\u200b\u5185\u90e8\u200b\u6d41\u7a0b\u200b\u4e3a\u200b\uff1a</p> <p></p>"},{"location":"13_V4L2/04_1/#23","title":"2.3 \u200b\u6570\u636e\u4f20\u8f93\u200b\u8fc7\u7a0b","text":"<p>\u200b\u5bf9\u4e8e\u200b\u6444\u50cf\u5934\u200b\uff0c\u200b\u6570\u636e\u4f20\u8f93\u200b\u65f6\u200b\uff0c\u200b\u786c\u4ef6\u200b\u64cd\u4f5c\u200b\u90e8\u5206\u200b\u7531\u200b<code>vb2_ops</code>\u200b\u7ed3\u6784\u200b\u4f53\u200b\u5b8c\u6210\u200b\u3002UVC\u200b\u9a71\u52a8\u200b\u7684\u200bvb2_ops\u200b\u7ed3\u6784\u200b\u4f53\u200b\u8bbe\u7f6e\u200b\u6d41\u7a0b\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>uvc_probe\n    uvc_register_chains\n        uvc_register_terms\n            uvc_register_video\n                uvc_queue_init                  \n</code></pre> <p></p> <p>\u200b\u786c\u4ef6\u200b\u76f8\u5173\u200b\u7684\u200buvc_queue_qops\u200b\u5185\u5bb9\u200b\u5728\u200b<code>drivers\\media\\usb\\uvc\\uvc_queue.c</code>\u200b\u4e2d\u200b\u5b9a\u4e49\u200b\uff0c\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u5404\u200b\u6210\u5458\u200b\u7684\u200b\u4f5c\u7528\u200b\u4e3a\u200b\uff1a</p> vb2_ops\u200b\u7ed3\u6784\u200b\u4f53\u200b\u6210\u5458\u200b \u200b\u4f5c\u7528\u200b queue_setup APP\u200b\u8c03\u7528\u200bioctl VIDIOC_REQBUFS\u200b\u6216\u200bVIDIOC_CREATE_BUFS\u200b\u65f6\u200b\uff0c\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5728\u200b\u5206\u914d\u5185\u5b58\u200b\u4e4b\u524d\u200b\uff0c\u200b\u4f1a\u200b\u8c03\u7528\u200b\u6b64\u200b\u51fd\u6570\u200b\u3002\u200b\u4f5c\u7528\u200b\uff1a\u200b\u901a\u8fc7\u200b\u5b83\u200b\u6765\u200b\u8be2\u95ee\u200b\u786c\u4ef6\u200b\u9a71\u52a8\u200b\"\u200b\u4f60\u200b\u9700\u8981\u200b\u591a\u5c11\u200b\u4e2a\u200bbuffer\uff1f\u200b\u6bcf\u4e2a\u200bbuffer\u200b\u9700\u8981\u200b\u591a\u5c11\u200b\u4e2a\u200bplane\uff1f\"\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u88ab\u200b\u8c03\u7528\u200b2\u200b\u6b21\u200b\uff1a\u200b\u7b2c\u200b1\u200b\u6b21\u200b\u7528\u6765\u200b\u8868\u660e\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5bf9\u200bbuffer\u200b\u7684\u200b\u9700\u6c42\u200b\uff0c\u200b\u4f46\u662f\u200b\u4e0d\u200b\u4e00\u5b9a\u200b\u80fd\u200b\u5168\u90e8\u200b\u5206\u914d\u200b\u8fd9\u4e9b\u200bbuffer\uff0c\u200b\u5f53\u200b\u5206\u914d\u200b\u51fa\u200bbuffer\u200b\u540e\u200b\uff0c\u200b\u518d\u200b\u8c03\u7528\u200b\u7b2c\u200b2\u200b\u6b21\u4ee5\u200b\u9a8c\u8bc1\u200b\"\u200b\u8fd9\u4e9b\u200bbuffer\u200b\u662f\u5426\u200b\u8db3\u591f\u200b\"\u3002 wait_prepare \u200b\u91ca\u653e\u200b\u9a71\u52a8\u200b\u81ea\u5df1\u200b\u7684\u200b\u4e92\u65a5\u200b\u9501\u200b wait_finish \u200b\u7533\u8bf7\u200b\u9a71\u52a8\u200b\u81ea\u5df1\u200b\u7684\u200b\u4e92\u65a5\u200b\u9501\u200b buf_init \u200b\u5206\u914d\u200bvb2_buffer\u200b\u53ca\u200b\u5b83\u200b\u5185\u90e8\u200b\u5b58\u50a8\u200b\u6570\u636e\u200b\u7684\u200bbuffer\u200b\u540e\u200b\uff0c\u200b\u4f7f\u7528\u200bbuf_init\u200b\u8fdb\u884c\u200b\u9a71\u52a8\u200b\u76f8\u5173\u200b\u7684\u200b\u521d\u59cb\u5316\u200b buf_prepare APP\u200b\u8c03\u7528\u200bioctl VIDIOC_QBUF\u200b\u6216\u200bVIDIOC_PREPARE_BUF\u200b\u65f6\u200b\uff0c\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4f1a\u200b\u5728\u200b\u6267\u884c\u200b\u786c\u4ef6\u200b\u64cd\u4f5c\u524d\u200b\uff0c\u200b\u8c03\u7528\u200b\u6b64\u200b\u51fd\u6570\u200b\u8fdb\u884c\u200b\u5fc5\u8981\u200b\u7684\u200b\u521d\u59cb\u5316\u200b\u3002 buf_finish APP\u200b\u8c03\u7528\u200bioctl VIDIOC_DQBUF\u200b\u540e\u200b\uff0c\u200b\u5728\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u8fd4\u56de\u200b\u7528\u6237\u200b\u7a7a\u95f4\u200b\u4e4b\u524d\u200b\uff0c\u200b\u4f1a\u200b\u8c03\u7528\u200b\u6b64\u200b\u51fd\u6570\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u91cc\u200b\u4fee\u6539\u200bbuffer\u3002\u200b\u6216\u8005\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5185\u90e8\u200b\u505c\u6b62\u200b\u6216\u200b\u6682\u505c\u200bstreaming\u200b\u65f6\u200b\uff0c\u200b\u4e5f\u200b\u4f1a\u200b\u8c03\u7528\u200b\u6b64\u200b\u51fd\u6570\u200b\u3002 buf_cleanup \u200b\u5728\u200bbuffer\u200b\u88ab\u200b\u91ca\u653e\u200b\u524d\u200b\u8c03\u7528\u200b\uff0c\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5728\u200b\u8fd9\u4e2a\u200b\u51fd\u6570\u200b\u91cc\u200b\u6267\u884c\u200b\u989d\u5916\u200b\u7684\u200b\u6e05\u9664\u200b\u5de5\u4f5c\u200b\u3002 start_streaming \u200b\u9a71\u52a8\u200b\u76f8\u5173\u200b\u7684\u200b\"\u200b\u542f\u52a8\u200bstreaming\"\u200b\u51fd\u6570\u200b stop_streaming \u200b\u9a71\u52a8\u200b\u76f8\u5173\u200b\u7684\u200b\"\u200b\u505c\u6b62\u200bstreaming\"\u200b\u51fd\u6570\u200b buf_queue \u200b\u628a\u200bbuffer\u200b\u4f20\u9001\u200b\u7ed9\u200b\u9a71\u52a8\u200b\uff0c\u200b\u9a71\u52a8\u200b\u83b7\u5f97\u200b\u6570\u636e\u200b\u3001\u200b\u586b\u5145\u200b\u597d\u200bbuffer\u200b\u540e\u200b\u4f1a\u200b\u8c03\u7528\u200bvb2_buffer_done\u200b\u51fd\u6570\u200b\u8fd4\u8fd8\u200bbuffer\u3002"},{"location":"13_V4L2/04_1/#231","title":"2.3.1 \u200b\u6838\u5fc3\u200b\u7ed3\u6784\u200b\u4f53","text":"<p>\u200b\u5728\u200bUVC\u200b\u9a71\u52a8\u200b\u91cc\u200b\uff0c\u200b\u6bcf\u200b\u4e00\u4e2a\u200bbuffer\u200b\u7684\u200b\u6838\u5fc3\u200b\u4ecd\u7136\u200b\u662f\u200bvb2_v4l2_buffer.vb2_buffer\uff0c\u200b\u4e3a\u4e86\u200b\u4fbf\u4e8e\u200b\u786c\u4ef6\u200b\u9a71\u52a8\u200b\u7ba1\u7406\u200b\uff0c\u200b\u6269\u5c55\u200b\u4e3a\u200buvc_buffer\uff1a</p> <p></p> <p>\u200b\u7ba1\u7406\u200bbuffer\u200b\u7684\u200b\u6838\u5fc3\u200b\u4ecd\u7136\u200b\u662f\u200bvb2_queue\uff0c\u200b\u4e3a\u4f8b\u200b\u4fbf\u4e8e\u200b\u786c\u4ef6\u200b\u9a71\u52a8\u200b\u7ba1\u7406\u200b\uff0c\u200b\u6269\u5c55\u200b\u4e3a\u200buvc_video_queue\uff1a</p> <p></p> <p>buffer\u200b\u5165\u200b\u961f\u5217\u200b\u6d41\u7a0b\u200b\uff1a</p> <ul> <li>APP\u200b\u8c03\u7528\u200bioctl VIDIOC_QBUF</li> <li>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u6839\u636e\u200b\u5176\u200bindex\u200b\u627e\u5230\u200bvb2_buffer</li> <li>\u200b\u628a\u200b\u8fd9\u4e2a\u200bvb2_buffer\u200b\u653e\u5165\u200b\u94fe\u8868\u200bvb2_queue.queued_list</li> <li>\u200b\u628a\u200b\u5bf9\u5e94\u200b\u7684\u200buvc_buffer\u200b\u653e\u5165\u200birqqueue</li> </ul> <p>\u200b\u786c\u4ef6\u200b\u9a71\u52a8\u200b\u63a5\u6536\u200b\u5230\u200b\u6570\u636e\u200b\u540e\u200b\uff0c\u200b\u6bd4\u5982\u200bURB\u200b\u4f20\u8f93\u200b\u5b8c\u6210\u200b\u540e\u200b\uff1a</p> <ul> <li>\u200b\u4ece\u200b\u94fe\u8868\u200birqqueue\u200b\u5f97\u5230\u200b\u3001\u200b\u79fb\u9664\u200buvc_buffer</li> <li>\u200b\u628a\u200b\u786c\u4ef6\u200b\u6570\u636e\u200b\u5b58\u5165\u200buvc_buffer.vb2_v4l2_buffer.vb2_buffer</li> <li>\u200b\u628a\u200bvb2_buffer\u200b\u653e\u5165\u200b\u94fe\u8868\u200bvb2_queue.done_list</li> </ul> <p>\u200b\u51fa\u200b\u961f\u5217\u200b\u6d41\u7a0b\u200b\uff1a</p> <ul> <li>APP\u200b\u8c03\u7528\u200bioctl VIDIOC_DQBUF</li> <li>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4ece\u200b\u94fe\u8868\u200bvb2_queue.done_list\u200b\u53d6\u51fa\u200b\u5e76\u200b\u79fb\u9664\u200b\u7b2c\u200b1\u200b\u4e2a\u200bvb2_buffer</li> <li>\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u4e5f\u200b\u628a\u200b\u8fd9\u4e2a\u200bvb2_buffer\u200b\u4ece\u200b\u94fe\u8868\u200bvb2_queue.queued_list\u200b\u79fb\u9664\u200b</li> </ul>"},{"location":"13_V4L2/04_1/#232-buffer","title":"2.3.2 \u200b\u5206\u914d\u200bbuffer","text":"<p>\u200b\u5206\u914d\u200bbuffer\u200b\u65f6\u200b\uff0cqueue_setup\u200b\u51fd\u6570\u200b\u4f1a\u200b\u8fdb\u884c\u200b\u53c2\u6570\u200b\u5224\u65ad\u200b\u3001\u200b\u8c03\u6574\u200b\u3002</p>"},{"location":"13_V4L2/04_1/#233-buffer","title":"2.3.3 \u200b\u628a\u200bbuffer\u200b\u653e\u5165\u200b\u961f\u5217","text":"<p>APP\u200b\u628a\u200bbuffer\u200b\u653e\u5165\u200b\u961f\u5217\u200b\u65f6\u200b\uff0c\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u91cc\u200b<code>uvc_buffer_queue</code>\u200b\u88ab\u200b\u8c03\u7528\u200b\uff0c\u200b\u5b83\u200b\u628a\u200bbuffer\u200b\u653e\u5728\u200bqueue-&gt;irqqueue\u200b\u94fe\u8868\u200b\u91cc\u200b\uff1a</p> <p></p>"},{"location":"13_V4L2/04_1/#234","title":"2.3.4 \u200b\u542f\u52a8\u200b\u6444\u50cf\u5934","text":"<p>\u200b\u63d0\u4ea4\u200bURB\uff0c\u200b\u63d0\u4ea4\u200bURB\u200b\u7684\u200bcomplete\u200b\u51fd\u6570\u200b\u4e3a\u200buvc_video_complete\u3002\u200b\u8c03\u7528\u200b\u5173\u7cfb\u200b\u5982\u4e0b\u200b\uff1a</p> <pre><code>uvc_start_streaming\n    ret = uvc_video_enable(stream, 1);\n        ret = uvc_init_video(stream, GFP_KERNEL);\n            ret = uvc_init_video_isoc(stream, best_ep, gfp_flags);\n                urb = usb_alloc_urb(npackets, gfp_flags);\n                urb-&gt;complete = uvc_video_complete;\n            ret = usb_submit_urb(stream-&gt;urb[i], gfp_flags);    \n</code></pre>"},{"location":"13_V4L2/04_1/#235-urb","title":"2.3.5 URB\u200b\u4f20\u8f93\u200b\u5b8c\u6210","text":"<p>URB\u200b\u5b8c\u6210\u200b\u540e\u200b\uff0c\u200b\u5b83\u200b\u7684\u200bcomplete\u200b\u51fd\u6570\u200buvc_video_complete\u200b\u88ab\u200b\u8c03\u7528\u200b\uff0c\u200b\u8c03\u7528\u200b\u5173\u7cfb\u200b\u4e3a\u200b\uff1a</p> <pre><code>uvc_video_complete\n    stream-&gt;decode(urb, stream, buf); // \u200b\u5728\u200buvc_register_video\u200b\u4e2d\u200b\u88ab\u200b\u8bbe\u7f6e\u200b\n        uvc_video_decode_isoc       \n            uvc_queue_next_buffer\n                // \u200b\u89e3\u6790\u200b\u6570\u636e\u200b\u5b58\u5165\u200bbuffer\n\n                // \u200b\u53d6\u51fa\u200b\u4e0b\u200b\u4e00\u4e2a\u200bbuffer\n                nextbuf = list_first_entry(&amp;queue-&gt;irqqueue, struct uvc_buffer, queue);\n\n                // \u200b\u628a\u200b\u5f53\u524d\u200bbuffer\u200b\u653e\u5165\u200bdone_list\n                vb2_buffer_done(&amp;buf-&gt;buf.vb2_buf, VB2_BUF_STATE_DONE);\n</code></pre> <p>\u200b\u51fd\u6570\u200buvc_video_complete\u200b\u5728\u200b<code>drivers\\media\\usb\\uvc\\uvc_video.c</code>\u200b\u4e2d\u200b\u5b9a\u4e49\u200b\uff0c\u200b\u4ee3\u7801\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"13_V4L2/04_1/#236-buffer","title":"2.3.6 \u200b\u628a\u200bbuffer\u200b\u4ece\u200b\u961f\u5217\u200b\u53d6\u51fa","text":"<p>\u200b\u5e38\u89c4\u200b\u6d41\u7a0b\u200b\uff0c\u200b\u6ca1\u4ec0\u4e48\u200b\u7279\u6b8a\u200b\u7684\u200b\uff1a\u200b\u4ece\u200bdone_list\u200b\u53d6\u51fa\u200b\u3001\u200b\u79fb\u9664\u200bbuffer\uff0c\u200b\u4ece\u200bqueued_list\u200b\u79fb\u9664\u200bbuffer\u3002</p>"},{"location":"13_V4L2/05_1/","title":"MIPI\u200b\u6444\u50cf\u5934\u200b\u9a71\u52a8\u7a0b\u5e8f\u200b\u5206\u6790","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>\u200b\u5185\u6838\u200b\u6e90\u7801\u200b: <code>drivers\\media\\usb\\uvc\\uvc_driver.c</code></li> <li>\u200b\u5168\u5fd7\u200b \u200b\u82af\u7247\u200b Linux MIPI CSI\u200b\u6444\u50cf\u5934\u200b\u63a5\u53e3\u200b\u5f00\u53d1\u200b\u6307\u5357\u200b\uff1ahttps://blog.csdn.net/thisway_diy/article/details/128459836</li> <li>\u200b\u745e\u82af\u5fae\u200brk3568\u200b\u5e73\u53f0\u200b\u6444\u50cf\u5934\u200b\u63a7\u5236\u5668\u200bMIPI-CSI\u200b\u9a71\u52a8\u200b\u67b6\u6784\u200b\u68b3\u7406\u200b\uff1ahttps://zhuanlan.zhihu.com/p/621470492</li> <li>MIPI\u3001CSI\u200b\u57fa\u7840\u200b\uff1ahttps://zhuanlan.zhihu.com/p/599531271</li> <li>\u200b\u5168\u5fd7\u200bT7 CSIC\u200b\u6a21\u5757\u200b\uff1ahttps://blog.csdn.net/suwen8100/article/details/116226366</li> <li>\u200b\u5168\u5fd7\u200b\u5728\u7ebf\u200b\u6587\u6863\u200b\uff1ahttps://v853.docs.aw-ol.com/soft/soft_camera/</li> <li>\u200b\u53c2\u8003\u200b\u6e90\u7801\u200b\uff1a\u2005https://gitee.com/juping_zheng1/v85x-mediactrl</li> </ul>"},{"location":"13_V4L2/05_1/#1","title":"1. \u200b\u672f\u8bed","text":"\u672f\u8bed\u200b \u200b\u89e3\u91ca\u200b AE(Auto Exposure) \u200b\u81ea\u52a8\u200b\u66dd\u5149\u200b AF(Auto Focus) \u200b\u81ea\u52a8\u200b\u5bf9\u7126\u200b AWB(Auto White Balance) \u200b\u81ea\u52a8\u200b\u767d\u5e73\u8861\u200b 3A \u200b\u6307\u200b\u81ea\u52a8\u200b\u66dd\u5149\u200b(AE)\u3001\u200b\u81ea\u52a8\u200b\u5bf9\u7126\u200b(AF)\u200b\u548c\u200b\u81ea\u52a8\u200b\u767d\u5e73\u8861\u200b(AWB)\u200b\u7b97\u6cd5\u200b Async Sub Device \u200b\u5728\u200bMedia Controller\u200b\u7ed3\u6784\u200b\u4e0b\u200b\u6ce8\u518c\u200b\u7684\u200bV4L2\u200b\u5f02\u6b65\u200b\u5b50\u200b\u8bbe\u5907\u200b\uff0c\u200b\u4f8b\u200b Bayer Raw\uff08\u200b\u6216\u200bRaw Bayer\uff09 Bayer\u200b\u662f\u200b\u76f8\u673a\u200b\u5185\u90e8\u200b\u7684\u200b\u539f\u59cb\u200b\u56fe\u7247\u200b\uff0c\u200b\u4e00\u822c\u200b\u540e\u7f00\u200b\u4e3a\u200b.raw CIF Rockchip\u200b\u82af\u7247\u200b\u4e2d\u200b\u7684\u200bVIP\u200b\u6a21\u5757\u200b\uff0c\u200b\u63a5\u6536\u200bSensor\u200b\u6570\u636e\u200b\u5e76\u200b\u4fdd\u5b58\u200b\u5230\u200b\u5185\u5b58\u200b\u4e2d\u200b\uff0c\u200b\u4ec5\u200b\u8f6c\u5b58\u200b\u6570\u636e\u200b\uff0c\u200b\u65e0\u200bISP\u200b\u529f\u80fd\u200b DVP(Digital Video Port) \u200b\u4e00\u79cd\u200b\u5e76\u884c\u200b\u6570\u636e\u4f20\u8f93\u200b\u63a5\u53e3\u200b Entity Media Controller\u200b\u67b6\u6784\u200b\u4e0b\u200b\u7684\u200b\u5404\u200b\u8282\u70b9\u200b Frame \u200b\u5e27\u200b HSYNC \u200b\u884c\u200b\u540c\u6b65\u200b\u4fe1\u53f7\u200b\uff0cHSYNC\u200b\u6709\u6548\u200b\u65f6\u200b\uff0c\u200b\u63a5\u6536\u200b\u5230\u200b\u7684\u200b\u4fe1\u53f7\u200b\u5c5e\u4e8e\u200b\u540c\u4e00\u200b\u884c\u200b IOMMU(Input Output Memory Management Unit) Rockchip\u200b\u82af\u7247\u200b\u4e2d\u200b\u7684\u200bIOMMU\u200b\u6a21\u5757\u200b\uff0c\u200b\u7528\u4e8e\u200b\u5c06\u200b\u7269\u7406\u200b\u4e0a\u200b\u5206\u6563\u200b\u7684\u200b\u5185\u5b58\u200b\u9875\u200b\u6620\u5c04\u200b\u6210\u200bCIF\u3001ISP\u200b\u53ef\u89c1\u200b\u7684\u200b\u8fde\u7eed\u200b\u5185\u5b58\u200b IQ(Image Quality) \u200b\u6307\u200b\u4e3a\u200bBayer Raw Camera\u200b\u8c03\u8bd5\u200b\u7684\u200bIQ xml\uff0c\u200b\u7528\u4e8e\u200b3A tunning ISP(Image Signal Processing) \u200b\u56fe\u50cf\u200b\u4fe1\u53f7\u5904\u7406\u200b Media Controller Linux\u200b\u5185\u6838\u200b\u4e2d\u200b\u7684\u200b\u4e00\u79cd\u200b\u5a92\u4f53\u200b\u6846\u67b6\u200b\uff0c\u200b\u7528\u4e8e\u200b\u62d3\u6251\u200b\u7ed3\u6784\u200b\u7684\u200b\u7ba1\u7406\u200b MIPI-DPHY Rockchip\u200b\u82af\u7247\u200b\u4e2d\u200b\u7b26\u5408\u200bMIPI-DPHY\u200b\u534f\u8bae\u200b\u7684\u200b\u63a7\u5236\u5668\u200b MP(Main Path) Rockchip\u200b\u82af\u7247\u200bISP\u200b\u9a71\u52a8\u200b\u7684\u200b\u4e00\u4e2a\u200b\u8f93\u51fa\u200b\u8282\u70b9\u200b\uff0c\u200b\u4e00\u822c\u200b\u7528\u6765\u200b\u62cd\u7167\u200b\u548c\u200b\u6293\u53d6\u200bRaw\u200b\u56fe\u200b PCLK(Pixel Clock) \u200b\u6307\u200bSensor\u200b\u8f93\u51fa\u200b\u7684\u200bPixel Clock Pipeline Media Controller\u200b\u67b6\u6784\u200b\u7684\u200b\u5404\u200bEntity\u200b\u4e4b\u95f4\u200b\u76f8\u4e92\u8fde\u63a5\u200b\u5f62\u6210\u200b\u7684\u200b\u94fe\u8def\u200b SP(Self Patch) Rockchip\u200b\u82af\u7247\u200bISP\u200b\u9a71\u52a8\u200b\u7684\u200b\u4e00\u4e2a\u200b\u8f93\u51fa\u200b\u8282\u70b9\u200b V4L2(Video4Linux2) \u200b\u6307\u200bLinux\u200b\u5185\u6838\u200b\u7684\u200b\u89c6\u9891\u200b\u5904\u7406\u200b\u6a21\u5757\u200b VICAP(Video Capture) \u200b\u89c6\u9891\u200b\u6355\u83b7\u200b VIP(Video Input Processor) \u200b\u5728\u200bRockchip\u200b\u82af\u7247\u200b\u4e2d\u200b\uff0c\u200b\u66fe\u200b\u4f5c\u4e3a\u200bCIF\u200b\u7684\u200b\u522b\u540d\u200b VSYNC \u200b\u573a\u200b\u540c\u6b65\u200b\u4fe1\u53f7\u200b\uff0cVSYNC\u200b\u6709\u6548\u200b\u65f6\u200b\uff0c\u200b\u63a5\u6536\u200b\u5230\u200b\u7684\u200b\u4fe1\u53f7\u200b\u5c5e\u4e8e\u200b\u540c\u4e00\u200b\u5e27"},{"location":"13_V4L2/05_1/#2","title":"2. \u200b\u786c\u4ef6\u200b\u6846\u67b6","text":""},{"location":"13_V4L2/05_1/#21","title":"2.1 \u200b\u63a5\u53e3","text":"<p>\u200b\u672c\u6587\u200b\u53c2\u8003\u200b\uff1ahttps://zhuanlan.zhihu.com/p/599531271\uff0c\u200b\u4f5c\u8005\u200b\"\u200b\u4e00\u53e3\u200bLinux\"\u3002</p> <p>MIPI\u200b\u5305\u542b\u200b\u6709\u200b\u5f88\u591a\u200b\u534f\u8bae\u200b\uff0c\u200b\u6bd4\u5982\u200b\u663e\u793a\u200b\u8bbe\u5907\u200b\u63a5\u53e3\u200b\u3001\u200b\u6444\u50cf\u5934\u200b\u8bbe\u5907\u200b\u63a5\u53e3\u200b\u3001\u200b\u5b58\u50a8\u8bbe\u5907\u200b\u63a5\u53e3\u200b\u7b49\u7b49\u200b\u3002</p> <p>\u200b\u7ecf\u5e38\u200b\u7528\u5230\u200b\u7684\u200b\u6709\u200b\u663e\u793a\u200b\u8bbe\u5907\u200b\u63a5\u53e3\u200b\u3001\u200b\u6444\u50cf\u5934\u200b\u8bbe\u5907\u200b\u63a5\u53e3\u200b\u3002</p> <p>\u200b\u663e\u793a\u200b\u8bbe\u5907\u200b\u63a5\u53e3\u200b\u53c8\u200b\u53ef\u4ee5\u200b\u5206\u4e3a\u200b\uff1a\u200b\u5e76\u884c\u63a5\u53e3\u200b\u3001\u200b\u4e32\u884c\u63a5\u53e3\u200b\u3002\u200b\u5e76\u884c\u63a5\u53e3\u200b\u53c8\u200b\u53ef\u4ee5\u200b\u5206\u4e3a\u200bDBI\u3001DPI\u3002\u200b\u4e32\u884c\u63a5\u53e3\u200b\u7b80\u79f0\u200bDSI\u3002</p> <p>\u200b\u6444\u50cf\u5934\u200b\u8bbe\u5907\u200b\u63a5\u53e3\u200b\u5e38\u7528\u200b\u4e32\u884c\u63a5\u53e3\u200bCSI\uff0c\u200b\u5b83\u200b\u53ef\u200b\u5206\u4e3a\u200bCSI-2\u3001CSI-3\uff0c\u200b\u76ee\u524d\u200b\u5e38\u7528\u200b\u7684\u200b\u662f\u200bCSI-2\u3002\u200b\u5bf9\u4e8e\u200bCSI-2\uff0c\u200b\u5b83\u200b\u7684\u200b\u7269\u7406\u200b\u63a5\u53e3\u200b\u5206\u4e3a\u200bD-PHY\u3001C-PHY\uff0c\u200b\u76ee\u524d\u200b\u5e38\u7528\u200b\u7684\u200b\u662f\u200bD-PHY\u3002(DSI\u200b\u4f7f\u7528\u200b\u7684\u200b\u7269\u7406\u200b\u63a5\u53e3\u200b\u4e5f\u200b\u662f\u200bD-PHY)\u3002</p> <p></p> <p>D-PHY\u200b\u63a5\u53e3\u200b\u5f15\u811a\u200b\u793a\u4f8b\u200b\u5982\u4e0b\u200b\uff1a</p> <p></p>"},{"location":"13_V4L2/05_1/#22","title":"2.2 \u200b\u786c\u4ef6\u200b\u7ed3\u6784","text":"<p>D-PHY\u200b\u63a5\u53e3\u200b\u5178\u578b\u200b\u56fe\u200b\u4f8b\u5982\u200b\u4e0b\u200b\uff1a</p> <p></p> <p>\u200b\u5bf9\u4e8e\u200b\u6444\u50cf\u5934\u200b\uff0cD-PHY\u200b\u63a5\u53e3\u200b\u4ec5\u4ec5\u200b\u662f\u200b\u7528\u6765\u200b\u4f20\u9012\u6570\u636e\u200b\uff1a</p> <ul> <li>\u200b\u6444\u50cf\u5934\u200b\u53d1\u9001\u6570\u636e\u200b\uff0c\u200b\u5b83\u200b\u88ab\u200b\u79f0\u4e3a\u200b\uff1aCSI Transmitter</li> <li>\u200b\u4e3b\u63a7\u200b\u63a5\u6536\u6570\u636e\u200b\uff0c\u200b\u5b83\u200b\u88ab\u200b\u79f0\u4e3a\u200b\uff1aCSI Receiver</li> <li>\u200b\u4e3b\u63a7\u200b\u901a\u8fc7\u200bI2C\u200b\u63a5\u53e3\u200b\u53d1\u9001\u200b\u63a7\u5236\u200b\u547d\u4ee4\u200b\uff0c\u200b\u5b83\u200b\u88ab\u200b\u79f0\u4e3a\u200b\uff1aCCI Master\uff08CCI\u200b\u540d\u4e3a\u200bCamera Control Interface\uff09</li> <li>\u200b\u6444\u50cf\u5934\u200b\u63a5\u6536\u200b\u63a7\u5236\u200b\u547d\u4ee4\u200b\uff0c\u200b\u5b83\u200b\u88ab\u200b\u79f0\u4e3a\u200b\uff1aCCI Slave</li> </ul> <p></p> <p>\u200b\u6444\u50cf\u5934\u200b\u901a\u8fc7\u200bCSI\u200b\u63a5\u53e3\u200b\uff0c\u200b\u4ec5\u4ec5\u200b\u662f\u200b\u4f20\u9012\u6570\u636e\u200b\u7ed9\u200b\u4e3b\u63a7\u200b\uff0c\u200b\u4e3b\u63a7\u200b\u8fd8\u200b\u9700\u8981\u200b\u66f4\u200b\u591a\u200b\u5904\u7406\u200b\uff0c\u200b\u5982\u4e0b\u200b\u56fe\u200b\uff1a</p> <p></p> <p>\u200b\u6709\u200b\u54ea\u4e9b\u200b\u5904\u7406\u200b\uff1f</p> <p>\u200b\u6839\u636e\u200b\u5168\u5fd7\u200bV853\u200b\u82af\u7247\u200b\u8d44\u6599\u200b\uff0c\u200b\u53ef\u4ee5\u200b\u770b\u5230\u200b\u4e0b\u56fe\u200b\uff1a</p> <p></p> <p>\u200b\u5b83\u200b\u7684\u200b\u5904\u7406\u8fc7\u7a0b\u200b\u5206\u4e3a\u200b\uff1a</p> <ul> <li>\u200b\u8f93\u5165\u200bParser\uff1a\u200b\u683c\u5f0f\u200b\u89e3\u6790\u200b</li> <li>ISP\uff1aImage Signal Processor\uff0c\u200b\u5373\u200b\u56fe\u50cf\u200b\u4fe1\u53f7\u5904\u7406\u5668\u200b\uff0c\u200b\u7528\u4e8e\u200b\u5904\u7406\u200b\u56fe\u50cf\u200b\u4fe1\u53f7\u200b\u4f20\u611f\u5668\u200b\u8f93\u51fa\u200b\u7684\u200b\u56fe\u50cf\u200b\u4fe1\u53f7\u200b</li> <li>VIPP\uff1a Video Input Post Processor\uff08\u200b\u89c6\u9891\u200b\u8f93\u5165\u200b\u540e\u200b\u5904\u7406\u5668\u200b\uff09\uff0c\u200b\u80fd\u200b\u5bf9\u200b\u56fe\u7247\u200b\u8fdb\u884c\u200b\u7f29\u5c0f\u200b\u548c\u200b\u6253\u200b\u6c34\u5370\u200b\u5904\u7406\u200b\u3002VIPP\u200b\u652f\u6301\u200bbayer raw data\u200b\u7ecf\u8fc7\u200bISP\u200b\u5904\u7406\u200b\u540e\u200b\u518d\u200b\u7f29\u5c0f\u200b\uff0c\u200b\u4e5f\u200b\u652f\u6301\u200b\u5bf9\u200b\u4e00\u822c\u200b\u7684\u200bYUV\u200b\u683c\u5f0f\u200b\u7684\u200bsensor\u200b\u56fe\u50cf\u200b\u76f4\u63a5\u200b\u7f29\u5c0f\u200b\u3002</li> </ul> <p>\u200b\u6444\u50cf\u5934\u200b\u6570\u636e\u5904\u7406\u200b\u7684\u200b\u5b8c\u6574\u200b\u786c\u4ef6\u200b\u6846\u56fe\u200b\u5982\u4e0b\u200b\uff08\u200b\u4ee5\u200b\u5168\u5fd7\u4e3a\u200b\u4f8b\u200b\uff09\uff1ahttps://v853.docs.aw-ol.com/soft/soft_camera/</p> <p></p> <p></p> <p>\u200b\u53ef\u4ee5\u200b\u8ddf\u745e\u200b\u82af\u5fae\u200b\u7684\u200b\u5bf9\u6bd4\u200b\u4e00\u4e0b\u200b\uff1ahttps://zhuanlan.zhihu.com/p/599531271</p>"},{"location":"13_V4L2/06_1/","title":"V4L2\u200b\u89c6\u9891\u200b\u4ecb\u7ecd\u200b\u53ca\u200b\u8d44\u6599\u200b\u4e0b\u8f7d","text":""},{"location":"13_V4L2/06_1/#1","title":"1. \u200b\u8d44\u6599\u200b\u4e0b\u8f7d","text":"<p>GIT\u200b\u4ed3\u5e93\u200b\uff1a</p> <pre><code>https://e.coding.net/weidongshan/projects/doc_and_source_for_projects.git\n</code></pre> <p>\u200b\u6ce8\u610f\u200b\uff1a\u200b\u4e0a\u8ff0\u200b\u94fe\u63a5\u200b\u65e0\u6cd5\u200b\u7528\u200b\u6d4f\u89c8\u5668\u200b\u6253\u5f00\u200b\uff0c\u200b\u5fc5\u987b\u200b\u4f7f\u7528\u200bGIT\u200b\u547d\u4ee4\u200b\u6765\u200b\u514b\u9686\u200b\u3002</p> <p>GIT\u200b\u7b80\u660e\u200b\u6559\u7a0b\u200b\uff1ahttp://download.100ask.org/tools/Software/git/how_to_use_git.html</p> <p>\u200b\u4e0b\u8f7d\u200b\u5230\u200bGIT\u200b\u4ed3\u5e93\u200b\u540e\u200b\uff0cV4L2\u200b\u8d44\u6599\u200b\u5728\u200b\u91cc\u9762\u200b\uff1a</p> <p></p>"},{"location":"13_V4L2/06_1/#2","title":"2. \u200b\u6536\u5230\u200b\u7684\u200b\u5efa\u8bae","text":"<p>ov13850\u200b\u5728\u200b\u9a71\u52a8\u200b\u4e2d\u200b\u4e3a\u5565\u200b\u8981\u200b\u4e5f\u200b\u8981\u200b\u6ce8\u518c\u200bnotified\uff0c\u200b\u540c\u4e3b\u200b\u8bbe\u5907\u200b\u6ce8\u518c\u200b\u7684\u200bnotified\u200b\u6709\u200b\u5565\u200b\u533a\u522b\u200b\uff1f\u200b\u8fd9\u5757\u200b\u5e2e\u5fd9\u200b\u8bb2\u8bb2\u200b</p> <p></p> <p>subdev, media control, media framework, vb2 buffer\u200b\u7684\u200b\u5206\u914d\u200b\uff0c\u200b\u600e\u4e48\u200b\u8f6e\u8f6c\u200b\uff0c\u200b\u600e\u4e48\u200b\u8ddf\u200b\u786c\u4ef6\u200b\u6253\u4ea4\u9053\u200b\uff0c\u200b\u7136\u540e\u200b\u56fe\u50cf\u200b\u7ed9\u200b\u5e94\u7528\u5c42\u200b\u7528\u200b</p> <p>\u200b\u6709\u200b\u7684\u200b\u6444\u50cf\u5934\u200b\u6709\u200b\u63a7\u5236\u200b\u63a5\u53e3\u200biic,spi\uff0c\u200b\u8fd8\u6709\u200b\u6ca1\u6709\u200b\u63a7\u5236\u200b\u63a5\u53e3\u200b\u7684\u200b\uff0c\u200b\u6211\u4eec\u200b\u600e\u4e48\u200b\u5904\u7406\u200b\uff1f</p> <p>\u200b\u4e32\u884c\u200b\u548c\u89e3\u200b\u4e32\u200b\u5305\u62ec\u200bcphy\u200b\u548c\u200bdphy</p> <p></p> <p>\u200b\u73b0\u5728\u200bsensor\u200b\u4e00\u822c\u200b\u90fd\u200b\u662f\u200bmipi\u200b\u8f93\u51fa\u200b\uff08iic\u200b\u505a\u200b\u63a7\u5236\u200b\uff09\uff0c\u200b\u4e22\u200b\u5230\u200bISP\uff0cISP\u200b\u5904\u7406\u200b\u5b8c\u200b\u4e86\u200b\u5c31\u200b\u62ff\u5230\u200b\u4e00\u5e27\u200b\u6570\u636e\u200b\uff0c\u200b\u540e\u9762\u200b\u8fd8\u200b\u53ef\u80fd\u200b\u6709\u200b\u88c1\u526a\u200b\u548c\u200b\u7f16\u7801\u200b\u7b49\u200b\u3002@\u200b\u97e6\u200b\u4e1c\u5c71\u200b \u200b\u4f1a\u200b\u6709\u200bISP\u200b\u90e8\u5206\u200b\u8bb2\u89e3\u200b\u5417\u200b\uff1f\u200b\u6700\u7ec8\u200b\u89c6\u9891\u200b\u8f93\u51fa\u200b\u662f\u200b\u5c4f\u5e55\u200b\u8fd8\u662f\u200b\u901a\u8fc7\u200b\u7f51\u7edc\u200b\u505a\u200bIPC\u200b\u6216\u8005\u200bUSB\u200b\u505a\u200bUVC?</p> <p>MIPI\u200b\u8d44\u6599\u200b\u7f51\u4e0a\u200b\u4e5f\u200b\u633a\u200b\u591a\u200b\u7684\u200b\u554a\u200b\uff0c\u200b\u628a\u200b\u534f\u8bae\u200b\u5543\u200b\u4e00\u5543\u200b</p> <p>https://www.mipi.org/</p> <p></p> <p>\u200b\u73b0\u5728\u200b\u6c7d\u8f66\u200b\u4e0a\u9762\u200b\u90fd\u200b\u662f\u200bsensor\u200b\u901a\u8fc7\u200b\u4e32\u884c\u200b/\u200b\u89e3\u4e32\u5668\u200b\uff0c\u200b\u7136\u540e\u200b\u901a\u8fc7\u200bmipi\u200b\u63a5\u53e3\u200b\u8fde\u63a5\u200b\u5230\u200bsoc</p> <p>sensor---\u200b\u4e32\u884c\u200b\u5668\u200b---GSML----&gt;\u200b\u89e3\u4e32\u5668\u200b----&gt;soc\uff08mipi\u200b\u63a5\u53e3\u200b\uff09\u200b\u8fd9\u200b\u4e00\u6761\u200b\u8def\u200b\u4e5f\u200b\u6d89\u53ca\u200b\u4e00\u4e0b\u200b\uff0c\u200b\u81ea\u52a8\u200b\u9a7e\u9a76\u200b\u57fa\u672c\u200b\u90fd\u200b\u6d89\u53ca\u200b\u8fd9\u4e2a\u200b</p>"},{"location":"13_V4L2/06_1/#3","title":"3. \u200b\u5b66\u4e60\u200b\u7b14\u8bb0","text":"<p>\u200b\u597d\u6587\u200b\uff1ahttps://zhuanlan.zhihu.com/p/613018868</p> <p>Linux V4L2\u200b\u5b50\u200b\u7cfb\u7edf\u5206\u6790\u200b\uff08\u200b\u4e00\u200b\uff09: https://blog.csdn.net/u011037593/article/details/115415136</p> <p>Linux V3H \u200b\u5e73\u53f0\u200b\u5f00\u53d1\u200b\u7cfb\u5217\u200b\u8bb2\u89e3\u200b\uff08\u200b\u6444\u50cf\u5934\u200b\uff092.1 MAX9296 GMSL\u200b\u94fe\u8def\u200b\u914d\u7f6e\u200b: https://blog.csdn.net/xian18809311584/article/details/131182605</p> <p>https://github.com/GStreamer/gstreamer</p> <p>\u200b\u9ea6\u515c\u200bchenchengwudi@sina.com 14:55:33 \u200b\u6211\u200b\u4e5f\u200b\u6b63\u5728\u200b\u770b\u200bV4L2\uff0c\u200b\u4e5f\u200b\u53c2\u8003\u200b\u4e86\u200b\u4e0a\u9762\u200b\u63d0\u5230\u200b\u7684\u200bLinux\u200b\u8bbe\u5907\u200b\u9a71\u52a8\u200b\u5f00\u53d1\u200b\uff0c\u200b\u8fd8\u6709\u200b\u5185\u6838\u200b\u6587\u6863\u200b\uff0c\u200b\u57fa\u4e8e\u200b5.4\u200b\u5185\u6838\u200b\u7684\u200b\uff0c\u200b\u5927\u5bb6\u200b\u53ef\u4ee5\u200b\u53c2\u8003\u200b\u4e0b\u200b</p> <p>\u200b\u9ea6\u515c\u200bchenchengwudi@sina.com 14:55:42 https://lvxfuhal9l.feishu.cn/docx/Cyssdr8BVonDnnx3YjUc4O9xngg</p> <p>\u200b\u9ea6\u515c\u200bchenchengwudi@sina.com 14:55:49 https://lvxfuhal9l.feishu.cn/docx/MYYndrVvPolMA4xhBCNczE4WnWf</p> <p>\u200b\u9ea6\u515c\u200bchenchengwudi@sina.com 14:56:32 \u200b\u51c6\u5907\u200b\u5199\u200b\u4e00\u7ec4\u200b\u7b14\u8bb0\u200b\uff0c\u200b\u76ee\u524d\u200b\u5b8c\u6210\u200b\u4e86\u200b1.5\u200b\u7bc7\u200b</p> <p>\u200b\u989c\u8272\u200b\u7a7a\u95f4\u200b\u603b\u7ed3\u200b https://blog.51cto.com/u_15471597/4927811</p> <p>https://zhuanlan.zhihu.com/p/159148034</p> <p>sRGB\u200b\u548c\u200bRGB\u200b\u7684\u200b\u8f6c\u6362\u200b</p> <p>https://www.zhangxinxu.com/wordpress/2017/12/linear-rgb-srgb-js-convert/</p> <p>YUV(\u200b\u6709\u200b\u7a0b\u5e8f\u200b)</p> <p>https://www.cnblogs.com/a4234613/p/15497724.html</p> <p>\u200b\u6d45\u8c08\u200bYUV444\u3001YUV422\u3001YUV420</p> <p>http://www.pjtime.com/2021/4/192828404475.shtml</p> <p>YUV\u200b\u4e0e\u200bRGB \u200b\u4ee5\u53ca\u200b\u4e4b\u95f4\u200b\u7684\u200b\u8f6c\u6362\u200b</p> <p>https://blog.csdn.net/WANGYONGZIXUE/article/details/127971015</p> <p>YUV 4:4:4  \u200b\u6bcf\u200b\u4e00\u4e2a\u200bY\u200b\u5bf9\u5e94\u200b\u4e00\u7ec4\u200bUV</p> <p>\u200b    YUV 4:2:2 \u200b\u6bcf\u200b\u4e24\u4e2a\u200bY\u200b\u5171\u7528\u200b\u4e00\u7ec4\u200bUV</p> <p>\u200b    YUV 4:2:0 \u200b\u6bcf\u200b\u56db\u4e2a\u200bY\u200b\u5171\u7528\u200b\u4e00\u7ec4\u200bUV</p> <p>480i\u3001576i\u200b\u662f\u200b\u4ec0\u4e48\u200b\u610f\u601d\u200b\uff1f</p> <p>SDTV\u3001EDTV\u3001HDTV\uff1a</p> <ul> <li>SDTV\uff1a</li> <li>\u200b\u91c7\u6837\u200b\u9891\u7387\u200b13.5MHz\uff0c</li> <li>\u200b\u6bcf\u884c\u200b\u626b\u63cf\u7ebf\u200b\u5305\u542b\u200b858\u200b\u4e2a\u200b\u91c7\u6837\u200b\u70b9\u200b\uff08480i\u200b\u7cfb\u7edf\u200b\uff09\u200b\u6216\u200b864\u200b\u4e2a\u200b\u91c7\u6837\u200b\u70b9\u200b\uff08576i\u200b\u7cfb\u7edf\u200b\uff09</li> <li>\u200b\u6709\u6548\u200b\u7ebf\u200b\u5468\u671f\u200b\u5185\u200b\uff0c\u200b\u90fd\u200b\u662f\u200b720\u200b\u4e2a\u200b\u91c7\u6837\u200b\u70b9\u200b</li> <li>\u200b\u540e\u6765\u200b\u652f\u6301\u200b16:9\u200b\u5bbd\u9ad8\u6bd4\u200b\uff0c\u200b\u91c7\u6837\u7387\u200b\u4e3a\u200b18MHz\uff08\u200b\u6709\u6548\u200b\u5206\u8fa8\u7387\u200b\u4e3a\u200b960x480i\u200b\u548c\u200b960x576i\uff09\uff0c\u200b\u6709\u6548\u200b\u7ebf\u5185\u200b960\u200b\u4e2a\u200b\u91c7\u6837\u200b\u70b9\u200b</li> <li>EDTV</li> <li>480p\u3001576p</li> <li>\u200b\u91c7\u6837\u200b\u9891\u7387\u200b\uff1a4:3\u200b\u5bbd\u9ad8\u6bd4\u200b27MHz\uff0c16:9\u200b\u5bbd\u9ad8\u6bd4\u200b36MHz</li> <li>HDTV</li> <li>720p\u30011080i\u30011080p</li> <li>\u200b\u6bcf\u7ebf\u200b\u7684\u200b\u6709\u6548\u200b\u91c7\u6837\u200b\u70b9\u200b\u6570\u91cf\u200b\u3001\u200b\u6bcf\u5e27\u200b\u7684\u200b\u6709\u6548\u200b\u7ebf\u200b\u6570\u76ee\u200b\uff1a\u200b\u90fd\u200b\u662f\u200b\u6052\u5b9a\u200b\u7684\u200b\uff0c\u200b\u65e0\u8bba\u200b\u5e27\u200b\u7387\u200b\u5982\u4f55\u200b</li> <li> <p>\u200b\u6bcf\u79cd\u200b\u5e27\u200b\u7387\u200b\u90fd\u200b\u4f7f\u7528\u200b\u4e0d\u540c\u200b\u7684\u200b\u91c7\u6837\u200b\u65f6\u949f\u200b\u9891\u7387\u200b</p> </li> <li> <p>480i\u200b\u548c\u200b480p\u200b\u7cfb\u7edf\u200b</p> </li> <li>480i\u200b\u5c5e\u4e8e\u200bSDTV</li> <li>480p\u200b\u5c5e\u4e8e\u200bEDTV</li> <li>\u200b\u9694\u884c\u200b\u6a21\u62df\u200b\u5206\u91cf\u200b\u89c6\u9891\u200b<ul> <li>\u200b\u6bcf\u5e27\u200b525\u200b\u7ebf\u200b\uff0c\u200b\u6709\u6548\u200b\u626b\u63cf\u7ebf\u200b\u4e3a\u200b480\uff0c\u200b\u5728\u200b23<sub>262\u200b\u548c\u200b286</sub>525\u200b\u7ebf\u4e0a\u200b\u663e\u793a\u200b\u6709\u6548\u200b\u89c6\u9891\u200b</li> <li>\u200b\u5e27\u200b\u7387\u200b\uff1a29.97Hz\uff0830/1.001\uff09</li> </ul> </li> <li>\u200b\u9694\u884c\u200b\u6570\u5b57\u200b\u5206\u91cf\u200b\u89c6\u9891\u200b<ul> <li></li> </ul> </li> <li>\u200b\u9010\u884c\u200b\u6a21\u62df\u200b\u5206\u91cf\u200b\u89c6\u9891\u200b<ul> <li>\u200b\u5e27\u200b\u7387\u200b\uff1a59.94Hz\uff0860/1.001\uff09</li> <li>\u200b\u6bcf\u5e27\u200b525\u200b\u7ebf\u200b\uff0c\u200b\u6709\u6548\u200b\u626b\u63cf\u7ebf\u200b\u4e3a\u200b480\uff0c\u200b\u5728\u200b45~524\u200b\u7ebf\u4e0a\u200b\u663e\u793a\u200b\u6709\u6548\u200b\u89c6\u9891\u200b</li> </ul> </li> <li>576i\u200b\u548c\u200b576p\u200b\u7cfb\u7edf\u200b</li> <li>\u200b\u9694\u884c\u200b\u6a21\u62df\u200b\u590d\u5408\u200b\u89c6\u9891\u200b\uff1a\u200b\u5355\u4e00\u200b\u4fe1\u53f7\u7ebf\u200b\uff0c\u200b\u6bcf\u5e27\u200b625\u200b\u7ebf\u200b</li> <li>\u200b\u9694\u884c\u200b\u6a21\u62df\u200b\u5206\u91cf\u200b\u89c6\u9891\u200b\uff1a\u200b\u4e09\u79cd\u200b\u4fe1\u53f7\u7ebf\u200b\uff0c\u200b\u5e27\u200b\u7387\u200b25Hz\uff0c\u200b\u6bcf\u5e27\u200b625\u200b\u7ebf\u200b\uff0c\u200b\u5728\u200b23<sub>310\u200b\u548c\u200b336</sub>623\u200b\u7ebf\u4e0a\u200b\u663e\u793a\u200b\u6709\u6548\u200b\u89c6\u9891\u200b</li> <li>\u200b\u9010\u884c\u200b\u6a21\u62df\u200b\u5206\u91cf\u200b\u89c6\u9891\u200b\uff1a\u200b\u4e09\u79cd\u200b\u4fe1\u53f7\u200b\uff0c\u200b\u5e27\u200b\u7387\u200b50Hz\uff0c\u200b\u6bcf\u5e27\u200b625\u200b\u7ebf\u200b\uff0c\u200b\u5728\u200b45`620\u200b\u7ebf\u4e0a\u200b\u663e\u793a\u200b\u6709\u6548\u200b\u89c6\u9891\u200b</li> <li>\u200b\u9694\u884c\u200b\u6570\u5b57\u200b\u5206\u91cf\u200b\u89c6\u9891\u200b</li> <li>\u200b\u9010\u884c\u200b\u6570\u5b57\u200b\u5206\u91cf\u200b\u89c6\u9891\u200b</li> </ul> <p>SDTV\u3001EDTV\u3001HDTV\u200b\u662f\u200b\u6570\u5b57\u7535\u89c6\u200b\u7684\u200b\u4e09\u79cd\u200b\u6807\u51c6\u200b\uff0c\u200b\u5206\u522b\u200b\u662f\u200b\u6807\u6e05\u200b\u7535\u89c6\u200b\u3001\u200b\u589e\u5f3a\u578b\u200b\u6807\u6e05\u200b\u7535\u89c6\u200b\u548c\u200b\u9ad8\u6e05\u200b\u7535\u89c6\u200b\u3002\u200b\u5b83\u4eec\u200b\u7684\u200b\u533a\u522b\u200b\u5728\u4e8e\u200b\u5206\u8fa8\u7387\u200b\u3001\u200b\u753b\u8d28\u200b\u548c\u200b\u58f0\u97f3\u200b\u7684\u200b\u8d28\u91cf\u200b\u3002</p> <ol> <li>SDTV\uff08Standard Definition Television\uff09\uff1a\u200b\u6807\u6e05\u200b\u7535\u89c6\u200b\uff0c\u200b\u5206\u8fa8\u7387\u200b\u4e3a\u200b720\u00d7576\u200b\u6216\u200b720\u00d7480\uff0c\u200b\u91c7\u7528\u200b4:3\u200b\u7684\u200b\u5c4f\u5e55\u200b\u6bd4\u4f8b\u200b\uff0c\u200b\u901a\u5e38\u200b\u662f\u200b\u666e\u901a\u200b\u7684\u200b\u7535\u89c6\u673a\u200b\u6216\u200bDVD\u200b\u64ad\u653e\u673a\u200b\u6240\u200b\u4f7f\u7528\u200b\u7684\u200b\u57fa\u672c\u200b\u5206\u8fa8\u7387\u200b\u3002\u200b\u5728\u200b\u64ad\u653e\u200b\u9ad8\u6e05\u200b\u8282\u76ee\u200b\u65f6\u200b\uff0c\u200b\u4f1a\u6709\u200b\u9ed1\u8fb9\u200b\u6216\u200b\u753b\u9762\u200b\u62c9\u4f38\u200b\u7b49\u200b\u663e\u793a\u200b\u4e0d\u200b\u5b8c\u6574\u200b\u7684\u200b\u60c5\u51b5\u200b\u3002</li> <li>EDTV\uff08Enhanced Definition Television\uff09\uff1a\u200b\u589e\u5f3a\u578b\u200b\u6807\u6e05\u200b\u7535\u89c6\u200b\uff0c\u200b\u5206\u8fa8\u7387\u200b\u4e3a\u200b1280\u00d7720\u200b\u6216\u200b960\u00d7540\uff0c\u200b\u91c7\u7528\u200b16:9\u200b\u7684\u200b\u5c4f\u5e55\u200b\u6bd4\u4f8b\u200b\u3002\u200b\u6bd4\u6807\u200b\u6e05\u200b\u7535\u89c6\u200b\u5206\u8fa8\u7387\u200b\u66f4\u9ad8\u200b\uff0c\u200b\u4f46\u200b\u4ecd\u200b\u4e0d\u200b\u8fbe\u5230\u200b\u9ad8\u6e05\u200b\u7684\u200b\u6807\u51c6\u200b\uff0c\u200b\u9002\u7528\u200b\u4e8e\u200b\u64ad\u653e\u200b\u5206\u8fa8\u7387\u200b\u8f83\u200b\u9ad8\u200b\u7684\u200b\u7535\u5f71\u200b\u6216\u200b\u6e38\u620f\u200b\u3002\u200b\u5728\u200b\u64ad\u653e\u200b\u9ad8\u6e05\u200b\u8282\u76ee\u200b\u65f6\u200b\uff0c\u200b\u4f1a\u6709\u200b\u9ed1\u8fb9\u200b\u6216\u200b\u753b\u9762\u200b\u62c9\u4f38\u200b\u7b49\u200b\u663e\u793a\u200b\u4e0d\u200b\u5b8c\u6574\u200b\u7684\u200b\u60c5\u51b5\u200b\u3002</li> <li>HDTV\uff08High Definition Television\uff09\uff1a\u200b\u9ad8\u6e05\u200b\u7535\u89c6\u200b\uff0c\u200b\u5206\u8fa8\u7387\u200b\u4e3a\u200b1920\u00d71080\u200b\u6216\u200b1280\u00d7720\uff0c\u200b\u91c7\u7528\u200b16:9\u200b\u7684\u200b\u5c4f\u5e55\u200b\u6bd4\u4f8b\u200b\uff0c\u200b\u753b\u9762\u8d28\u91cf\u200b\u9ad8\u200b\uff0c\u200b\u58f0\u97f3\u200b\u4e5f\u200b\u66f4\u4e3a\u200b\u6e05\u6670\u200b\u3002\u200b\u662f\u200b\u5f53\u524d\u200b\u6570\u5b57\u7535\u89c6\u200b\u7684\u200b\u6700\u9ad8\u200b\u6807\u51c6\u200b\uff0c\u200b\u9002\u7528\u200b\u4e8e\u200b\u64ad\u653e\u200b\u9ad8\u6e05\u200b\u7535\u5f71\u200b\u3001\u200b\u6e38\u620f\u200b\u3001\u200b\u4f53\u80b2\u8d5b\u4e8b\u200b\u548c\u200b\u5176\u4ed6\u200b\u8282\u76ee\u200b\u3002\u200b\u5728\u200b\u64ad\u653e\u200b\u6807\u6e05\u200b\u8282\u76ee\u200b\u65f6\u200b\uff0c\u200b\u7535\u89c6\u200b\u4f1a\u200b\u5bf9\u200b\u5176\u200b\u8fdb\u884c\u200b\u5347\u9891\u200b\uff0c\u200b\u4f1a\u7528\u200b\u6bd4\u6807\u200b\u6e05\u200b\u5206\u8fa8\u7387\u200b\u66f4\u200b\u9ad8\u200b\u7684\u200b\u5206\u8fa8\u7387\u200b\u53bb\u200b\u663e\u793a\u200b\uff0c\u200b\u4ece\u800c\u200b\u63d0\u9ad8\u200b\u753b\u8d28\u200b\u4f53\u9a8c\u200b\u3002</li> </ol> <p>YUV420P(YU12\u200b\u548c\u200bYV12)\u200b\u683c\u5f0f\u200b https://blog.csdn.net/lz0499/article/details/101029783</p> <p>\u200b\u8272\u5f69\u200b\u6821\u6b63\u200b\u4e2d\u200b\u7684\u200b gamma \u200b\u503c\u200b\u662f\u200b\u4ec0\u4e48\u200b</p> <p>https://www.jianshu.com/p/52fc2192ae7b</p> <p>https://www.zhihu.com/question/27467127</p> <p>https://blog.csdn.net/weixin_42203498/article/details/126753239</p> <p>https://blog.csdn.net/m0_61737429/article/details/129782000</p> <p>https://blog.csdn.net/seiyaaa/article/details/120199720</p> <p>Linux\u200b\u591a\u5a92\u4f53\u200b\u5b50\u7cfb\u7edf\u200b01\uff1a\u200b\u4ece\u200b\u7528\u6237\u200b\u7a7a\u95f4\u200b\u4f7f\u7528\u200bV4L2\u200b\u5b50\u7cfb\u7edf\u200b https://blog.csdn.net/chenchengwudi/article/details/129176862</p> <p>Video Demystified\uff1a</p> <p>https://www.zhihu.com/column/videodemystified</p> <p>\u200b\u6444\u50cf\u5934\u200b\uff1a</p> <p>https://mp.weixin.qq.com/s?__biz=MzUxMjEyNDgyNw==&amp;mid=2247510675&amp;idx=1&amp;sn=66fcc83a95974add9d25a6e9b925c43b&amp;chksm=f96bd867ce1c5171976838ddf995fc6f68e7e839c797bfa6f690c94b577d359939ad1a816cd1&amp;cur_album_id=2583789151490113538&amp;scene=189#wechat_redirect</p> <p>UI \u200b\u8bbe\u8ba1\u200b\u77e5\u8bc6\u5e93\u200b [01] \u200b\u8272\u5f69\u200b \u00b7 \u200b\u7406\u8bba\u200b https://www.jianshu.com/p/34e9660f00f4</p> <p>UI \u200b\u8bbe\u8ba1\u200b\u77e5\u8bc6\u5e93\u200b [02] \u200b\u8272\u5f69\u200b \u00b7 \u200b\u7406\u8bba\u200b \u2013 \u200b\u5e38\u89c1\u95ee\u9898\u200b https://www.jianshu.com/p/7f652ae75142</p> <p>UI \u200b\u8bbe\u8ba1\u200b\u77e5\u8bc6\u5e93\u200b [03] \u200b\u8272\u5f69\u200b \u00b7 \u200b\u914d\u8272\u200b https://www.jianshu.com/p/b56acefc66ed</p> <p>sRGB https://en.wikipedia.org/wiki/SRGB https://zh.wikipedia.org/wiki/SRGB%E8%89%B2%E5%BD%A9%E7%A9%BA%E9%97%B4</p> <p>\u200b\u8272\u5f69\u200b\u7a7a\u95f4\u200b\u662f\u200b\u4ec0\u4e48\u200b\uff1f https://www.pantonecn.com/articles/technical/what-are-your-color-spaces</p> <p>Gamma\u3001Linear\u3001sRGB \u200b\u548c\u200bUnity Color Space\uff0c\u200b\u4f60\u200b\u771f\u200b\u61c2\u200b\u4e86\u200b\u5417\u200b\uff1f https://zhuanlan.zhihu.com/p/66558476</p> <p>https://baike.baidu.com/tashuo/browse/content?id=9167c87c2cd4f1c2f4d1c173&amp;lemmaId=2147136&amp;fromLemmaModule=pcRight</p> <p>A Standard Default Color Space for the Internet - sRGB https://www.w3.org/Graphics/Color/sRGB</p> <p>\u200b\u672f\u8bed\u200b\uff1a</p> <p>colorspace\uff1a SMPTE-170M\u3001 REC-709 (CEA-861 timings) \u3001 sRGB (VESA DMT timings)</p> <p>NTSC TV \u3001PAL</p> <p>HDMI EDID</p> <p>progressive\u3001interlaced\u3001</p> <p>HDMI\u3001webcam TV\u3001S-Video</p> <p>S-Video and TV inputs</p> <p>Y'CbCr\u3001RGB\u3001</p> <p>YUYV 4:4:4, 4:2:2 and 4:2:0</p> <p>V4L2 capture overlay</p>"},{"location":"13_V4L2/06_1/#4-videobuffer2","title":"4. videobuffer2","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>https://www.linuxtv.org/downloads/v4l-dvb-apis-new/</li> <li>https://www.linuxtv.org/downloads/v4l-dvb-apis-old/vidioc-create-bufs.html</li> <li>3\u200b\u79cd\u200bbuffer\uff1ahttps://www.linuxtv.org/downloads/v4l-dvb-apis-old/index.html</li> <li>https://www.linuxtv.org/downloads/v4l-dvb-apis-old/buffer.html#v4l2-memory</li> <li>https://www.linuxtv.org/downloads/v4l-dvb-apis-old/mmap.html</li> <li>https://www.linuxtv.org/downloads/v4l-dvb-apis-old/userp.html</li> <li>https://www.linuxtv.org/downloads/v4l-dvb-apis-old/dmabuf.html</li> <li>https://www.linuxtv.org/downloads/v4l-dvb-apis-old/vidioc-expbuf.html</li> <li>\u200b\u57fa\u4e8e\u200bStreaming I/O\u200b\u7684\u200bV4L2\u200b\u8bbe\u5907\u200b\u4f7f\u7528\u200b\uff1a https://blog.csdn.net/coroutines/article/details/70141086</li> <li>https://www.linuxtv.org/downloads/v4l-dvb-apis-old/mmap.html</li> <li>V4l2\u200b\u5e94\u7528\u200b\u6846\u67b6\u200b-Videobuf2\u200b\u6570\u636e\u7ed3\u6784\u200b https://blog.csdn.net/weixin_42581177/article/details/126582465</li> <li>user ptr\uff1ahttps://github.com/h4tr3d/v4l2-capture-complex/blob/master/main.cpp</li> </ul> <pre><code>static const struct vb2_ops airspy_vb2_ops = {\n    .queue_setup            = airspy_queue_setup,\n    .buf_queue              = airspy_buf_queue,\n    .start_streaming        = airspy_start_streaming,\n    .stop_streaming         = airspy_stop_streaming,\n    .wait_prepare           = vb2_ops_wait_prepare,\n    .wait_finish            = vb2_ops_wait_finish,\n};\n\nconst struct vb2_mem_ops vb2_vmalloc_memops = {\n    .alloc      = vb2_vmalloc_alloc,\n    .put        = vb2_vmalloc_put,\n    .get_userptr    = vb2_vmalloc_get_userptr,\n    .put_userptr    = vb2_vmalloc_put_userptr,\n#ifdef CONFIG_HAS_DMA\n    .get_dmabuf = vb2_vmalloc_get_dmabuf,\n#endif\n    .map_dmabuf = vb2_vmalloc_map_dmabuf,\n    .unmap_dmabuf   = vb2_vmalloc_unmap_dmabuf,\n    .attach_dmabuf  = vb2_vmalloc_attach_dmabuf,\n    .detach_dmabuf  = vb2_vmalloc_detach_dmabuf,\n    .vaddr      = vb2_vmalloc_vaddr,\n    .mmap       = vb2_vmalloc_mmap,\n    .num_users  = vb2_vmalloc_num_users,\n};\n\n\ns-&gt;vb_queue.ops = &amp;airspy_vb2_ops;          // call_qop,call_vb_qop\ns-&gt;vb_queue.mem_ops = &amp;vb2_vmalloc_memops;  // call_ptr_memop\n\nint vb2_queue_init(struct vb2_queue *q)\n        q-&gt;buf_ops = &amp;v4l2_buf_ops;\n</code></pre>"},{"location":"13_V4L2/06_1/#41-app-request-buf","title":"4.1 APP request buf","text":"<pre><code>ioctl(fd, VIDIOC_REQBUFS, &amp;rb);\n--------------------------------\n    v4l_reqbufs(const struct v4l2_ioctl_ops *ops,\n        ops-&gt;vidioc_reqbufs(file, fh, p);\n            vb2_ioctl_reqbufs\n                res = vb2_core_reqbufs(vdev-&gt;queue, p-&gt;memory, &amp;p-&gt;count);\n                        num_buffers = min_t(unsigned int, *count, VB2_MAX_FRAME);\n                        num_buffers = max_t(unsigned int, num_buffers, q-&gt;min_buffers_needed);\n\n                        // \u200b\u7ed9\u200b\u4f60\u200b\u673a\u4f1a\u200b\u4fee\u6539\u200bnum_buffers,num_planes\n                        ret = call_qop(q, queue_setup, q, &amp;num_buffers, &amp;num_planes,                                              plane_sizes, q-&gt;alloc_devs); // airspy_queue_setup\n\n                        /* Finally, allocate buffers and video memory */\n                        allocated_buffers =\n                            __vb2_queue_alloc(q, memory, num_buffers, num_planes, plane_sizes);\n                                ret = __vb2_buf_mem_alloc(vb);\n                                            call_ptr_memop(vb, alloc,\n                                                 vb2_queue-&gt;mem_ops-&gt;alloc\n                                                        vb2_vmalloc_alloc\n                                                           buf-&gt;vaddr = vmalloc_user(buf-&gt;size);\n                                ret = call_vb_qop(vb, buf_init, vb);\n</code></pre>"},{"location":"13_V4L2/06_1/#42-queue-buffer","title":"4.2 queue buffer","text":"<p>queue buffer\u200b\u5173\u952e\u70b9\u200b\uff1a</p> <ul> <li>VB2\u200b\u7684\u200b\u94fe\u8868\u200b\uff1alist_add_tail(&amp;vb-&gt;queued_entry, &amp;q-&gt;queued_list);</li> <li>\u200b\u9a71\u52a8\u200b\u81ea\u5df1\u200b\u7ef4\u62a4\u200b\u7684\u200b\u94fe\u8868\u200b\uff1alist_add_tail(&amp;buf-&gt;list, &amp;s-&gt;queued_bufs);</li> </ul> <p>\u200b\u9a71\u52a8\u200b\u7684\u200bURB\u200b\u4f20\u8f93\u200b\u5b8c\u6210\u200b\u540e\u200b\uff1a</p> <ul> <li>\u200b\u4ece\u200b\u94fe\u8868\u200bqueued_bufs\u200b\u53d6\u51fa\u200bbuffer</li> <li>\u200b\u628a\u200bURB\u200b\u5f97\u5230\u200b\u7684\u200b\u6570\u636e\u200b\u586b\u5165\u200bbuffer</li> <li>\u200b\u8c03\u7528\u200bvb2_buffer_done\uff1alist_add_tail(&amp;vb-&gt;done_entry, &amp;q-&gt;done_list);</li> </ul> <p>dequeue buffer\u200b\u5173\u952e\u70b9\u200b\uff1a</p> <ul> <li>\u200b\u4ece\u200b\u94fe\u8868\u200bdone_entry\u200b\u53d6\u51fa\u200b\u5e76\u200b\u79fb\u9664\u200b\u7b2c\u200b1\u200b\u4e2a\u200bvb</li> <li>\u200b\u628a\u200b\u5b83\u200b\u4e5f\u200b\u4ece\u200bqueued_list\u200b\u4e2d\u200b\u79fb\u9664\u200b</li> </ul> <pre><code>ioctl(fd, VIDIOC_QBUF, &amp;buf)\n-------------------------------\n    v4l_qbuf\n        ops-&gt;vidioc_qbuf(file, fh, p);\n            vb2_ioctl_qbuf\n                vb2_qbuf(vdev-&gt;queue, p);\n                    vb2_queue_or_prepare_buf(q, b, \"qbuf\");\n                    vb2_core_qbuf(q, b-&gt;index, b);\n                        list_add_tail(&amp;vb-&gt;queued_entry, &amp;q-&gt;queued_list);\n                        vb-&gt;state = VB2_BUF_STATE_QUEUED;\n\n                            /*\n                             * If already streaming, give the buffer to driver for processing.\n                             * If not, the buffer will be given to driver on next streamon.\n                             */\n                            if (q-&gt;start_streaming_called)\n                                __enqueue_in_driver(vb);\n                                        /* sync buffers */\n                                        for (plane = 0; plane &lt; vb-&gt;num_planes; ++plane)\n                                            call_void_memop(vb, prepare, vb-&gt;planes[plane].mem_priv);\n\n                                        call_void_vb_qop(vb, buf_queue, vb);\n                                            airspy_buf_queue\n                                                list_add_tail(&amp;buf-&gt;list, &amp;s-&gt;queued_bufs);\n\n                        if (pb)\n                            call_void_bufop(q, fill_user_buffer, vb, pb);\n</code></pre>"},{"location":"13_V4L2/06_1/#43-dequeue-buf","title":"4.3 dequeue buf","text":"<pre><code>ioctl(fd, VIDIOC_DQBUF, &amp;buf)\n----------------------------------\n    v4l_dqbuf\n        ops-&gt;vidioc_dqbuf(file, fh, p);\n            vb2_ioctl_dqbuf\n                vb2_dqbuf(vdev-&gt;queue, p, file-&gt;f_flags &amp; O_NONBLOCK);\n                    ret = vb2_core_dqbuf(q, NULL, b, nonblocking);\n                            ret = __vb2_get_done_vb(q, &amp;vb, pb, nonblocking);\n                                    *vb = list_first_entry(&amp;q-&gt;done_list, struct vb2_buffer, done_entry);\n                                    list_del(&amp;(*vb)-&gt;done_entry);\n                            call_void_vb_qop(vb, buf_finish, vb);\n                            call_void_bufop(q, fill_user_buffer, vb, pb);\n                            __vb2_dqbuf(vb);\n</code></pre>"},{"location":"13_V4L2/06_1/#43-stream-on","title":"4.3 stream on","text":"<pre><code>ioctl(fd, VIDIOC_STREAMON, &amp;type)\n------------------------------------\n    v4l_streamon\n        ops-&gt;vidioc_streamon(file, fh, *(unsigned int *)arg)\n            vb2_ioctl_streamon\n                vb2_streamon(vdev-&gt;queue, i);\n                    vb2_core_streamon(q, type);\n                        ret = vb2_start_streaming(q);\n                                    /*\n                                     * If any buffers were queued before streamon,\n                                     * we can now pass them to driver for processing.\n                                     */\n                                    list_for_each_entry(vb, &amp;q-&gt;queued_list, queued_entry)\n                                        __enqueue_in_driver(vb);\n                                                /* sync buffers */\n                                                for (plane = 0; plane &lt; vb-&gt;num_planes; ++plane)\n                                                    call_void_memop(vb, prepare, vb-&gt;planes[plane].mem_priv);\n\n                                                call_void_vb_qop(vb, buf_queue, vb);\n                                                    airspy_buf_queue            \n\n                                    /* Tell the driver to start streaming */\n                                    q-&gt;start_streaming_called = 1;\n                                    ret = call_qop(q, start_streaming, q, atomic_read(&amp;q-&gt;owned_by_drv_count));\n                                                airspy_start_streaming // \u200b\u5206\u914d\u200b\u63d0\u4ea4\u200bURB\n</code></pre>"},{"location":"13_V4L2/06_1/#43-stream-off","title":"4.3 stream off","text":"<pre><code>ioctl(fd, VIDIOC_STREAMOFF, &amp;type)\n-----------------------------------\n    v4l_streamoff\n        ops-&gt;vidioc_streamoff(file, fh, *(unsigned int *)arg);\n            vb2_ioctl_streamoff\n                vb2_streamoff(vdev-&gt;queue, i);  \n                    vb2_core_streamoff(q, type);\n                        __vb2_queue_cancel(q);\n                            call_void_qop(q, stop_streaming, q);\n                                airspy_stop_streaming // kill URB\n\n                            call_void_vb_qop(vb, buf_finish, vb);\n</code></pre>"},{"location":"13_V4L2/06_1/#44","title":"4.4 \u200b\u963b\u585e\u200b\u4e0e\u200b\u5524\u9192","text":""},{"location":"13_V4L2/06_1/#441","title":"4.4.1 \u200b\u963b\u585e","text":"<pre><code>memset(fds, 0, sizeof(fds));\nfds[0].fd = fd;\nfds[0].events = POLLIN;\nif (1 == poll(fds, 1, -1))\n--------------------------------------\nv4l2_poll\n    res = vdev-&gt;fops-&gt;poll(filp, poll);\n            vb2_fop_poll\n                res = vb2_poll(vdev-&gt;queue, file, wait);\n                            vb2_core_poll(q, file, wait);\n                                poll_wait(file, &amp;q-&gt;done_wq, wait);\n</code></pre>"},{"location":"13_V4L2/06_1/#442","title":"4.4.2 \u200b\u5524\u9192","text":"<pre><code>airspy_urb_complete\n    vb2_buffer_done(&amp;fbuf-&gt;vb.vb2_buf, VB2_BUF_STATE_DONE);\n</code></pre>"},{"location":"13_V4L2/06_1/#46-buf","title":"4.6 \u200b\u8bfb\u5199\u200bbuf","text":""},{"location":"13_V4L2/06_1/#47-vidioc_prepare_buf","title":"4.7 vidioc_prepare_buf","text":"<pre><code>v4l2_ioctl_ops.vidioc_prepare_buf\n    vb2_ioctl_prepare_buf\n        vb2_prepare_buf(vdev-&gt;queue, p);\n            vb2_core_prepare_buf(q, b-&gt;index, b)\n                call_void_bufop(q, fill_user_buffer, vb, pb);\n                    __fill_v4l2_buffer\n                    /**\n                     * __fill_v4l2_buffer() - fill in a struct v4l2_buffer with information to be\n                     * returned to userspace\n                     */\n</code></pre>"},{"location":"13_V4L2/07_1/","title":"V4L2\u200b\u5e94\u7528\u200b\u7a0b\u5e8f\u5f00\u53d1","text":"<p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <ul> <li>mjpg-streamer\uff1ahttps://github.com/jacksonliam/mjpg-streamer</li> <li>video2lcd\uff1a\u200b\u8fd9\u662f\u200b\u767e\u95ee\u200b\u7f51\u200b\u7f16\u5199\u200b\u7684\u200bAPP\uff0c\u200b\u5b83\u200b\u53ef\u4ee5\u200b\u5728\u200bLCD\u200b\u4e0a\u200b\u76f4\u63a5\u200b\u663e\u793a\u200b\u6444\u50cf\u5934\u200b\u7684\u200b\u56fe\u50cf\u200b</li> <li>\u200b\u8fd9\u200b2\u200b\u4e2a\u200b\u6e90\u7801\u200b\u90fd\u200b\u653e\u5728\u200bGIT\u200b\u4ed3\u5e93\u200b\u91cc\u200b\uff1a   </li> </ul>"},{"location":"13_V4L2/07_1/#1","title":"1.","text":"<p>To be able to manipulate the physical properties of a video function, its functionality must be divided into addressable entities. The following two generic entities are identified:</p> <ul> <li>Units\uff1aSelector Unit  \u3001Processing Unit  \u3001Encoding Unit  \u3001Extension Unit  </li> <li>Terminals \uff1aInput Terminal (IT)   \u3001Output Terminal (OT)  \u3001Camera Terminal (CT)  </li> <li>A Camera Terminal is always represented as an     Input Terminal with a single output pin. It provides support for the following features  <ul> <li>Scanning Mode (Progressive or Interlaced)</li> <li>Auto-Exposure Mode</li> <li>Auto-Exposure Priority</li> <li>Exposure Time</li> <li>Focus</li> <li>Auto-Focus</li> <li>Simple Focus</li> <li>Iris</li> <li>Zoom  </li> <li>Pan</li> <li>Roll</li> <li>Tilt</li> <li>Digital Windowing</li> <li>Region of Interest  </li> </ul> </li> </ul> <p>Controls have attributes, which might include:  </p> <ul> <li>Current setting</li> <li>Minimum setting</li> <li>Maximum setting</li> <li>Resolution</li> <li>Size</li> <li>Default  </li> </ul> <p>Processing Unit  </p> <ul> <li>User Controls  </li> <li>Brightness</li> <li>Hue</li> <li>Saturation</li> <li>Sharpness</li> <li>Gamma</li> <li>Digital Multiplier (Zoom)  </li> <li>Auto Controls  </li> <li>White Balance Temperature</li> <li>White Balance Component</li> <li>Backlight Compensation  </li> <li>Contrast  </li> <li>Other  </li> <li>Gain</li> <li>Power Line Frequency</li> <li>Analog Video Standard</li> <li>Analog Video Lock Status  </li> </ul> <p>Extension Unit  </p> <p>\u200b\u5bf9\u4e8e\u200b\u6bcf\u200b\u4e00\u4e2a\u200bentity(IT,PU,SU,OT\u200b\u7b49\u200b)</p> <ul> <li>IT: input terminal</li> <li>OT\uff1aoutput terminal</li> <li>VC: video control</li> <li></li> </ul> <p>video function\uff1a\u200b\u542b\u6709\u200b\u51e0\u4e2a\u200binterface\uff0c\u200b\u6bcf\u4e2a\u200bvideo function\u200b\u542b\u6709\u200b\u4e00\u4e2a\u200bVC(video control)\u3001\u200b\u591a\u4e2a\u200bVS(video streaming)\uff0c\u200b\u5b83\u4eec\u200b\u88ab\u200b\u79f0\u4e3a\u200bVIC\u3002</p> <p>\u200b\u53c2\u8003\u8d44\u6599\u200b\uff1a</p> <p>https://www.php1.cn/detail/CSS_YangShiGuiZe_218a96fe.html</p>"}]}